/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../chunks/ArrayPool.js";import"../core/lang.js";import"../chunks/deprecate.js";import"../chunks/object.js";import"../kernel.js";import"../config.js";import{L as t,b as i,i as s,r,e as o,u as a}from"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/metadata.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import l from"../core/Accessor.js";import"../chunks/PropertyOrigin.js";import{schedule as p,i as h}from"../core/scheduling.js";import{createDeferred as c,isAbortError as u,createAbortController as d,onAbort as m,throwIfAborted as y,isAborted as g,createAbortError as f,reject as v,after as w}from"../core/promiseUtils.js";import"../chunks/Message.js";import _ from"../core/Error.js";import"../chunks/compilerUtils.js";import"../chunks/ensureType.js";import{subclass as b}from"../core/accessorSupport/decorators/subclass.js";import{E as j}from"../chunks/Evented.js";import k from"../core/Collection.js";import"../chunks/collectionUtils.js";import"../chunks/JSONSupport.js";import{a as M}from"../chunks/Promise.js";import{L as I}from"../chunks/Loadable.js";import"../chunks/asyncUtils.js";import"../chunks/loadAll.js";import"../core/urlUtils.js";import{aliasOf as T}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/jsonMap.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../chunks/shared.js";import"../chunks/writer.js";import"../chunks/resourceExtension.js";import"../chunks/persistableUrlUtils.js";import V,{e as C}from"../geometry/SpatialReference.js";import"../chunks/locale.js";import"../chunks/number.js";import"../intl.js";import"../request.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../chunks/Ellipsoid.js";import{canProject as S,project as L}from"../geometry/support/webMercatorUtils.js";import P from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../portal/PortalItem.js";import"../Basemap.js";import"../chunks/writeUtils.js";import{r as R,c as D}from"../chunks/mathUtils2.js";import"../chunks/vec3f64.js";import"../chunks/colorUtils.js";import"../Color.js";import"../chunks/zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/domains.js";import"../chunks/arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"../chunks/date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{c as E}from"../chunks/screenUtils.js";import"../chunks/opacityUtils.js";import"../chunks/materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/utils.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"../chunks/colors.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../chunks/urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols.js";import"../chunks/uid.js";import"../Graphic.js";import"../Ground.js";import x from"../core/Handles.js";import{C as F}from"../chunks/CollectionFlattener.js";import"../chunks/basemapUtils.js";import O from"../Map.js";import"../layers/Layer.js";import"../chunks/TablesMixin.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../tasks/support/ColorRamp.js";import"../tasks/support/AlgorithmicColorRamp.js";import"../tasks/support/MultipartColorRamp.js";import"../chunks/colorRamps.js";import"../renderers/Renderer.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"../chunks/sizeVariableUtils.js";import"../chunks/unitUtils.js";import"../chunks/lengthUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/VisualVariablesMixin.js";import"../chunks/symbolConversion.js";import"../symbols/support/jsonUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../renderers/ClassBreaksRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/devEnvironmentUtils.js";import"../chunks/styleUtils.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/normalizeUtilsCommon.js";import"../geometry/support/normalizeUtils.js";import"../chunks/MemCache.js";import"../chunks/ItemCache.js";import"../chunks/utils3.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils2.js";import"../chunks/LRUCache.js";import"../renderers/DictionaryRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/HeatmapRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/support/jsonUtils.js";import"../chunks/timeUtils.js";import U from"../TimeExtent.js";import"../TimeInterval.js";import"../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../chunks/MultiOriginJSONSupport.js";import{on as A,init as H,whenOnce as W,watch as N,when as B,whenFalseOnce as K}from"../core/watchUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/fieldType.js";import z from"../geometry/HeightModelInfo.js";import{m as G,d as q}from"../chunks/heightModelInfoUtils.js";import"../chunks/OperationalLayer.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/commonProperties2.js";import"../chunks/Scheduler.js";import{HandleOwner as $,W as Q,HandleOwnerMixin as J}from"../core/HandleOwner.js";import"../core/workers/RemoteClient.js";import"../core/workers/Connection.js";import"../core/workers/workers.js";import"../form/ExpressionInfo.js";import"../form/elements/FieldElement.js";import"../form/support/elements.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/support/inputs.js";import"../form/elements/GroupElement.js";import"../form/FormTemplate.js";import"../chunks/domUtils.js";import"../chunks/widgetUtils.js";import"../chunks/projector.js";import"../chunks/accessibleHandler.js";import"../chunks/messageBundle.js";import"../widgets/support/widget.js";import"../chunks/vmEvent.js";import"../chunks/index.js";import"../widgets/Widget.js";import"../chunks/zscale.js";import"../chunks/queryZScale.js";import"../layers/support/Field.js";import"../tasks/support/FeatureSet.js";import"../layers/FeatureLayer.js";import"../chunks/ArcGISService.js";import"../chunks/BlendLayer.js";import"../chunks/CustomParametersMixin.js";import"../chunks/PortalLayer.js";import"../chunks/RefreshableLayer.js";import"../chunks/ScaleRangeLayer.js";import"../layers/support/TimeInfo.js";import"../chunks/TemporalLayer.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureReductionCluster.js";import"../chunks/labelUtils.js";import"../layers/support/LabelClass.js";import"../chunks/defaultsJSON.js";import"../chunks/defaults.js";import"../chunks/featureReductionUtils.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"../chunks/labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../chunks/DataLayerSource.js";import"../chunks/styleUtils2.js";import"../support/popupUtils.js";import"../tasks/support/AttachmentQuery.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"../tasks/support/RelationshipQuery.js";import{G as Y,g as Z}from"../chunks/GraphicsCollection.js";import"../chunks/utils4.js";import"../tasks/Task.js";import"../rest/query/support/AttachmentInfo.js";import"../chunks/query.js";import"../chunks/executeRelationshipQuery.js";import"../chunks/pbf.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/pbfQueryUtils.js";import"../chunks/featureConversionUtils.js";import"../tasks/QueryTask.js";import"../symbols/support/symbolUtils.js";import{BasemapView as X}from"./BasemapView.js";import ee from"./Magnifier.js";import{a as te,n as ie,s as se,e as re,b as oe}from"../chunks/interactiveToolUtils.js";import"../chunks/throttle.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../widgets/Feature/FeatureViewModel.js";import"../widgets/Feature.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../widgets/Popup.js";import"../chunks/Queue.js";import{I as ae,V as ne}from"../chunks/InputManager.js";import"../chunks/layerViewUtils.js";import"../chunks/actions.js";import"../widgets/Popup/PopupViewModel.js";import"../chunks/GoTo.js";import{s as le}from"../chunks/MapUtils.js";import{i as pe}from"../chunks/RefreshableLayerView.js";import{b as he}from"../chunks/screenUtils2.js";import"./input/gamepad/GamepadInputDevice.js";import"./input/gamepad/GamepadSettings.js";import ce from"./input/Input.js";import"./navigation/gamepad/GamepadSettings.js";import ue from"./navigation/Navigation.js";const de=t.getLogger("esri.views.LayerViewManager");class me{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=d(),this._deferred=c(),this._started=!1,this.done=!1,m(this._controller.signal,(()=>{const t=new _("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{var s,o;let a,n;if(await t.load({signal:e}),"prefetchResources"in t&&await t.prefetchResources({signal:e}),t.createLayerView)a=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new _("layer:view-not-supported","No layerview implementation was found");const s=await this.layerViewImporter.importLayerView(t);y(e),a="default"in s?new s.default({layer:t,view:i}):new s({layer:t,view:i})}const l=()=>{n=r(n),a.destroy(),a.layer=null,a.parent=null,a.view=null,this.done=!0};n=m(e,l),y(e);try{await a.when()}catch(e){throw l(),e}if(!(null==(s=this._map)||null==(o=s.allLayers)?void 0:o.includes(t)))return l(),void this._deferred.reject(new _("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=a,t.emit("layerview-create",{view:i,layerView:a}),i.emit("layerview-create",{layer:t,layerView:a}),this.done=!0,this._deferred.resolve(a)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new _("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let ye=class extends ${constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new Q,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var e;const t=null==(e=this.view.map)?void 0:e.allLayers;if(t)for(const e of t)this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e)},this._reschedule=()=>(i(this._workPromise)&&(this._workPromise=c()),this.handles.remove("reschedule"),this.handles.add(p(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var e,t,s;const r=this.view.map;if(this._map!==r&&(this.clear(),this._map=r),i(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const o=new F({root:this,rootCollectionNames:this._rootCollectionNames,getChildrenFunction:e=>e.layers});if(!o)return this._workPromise.resolve(),void(this._workPromise=null);for(const e of o)this._createLayerView(e);this._refreshCollections();for(const[e,t]of this._layerLayerViewInfoMap)o.includes(e)||(this._layerLayerViewInfoMap.delete(t.layer),t.destroy());const a=o.filter((e=>"group"===e.type)).map((e=>e.layers)),n=[null==r||null==(e=r.ground)?void 0:e.layers,null==r||null==(t=r.basemap)?void 0:t.baseLayers,null==r||null==(s=r.basemap)?void 0:s.referenceLayers,null==r?void 0:r.layers,...a].filter((e=>!!e));this.handles.add(n.map((e=>this._watchUpdatingTracking.addOnCollectionChange(e,this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([A(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),H(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return!(!s(this._workPromise)&&!this._watchUpdatingTracking.updating)||le(this._layerLayerViewInfoMap,(e=>!e.done))}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e))throw new _("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let s=0;for(const r of e){const e=this._layerLayerViewInfoMap.get(r);if(!e||!e.layerView)continue;const o=e.layerView;o.layer=r,o.parent=i,t.getItemAt(s)!==o&&t.splice(s,0,o),r.layers&&this._populateLayerViewsOwners(r.layers,o.layerViews,o),s+=1}s<t.length&&t.splice(s,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),void this.notifyChange("updating");e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new me(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{var i,s;t&&(u(t)||"cancelled:layerview-create"===t.name)||de.error(`Failed to create layerview for layer title:'${null!=(i=e.title)?i:"no title"}', id:'${null!=(s=e.id)?s:"no id"}' of type '${e.type}'.`,{layer:e,error:t});this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating")}};e([n()],ye.prototype,"_workPromise",void 0),e([n({readOnly:!0})],ye.prototype,"_watchUpdatingTracking",void 0),e([n({readOnly:!0})],ye.prototype,"_layersToLayerViews",null),e([n({readOnly:!0})],ye.prototype,"_rootCollectionNames",null),e([n()],ye.prototype,"layerViewImporter",void 0),e([n()],ye.prototype,"supportsGround",void 0),e([n({readOnly:!0})],ye.prototype,"updating",null),e([n({constructOnly:!0})],ye.prototype,"view",void 0),ye=e([b("esri.views.LayerViewManager")],ye);var ge=ye;let fe=class extends j.EventedAccessor{constructor(){super(...arguments),this._handles=new x,this._currentTick=0}initialize(){this._handles.add([this.view.allLayerViews.on("after-changes",(()=>{this.notifyChange("tickInterval"),this._handles.remove("layerViewsUpdating"),this._handles.add(this._getLayerViewHandles(),"layerViewsUpdating")})),this.watch("tickInterval",(()=>this._restartTicking())),this.watch("view.ready",(()=>this._restartTicking()))]),this._restartTicking()}destroy(){this._handles&&(this._handles.destroy(),this._handles=null,this._intervalID&&clearInterval(this._intervalID),this._currentTick=0)}get tickInterval(){const e=this.view.allLayerViews.filter((e=>pe(e)));return this._getCommonInterval(e)}_restartTicking(){this._currentTick=0,this._intervalID&&clearInterval(this._intervalID),this.get("view.ready")&&this.tickInterval&&(this._intervalID=setInterval((()=>{const e=Date.now();this._currentTick+=this.tickInterval,this.view.allLayerViews.forEach((t=>{if(pe(t)){const i=Math.round(6e4*t.refreshInterval),s=this._currentTick%i==0,r=e-t.refreshTimestamp<5400;i&&s&&!r&&(t.refresh(e),this.emit("refresh",{layerView:t,timestamp:e,trigger:"interval"}))}}))}),this.tickInterval))}_getLayerViewHandles(){const e=[],t=()=>this.notifyChange("tickInterval");return this.view.allLayerViews.forEach((i=>{pe(i)&&i.layer&&e.push(i.watch("refreshInterval",t),i.layer.on("refresh",(()=>{const e=Date.now();i.refresh(e),this.emit("refresh",{layerView:i,timestamp:e,trigger:"layer-refresh"})})))})),e}_getCommonInterval(e){const t=(e,i)=>isNaN(e)||isNaN(i)?0:i<=0?e:t(i,e%i);return e.toArray().reduce(((e,i)=>t(Math.round(6e4*i.refreshInterval),e)),0)}};e([n()],fe.prototype,"view",void 0),e([n({readOnly:!0})],fe.prototype,"tickInterval",null),fe=e([b("esri.views.RefreshManager")],fe);var ve=fe;const we=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],_e={};function be(e){return!!_e[e]}we.forEach((e=>{_e[e]=!0}));class je{constructor(e){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this.handlers.forEach((({handler:e,priority:t},i)=>this.inputManager.installHandlers(i,[e],t)))}disconnect(){this.inputManager&&this.handlers.forEach(((e,t)=>this.inputManager.uninstallHandlers(t))),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(e,t,i,s){const r=Array.isArray(e)?e:e.split(",");if(!function(e){for(const t of e)if(!be(t))return!1;return!0}(r))return r.some(be)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(t)?a=t:(o=t,a=[]),"function"==typeof i?o=i:s=i,s=null!=s?s:ne.DEFAULT;const n=this.createUniqueGroupName(),l=new ke(this.view,r,a,o);this.handlers.set(n,{handler:l,priority:s});for(const e of r){const t=this.handlerCounts.get(e)||0;this.handlerCounts.set(e,t+1)}return this.inputManager&&this.inputManager.installHandlers(n,[l],s),{remove:()=>this.removeHandler(n,r)}}hasHandler(e){return!!this.handlerCounts.get(e)}removeHandler(e,t){if(this.handlers.has(e)){this.handlers.delete(e);for(const e of t){const t=this.handlerCounts.get(e);void 0===t?console.error("Trying to remove handler for event that has no handlers registered: ",e):1===t?this.handlerCounts.delete(e):this.handlerCounts.set(e,t-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class ke extends ae{constructor(e,t,i,s){super(!0),this.view=e;for(const e of t)switch(e){case"click":this.registerIncoming("click",i,(e=>s(this.wrapClick(e))));break;case"double-click":this.registerIncoming("double-click",i,(e=>s(this.wrapDoubleClick(e))));break;case"immediate-click":this.registerIncoming("immediate-click",i,(e=>s(this.wrapImmediateClick(e))));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,(e=>s(this.wrapImmediateDoubleClick(e))));break;case"hold":this.registerIncoming("hold",i,(e=>s(this.wrapHold(e))));break;case"drag":this.registerIncoming("drag",i,(e=>{const t=this.wrapDrag(e);t&&s(t)}));break;case"key-down":this.registerIncoming("key-down",i,(e=>s(this.wrapKeyDown(e))));break;case"key-up":this.registerIncoming("key-up",i,(e=>s(this.wrapKeyUp(e))));break;case"pointer-down":this.registerIncoming("pointer-down",i,(e=>s(this.wrapPointer(e,"pointer-down"))));break;case"pointer-move":this.registerIncoming("pointer-move",i,(e=>s(this.wrapPointer(e,"pointer-move"))));break;case"pointer-up":this.registerIncoming("pointer-up",i,(e=>s(this.wrapPointer(e,"pointer-up"))));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,(e=>s(this.wrapPointerDrag(e))));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,(e=>s(this.wrapMouseWheel(e))));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,(e=>s(this.wrapPointer(e,"pointer-enter"))));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,(e=>s(this.wrapPointer(e,"pointer-leave"))));break;case"gamepad":this.registerIncoming("gamepad",i,(e=>{s(this.wrapGamepad(e))}));break;case"focus":this.registerIncoming("focus",i,(e=>{s(this.wrapFocus(e))}));break;case"blur":this.registerIncoming("blur",i,(e=>{s(this.wrapBlur(e))}))}}wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapClick(e){const{pointerType:t,button:i,buttons:s,x:r,y:o,native:a,eventId:n}=e.data,{cancelable:l,timestamp:p}=e;return{type:"click",pointerType:t,button:i,buttons:s,x:r,y:o,native:a,timestamp:p,screenPoint:E(r,o),mapPoint:this.getMapPoint(r,o),eventId:n,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapDoubleClick(e){const{pointerType:t,button:i,buttons:s,x:r,y:o,native:a,eventId:n}=e.data,{cancelable:l,timestamp:p}=e;return{type:"double-click",pointerType:t,button:i,buttons:s,x:r,y:o,native:a,timestamp:p,mapPoint:this.getMapPoint(r,o),eventId:n,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateClick(e){const{pointerType:t,button:i,buttons:s,x:r,y:o,native:a,eventId:n}=e.data,l=a.pointerId,{cancelable:p,timestamp:h}=e;return{type:"immediate-click",pointerId:l,pointerType:t,button:i,buttons:s,x:r,y:o,native:a,timestamp:h,mapPoint:this.getMapPoint(r,o),eventId:n,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateDoubleClick(e){const{pointerType:t,button:i,buttons:s,x:r,y:o,native:a,eventId:n}=e.data,l=a.pointerId,{cancelable:p,timestamp:h}=e;return{type:"immediate-double-click",pointerId:l,pointerType:t,button:i,buttons:s,x:r,y:o,native:a,timestamp:h,mapPoint:this.getMapPoint(r,o),eventId:n,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapHold(e){const{pointerType:t,button:i,buttons:s,x:r,y:o,native:a}=e.data,{cancelable:n,timestamp:l}=e;return{type:"hold",pointerType:t,button:i,buttons:s,x:r,y:o,native:a,timestamp:l,mapPoint:this.getMapPoint(r,o),cancelable:n,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}getMapPoint(e,t){return this.view.toMap(E(e,t),{exclude:[]})}wrapDrag(e){const t=e.data,{x:i,y:s}=t.center,{action:r,pointerType:o,button:a}=t;if("start"===r&&(this.latestDragStart=t),!this.latestDragStart)return;const n=t.pointer.native,l=t.buttons,{cancelable:p,timestamp:h}=e,c={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return"end"===r&&(this.latestDragStart=void 0),{type:"drag",action:r,x:i,y:s,origin:c,pointerType:o,button:a,buttons:l,radius:t.radius,angle:R(t.angle),native:n,timestamp:h,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyDown(e){const{key:t,repeat:i,native:s}=e.data,{cancelable:r,timestamp:o}=e;return{type:"key-down",key:t,repeat:i,native:s,timestamp:o,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyUp(e){const{key:t,native:i}=e.data,{cancelable:s,timestamp:r}=e;return{type:"key-up",key:t,native:i,timestamp:r,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointer(e,t){const{x:i,y:s,button:r,buttons:o,native:a,eventId:n}=e.data,l=a.pointerId,p=a.pointerType,{cancelable:h,timestamp:c}=e;return{type:t,x:i,y:s,pointerId:l,pointerType:p,button:r,buttons:o,native:a,timestamp:c,eventId:n,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointerDrag(e){const{x:t,y:i,buttons:s,native:r,eventId:o}=e.data.currentEvent,{button:a}=e.data.startEvent,n=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,p=e.data.action,h={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:c,timestamp:u}=e;return{type:"pointer-drag",x:t,y:i,pointerId:n,pointerType:l,button:a,buttons:s,action:p,origin:h,native:r,timestamp:u,eventId:o,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapMouseWheel(e){const{cancelable:t,data:i,timestamp:s}=e,{x:r,y:o,deltaY:a,native:n}=i;return{type:"mouse-wheel",x:r,y:o,deltaY:a,native:n,timestamp:s,cancelable:t,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapGamepad(e){const{action:t,state:i,device:s}=e.data,{cancelable:r,timestamp:o}=e,{buttons:a,axes:n}=i;return{type:"gamepad",device:s,timestamp:o,action:t,buttons:a,axes:n,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}}class Me{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToActiveTool=null,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,t){const r=()=>e.stopPropagation();switch(e.type){case"pointer-move":Ie(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!Te(e)||Ve(e))break;const a=he(e),n=this._intersect(a,e.pointerType,t.forEachTool);if(i(n))break;const l=this._findToolAndManipulatorByKey(n,t.forEachTool,Ce),p=o(l,(e=>e.manipulator)),h=o(l,(e=>e.tool));!(s(p)&&s(h)&&p.interactive)||p.grabbable&&p.grabbableForEvent(e)||!p.grabbing||p.dragging||this._ungrabManipulatorBeforeDragging(p,h,e),s(p)&&p.interactive&&p.grabbable&&p.grabbableForEvent(e)&&!p.grabbing&&(this._grabbedManipulators.set(e.pointerId,{key:n,start:a}),1===this._grabbedManipulators.size&&(this._revertToActiveTool=t.activeTool,t.setActiveTool(n.tool)),p.grabbing=!0,p.events.emit("grab-changed",{action:"start",screenPoint:a}),r());break}case"pointer-up":this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Te(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=this._draggedManipulators.get(e.pointerId),l=o(s||n,(({key:e})=>e)),p=this._findManipulatorByKey(l,t.forEachTool);if(i(p))break;const h=he(e);h.x=D(h.x,0,t.view.width),h.y=D(h.y,0,t.view.height);const c=a(s||n).start;switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(p.dragging=!0,n?p.events.emit("drag",{action:"update",start:c,screenPoint:h}):p.events.emit("drag",{action:"start",start:c,screenPoint:h,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{key:a(l),start:c}));break;case"end":p.dragging=!1,n&&p.events.emit("drag",{action:"end",start:c,screenPoint:h}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}r();break}case"immediate-click":{const o=he(e),a=this._intersect(o,e.pointerType,t.forEachTool),n=this._findToolAndManipulatorByKey(a,t.forEachTool,Ce);if(Ve(e)||t.forEachTool((e=>{if((!s(n)||n.tool!==e||!e.selectionManagementDisabled)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.manipulatorSelectionChanged&&e.manipulatorSelectionChanged()}})),i(n))break;const{manipulator:l,tool:p}=n;if(!l.interactive)break;l.selectable&&!p.selectionManagementDisabled&&(l.selected=!l.selected,p.manipulatorSelectionChanged&&p.manipulatorSelectionChanged());const h=e.native.shiftKey;l.events.emit("immediate-click",{screenPoint:o,button:e.button,pointerType:e.pointerType,shiftKey:h,stopPropagation:r});break}case"click":{const s=he(e),o=this._intersect(s,e.pointerType,t.forEachTool),a=this._findManipulatorByKey(o,t.forEachTool);if(i(a)||!a.interactive)break;const n=e.native.shiftKey;a.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:n}),r();break}case"double-click":{const s=he(e),o=this._intersect(s,e.pointerType,t.forEachTool),a=this._findManipulatorByKey(o,t.forEachTool);if(i(a)||!a.interactive)break;const n=e.native.shiftKey;a.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:r});break}case"immediate-double-click":{const s=he(e),o=this._intersect(s,e.pointerType,t.forEachTool),a=this._findManipulatorByKey(o,t.forEachTool);if(i(a)||!a.interactive)break;const n=e.native.shiftKey;a.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:r});break}}this._updateCursor(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",screenPoint:he(i)}),this._grabbedManipulators.forEach((({key:i},s)=>{i.tool===t&&t.manipulators.findById(i.manipulatorId)===e&&this._grabbedManipulators.delete(s)}))}_handlePointerEnd(e,t){const i=o(this._grabbedManipulators.get(e.pointerId),(({key:e})=>e)),r=this._findManipulatorByKey(i,t.forEachTool);if(s(r)&&!r.dragging){const o=s(t.creatingTool)&&t.creatingTool===a(i).tool;1!==this._grabbedManipulators.size||0!==this._draggedManipulators.size||o||(t.setActiveTool(this._revertToActiveTool),this._revertToActiveTool=null),r.grabbing&&(r.grabbing=!1,r.events.emit("grab-changed",{action:"end",screenPoint:he(e)})),this._grabbedManipulators.delete(e.pointerId)}}_cursorFromMap(e,t){let i=null;return le(e,(({key:e})=>{const r=this._findManipulatorByKey(e,t);return!!(s(r)&&r.interactive&&"cursor"in r&&r.cursor)&&(i=r.cursor,!0)})),i}_updateCursor(e){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,e)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,e)||"pointer":this._cursor=null}clearPointers(e,t,r=!0,o){const a=t=>t.tool===e&&(i(o)||t.manipulatorId===o);this._grabbedManipulators.forEach((({key:e},i)=>{if(a(e)){this._grabbedManipulators.delete(i);const r=this._findManipulatorByKey(e,t);s(r)&&(r.grabbing=!1,r.events.emit("grab-changed",{action:"end",screenPoint:null}))}})),this._draggedManipulators.forEach((({key:e},i)=>{if(a(e)){this._draggedManipulators.delete(i);const r=this._findManipulatorByKey(e,t);s(r)&&(r.dragging=!1,r.events.emit("drag",{action:"cancel"}))}})),r&&this._hoveredManipulators.forEach((({key:e},i)=>{if(a(e)){this._hoveredManipulators.delete(i);const r=this._findManipulatorByKey(e,t);s(r)&&(r.hovering=!1)}})),this._updateCursor(t)}_intersect(e,t,s){let r=null;return s((s=>{if(null==s.manipulators||!te(s))return!1;const o=s.manipulators.intersect(e,t);return!i(o)&&(r={manipulatorId:o.id,tool:s},!0)})),r}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(E(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!Ie(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(he(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){const n=this._intersect(e,i,r);let l=this._findManipulatorByKey(n,r);const p=o(this._hoveredManipulators.get(t),(({key:e})=>e)),h=this._findManipulatorByKey(p,r);s(l)&&!l.interactive&&(l=null),h!==l&&(s(h)&&(h.hovering=!1),s(l)?(l.hovering=!0,this._hoveredManipulators.set(t,{key:a(n)})):this._hoveredManipulators.delete(t),this._updateCursor(r))}_findManipulatorByKey(e,t){return this._findToolAndManipulatorByKey(e,t,Ce)?Ce.manipulator:null}_findToolAndManipulatorByKey(e,t,r){return i(e)?null:(r.tool=null,r.manipulator=null,t((t=>{if(t!==e.tool||null==t.manipulators||!te(t))return!1;const i=t.manipulators.findById(e.manipulatorId);return!!s(i)&&(r.manipulator=i,r.tool=t,!0)})),r.manipulator?r:null)}}function Ie(e){return"mouse"===e}function Te(e){return"mouse"!==e.pointerType||0===e.button}function Ve(e){return!!e.native.shiftKey}const Ce={manipulator:null,tool:null},Se=t.getLogger("esri.views.ToolViewManager");let Le=class extends l{constructor(e){super(e),this._handles=new x,this._creatingTool=null,this._manipulatorState=new Me,this.tools=ie(),this.cursor=null,this._forEachTool=e=>{if(!s(this._creatingTool)||!e(this._creatingTool))for(const t of this.tools.items)if(e(t))return}}initialize(){this._handles.add([this.view.on(we,(e=>{this._handleInputEvent(e)}),ne.TOOL),this.tools.on("before-add",(e=>{const t=e.item;null==t||this.tools.includes(t)?e.preventDefault():null==t.created||t.created||(Se.error("tools","Tool can not be added to view before it has been created"),e.preventDefault())})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((e=>e.destroy())),this._handles.destroy(),this._handles=null}set activeTool(e){!s(e)||this.view.ready?(se(this,e,(t=>{this._set("activeTool",t),this._removeIncompleteTools(e),this._forEachTool((e=>{const t=i(this.activeTool)||e===this.activeTool;e.setEditableFlag&&e.setEditableFlag(1,t);const s=te(e);!i(this.activeTool)&&s||this._manipulatorState.clearPointers(e,this._forEachTool,!s)})),this._updateCursor()})),this._creatingTool!==e&&this._rejectCreatingTool()):Se.error("#activeTool=","cannot set active tool while view is not ready")}async createTool(e,t,i){await this.view.whenReady();const r="Tool creation was interrupted by another tool being created";if(g(i))throw f(r);const o=new e({...re(t),view:this.view}),a=m(i,(()=>this.activeTool=null));return this._rejectCreatingTool(r),this._creatingTool=o,o.attach(),this._refreshToolWatchers(),oe(o,!0),await o.when(),s(a)&&a.remove(),this._creatingTool=null,this.tools.add(o),o instanceof l&&null!=o.completed&&W(o,"completed").then((()=>{oe(o,!1)})),o}attach(){this._forEachTool((e=>e.attach())),"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",(()=>{this.forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(e=>{this.forEachManipulator((t=>{null!=t.onElevationChange&&t.onElevationChange(e)}))}))],"manipulators"):this._handles.add(this.view.watch("extent",(()=>{this.forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})))}detach(){this.activeTool=null,this._forEachTool((e=>{e.detach(),e.destroy()})),this.tools.removeAll(),this._handles.remove("manipulators")}forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};s(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&!1!==e.visible&&e.handleInputEvent&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},creatingTool:this._creatingTool,view:this.view}),!t&&s(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this._handles.remove("tools"),this._forEachTool((e=>{if(e instanceof l){const t=N(e,["cursor","visible","editable"],(()=>{te(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()}));this._handles.add(t,"tools")}e.manipulators&&this._handles.add(e.manipulators.on("change",(t=>{t.removed.forEach((({id:t})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,t)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),"tools")})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let e=null;this._forEachTool((t=>null!=t.cursor&&!1!==t.visible&&(e=t.cursor,!0))),e||(e=this._manipulatorState.cursor),this._get("cursor")!==e&&this._set("cursor",e)}_rejectCreatingTool(e){const t=this._creatingTool;i(t)||(this._manipulatorState.clearPointers(t,this._forEachTool),t.rejectCreation&&t.rejectCreation(f(e)),t.destroy(),this._creatingTool=null,this._refreshToolWatchers())}_removeIncompleteTools(e){this.tools.filter((t=>(i(e)||t!==e)&&null!=t.completed&&!t.completed)).forEach((e=>{this.tools.remove(e)}))}};e([n({constructOnly:!0,nonNullable:!0})],Le.prototype,"view",void 0),e([n({value:null})],Le.prototype,"activeTool",null),e([n({readOnly:!0,type:k})],Le.prototype,"tools",void 0),e([n({readOnly:!0})],Le.prototype,"cursor",void 0),Le=e([b("esri.views.ToolViewManager")],Le);var Pe=Le;class Re{constructor(e,t,i){this.analysis=e,this.viewFactory=t,this.controllerFactory=i,this._promise=c(),this.analysisView=null,this.analysisController=null,this._load()}destroy(){s(this.analysisView)&&this.analysisView.destroy(),s(this.analysisController)&&this.analysisController.destroy()}get promise(){return this._promise.promise}async _load(){let e=!1;s(this.viewFactory)?this.analysisView=await this.viewFactory(this.analysis):e=!0,s(this.controllerFactory)?this.analysisController=await this.controllerFactory(this.analysis):e=!0,e?this._promise.reject("no view/controller factories available for analysis"):this._promise.resolve(a(this.analysisView))}}let De=class extends l{constructor(e){super(e),this._items=new Map,this.analyses=new k}initialize(){this.analyses.on("after-add",(e=>{const t=e.item;this._items.set(t,this._createItem(t))})),this.analyses.on("after-remove",(e=>{const t=e.item,i=this._getItem(t);s(i)&&(i.destroy(),this._items.delete(t))}))}async whenAnalysisView(e){return this._items.has(e)?this._items.get(e).promise:v(new _("view:no-analysisview-for-analysis","No analysis view has been found for the analysis"))}getAnalysisView(e){const t=this._items.get(e);return t?t.analysisView:null}_createItem(e){return new Re(e,this.viewFactory,this.controllerFactory)}_getItem(e){return this._items.get(e)}};var Ee;e([n({type:k})],De.prototype,"analyses",void 0),e([n()],De.prototype,"viewFactory",void 0),e([n()],De.prototype,"controllerFactory",void 0),De=e([b("esri.views.3d.interactive.graphics.AnalysisManager")],De);const xe=t.getLogger("esri.views.support.DefaultsFromMap");let Fe=Ee=class extends l{constructor(){super(...arguments),this._handles=new x,this._waitTask=null,this._extentProjectController=null,this._spatialReferenceCandidates=null,this._extentCandidates=null,this.logDebugInformation=!1,this.isSpatialReferenceDone=!1,this.isTileInfoDone=!1,this.isHeightModelInfoSearching=!1,this.spatialReference=null,this.extent=null,this.heightModelInfo=null,this.vcsWkid=null,this.latestVcsWkid=null,this.mapCollectionPaths=Ee.DefaultMapCollectionPaths.slice(),this.tileInfo=null}initialize(){this.watch("mapCollectionPaths",(()=>{this._running&&(this.reset(),this.start())}))}destroy(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null),this._cancelLoading()}get _running(){return!!(this._handles&&this._handles.size>0)}reset(){this._handles.removeAll(),this._set("isSpatialReferenceDone",!1),this._set("isTileInfoDone",!1),this._set("isHeightModelInfoSearching",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("vcsWkid",null),this._set("latestVcsWkid",null),this._set("tileInfo",null),this._spatialReferenceCandidates=null,this._extentCandidates=null}start(){this._handles.removeAll();const e=this._updateLayerChange.bind(this);for(const t of this.mapCollectionPaths)this._handles.add(A(this.view,`map.${t}`,"change",e,e,e,!0));this._handles.add(B(this,"isSpatialReferenceDone",(()=>this._updateTileInfo()),!0))}_ownerNameFromCollectionName(e){const t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)}_ensureLoadedOwnersFromCollectionName(e){const t=this._ownerNameFromCollectionName(e).split(".");let i;for(let s=0;s<t.length&&(i=this.get(t.slice(0,s+1).join(".")),i);s++)if(i.load&&!i.isFulfilled())return{collectionName:e,owner:null,loading:i.load().catch((()=>{}))};return{collectionName:e,owner:i}}_cancelLoading(){this._waitTask=null,this._extentProjectController&&(this._extentProjectController.abort(),this._extentProjectController=null)}_updateWhen(e){let t=!0,i=!1;const s=e.catch((()=>{})).then((()=>{t?i=!0:s===this._waitTask&&this._update()}));return t=!1,i||(this._waitTask=s),i}_updateLayerChange(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()}_update(){if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog("Starting search for spatial reference...");const e=this._processMapCollections((e=>this._processSpatialReferenceSource(e)));if(this._debugLog(`Search ended with status '${Ue(e)}'`),0!==e){let e=null,t=this._spatialReferenceCandidates;if(!t||t.length<1?(e=this.defaultSpatialReference,this._debugLog(`No spatial reference found, locking to default (${Oe(e)})`)):(this.defaultSpatialReference&&t.length>1&&t.findIndex((e=>e.equals(this.defaultSpatialReference)))>-1&&(t=[this.defaultSpatialReference]),e=t[0],this._debugLog(`Locking to ${Oe(e)}`)),this._set("spatialReference",e),e)if(this.extent)this._set("isSpatialReferenceDone",!0);else{const t=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections((t=>this._findExtent(t,e))),this.logDebugInformation=t,this._projectExtentCandidate().catch((()=>{})).then((()=>this._set("isSpatialReferenceDone",!0)))}else this._set("isSpatialReferenceDone",!0)}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog("Starting search for height model info...");const e=this._processMapCollections((e=>this._processHeightModelInfoSource(e)),(e=>G(e)));this._debugLog(`Search ended with status ${Ue(e)}`),this._set("isHeightModelInfoSearching",0===e)}this._updateTileInfo()}}_processMapCollections(e,t){this._preloadMapCollections(t);let i=2;return this._forAllMapCollectionSources((e=>{if(2!==i)return!1;const{collectionName:t}=e;return this._debugLog(`Processing collection ${t}...`),!(e.loading&&!this._updateWhen(e.loading))||(this._debugLog(`Collection ${e.collectionName} owner is loading -> wait`),i=0,!1)}),(s=>{if(2!==i)return!1;return null!=t&&!t(s)?(this._debugLog(`Source ${s.id} is skipped due to predicate`),!1):!s.load||s.isFulfilled()||this._updateWhen(s.load())?!((!s.load||s.isResolved())&&e(s))||(i=1,!1):(this._debugLog(`Source ${s.id} is loading -> wait`),i=0,!1)})),i}_preloadMapCollections(e){let t=10;const i=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources((()=>!0),(s=>{if(0===t)return!1;return!(null!=e&&!e(s))&&(s.load&&!s.isFulfilled()&&(this.logDebugInformation=i,this._debugLog(`Pre-loading source ${s.id}`),this.logDebugInformation=!1,s.load().catch((()=>{})),t--),!0)})),this.logDebugInformation=i}_forAllMapCollectionSources(e,t){for(const i of this.mapCollectionPaths){const s=`map.${i}`,r=this._ensureLoadedOwnersFromCollectionName(s);if(!1===e(r))continue;const o=r.owner;if(!o||o.isRejected&&o.isRejected()){this._debugLog(`Collection ${s} owner is invalid or rejected -> skip`);continue}const a=this.view.get(s);a?this._forEachSource(a,t):this._debugLog(`Collection ${s} does not exist -> skip`)}}_forEachSource(e,t){for(const i of e.items)!1!==t(i)&&"layers"in i&&i.layers&&this._forEachSource(i.layers,t)}_processSpatialReferenceSource(e){let t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=h(t,this._spatialReferenceCandidates,((e,t)=>e.equals(t))),t.length>0?this._spatialReferenceCandidates=t:this._debugLog(`Layer ${e.id} is ignored because its supported spatial\n          references are not compatible with the previous candidates`)):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)}_findExtent(e,t){const i="fullExtents"in e&&e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),s=i.find((e=>e.spatialReference.equals(t)));if(s)return this._set("extent",s),!0;if(this._getSupportedSpatialReferences(e).length>0){const t=i.map((t=>({extent:t,layer:e}))),s=this._extentCandidates||[];this._extentCandidates=s.concat(t)}return!1}async _projectExtentCandidate(){if(!this._extentCandidates||!this._extentCandidates.length)return;const e=this.spatialReference,t=this._extentCandidates.find((t=>S(t.extent.spatialReference,e)));if(t)this._set("extent",L(t.extent,e));else{const t=this._extentCandidates[0];this._extentProjectController=d();const i=await import("../chunks/geometryServiceUtils.js");try{const s=await i.projectGeometry(t.extent,e,t.layer.portalItem,this._extentProjectController.signal);this._set("extent",s)}catch{}this._extentProjectController=null}}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return this._debugLog(`Layer ${e.id} is ignored because it does not have any spatial references`),[];const i=t.filter((t=>this.view.isSpatialReferenceSupported(t,e,(e=>this._debugLog(e)))));return 0===i.length?this._debugLog(`Layer ${e.id} has spatial references but none of them are supported (or layer doesn't require locking)`):this._debugLog(`Layer ${e.id} has spatial references. Resulting candidate set: ${i.map(Oe).join(", ")}`),i}_processHeightModelInfoSource(e){const t=q(e);return!!t&&(this._set("heightModelInfo",t),this._set("isHeightModelInfoSearching",!1),e.spatialReference&&(this._set("vcsWkid",e.spatialReference.vcsWkid),this._set("latestVcsWkid",e.spatialReference.latestVcsWkid)),!0)}_updateTileInfo(){if(null!=this.tileInfo)return;if(!this.view.isTileInfoRequired())return void this._set("isTileInfoDone",!0);if(!this.isSpatialReferenceDone)return;const e=this.get("view.map");if(!e)return void this._debugLog("updateTileInfo: no map");const t=e.basemap,i=e.get("layers.0");let s=null;if(t&&"failed"!==t.loadStatus){if(!t.loaded)return this._updateWhen(t.load()),void this._debugLog("updateTileInfo: basemap still loading");const e=t&&t.get("baseLayers.0");if(e&&"failed"!==e.loadStatus){if(!e.loaded)return this._updateWhen(e.load()),void this._debugLog("updateTileInfo: first basemap layer still loading");s="tileInfo"in e&&e.tileInfo}else{if(!i||"failed"===i.loadStatus)return this._debugLog("updateTileInfo: no tileInfo"),void this._set("isTileInfoDone",!0);if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");s="tileInfo"in i&&i.tileInfo}}else if(i&&"failed"!==i.loadStatus){if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");s="tileInfo"in i&&i.tileInfo}s&&!s.spatialReference.equals(this.spatialReference)&&(s=null),this._debugLog(`updateTileInfo: setting ${s}`),this._set("tileInfo",s),this._set("isTileInfoDone",!0)}_debugLog(e){this.logDebugInformation&&xe.info(e)}};function Oe(e){return e?JSON.stringify(e.toJSON()):"undefined"}function Ue(e){switch(e){case 0:return"Waiting";case 1:return"Found";case 2:return"Exhausted"}}Fe.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],e([n()],Fe.prototype,"logDebugInformation",void 0),e([n({readOnly:!0})],Fe.prototype,"isSpatialReferenceDone",void 0),e([n({readOnly:!0})],Fe.prototype,"isTileInfoDone",void 0),e([n({readOnly:!0})],Fe.prototype,"isHeightModelInfoSearching",void 0),e([n({constructOnly:!0})],Fe.prototype,"view",void 0),e([n({readOnly:!0})],Fe.prototype,"spatialReference",void 0),e([n({readOnly:!0})],Fe.prototype,"extent",void 0),e([n({readOnly:!0})],Fe.prototype,"heightModelInfo",void 0),e([n({readOnly:!0})],Fe.prototype,"vcsWkid",void 0),e([n({readOnly:!0})],Fe.prototype,"latestVcsWkid",void 0),e([n()],Fe.prototype,"mapCollectionPaths",void 0),e([n()],Fe.prototype,"defaultSpatialReference",void 0),e([n({readOnly:!0})],Fe.prototype,"tileInfo",void 0),Fe=Ee=e([b("esri.views.support.DefaultsFromMap")],Fe);var Ae,He=Fe;const We=t.getLogger("esri.views.View");let Ne=Ae=class extends(J(j.EventedMixin(M(l)))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new F({root:this,rootCollectionNames:["basemapView.baseLayerViews","groundView?.layerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:e=>e.layerViews}),this.animation=null,this.basemapView=null,this.defaultsFromMap=new He({view:this}),this.fatalError=null,this.extent=null,this.graphics=new Y,this.navigating=!1,this.layerViews=new k,this.magnifier=new ee,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.renderContext=null,this.input=new ce,this.navigation=new ue,this.layerViewManager=null,this.refreshManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new je(this),this.persistableViewModels=new k,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",(e=>{e?(this._currentSpatialReference=this.spatialReference,Ae.views.add(this)):(this._currentSpatialReference=null,Ae.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.layerViewManager.clear(),this.toolViewManager.detach(),this._teardown()):e&&!this.ready&&(this._startup(),this.toolViewManager.attach())}),!0))}initialize(){let e;this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,W(this,"ready"))))),this.basemapView=new X({view:this}),this.layerViewManager=new ge({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.refreshManager=new ve({view:this}),this.toolViewManager=new Pe({view:this}),this.analysisManager=new De({viewFactory:e=>this.createAnalysisView(e),controllerFactory:e=>this.createAnalysisController(e)}),this._resetInitialViewPropertiesFromContent(),H(this.defaultsFromMap,"isSpatialReferenceDone",(t=>{const i=!!(this.map&&this.map.allLayers.length>0);if(t&&!this.spatialReference&&i||!e){if(t&&!this.spatialReference&&i&&!e){const t=e=w(this.spatialReferenceWarningDelay);e.then((()=>{t===e&&We.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((()=>{}))}}else e=null}),!0)}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics.destroy(),this.graphics=null,this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager.destroy(),this.toolViewManager=null,this.refreshManager.destroy(),this.refreshManager=null,this.layerViewManager.destroy(),this.layerViewManager=null,this.basemapView.destroy(),this.basemapView=null,this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return We.error("#toMap()","Not implemented on this instance of View"),null}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!I.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)}set map(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(We.warn("#map","The provided map is already destroyed",{map:e}),e=null),I.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))}get spatialReference(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){this._userSpatialReference=e,this._set("spatialReference",e)}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){return this.defaultsFromMap&&this.defaultsFromMap.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return s(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getAnalysisView(e){return this.analysisManager.getAnalysisView(e)}whenAnalysisView(e){return this.analysisManager.whenAnalysisView(e)}getDefaultSpatialReference(){return this.get("defaultsFromMap.spatialReference")}getDefaultHeightModelInfo(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null}importLayerView(e){throw new _("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async createAnalysisView(e){throw new _("createAnalysisView() not implemented")}async createAnalysisController(e){throw new _("createAnalysisController() not implemented")}async validate(){}invalidate(){this._isValid=!1}isSpatialReferenceSupported(e,t,i){return!0}isTileInfoRequired(){return!1}when(e,t){return this.isResolved()&&!this.ready&&We.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),super.when(e,t)}forceReadyCycle(){this.ready&&(this._readyCycleForced=!0,K(this,"preconditionsReady",(()=>this._readyCycleForced=!1)))}createTool(e,t,i){return this.toolViewManager.createTool(e,t,i)}tryFatalErrorRecovery(){this.fatalError=null}_resetInitialViewPropertiesFromContent(){if(!this.defaultsFromMap)return;const e=()=>this.defaultsFromMap&&this.defaultsFromMap.start();this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([N(this,"spatialReference",((t,i)=>{C(t,i)||e()})),N(this,"initialExtentRequired",e),p(e)],"defaultsFromMap")}};Ne.views=new k,e([T("toolViewManager.activeTool")],Ne.prototype,"activeTool",void 0),e([n({readOnly:!0})],Ne.prototype,"allLayerViews",void 0),e([n()],Ne.prototype,"animation",void 0),e([n()],Ne.prototype,"basemapView",void 0),e([n()],Ne.prototype,"defaultsFromMap",void 0),e([n()],Ne.prototype,"fatalError",void 0),e([n({type:P})],Ne.prototype,"extent",void 0),e([n(Z())],Ne.prototype,"graphics",void 0),e([n({readOnly:!0,type:z,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"]})],Ne.prototype,"heightModelInfo",null),e([n({readOnly:!0})],Ne.prototype,"interacting",null),e([n({readOnly:!0})],Ne.prototype,"navigating",void 0),e([n({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"]})],Ne.prototype,"preconditionsReady",null),e([n({type:k,readOnly:!0})],Ne.prototype,"layerViews",void 0),e([n({type:ee})],Ne.prototype,"magnifier",void 0),e([n({value:null,type:O})],Ne.prototype,"map",null),e([n()],Ne.prototype,"padding",void 0),e([n({readOnly:!0})],Ne.prototype,"ready",void 0),e([n({type:V})],Ne.prototype,"spatialReference",null),e([n()],Ne.prototype,"spatialReferenceWarningDelay",void 0),e([n()],Ne.prototype,"stationary",null),e([n({readOnly:!0})],Ne.prototype,"supportsGround",void 0),e([n({type:U})],Ne.prototype,"timeExtent",void 0),e([T("toolViewManager.tools")],Ne.prototype,"tools",void 0),e([n()],Ne.prototype,"toolViewManager",void 0),e([T("analysisManager.analyses")],Ne.prototype,"analyses",void 0),e([n()],Ne.prototype,"analysisManager",void 0),e([n({readOnly:!0})],Ne.prototype,"type",void 0),e([n({type:Number})],Ne.prototype,"scale",void 0),e([n({readOnly:!0})],Ne.prototype,"updating",void 0),e([n({readOnly:!0})],Ne.prototype,"initialExtentRequired",void 0),e([n({readOnly:!0,type:P})],Ne.prototype,"initialExtent",null),e([n()],Ne.prototype,"cursor",null),e([n()],Ne.prototype,"renderContext",void 0),e([n({readOnly:!0})],Ne.prototype,"input",void 0),e([n({type:ue,nonNullable:!0})],Ne.prototype,"navigation",void 0),e([n()],Ne.prototype,"layerViewManager",void 0),e([n()],Ne.prototype,"width",void 0),e([n()],Ne.prototype,"height",void 0),e([n({readOnly:!0})],Ne.prototype,"resizing",void 0),e([n({value:null,readOnly:!0})],Ne.prototype,"size",null),e([n({readOnly:!0})],Ne.prototype,"suspended",void 0),e([n({readOnly:!0})],Ne.prototype,"viewEvents",void 0),e([n({readOnly:!0})],Ne.prototype,"persistableViewModels",void 0),e([n()],Ne.prototype,"_isValid",void 0),e([n()],Ne.prototype,"_readyCycleForced",void 0),e([n()],Ne.prototype,"_currentSpatialReference",void 0),Ne=Ae=e([b("esri.views.View")],Ne);var Be=Ne;export default Be;
