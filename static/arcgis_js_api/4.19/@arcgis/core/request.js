/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{h as e,clone as t,g as r}from"./core/lang.js";import"./chunks/object.js";import{id as s}from"./kernel.js";import o from"./config.js";import{i as n,u as a}from"./chunks/Logger.js";import"./chunks/string.js";import{isAborted as i,createAbortController as l,onAbort as c,isAbortError as u,createAbortError as d}from"./core/promiseUtils.js";import"./chunks/Message.js";import p from"./core/Error.js";import{getOrigin as m,isDataProtocol as h,isBlobProtocol as f,normalize as w,getInterceptor as g,isTrustedServer as y,toHTTPS as b,addQueryParameter as k,objectToQuery as q,getProxyRule as O,getProxyUrl as T,addQueryParameters as E,hasSameOrigin as x,appUrl as v,addProxyRule as S,removeFile as L,urlToObject as C}from"./core/urlUtils.js";const j=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function U(t,r,s=!1,o){return new Promise(((a,l)=>{if(i(o))return void l(_());let c=()=>{p(),l(new Error(`Unable to load ${r}`))},u=()=>{const e=t;p(),a(e)},d=()=>{if(!t)return;const e=t;p(),e.src="",l(_())};const p=()=>{e("esri-image-decode")||(t.removeEventListener("error",c),t.removeEventListener("load",u)),c=null,u=null,t=null,n(o)&&o.removeEventListener("abort",d),d=null,s&&URL.revokeObjectURL(r)};n(o)&&o.addEventListener("abort",d),e("esri-image-decode")?t.decode().then(u,c):(t.addEventListener("error",c),t.addEventListener("load",u))}))}function _(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function P(t,n){const u=h(t),d=f(t);d||u||(t=w(t));const b={url:t,requestOptions:{...a(n)}};let k=g(t);if(k){const e=await async function(e,t){if(null!=e.responseData)return e.responseData;e.headers&&(t.requestOptions.headers={...t.requestOptions.headers,...e.headers});e.query&&(t.requestOptions.query={...t.requestOptions.query,...e.query});if(e.before){let r,s;try{s=await e.before(t)}catch(e){r=B("request:interceptor",e,t)}if((s instanceof Error||s instanceof p)&&(r=B("request:interceptor",s,t)),r)throw e.error&&e.error(r),r;return s}}(k,b);if(null!=e)return{data:e,getHeader:H,requestOptions:b.requestOptions,url:b.url};k.after||k.error||(k=null)}if(t=b.url,"image"===(n=b.requestOptions).responseType){if(e("host-webworker")||e("host-node"))throw B("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),b)}else if(u)throw B("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+n.responseType),b);if("head"===n.method){if(n.body)throw B("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),b);if(u||d)throw B("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),b)}if(await async function(){e("host-webworker")?D||(D=await import("./chunks/request.js")):P._abortableFetch||(P._abortableFetch=r.fetch.bind(r))}(),D)return D.execute(t,n);const q=l();c(n,(()=>q.abort()));const O={controller:q,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:k,params:b,redoRequest:!1,useIdentity:M.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},T=await async function(e){let t,n;await async function(e){const t=e.params.url,n=e.params.requestOptions,a=e.controller.signal,l=n.body;let c=null,u=null,d=null;R&&"HTMLFormElement"in r&&(l instanceof FormData?c=l:l instanceof HTMLFormElement&&(u=l,c=new FormData(u)));"string"==typeof l&&(d=l);e.fetchOptions={cache:n.cacheBust&&!P._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:n.headers||{},method:"head"===n.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:a},(c||d)&&(e.fetchOptions.body=c||d);"anonymous"===n.authMode&&(e.useIdentity=!1);e.hasToken=!!(/token=/i.test(t)||n.query&&n.query.token||c&&c.get&&c.get("token")||u&&u.elements.token),!e.hasToken&&o.apiKey&&function(e){const t=m(e,!0);return t&&t.endsWith(".arcgis.com")&&!j.includes(t)&&!e.endsWith("/sharing/rest/generateToken")}(t)&&(n.query||(n.query={}),n.query.token=o.apiKey,e.hasToken=!0);if(e.useIdentity&&!e.hasToken&&!e.credentialToken&&!$(t)&&!i(a)){let r;"immediate"===n.authMode?(await N(),r=await s.getCredential(t,{signal:a}),e.credential=r):"no-prompt"===n.authMode?(await N(),r=await s.getCredential(t,{prompt:!1,signal:a}).catch((()=>{})),e.credential=r):s&&(r=s.findCredential(t)),r&&(e.credentialToken=r.token,e.useSSL=!!r.ssl)}}(e);try{do{[t,n]=await W(e)}while(!await G(e,t,n))}catch(r){const s=B("request:server",r,e.params,t);throw s.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(s),s}const a=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(a)&&!e.hasToken&&!e.credentialToken&&n&&n.user&&n.user.username&&!y(a)){const e=m(a,!0);e&&M.trustedServers.push(e)}const l=e.credential;if(l&&s){const e=s.findServerInfo(l.server);let t=e&&e.owningSystemUrl;if(t){t=t.replace(/\/?$/,"/sharing");const e=s.findCredential(t,l.userId);e&&-1===s._getIdenticalSvcIdx(t,e)&&e.resources.unshift(t)}}return{data:n,getHeader:t?e=>t.headers.get(e):H,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}(O);return k&&k.after&&k.after(T),T}let D;const M=o.request,R="FormData"in r,F=[499,498,403,401],I=["COM_0056","COM_0057","SB_0008"],A=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],H=()=>null;function B(e,r,s,o){let n="Error";const a={url:s.url,requestOptions:s.requestOptions,getHeader:H,ssl:!1};if(r instanceof p)return r.details?(r.details=t(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=a,r;if(r){const e=o&&(e=>o.headers.get(e)),t=o&&o.status,s=r.message;s&&(n=s),e&&(a.getHeader=e),a.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,a.subCode=r.subcode,a.messageCode=r.messageCode,"string"==typeof r.details?a.messages=[r.details]:a.messages=r.details}return u(r)?d():new p(e,n,a)}async function N(){s||await import("./identity/IdentityManager.js")}function $(e){return A.some((t=>t.test(e)))}async function W(t){let r=t.params.url;const o=t.params.requestOptions,n=t.fetchOptions,a=f(r)||h(r),i=o.responseType||"json",l=a?0:null!=o.timeout?o.timeout:M.timeout;let c=!1;if(!a){t.useSSL&&(r=b(r)),o.cacheBust&&"default"===n.cache&&(r=k(r,"request.preventCache",Date.now()));let a={...o.query};t.credentialToken&&(a.token=t.credentialToken);let i=q(a);e("esri-url-encodes-apostrophe")&&(i=i.replace(/'/g,"%27"));const l=r.length+1+i.length;let u;c="delete"===o.method||"post"===o.method||"put"===o.method||!!o.body||l>M.maxUrlLength;const d=o.useProxy||!!O(r);if(d){const e=T(r);u=e.path,!c&&u.length+1+l>M.maxUrlLength&&(c=!0),e.query&&(a={...e.query,...a})}if("HEAD"===n.method&&(c||d)){if(c){if(l>M.maxUrlLength)throw B("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params);throw B("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params)}if(d)throw B("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(c?(n.method="delete"===o.method?"DELETE":"put"===o.method?"PUT":"POST",o.body?r=E(r,a):(n.body=q(a),n.headers["Content-Type"]="application/x-www-form-urlencoded")):r=E(r,a),d&&(t.useProxy=!0,r=`${u}?${r}`),a.token&&R&&n.body instanceof FormData){const e=n.body;e.set?e.set("token",a.token):e.append("token",a.token)}if(o.hasOwnProperty("withCredentials"))t.withCredentials=o.withCredentials;else if(!x(r,v))if(y(r))t.withCredentials=!0;else if(s){const e=s.findServerInfo(r);e&&e.webTierAuth&&(t.withCredentials=!0)}t.withCredentials&&(n.credentials="include")}let u,p,w=0,g=!1;l>0&&(w=setTimeout((()=>{g=!0,t.controller.abort()}),l));try{if("image"!==o.responseType||"default"!==n.cache||"GET"!==n.method||c||function(e){if(e)for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0;return!1}(o.headers)||!a&&!t.useProxy&&M.proxyUrl&&!function(e){const t=m(e);return!t||t.endsWith(".arcgis.com")||-1!==P._corsServers.indexOf(t)||y(t)}(r)){if(u=await P._abortableFetch(r,n),t.useProxy||function(e){if(f(e)||h(e))return;const t=m(e);t&&-1===P._corsServers.indexOf(t)&&P._corsServers.push(t)}(r),u.ok&&"HEAD"!==n.method){switch(i){case"array-buffer":p=await u.arrayBuffer();break;case"blob":case"image":p=await u.blob();break;default:p=await u.text()}if(w&&(clearTimeout(w),w=0),"json"===i||"xml"===i||"document"===i)if(p)switch(i){case"json":p=JSON.parse(p);break;case"xml":p=z(p,"application/xml");break;case"document":p=z(p,"text/html")}else p=null;if(p){if("array-buffer"===i||"blob"===i){const e=u.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&p["blob"===i?"size":"byteLength"]<=750)try{const e=await new Response(p).json();e.error&&(p=e)}catch{}}"image"===i&&p instanceof Blob&&(p=await K(URL.createObjectURL(p),t,!0))}}}else p=await K(r,t)}catch(e){if("AbortError"===e.name){if(g)throw new Error("Timeout exceeded");throw d("Request canceled")}if(!(!u&&e instanceof TypeError&&M.proxyUrl)||o.body||"delete"===o.method||"head"===o.method||"post"===o.method||"put"===o.method||t.useProxy)throw e;t.redoRequest=!0,S({proxyUrl:M.proxyUrl,urlPrefix:L(C(r).path)})}finally{w&&clearTimeout(w)}return[u,p]}function z(e,t){let r;try{r=(new DOMParser).parseFromString(e,t)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function G(e,t,r){if(e.redoRequest)return e.redoRequest=!1,!1;if(!t)return!0;if(!t.ok)throw new Error(`Unable to load ${t.url} status: ${t.status}`);let o,n,a,i;r&&r.error&&(o=Object.assign(new Error,r.error)),o&&(n=Number(o.code),a=o.hasOwnProperty("subcode")?Number(o.subcode):null,i=o.messageCode,i=i&&i.toUpperCase());const l=e.params.requestOptions.authMode;if(403===n&&(4===a||o.message&&o.message.toLowerCase().indexOf("ssl")>-1&&-1===o.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==l||498===n)&&-1!==F.indexOf(n)&&!$(e.params.url)&&(403!==n||-1===I.indexOf(i)&&(null==a||2===a&&e.credentialToken))){await N();try{const t=await s.getCredential(e.params.url,{error:B("request:server",o,e.params),prompt:"no-prompt"!==l,signal:e.controller.signal,token:e.credentialToken});return e.credential=t,e.credentialToken=t.token,e.useSSL=e.useSSL||t.ssl,!1}catch(t){if("no-prompt"===l)return e.credential=null,e.credentialToken=null,!1;o=t}}if(o)throw o;return!0}function K(e,t,r=!1){const s=t.controller.signal,o=new Image;return t.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.src=e,U(o,e,r,s)}P._abortableFetch=null,P._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var J=Object.freeze({__proto__:null,default:P});export default P;export{U as l,J as r};
