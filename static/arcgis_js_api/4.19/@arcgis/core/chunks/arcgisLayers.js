/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../core/lang.js";import"./object.js";import"../kernel.js";import"../config.js";import{b as e,i as r}from"./Logger.js";import"./string.js";import"../core/promiseUtils.js";import"./Message.js";import a from"../core/Error.js";import{getFilename as t,urlToObject as l}from"../core/urlUtils.js";import"./persistableUrlUtils.js";import s from"../request.js";import{p as n,f as o}from"./arcgisLayerUrl.js";import{l as i}from"./lazyLayerLoader.js";async function u(s){var u;const p=null==(u=s.properties)?void 0:u.customParameters,f=await async function(s,u){let y=n(s);e(y)&&(y=await async function(e,a){const s=await d(e,a);let n=null,i=null;const u=s.type;"Feature Layer"===u||"Table"===u?(n="FeatureServer",i=s.id):"indexedVector"===u?n="VectorTileServer":s.hasOwnProperty("mapName")?n="MapServer":s.hasOwnProperty("bandCount")&&s.hasOwnProperty("pixelSizeX")?n="ImageServer":s.hasOwnProperty("maxRecordCount")&&s.hasOwnProperty("allowGeometryUpdates")?n="FeatureServer":s.hasOwnProperty("streamUrls")&&(n="StreamServer");if(!n)return null;const y=null!=i?o(e):null;return{title:r(y)&&s.name||t(e),serverType:n,sublayer:i,url:{path:r(y)?y.serviceUrl:l(e).path}}}(s,u));if(e(y))throw new a("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:s});const{serverType:p,sublayer:f}=y;let m;const I={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(p){case"MapServer":m=null!=f?"FeatureLayer":async function(e,r){return(await d(e,r)).tileInfo}(s,u).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":m=d(s,u).then((e=>{const r=e.tileInfo&&e.tileInfo.format;return e.tileInfo?!r||"LERC"!==r.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":m=d(y.url.path,u).then((e=>{const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};if(e&&Array.isArray(e.layers)&&e.layers.length>0){const a=e.layers[0].layerType;if(null!=r[a])return r[a]}return"SceneLayer"}));break;default:m=I[p]}const b={FeatureLayer:!0,SceneLayer:!0},v="FeatureServer"===p,S={parsedUrl:y,Constructor:null,layerOrTableId:v?f:null,sublayerIds:null,tableIds:null},w=await m;if(b[w]&&null==f){const e=await async function(e,r,a){var t,l;let s,n=!1;if("FeatureServer"===r){const r=await async function(e,r){var a,t;let l=await d(e,r);l=l||{},l.layers=(null==(a=l.layers)?void 0:a.filter(c))||[];const s={serviceJSON:l};if(l.currentVersion<10.5)return s;const n=await d(e+"/layers",r);return s.layersJSON={layers:(null==n||null==(t=n.layers)?void 0:t.filter(c))||[],tables:(null==n?void 0:n.tables)||[]},s}(e,a);n=!!r.layersJSON,s=r.layersJSON||r.serviceJSON}else s=await d(e,a);const o=null==(t=s)?void 0:t.layers,i=null==(l=s)?void 0:l.tables;return{layerIds:(null==o?void 0:o.map((e=>e.id)).reverse())||[],tableIds:(null==i?void 0:i.map((e=>e.id)).reverse())||[],layerInfos:n?o:[],tableInfos:n?i:[]}}(s,p,u);v&&(S.sublayerInfos=e.layerInfos,S.tableInfos=e.tableInfos);if(1!==e.layerIds.length+e.tableIds.length)S.sublayerIds=e.layerIds,S.tableIds=e.tableIds;else if(v){var L,h;S.layerOrTableId=null!=(L=e.layerIds[0])?L:e.tableIds[0],S.sourceJSON=null!=(h=e.layerInfos[0])?h:e.tableInfos[0]}}return S.Constructor=await async function(e){return(0,i[e])()}(w),S}(s.url,p),m={...s.properties,url:s.url};if(!f.sublayerIds)return null!=f.layerOrTableId&&(m.layerId=f.layerOrTableId,m.sourceJSON=f.sourceJSON),new f.Constructor(m);const I=new(0,(await import("../layers/GroupLayer.js")).default)({title:f.parsedUrl.title});return function(e,a,t){function l(e,l){const s={...t,layerId:e,sublayerTitleMode:"service-name"};return r(l)&&(s.sourceJSON=l),new a.Constructor(s)}a.sublayerIds.forEach((r=>{const t=l(r,y(a.sublayerInfos,r));e.add(t)})),a.tableIds.forEach((r=>{const t=l(r,y(a.tableInfos,r));e.tables.add(t)}))}(I,f,m),I}function y(e,r){return e?e.find((e=>e.id===r)):null}function c(e){return!e.type||"Feature Layer"===e.type}async function d(e,r){return(await s(e,{responseType:"json",query:{f:"json",...r}})).data}export{u as fromUrl};
