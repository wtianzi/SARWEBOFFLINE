/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"./tslib.es6.js";import"./ArrayPool.js";import"../core/lang.js";import"./deprecate.js";import"./object.js";import"../kernel.js";import"../config.js";import"./Logger.js";import"./string.js";import"./metadata.js";import"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import"../core/scheduling.js";import{create as e,all as t,reject as r,resolve as n}from"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import"./ensureType.js";import"../core/accessorSupport/decorators/subclass.js";import"./JSONSupport.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./writer.js";import"./resourceExtension.js";import o from"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../request.js";import"./assets.js";import a from"../geometry/Geometry.js";import s from"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import i from"../geometry/Extent.js";import"./zmUtils.js";import c from"../geometry/Multipoint.js";import l from"../geometry/Polygon.js";import"./extentUtils.js";import u from"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./sizeVariableUtils.js";import"../core/watchUtils.js";import"./fieldType.js";import"./Scheduler.js";import"../core/workers/RemoteClient.js";import"../core/workers/Connection.js";import"../core/workers/workers.js";import"../geometry/geometryEngineAsync.js";import"../layers/support/Field.js";import"./OptimizedFeatureSet.js";import"./featureConversionUtils.js";import"./number3.js";import"./moment.js";import{r as p,a as f,b as h,c as m,d,e as g,p as y,i as E,f as w,N as v,g as N,R as I,I as b,v as S,h as T,j as R,F as j,k as O,l as U,m as A,n as C,o as M,q as x,s as F,t as D,u as P,w as k,x as L,D as _,y as V,z as B,A as Y,B as G,C as z,E as q,G as H,H as Z,J,K,L as W,M as X,O as Q,P as $}from"./arcadeUtils.js";import"./centroid.js";import"./FeatureSetReader.js";import{registerFunctions as ee}from"./geomasync.js";function te(e){return e instanceof Error?r(e):r(new Error(e))}function re(e){return n(e)}function ne(e,r){const n=[];for(let t=0;t<r.arguments.length;t++)n.push(se(e,r.arguments[t]));return t(n)}function oe(t,r,n){return e(((e,o)=>{ne(t,r).then((a=>{try{e(n(t,r,a))}catch(e){o(e)}}),o)}))}function ae(e,t,r){try{return ne(e,t).then((o=>{try{const s=r(e,t,o);return(a=s)&&"function"==typeof a.then?s:n(s)}catch(e){return te(e)}var a}))}catch(e){return te(e)}}function se(o,s,i){try{if(s.breakpoint&&!0!==i){return s.breakpoint().then((()=>se(o,s,!0)))}switch(s.type){case"VariableDeclarator":return function(t,r){try{let o=null;return o=null===r.init?n(null):se(t,r.init),null!==t.localScope?o.then((n=>e((e=>{if(n===S&&(n=null),"Identifier"!==r.id.type)throw new Error("Can only assign a regular variable");const o=r.id.name.toLowerCase();t.localScope[o]={value:n,valueset:!0,node:r.init},e(S)})))):o.then((n=>e((e=>{if("Identifier"!==r.id.type)throw new Error("Can only assign a regular variable");const o=r.id.name.toLowerCase();n===S&&(n=null),t.globalScope[o]={value:n,valueset:!0,node:r.init},e(S)}))))}catch(e){return te(e)}}(o,s);case"VariableDeclaration":return de(o,s,0);case"BlockStatement":return function(e,t){try{return me(e,t,0)}catch(e){return te(e)}}(o,s);case"FunctionDeclaration":return function(e,t){try{const r=t.id.name.toLowerCase();return e.globalScope[r]={valueset:!0,node:null,value:new j(t,e)},n(S)}catch(e){return te(e)}}(o,s);case"ReturnStatement":return function(t,r){return e(((e,n)=>{null===r.argument?e(new I(S)):se(t,r.argument).then((t=>{try{e(new I(t))}catch(e){n(e)}}),n)}))}(o,s);case"IfStatement":return function(t,r){return e(((e,n)=>{"AssignmentExpression"!==r.test.type&&"UpdateExpression"!==r.test.type?se(t,r.test).then((o=>{try{!0===o?se(t,r.consequent).then(e,n):!1===o?null!==r.alternate?se(t,r.alternate).then(e,n):e(S):n(new Error(x(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))}catch(e){n(e)}}),n):n(new Error(x(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}(o,s);case"ExpressionStatement":return function(t,n){try{return"AssignmentExpression"===n.expression.type?se(t,n.expression):(n.expression.type,se(t,n.expression).then((t=>e((e=>{e(t===S?S:new b(t))})))))}catch(e){return r(e)}}(o,s);case"UpdateExpression":return function(t,o){try{const r=o.argument;if("MemberExpression"===r.type){const a={t:null};return se(t,r.object).then((e=>{let o=null;return a.t=e,!0===r.computed?o=se(t,r.property):"Identifier"===r.property.type&&(o=n(r.property.name)),o})).then((t=>e((e=>{const r=a.t;let n;if(P(r)){if(!Y(t))throw new Error("Invalid Parameter");if(t<0&&(t=r.length+t),t<0||t>=r.length)throw new Error("Assignment outside of array bounds");n=z(r[t]),r[t]="++"===o.operator?n+1:n-1}else if(r instanceof _){if(!1===k(t))throw new Error("Dictionary accessor must be a string");if(!0!==r.hasField(t))throw new Error("Invalid Parameter");n=z(r.field(t)),r.setField(t,"++"===o.operator?n+1:n-1)}else{if(!(r instanceof V))throw L(r)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===k(t))throw new Error("Feature accessor must be a string");if(!0!==r.hasField(t))throw new Error("Invalid Parameter");n=z(r.field(t)),r.setField(t,"++"===o.operator?n+1:n-1)}!1===o.prefix?e(n):e("++"===o.operator?n+1:n-1)}))))}return e(((e,r)=>{const n="Identifier"===o.argument.type?o.argument.name.toLowerCase():"";if(!n)throw new Error("Invalid identifier");let a;return null!==t.localScope&&void 0!==t.localScope[n]?(a=z(t.localScope[n].value),t.localScope[n]={value:"++"===o.operator?a+1:a-1,valueset:!0,node:o},void(!1===o.prefix?e(a):e("++"===o.operator?a+1:a-1))):void 0!==t.globalScope[n]?(a=z(t.globalScope[n].value),t.globalScope[n]={value:"++"===o.operator?a+1:a-1,valueset:!0,node:o},void(!1===o.prefix?e(a):e("++"===o.operator?a+1:a-1))):void r(new Error("Variable not recognised"))}))}catch(e){return r(e)}}(o,s);case"AssignmentExpression":return function(t,r){return e(((e,o)=>{const a=r.left;if("MemberExpression"===a.type)se(t,r.right).then((s=>{try{se(t,a.object).then((i=>{try{let c=null;if(!0===a.computed)c=se(t,a.property);else{if("Identifier"!==a.property.type)throw new Error("Expected computed or identifier for assignemnt target");c=n(a.property.name)}c.then((t=>{try{if(P(i)){if(!Y(t))throw new Error("Invalid Parameter");if(t<0&&(t=i.length+t),t<0||t>i.length)throw new Error("Assignment outside of array bounds");if(t===i.length){if("="!==r.operator)throw new Error("Invalid Parameter");i[t]=he(s,r.operator,i[t],r)}else i[t]=he(s,r.operator,i[t],r)}else if(i instanceof _){if(!1===k(t))throw new Error("Dictionary accessor must be a string");if(!0===i.hasField(t))i.setField(t,he(s,r.operator,i.field(t),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");i.setField(t,he(s,r.operator,null,r))}}else{if(!(i instanceof V))throw L(i)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===k(t))throw new Error("Feature accessor must be a string");if(!0===i.hasField(t))i.setField(t,he(s,r.operator,i.field(t),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");i.setField(t,he(s,r.operator,null,r))}}e(S)}catch(e){o(e)}}),o)}catch(e){o(e)}}),o)}catch(e){o(e)}}),o);else{const n=a.name.toLowerCase();if(null!==t.localScope&&void 0!==t.localScope[n])return void se(t,r.right).then((a=>{try{t.localScope[n]={value:he(a,r.operator,t.localScope[n].value,r),valueset:!0,node:r.right},e(S)}catch(e){o(e)}}),o);void 0!==t.globalScope[n]?se(t,r.right).then((a=>{try{t.globalScope[n]={value:he(a,r.operator,t.globalScope[n].value,r),valueset:!0,node:r.right},e(S)}catch(e){o(e)}}),o):o(new Error("Cannot assign undeclared variable"))}}))}(o,s);case"ForStatement":return function(t,n){try{return null!==n.init?se(t,n.init).then((()=>e(((e,r)=>{ce(t,n,{testResult:!0,lastAction:S},(t=>{e(t)}),(e=>{r(e)}),0)})))):e(((e,r)=>{ce(t,n,{testResult:!0,lastAction:S},(t=>{e(t)}),(e=>{r(e)}),0)}))}catch(e){return r(e)}}(o,s);case"ForInStatement":return function(t,r){return e(((e,o)=>{se(t,r.right).then((a=>{try{let s=null;s="VariableDeclaration"===r.left.type?se(t,r.left):n(),s.then((()=>{try{let n="";if("VariableDeclaration"===r.left.type){const e=r.left.declarations[0].id;"Identifier"===e.type&&(n=e.name)}else"Identifier"===r.left.type&&(n=r.left.name);if(!n)throw new Error(x(r,"RUNTIME","INVALIDVARIABLE"));n=n.toLowerCase();let s=null;if(null!==t.localScope&&void 0!==t.localScope[n]&&(s=t.localScope[n]),null===s&&void 0!==t.globalScope[n]&&(s=t.globalScope[n]),null===s)return void o(new Error(x(r,"RUNTIME","VARIABLENOTDECLARED")));P(a)||k(a)?pe(t,r,a,{reject:o,resolve:e},s):L(a)?function(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(S);ue(e,t,r,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}(t,r,a,{reject:o,resolve:e},s):a instanceof _||a instanceof V?function(e,t,r,n,o){try{pe(e,t,r.keys(),n,o,"k")}catch(e){n.reject(e)}}(t,r,a,{reject:o,resolve:e},s):B(a)?fe(a.iterator(t.abortSignal),t,r,a,s,(t=>{e(t)}),(e=>{o(e)}),0):pe(t,r,[],{reject:o,resolve:e},s)}catch(e){o(e)}}),o)}catch(e){o(e)}}),o)}))}(o,s);case"BreakStatement":return n(T);case"EmptyStatement":return n(S);case"ContinueStatement":return n(R);case"TemplateElement":return function(e,t){return n(t.value?t.value.cooked:"")}(0,s);case"TemplateLiteral":return function(t,r){return e((e=>{const n=[];F(r.expressions,((e,r,o,a)=>se(t,r).then((e=>{n[o]=D(e)})))).then((()=>{let t="",o=0;for(const e of r.quasis)if(t+=e.value?e.value.cooked:"",!1===e.tail){t+=n[o]?n[o]:"",o++}e(t)}))}))}(o,s);case"Identifier":return Ee(o,s);case"MemberExpression":return function(t,o){try{return se(t,o.object).then((s=>{try{return null===s?r(new Error(x(o,"RUNTIME","NOTFOUND"))):!1===o.computed?"Identifier"===o.property.type?s instanceof _||s instanceof V?n(s.field(o.property.name)):s instanceof a?n(ye(s,o.property.name,t,o)):r(new Error(x(o,"RUNTIME","INVALIDTYPE"))):r(new Error(x(o,"RUNTIME","INVALIDTYPE"))):se(t,o.property).then((r=>e(((e,n)=>{if(s instanceof _||s instanceof V)k(r)?e(s.field(r)):n(new Error(x(o,"RUNTIME","INVALIDTYPE")));else if(s instanceof a)k(r)?e(ye(s,r,t,o)):n(new Error(x(o,"RUNTIME","INVALIDTYPE")));else if(P(s))if(Y(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=s.length+r),r>=s.length||r<0)throw new Error(x(o,"RUNTIME","OUTOFBOUNDS"));e(s[r])}else n(new Error(x(o,"RUNTIME","INVALIDTYPE")));else if(L(s))if(Y(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=s.length()+r),r>=s.length()||r<0)throw new Error(x(o,"RUNTIME","OUTOFBOUNDS"));e(s.get(r))}else n(new Error(x(o,"RUNTIME","INVALIDTYPE")));else if(k(s))if(Y(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=s.length+r),r>=s.length||r<0)throw new Error(x(o,"RUNTIME","OUTOFBOUNDS"));e(s[r])}else n(new Error(x(o,"RUNTIME","INVALIDTYPE")));else n(new Error(x(o,"RUNTIME","INVALIDTYPE")))}))))}catch(e){return te(e)}}))}catch(e){return te(e)}}(o,s);case"Literal":return re(s.value);case"CallExpression":return function(e,t){try{if("Identifier"!==t.callee.type)return te(x(t,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[t.callee.name.toLowerCase()]){const r=e.localScope[t.callee.name.toLowerCase()];return r.value instanceof v?r.value.fn(e,t):r.value instanceof j?je(e,t,r.value.definition):te(x(t,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[t.callee.name.toLowerCase()]){const r=e.globalScope[t.callee.name.toLowerCase()];return r.value instanceof v?r.value.fn(e,t):r.value instanceof j?je(e,t,r.value.definition):te(x(t,"RUNTIME","NOTAFUNCTION"))}return te(x(t,"RUNTIME","NOTFOUND"))}catch(e){return te(e)}}(o,s);case"UnaryExpression":return function(t,r){try{return se(t,r.argument).then((t=>e(((e,n)=>{E(t)&&"!"===r.operator?e(!t):"-"===r.operator?e(-1*z(t)):"+"===r.operator?e(1*z(t)):"~"===r.operator?e(~z(t)):n(new Error(x(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))}))))}catch(e){return te(e)}}(o,s);case"BinaryExpression":return function(r,n){try{return t([se(r,n.left),se(r,n.right)]).then((t=>e(((e,r)=>{const o=t[0],a=t[1];switch(n.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":e(H(z(o),z(a),n.operator));case"==":e(w(o,a));break;case"!=":e(!w(o,a));break;case"<":case">":case"<=":case">=":e(q(o,a,n.operator));break;case"+":k(o)||k(a)?e(D(o)+D(a)):e(z(o)+z(a));break;case"-":e(z(o)-z(a));break;case"*":e(z(o)*z(a));break;case"/":e(z(o)/z(a));break;case"%":e(z(o)%z(a));break;default:r(new Error(x(n,"RUNTIME","OPERATORNOTRECOGNISED")))}}))))}catch(e){return te(e)}}(o,s);case"LogicalExpression":return function(t,r){return e(((e,n)=>{"AssignmentExpression"!==r.left.type&&"UpdateExpression"!==r.left.type?"AssignmentExpression"!==r.right.type&&"UpdateExpression"!==r.right.type?se(t,r.left).then((o=>{try{if(!E(o))throw new Error(x(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":!0===o?e(o):se(t,r.right).then((t=>{try{if(!E(t))throw new Error(x(r,"RUNTIME","ONLYORORAND"));e(t)}catch(e){n(e)}}),n);break;case"&&":!1===o?e(o):se(t,r.right).then((t=>{try{if(!E(t))throw new Error(x(r,"RUNTIME","ONLYORORAND"));e(t)}catch(e){n(e)}}),n);break;default:throw new Error(x(r,"RUNTIME","ONLYORORAND"))}}catch(e){n(e)}}),n):n(new Error(x(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))):n(new Error(x(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION")))}))}(o,s);case"ConditionalExpression":return te(x(s,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return function(r,n){try{const o=[];for(let e=0;e<n.elements.length;e++)o.push(se(r,n.elements[e]));return t(o).then((t=>e(((e,r)=>{for(let e=0;e<t.length;e++){if(G(t[e]))return void r(new Error(x(n,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));t[e]===S&&(t[e]=null)}e(t)}))))}catch(e){return te(e)}}(o,s);case"ObjectExpression":return function(r,n){try{const o=[];for(let e=0;e<n.properties.length;e++)o.push(se(r,n.properties[e]));return t(o).then((t=>e((e=>{const r={};for(let e=0;e<t.length;e++){const n=t[e];if(G(n.value))throw new Error("Illegal Argument");if(!1===k(n.key))throw new Error("Illegal Argument");n.value===S?r[n.key.toString()]=null:r[n.key.toString()]=n.value}const n=new _(r);n.immutable=!1,e(n)}))))}catch(e){return te(e)}}(o,s);case"Property":return function(t,n){try{return se(t,n.value).then((r=>e((e=>{"Identifier"===n.key.type?e({key:n.key.name,value:r}):se(t,n.key).then((t=>{e({key:t,value:r})}))}))))}catch(e){return r(e)}}(o,s);default:return te(x(s,"RUNTIME","UNREOGNISED"))}}catch(e){return te(e)}}function ie(e,t,o){try{return se(e,t.body).then((a=>{try{return o.lastAction=a,o.lastAction===T||o.lastAction instanceof I?(o.testResult=!1,n(o)):null!==t.update?se(e,t.update).then((()=>n(o))):n(o)}catch(e){return r(e)}}))}catch(e){return r(e)}}function ce(e,t,o,a,s,i){try{(function(e,t,o){try{return null!==t.test?se(e,t.test).then((a=>{try{return!0===e.abortSignal.aborted?r(new Error("Cancelled")):(o.testResult=a,!1===o.testResult?n(o):!0!==o.testResult?r(new Error(x(t,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):ie(e,t,o))}catch(e){return r(e)}})):ie(e,t,o)}catch(e){return r(e)}})(e,t,o).then((()=>{try{!0===o.testResult?++i>100?(i=0,setTimeout((()=>{ce(e,t,o,a,s,i)}),0)):ce(e,t,o,a,s,i):o.lastAction instanceof I?a(o.lastAction):a(S)}catch(e){s(e)}}),(e=>{s(e)}))}catch(e){s(e)}}function le(e,t,r,n,o,a,s,i,c,l){try{if(n<=a)return void i(S);o.value="k"===s?r[a]:a,se(e,t.body).then((u=>{try{u instanceof I?i(u):u===T?i(S):++l>100?(l=0,setTimeout((()=>{le(e,t,r,n,o,a+1,s,i,c,l)}),0)):le(e,t,r,n,o,a+1,s,i,c,l)}catch(e){c(e)}}),(e=>{c(e)}))}catch(e){c(e)}}function ue(e,t,r,n,o,a,s,i,c){try{if(r.length()<=o)return void s(S);n.value="k"===a?r.get(o):o,se(e,t.body).then((l=>{l instanceof I?s(l):l===T?s(S):++c>100?(c=0,setTimeout((()=>{ue(e,t,r,n,o+1,a,s,i,c)}),0)):ue(e,t,r,n,o+1,a,s,i,c)}),(e=>{i(e)}))}catch(e){i(e)}}function pe(e,t,r,n,o,a){try{if(void 0===a&&(a="i"),0===r.length)return void n.resolve(S);le(e,t,r,r.length,o,0,a,(e=>{n.resolve(e)}),(e=>{n.reject(e)}),0)}catch(e){n.reject(e)}}function fe(e,t,r,n,o,a,s,i){try{e.next().then((c=>{try{if(null===c)a(S);else{const l=V.createFromGraphicLikeObject(c.geometry,c.attributes,n);l._underlyingGraphic=c,o.value=l;se(t,r.body).then((c=>{try{c===T?a(S):c instanceof I?a(c):++i>100?(i=0,setTimeout((()=>{fe(e,t,r,n,o,a,s,i)}),0)):fe(e,t,r,n,o,a,s,i)}catch(e){s(e)}}),(e=>{s(e)}))}}catch(e){s(e)}}),(e=>{s(e)}))}catch(e){s(e)}}function he(e,t,r,n){switch(t){case"=":return e===S?null:e;case"/=":return z(r)/z(e);case"*=":return z(r)*z(e);case"-=":return z(r)-z(e);case"+=":return k(r)||k(e)?D(r)+D(e):z(r)+z(e);case"%=":return z(r)%z(e);default:throw new Error(x(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}function me(t,r,o){try{return o>=r.body.length?n(S):e(((e,n)=>{se(t,r.body[o]).then((a=>{try{a instanceof I||a===T||a===R||o===r.body.length-1?e(a):me(t,r,o+1).then(e,n)}catch(e){n(e)}}),n)}))}catch(e){return te(e)}}function de(t,r,n){return e(((e,o)=>{n>=r.declarations.length?e(S):se(t,r.declarations[n]).then((()=>{n===r.declarations.length-1?e(S):de(t,r,n+1).then((()=>{e(S)}),o)}),o)}))}let ge=0;function ye(e,t,r,n){let o;switch(t=t.toLowerCase()){case"hasz":{const t=e.hasZ;return void 0!==t&&t}case"hasm":{const t=e.hasM;return void 0!==t&&t}case"spatialreference":{let t=e.spatialReference._arcadeCacheId;if(void 0===t){let r=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(r=!1),r&&(ge++,e.spatialReference._arcadeCacheId=ge,t=ge)}const r=new _({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==t&&(r._arcadeCacheId="SPREF"+t.toString()),r}}switch(e.type){case"extent":switch(t){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":{const r=e[t];return void 0!==r?r:null}case"type":return"Extent"}break;case"polygon":switch(t){case"rings":o=e.cache._arcadeCacheId,void 0===o&&(ge++,o=ge,e.cache._arcadeCacheId=o);return new K(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polygon"}break;case"point":switch(t){case"x":case"y":case"z":case"m":return void 0!==e[t]?e[t]:null;case"type":return"Point"}break;case"polyline":switch(t){case"paths":o=e.cache._arcadeCacheId,void 0===o&&(ge++,o=ge,e.cache._arcadeCacheId=o);return new K(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);case"type":return"Polyline"}break;case"multipoint":switch(t){case"points":o=e.cache._arcadeCacheId,void 0===o&&(ge++,o=ge,e.cache._arcadeCacheId=o);return new J(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,o,1);case"type":return"Multipoint"}}throw new Error(x(n,"RUNTIME","PROPERTYNOTFOUND"))}function Ee(t,r){return e(((e,n)=>{const o=r.name.toLowerCase();if(null===t.localScope||void 0===t.localScope[o])if(void 0===t.globalScope[o])n(new Error(x(r,"RUNTIME","VARIABLENOTFOUND")));else{const r=t.globalScope[o];!0===r.valueset?e(r.value):null!==r.d?r.d.then(e,n):(r.d=se(t,r.node),r.d.then((t=>{try{r.value=t,r.valueset=!0,e(t)}catch(e){n(e)}}),n))}else{const r=t.localScope[o];!0===r.valueset?e(r.value):null!==r.d?r.d.then(e,n):(r.d=se(t,r.node),r.d.then((t=>{try{r.value=t,r.valueset=!0,e(t)}catch(e){n(e)}}),n))}}))}const we={};function ve(e){return null===e?"":P(e)||L(e)?"Array":W(e)?"Date":k(e)?"String":E(e)?"Boolean":Y(e)?"Number":e instanceof X?"Attachment":e instanceof Q?"Portal":e instanceof _?"Dictionary":e instanceof V?"Feature":e instanceof s?"Point":e instanceof l?"Polygon":e instanceof u?"Polyline":e instanceof c?"Multipoint":e instanceof i?"Extent":G(e)?"Function":B(e)?"FeatureSet":$(e)?"FeatureSetCollection":e===S?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function Ne(t,r,n,o){return e(((e,a)=>{se(t,r.arguments[n]).then((s=>{try{if(w(s,o))return void se(t,r.arguments[n+1]).then(e,a);{const s=r.arguments.length-n;return 1===s?void se(t,r.arguments[n]).then(e,a):(2===s&&e(null),3===s?void se(t,r.arguments[n+2]).then(e,a):void Ne(t,r,n+2,o).then(e,a))}}catch(e){a(e)}}),a)}))}function Ie(t,r,n,o){return e(((e,a)=>{if(!0===o)se(t,r.arguments[n+1]).then(e,a);else{3===r.arguments.length-n?se(t,r.arguments[n+2]).then(e,a):se(t,r.arguments[n+2]).then((o=>{try{if(!1===E(o))return void a(new Error("WHEN needs boolean test conditions"));Ie(t,r,n+2,o).then(e,a)}catch(e){a(e)}}))}}))}function be(r,o){try{const a=r.length,s=Math.floor(a/2);return 0===a?n([]):1===a?n([r[0]]):e(((e,n)=>{const i=[be(r.slice(0,s),o),be(r.slice(s,a),o)];t(i).then((t=>{try{Se(t[0],t[1],o,[]).then(e,n)}catch(e){n(e)}}),n)}))}catch(e){return te(e)}}function Se(t,r,n,o){return e(((e,a)=>{const s=o;t.length>0||r.length>0?t.length>0&&r.length>0?n(t[0],r[0]).then((i=>{try{isNaN(i)&&(i=1),i<=0?(s.push(t[0]),t=t.slice(1)):(s.push(r[0]),r=r.slice(1)),Se(t,r,n,o).then(e,a)}catch(e){a(e)}}),a):t.length>0?(s.push(t[0]),Se(t=t.slice(1),r,n,o).then(e,a)):r.length>0&&(s.push(r[0]),r=r.slice(1),Se(t,r,n,o).then(e,a)):e(o)}))}function Te(e,t){const r=e.length,n=Math.floor(r/2);return t||(t=function(e,t){return e<t?-1:e===t?0:1}),0===r?[]:1===r?[e[0]]:function(e,t,r){const n=[];for(;e.length>0||t.length>0;)if(e.length>0&&t.length>0){let o=r(e[0],t[0]);isNaN(o)&&(o=1),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(t[0]),t=t.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):t.length>0&&(n.push(t[0]),t=t.slice(1));return n}(Te(e.slice(0,n),t),Te(e.slice(n,r),t),t)}function Re(t,n,o){try{const r=t.body;if(o.length!==t.params.length)return te(new Error("Invalid Parameter calls to function."));for(let e=0;e<o.length;e++){const r=t.params[e];"Identifier"===r.type&&(n.localScope[r.name.toLowerCase()]={d:null,value:o[e],valueset:!0,node:null})}return se(n,r).then((t=>e(((e,r)=>{t instanceof I?e(t.value):t!==T?t!==R?e(t instanceof b?t.value:t):r(new Error("Cannot Continue from a Function")):r(new Error("Cannot Break from a Function"))}))))}catch(e){return r(e)}}function je(e,t,r){return ae(e,t,(function(t,n,o){const a={spatialReference:e.spatialReference,services:e.services,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return Re(r,a,o)}))}function Oe(e){return function(){const t={abortSignal:e.context.abortSignal,spatialReference:e.context.spatialReference,console:e.context.console,lrucache:e.context.lrucache,interceptor:e.context.interceptor,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(t.depthCounter>64)throw new Error("Exceeded maximum function depth");return Re(e.definition,t,arguments)}}p(we,oe),f(we,oe),h(we,oe),m(we,oe),d(we,oe),g(we,oe),ee({functions:we,compiled:!1,signatures:null,failDefferred:null,evaluateIdentifier:null,arcadeCustomFunctionHandler:null,mode:"async",standardFunction:oe,standardFunctionAsync:ae}),we.typeof=function(e,t){return oe(e,t,(function(e,t,r){y(r,1,1);const n=ve(r[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n}))},we.iif=function(r,n){return e(((e,o)=>{y(null===n.arguments?[]:n.arguments,3,3),se(r,n.arguments[0]).then((a=>{try{if(!1===E(a))return void o(new Error("IF Function must have a boolean test condition"));t([se(r,n.arguments[1]),se(r,n.arguments[2])]).then((t=>{e(a?t[0]:t[1])}),o)}catch(e){o(e)}}),o)}))},we.decode=function(t,r){return e(((e,n)=>{r.arguments.length<2?n(new Error("Missing Parameters")):2!==r.arguments.length?(r.arguments.length-1)%2!=0?se(t,r.arguments[0]).then((o=>{try{Ne(t,r,1,o).then(e,n)}catch(e){n(e)}}),n):n(new Error("Must have a default value result.")):se(t,r.arguments[1]).then(e,n)}))},we.when=function(t,r){try{return r.arguments.length<3?te("Missing Parameters"):r.arguments.length%2==0?te("Must have a default value result."):se(t,r.arguments[0]).then((n=>e(((e,o)=>{if(!1===E(n))return void o(new Error("WHEN needs boolean test conditions"));Ie(t,r,0,n).then(e,o)}))))}catch(e){return te(e)}},we.sort=function(e,t){return ae(e,t,(function(e,t,r){y(r,1,2);let o=r[0];if(L(o)&&(o=o.toArray()),!1===P(o))return te(Error("Illegal Argument"));if(r.length>1){if(!1===G(r[1]))return te(Error("Illegal Argument"));return be(o,Oe(r[1]))}{let e=o;if(0===e.length)return n([]);const t={};for(let r=0;r<e.length;r++){const n=ve(e[r]);""!==n&&(t[n]=!0)}if(!0===t.Array||!0===t.Dictionary||!0===t.Feature||!0===t.Point||!0===t.Polygon||!0===t.Polyline||!0===t.Multipoint||!0===t.Extent||!0===t.Function)return n(e.slice(0));let r=0,a="";for(const e in t)r++,a=e;return r>1||"String"===a?e=Te(e,(function(e,t){if(null==e||e===S)return null==t||t===S?0:1;if(null==t||t===S)return-1;const r=D(e),n=D(t);return r<n?-1:r===n?0:1})):"Number"===a?e=Te(e,(function(e,t){return e-t})):"Boolean"===a?e=Te(e,(function(e,t){return e===t?0:t?-1:1})):"Date"===a&&(e=Te(e,(function(e,t){return t-e}))),n(e)}}))};const Ue={failDefferred:te,resolveDeffered:re,fixSpatialReference:Z,parseArguments:ne,standardFunction:oe,standardFunctionAsync:ae,evaluateIdentifier:Ee,arcadeCustomFunction:Oe};for(const e in we)we[e]={value:new v(we[e]),valueset:!0,node:null};const Ae=function(){};function Ce(e){console.log(e)}(Ae.prototype=we).infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},Ae.prototype.pi={value:Math.PI,valueset:!0,node:null};const Me=Ue;function xe(e){const t={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:oe,standardFunctionAsync:ae,failDefferred:te,evaluateIdentifier:Ee,arcadeCustomFunctionHandler:Oe};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const e in t.functions)we[e]={value:new v(t.functions[e]),valueset:!0,node:null},Ae.prototype[e]=we[e];for(let e=0;e<t.signatures.length;e++)N(t.signatures[e],"async")}function Fe(t,r){let n=r.spatialReference;null==n&&(n=new o({wkid:102100}));const a=function(e,t){const r=new Ae;null==e&&(e={}),null==t&&(t={});const n=new _({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});n.immutable=!1,r.textformatting={value:n,valueset:!0,node:null};for(const e in t)r[e]={value:new v(t[e]),native:!0,valueset:!0,node:null};for(const t in e)e[t]&&"esri.Graphic"===e[t].declaredClass?r[t]={value:V.createFromGraphic(e[t]),valueset:!0,node:null}:r[t]={value:e[t],valueset:!0,node:null};return r}(r.vars,r.customfunctions);return se({spatialReference:n,services:r.services,abortSignal:void 0===r.abortSignal||null===r.abortSignal?{aborted:!1}:r.abortSignal,globalScope:a,console:r.console?r.console:Ce,lrucache:r.lrucache,interceptor:r.interceptor,localScope:null,depthCounter:1},t.body[0].body).then((t=>e(((e,r)=>{t instanceof I&&(t=t.value),t instanceof b&&(t=t.value),t===S&&(t=null),t!==T?t!==R?t instanceof v||t instanceof j?r(new Error("Cannot return FUNCTION")):e(t):r(new Error("Cannot return CONTINUE")):r(new Error("Cannot return BREAK"))}))))}function De(e,t){return O(e)}function Pe(e,t){return U(e,t,"full")}function ke(e,t){return A(e,t)}function Le(e,t){return C(e,t)}function _e(e){return M(e)}export{Fe as executeScript,xe as extend,De as extractFieldLiterals,_e as findFunctionCalls,Me as functionHelper,Le as referencesFunction,ke as referencesMember,Pe as validateScript};
