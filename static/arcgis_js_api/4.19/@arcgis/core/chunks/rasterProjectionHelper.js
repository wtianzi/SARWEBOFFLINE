/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{g as n}from"../geometry/SpatialReference.js";import t from"../geometry/Point.js";import{project as o}from"../geometry/support/webMercatorUtils.js";import i from"../geometry/Extent.js";import"../geometry.js";import{a}from"./unitUtils.js";import{isLoaded as r,isSupported as s,load as l,project as c,getTransformation as x}from"../geometry/projection.js";const u=function(e,n){const t=(e.isWGS84||e.isWebMercator)&&(n.isWGS84||n.isWebMercator);return!(e.equals(n)||t)};async function m(){if(r()||!s())return null;await l()}function p(n,t,o){if(!u(n.spatialReference,t))return null;if(!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");return o?x(t,n.spatialReference,n):x(n.spatialReference,t,n)}function f(n,t,a,s=null){if(n.spatialReference.equals(t))return n;const l=u(n.spatialReference,t);if(l&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");const x=a.center,m=new i({xmin:x.x-n.x/2,xmax:x.x+n.x/2,ymin:x.y-n.y/2,ymax:x.y+n.y/2,spatialReference:n.spatialReference}),p=l?c(m,t,s):o(m,t);if(null==p)return null;return{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function h(e,n=.01){return a(e)?n/a(e):0}function y(t,i,a=null,s=!0){const l=t.spatialReference;if(l.equals(i))return t;const x=u(l,i);if(x&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");const m=x?c(t,i,a):o(t,i);if(m&&s&&i.isGeographic){var p,f;const[e,o]=l.isWebMercator?n(l).origin:null!=(p=null==(f=n(l))?void 0:f.valid)?p:[],i=h(l);i&&null!=e&&null!=o&&(Math.abs(t.x-e)<i&&Math.abs(180-m.x)<5e-4?m.x-=360:Math.abs(t.x-o)<i&&Math.abs(180+m.x)<5e-4&&(m.x+=360))}return m}function M(i,a,s=null,l=!0){var x,m,p,f;const M=i.spatialReference;if(M.equals(a))return i;const w=u(M,a);if(w&&!r())throw new e("rasterprojectionhelper-projectExtent","projection engine is not loaded");const d=w?c(i,a,s):o(i,a);let[g,R]=null!=(x=null==(m=n(M))?void 0:m.origin)?x:[];if(d&&l&&M.isWebMercator&&a.isGeographic&&null!=g&&null!=R){const e=.001,n=1e3;if(Math.abs(i.xmin-g)<e&&Math.abs(R-i.xmax)>n&&Math.abs(180-d.xmax)<5e-4){d.xmin=-180;const e=[];e.push(new t(i.xmax,i.ymin,M)),e.push(new t(i.xmax,(i.ymin+i.ymax)/2,M)),e.push(new t(i.xmax,i.ymax,M));const n=e.map((e=>y(e,a,s))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));d.xmax=Math.max.apply(null,n)}if(Math.abs(i.xmax-R)<e&&Math.abs(g-i.xmin)>n&&Math.abs(180+d.xmin)<5e-4){d.xmax=180;const e=[];e.push(new t(i.xmin,i.ymin,M)),e.push(new t(i.xmin,(i.ymin+i.ymax)/2,M)),e.push(new t(i.xmin,i.ymax,M));const n=e.map((e=>y(e,a,s))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));d.xmin=Math.min.apply(null,n)}}[g,R]=a.isWebMercator?n(a).origin:null!=(p=null==(f=n(a))?void 0:f.valid)?p:[];const j=h(a);return j&&null!=g&&null!=R&&(Math.abs(d.xmin-g)<j&&(d.xmin=g),Math.abs(d.xmax-R)<j&&(d.xmax=R)),d}function w(o,i,a,s=null,l=null,c=!1,x=[32,32]){var m,p;if(u(o.spatialReference,i.spatialReference)&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(o&&i&&a))return null;const{xmin:f,ymin:h,xmax:M,ymax:w}=o,d=o.spatialReference,g=i.spatialReference,[R,j]=null!=(m=null==(p=n(d))?void 0:p.valid)?m:[],b={x:x[0]*a.x,y:x[1]*a.y},v={cols:Math.ceil((M-f)/b.x-.1)+1,rows:Math.ceil((w-h)/b.y-.1)+1},N=b.x,S=b.y,z=[];let W,G=!1;for(let e=0;e<v.cols;e++){const n=[];for(let o=0;o<v.rows;o++){let a=y(new t({x:f+N*e,y:w-S*o,spatialReference:d}),g,s);l&&(a=l.inverseTransform(a)),n.push(a),e>0&&c&&a&&W[o]&&null!=R&&a.x<W[o].x&&(a.x+=j-R),a?(z.push((a.x-i.xmin)/(i.xmax-i.xmin)),z.push((i.ymax-a.y)/(i.ymax-i.ymin))):(z.push(NaN),z.push(NaN),G=!0)}W=n}const P=function(e,n){const t=(e[0]+e[4]+e[4*n.cols]+e[4*n.cols+4])/4,o=(e[1]+e[5]+e[4*n.rows+1]+e[4*n.rows+5])/4;return[Math.abs(t-e[2*n.rows+2]),Math.abs(o-e[2*n.rows+3])]}(z,v),L=new Float32Array((v.cols-1)*(v.rows-1)*2*6),q=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),A=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let e=0;e<v.cols-1;e++){for(let n=0;n<v.rows-1;n++){let t=e*v.rows*2+2*n;const o=z[t],i=z[t+1],a=z[t+2],r=z[t+3];t+=2*v.rows;const s=z[t],l=z[t+1],c=z[t+2],x=z[t+3];let u=0,m=12*(n*(v.cols-1)+e);for(let e=0;e<3;e++)L[m++]=q[u++]*o+q[u++]*a+q[u++]*c;u=0;for(let e=0;e<3;e++)L[m++]=q[u++]*i+q[u++]*r+q[u++]*x;u=0;for(let e=0;e<3;e++)L[m++]=A[u++]*o+A[u++]*s+A[u++]*c;u=0;for(let e=0;e<3;e++)L[m++]=A[u++]*i+A[u++]*l+A[u++]*x}if(G)for(let e=0;e<L.length;e++)isNaN(L[e])&&(L[e]=-1)}return{offsets:z,error:P,coefficients:L,spacing:x,size:[v.cols-1,v.rows-1]}}function d(e,n,o){const i=Math.log(e.x/n.pixelSize.x)/Math.LN2,a=Math.log(e.y/n.pixelSize.y)/Math.LN2,r=n.storageInfo.maximumPyramidLevel||0;let s="down"===o?Math.floor(Math.min(i,a)):"up"===o?Math.ceil(Math.max(i,a)):Math.round((i+a)/2),l=!1;s<0?s=0:s>r&&(l=s>r+3,s=r);const c=2**s;return{pyramidLevel:s,pyramidResolution:new t({x:c*n.nativePixelSize.x,y:c*n.nativePixelSize.y,spatialReference:n.spatialReference}),excessiveReading:l}}function g(e,n,o=512,i=!0){const{extent:r,spatialReference:s,pixelSize:l}=e,c=f(new t({x:l.x,y:l.y,spatialReference:s}),n,r);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const x=(c.x+c.y)/2,u=a(n),m=x*u*96*39.37,p=n.isGeographic?512/o*295828763.7958547:512/o*591657527.591555;let h=!1;const y=M(r,n);i&&(n.isGeographic||n.isWebMercator)&&(h=y.xmin*y.xmax<0);let w,d=m;const g=1.001;if(h){d=p;const e=.29858214164761665,n=e*(96*u*39.37);w=f(new t({x:e,y:e,spatialReference:{wkid:3857}}),s,y),w.x*=d/n,w.y*=d/n}else{w={x:l.x,y:l.y};const n=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let t=0;for(;d<.5005*p&&t<n;)t++,d*=2,w.x*=2,w.y*=2;Math.max(d,p)/Math.min(d,p)<=g&&(d=p)}const R=[d],j=[{x:w.x,y:w.y}],b=Math.min(70.5310735,m)/g;for(;d>=b;)d/=2,w.x/=2,w.y/=2,R.push(d),j.push({x:w.x,y:w.y});return{projectedPixelSize:c,scales:R,srcResolutions:j,isCustomTilingScheme:!h}}export{f as a,M as b,g as c,p as d,w as g,m as l,y as p,d as s};
