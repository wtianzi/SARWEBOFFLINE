/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../core/lang.js";import{b as e,i as t}from"./Logger.js";import{whenOrAbort as a,eachAlways as i}from"../core/promiseUtils.js";import{hasField as r}from"../layers/support/fieldUtils.js";import{p as n}from"./screenUtils.js";import s from"../Graphic.js";import{a as l}from"./sizeVariableUtils.js";import{m as o}from"./lengthUtils.js";import{getVisualVariableValues as c}from"./visualVariableUtils.js";import{t as u}from"./symbolConversion.js";import{d as p}from"./diffUtils.js";import{getDisplayedSymbol as y}from"../symbols/support/symbolUtils.js";import{h as d}from"./hitTestSelectUtils.js";import{c as f,a as m}from"./drapedUtils.js";function g(e){const t=e.layer,a=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&c(t.renderer,e),i=a?a.map((e=>e.variable)):[],r=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=r[0],s=1===r.length&&n.field&&!n.valueExpression,o=i.filter((e=>"size"===e.type)),u=o[0],p=1===o.length&&"real-world-size"===l(u)&&u.field&&!u.useSymbolValue&&!u.valueExpression;return{rotation:s?b(n,t):null,size:p?h(u,t):null}}function b(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,r=t.fields&&t.fields.filter((e=>e.name===i)),n=r&&1===r.length?r[0].type:"double",s={initial:0,current:0};return{field:i,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-a*e,v((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1}}function h(t,a){const i=t.field,r=t.axis,n=a.fields&&a.fields.filter((e=>e.name===i)),s=n&&1===n.length?n[0].type:"double",l={updating:!1,initial:0,current:0},c=o[t.valueUnit];let p;return p="area"===t.valueRepresentation?e=>(e*c/2)**2*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?e=>e*c/2:e=>e*c,{field:i,getDefault:async(t,a)=>v(p(await async function(t,a,i){if(e(a))return 0;const{symbol:r}=u(a);if(e(r)||"web-style"===r.type)return 0;const n=r.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return n.size||Math.min(z.icon,(await e(n,z.icon))[0])||z.icon}case"text":return n.size||z.text;case"line":return n.size||z.line;case"object":{const{computeObjectLayerResourceSize:e}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await e(n,t.scale/z.viewScaleSizeFactor),i)}case"path":case"extrude":return n.size||t.scale/z.viewScaleSizeFactor;case"fill":case"water":default:return 0}}(a,t,r)),s),getValue:(e,t)=>(l.initial||(l.initial=t.pixelSizeAt(t.center)),l.current=l.initial*e,v(l.current,s)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1}}function v(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function w(e){const a=await y(e,{ignoreGraphicSymbol:!0}),i=p(e.symbol,a);t(i)&&(e.symbol=a)}async function j(t,a,i,r){const n=a.layer;await async function(t,a,i){var r;if("3d"!==i.type)return;const n=a.layer,l={...a.template.prototype.attributes},o=new s({layer:n,sourceLayer:n,attributes:l}),{rotation:c,size:u}=g(o);let p=await y(o),d=!1;for(const t of[u,c]){if(e(t))continue;null==l[t.field]&&(l[t.field]=await t.getDefault(p,i),d=!0)}d&&(p=await y(o));switch(null==(r=p)?void 0:r.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=p;break;case"simple-line":case"line-3d":t.polylineSymbol=p;break;case"simple-marker":case"point-3d":t.pointSymbol=p}}(t,a,i),t.layer.elevationInfo=n.elevationInfo;const l=()=>t.create(n.geometryType,{hasZ:n.capabilities.data.supportsZ});await l();const o=t.on("create",(async e=>{const{state:i,graphic:s}=e;if("cancel"!==i){if("complete"===i){const e=s.clone();e.attributes={...a.template.prototype.attributes},e.layer=n,t.layer.remove(s),await w(e),r(e)}}else l()}));return i.map.add(t.layer),{remove:()=>{o.remove(),i.map.remove(t.layer),t.cancel()}}}function I(e,t){return e&&e.find((e=>e.layer===t))}async function S(e,t,n,s){if(0===e.length)return[];const{updatable:l,graphicsByLayer:o}=await n.async((async()=>{const{results:i}=await a(d(t,n),s),r=new Map;i.forEach((({graphic:e})=>(({layer:e})=>{const t=r.get(e);if(!t){const t=new Array;return r.set(e,t),t}return t})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&r.has(t)));return 0!==l.length&&n.stopPropagation(),{updatable:l,graphicsByLayer:r}}));return a(i(l.map((async({layer:e})=>{const{objectIdField:t,displayField:a}=e,i=[t];r(e.fields,a)&&i.push(a);const n=o.get(e);if(!!n.some((e=>i.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=i,t.returnGeometry=!1,t.objectIds=n.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:s}).then((({features:e})=>e))}return n}))),s)}async function U(e,t,n,s){switch(t.type){case"3d":return S(e,t,n,s);case"2d":return async function(e,t,n,s){if(0===e.length)return[];const l=await n.async((async()=>{const{results:i}=await a(t.hitTest(n),s);if(0===i.length)return[];const r=new Set;i.forEach((({graphic:e})=>r.add(e.layer)));const l=e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&r.has(e)));return l.length>0&&n.stopPropagation(),l}));return a(i(l.map((({layer:e})=>{const{objectIdField:a,displayField:i}=e,l=[a];r(e.fields,i)&&l.push(i);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c=f({renderer:e.renderer,event:n});return o.geometry=m(n.mapPoint,c,t),o.outSpatialReference=t.spatialReference,e.queryFeatures(o,{signal:s}).then((({features:e})=>e))}))),s)}(e,t,n,s)}}async function V(e,t,a){const i=e.layer,r=i.createQuery();return r.objectIds=[e.getAttribute(i.objectIdField)],r.outFields=["*"],r.outSpatialReference=t.spatialReference,r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(r,{signal:a})).features[0]}async function x(a,i,r,n,s){const l=a.clone();await w(l),r.layer.add(l),l.sourceLayer=a.layer;const o=(()=>{const{layer:e}=a;if("graphics"===e.type)return{remove(){}};const{objectIdField:t}=e,i=a.attributes[t],r=n.whenLayerView(e);return r.then((e=>e.setVisibility(i,!1)),(()=>{})),{remove(){r.then((e=>e.setVisibility(i,!0)),(()=>{}))}}})(),c=a.layer,u=i.size,p=i.rotation,y={multipleSelectionEnabled:!1};"point"===c.geometryType&&(y.enableRotation=!!p,y.enableScaling=!!u),r.layer.elevationInfo=c.elevationInfo,r.update(l,y);const d=(t(u)||t(p))&&a.watch("attributes",(async e=>{let a=!1;for(const i in e){const r=e[i];r!==l.attributes[i]&&(l.setAttribute(i,r),a=!0,t(u)&&!u.isUpdatingInteractively&&u.field===i&&u.initValue(r),t(p)&&!p.isUpdatingInteractively&&p.field===i&&p.initValue(r))}a&&"3d"===n.type&&await w(l)}));[p,u].forEach((async t=>{if(e(t))return;const i=a.attributes[t.field];if(null!=i)t.initValue(i);else{const e=await t.getDefault(l.symbol,n);t.initValue(e),l.setAttribute(t.field,e),"3d"===n.type&&await w(l)}}));const f=r.on("update",(async e=>{const{graphics:[a],state:i,toolEventInfo:o}=e;if("complete"===i)return void r.update(a,y);const c=o;if(t(p)&&c){const{field:e,getValue:t,initValue:a}=p;"rotate-stop"===c.type?(p.isUpdatingInteractively=!1,a()):null!=c.angle&&(p.isUpdatingInteractively=!0,l.attributes[e]=t(c.angle,n))}const d=o;if(t(u)&&d){const{field:e,getValue:t,initValue:a}=u;"scale-stop"===d.type?(u.isUpdatingInteractively=!1,a()):null!=d.xScale&&(u.isUpdatingInteractively=!0,l.attributes[e]=t(d.xScale,n))}"3d"===n.type&&await w(l),s(a.clone())})),m=r.on(["undo","redo"],(async e=>{const{graphics:[t]}=e;s(t.clone())}));n.map.add(r.layer);const g=()=>{};return{interactive:{remove(){m.remove(),f.remove(),r.cancel(),d&&d.remove(),this.remove=g}},visual:{remove(){o.remove(),n.map.remove(r.layer),r.layer.removeAll(),this.remove=g}}}}const z={icon:n(24),text:n(12),line:n(1),viewScaleSizeFactor:100};export{x as a,U as b,V as c,I as f,g,j as s};
