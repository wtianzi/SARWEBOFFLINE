/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{h as e,k as t,l as r}from"../core/lang.js";import{i as a,b as n}from"./Logger.js";import{f as o,s,g as i}from"../core/scheduling.js";import{eachAlways as c}from"../core/promiseUtils.js";import l from"../core/Error.js";import u from"../geometry/SpatialReference.js";import f from"../request.js";import{canProject as h}from"../geometry/support/webMercatorUtils.js";import{c as p}from"./vec3f64.js";import{a as m,g as d,A as g,x as y,b,e as w,i as M}from"./vec3.js";import{e as x,f as S}from"./unitUtils.js";import{a as v}from"./mat4.js";import{c as j,e as q,g as R,i as T}from"./aaBoundingRect.js";import{computeLinearTransformation as k,projectBoundingSphere as I,projectBuffer as z,projectVectorToVector as A}from"../geometry/projection.js";import{c as F}from"./vec4f64.js";import{c as C}from"./quatf64.js";import{a as G,m as L,c as B}from"./quat.js";import K from"../tasks/support/Query.js";import{c as O}from"./aaBoundingBox.js";import{h as W,i as E,j as P,g as U,k as D,l as N}from"../views/SceneView.js";import{T as _}from"./Texture.js";import{b as V}from"./quatf32.js";import{r as $}from"./I3SBinaryReader.js";function Q(e,t,r,a){const n=Z(e,t,r),o=C();return k(r,n,o,a),o}function Z(e,t,r){const a=p(),n=e[3],o=2**(4*Math.ceil(Math.log(n)*Math.LOG2E/4)+1);if(r.isGeographic){const t=o/x(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),c=Math.round(e[0]/i)*i;a[0]=c,a[1]=s}else{const t=Math.round(e[0]/o),r=Math.round(e[1]/o);a[0]=t*o,a[1]=r*o}const s=e[2]+t,i=Math.round(s/o);return a[2]=i*o,a}function H(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function J(t){const r=t._stage.renderView.has(1),a=t._stage.renderView.has(0),n=e("disable-feature:i3s-basis")?0:1;return 12|(r?2|n:0)|(a?n:0)}function X(e,t){return e.find((e=>0!=(e.encoding&t)))}function Y(e){switch(e){case 1:return _.BASIS_ENCODING;case 2:return _.DDS_ENCODING;case 4:return"image/png";case 8:return"image/jpeg";case 16:return"image/ktx";default:return""}}function ee(t){if(e("disable-feature:i3s-draco")||!t)return!1;for(const e of t)for(const t of e.geometryBuffers)if("draco"===t.compressedAttributes.encoding)return!0;return!1}function te(e,t,r,a,n,o){n.traverse(r,(r=>{let n=r.mbs;t!==a&&(n=se,I(r.mbs,a,n,t));const s=function(e,t){const r=t[0],a=t[1],n=t[3],o=e[0]-r,s=r-e[2],i=e[1]-a,c=a-e[3],l=Math.max(o,s,0),u=Math.max(i,c,0),f=l*l+u*u;if(f>n*n)return 0;if(f>0)return 1;if(-Math.max(o,s,i,c)>n)return 3;return 2}(e,n);return 0!==s&&(o(r,s),!0)}))}function re(e,t,r){let a=0,n=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(r(o)&&(e[n]=e[a],n++),a++);e.length=n}function ae(e,t,r){let a=0,n=0;for(;a<r.length;){i(e,r[a])>=0===t&&(r[n]=r[a],n++),a++}r.length=n}const ne=O();function oe(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return ne[0]=(e[0]-t.position[0])/t.rotationScale[0],ne[1]=(e[1]-t.position[1])/t.rotationScale[4],ne[2]=(e[2]-t.position[2])/t.rotationScale[8],ne[3]=(e[3]-t.position[0])/t.rotationScale[0],ne[4]=(e[4]-t.position[1])/t.rotationScale[4],ne[5]=(e[5]-t.position[2])/t.rotationScale[8],ne}const se=F();function ie(e,t){const r=t[0],a=t[1],n=t[2],o=t[3],s=e[0]-r,i=r-e[3],c=e[1]-a,l=a-e[4],u=e[2]-n,f=n-e[5],h=Math.max(s,i,0),p=Math.max(c,l,0),m=Math.max(u,f,0),d=h*h+p*p+m*m;if(d>o*o)return 0;if(d>0)return 1;return-Math.max(s,i,c,l,u,f)>o?3:2}function ce(e,t,r){const a=[],n=r&&r.missingFields,o=r&&r.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const n of t)if(e===n.name.toLowerCase()){a.push(n.name),s=!0,o&&o.push(r);break}!s&&n&&n.push(r)}return a}async function le(e,t,r,s,i){if(0===t.length)return[];const u=e.attributeStorageInfo;if(a(e.associatedLayer))try{return await async function(e,t,r,a){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const n=t.map((e=>e.attributes[r])),o=[],s=ce(a,e.fields,{originalFields:o}),i=await ue(e,n,s);for(let e=0;e<t.length;e++){const r=t[e],a=i[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<o.length;e++)n[o[e]]=a[s[e]];r.attributes=n}return t}(e.associatedLayer,t,r,s)}catch(t){if(e.associatedLayer.loaded)throw t}if(u){const a=function(e,t,r){const a=new Map,n=[],o=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<o.length;t++){const s=o[t],i=s.featureIds.indexOf(e);if(i>=0){let e=a.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},n.push(e),a.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)o[e]=o[e-1];o[0]=s;break}}}return n}(t,r,i);if(n(a))throw new l("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const h=e.parsedUrl.path,p=await Promise.all(a.map((e=>function(e,t,r,a,n){const o=[];for(const a of t)if(a&&-1!==n.indexOf(a.name)){const t=`${e}/nodes/${r.resources.attributes}/attributes/${a.key}/0`;o.push({url:t,storageInfo:a})}return c(o.map((e=>f(e.url,{responseType:"array-buffer"}).then((t=>$(e.storageInfo,t.data)))))).then((e=>{const t=[];for(const r of a){const a={};for(let t=0;t<e.length;t++)null!=e[t].value&&(a[o[t].storageInfo.name]=fe(e[t].value,r));t.push(a)}return t}))}(h,u,e.node,e.indices,s).then((t=>{for(let r=0;r<e.graphics.length;r++){const a=e.graphics[r],n=t[r];if(a.attributes)for(const e in a.attributes)e in n||(n[e]=a.attributes[e]);a.attributes=n}return e.graphics})))));return o(p)}throw new l("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function ue(e,t,r){const a=e.capabilities.query.maxRecordCount;if(null!=a&&t.length>a){const n=s(t,a);return Promise.all(n.map((t=>ue(e,t,r)))).then(o)}const n=new K({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(n).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new l("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function fe(e,a){if(!e)return null;const n=e[a];if(t(e))return-32768===n?null:n;if(r(e))return-2147483648===n?null:n;return n!=n?null:n}function he(e){const t=e.store.indexCRS||e.store.geographicCRS,r=void 0===t?e.store.indexWKT:void 0;if(r){if(!e.spatialReference)throw new l("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new l("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new u(H(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function pe(e){const t=e.store.vertexCRS||e.store.projectedCRS,r=void 0===t?e.store.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new l("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new l("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new u(H(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function me(e,t){return n(t)?"@null":t===S(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function de(e,t,r){if(!h(e,t))throw new l("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new l("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function ge(e,t,r){const a=he(e),n=pe(e);de(a,t,r),de(n,t,r)}function ye(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new l("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function be(e,t){ge(e,t.spatialReference,t.viewingMode)}function we(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new l("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function Me(e,t){de(e.spatialReference,t.spatialReference,t.viewingMode)}function xe(e){return"mesh-3d"===e.type}function Se(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!xe(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||n(t.material)||n(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}const ve=E({color:[0,0,0,0],opacity:0});class je{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function qe(e){const t=new je;let r=!1,n=!1;for(const o of e.symbolLayers.items)if("fill"===o.type&&o.enabled){const e=o.material,s=o.edges;if(a(e)&&!r){const n=e.color,s=P(e.colorMixMode);a(n)?t.material={color:[n.r/255,n.g/255,n.b/255],alpha:n.a,colorMixMode:s}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=o.castShadows,r=!0}a(s)&&!n&&(t.edgeMaterial=U(s,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function Re(e,t){return(0|e)+(0|t)|0}function Te(e,t,r,a,n=0){a===S(a)?t.isGeographic?function(e,t,r,a){const n=x(r),o=1+Math.max(0,a)/(n.radius+e.center[2]);m(t.center,e.center[0],e.center[1],e.center[2]+a),z(t.center,r,0,t.center,S(r),0,1),G(t.quaternion,e.quaternion),B(ze,e.quaternion),m(Le,0,0,1),y(Le,Le,ze),m(Le,e.halfSize[0]*Math.abs(Le[0]),e.halfSize[1]*Math.abs(Le[1]),e.halfSize[2]*Math.abs(Le[2])),b(Le,Le,n.inverseFlattening),w(t.halfSize,e.halfSize,Le),b(t.halfSize,t.halfSize,o)}(e,r,t,n):function(e,t,r,a){D(e,Ae),m(t.center,e.center[0],e.center[1],e.center[2]+a),k(r,t.center,Ie,S(r)),m(t.center,Ie[12],Ie[13],Ie[14]);const n=2*Math.sqrt(1+Ie[0]+Ie[5]+Ie[10]);ze[0]=(Ie[6]-Ie[9])/n,ze[1]=(Ie[8]-Ie[2])/n,ze[2]=(Ie[1]-Ie[4])/n,ze[3]=.25*n,L(t.quaternion,ze,e.quaternion),B(ze,t.quaternion);let o=0,s=0,i=0;for(const e of Ae)e[2]+=a,z(e,r,0,e,S(r),0,1),g(Le,e,t.center),y(Le,Le,ze),o=Math.max(o,Math.abs(Le[0])),s=Math.max(s,Math.abs(Le[1])),i=Math.max(i,Math.abs(Le[2]));m(t.halfSize,o,s,i)}(e,r,t,n):e===r?(r.center[2]+=n,z(r.center,t,0,r.center,a,0,1)):(m(r.center,e.center[0],e.center[1],e.center[2]+n),z(r.center,t,0,r.center,a,0,1),G(r.quaternion,e.quaternion),d(r.halfSize,e.halfSize))}function ke(e,t,r,o,s,i){if(!i||0===i.length||n(t))return null;const c=Q(e.mbs,s,r,t);let l;v(Ke,c);let u=1/0,f=-1/0;const h=n=>{if("replace"!==n.type)return;const i=n.geometry;if(!i.hasZ)return;q(Fe);const c=i.spatialReference||o,h=i.rings.reduce(((e,r)=>r.reduce(((e,r)=>(A(r,c,Le,t),M(Le,Le,Ke),R(Fe,Le),Math.min(Le[2],e))),e)),1/0);(()=>{if(!l)if(l=Ae,q(Ce),a(e.serviceObb)){Te(e.serviceObb,r,Ge,t,s),D(Ge,l);for(const e of l)M(e,e,Ke),R(Ce,e)}else{const a=e.mbs,n=a[3];A(a,r,Le,t),M(Le,Le,Ke),Le[2]+=s;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,a=4&e?n:-n,o=l[e];d(o,[Le[0]+t,Le[1]+r,Le[2]+a]),R(Ce,o)}}})(),T(Ce,Fe)&&(u=Math.min(u,h),f=Math.max(f,h))};if(i.forEach((e=>h(e))),u===1/0)return null;for(let e=0;e<8;++e)p=Be.data,m=3*e,g=l[e],M(Le,g,c),p[m+0]=Le[0],p[m+1]=Le[1],p[m+2]=Le[2],m+=24,g[2]=u,M(Le,g,c),p[m+0]=Le[0],p[m+1]=Le[1],p[m+2]=Le[2],m+=24,g[2]=f,M(Le,g,c),p[m+0]=Le[0],p[m+1]=Le[1],p[m+2]=Le[2];var p,m,g;return N(Be)}const Ie=C(),ze=V(),Ae=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Fe=j(),Ce=j(),Ge=W(),Le=[0,0,0],Be={data:new Array(72),size:3},Ke=C();export{Me as A,ge as B,ee as C,J as a,ye as b,de as c,be as d,me as e,ce as f,he as g,Q as h,ke as i,Z as j,re as k,ie as l,Re as m,qe as n,fe as o,oe as p,Y as q,Se as r,X as s,ve as t,ae as u,Te as v,le as w,pe as x,te as y,we as z};
