/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{h as e}from"../core/lang.js";import t from"../core/Error.js";import{normalize as r,removeFile as o,urlToObject as s}from"../core/urlUtils.js";import{f as n}from"./persistableUrlUtils.js";import l from"../request.js";import a from"../portal/PortalQueryParams.js";import m from"../portal/Portal.js";import{S as i}from"../symbols/Symbol3D.js";import{T as y}from"./Thumbnail.js";import{isSymbol3D as u}from"../symbols.js";import{fromJSON as f}from"../symbols/support/jsonUtils.js";import{i as c,a as p}from"./devEnvironmentUtils.js";function b(t){return!!e(`enable-feature:${t}`)}const d=()=>b("disable-context-navigation"),h={};function j(e,r,o){const s=r.portal||m.getDefault();let n;const l=`${s.url} - ${s.user&&s.user.username} - ${e}`;return h[l]||(h[l]=function(e,r,o){return r.load(o).then((()=>{const t=new a({disableExtraQuery:!0,query:`owner:${$} AND type:${D} AND typekeywords:"${e}"`});return r.queryItems(t,o)})).then((({results:r})=>{let s=null;const n=e.toLowerCase();if(r&&Array.isArray(r))for(const e of r){if(e.typeKeywords.some((e=>e.toLowerCase()===n))&&e.type===D&&e.owner===$){s=e;break}}if(!s)throw new t("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return s.load(o)}))}(e,s,o).then((e=>(n=e,e.fetchData()))).then((t=>({data:t,baseUrl:n.itemUrl,styleName:e})))),h[l]}function w(e,r,s){return e.styleUrl?function(e,t){return U(e,t).then((t=>({data:t.data,baseUrl:o(e),styleUrl:e})))}(e.styleUrl,s):e.styleName?j(e.styleName,r,s):Promise.reject(new t("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function g(e,r,n,l){return e.name?e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?function(e,t,r){const n=E.replace(/\{SymbolName\}/gi,e.name);return U(n,r).then((e=>{const r=S(e.data);return f(r,{portal:t.portal,url:s(o(n)),origin:"portal-item"})}))}(e,r,l):w(e,r,l).then((t=>N(t,e.name,r,n,l))):Promise.reject(new t("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function N(e,r,l,a,m){const d=e.data,h={portal:l.portal,url:s(e.baseUrl),origin:"portal-item"},j=d.items.find((e=>e.name===r));if(!j){const e=`The symbol name '${r}' could not be found`;return Promise.reject(new t("symbolstyleutils:symbol-name-not-found",e,{symbolName:r}))}let w=n(function(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!b("force-wosr"))for(const t of e.formatInfos)if("gltf"===t.type)return t.href;return e.webRef}(j,a),h),g=j.thumbnail&&j.thumbnail.href;const N=j.thumbnail&&j.thumbnail.imageData;c()&&(w=p(w),g=p(g));const $={portal:l.portal,url:s(o(w)),origin:"portal-item"};return U(w,m).then((t=>{const o="cimRef"===a?S(t.data):t.data,s=f(o,$);if(s&&u(s)){if(g){const e=n(g,h);s.thumbnail=new y({url:e})}else N&&(s.thumbnail=new y({url:`data:image/png;base64,${N}`}));e.styleUrl?s.styleOrigin=new i({portal:l.portal,styleUrl:e.styleUrl,name:r}):e.styleName&&(s.styleOrigin=new i({portal:l.portal,styleName:e.styleName,name:r}))}return s}))}function S(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function U(e,t){const o={responseType:"json",query:{f:"json"},...t};return l(r(e),o)}const $="esri_en",D="Style",E="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var P=Object.freeze({__proto__:null,fetchStyle:w,resolveWebStyleSymbol:g,fetchSymbolFromStyle:N,styleNameFromItem:function(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t}});export{d,w as f,g as r,P as s};
