/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{L as e,i as t,u as r,g as s,b as o}from"./Logger.js";import{throwIfAbortError as a}from"../core/promiseUtils.js";import n from"../core/Error.js";import{r as i}from"./asyncUtils.js";import u from"../request.js";import{b as l,c}from"./vec3f64.js";import{i as m,s as d,D as p,l as f,n as x,f as g}from"./vec3.js";import{a as h}from"./devEnvironmentUtils.js";import{V as b}from"./Version.js";import{a as v}from"./mat4.js";import{c as y,a as w}from"./quatf64.js";import{n as R}from"./mat3.js";import{a as M,f as B,d as A,h as E,l as T,m as C,n as j}from"./BufferView.js";import{t as I,a as O,s as S}from"./vec32.js";import{b as P,p as U}from"./aaBoundingBox.js";import{r as F}from"./requestImageUtils.js";import{G as L}from"./glUtil3D.js";import{D,l as N,b as k,n as q,o as V,p as _,q as z,s as $,r as G,u as W,k as K,v as Q,w as H,x as J}from"./vec42.js";import{T as X}from"./Texture.js";const Y=e.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Z(e,s){const o=await async function(e,s){const o=t(s)&&s.streamDataRequester;if(o)return async function(e,t,r){const s=await i(t.request(e,"json",r));if(!0===s.ok)return s.value;return a(s.error),void ee(s.error.details.url)}(e,o,s);const n=await i(u(e,r(s)));if(!0===n.ok)return n.value.data;return a(n.error),void ee(n.error)}(e,s);return{resource:o,textures:await async function(e,r){const s=[];for(const o in e){const a=e[o],n=a.images[0].data;if(!n){Y.warn("Externally referenced texture data is not yet supported");continue}const i=a.encoding+";base64,"+n,u="/textureDefinitions/"+o,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},c=t(r)&&r.disableTextures?Promise.resolve(null):F(i,r);s.push(c.then((e=>({refId:u,image:e,params:l,alphaChannelUsage:"rgba"===a.channels?a.alphaChannelUsage||"transparency":"none"}))))}const o=await Promise.all(s),a={};for(const e of o)a[e.refId]=e;return a}(o.textureDefinitions,s)}}function ee(e){throw new n("",`Request for object resource failed: ${e}`)}function te(e){const t=e.params,r=t.topology;let s=!0;switch(t.vertexAttributes||(Y.warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(Y.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),s=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(Y.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),s=!1)):(Y.warn(`Indexed geometry does not specify face indices for '${r}' attribute`),s=!1)}}else Y.warn("Indexed geometries must specify faces"),s=!1;break}default:Y.warn(`Unsupported topology '${r}'`),s=!1}e.params.material||(Y.warn("Geometry requires material"),s=!1);const o=e.params.vertexAttributes;for(const e in o){o[e].values||(Y.warn("Geometries with externally defined attributes are not yet supported"),s=!1)}return s}function re(e){const r=P();return e.forEach((e=>{const s=e.boundingInfo;t(s)&&(U(r,s.getBBMin()),U(r,s.getBBMax()))})),r}function se(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;case"transparency":default:return 0}}function oe(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const ae=new b(1,2,"wosr");async function ne(e,r){const a=ie(h(e));if("wosr"===a.fileType){const e=await(r.cache?r.cache.loadWOSR(a.url,r):Z(a.url,r)),s=function(e,r){const s=[],o=[],a=[],n=[],i=e.resource,u=b.parse(i.version||"1.0","wosr");ae.validate(u);const c=i.model.name,m=i.model.geometries,d=i.materialDefinitions,p=e.textures;let f=0;const x=new Map;for(let e=0;e<m.length;e++){const i=m[e];if(!te(i))continue;const u=oe(i),c=i.params.vertexAttributes,g=[];for(const e in c){const t=c[e],r=t.values;g.push([e,{data:r,size:t.valuesPerElement,exclusive:!0}])}const h=[];if("PerAttributeArray"!==i.params.topology){const e=i.params.faces;for(const t in e)h.push([t,new Uint32Array(e[t].values)])}const b=p&&p[u.texture];if(b&&!x.has(u.texture)){const{image:e,params:t}=b,r=new X(e,t);n.push(r),x.set(u.texture,r)}const v=x.get(u.texture),y=v?v.id:void 0;let w=a[u.material]?a[u.material][u.texture]:null;if(!w){const e=d[u.material.substring(u.material.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const s=b&&b.alphaChannelUsage,o=e.transparency>0||"transparency"===s||"maskAndTransparency"===s,n={ambient:l(e.diffuse),diffuse:l(e.diffuse),opacity:1-(e.transparency||0),transparent:o,textureAlphaMode:b?se(b.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:y,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};t(r)&&r.materialParamsMixin&&Object.assign(n,r.materialParamsMixin),w=new D(n),a[u.material]||(a[u.material]={}),a[u.material][u.texture]=w}o.push(w);const R=new L(g,h);f+=h.position?h.position.length:0,s.push(R)}return{name:c,stageResources:{textures:n,materials:o,geometries:s},pivotOffset:i.model.pivotOffset,boundingBox:re(s),numberOfVertices:f,lodThreshold:null}}(e,r);return{lods:[s],referenceBoundingBox:s.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const n=await(r.cache?r.cache.loadGLTF(a.url,r,r.usePBR):N(new k(r.streamDataRequester),a.url,r,r.usePBR)),i=s(n.model.meta,"ESRI_proxyEllipsoid");n.meta.isEsriSymbolResource&&t(i)&&-1!==n.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(let r=0;r<e.model.lods.length;++r){const s=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(const a of s.parts){const s=a.attributes.normal;if(o(s))return;const n=a.attributes.position,i=n.count,u=c(),l=c(),h=c(),b=V(E,i),w=V(M,i),R=v(y(),a.transform);for(let o=0;o<i;o++){n.getVec(o,l),s.getVec(o,u),m(l,l,a.transform),d(h,l,t.center),p(h,h,t.radius);const i=h[2],c=f(h),v=Math.min(.45+.55*c*c,1);p(h,h,t.radius),m(h,h,R),x(h,h),r+1!==e.model.lods.length&&e.model.lods.length>1&&g(h,h,u,i>-1?.2:Math.min(-4*i-3.8,1)),w.setVec(o,h),b.set(o,0,255*v),b.set(o,1,255*v),b.set(o,2,255*v),b.set(o,3,255)}a.attributes.normal=w,a.attributes.color=b}}}(n,i);const u=n.meta.isEsriSymbolResource?{usePBR:r.usePBR,isSchematic:!1,treeRendering:n.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:r.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},w={...r.materialParamsMixin,treeRendering:n.customMeta.esriTreeRendering};if(null!=a.specifiedLodIndex){const e=ue(n,u,w,a.specifiedLodIndex);let t=e[0].boundingBox;if(0!==a.specifiedLodIndex){t=ue(n,u,w,0)[0].boundingBox}return{lods:e,referenceBoundingBox:t,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1,remove:n.remove}}const R=ue(n,u,w);return{lods:R,referenceBoundingBox:R[0].boundingBox,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1,remove:n.remove}}function ie(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function ue(e,r,s,o){const a=e.model,n=w(),i=new Array,u=new Map,l=new Map;return a.lods.forEach(((e,c)=>{if(void 0!==o&&c!==o)return;const m={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:t(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:P()};i.push(m),e.parts.forEach((e=>{const o=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),i=a.materials.get(e.material),c=t(e.attributes.texCoord0),d=t(e.attributes.normal);if(!u.has(o)){if(c){if(t(i.textureColor)&&!l.has(i.textureColor)){const e=a.textures.get(i.textureColor),t={...e.parameters,preMultiplyAlpha:!0};l.set(i.textureColor,new X(e.data,t))}if(t(i.textureNormal)&&!l.has(i.textureNormal)){const e=a.textures.get(i.textureNormal),t={...e.parameters,preMultiplyAlpha:!0};l.set(i.textureNormal,new X(e.data,t))}if(t(i.textureOcclusion)&&!l.has(i.textureOcclusion)){const e=a.textures.get(i.textureOcclusion),t={...e.parameters,preMultiplyAlpha:!0};l.set(i.textureOcclusion,new X(e.data,t))}if(t(i.textureEmissive)&&!l.has(i.textureEmissive)){const e=a.textures.get(i.textureEmissive),t={...e.parameters,preMultiplyAlpha:!0};l.set(i.textureEmissive,new X(e.data,t))}if(t(i.textureMetallicRoughness)&&!l.has(i.textureMetallicRoughness)){const e=a.textures.get(i.textureMetallicRoughness),t={...e.parameters,preMultiplyAlpha:!0};l.set(i.textureMetallicRoughness,new X(e.data,t))}}const n=i.color[0]**(1/q),m=i.color[1]**(1/q),p=i.color[2]**(1/q),f=i.emissiveFactor[0]**(1/q),x=i.emissiveFactor[1]**(1/q),g=i.emissiveFactor[2]**(1/q);u.set(o,new D({...r,transparent:"BLEND"===i.alphaMode,textureAlphaMode:le(i.alphaMode),textureAlphaCutoff:i.alphaCutoff,diffuse:[n,m,p],ambient:[n,m,p],opacity:i.opacity,doubleSided:i.doubleSided,doubleSidedType:"winding-order",cullFace:i.doubleSided?0:2,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:d?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:t(i.textureColor)&&c?l.get(i.textureColor).id:void 0,colorMixMode:i.colorMixMode,normalTextureId:t(i.textureNormal)&&c?l.get(i.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:t(i.textureOcclusion)&&c?l.get(i.textureOcclusion).id:void 0,emissiveTextureId:t(i.textureEmissive)&&c?l.get(i.textureEmissive).id:void 0,metallicRoughnessTextureId:t(i.textureMetallicRoughness)&&c?l.get(i.textureMetallicRoughness).id:void 0,emissiveFactor:[f,x,g],mrrFactors:[i.metallicFactor,i.roughnessFactor,r.mrrFactors[2]],isSchematic:!1,...s}))}const p=function(e,t){switch(t){case 4:return J(e);case 5:return H(e);case 6:return Q(e)}}(e.indices||e.attributes.position.count,e.primitiveType),f=e.attributes.position.count,x=V(M,f);I(x,e.attributes.position,e.transform);const g=[["position",{data:x.typedBuffer,size:x.elementCount,exclusive:!0}]],h=[["position",p]];if(t(e.attributes.normal)){const t=V(M,f);R(n,e.transform),O(t,e.attributes.normal,n),g.push(["normal",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),h.push(["normal",p])}if(t(e.attributes.tangent)){const t=V(B,f);R(n,e.transform),_(t,e.attributes.tangent,n),g.push(["tangent",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),h.push(["tangent",p])}if(t(e.attributes.texCoord0)){const t=V(A,f);z(t,e.attributes.texCoord0),g.push(["uv0",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),h.push(["uv0",p])}if(t(e.attributes.color)){const t=V(E,f);if(4===e.attributes.color.elementCount)e.attributes.color instanceof B?$(t,e.attributes.color,255):e.attributes.color instanceof E?G(t,e.attributes.color):e.attributes.color instanceof T&&$(t,e.attributes.color,1/256);else{W(t,255,255,255,255);const r=new C(t.buffer,0,4);e.attributes.color instanceof M?S(r,e.attributes.color,255):e.attributes.color instanceof C?K(r,e.attributes.color):e.attributes.color instanceof j&&S(r,e.attributes.color,1/256)}g.push(["color",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),h.push(["color",p])}const b=new L(g,h);m.stageResources.geometries.push(b),m.stageResources.materials.push(u.get(o)),c&&(t(i.textureColor)&&m.stageResources.textures.push(l.get(i.textureColor)),t(i.textureNormal)&&m.stageResources.textures.push(l.get(i.textureNormal)),t(i.textureOcclusion)&&m.stageResources.textures.push(l.get(i.textureOcclusion)),t(i.textureEmissive)&&m.stageResources.textures.push(l.get(i.textureEmissive)),t(i.textureMetallicRoughness)&&m.stageResources.textures.push(l.get(i.textureMetallicRoughness))),m.numberOfVertices+=f;const v=b.boundingInfo;t(v)&&(U(m.boundingBox,v.getBBMin()),U(m.boundingBox,v.getBBMax()))}))})),i}function le(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}var ce=Object.freeze({__proto__:null,fetch:ne,parseUrl:ie,gltfToEngineResources:ue});export{ne as f,Z as l,ce as o};
