/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{clone as e}from"../core/lang.js";import{id as t}from"../kernel.js";import o from"../config.js";import{addQueryParameters as r}from"../core/urlUtils.js";import s from"../geometry/SpatialReference.js";import n from"../request.js";import{b as i}from"./extentUtils.js";import a from"../PopupTemplate.js";import{fromJSON as f}from"../renderers/support/jsonUtils.js";import l from"../tasks/support/FeatureSet.js";import{e as u,c as p,N as m,a as y}from"./aaBoundingBox.js";const c={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function d(t){const o=t.folders||[],r=o.slice(),s=new Map,n=new Map,i=new Map,a=new Map,f=new Map,l={esriGeometryPoint:n,esriGeometryPolyline:i,esriGeometryPolygon:a};(t.featureCollection&&t.featureCollection.layers||[]).forEach((t=>{const o=e(t);o.featureSet.features=[];const r=t.featureSet.geometryType;s.set(r,o);const f=t.layerDefinition.objectIdField;"esriGeometryPoint"===r?G(n,f,t.featureSet.features):"esriGeometryPolyline"===r?G(i,f,t.featureSet.features):"esriGeometryPolygon"===r&&G(a,f,t.featureSet.features)})),t.groundOverlays&&t.groundOverlays.forEach((e=>{f.set(e.id,e)})),o.forEach((e=>{e.networkLinkIds.forEach((o=>{const s=function(e,t,o){const r=function(e,t){let o;return t.some((t=>t.id===e&&(o=t,!0))),o}(e,o);r&&(r.parentFolderId=t,r.networkLink=r);return r}(o,e.id,t.networkLinks);s&&r.push(s)}))})),r.forEach((t=>{t.featureInfos&&(t.points=e(s.get("esriGeometryPoint")),t.polylines=e(s.get("esriGeometryPolyline")),t.polygons=e(s.get("esriGeometryPolygon")),t.mapImages=[],t.featureInfos.map((e=>{switch(e.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const o=l[e.type].get(e.id);o&&t[c[e.type]].featureSet.features.push(o);break}case"GroundOverlay":{const o=f.get(e.id);o&&t.mapImages.push(o);break}}})),t.fullExtent=P([t]))}));const u=P(r);return{folders:o,sublayers:r,extent:u}}function g(e,s,i,a){const f=t&&t.findCredential(e);e=r(e,{token:f&&f.token});const l=o.kmlServiceUrl;return n(l,{query:{url:e,model:"simple",folders:"",refresh:0!==i||void 0,outSR:JSON.stringify(s)},responseType:"json",signal:a})}function S(e,t,o=null,r=[]){const s=[],n={},i=t.sublayers,a=t.folders.map((e=>e.id));return i.forEach((t=>{const i=new e;if(o?i.read(t,o):i.read(t),r.length&&a.indexOf(i.id)>-1&&(i.visible=-1!==r.indexOf(i.id)),n[t.id]=i,null!=t.parentFolderId&&-1!==t.parentFolderId){const e=n[t.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers.unshift(i)}else s.unshift(i)})),s}function G(e,t,o){o.forEach((o=>{e.set(o.attributes[t],o)}))}async function h(e){const t=l.fromJSON(e.featureSet).features,o=e.layerDefinition,r=f(o.drawingInfo.renderer),s=a.fromJSON(e.popupInfo),n=[];for(const e of t){const t=await r.getSymbolAsync(e);e.symbol=t,e.popupTemplate=s,e.visible=!0,n.push(e)}return n}function P(e){const t=p(),o=p(m);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const e of r.polygons.featureSet.features)i(t,e.geometry),y(o,t);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const e of r.polylines.featureSet.features)i(t,e.geometry),y(o,t);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const e of r.points.featureSet.features)i(t,e.geometry),y(o,t);if(r.mapImages)for(const e of r.mapImages)i(t,e.extent),y(o,t)}return u(o,m)?null:{xmin:o[0],ymin:o[1],zmin:o[2],xmax:o[3],ymax:o[4],zmax:o[5],spatialReference:s.WGS84}}export{P as c,g as f,h as g,d as p,S as s};
