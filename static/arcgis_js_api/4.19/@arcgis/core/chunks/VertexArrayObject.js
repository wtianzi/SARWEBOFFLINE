/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{a as e,i as t}from"../core/lang.js";import{b as i,f as s}from"./Logger.js";import{c as r}from"./FramebufferObject.js";class n{constructor(e,t,i,s,n){this._context=e,this.bufferType=t,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(1,this),this._glName=this._context.gl.createBuffer(),r(this._context.gl),s&&this.setData(s,n)}static createIndex(e,t,i,s){return new n(e,34963,t,i,s)}static createVertex(e,t,i){return new n(e,34962,t,i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return 34962===this.bufferType?this._size:5125===this._indexType?4*this._size:2*this._size}dispose(){if(this._context){if(this._glName){this._context.gl.deleteBuffer(this._glName),this._glName=null}this._context.instanceCounter.decrement(1,this),this._context=null}}setData(i,s){if(!i)return;if("number"==typeof i){if(i<0&&console.error("Buffer size cannot be negative!"),34963===this.bufferType&&s)switch(this._indexType=s,this._size=i,s){case 5123:i*=2;break;case 5125:i*=4}}else{let s=i.byteLength;e(i)&&(s/=2,this._indexType=5123),t(i)&&(s/=4,this._indexType=5125),this._size=s}const r=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);this._context.gl.bufferData(this.bufferType,i,this.usage),this._context.bindVAO(r)}setSubData(i,s=0,r=0,n=i.byteLength){if(!i)return;(s<0||s>=this._size)&&console.error("offset is out of range!");let o=s,a=r,c=n,u=i.byteLength;e(i)&&(u/=2,o*=2,a*=2,c*=2),t(i)&&(u/=4,o*=4,a*=4,c*=4),void 0===n&&(n=u-1),r>=n&&console.error("end must be bigger than start!"),s+r-n>this._size&&console.error("An attempt to write beyond the end of the buffer!");const f=this._context.getBoundVAO();this._context.bindVAO(null),this._context.bindBuffer(this);const h=this._context.gl,l=ArrayBuffer.isView(i)?i.buffer:i,d=0===a&&c===i.byteLength?l:l.slice(a,c);h.bufferSubData(this.bufferType,o,d),this._context.bindVAO(f)}}function o(e,t){return e.vertexBuffers[t].size/a(e.layout[t])}function a(e){return e[0].stride}function c(e,t,i,s,r){const n=e.gl,o=e.capabilities.instancing;e.bindBuffer(i);for(const e of s){const i=t[e.name],s=(r||(0+e.baseInstance?e.baseInstance:0))*e.stride;if(void 0===i&&console.error(`There is no location for vertex attribute '${e.name}' defined.`),e.baseInstance&&!e.divisor&&console.error(`Vertex attribute '${e.name}' uses baseInstanceOffset without divisor.`),e.count<=4)n.vertexAttribPointer(i,e.count,e.type,e.normalized,e.stride,e.offset+s),n.enableVertexAttribArray(i),e.divisor&&e.divisor>0&&o&&o.vertexAttribDivisor(i,e.divisor);else if(9===e.count)for(let t=0;t<3;t++)n.vertexAttribPointer(i+t,3,e.type,e.normalized,e.stride,e.offset+12*t+s),n.enableVertexAttribArray(i+t),e.divisor&&e.divisor>0&&o&&o.vertexAttribDivisor(i+t,e.divisor);else if(16===e.count)for(let t=0;t<4;t++)n.vertexAttribPointer(i+t,4,e.type,e.normalized,e.stride,e.offset+16*t+s),n.enableVertexAttribArray(i+t),e.divisor&&e.divisor>0&&o&&o.vertexAttribDivisor(i+t,e.divisor);else console.error("Unsupported vertex attribute element count: "+e.count)}}function u(e,t,i,s){const r=e.gl,n=e.capabilities.instancing;e.bindBuffer(i);for(const e of s){const i=t[e.name];if(e.count<=4)r.disableVertexAttribArray(i),e.divisor&&e.divisor>0&&n&&n.vertexAttribDivisor(i,0);else if(9===e.count)for(let t=0;t<3;t++)r.disableVertexAttribArray(i+t),e.divisor&&e.divisor>0&&n&&n.vertexAttribDivisor(i+t,0);else if(16===e.count)for(let t=0;t<4;t++)r.disableVertexAttribArray(i+t),e.divisor&&e.divisor>0&&n&&n.vertexAttribDivisor(i+t,0);else console.error("Unsupported vertex attribute element count: "+e.count)}e.unbindBuffer(34962)}function f(e){switch(e){case 6406:case 6409:case 36168:return 1;case 6410:case 32854:case 33325:case 32854:case 33189:return 2;case 6407:case 6402:return 3;case 6408:case 34041:case 33326:case 35898:case 33327:case 34041:return 4;case 33328:case 34842:return 8;case 34836:return 16;case 33776:case 33777:return.5;case 33778:case 33779:return 1;case 37488:case 37489:case 37492:case 37493:case 37494:case 37495:return.5;case 37490:case 37491:case 37496:case 37497:return 1}return 0}function h(e){if(i(e))return 0;if("colorAttachment"in e)return e.glName?h(e.colorAttachment)+h(e.depthStencilAttachment):0;if("descriptor"in e)return e.glName?h(e.descriptor):0;const t=e.internalFormat||"pixelFormat"in e&&e.pixelFormat;if(!t)return 0;const s="hasMipmap"in e&&e.hasMipmap?1.3:1,r=e.width*e.height;return f(t)*r*s}class l{constructor(e,t,i,s,r){this._context=e,this._locations=t,this._layout=i,this._buffers=s,this._indexBuffer=r,this._glName=null,this._initialized=!1,e.instanceCounter.increment(2,this)}get glName(){return this._glName}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce(((e,t)=>e+this._buffers[t].size),this._indexBuffer?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(e=!0){if(!this._context)return;const t=this._context.capabilities.vao;t&&this._glName&&(t.deleteVertexArray(this._glName),this._glName=null);if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),e){for(const e in this._buffers)this._buffers[e].dispose(),delete this._buffers[e];this._indexBuffer=s(this._indexBuffer)}this._context.instanceCounter.decrement(2,this),this._context=null}initialize(){if(this._initialized)return;const e=this._context.capabilities.vao;if(e){const t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t}this._initialized=!0}bind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const e=this._buffers,t=!!this._context.capabilities.vao,i=this._layout,s=this._indexBuffer;e||console.error("Vertex buffer dictionary is empty!");const r=this._context.gl;for(const t in e){const s=e[t];s||console.error("Vertex buffer is uninitialized!");const r=i[t];r||console.error("Vertex element descriptor is empty!"),c(this._context,this._locations,s,r)}s&&(t?r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s.glName):this._context.bindBuffer(s))}unbind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const e=this._buffers,t=this._layout;e||console.error("Vertex buffer dictionary is empty!");for(const i in e){const s=e[i];s||console.error("Vertex buffer is uninitialized!");const r=t[i];u(this._context,this._locations,s,r)}this._indexBuffer&&this._context.unbindBuffer(this._indexBuffer.bufferType)}}export{n as B,l as V,a,c as b,f as c,h as g,u,o as v};
