/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{clone as t}from"../core/lang.js";import{i as r,b as s,L as n,c as o}from"./Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import a,{S as l,a as u}from"../core/Accessor.js";import"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{fixFields as d,unpackFieldNames as p,collectLabelingFields as f,collectFilterFields as m}from"../layers/support/fieldUtils.js";import{HandleOwner as y}from"../core/HandleOwner.js";import h from"../views/layers/LayerView.js";import{a as b}from"./attributeUtils.js";const w={setAttribute(){},rollback(){},commit(){}};function g(e,r){const n=r.attributes[e.objectIdField],o=e.sessions.get(n);if(o)return o;const i=t(r.attributes),a=new Set;if(null==n)return w;const l=e.attributeOverrides.createInteractiveEditSession(n),u=new Map;let c=0;const d={setAttribute(t,o){if(0!==c)return;const i=e.fieldsIndex.get(t);if(s(i))return;const d=e.attributeStorageInfo.findIndex((e=>e.name===i.name));if(d<0)return;l.set(d,o);const p=e.attributeStorageInfo[d];let f=!1;a.add(t),e.forEachNode(((t,s)=>{const i=((e,t)=>{const r=u.get(e);if(null==r){const r=t.indexOf(n);return u.set(e,r),r}return r})(t,s);if(-1===i)return;const a=e.getAttributeData(t.index);if(a){const s=a[p.name];s&&(s[i]=o,e.setAttributeData(t.index,a,r),f=!0)}})),f&&e.clearMemCache()},rollback(){if(0===c){for(const e of a)this.setAttribute(e,i[e]);l.rollback(),c=1,e.sessions.delete(n)}},commit(){0===c&&(l.commit(),c=2,e.sessions.delete(n))}};return e.sessions.set(n,d),d}function F(e,t){const s=function(e,t){const r=t.edits.updateFeatures;if(!r||0===r.length)return new A;const s=function(e){const t=new Set;if(!e.updatedFeatures)return t;for(const r of e.updatedFeatures)null!=r.objectId&&null==r.error&&t.add(r.objectId);return t}(t),n=new A,o=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)o.set(e.attributeStorageInfo[t].name,t);const i=e.fieldsIndex,a=e.objectIdField,l=r.filter((e=>{const t=b(i,e.attributes,a);return s.has(t)}));return e.forEachNode(((t,r)=>{const s=new Set(r);for(const o of l){const l=b(i,o.attributes,a);if(!s.has(l))continue;const u=r.indexOf(l);for(const r in o.attributes){const s=e.fieldsIndex.normalizeFieldName(r),i=x(n,t.index,s),a=o.attributes[r];i.push({featureIndex:u,featureId:l,value:a})}}})),n}(e,t);if(0===s.size)return;const n=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)n.set(e.attributeStorageInfo[t].name,t);let o=!1;s.forEach(((t,s)=>{const i=e.getAttributeData(s);let a=!1;t.forEach(((t,s)=>{const l=r(i)?i[s]:null,u=n.get(s);for(const{featureIndex:r,value:s,featureId:n}of t)l&&(l[r]=s,a=!0,o=!0),e.attributeOverrides.updateValue(n,u,s)})),a&&e.setAttributeData(s,i,null)})),o&&e.clearMemCache()}function x(e,t,r){const s=function(e,t){const r=e.get(t);if(r)return r;const s=new S;return e.set(t,s),s}(e,t),n=s.get(r);if(n)return n;const o=new Array;return s.set(r,o),o}const S=Map,A=Map;function v(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fields:t},requiredFields:r}=this;return e.outFields?d(t,[...p(t,e.outFields),...r]):d(t,r)}}}}const I=t=>{let r=class extends t{constructor(){super(...arguments),this.asyncUpdateState=new Map}autoUpdateAsync(e,t){return function(e,t){const r=()=>{o&&!i&&e(s)},s=()=>{if(!o||i)return t();o.clear(),i=!0;const e=u(o,t);return i=!1,e},n=()=>{o&&(o.destroy(),o=null)};let o=new l(r),i=!1;return e(s),{remove:n}}((t=>this.updateAsync(e,t)),t)}async updateAsync(e,t){if(!this.startAsyncUpdate(e)){try{const r=await t();this._set(e,r)}catch(t){n.getLogger(this.declaredClass).warn(`Async update of "${e}" failed. Async update functions should not throw exceptions.`)}this.endAsyncUpdate(e)&&this.updateAsync(e,t)}}startAsyncUpdate(e){var t;const r=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&r?(this.asyncUpdateState.set(e,2|r),!0):(this.asyncUpdateState.set(e,1|r),!1)}endAsyncUpdate(e){var t;const r=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&r?(this.asyncUpdateState.set(e,-3&r),!0):(this.asyncUpdateState.set(e,r),!1)}};return r=e([c("esri.core.AsyncUpdate")],r),r};let U=class extends(I(a)){};U=e([c("esri.core.AsyncUpdate")],U);const j=n.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields");let E=class extends(I(y)){constructor(e){super(e)}get requiredFields(){const{layerView:{layer:{fields:e},definitionExpressionFields:t},rendererFields:r,labelingFields:s,viewFilterFields:n}=this;return d(e,[...o(t,[]),...o(r,[]),...o(s,[]),...o(n,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",(()=>{const{fields:e,renderer:t}=this.layer;return t?N((r=>t.collectRequiredFields(r,e))):null})),this.autoUpdateAsync("labelingFields",(()=>{const{layer:e}=this;return e.labelsVisible?N((t=>f(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:t}=this.layerView;return N((r=>m(r,e,t)))}))])}};async function N(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return j.error(e),null}}e([i()],E.prototype,"layerView",void 0),e([i()],E.prototype,"layer",void 0),e([i()],E.prototype,"requiredFields",null),e([i()],E.prototype,"rendererFields",void 0),e([i()],E.prototype,"labelingFields",void 0),e([i()],E.prototype,"viewFilterFields",void 0),E=e([c("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],E);class O extends h{constructor(){super(...arguments),this.layer=null,this.filter=null}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}}e([i()],O.prototype,"layer",void 0),e([i()],O.prototype,"availableFields",null),e([i()],O.prototype,"maximumNumberOfFeatures",null),e([i({readOnly:!0})],O.prototype,"maximumNumberOfFeaturesExceeded",null),e([i()],O.prototype,"filter",void 0);export{O as S,E as a,g as c,v as d,F as p};
