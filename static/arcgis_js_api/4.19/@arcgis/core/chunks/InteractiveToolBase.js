/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{clone as e}from"../core/lang.js";import{i as n,b as a,u as r}from"./Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import s from"../core/Accessor.js";import{createResolver as o}from"../core/promiseUtils.js";import"./ensureType.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import c from"../core/Collection.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{project as u,canProject as h}from"../geometry/support/webMercatorUtils.js";import{c as p}from"./mathUtils2.js";import{c as m}from"../geometry/Polygon.js";import{c as d}from"./extentUtils.js";import{c as f}from"./screenUtils.js";import{c as y}from"./aaBoundingRect.js";import{b as x}from"./interactiveToolUtils.js";function _(t,e,n,a){if(null==a||t.hasZ||(a=void 0),"point"===t.type)return t.x+=e,t.y+=n,t.hasZ&&null!=a&&(t.z+=a),t;if("multipoint"===t.type){const r=t.points;for(let t=0;t<r.length;t++)r[t]=M(r[t],e,n,a);return t}if("extent"===t.type)return t.xmin+=e,t.xmax+=e,t.ymin+=n,t.ymax+=n,null!=a&&(t.zmin+=a,t.zmax+=a),t;const r=m(t),i="polyline"===t.type?t.paths:t.rings;for(let t=0;t<r.length;t++){const i=r[t];for(let t=0;t<i.length;t++)i[t]=M(i[t],e,n,a)}return"paths"in t?t.paths=i:t.rings=i,t}function g(t,e,n,a,r){const i=t.clone(),s=a.resolution;if("point"===i.type){if(r)_(i,e*s,-n*s);else{const t=a.state.transform,r=a.state.inverseTransform,s=t[0]*i.x+t[2]*i.y+t[4],o=t[1]*i.x+t[3]*i.y+t[5];i.x=r[0]*(s+e)+r[2]*(o+n)+r[4],i.y=r[1]*(s+e)+r[3]*(o+n)+r[5]}return i}if("multipoint"===i.type){if(r)_(i,e*s,-n*s);else{const t=i.points,r=a.state.transform,s=a.state.inverseTransform;for(let a=0;a<t.length;a++){const i=t[a],o=r[0]*i[0]+r[2]*i[1]+r[4],l=r[1]*i[0]+r[3]*i[1]+r[5],c=s[0]*(o+e)+s[2]*(l+n)+s[4],u=s[1]*(o+e)+s[3]*(l+n)+s[5];t[a]=S(i,c,u,void 0)}}return i}if("extent"===i.type){if(r)_(i,e*s,-n*s);else{const t=a.state.transform,r=a.state.inverseTransform,s=t[0]*i.xmin+t[2]*i.ymin+t[4],o=t[1]*i.xmin+t[3]*i.ymin+t[5],l=t[0]*i.xmax+t[2]*i.ymax+t[4],c=t[1]*i.xmax+t[3]*i.ymax+t[5];i.xmin=r[0]*(s+e)+r[2]*(o+n)+r[4],i.ymin=r[1]*(s+e)+r[3]*(o+n)+r[5],i.xmax=r[0]*(l+e)+r[2]*(c+n)+r[4],i.ymax=r[1]*(l+e)+r[3]*(c+n)+r[5]}return i}if(r)_(i,e*s,-n*s);else{const t=m(i),r="polyline"===i.type?i.paths:i.rings,s=a.state.transform,o=a.state.inverseTransform;for(let a=0;a<t.length;a++){const r=t[a];for(let t=0;t<r.length;t++){const a=r[t],i=s[0]*a[0]+s[2]*a[1]+s[4],l=s[1]*a[0]+s[3]*a[1]+s[5],c=o[0]*(i+e)+o[2]*(l+n)+o[4],u=o[1]*(i+e)+o[3]*(l+n)+o[5];r[t]=S(a,c,u,void 0)}}"paths"in i?i.paths=r:i.rings=r}return i}function v(t,e,n,a){if("point"===t.type){const{x:r,y:i}=t,s=a?a[0]:r,o=a?a[1]:i,l=t.clone(),c=(r-s)*e+s,u=(i-o)*n+o;return l.x=c,l.y=u,l}if("multipoint"===t.type){const r=m(t),i=y(),[s,o,l,c]=d(i,[r]),u=a?a[0]:(s+l)/2,h=a?a[1]:(c+o)/2,p=t.clone(),f=p.points;for(let t=0;t<f.length;t++){const a=f[t],[r,i]=a,s=(r-u)*e+u,o=(i-h)*n+h;f[t]=S(a,s,o,void 0)}return p}if("extent"===t.type){const{xmin:r,xmax:i,ymin:s,ymax:o}=t,l=a?a[0]:(r+i)/2,c=a?a[1]:(o+s)/2,u=t.clone();if(u.xmin=(r-l)*e+l,u.ymax=(o-c)*n+c,u.xmax=(i-l)*e+l,u.ymin=(s-c)*n+c,u.xmin>u.xmax){const t=u.xmin,e=u.xmax;u.xmin=e,u.xmax=t}if(u.ymin>u.ymax){const t=u.ymin,e=u.ymax;u.ymin=e,u.ymax=t}return u}const r=m(t),i=y(),[s,o,l,c]=d(i,r),u=a?a[0]:(s+l)/2,h=a?a[1]:(c+o)/2,p=t.clone(),f="polyline"===p.type?p.paths:p.rings;for(let t=0;t<r.length;t++){const a=r[t];for(let r=0;r<a.length;r++){const i=a[r],[s,o]=i,l=(s-u)*e+u,c=(o-h)*n+h;f[t][r]=S(i,l,c,void 0)}}return"paths"in p?p.paths=f:p.rings=f,p}function E(t,e,n,a,r,i){const s=Math.sqrt((n-t)*(n-t)+(a-e)*(a-e));return Math.sqrt((r-t)*(r-t)+(i-e)*(i-e))/s}function b(t,e,n,a,r,i){const s=180*Math.atan2(e-a,t-n)/Math.PI;return 180*Math.atan2(e-i,t-r)/Math.PI-s}function M(t,e,n,a){return S(t,t[0]+e,t[1]+n,null!=t[2]&&null!=a?t[2]+a:void 0)}function S(t,e,n,a){const r=[e,n];return t.length>2&&r.push(null!=a?a:t[2]),t.length>3&&r.push(t[3]),r}function j(t,e){return t.events.on("drag",function(t,e){let r=null,i=null;return s=>{if("cancel"===s.action)return void(n(i)&&(i.execute({action:"cancel"}),r=null,i=null));const o={action:s.action,screenStart:s.start,screenEnd:s.screenPoint};"start"===s.action&&a(r)&&(r=new q,i=new q,e(t,r,i,s.pointerType,o)),n(r)&&r.execute(o),"end"===s.action&&n(r)&&(r=null,i=null)}}(t,e))}function w(t,e){const n=[t.x,t.y,t.z],a=e,r=[Math.cos(a),Math.sin(a)],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===i)return null;r[0]/=i,r[1]/=i;const s=t=>{const e=(t.x-n[0])*r[0]+(t.y-n[1])*r[1];t.x=n[0]+e*r[0],t.y=n[1]+e*r[1]};return t=>(s(t.mapStart),s(t.mapEnd),t)}function A(t,e){let r=null;const i=n(t[e])?t[e].spatialReference:null;return s=>{var o,l;if("start"===s.action&&n(t[e])&&(o=t[e],l=s.mapStart.spatialReference,r=a(o)||"mesh"===o.type?null:o.spatialReference.equals(l)?o.clone():h(o,l)?u(o,l):null),a(r))return null;const c=s.mapEnd.x-s.mapStart.x,p=s.mapEnd.y-s.mapStart.y,m=s.mapEnd.z-s.mapStart.z,d=_(r.clone(),c,p,m);return d.spatialReference.equals(i)?t[e]=d:t[e]=u(d,i),{...s,translationX:c,translationY:p,translationZ:m}}}function I(t){return A(t,"geometry")}function T(t,e=null,r){let i=null;const s=n(e)&&!t.spatialReference.equals(e)?t=>n(t)?u(t,e):t:t=>t,o={exclude:[],...r};return e=>{if("start"===e.action&&(i=s(t.toMap(e.screenStart,o))),a(i))return null;const r=s(t.toMap(e.screenEnd,o));return n(r)?{...e,mapStart:i,mapEnd:r}:null}}function z(t){const e=t.map((t=>r(I(t)))).filter((t=>n(t)));return t=>{const n=t.mapEnd.x-t.mapStart.x,a=t.mapEnd.y-t.mapStart.y,r=t.mapEnd.z-t.mapStart.z;return e.forEach((e=>e(t))),{...t,translationX:n,translationY:a,translationZ:r}}}function C(t,n){const a=new Map;for(const r of n)a.set(r,e(t[r]));return e=>(a.forEach(((e,n)=>{t[n]=e})),e)}function R(t){return C(t,["geometry"])}function D(t){const e=t.map((t=>r(R(t)))).filter((t=>n(t)));return t=>(e.forEach((e=>e(t))),t)}function F(t){const e=n(t.symbol)?t.symbol.clone():null;return n=>(t.symbol=e,n)}function P(){let t=0,e=0,n=0;return a=>{"start"===a.action&&(t=a.mapStart.x,e=a.mapStart.y,n=a.mapStart.z);const r=a.mapEnd.x-t,i=a.mapEnd.y-e,s=a.mapEnd.z-n;return t=a.mapEnd.x,e=a.mapEnd.y,n=a.mapEnd.z,{...a,mapDeltaX:r,mapDeltaY:i,mapDeltaZ:s,mapDeltaSpatialReference:a.mapStart.spatialReference}}}function U(){let t=0,e=0;return n=>{"start"===n.action&&(t=n.screenStart.x,e=n.screenStart.y);const a=n.screenEnd.x-t,r=n.screenEnd.y-e;return t=n.screenEnd.x,e=n.screenEnd.y,{...n,screenDeltaX:a,screenDeltaY:r}}}function O(t,e){let n=null,a=0,r=0;return i=>{if("start"===i.action&&(n=t.toScreen(e),n.x<0||n.x>t.width||n.y<0||n.y>t.height?n=null:(a=i.screenStart.x-n.x,r=i.screenStart.y-n.y)),null==n)return null;const s=p(i.screenEnd.x-a,0,t.width),o=p(i.screenEnd.y-r,0,t.height),l=f(s,o);return i.screenStart=n,i.screenEnd=l,i}}class q{constructor(){this.execute=()=>{}}next(t,e=new q){return n(t)&&(this.execute=a=>{const r=t(a);n(r)&&e.execute(r)}),e}}class X{constructor(){this._isToolEditable=!0,this._manipulators=new c,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=0){return this.addMany([t],e)[0]}addMany(t,e=0){return t.map((t=>{const n=this._nextManipulatorId++,a={id:n,manipulator:t,visibilityPredicate:e,attached:!1};return this._manipulators.add(a),this._attached&&this._updateManipulatorAttachment(a),n}))}remove(t){if("number"==typeof t){const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(t,e){let a=null,r=Number.MAX_VALUE;return this._manipulators.forEach((({id:i,manipulator:s,attached:o})=>{if(!o||!s.interactive)return;const l=s.intersectionDistance(t,e);n(l)&&l<r&&(r=l,a={id:i,manipulator:s})})),a}findById(t){if(a(t))return null;for(const e of this._manipulators.items)if(t===e.id)return e.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return 2===t.visibilityPredicate||(this._isToolEditable?0===t.visibilityPredicate:1===t.visibilityPredicate)}}let Z=class extends s{constructor(t){super(t),this.attached=!1,this.created=!1,this.completed=!1,this.manipulators=new X,this.deferCreation=!1,this._editableFlags=new Array,this._creationResolver=o()}get active(){return null!=this.view&&this.view.activeTool===this}get isSupported(){return!0}set visible(t){this._set("visible",t),t||x(this,!1),this.attached&&(t?this._show():this._hide())}get editable(){return this.hasEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}attach(){!this.attached&&this.isSupported&&(this.manipulators.attach(),this.onAttach(),this.visible&&this.onShow(),this._set("attached",!0))}detach(){this.attached&&(this.onHide(),this.onDetach(),this.manipulators.detach(),this._set("attached",!1))}handleInputEvent(t){this.attached&&this.onInputEvent(t)}handleInputEventAfter(t){this.attached&&this.onInputEventAfter(t)}destroy(){this.manipulators.destroy(),this._set("view",null),this._set("created",!1),this._set("completed",!1)}setEditableFlag(t,e){this._editableFlags[t]=e,this.manipulators.isToolEditable=this._editableFlags.every((t=>null==t||t)),this._updateManipulatorAttachment(),0===t&&this.notifyChange("editable"),this.onEditableChange()}hasEditableFlag(t){const e=this._editableFlags[t];return null==e||e}when(){return this._creationResolver.promise}rejectCreation(t){this._creationResolver.reject(t)}initialize(){this.deferCreation||this.complete()}onAttach(){}onDetach(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.hasEditableFlag(0)&&this.hasEditableFlag(1)}create(){this.created||(this._set("created",!0),this._creationResolver.resolve(this))}complete(){this.create(),this._set("completed",!0)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.attached&&this.visible?this.manipulators.attach():this.manipulators.detach()}};t([i({constructOnly:!0})],Z.prototype,"view",void 0),t([i({readOnly:!0})],Z.prototype,"active",null),t([i({value:!0})],Z.prototype,"visible",null),t([i({value:!0})],Z.prototype,"editable",null),t([i({readOnly:!0})],Z.prototype,"attached",void 0),t([i({readOnly:!0})],Z.prototype,"created",void 0),t([i({readOnly:!0})],Z.prototype,"completed",void 0),t([i({readOnly:!0})],Z.prototype,"manipulators",void 0),t([i({constructOnly:!0})],Z.prototype,"deferCreation",void 0),Z=t([l("esri.views.interactive.InteractiveToolBase")],Z);export{q as E,Z as I,X as M,R as a,O as b,j as c,I as d,w as e,U as f,P as g,z as h,D as i,F as j,g as k,v as l,E as m,b as n,C as r,T as s};
