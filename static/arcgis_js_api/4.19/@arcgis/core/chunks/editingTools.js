/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./ArrayPool.js";import{h as t}from"../core/lang.js";import"./deprecate.js";import"./object.js";import"../kernel.js";import"../config.js";import{b as i,c as a,i as s,u as r,d as o}from"./Logger.js";import"./string.js";import{h as n,j as l,r as p,f as h}from"./metadata.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import{addFrameTask as u}from"../core/scheduling.js";import"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import"./compilerUtils.js";import"./ensureType.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{E as m}from"./Evented.js";import g from"../core/Collection.js";import"./collectionUtils.js";import"./JSONSupport.js";import"./Promise.js";import"./Loadable.js";import"./asyncUtils.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./shared.js";import"./writer.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";import"./persistable.js";import"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../request.js";import"./assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../portal/PortalItem.js";import{d as y,c as v,r as M}from"./mathUtils2.js";import{c as f,f as _,a as S,Z as w}from"./vec3f64.js";import{a as j,t as x}from"./common.js";import{a as E,e as D,b as G,p as O,s as P,n as R,d as A,c as I,f as V,l as T,h as C,E as k,g as z,r as U}from"./vec3.js";import{e as H}from"./mathUtils.js";import"./colorUtils.js";import L from"../Color.js";import"./zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"./date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"./chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"./Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{g as B,b as F,s as Z}from"./screenUtils.js";import"./opacityUtils.js";import"./materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./utils.js";import"./Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"./Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"./Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"./urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols.js";import"./uid.js";import N from"../Graphic.js";import Y from"../core/Handles.js";import"../layers/Layer.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../tasks/support/ColorRamp.js";import"../tasks/support/AlgorithmicColorRamp.js";import"../tasks/support/MultipartColorRamp.js";import"./colorRamps.js";import"../renderers/Renderer.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"./sizeVariableUtils.js";import{a as X}from"./unitUtils.js";import"./lengthUtils.js";import"./visualVariableUtils.js";import"./VisualVariablesMixin.js";import"./symbolConversion.js";import"../symbols/support/jsonUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties.js";import"../renderers/ClassBreaksRenderer.js";import{d as q}from"./colorUtils2.js";import"./diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"./devEnvironmentUtils.js";import"./styleUtils.js";import"../renderers/UniqueValueRenderer.js";import"./normalizeUtilsCommon.js";import"../geometry/support/normalizeUtils.js";import"./MemCache.js";import"./ItemCache.js";import"./utils3.js";import"../symbols/support/cimSymbolUtils.js";import"./utils2.js";import"./LRUCache.js";import"../renderers/DictionaryRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/HeatmapRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/support/jsonUtils.js";import"./timeUtils.js";import"../TimeExtent.js";import"../TimeInterval.js";import"./ReadOnlyMultiOriginJSONSupport.js";import"./MultiOriginJSONSupport.js";import{init as W}from"../core/watchUtils.js";import"./arcgisLayerUrl.js";import"./fieldType.js";import"../geometry/HeightModelInfo.js";import{u as Q,i as J,v as K,m as $,r as ee,p as te,t as ie,e as ae,s as se,d as re}from"./mat4.js";import"./pe.js";import{z as oe}from"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformationStep.js";import"../geometry/support/GeographicTransformation.js";import{projectVectorToVector as ne,projectPointToVector as le}from"../geometry/projection.js";import"./OperationalLayer.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"./commonProperties2.js";import"./Scheduler.js";import{HandleOwnerMixin as pe}from"../core/HandleOwner.js";import"./_commonjsHelpers.js";import"../core/workers/RemoteClient.js";import"../core/workers/Connection.js";import"../core/workers/workers.js";import"../form/ExpressionInfo.js";import"../form/elements/FieldElement.js";import"../form/support/elements.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/support/inputs.js";import"../form/elements/GroupElement.js";import"../form/FormTemplate.js";import"../geometry/support/geodesicUtils.js";import"../geometry/Circle.js";import"./geometryEngineBase.js";import"./hydrated.js";import"../geometry/geometryEngine.js";import"./vec4f64.js";import"./earcut.js";import"./deduplicate.js";import"./triangulationUtils.js";import{c as he}from"./quatf64.js";import"./mat3.js";import"./BufferView.js";import{a as ce,b as ue,i as de,p as me,s as ge,u as ye,v as ve,f as Me,g as fe}from"./vec2.js";import{e as _e,c as be}from"./vec4.js";import"./quat.js";import"./domUtils.js";import"./widgetUtils.js";import"./projector.js";import"./accessibleHandler.js";import"./messageBundle.js";import"../widgets/support/widget.js";import"./vmEvent.js";import"./index.js";import"../widgets/Widget.js";import"./zscale.js";import"./queryZScale.js";import"../layers/support/Field.js";import"../tasks/support/FeatureSet.js";import"../layers/FeatureLayer.js";import"./ArcGISService.js";import"./BlendLayer.js";import"./CustomParametersMixin.js";import"./PortalLayer.js";import"./RefreshableLayer.js";import"./ScaleRangeLayer.js";import"../layers/support/TimeInfo.js";import"./TemporalLayer.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureReductionCluster.js";import"./labelUtils.js";import"../layers/support/LabelClass.js";import"./defaultsJSON.js";import"./defaults.js";import"./featureReductionUtils.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"./fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"./labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./DataLayerSource.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"../tasks/support/AttachmentQuery.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"../tasks/support/RelationshipQuery.js";import"./GraphicsCollection.js";import Se from"../layers/GraphicsLayer.js";import"./utils4.js";import"../tasks/Task.js";import"../rest/query/support/AttachmentInfo.js";import"./query.js";import"./executeRelationshipQuery.js";import"./pbf.js";import"./OptimizedFeatureSet.js";import"./pbfQueryUtils.js";import"./featureConversionUtils.js";import"../tasks/QueryTask.js";import{c as we,b as je,F as xe}from"./aaBoundingBox.js";import"./vec4f32.js";import"./quantizationUtils.js";import"./mat2d.js";import"../symbols/support/symbolUtils.js";import"./byteSizeEstimations.js";import"./dehydratedFeatureComparison.js";import{m as Ee}from"./dehydratedFeatures.js";import"./ElevationProvider.js";import"./interactiveToolUtils.js";import"./throttle.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../widgets/Feature/FeatureViewModel.js";import"../widgets/Feature.js";import"./AnchorElementViewModel.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../widgets/Popup.js";import"./Queue.js";import"./InputManager.js";import"./layerViewUtils.js";import"./actions.js";import"../widgets/Popup/PopupViewModel.js";import"./GoTo.js";import"./MapUtils.js";import"./screenUtils2.js";import"./mat2df64.js";import{c as De}from"./vec2f64.js";import"./requestImageUtils.js";import"./VertexColor.glsl.js";import"./Program.js";import"./FramebufferObject.js";import"./renderState.js";import"./glUtil.js";import"./InterleavedLayout.js";import"./mat4f32.js";import"./vec3f32.js";import{a as Ge,s as Oe,c as Pe}from"./stack.js";import{p as Re,r as Ae,b as Ie}from"./geometryUtils.js";import{G as Ve,C as Te}from"./ColorMaterial.js";import"./Util.js";import"./glUtil3D.js";import"./Object3D.js";import"./VertexArrayObject.js";import{E as Ce}from"./sdfPrimitives.js";import"./lineUtils.js";import"./intersectorUtils.js";import"./Intersector.js";import"./Camera.js";import"./PiUtils.glsl.js";import"./GLMaterialTexture.js";import"./VerticalOffset.glsl.js";import{e as ke}from"./RibbonLineMaterial.js";import{g as ze}from"./pointUtils.js";import"./PhysicallyBasedRendering.glsl.js";import"./RenderGeometry.js";import{T as Ue}from"./Texture.js";import"./NativeLineMaterial.js";import"./CameraSpace.glsl.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./Settings.js";import"../views/interactive/snapping/SnappingOptions.js";import{S as He,E as Le,U as Be,M as Fe,f as Ze,g as Ne}from"../views/draw/DrawAction.js";import{e as Ye,d as Xe,b as qe,a as We}from"./elevationInfoUtils.js";import{E as Qe}from"./AppendVertex.js";import"./Keys.js";import"../views/draw/MultipointDrawAction.js";import{I as Je,d as Ke,a as $e,c as et,b as tt,e as it,f as at,E as st,g as rt,h as ot,i as nt,j as lt}from"./InteractiveToolBase.js";import{b as pt,S as ht,E as ct,c as ut,P as dt,e as mt,f as gt}from"./DrawTool.js";export{b as DrawOperation}from"./DrawTool.js";import"./VisualElement.js";import{L as yt}from"./LaserlineVisualElement.js";import{O as vt}from"./Object3DVisualElement.js";import"./RightAngleQuadVisualElement.js";import"../views/draw/PointDrawAction.js";import"../views/draw/PolygonDrawAction.js";import"../views/draw/PolylineDrawAction.js";import{c as Mt}from"../views/draw/SegmentDrawAction.js";import"../views/draw/Draw.js";import"./drapedUtils.js";import{G as ft}from"./GraphicManipulator.js";import{b as _t,c as bt,d as St,e as wt,a as jt}from"./dragEventPipeline3D.js";import{S as xt,M as Et,a as Dt,g as Gt,e as Ot,p as Pt,b as Rt}from"./manipulatorUtils.js";import"./LineVisualElement.js";import{i as At,a as It}from"../widgets/Sketch/SketchViewModel.js";import{c as Vt}from"./manipulatorUtils2.js";import{C as Tt,c as Ct,E as kt,b as zt,h as Ut,a as Ht,F as Lt,H as Bt,J as Ft,l as Zt,t as Nt,v as Yt,x as Xt}from"./heading-rotate-png.js";import"./ImageMaterial.js";import"../widgets/Slice/SlicePlane.js";import{createSquare as qt,createRectangle as Wt,createCircle as Qt,createEllipse as Jt,createPolygon as Kt,createPolyline as $t}from"./createUtils.js";import{s as ei,O as ti,G as ii,c as ai}from"./GraphicState.js";class si extends vt{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=ei.colorToVec4(ei.reshapeManipulators.vertex.color),this._size=ei.reshapeManipulators.vertex.size,this._outlineColor=ei.colorToVec4(ei.reshapeManipulators.vertex.outlineColor),this._outlineSize=ei.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){_e(e,this._color)||(be(this._color,e),this.updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){_e(e,this._outlineColor)||(be(this._outlineColor,e),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameterValues(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameterValues(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const e=this.vertices;if(i(e)||0===e.length)return[];const t=ze(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Ce.fromElevationInfo(this.elevationInfo)),a=[],s=t.numVertices,r=t.position;for(let e=0;e<s;++e){const t=E(ri,r[3*e+0],r[3*e+1],r[3*e+2]),i=oi(.5,t),s=oi(.5,t);a.push({vertexGeometry:i,vertexOutlineGeometry:s})}return a}createGeometries(e){const t=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new xt({...this.vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new xt({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const ri=f();function oi(e,t){return Ve.createSphereGeometry(e,16,16,{offset:t})}let ni=class extends(pe(m.EventedMixin(Je))){constructor(e){super(e),this.drawOperation=null,this._createGraphic=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._stagedVerticesVisualElement=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=!1,this.snappingManager=null,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=a(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new Se({elevationInfo:e,listMode:"hide",internal:!0}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new pt({view:this.view,manipulators:this.manipulators,geometryType:li(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new ht(this.view,e,[this._internalGraphicsLayer]),elevationDrawSurface:new ct(e,this.defaultZ,this.view,this._internalGraphicsLayer),hasM:!1,elevationInfo:e,snappingManager:this.snappingManager}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}_getCreateGeometry(e,t=!1){if(null==this.drawOperation)return null;const i=s(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,a=this.drawOperation.vertices;if(0===a.length)return null;const r=this.drawOperation.spatialReference,o=a,n=o.slice(),l=[];s(i)&&(n.splice(i,1),l.push(o[i]));const p={regularVertices:null,stagedVertices:null,full:null,outline:null},h="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":p.regularVertices=n,p.stagedVertices=l,p.full=this.drawOperation.coordinateHelper.createPointFromArray(a[0]);break;case"polyline":p.regularVertices=n,p.stagedVertices=l,o.length>0&&(p.full=$t([o],r,h));break;case"polygon":p.regularVertices=n,p.stagedVertices=l,o.length>0&&(p.full=Kt([o],r,h,!0));break;case"circle":if(o.length>0){const e=Mt(this.view,a[0]);if(1===o.length&&t){const t=o[0],i=e.makeMapPoint(t[0]+pi*this.view.resolution,t[1]);p.full=Qt([t,i],e,!0)}else 2===o.length&&(p.full=this.forceUniformSize?Qt(a,e,this.centered):Jt(a,e,this.centered))}break;case"rectangle":if(o.length>0){const e=Mt(this.view,a[0]);if(1===o.length&&t){const t=o[0],i=e.makeMapPoint(t[0]+pi*this.view.resolution,t[1]);p.full=qt([t,i],e,!0)}else 2===o.length&&(p.full=this.forceUniformSize?qt(a,e,this.centered):Wt(a,e,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":o.length>1&&(p.outline=$t([o],r,h));break;case"polygon":o.length>1&&(p.outline=Kt([o],r,h));break;case"circle":case"rectangle":s(p.full)&&"polygon"===p.full.type&&(p.outline=Kt(p.full.rings,r,h))}return p}_destroyAllVisualisations(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}_destroyCreateGraphic(){s(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null),this._createGraphicState=null,this.handles.remove(hi)}_destroyOutlineVisualElement(){s(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)}_destroyVerticesVisualElement(){s(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)}_destroyStagedVerticesVisualElement(){s(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)}_updateCreateGraphic(e=null){const t=this._getCreateGeometry(e);if(i(t))return void this._destroyAllVisualisations();const a=this._internalGraphicsLayer.elevationInfo;s(t.outline)?i(this._outlineVisualElement)?(this._outlineVisualElement=new ti({view:this.view,geometry:t.outline,elevationInfo:r(a),isDraped:s(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===Ye(this.hasZ,a),attached:!1}),ei.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),ei.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),s(t.regularVertices)?i(this._verticesVisualElement)?(this._verticesVisualElement=new si({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:r(this._internalGraphicsLayer.elevationInfo),renderOccluded:ei.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),s(t.stagedVertices)?i(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new si({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:r(this._internalGraphicsLayer.elevationInfo),renderOccluded:ei.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=ei.colorToVec4(ei.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),s(t.full)?i(this._createGraphic)?(this._createGraphic=new N({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this._createGraphicState=new ii({graphic:this._createGraphic}),this.handles.add([this.view.trackGraphicState(this._createGraphicState),W(this._createGraphicState,"isDraped",(e=>{s(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)}))],hi),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}get createGraphic(){return this._createGraphic}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set centered(e){this._set("centered",e),this._updateCreateGraphic()}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}onCursorUpdate(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)}onComplete(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry(null,!0);s(e)&&(t=new N({geometry:e.full,symbol:this.createGraphicSymbol}))}this.emit("complete",{graphic:t,...e})}};function li(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}e([c({constructOnly:!0,nonNullable:!0})],ni.prototype,"view",void 0),e([c()],ni.prototype,"createGraphicSymbol",void 0),e([c()],ni.prototype,"createGraphic",null),e([c({value:!0})],ni.prototype,"enabled",null),e([c({value:!0})],ni.prototype,"centered",null),e([c({value:!0})],ni.prototype,"forceUniformSize",null),e([c({constructOnly:!0})],ni.prototype,"hasZ",void 0),e([c({nonNullable:!0})],ni.prototype,"defaultZ",void 0),e([c({constructOnly:!0})],ni.prototype,"elevationInfo",void 0),e([c()],ni.prototype,"snapToScene",void 0),e([c()],ni.prototype,"snappingManager",void 0),e([c({constructOnly:!0})],ni.prototype,"mode",void 0),e([c({constructOnly:!0})],ni.prototype,"geometryType",void 0),e([c({readOnly:!0})],ni.prototype,"type",void 0),ni=e([d("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],ni);const pi=48,hi="create-graphic";class ci{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(0===t&&(this.zManipulator=e),e instanceof Et&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),i(this.firstGrabbedXY)&&e.grabbing&&1===t&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=1,t){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function ui(e){const{view:t,graphic:i}=e,a=new ii({graphic:i}),r=function(e,t){const{view:i,graphic:a}=e,s=new ti({view:i,geometry:di(a)?a.geometry:null,elevationInfo:Xe(a),attached:!1});ei.visualElements.lineGraphics.shadowStyle.apply(s);const r=()=>{s.attached=t.displaying};ei.visualElements.lineGraphics.outline.apply(s);const o=[t.watch("displaying",r),t.watch("isDraped",(e=>s.isDraped=e)),t.on("changed",(()=>s.geometry=di(a)?a.geometry:null)),l(s)];return r(),{visualElement:s,remove:()=>n(o).remove()}}(e,a),o=[r,function(e,t,i){const{graphic:a,view:r}=e,o=[],h=Xe(a),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,u=new ci,d=new ut({view:r,extensionType:ei.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});ei.visualElements.pointGraphics.shadowStyle.apply(d);const m=y(ei.visualElements.heightPlaneAngleCutoff),g=new yt({view:r,attached:!1,angleCutoff:m});ei.visualElements.heightPlane.apply(g);let v=1,M=1;const f=()=>{if(u.update(e),!i.displaying||c&&(i.isDraped||!di(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,d.attached=!1,void(g.attached=!1);t.laserlineEnabled=!0;{const e=4&u.grabbingState?ei.visualElements.laserlineAlphaMultiplier:1;e!==v&&(v=e,ei.visualElements.lineGraphics.shadowStyle.apply(t,e),ei.visualElements.pointGraphics.shadowStyle.apply(d,e))}{const e=2&u.grabbingState?ei.visualElements.laserlineAlphaMultiplier:1;e!==M&&(M=e,ei.visualElements.heightPlane.apply(g,e))}!function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&s(t.firstGrabbedXY)?t.firstGrabbedXY:null;s(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(d,u),function(e,t,i,a){if(a.numSelected>0){E(mi,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{1===i&&e.selected&&e instanceof Et&&(D(mi,mi,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=G(mi,mi,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;s(a)&&e.view.renderCoordsHelper.toRenderCoords(a,mi)?(i.heightManifoldTarget=mi,i.attached=!0):i.attached=!1}}(e,t,g,u)};ei.visualElements.zVerticalLine.apply(d),o.push(i.on("changed",f),i.watch("displaying",f),t.events.on("attachment-origin-changed",f),l(d),l(g));const _=[],b=()=>{n(_).remove(),_.length=0,e.forEachManipulator((e=>_.push(e.events.on("grab-changed",f)))),e.forEachManipulator((e=>_.push(e.events.on("select-changed",f)))),f()};return b(),o.push(e.onManipulatorsChanged(b),p((()=>n(_)))),n(o)}(e,r.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:r.visualElement,remove:()=>n(o).remove()}}function di(e){return s(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const mi=f();function gi(e){const{view:t,graphic:i}=e,a=new ii({graphic:i}),r=[],o=function(e,t,i){const{view:a,graphic:r}=e,o=new dt({view:a,geometry:yi(r)?r.geometry:null,elevationInfo:Xe(r),attached:!1});return function(e,t,i,a){const r=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:r,graphic:o}=e;let n=null;const l=()=>{s(n)&&(n.remove(),n=null),i.isDraped&&yi(o)&&(n=function(e,t,i){const a=e.elevationProvider.spatialReference;le(t,vi,a);const s=vi[0],r=vi[1];return e.elevationProvider.on("elevation-change",(e=>{oe(e.extent,s,r)&&i()}))}(r,o.geometry,(()=>{t.geometry=o.geometry})))},h=()=>{l(),t.geometry=yi(o)?o.geometry:null};a.push(i.on("changed",h),p((()=>n))),h()})(e,t,i,a),ei.visualElements.pointGraphics.outline.apply(t),a.push(W(i,"displaying",r))}(e,o,t,i),i.push(l(o)),o}(e,a,r);return function(e,t,i,a){const{view:s,graphic:r}=e,o=new ut({view:s,extensionType:ei.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});ei.visualElements.zVerticalLine.apply(o);const n=new yt({view:s,intersectsLineInfinite:!0,attached:!1});ei.visualElements.pointGraphics.shadowStyle.apply(n);const p=y(ei.visualElements.heightPlaneAngleCutoff),h=new yt({view:s,attached:!1,angleCutoff:p});ei.visualElements.heightPlane.apply(h);const c=Xe(e.graphic),u=Ce.fromElevationInfo(c),d="on-the-ground"===c.mode||!c.offset&&"absolute-height"!==c.mode,m=new ci;let g=1,v=1;const M=()=>{m.update(e);const i=d&&(t.isDraped||!yi(r)||!r.geometry.hasZ);let l=!0;if(!i&&yi(r)){const e=r.geometry,t=ke(r.geometry,s.elevationProvider,u,s.renderCoordsHelper);E(vi,e.x,e.y,t),ne(vi,e.spatialReference,vi,s.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(vi),n.intersectsWorldUpAtLocation=vi}else l=!1;const p=2&m.grabbingState?ei.visualElements.laserlineAlphaMultiplier:1;p!==g&&(g=p,ei.visualElements.heightPlane.apply(h,p));const c=je(Mi);!i&&t.displaying&&a.calculateMapBounds(c)&&ne(xe(c,vi),s.spatialReference,vi,s.renderCoordsHelper.spatialReference)?(h.heightManifoldTarget=vi,h.attached=!0):h.attached=!1;const y=4&m.grabbingState?ei.visualElements.laserlineAlphaMultiplier:1;y!==v&&(v=y,ei.visualElements.pointGraphics.shadowStyle.apply(n,y));const M=l&&t.displaying&&!i;n.attached=M,o.attached=M};i.push(t.watch(["displaying","isDraped"],M),t.on("changed",M)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",M))})),i.push(l(n)),i.push(l(o)),i.push(l(h)),M()}(e,a,r,o),r.push(t.trackGraphicState(a)),{visualElement:o,remove(){n(r).remove()}}}function yi(e){return s(e.geometry)&&"point"===e.geometry.type}const vi=f(),Mi=we();function fi(e){switch(r(e.graphic.geometry).type){case"point":return gi(e);case"polygon":case"polyline":return ui(e);default:return null}}const _i=[1,.5,0],bi=Math.ceil(70/3*2),Si=5*Math.PI/12,wi=1*Math.PI/3;class ji{constructor(){this._available=!0}set location(e){this.forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this.forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this.forEachManipulator3D((t=>t.elevationInfo=e))}get available(){return this._available}set available(e){this._available=e,this.forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof Et&&e(t,i)}))}}function xi(e,t,i){const a=e.graphic,s=(e,i)=>t({action:e,graphic:a,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{const r=t.next((e=>("start"===e.action&&s("start",e),e))).next(Ke(a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&s("update",e);break;case"end":s("end",e)}return e}));return i.next($e(a)).next((()=>{s("end",{screenDeltaX:0,screenDeltaY:0})})),r}))}function Ei(e){if(i(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=("polyline"===e.type?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const a=t[0],s=t[1];return Math.atan2(s[1]-a[1],s[0]-a[0])}class Di extends ji{constructor(e){super(),this._handles=new Y,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new m,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){this._arrowManipulatorInfos.map((({manipulator:t})=>e(t,1)))}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=Xe(a),o=r(a.geometry).spatialReference;return xi(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),s,o,a)))}createDragPipeline(e,t,i,a){return n(this._arrowManipulatorInfos.map((({manipulator:s},r)=>et(s,((s,o,n,l,p)=>{const h=o.next((e=>({...e,manipulatorType:1}))).next(tt(this._view,s.elevationAlignedLocation)).next(_t(this._view,s.elevationAlignedLocation,t,i,a)).next(it(s.location,this.angle+(r+1)*Math.PI*.5)).next(at());e(s,h,n,l,p)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const a=this._radius/70,s=54*a,r=Math.sqrt(s*s*3/4),o=Ve.createExtrudedTriangle(r,s/2,s/2,.02);Ve.transformInPlace(o,Q(Oe.get(),E(Ge.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:2},{geometry:o,material:this._transparentMaterial,stateMask:1}],e.radius=r/3*2*1.2;const n=J(Oe.get());K(n,i*Math.PI/2);const l=J(Oe.get());Q(l,E(Ge.get(),0,100*a,0)),$(t,n,l)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=J(Oe.get());ee(t,t,e,_(0,0,1));const i=te(Oe.get(),E(Ge.get(),this.displayScale,this.displayScale,this.displayScale)),a=J(Oe.get());$(a,i,t);for(const e of this._arrowManipulatorInfos){const t=$(Oe.get(),a,e.transform);e.manipulator.modelTransform=t}}_createArrowManipulator(e){const t=new Et({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)}}),i={manipulator:t,transform:he()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(e=1){const t=L.toUnitRGBA(ai.main);return t[3]*=e,new Te({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class Gi{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new st,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&s(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if(s(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}snap(e){const t=s(this.view)?this.view.toMap(e,{exclude:[]}):null;return s(t)&&s(this.view)&&(t.z=qe(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this.snap(e.screenEnd);return s(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class Oi extends ji{constructor(e){super(),this._handles=new Y,this._snapToScene=new Gi,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=70,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t,i){const a=t.graphic,s=Xe(a),o=r(a.geometry).spatialReference;return xi(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),s,o,a)))}createDragPipeline(e,t,i,a){const s=this._view;return et(this._manipulator,((r,o,n,l,p)=>{const h=o.next(tt(s,r.elevationAlignedLocation)).next(_t(s,r.elevationAlignedLocation,t,i,a)).next(this._snapToScene.createDragEventPipelineStep(s,t),this._snapToScene.next).next((e=>({...e,manipulatorType:1}))).next(at());e(r,h,n,l,p)}))}_updateManipulatorTransform(){const e=te(Oe.get(),E(Ge.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new Et({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=Ve.createCylinderGeometry(.02,1,128,_(0,0,1),_(0,0,0)),t=te(he(),_(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/70*80}_createMaterial(e=1){const t=L.toUnitRGBA(ai.main);return t[3]*=e,new Te({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}get test(){return{discManipulator:this._manipulator}}}class Pi extends ji{constructor(e){super(),this._handles=new Y,this._radius=70,this.events=new m,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this.createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,0)}createGraphicDragPipeline(e,t,i){const a=r(t.graphic.geometry).spatialReference;return xi(t,i,(t=>this.createDragPipeline(((i,a,s,r,o)=>t(i,e(i,a,s,r,o),s)),a)))}createDragPipeline(e,t){const i=this._view;return et(this._manipulator,((a,s,r,o,n)=>{const l=s.next((e=>({...e,manipulatorType:0}))).next(bt(i,a.renderLocation,t)).next(at());e(a,l,r,o,n)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}updateManipulator(){const e=this._radius/70,t=ei.zManipulator.height*e,i=ei.zManipulator.coneHeight*e,a=ei.zManipulator.coneWidth*e,s=ei.zManipulator.width*e,r=[_(0,0,0),_(0,0,t)],o=Ve.createTubeGeometry(r,s/2,16,!1),n=Ve.createConeGeometry(i,a/2,16,!1),l=[_(0,0,0),_(0,0,t+i)],p=(e=>{const i=he();if(ie(i,i,[0,0,t]),ae(i,i,Math.PI/2),e){const t=1+2*e/a;se(i,i,[t,t,t])}return i})(0),h=(e,t)=>{const i=q(ei.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,ei.zManipulator.color.a*e]},c=Dt(h(1,.25),1),u=Dt(h(1,0),1),d=Dt(h(.7,0),ei.zManipulator.renderOccluded),m=Dt(h(.85,0),ei.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:n,transform:p,material:c,stateMask:1},{geometry:o,material:c,stateMask:1},{geometry:n,transform:p,material:u,stateMask:2},{geometry:o,material:u,stateMask:2},{geometry:n,transform:p,material:d,stateMask:1},{geometry:o,material:d,stateMask:1},{geometry:n,transform:p,material:m,stateMask:2},{geometry:o,material:m,stateMask:2}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}createManipulator(){const e=new Et({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=Ri;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=O(t.eye,i),s=t.computeRenderPixelSizeAtDist(a),r=P(Ai,i,t.eye);R(r,r);const o=Ii;this._view.renderCoordsHelper.worldUpAtPosition(Ri,o);const n=Math.abs(A(r,o)),l=I(Ai,r,o),p=I(Ai,l,o),h=v(n,.01,1),c=1-Math.sqrt(1-h*h)/h/t.fullWidth,u=this._radius/70,d=ei.zManipulator.width*u;G(p,R(p,p),(1/c-1)*a+s*d),e[12]-=Ai[0],e[13]-=Ai[1],e[14]-=Ai[2]},this._manipulator=e,this.updateManipulator()}}const Ri=f(),Ai=f(),Ii=f();class Vi extends ji{constructor(e){super(),this._handles=new Y,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:s}=e;this._view=i,this.xyManipulation=new Oi({tool:t,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new Di({tool:t,view:i,radius:s}),this.zManipulation=new Pi({tool:t,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t,i){return n([this.xyManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,i),this.xyAxisManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,i),this.zManipulation.createGraphicDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),t,i)])}createDragPipeline(e,t,i,a){return n([this.xyManipulation.createDragPipeline(((t,i,a,s,r)=>e(0,t,i,a,s,r)),t,i,a),this.xyAxisManipulation.createDragPipeline(((t,i,a,s,r)=>e(1,t,i,a,s,r)),t,i,a),this.zManipulation.createDragPipeline(((t,i,a,s,r)=>e(2,t,i,a,s,r)),i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,1))),this.xyAxisManipulation.forEachManipulator((t=>e(t,1))),this.zManipulation.forEachManipulator((t=>e(t,0)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(t("esri-mobile"))return;const a=[];i.forEachManipulator((e=>a.push(e))),e.forEachManipulator((e=>a.push(e)));const r=()=>{const t=[];this.xyAxisVisible?s(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(Ti),this._handles.add(t,Ti)};for(const e of a)this._handles.add(e.events.on("focus-changed",r));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",r)),r()}updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=s(e)&&"point-3d"===e.type&&e.symbolLayers;return!!t&&t.length>0&&t.some((e=>"icon"===e.type))?bi:70}}const Ti="disable-xy-axis-display";class Ci extends ji{constructor(e){super(),this._handles=new Y,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,1)}createGraphicDragPipeline(e){return xi(this._graphicState,e,(e=>this.createDragPipeline(e)))}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=s(i.geometry)?i.geometry.spatialReference:null;return et(this._manipulator,((s,r,o,n,l)=>{const p=r.next(St(l,t,i,a)).next(rt()).next(at());e(s,p,o,n,l)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new ft({graphic:t,view:e,selectable:!0,cursor:"move"})}}class ki{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class zi{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class Ui{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let Hi=class extends(m.EventedMixin(Je)){constructor(e){super(e),this.graphics=new g,this.enableZ=!0,this.type="move-3d",this._toolHandles=new Y,this._handles=new Y,this.snappingPipeline=new mt}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators()}destroy(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}reset(){}_refreshManipulators(){this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===At(e))).map((e=>new Li(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))}createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ci({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this._handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this._handles.add(t.manipulationXY.createDragPipeline(((t,i,a,s)=>this.buildDragEventPipeline(e,0,t,i,a,s))))}this.createMoveManipulation(e)}createMoveManipulation(e){const t=new Vi({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Vi.radiusForSymbol(e[0].graphic.symbol):70});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this._handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const t of e)this._handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const a=e[e.length-1];this._handles.add(a.state.on("changed",(()=>this.updateMoveManipulationAngle(a)))),this._handles.add(t.createDragPipeline(((t,i,a,s,r)=>this.buildDragEventPipeline(e,t,i,a,s,r)),Xe(a.graphic),r(a.graphic.geometry).spatialReference,a.graphic)),this.updateMoveManipulationAngle(a)}createVisualElements(e){for(const t of e){const i=t.graphic,a=fi({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>h()});t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof ti&&this._handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this._handles.add(a)}}updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>Ei(e.graphic.geometry)}updateMoveManipulation(e){const t=Ee(0,0,0,this.view.spatialReference);let i=0,a=!1;const r=this._moveManipulation;for(const r of e){if(!r.state.displaying)continue;const e=r.state.graphic;this.enableZ&&Vt(e)&&(a=!0);const o=r.geometryRepresentation instanceof ti&&!r.state.isDraped?r.geometryRepresentation.attachmentOrigin:Gt(this.view,e);s(o)&&(t.x+=o.x,t.y+=o.y,t.z+=o.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,r.location=t,r.xyManipulation.available=!0,r.xyAxisManipulation.available=!0,r.zManipulation.available=a):r.available=!1}buildDragEventPipeline(e,t,i,a,s,r){const o=[],n=[];let l=null,p=null;const h=()=>{for(const e of o)e.dragging=!1;o.length=0,n.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(1===e.length&&0===t){const t=e[0].graphic;a=this.buildSnappingPipelineSteps(t,Xe(t),a,s,r)}const c=a.next((t=>{if("start"===t.action){o.length=0,n.length=0;for(const t of e)t.dragging||!t.manipulationXY.hasManipulator(i)&&t.manipulationXY.grabbing||(o.push(t),n.push(t.graphic),t.dragging=!0);if(0!==n.length&&(this._moveManipulation.interactive=!1,l=ot(n),p=nt(n),this.emit("graphic-move-start",new ki(n)),this.destroyed))return null}return 0!==n.length?t:null})).next((e=>l(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,s=i.y-t.y;if(this.emit("graphic-move",new zi(a,s,n)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Ui(n)),this.destroyed)return null;h()}}));return s.next((e=>p(e))).next((()=>{if(this.emit("graphic-move-stop",new Ui(n)),this.destroyed)return null;h()})),c}buildSnappingPipelineSteps(e,t,a,s,r){const o=e.geometry;if(i(o)||"point"!==o.type)return a;const n=new He({elevationInfo:t,pointer:r,geometry:new Le(Qe.fromGeometry(o,this.view.viewingMode),"point"),visualizer:new gt,excludeFeature:e}),l=this.snappingManager;return a.next((t=>{const i=o.clone();i.z=We(this.view,i,Xe(e),{mode:"absolute-height",offset:0});return{...t,snapOrigin:n.coordinateHelper.fromPoint(i)}})).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:n,snappingManager:l,cancel:s}),this.snappingPipeline.next)}};e([c({constructOnly:!0,nonNullable:!0})],Hi.prototype,"view",void 0),e([c({readOnly:!0})],Hi.prototype,"graphics",void 0),e([c({constructOnly:!0,nonNullable:!0})],Hi.prototype,"enableZ",void 0),e([c({constructOnly:!0})],Hi.prototype,"snappingManager",void 0),e([c({readOnly:!0})],Hi.prototype,"type",void 0),Hi=e([d("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Hi);class Li{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new ii({graphic:e})}get graphic(){return this.state.graphic}}let Bi=class extends m.EventedAccessor{constructor(e){super(e),this._vertexManipulatorMaterial=Dt(ei.colorToVec4(ei.reshapeManipulators.vertex.color),ei.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Ot(ei.colorToVec4(ei.reshapeManipulators.vertex.outlineColor),ei.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Ot(ei.colorToVec4(ei.reshapeManipulators.vertex.hoverOutlineColor),ei.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Dt(ei.colorToVec4(ei.reshapeManipulators.edge.color),ei.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Ot(ei.colorToVec4(ei.reshapeManipulators.edge.outlineColor),ei.reshapeManipulators.edge.renderOccluded),this._selectedManipulatorMaterial=Dt(ei.colorToVec4(ei.reshapeManipulators.selected.color),ei.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Ot(ei.colorToVec4(ei.reshapeManipulators.selected.outlineColor),ei.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Ot(ei.colorToVec4(ei.reshapeManipulators.selected.hoverOutlineColor),ei.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._handles=new Y,this._manipulatorHandles=new Y,this._manipulatorInfos=[],this._reshapeHelper=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new mt,this._snappingPipelineHandle=new mt,this._vertexLaserLineVisualElement=null}initialize(){const e=new ii({graphic:this.graphic});this._graphicState=e,this._handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._clear(),this._handles.destroy()}get inputGeometry(){return s(this._reshapeHelper)?this._reshapeHelper.geometry:null}set inputGeometry(e){this._recreateManipulators(e)}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZ(){return this.tool.enableZ}get enableMoveGraphic(){return this.tool.enableMoveGraphic}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_clear(){this._moveManipulation=o(this._moveManipulation),this._graphicMoveManipulation=o(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._reshapeHelper=o(this._reshapeHelper),this._numGrabbing=0,this._numDragging=0}_recreateManipulators(e=this.inputGeometry){if(this._clear(),i(e))return;o(this._reshapeHelper),this._reshapeHelper=new Wi(Qe.fromGeometry(e,this.view.viewingMode),e.type);const t=Xe(this.graphic);for(const e of this._reshapeHelper.editGeometry.components){for(const i of e.vertices)this._createPerVertexManipulator(i,t);for(const i of e.edges)this._createPerVertexManipulator(i,t)}this._createGraphicMoveManipulators(t)}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;const i=[],a=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),s=1===e&&a,o=r(this._reshapeHelper);for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&(e.manipulator.grabbing||s&&!e.manipulator.selected||(r(o).moveVertices([e.handle],t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),i.push(e.handle.pos),this._updateManipulatorPosition(e)));if(0===i.length)return;let n=0;for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&n++;this.outputGeometry=o.geometry;if(i.length===n){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}}isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)Zi(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const t=e.mapDeltaX,i=e.mapDeltaY,a=e.mapDeltaZ;if(!t&&!i&&!a)return;const s=[];for(const t of this._manipulatorInfos)Zi(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&s.push(t);const o=r(this._reshapeHelper);for(const e of s)o.moveVertices([e.handle],t,i,a);this.outputGeometry=o.geometry;for(const e of s)this._updateManipulatorPosition(e);this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){this._graphicMoveManipulation=new Ci({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic?this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,t,i)=>{t.next((e=>this._trackNumDragging(e))).next((e=>{this._perGraphicManipulatorDragAction(0,e)})),i.next(this._cancelDragOperation())}))):this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null})),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()}))]))),this._moveManipulation=new Vi({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Vt(this.graphic),snapToScene:!1,radius:Vi.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this._handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=r(this.graphic.geometry).spatialReference;this._handles.add([this._moveManipulation.createDragPipeline(((t,i,a,s,o)=>{const n=a.next((e=>this._trackNumDragging(e))).next((e=>{const t=this._manipulatorInfos.filter((e=>Zi(e)&&e.manipulator.selected));return 1===e.manipulatorType&&1===t.length?{...e,info:t[0],snapOrigin:t[0].handle.pos}:{...e,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:e=>!!e.info,cancel:s,snappingManager:this.tool.snappingManager,snappingContext:new He({geometry:r(this._reshapeHelper),elevationInfo:e,pointer:o,excludeFeature:this.graphic,visualizer:new gt})}),this._snappingPipelineHandle.next).next(rt()).next((e=>(this._perGraphicManipulatorDragAction(1,e),e)));return s.next(this._cancelDragOperation()),n}),e,t,this.graphic),W(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),W(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this._handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this._handles.remove(e)}))]),this._updateMoveManipulationPosition();const i=fi({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){s(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});this._outlineVisualElement=i.visualElement instanceof ti?i.visualElement:null,s(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(i)}_createPerVertexManipulator(e,t=Xe(this.graphic)){if(i(this._vertexManipulatorGeometry)||i(this._vertexManipulatorOutlineGeometry)){const e=ei.reshapeManipulators.vertex,t=e.size/2,i=t+e.collisionPadding,a=t/i;this._vertexManipulatorGeometry=Ve.createSphereGeometry(a,16,16);const s=(t+e.outlineSize)/i;this._vertexManipulatorOutlineGeometry=Ve.createSphereGeometry(s,16,16)}if(i(this._edgeManipulatorGeometry)||i(this._edgeManipulatorOutlineGeometry)){const e=ei.reshapeManipulators.edge,t=e.size/2,i=t+e.collisionPadding,a=t/i;this._edgeManipulatorGeometry=Ve.createSphereGeometry(a,16,16);const s=(t+e.outlineSize)/i;this._edgeManipulatorOutlineGeometry=Ve.createSphereGeometry(s,16,16)}const a=new Et({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|qi.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|qi.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|qi.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|qi.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|qi.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|qi.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|qi.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const s="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),"edge"===s.type){const e=this._getManipulatorInfoFromHandle(s.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s))),t=this._getManipulatorInfoFromHandle(s.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s)));s.locationUpdateHandle=n([e,t]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const o=et(a,((e,i,a,o)=>{i.next((e=>this._trackNumDragging(e))).next((e=>{if(Ni(s)){const t=this._splitEdgeManipulator(s);return{...e,info:t,snapOrigin:t.handle.pos}}return{...e,info:s,snapOrigin:s.handle.pos}})).next(tt(this.view,e.elevationAlignedLocation)).next(wt(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this.isMultiVertexSelection(),cancel:a,snappingManager:this.tool.snappingManager,snappingContext:new He({geometry:r(this._reshapeHelper),elevationInfo:t,pointer:o,excludeFeature:this.graphic,visualizer:new gt})}),this._snappingPipeline.next).next(rt()).next((e=>{this._perVertexManipulatorDragAction(e)})),a.next(this._cancelDragOperation())}));return this._manipulatorHandles.add(o,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,s))),a.events.on("select-changed",(()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),a}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(){const e=s(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return()=>{switch(this._numDragging--,this.inputGeometry=e,this.outputGeometry=e,s(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=qi.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=ei.reshapeManipulators.vertex.size/2+ei.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i;break;case"edge":e.state=qi.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=ei.reshapeManipulators.edge.size/2+ei.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"===i.mode?i:{mode:"absolute-height",offset:0}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=r(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.editGeometry.coordinateHelper.toPoint(e.handle.pos,Yi),e.manipulator.grabbing&&s(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(s(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const s=i.location,r=a.location,o=.5,n=s.x+o*(r.x-s.x),l=s.y+o*(r.y-s.y),p=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=Ee(n,l,p,t.geometry.spatialReference)}else V(Xi,i.renderLocation,a.renderLocation,.5),e.manipulator.renderLocation=Xi}}_splitEdgeManipulator(e){const t=r(this._reshapeHelper),i=r(t.splitEdge(e.handle,.5).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const a=e;a.handle=i,a.type="vertex";const s=Xe(this.graphic);this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s),i.left&&this._createPerVertexManipulator(i.left),i.right&&this._createPerVertexManipulator(i.right),this.outputGeometry=t.geometry,this._updateManipulatorPosition(a),this._updateSelection(e.manipulator);const o=this._updateEventState(2),n=t.editGeometry.coordinateHelper.toArray(a.handle.pos),l=t.editGeometry.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:n,componentIndex:l,vertexIndex:r(i.index)}],added:n}),o&&this._updateEventState(0),a}_updateMoveManipulationPosition(){const e=Ge.get();E(e,0,0,0);let t=0,a=!1,o=null,n=null;for(const s of this._manipulatorInfos)Zi(s)&&(s.manipulator.selected?(t++,D(e,e,s.manipulator.renderLocation),i(o)||s.selectedIndex>o.selectedIndex?(n=o,o=s):(i(n)||s.selectedIndex>n.selectedIndex)&&(n=s)):a=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Vt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Vt(this.graphic)}if(0!==t){let e=0;if(s(o)){const t=o.handle.pos,i=s(n)?n.handle.pos:o.handle.left&&o.handle.left.left?o.handle.left.left.pos:null,a=!s(n)&&o.handle.right&&o.handle.right.right?o.handle.right.right.pos:null;i&&a?this._moveManipulation.xyAxisManipulation.available=!1:i?e=Fi(i,t):a&&(e=Fi(t,a))}this._moveManipulation.angle=e,this._moveManipulation.radius=bi}else this._moveManipulation.angleDeferred=()=>Ei(r(this.graphic.geometry)),this._moveManipulation.radius=Vi.radiusForSymbol(this.graphic.symbol);0!==t&&a?(G(e,e,1/t),Yi.spatialReference=r(this._reshapeHelper).geometry.spatialReference,Yi.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,Yi),this._moveManipulation.elevationAlignedLocation=Yi):s(this._outlineVisualElement)&&!this._graphicState.isDraped&&s(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Pt(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=r(this._reshapeHelper);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.right));const e=r(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createPerVertexManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.editGeometry.components.indexOf(e.component);return{coordinates:i.editGeometry.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:r(e.index)}}));this.outputGeometry=i.geometry;const a=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),Ni(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function Fi(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Zi(e){return"vertex"===e.handle.type}function Ni(e){return"edge"===e.handle.type}e([c({constructOnly:!0})],Bi.prototype,"tool",void 0),e([c()],Bi.prototype,"inputGeometry",null),e([c()],Bi.prototype,"outputGeometry",void 0),Bi=e([d("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Bi);const Yi=Ee(0,0,null,null),Xi=f();var qi;!function(e){e.Vertex=16,e.Edge=32}(qi||(qi={}));class Wi extends Le{constructor(e,t){super(e,t),this.type=t,this._geometry=null}get geometry(){if(this._dirty){switch(this.type){case"polyline":this._geometry=this.editGeometry.toPolyline();break;case"polygon":this._geometry=this.editGeometry.toPolygon()}this._dirty=!1}return this._geometry}}let Qi=class extends(m.EventedMixin(Je)){constructor(e){super(e),this._handles=new Y,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZ=!0,this.enableMoveGraphic=!0,this.type="reshape-3d",this.snappingManager=null}destroy(){this._handles.removeAll(),this._reshapeOperation=o(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get selectionManagementDisabled(){return!0}_updateGeometry(){const e=this.graphic.geometry;0!==It(this.graphic)||!s(e)||"polygon"!==e.type&&"polyline"!==e.type?this._reshapeOperation.inputGeometry=null:this._reshapeOperation.inputGeometry=e.clone()}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==It(this.graphic))return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_onReshapeGeometryChanged(){i(this.graphic)||(this._internalGeometryUpdate=!0,this.graphic.geometry=this._reshapeOperation.outputGeometry.clone(),this._internalGeometryUpdate=!1)}initialize(){this._reshapeOperation=new Bi({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(e=>this.emit("immediate-click",e))),W(this,"graphic",(()=>{this._updateGraphic()}),!0)])}beforeUndo(){s(this.snappingManager)&&this.snappingManager.doneSnapping()}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};var Ji;e([c({constructOnly:!0,nonNullable:!0})],Qi.prototype,"view",void 0),e([c({constructOnly:!0})],Qi.prototype,"graphic",void 0),e([c({constructOnly:!0,nonNullable:!0})],Qi.prototype,"enableZ",void 0),e([c({constructOnly:!0,nonNullable:!0})],Qi.prototype,"enableMoveGraphic",void 0),e([c({readOnly:!0})],Qi.prototype,"type",void 0),e([c({constructOnly:!0})],Qi.prototype,"snappingManager",void 0),Qi=e([d("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Qi),function(e){e.ScaleIn=32,e.ScaleOut=64,e.RotateLeft=128,e.RotateRight=256,e.Unlocked=1024,e.DelayedFocused=2048,e.TouchInput=32768}(Ji||(Ji={}));class Ki{constructor(e){this.mode=null,this._handles=new Y,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new m,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>s(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._scaleRotateDragData.scale:1,this.tool=e.tool,this.mode=e.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}destroy(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=u({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}forEachManipulator(e){e(this.ringManipulator,4)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,a=et(e,((e,a,r)=>{this._scaleRotateDragData=null;const o=function(e,t){const a=e.allLayerViews.find((e=>e.layer===t.layer));if(i(t.symbol))return null;const s=t.symbol;return{symbolLayers:s.symbolLayers.map((e=>{let t=null,i=null;return"object"===e.type&&(t=e.heading),i=a.getSymbolLayerSize(s,e),{heading:t,size:i}})).toArray()}}(this.tool.view,t);if(i(o))return this.updateDragState(),null;const n={mode:"none",origin:S(e.renderLocation),angle:0,startAngle:this.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:o};this._scaleRotateDragData=n,this.updateDragState();const l=Ge.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,l),a.next(jt(this.tool.view,Re.fromPositionAndNormal(e.renderLocation,l))).next((e=>{const i=Re.normal(e.plane),a=Rt(e.renderStart,e.renderEnd,n.origin,i),r=H.shortestSignedDiff(n.angle,a);n.angleDir=v(n.angleDir+r,-.3,.3),n.angle=a;const o=function(e,t){const i=P(Ge.get(),t.renderStart,e.origin),a=P(Ge.get(),t.renderEnd,e.origin),s=T(i),r=T(a);if(0===s)return 0;return r/s}(n,e),l=o-n.scale;if(n.scaleDir=v(n.scaleDir+l,-.2,.2),n.scale=o,this.onScaleChanged(),"none"===n.mode){const i=this.mode||function(e,t,i,a){const{renderStart:s,renderEnd:r}=e,o=$i(s,a,Ge.get()),n=$i(r,a,Ge.get());if(C(o,n)<100)return null;const l=P(Ge.get(),s,i),p=I(Ge.get(),l,t),h=s,c=D(Ge.get(),h,p),u=$i(i,a,Ge.get()),d=o,m=$i(c,a,Ge.get()),g=P(Ge.get(),m,d),y=P(Ge.get(),o,u),v=Ae.wrap(d,g),M=Ae.wrap(u,y);if(Ae.distance2(v,n)<Ae.distance2(M,n))return"rotate";return"scale"}(e,e.plane,n.origin,this.tool.view.state.camera);if(s(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:M(n.angle)});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:n.scale,yScale:n.scale})}n.mode=i}}if(this.updateDragState(),s(t.symbol)){const e=t.symbol.clone();let i=0,a=1;switch(n.mode){default:case"none":break;case"scale":a=n.scale;break;case"rotate":i=n.angle}this.applySymbolData(e,n.startSymbolData,i,a),t.symbol=e,this.updateManipulatorTransform()}switch(e.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:M(n.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:n.scale,yScale:n.scale})}break;case"end":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:M(n.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:n.scale,yScale:n.scale});break;default:case"none":}}"end"===e.action&&(this.startAnimation(ea(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),r.next(lt(t)).next((()=>{if(s(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:M(this._scaleRotateDragData.startAngle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(ea(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null}}))}));this._handles.add(a),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:e=>(i+=e,!a()||i>200?1:0),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),W(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e)),this.tool.graphicState.on("changed",(()=>Pt(this.tool.view,this.ringManipulator,t)))]),Pt(this.tool.view,this.ringManipulator,t)}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(Ji.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(Ji.Unlocked,!(s(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),s(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(Ji.ScaleIn|Ji.ScaleOut,!1),this.ringManipulator.updateStateEnabled(Ji.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(Ji.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(Ji.RotateLeft|Ji.RotateRight,!1),this.ringManipulator.updateStateEnabled(Ji.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(Ji.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(Ji.ScaleIn|Ji.ScaleOut|Ji.RotateLeft|Ji.RotateRight,!1)}updateManipulatorTransform(){const e=J(Oe.get()),t=this.tool.symbolRotationAngle;ee(e,e,t,_(0,0,1));const i=this.getScale(),a=te(Oe.get(),E(Ge.get(),i,i,i)),s=J(Oe.get());$(s,a,e),this.ringManipulator.modelTransform=s}createRingManipulator(){const e=(e,t,i)=>{const a=[],s=Math.ceil(128*(t-e)/(2*Math.PI));for(let r=0;r<s+1;r++){const o=e+r*(t-e)/s;a.push(_(i*Math.cos(o),i*Math.sin(o),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>Ve.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),a=t(160),s=i(a,24),r={left:[],right:[]},o=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-Si,n=a+s,l=a+Math.PI/2-s,p=e(n,l,190),h=i(p,9);o.push(p),o.push(e(n,l,201)),r.left.push(h),r.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=he();if(t){se(i,i,[1,-1,1]),ee(i,i,-n,[0,0,1]);const e=Math.round(.2*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}else{ee(i,i,l,[0,0,1]);const e=Math.round(.8*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}const a=Ve.createExtrudedTriangle(60,0,23,.5);Ve.transformInPlace(a,i),(t?r.left:r.right).push(a)}}const n=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-wi,r=a+s,o=a+Math.PI/2-s,l=e(r,o,213);n.push(i(l,9))}const l=t(190),p=t(213),h=i(l,9),c=i(p,9),u=t(130),d=t(107),m=i(u,9),g=i(d,9),y=this.createMaterial(),v=this.createMaterial(.66),M=this.createMaterial(.5),f=this.createMaterial(.33);let b=[{geometry:s,material:y,stateMask:Ji.DelayedFocused},{geometry:s,material:M,stateMask:0}];this.mode&&"scale"!==this.mode||(b=b.concat([{geometry:n,material:y,stateMask:Ji.DelayedFocused|Ji.Unlocked},{geometry:h,material:v,stateMask:Ji.DelayedFocused|Ji.ScaleIn},{geometry:c,material:f,stateMask:Ji.DelayedFocused|Ji.ScaleIn},{geometry:m,material:v,stateMask:Ji.DelayedFocused|Ji.ScaleOut},{geometry:g,material:f,stateMask:Ji.DelayedFocused|Ji.ScaleOut}])),this.mode&&"rotate"!==this.mode||(b=b.concat([{geometry:r.right,material:y,stateMask:Ji.DelayedFocused|Ji.Unlocked},{geometry:r.left,material:y,stateMask:Ji.DelayedFocused|Ji.RotateLeft},{geometry:r.right,material:y,stateMask:Ji.DelayedFocused|Ji.RotateRight}]));const S=[a,...o];return new Et({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:Xe(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:S,direction:_(0,0,1)}})}createMaterial(e=1){const t=[..._i,e];return new Te({color:t,transparent:1!==e,cullFace:2,renderOccluded:2})}applySymbolData(e,t,i,a){e.symbolLayers.forEach(((e,r)=>{const{heading:o,size:n}=t.symbolLayers[r];"object"===e.type&&(e.heading=(s(o)?o:0)-j(i),s(n)&&"width"in n&&(n.width=this.enforceNonZeroSize(n.width),n.height=this.enforceNonZeroSize(n.height),n.depth=this.enforceNonZeroSize(n.depth),e.width=n.width*a,e.depth=n.depth*a,e.height=n.height*a))}))}enforceNonZeroSize(e){return e||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)}get test(){return{ringManipulator:this.ringManipulator}}}function $i(e,t,i){const a=t.projectToRenderScreen(e,B(ta)),s=t.renderToScreen(a,ia);return E(i,s[0],s[1],0)}function ea(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?1:0),destroy:()=>{e.getScale=i,t()}}}const ta=f(),ia=F();let aa=class extends(m.EventedMixin(Je)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.handles=new Y,this.scaleRotate=null,this.snappingPipeline=new mt}initialize(){this.graphicState=new ii({graphic:this.graphic}),this.moveManipulation=new Vi({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Vt(this.graphic),radius:Vi.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>e.stopPropagation()))))),this.moveManipulation.elevationInfo=Xe(this.graphic);const e=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((t,i,a,r,o)=>(s(e)&&"point"===e.type&&0===t&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new He({elevationInfo:Xe(this.graphic),pointer:o,geometry:new Le(Qe.fromGeometry(e,this.view.viewingMode),"point"),visualizer:new gt,excludeFeature:this.graphic}),snappingManager:this.snappingManager,cancel:r}),this.snappingPipeline.next)),a)),this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:s}=e,r={graphic:i,dxScreen:a,dyScreen:s};switch(t){case"start":this.emit("graphic-translate-start",r);break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Ki({tool:this,mode:e}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([fi({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>h()}),this.graphic.watch("symbol",(()=>this.updateMoveAngle())),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()}forEachManipulator(e){this.moveManipulation.forEachManipulator(e),s(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&Vt(this.graphic)}))}destroy(){this.handles.destroy(),this.moveManipulation.destroy(),this.scaleRotate=o(this.scaleRotate),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get symbolRotationAngle(){const e=this.graphic.symbol;if(e){const t=e.symbolLayers.find((e=>"object"===e.type)),i=t&&t.heading||0;return x(-i)}return 0}reset(){}onDetach(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(i(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}updateMoveAngle(){"local"===this.view.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0}onGeometryChanged(){Pt(this.view,this.moveManipulation,this.graphic)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:s(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};e([c({constructOnly:!0,nonNullable:!0})],aa.prototype,"view",void 0),e([c({constructOnly:!0,nonNullable:!0})],aa.prototype,"graphic",void 0),e([c({constructOnly:!0,nonNullable:!0})],aa.prototype,"enableZ",void 0),e([c()],aa.prototype,"enableRotation",void 0),e([c()],aa.prototype,"enableScaling",void 0),e([c({value:!1})],aa.prototype,"snapToScene",null),e([c({constructOnly:!0})],aa.prototype,"snappingManager",void 0),e([c({readOnly:!0})],aa.prototype,"type",void 0),aa=e([d("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],aa);class sa{constructor(){this.lastDragEvent=null,this.next=new st,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&s(this.lastDragEvent)){const t={...this.lastDragEvent,action:"update"};e&&this.adjustScaleFactors(t),this.next.execute(t)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled&&this.adjustScaleFactors(e),e)}adjustScaleFactors(e){const t=Tt(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):0===e.handle.direction[0]?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-t:t,e.factor2=e.factor2<0?-t:t}get test(){return{adjustScaleFactors:e=>this.adjustScaleFactors(e)}}}function ra(e,t){return na(e,t,!1)}function oa(e,t){return na(e,t,!0)}function na(e,t,i){if(e instanceof Be){if(e.operation instanceof Fe)return function(e,t,i=!1){const a=i?-1:1,s=_(a*e.dx,a*e.dy,a*e.dz);D(t.origin,t.origin,s)}(e.operation,t,i),!0;if(e.operation instanceof Ze)return function(e,t,i=!1){const a=i?-e.angle:e.angle;k(t.basis1,t.basis1,w,a),k(t.basis2,t.basis2,w,a)}(e.operation,t,i),!0;if(e.operation instanceof Ne)return function(e,t,i=!1){const a=i?1/e.factor1:e.factor1,s=i?1/e.factor2:e.factor2;G(t.basis1,t.basis1,a),G(t.basis2,t.basis2,s),la(t.origin,e.origin,e.axis1,a),la(t.origin,e.origin,e.axis2,s)}(e.operation,t,i),!0}return!1}function la(e,t,i,a){const s=Pe.get(),r=ce(s,e,t),o=ue(s,i,de(i,r));me(e,e,o,a-1)}let pa=class extends(m.EventedMixin(Je)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new sa,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new Y,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=Ie.create(),this.mapBoundsStart=Ie.create(),this.displayBounds=Ie.create(),this.displayBoundsStart=Ie.create(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new ii({graphic:this.graphic});const e=this.graphic.geometry;this.reshapeHelper=new Wi(Qe.fromGeometry(e,this.view.viewingMode),e.type),this.graphicMoveManipulation=new Ci({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=Ct(this.view,0),this.moveZManipulator.state|=kt,this.handles.add(this.watch("enableZ",(()=>this.updateManipulatorAvailability(this.moveZManipulator,0)))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((e=>{const t=zt(this.view,e);return this.handles.add(this.watch("enableScaling",(()=>this.updateManipulatorAvailability(t,2)))),t.events.on("grab-changed",(e=>this._onResizeGrab(e))),this.handles.add(this._createResizeDragPipeline(t,e)),t})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=new Ue(Ut,{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&this.view._stage.add(this.rotateManipulatorTexture),this.rotateManipulator=Ht(this.view,this.rotateManipulatorTexture),this.handles.add(this.watch("enableRotation",(()=>this.updateManipulatorAvailability(this.rotateManipulator,3)))),this.rotateManipulator.events.on("grab-changed",(e=>{this._onRotateGrab(e)})),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this.calculateMapBounds(),this.updateDisplayBounds(this.mapBounds);const t=fi({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>h()});this.outlineVisualElement=t.visualElement instanceof ti?t.visualElement:null,s(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this.updateDisplayBounds(this.mapBounds)))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.graphicState.watch("displaying",(()=>this.updateAllManipulatorAvailability())),W(this.graphicState,"isDraped",(()=>this.graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.focus.watch("location",(()=>this.updateDisplayBounds(this.mapBounds))));const a=e=>{this.handles.add(e.events.on("grab-changed",(()=>{this.grabbing=e.grabbing,this.updateAllManipulatorAvailability()})))};this.forEachManipulator(a),this.graphicMoveManipulation.forEachManipulator(a);const r=(e,t)=>{this.handles.add(e.events.on("immediate-click",(e=>{1===t&&this.emit("immediate-click",{...e,graphic:this.graphic}),e.stopPropagation()})))};this.forEachManipulator(r),this.graphicMoveManipulation.forEachManipulator(r),this.onGeometryChanged(),this.updateAllManipulatorAvailability()}graphicDrapedChanged(){this.handles.remove(ha),this.updateDisplayBounds(this.mapBounds),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(e=>{s(this.attachmentOrigin)&&oe(e.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this.updateDisplayBounds(this.mapBounds)})),ha)}updateAllManipulatorAvailability(){this.forEachManipulator(((e,t)=>this.updateManipulatorAvailability(e,t)))}updateManipulatorAvailability(e,t){const i=this.graphicState.displaying,a=this.grabbing&&!e.grabbing;e.interactive=!a;const s=this.enableZ&&Vt(this.graphic);switch(t){case 3:e.available=i&&this.enableRotation;break;case 2:e.available=i&&(this.enableScaling||this.enableRotation||s),e.interactive=!a&&this.enableScaling,e.state=this.enableScaling?Lt:Bt;break;case 0:e.available=i&&s;break;default:e.available=i}}forEachManipulator(e){this.resizeManipulators.forEach((t=>e(t,2))),e(this.rotateManipulator,3),e(this.moveZManipulator,0)}destroy(){this.view._stage&&this.view._stage.remove(this.rotateManipulatorTexture),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.reshapeHelper.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}reset(){}onDetach(){this.mapBounds=null,this.displayBounds=null}onGeometryChanged(){this.updateDisplayBounds(this.mapBounds)}calculateMapBounds(){const e=this.graphic.geometry,t=this.reshapeHelper.editGeometry,i=t.components[0].edges[0],s=ce(Pe.get(),i.left.pos,i.right.pos);fe(s,s);const r=a(Gt(this.view,this.graphic),e.extent.center);let o=ua*this.view.pixelSizeAt(r);const n=this.view.spatialReference;n!==e.spatialReference&&(o*=X(n)/X(e.spatialReference)),function(e,t,i,a){a||(a=Ie.create());const s=ge(Pe.get(),e[1],-e[0]),r=ge(Pe.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=ge(Pe.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n=Pe.get();t.components.forEach((t=>t.vertices.forEach((t=>{const i=t.pos;ge(n,de(e,i),de(s,i)),ye(r,r,n),ve(o,o,n)}))));const l=1e-6,p=ge(Pe.get(),o[0]-r[0]<l?i/2:0,o[1]-r[1]<l?i/2:0);ce(r,r,p),Me(o,o,p),ue(a.basis1,e,(o[0]-r[0])/2),ue(a.basis2,s,(o[1]-r[1])/2),ge(a.origin,r[0]*e[0]+r[1]*s[0],r[0]*e[1]+r[1]*s[1]),Me(a.origin,a.origin,a.basis1),Me(a.origin,a.origin,a.basis2)}(s,t,o,this.mapBounds)}updateDisplayBounds(e){const t=this.graphic.geometry,i=s(this.outlineVisualElement)&&!this.graphicState.isDraped&&s(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Gt(this.view,this.graphic);this.attachmentOrigin=a(i,t.extent.center);const r=s(i)?i.z:ke(e.origin,this.view.elevationProvider,Ce.fromElevationInfo(Xe(this.graphic)),this.view.renderCoordsHelper),o=Ie.copy(e);E(o.origin,e.origin[0],e.origin[1],r),function(e,t,i,a=0,s){s||(s=Ie.create()),t.toRenderCoords(e.origin,i,s.origin);const r=Ge.get();D(r,e.origin,e.basis1),D(r,r,e.basis2),t.toRenderCoords(r,i,r);const o=Ge.get();D(o,e.origin,e.basis1),P(o,o,e.basis2),t.toRenderCoords(o,i,o);const n=Ge.get();P(n,e.origin,e.basis1),P(n,n,e.basis2),t.toRenderCoords(n,i,n);const l=Ge.get();P(l,e.origin,e.basis1),D(l,l,e.basis2),t.toRenderCoords(l,i,l);const p=V(Ge.get(),r,o,.5);P(p,p,s.origin);const h=V(Ge.get(),n,l,.5);P(h,s.origin,h),V(s.basis1,p,h,.5);const c=V(Ge.get(),l,r,.5);P(c,c,s.origin);const u=V(Ge.get(),o,n,.5);P(u,s.origin,u),V(s.basis2,c,u,.5);const d=I(Ge.get(),s.basis1,s.basis2),m=I(d,d,s.basis1);R(m,m),G(s.basis2,m,A(s.basis2,m)),G(s.basis1,s.basis1,1+a/T(s.basis1)),G(s.basis2,s.basis2,1+a/T(s.basis2)),Ie.updateUnboundedPlane(s)}(o,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin(),this.displayBounds),this.updateManipulators()}displayBoundsMargin(){const e=this.view.pointsOfInterest,t=e?e.focus.location:this.reshapeHelper.geometry.extent.center;return ca*this.view.pixelSizeAt(t)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((e,t,i)=>this.applyGraphicMoveSteps(t,i)))}_createMoveZDragPipeline(){const e=this.view,t=this.reshapeHelper.geometry.spatialReference;return et(this.moveZManipulator,((i,a,s)=>{const r=S(i.renderLocation),o=a.next(bt(e,r,t)).next(at());this.applyGraphicMoveSteps(o,s)}))}applyGraphicMoveSteps(e,t){const i=e.next((e=>("start"===e.action&&(this.inputState={type:"move"},Ie.copy(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY})),e))).next(rt()).next(this._moveDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,dxScreen:e.screenDeltaX,dyScreen:e.screenDeltaY};switch(e.action){case"start":case"update":(e.mapEnd.x-e.mapStart.x||e.mapEnd.y-e.mapStart.y||e.mapEnd.z-e.mapStart.z)&&this.emit("graphic-translate",t);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",t)}return e}));return t.next((()=>{s(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this.cancel()})),i}_moveDragUpdateGeometry(){return e=>{if(i(this.inputState)||"move"!==this.inputState.type)return e;const t=[];for(const e of this.reshapeHelper.editGeometry.components)t.push(...e.vertices);const a="start"===e.action?0:1;return ra(this.reshapeHelper.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a),this.mapBounds),this.graphic.geometry=this.reshapeHelper.geometry,e}}_onResizeGrab(e){if("start"!==e.action)return;const t=this._calculatePickRay(e.screenPoint);Re.intersectRay(this.displayBounds.plane,t,Ge.get())&&(Ie.copy(this.displayBounds,this.displayBoundsStart),Ie.copy(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin(),this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return et(e,((e,a,r)=>{i(this.inputState)||(a.next((e=>("start"===e.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),e))).next(jt(this.view,this.displayBoundsStart.plane)).next((e=>({...e,handle:t}))).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,xScale:e.factor1,yScale:e.factor2};switch(e.action){case"start":case"update":this.emit("graphic-scale",t);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",t)}return e})),r.next((()=>{s(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this.cancel()})))}))}_resizeDragRenderPlaneToFactors(){return e=>{const t=this.displayBoundsStart,i=e.handle.direction,a=this.displayBoundsMargin(),s=this.displayBoundsMarginStart,r=z(Ge.get(),t.origin);U(r,r,t.basis1,-i[0]),U(r,r,t.basis2,-i[1]);const o=P(Ge.get(),e.renderEnd,r),n=P(Ge.get(),e.renderStart,r),l=Tt(e.handle),p=Ft(t),h=Ft(this.displayBounds)/p,c=(e,t)=>{if(0===e)return 1;let i=T(t),r=.5*e*A(t,o)/i;const p=r<0?-1:1;if(l){r+=(i-.5*e*A(t,n)/i)*p*h}const c=i<1.5*s?1:da;return i=Math.max(i-s,da),p>0&&(r-=a),p*Math.max(p*(r/i),c)};return{...e,factor1:c(i[0],t.basis1),factor2:c(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=z(f(),this.mapBoundsStart.origin);U(t,t,this.mapBoundsStart.basis1,-e.handle.direction[0]),U(t,t,this.mapBoundsStart.basis2,-e.handle.direction[1]);const i=ge(De(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);fe(i,i);const a=[];for(const e of this.reshapeHelper.editGeometry.components)a.push(...e.vertices);const s="start"===e.action?0:1,r=this.reshapeHelper.scaleVertices(a,this.reshapeHelper.editGeometry.coordinateHelper.fromXYZ(t),i,e.factor1,e.factor2,s,1);return Ie.copy(this.mapBoundsStart,this.mapBounds),ra(r,this.mapBounds),this.graphic.geometry=this.reshapeHelper.geometry,e}}_onRotateGrab(e){if("start"!==e.action)return;const t=Zt(this.displayBounds,this.view.renderCoordsHelper,1,Re.create()),i=this._calculatePickRay(e.screenPoint);Re.intersectRay(t,i,Ge.get())&&(Ie.copy(this.displayBounds,this.displayBoundsStart),Ie.copy(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:t})}_createRotateDragPipeline(e){return et(e,((e,t,a)=>{const r=this.inputState;i(r)||(t.next((e=>("start"===e.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),e))).next(jt(this.view,r.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(r)).next(this._rotateDragUpdateGeometry()).next((e=>{const t={graphic:this.graphic,angle:M(e.rotateAngle)};switch(e.action){case"start":case"update":this.emit("graphic-rotate",t);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",t)}return e})),a.next((()=>{s(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this.cancel()})))}))}_rotateDragRenderPlaneToRotate(e){return t=>{const i=Re.normal(e.rotatePlane),a=Rt(t.renderStart,t.renderEnd,this.displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=z(f(),this.mapBoundsStart.origin),i=[];for(const e of this.reshapeHelper.editGeometry.components)i.push(...e.vertices);const a="start"===e.action?0:1,s=this.reshapeHelper.rotateVertices(i,this.reshapeHelper.editGeometry.coordinateHelper.fromXYZ(t),e.rotateAngle,a,1);return Ie.copy(this.mapBoundsStart,this.mapBounds),ra(s,this.mapBounds),this.graphic.geometry=this.reshapeHelper.geometry,e}}_calculatePickRay(e){const t=Ae.create(),i=Z(e);return Ae.fromScreen(this.view.state.camera,i,t),R(t.direction,t.direction),t}updateManipulators(){if(!this.visible)return;const e=Nt(this.displayBounds,Oe.get());Yt(this.rotateManipulator,e,this.displayBounds,this.view.renderCoordsHelper),this.updateZMoveHandle(this.moveZManipulator,e),this.resizeManipulators.forEach(((t,i)=>{Xt(t,this.resizeHandles[i],e,this.displayBounds)}))}updateZMoveHandle(e,t){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:P(Ge.get(),i.origin,i.basis1),edge:2},s=Oe.get();re(s,t,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}cancel(){const e=this.reshapeHelper.editGeometry.lastOperation;i(e)||(this.reshapeHelper.undo(),this.graphic.geometry=this.reshapeHelper.geometry,oa(e,this.mapBounds),this.updateDisplayBounds(this.mapBounds),this.inputState=null)}canUndo(){return this.reshapeHelper.canUndo}undo(){if(s(this.inputState))this.view.activeTool=null;else if(this.canUndo()){const e=this.reshapeHelper.undo();this.graphic.geometry=this.reshapeHelper.geometry,oa(r(e),this.mapBounds),this.updateDisplayBounds(this.mapBounds)}}canRedo(){return this.reshapeHelper.canRedo}redo(){if(this.canRedo()){const e=this.reshapeHelper.redo();this.graphic.geometry=this.reshapeHelper.geometry,ra(r(e),this.mapBounds),this.updateDisplayBounds(this.mapBounds)}}};e([c({constructOnly:!0,nonNullable:!0})],pa.prototype,"view",void 0),e([c({constructOnly:!0,nonNullable:!0})],pa.prototype,"graphic",void 0),e([c({constructOnly:!0,nonNullable:!0})],pa.prototype,"enableZ",void 0),e([c()],pa.prototype,"enableRotation",void 0),e([c()],pa.prototype,"enableScaling",void 0),e([c()],pa.prototype,"preserveAspectRatio",null),e([c()],pa.prototype,"grabbing",void 0),e([c()],pa.prototype,"inputState",void 0),e([c({readOnly:!0})],pa.prototype,"type",void 0),pa=e([d("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],pa);const ha="draped-elevation-changes",ca=10,ua=80,da=1e-6;export{ni as DrawGraphicTool,pa as ExtentTransformTool,Hi as GraphicMoveTool,Qi as GraphicReshapeTool,aa as GraphicTransformTool};
