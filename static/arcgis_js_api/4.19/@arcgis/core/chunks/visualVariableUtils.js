/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"./tslib.es6.js";import"./ArrayPool.js";import"../core/lang.js";import"./deprecate.js";import"./object.js";import"../kernel.js";import"../config.js";import{L as e,i as t,b as o}from"./Logger.js";import"./string.js";import"./metadata.js";import"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import{n as r}from"./compilerUtils.js";import"./ensureType.js";import"../core/accessorSupport/decorators/subclass.js";import"./Evented.js";import"../core/Collection.js";import"./collectionUtils.js";import"./JSONSupport.js";import"./Promise.js";import"./Loadable.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./writer.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";import"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../request.js";import"./assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"./mathUtils2.js";import"./colorUtils.js";import s from"../Color.js";import"./zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"./date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"./chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"./Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import"./screenUtils.js";import"./opacityUtils.js";import"./materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./utils.js";import"./Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"./Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"./Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"./urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols.js";import"./uid.js";import i from"../Graphic.js";import{i as a,b as n}from"./sizeVariableUtils.js";import"./unitUtils.js";import{m as l}from"./lengthUtils.js";const p=e.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),c=new i,m=Math.PI,u=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function j(e,o,r){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"color"===e.type))[0]:e;if(!i)return;if("esri.renderers.visualVariables.ColorVariable"!==i.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const a="number"==typeof o,n=a?null:o,l=n&&n.attributes;let c=a?o:null;const m=i.field,{ipData:u,hasExpression:j}=i.cache;let d=i.cache.compiledFunc;if(!m&&!j){const e=i.stops;return e&&e[0]&&e[0].color}if("number"!=typeof c)if(j){if(!t(r)||!t(r.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},o=r.arcade.arcadeUtils,s=o.getViewInfo(e),a=o.createExecContext(n,s);if(!d){const e=o.createSyntaxTree(i.valueExpression);d=o.createFunction(e),i.cache.compiledFunc=d}c=o.executeFunction(d,a)}else l&&(c=l[m]);const b=i.normalizationField,y=l?parseFloat(l[b]):void 0;if(null!=c&&(!b||a||!isNaN(y)&&0!==y)){isNaN(y)||a||(c/=y);const e=g(c,u);if(e){const o=e[0],a=e[1],n=o===a?i.stops[o].color:s.blendColors(i.stops[o].color,i.stops[a].color,e[2],t(r)?r.color:void 0);return new s(n)}}}function d(e,t,r){const s="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"opacity"===e.type))[0]:e;if(!s)return;if("esri.renderers.visualVariables.OpacityVariable"!==s.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const i="number"==typeof t,a=i?null:t,n=a&&a.attributes;let l=i?t:null;const c=s.field,{ipData:m,hasExpression:u}=s.cache;let j=s.cache.compiledFunc;if(!c&&!u){const e=s.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof l)if(u){if(o(r)||o(r.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,i=t.getViewInfo(e),n=t.createExecContext(a,i);if(!j){const e=t.createSyntaxTree(s.valueExpression);j=t.createFunction(e),s.cache.compiledFunc=j}l=t.executeFunction(j,n)}else n&&(l=n[c]);const d=s.normalizationField,b=n?parseFloat(n[d]):void 0;if(null!=l&&(!d||i||!isNaN(b)&&0!==b)){isNaN(b)||i||(l/=b);const e=g(l,m);if(e){const t=e[0],o=e[1];if(t===o)return s.stops[t].opacity;{const r=s.stops[t].opacity;return r+(s.stops[o].opacity-r)*e[2]}}}}function b(e,t,r){const s="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"rotation"===e.type))[0]:e;if(!s)return;if("esri.renderers.visualVariables.RotationVariable"!==s.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const i=s.axis||"heading",a="heading"===i&&"arithmetic"===s.rotationType?90:0,n="heading"===i&&"arithmetic"===s.rotationType?-1:1,l="number"==typeof t?null:t,c=l&&l.attributes,m=s.field,{hasExpression:u}=s.cache;let j=s.cache.compiledFunc,d=0;if(!m&&!u)return d;if(u){if(o(r)||o(r.arcade))return void p.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,i=t.getViewInfo(e),a=t.createExecContext(l,i);if(!j){const e=t.createSyntaxTree(s.valueExpression);j=t.createFunction(e),s.cache.compiledFunc=j}d=t.executeFunction(j,a)}else c&&(d=c[m]||0);return d="number"!=typeof d||isNaN(d)?null:a+n*d,d}function y(e,r,s){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.filter((e=>"size"===e.type))[0]:e;if(!i)return;if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void p.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const a=v(function(e,r,s){const i="number"==typeof r,a=i?null:r,l=a&&a.attributes;let c=i?r:null;const{isScaleDriven:m}=e.cache;let u=e.cache.compiledFunc;if(m){const o=t(s)?s.scale:void 0,r=t(s)?s.view:void 0;c=null==o||"3d"===r?function(e){let t=null,o=null;const r=e.stops;return r?(t=r[0].value,o=r[r.length-1].value):(t=e.minDataValue||0,o=e.maxDataValue||0),(t+o)/2}(e):o}else if(!i)switch(e.inputValueType){case"expression":{if(o(s)||o(s.arcade))return void p.error("Use of arcade expressions requires an arcade context");const t={viewingMode:s.viewingMode,scale:s.scale,spatialReference:s.spatialReference},r=s.arcade.arcadeUtils,i=r.getViewInfo(t),n=r.createExecContext(a,i);if(!u){const t=r.createSyntaxTree(e.valueExpression);u=r.createFunction(t),e.cache.compiledFunc=u}c=r.executeFunction(u,n);break}case"field":l&&(c=l[e.field]);break;case"unknown":c=null}if(!n(c))return null;if(i||!e.normalizationField)return c;const j=l?parseFloat(l[e.normalizationField]):null;return n(j)&&0!==j?c/j:null}(i,r,s),i,r,s,i.cache.ipData);return null==a||isNaN(a)?0:a}function f(e,t,o){return null==e?null:a(e)?y(e,t,o):n(e)?e:null}function h(e,t,o){return n(o)&&e>o?o:n(t)&&e<t?t:e}function v(e,o,r,s,i){switch(o.transformationType){case"additive":return function(e,t,o,r){return e+(f(t.minSize,o,r)||t.minDataValue)}(e,o,r,s);case"constant":return function(e,t,o){const r=e.stops;let s=r&&r.length&&r[0].size;return null==s&&(s=e.minSize),f(s,t,o)}(o,r,s);case"clamped-linear":return function(e,o,r,s){const i=(e-o.minDataValue)/(o.maxDataValue-o.minDataValue),a=f(o.minSize,r,s),n=f(o.maxSize,r,s),l=t(s)?s.shape:void 0;if(e<=o.minDataValue)return a;if(e>=o.maxDataValue)return n;if("area"===o.scaleBy&&l){const e="circle"===l,t=e?m*(a/2)**2:a*a,o=t+i*((e?m*(n/2)**2:n*n)-t);return e?2*Math.sqrt(o/m):Math.sqrt(o)}return a+i*(n-a)}(e,o,r,s);case"proportional":return function(e,o,r,s){const i=t(s)?s.shape:void 0,a=e/o.minDataValue,n=f(o.minSize,r,s),l=f(o.maxSize,r,s);let p=null;return p="circle"===i?2*Math.sqrt(a*(n/2)**2):"square"===i||"diamond"===i||"image"===i?Math.sqrt(a*n**2):a*n,h(p,n,l)}(e,o,r,s);case"stops":return function(e,t,o,r,s){const[i,a,n]=g(e,s);if(i===a)return f(t.stops[i].size,o,r);{const e=f(t.stops[i].size,o,r);return e+(f(t.stops[a].size,o,r)-e)*n}}(e,o,r,s,i);case"real-world-size":return function(e,o,r,s){const i=(t(s)&&s.resolution?s.resolution:1)*l[o.valueUnit],a=f(o.minSize,r,s),n=f(o.maxSize,r,s),{valueRepresentation:p}=o;let c=null;return c="area"===p?2*Math.sqrt(e/m)/i:"radius"===p||"distance"===p?2*e/i:e/i,h(c,a,n)}(e,o,r,s);case"identity":return e;case"unknown":return null}}function S(e,t,o){const{isScaleDriven:r}=e.cache;if(!(r&&"3d"===o||t))return null;const s={scale:t,view:o};let i=f(e.minSize,c,s),a=f(e.maxSize,c,s);if(null!=i||null!=a){if(i>a){const e=a;a=i,i=e}return{minSize:i,maxSize:a}}}function V(e,t,o){if(!e.visualVariables)return;const r=[],s=[],i=[],a=[],n=[];for(const t of e.visualVariables)switch(t.type){case"color":s.push(t);break;case"opacity":i.push(t);break;case"rotation":n.push(t);break;case"size":a.push(t)}return s.forEach((e=>{const s=j(e,t,o);r.push({variable:e,value:s})})),i.forEach((e=>{const s=d(e,t,o);r.push({variable:e,value:s})})),n.forEach((e=>{const s=b(e,t,o);r.push({variable:e,value:s})})),a.forEach((e=>{const s=y(e,t,o);r.push({variable:e,value:s})})),r.filter((e=>null!=e.value))}function g(e,t){if(!t)return;let o=0,r=t.length-1;return t.some(((t,s)=>e<t?(r=s,!0):(o=s,!1))),[o,r,(e-t[o])/(t[r]-t[o])]}function x(e,t,o){const s=["proportional","proportional","proportional"];for(const i of e){const e=i.useSymbolValue?"symbol-value":y(i,t,o);switch(i.axis){case"width":s[0]=e;break;case"depth":s[1]=e;break;case"height":s[2]=e;break;case"width-and-depth":s[0]=e,s[1]=e;break;case"all":case void 0:case null:s[0]=e,s[1]=e,s[2]=e;break;default:r(i.axis)}}return s}export{x as getAllSizes,j as getColor,d as getOpacity,b as getRotationAngle,y as getSize,v as getSizeForValue,f as getSizeFromNumberOrVariable,S as getSizeRangeAtScale,V as getVisualVariableValues,u as viewScaleRE};
