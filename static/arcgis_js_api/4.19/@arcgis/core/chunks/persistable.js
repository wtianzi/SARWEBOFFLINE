/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{i as r,b as t,g as e}from"./Logger.js";import{a as o}from"./metadata.js";import{propertyJSONMeta as i}from"../core/accessorSupport/decorators/property.js";import{n}from"./PropertyOrigin.js";import{isAbsolute as s,isBlobProtocol as u,join as a,getPathExtension as p}from"../core/urlUtils.js";import{i as c}from"./multiOriginJSONSupportUtils.js";import{g as l,a as f}from"./resourceExtension.js";import{r as m,t as y,i as g,p as h}from"./persistableUrlUtils.js";function d(e){const a=r(e)&&e.origins?e.origins:[void 0];return(l,d)=>{const j=function(e,i,a){if(r(e)&&"resource"===e.type)return function(e,i,a){const l=o(i,a);return{type:String,read:(r,t,e)=>{const o=m(r,t,e);return l.type===String?o:"function"==typeof l.type?new l.type({url:o}):void 0},write:{writer(o,i,m,h){if(!h||!h.resources)return"string"==typeof o?void(i[m]=y(o,h)):void(i[m]=o.write({},h));const d=function(r){if(t(r))return null;if("string"==typeof r)return r;return r.url}(o),j=d?y(d,{...h,verifyItemRelativeUrls:h&&h.verifyItemRelativeUrls?{writtenUrls:h.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},1):null,I=l.type!==String&&(!c(this)||h&&h.origin&&this.originIdOf(a)>n(h.origin));h&&h.portalItem&&r(j)&&!s(j)?I?function(r,t,e,o,i,n,s,u){const a=s.portalItem.resourceFromPath(o),c=U(e,o,s),l=f(c),m=p(a.path);if(l!==m)return void v(r,t,e,o,i,n,s,u);w(r,t,a,c,s.resources.toUpdate),i[n]=o}(this,a,o,j,i,m,h,e):function(r,t,e,o){o.resources.toKeep.push({resource:o.portalItem.resourceFromPath(r)}),t[e]=r}(j,i,m,h):h&&h.portalItem&&(t(j)||r(g(j))||u(j)||I)?v(this,a,o,j,i,m,h,e):i[m]=j}}}}(e,i,a);switch(r(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:r,write:t}=h;return{read:r,write:t}}}}(e,l,d);for(const r of a){const t=i(l,r,d);for(const r in j)t[r]=j[r]}}}function v(r,t,o,i,n,s,p,c){const m=l(),y=U(o,i,p),g=a(e(c,"prefix"),m),h=`${g}.${f(y)}`,d=p.portalItem.resourceFromPath(h);u(i)&&p.resources.pendingOperations.push(async function(r){const t=(await import("../request.js").then((function(r){return r.r}))).default,{data:e}=await t(r,{responseType:"blob"});return e}(i).then((r=>{d.path=`${g}.${f(r)}`,n[s]=d.itemRelativeUrl})).catch((()=>{}))),w(r,t,d,y,p.resources.toAdd),n[s]=d.itemRelativeUrl}function w(r,t,e,o,i){i.push({resource:e,content:o,finish:e=>{!function(r,t,e){"string"==typeof r[t]?r[t]=e.url:r[t].url=e.url}(r,t,e)}})}function U(r,t,e){return"string"==typeof r?{url:t}:new Blob([JSON.stringify(r.toJSON(e))],{type:"application/json"})}export{d as p};
