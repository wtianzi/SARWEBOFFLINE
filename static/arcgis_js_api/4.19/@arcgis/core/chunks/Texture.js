/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{f as e,d as t}from"../core/lang.js";import{b as r,L as s,i as a}from"./Logger.js";import{createAbortController as i,onAbort as o,createAbortError as n}from"../core/promiseUtils.js";import l from"../core/Error.js";import{n as h}from"./compilerUtils.js";import{E as m}from"./Evented.js";import{isBlobProtocol as d,isDataProtocol as p}from"../core/urlUtils.js";import{l as u}from"../request.js";import{g as c}from"./assets.js";import{o as g,n as f}from"./mathUtils2.js";import{r as w}from"./requestImageUtils.js";import{T,i as x,F}from"./FramebufferObject.js";import{a as y}from"./Util.js";import{c as D}from"./glUtil3D.js";import{C as M}from"./Object3D.js";import{c as I,v as b}from"./VertexArrayObject.js";let A,v=null,E=null;async function S(){return r(E)&&(E=function(){if(r(A)){const e=e=>c(`esri/libs/basisu/${e}`);A=import("./basis_transcoder.js").then((function(e){return e.b})).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return A}(),v=await E),E}const O=s.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function C(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const P=C("DXT1"),U=C("DXT3"),L=C("DXT5");function j(e,t,r,s){const{textureData:a,internalFormat:i,width:o,height:n}=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return O.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return O.error("Unsupported format, must contain a FourCC code"),null;const s=r[21];let a,i;switch(s){case P:a=8,i=33776;break;case U:a=16,i=33778;break;case L:a=16,i=33779;break;default:return O.error("Unsupported FourCC code:",(o=s,String.fromCharCode(255&o,o>>8&255,o>>16&255,o>>24&255))),null}var o;let n=1,l=r[4],h=r[3];0==(3&l)&&0==(3&h)||(O.warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,h=h+3&-4);const m=l,d=h;131072&r[2]&&!1!==t&&(n=Math.max(1,r[7]));1===n||g(l)&&g(h)||(O.warn("Ignoring mipmaps of non power of two sized compressed texture."),n=1);let p,u,c=r[1]+4;const f=[];for(let t=0;t<n;++t)u=(l+3>>2)*(h+3>>2)*a,p=new Uint8Array(e,c,u),f.push(p),c+=u,l=Math.max(1,l>>1),h=Math.max(1,h>>1);return{textureData:{type:"compressed",levels:f},internalFormat:i,width:m,height:d}}(r,s);t.samplingMode=a.levels.length>1?9987:9729,t.hasMipmap=a.levels.length>1,t.internalFormat=i,t.width=o,t.height=n;const l=new T(e,t,a);return e.bindTexture(l,0),l}class V extends M{constructor(e,t){super(),this.data=e,this.type=4,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new m,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=V.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const e=this.data;r(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}startPreloadVideoElement(e){d(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}startPreloadImageElement(e){p(e.src)||d(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static estimateTexMemRequired(s,a){if(r(s))return 0;if(e(s)||t(s))return a.encoding===V.BASIS_ENCODING?function(e){if(r(v))return e.byteLength;const t=new v.BasisFile(new Uint8Array(e));if(t.getNumImages()<1)return 0;const s=t.getNumLevels(0),a=t.getHasAlpha(),i=t.getImageWidth(0,0),o=t.getImageHeight(0,0);t.close(),t.delete();const n=I(a?37496:37492),l=(4**s-1)/(3*4**(s-1));return Math.ceil(i*o*n*l)}(s):s.byteLength;const{width:i,height:o}=s instanceof Image||s instanceof ImageData||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement?V.getDataDimensions(s):a;return(a.mipmap?4/3:1)*i*o*(a.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(e){const t=this.params.mipmap&&!this.params.disableAnisotropy;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:t?e.parameters.maxMaxAnisotropy:void 0}}load(s,i){if(a(this.glTexture))return this.glTexture;if(a(this.loadingPromise))return this.loadingPromise;const o=this.data;return r(o)?(this.glTexture=new T(s,this.createDescriptor(s),null),s.bindTexture(this.glTexture,0),this.glTexture):"string"==typeof o?this.loadFromURL(s,i,o):o instanceof Image?this.loadFromImageElement(s,i,o):o instanceof HTMLVideoElement?this.loadFromVideoElement(s,i,o):o instanceof ImageData||o instanceof HTMLCanvasElement?this.loadFromImage(s,o,i):(e(o)||t(o))&&this.params.encoding===V.DDS_ENCODING?this.loadFromDDSData(s,o):(e(o)||t(o))&&this.params.encoding===V.BASIS_ENCODING?this.loadFromBasis(s,o):t(o)?this.loadFromPixelData(s,o):e(o)?this.loadFromPixelData(s,new Uint8Array(o)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,t,s){if(!(this.data instanceof HTMLVideoElement)||r(this.glTexture))return s;if(this.data.readyState<2||s===this.data.currentTime)return s;if(a(this.powerOfTwoStretchInfo)){const{framebuffer:r,vao:s,sourceTexture:a}=this.powerOfTwoStretchInfo;a.setData(this.data),this.drawStretchedTexture(e,t,r,s,a,this.glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:s}=this.glTexture.descriptor;e!==r||t!==s?this.glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,s),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(e,t){return this.glTexture=j(e,this.createDescriptor(e),t,this.params.mipmap),e.bindTexture(this.glTexture,0),this.glTexture}loadFromBasis(e,t){return this.loadAsync((()=>async function(e,t,s){r(v)&&(v=await S());const a=new v.BasisFile(new Uint8Array(s));if(a.getNumImages()<1)return null;const i=a.getNumLevels(0),o=a.getHasAlpha(),n=a.getImageWidth(0,0),l=a.getImageHeight(0,0),{compressedTextureETC:h,compressedTextureS3TC:m}=e.capabilities,[d,p]=h?o?[1,37496]:[0,37492]:m?o?[3,33779]:[2,33776]:[13,6408];a.startTranscoding();const u=[];for(let e=0;e<i;e++)u.push(new Uint8Array(a.getImageTranscodedSizeInBytes(0,e,d))),a.transcodeImage(u[e],0,e,d,0,0);a.close(),a.delete();const c={...t,samplingMode:i>1?9987:9729,hasMipmap:i>1,internalFormat:p,width:n,height:l};return new T(e,c,{type:"compressed",levels:u})}(e,this.createDescriptor(e),t).then((e=>(this.glTexture=e,e)))))}loadFromPixelData(e,t){y(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new T(e,r,t),e.bindTexture(this.glTexture,0),this.glTexture}async loadAsync(e){const t=i();this.loadingController=t;const r=e(t.signal);this.loadingPromise=r;const s=()=>{this.loadingController===t&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(s,s),r}loadFromURL(e,t,r){return this.loadAsync((async s=>{const a=await w(r,{signal:s});return this.loadFromImage(e,a,t)}))}loadFromImageElement(e,t,r){return r.complete?this.loadFromImage(e,r,t):this.loadAsync((async s=>{const a=await u(r,r.src,!1,s);return this.loadFromImage(e,a,t)}))}loadFromVideoElement(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)}loadFromVideoElementAsync(e,t,r){return this.loadAsync((s=>new Promise(((i,h)=>{const m=()=>{r.removeEventListener("loadeddata",d),r.removeEventListener("error",p),a(u)&&u.remove()},d=()=>{r.readyState>=2&&(m(),i(this.loadFromImage(e,r,t)))},p=e=>{m(),h(e||new l("Failed to load video"))};r.addEventListener("loadeddata",d),r.addEventListener("error",p);const u=o(s,(()=>p(n())))}))))}loadFromImage(e,t,r){const s=V.getDataDimensions(t);this.params.width=s.width,this.params.height=s.height;const a=this.createDescriptor(e);return a.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,a)||g(s.width)&&g(s.height)?(a.width=s.width,a.height=s.height,this.glTexture=new T(e,a,t),e.bindTexture(this.glTexture,0),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(e,t,s,a,r),e.bindTexture(this.glTexture,0),this.glTexture)}requiresPowerOfTwo(e,t){const r=33071,s="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!x(e.gl)&&(t.hasMipmap||!s)}makePowerOfTwoTexture(e,t,r,s,a){const{width:i,height:o}=r,n=f(i),l=f(o);let m;switch(s.width=n,s.height=l,this.params.powerOfTwoResizeMode){case 2:s.textureCoordinateScaleFactor=[i/n,o/l],m=new T(e,s),m.updateData(0,0,0,i,o,t);break;case 1:case null:case void 0:m=this.stretchToPowerOfTwo(e,t,s,a);break;default:h(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&m.generateMipmap(),m}stretchToPowerOfTwo(e,t,r,s){const a=new T(e,r),i=new F(e,{colorTarget:0,depthStencilTarget:0},a),o=new T(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=D(e);return this.drawStretchedTexture(e,s,i,n,o,a),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:i}:(n.dispose(!0),o.dispose(),i.detachColorTexture(),e.bindFramebuffer(null),i.dispose()),a}drawStretchedTexture(e,t,r,s,a,i){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,i.descriptor.width,i.descriptor.height);const n=t.program;e.bindProgram(n),n.setUniform4f("color",1,1,1,1),n.setUniform1i("tex",0),e.bindTexture(a,0),e.bindVAO(s),e.setPipelineState(t.pipeline),e.drawArrays(5,0,b(s,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}unload(){if(a(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this.powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(a(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),a(this.loadingController)){const e=this.loadingController;this.loadingController=null,this.loadingPromise=null,e.abort()}this.events.emit("unloaded")}}V.DDS_ENCODING="image/vnd-ms.dds",V.BASIS_ENCODING="image/x.basis";export{V as T,S as l};
