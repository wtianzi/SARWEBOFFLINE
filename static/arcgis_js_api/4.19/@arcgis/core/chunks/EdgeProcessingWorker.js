/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{j as t}from"../core/lang.js";import{R as e,h as n}from"../core/scheduling.js";import{d as s,b as o}from"./mathUtils2.js";import{c as r}from"./vec3f64.js";import{e as i,n as a,a as c,g as f,d as l,c as u,s as g,k as d}from"./vec3.js";import{d as m}from"./mathUtils.js";import{d as p}from"./deduplicate.js";import{v as h,d as w,a as v,f as y,c as A,u as I,w as b,t as S,B as V,e as N,i as x,b as E,g as L,r as j,m as U,h as k,k as B,p as D,n as F,l as W,j as M,o as P,y as _,z,x as O,s as R,A as C,C as H,D as T,q,E as $,F as G,G as J,H as K,I as Q,J as X}from"./BufferView.js";import{g as Y}from"./glUtil.js";import{n as Z}from"./InterleavedLayout.js";const tt=Z().vec3f("position").u16("componentIndex").u16("u16padding"),et=Z().vec2u8("sideness"),nt=Y(et),st=Z().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),ot=st.clone().vec3f("normal"),rt=st.clone().vec3f("normalA").vec3f("normalB"),it={position0:0,position1:1,componentIndex:2,variantOffset:4,variantStroke:5,variantExtension:6,normal:7,normalA:7,normalB:8,sideness:9};class at{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?gt:ut}write(t,e,n){const s=this.edgeHashFunction(n);wt.seed=s;const o=wt.getIntRange(0,255),r=wt.getIntRange(0,this.settings.variants-1),i=wt.getFloat(),a=255*(.5*function(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}(-(1-Math.min(i/.7,1))+Math.max(0,i-.7)/(1-.7),1.2)+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,o),t.variantStroke.set(e,r),t.variantExtension.set(e,a)}trim(t,e){return t.slice(0,e)}}const ct=new Float32Array(6),ft=new Uint32Array(ct.buffer),lt=new Uint32Array(1);function ut(t){const e=ct;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],lt[0]=5381;for(let t=0;t<ft.length;t++)lt[0]=31*lt[0]+ft[t];return lt[0]}function gt(t){const e=ct;e[0]=dt(t.position0[0]),e[1]=dt(t.position0[1]),e[2]=dt(t.position0[2]),e[3]=dt(t.position1[0]),e[4]=dt(t.position1[1]),e[5]=dt(t.position1[2]),lt[0]=5381;for(let t=0;t<ft.length;t++)lt[0]=31*lt[0]+ft[t];return lt[0]}function dt(t){return Math.round(1e4*t)/1e4}class mt{constructor(){this.commonWriter=new at}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ot.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),i(ht,n.faceNormal0,n.faceNormal1),a(ht,ht),t.normal.setVec(e,ht)}trim(t,e){return this.commonWriter.trim(t,e)}}mt.Layout=ot,mt.glLayout=Y(ot,{divisor:1});class pt{constructor(){this.commonWriter=new at}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return rt.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),t.normalA.setVec(e,n.faceNormal0),t.normalB.setVec(e,n.faceNormal1)}trim(t,e){return this.commonWriter.trim(t,e)}}pt.Layout=rt,pt.glLayout=Y(rt,{divisor:1});const ht=r(),wt=new e;function vt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:At(t.layout)}}function yt(t){return function(t){const e=Z();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach((t=>e.fields.set(t[0],{...t[1],constructor:St(t[1].constructor)}))),e}(t.layout).createView(t.buffer)}function At(t){const e=new Array;return t.fields.forEach(((t,n)=>{const s={...t,constructor:bt(t.constructor)};e.push([n,s])})),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const It=[h,w,v,y,A,I,b,S,V,N,x,E,L,j,U,k,B,D,F,W,M,P,_,z,O,R,C,H,T,q,$,G,J,K,Q,X];function bt(t){return`${t.ElementType}_${t.ElementCount}`}function St(t){return Vt.get(t)}const Vt=new Map;function Nt(t,e,n){const s=e/3,o=new Uint32Array(n+1),r=new Uint32Array(n+1),i=(t,e)=>{t<e?o[t+1]++:r[e+1]++};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];i(n,s),i(s,o),i(o,n)}let a=0,c=0;for(let t=0;t<n;t++){const e=o[t+1],n=r[t+1];o[t+1]=a,r[t+1]=c,a+=e,c+=n}const f=new Uint32Array(6*s),l=o[n],u=(t,e,n)=>{if(t<e){const s=o[t+1]++;f[2*s]=e,f[2*s+1]=n}else{const s=r[e+1]++;f[2*l+2*s]=t,f[2*l+2*s+1]=n}};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];u(n,s,e),u(s,o,e),u(o,n,e)}const g=(t,e)=>{const n=2*t,s=e-t;for(let t=1;t<s;t++){const e=f[n+2*t],s=f[n+2*t+1];let o=t-1;for(;o>=0&&f[n+2*o]>e;o--)f[n+2*o+2]=f[n+2*o],f[n+2*o+3]=f[n+2*o+1];f[n+2*o+2]=e,f[n+2*o+3]=s}};for(let t=0;t<n;t++)g(o[t],o[t+1]),g(l+r[t],l+r[t+1]);const d=new Int32Array(3*s),m=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,p=(t,e)=>{const n=m(t,e);d[3*e+n]=-1},h=(t,e,n,s)=>{const o=m(t,e);d[3*e+o]=s;const r=m(n,s);d[3*s+r]=e};for(let t=0;t<n;t++){let e=o[t];const n=o[t+1];let s=r[t];const i=r[t+1];for(;e<n&&s<i;){const n=f[2*e],o=f[2*l+2*s];n===o?(h(t,f[2*e+1],o,f[2*l+2*s+1]),e++,s++):n<o?(p(t,f[2*e+1]),e++):(p(o,f[2*l+2*s+1]),s++)}for(;e<n;)p(t,f[2*e+1]),e++;for(;s<i;){p(f[2*l+2*s],f[2*l+2*s+1]),s++}}return d}It.forEach((t=>Vt.set(bt(t),t)));function xt(e,o,r,i=Bt){const m=e.vertices.position,p=e.vertices.componentIndex,h=s(i.anglePlanar),w=s(i.angleSignificantEdge),v=Math.cos(w),y=Math.cos(h),A=Ut.edge,I=A.position0,b=A.position1,S=A.faceNormal0,V=A.faceNormal1,N=function(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,o=kt.v0,r=kt.v1,i=kt.v2,c=new Float32Array(3*e);for(let t=0;t<e;t++){const e=s[3*t+0],f=s[3*t+1],l=s[3*t+2];n.getVec(e,o),n.getVec(f,r),n.getVec(l,i),g(r,r,o),g(i,i,o),u(o,r,i),a(o,o),c[3*t+0]=o[0],c[3*t+1]=o[1],c[3*t+2]=o[2]}return c}(e),x=function(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let o=0;for(let t=0;t<e;t++){const e=s[3*t+0],r=s[3*t+1],i=s[3*t+2],a=n[3*t+0],c=n[3*t+1],f=n[3*t+2];o+=-1===e||a<c?1:0,o+=-1===r||c<f?1:0,o+=-1===i||f<a?1:0}const r=new Int32Array(4*o);let i=0;for(let t=0;t<e;t++){const e=s[3*t+0],o=s[3*t+1],a=s[3*t+2],c=n[3*t+0],f=n[3*t+1],l=n[3*t+2];(-1===e||c<f)&&(r[i++]=c,r[i++]=f,r[i++]=t,r[i++]=e),(-1===o||f<l)&&(r[i++]=f,r[i++]=l,r[i++]=t,r[i++]=o),(-1===a||l<c)&&(r[i++]=l,r[i++]=c,r[i++]=t,r[i++]=a)}return r}(e),E=x.length/4,L=o.allocate(E);let j=0;const U=E,k=r.allocate(U);let B=0,D=0,F=0;const W=n(0,E),M=new Float32Array(E);t(M,((t,e,n)=>{m.getVec(x[4*e+0],I),m.getVec(x[4*e+1],b),n[e]=d(I,b)})),W.sort(((t,e)=>M[e]-M[t]));const P=new Array,_=new Array;for(let t=0;t<E;t++){const e=W[t],n=M[e],s=x[4*e+0],i=x[4*e+1],a=x[4*e+2],u=x[4*e+3],g=-1===u;if(m.getVec(s,I),m.getVec(i,b),g)c(S,N[3*a+0],N[3*a+1],N[3*a+2]),f(V,S),A.componentIndex=p.get(s),A.cosAngle=l(S,V);else{if(c(S,N[3*a+0],N[3*a+1],N[3*a+2]),c(V,N[3*u+0],N[3*u+1],N[3*u+2]),A.componentIndex=p.get(s),A.cosAngle=l(S,V),Lt(A,y))continue;A.cosAngle<-.9999&&f(V,S)}D+=n,F++,g||Et(A,v)?(o.write(L,j++,A),P.push(n)):jt(A,h)&&(r.write(k,B++,A),_.push(n))}const z=new Float32Array(P.reverse()),O=new Float32Array(_.reverse());return{regular:{instancesData:o.trim(L,j),lodInfo:{lengths:z}},silhouette:{instancesData:r.trim(k,B),lodInfo:{lengths:O}},averageEdgeLength:D/F}}function Et(t,e){return t.cosAngle<e}function Lt(t,e){return t.cosAngle>e}function jt(t,e){const n=o(t.cosAngle),s=Ut.fwd,r=Ut.ortho;m(s,t.position1,t.position0);return n*(l(u(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}const Ut={edge:{position0:r(),position1:r(),faceNormal0:r(),faceNormal1:r(),componentIndex:0,cosAngle:0},ortho:r(),fwd:r()},kt={v0:r(),v1:r(),v2:r()},Bt={anglePlanar:4,angleSignificantEdge:35};function Dt(t){const e=function(t,e,n,s){if(e){return{faces:n,facesLength:s,neighbors:Nt(n,s,t.count),vertices:t}}const o=p(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:s}),r=Nt(o.indices,s,o.uniqueCount);return{faces:o.indices,facesLength:o.indices.length,neighbors:r,vertices:tt.createView(o.buffer)}}(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Ft.updateSettings(t.writerSettings),Wt.updateSettings(t.writerSettings),xt(e,Ft,Wt)}const Ft=new mt,Wt=new pt;var Mt=Object.freeze({__proto__:null,wrappedWork:async function(t){const e=function(t){return{data:tt.createView(t.dataBuffer),indices:"Uint32Array"===t.indicesType?new Uint32Array(t.indicesBuffer):"Uint16Array"===t.indicesType?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}(t),n=Dt(e),s=[e.data.buffer];return{result:function(t,e){e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer);return{regular:{instancesData:vt(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:vt(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}(n,s),transferList:s}},work:Dt});export{it as E,mt as R,pt as S,et as V,tt as a,Mt as b,nt as g,yt as u,Dt as w};
