/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{O as t,A as e}from"../chunks/ArrayPool.js";import{clone as s,equals as r}from"./lang.js";import{d as i}from"../chunks/deprecate.js";import"../chunks/object.js";import"../config.js";import{L as o,n}from"../chunks/Logger.js";import"../chunks/string.js";import{p as a,g as c,d as l,e as h,o as u,c as d}from"../chunks/metadata.js";import{v as f,property as _,g as p,s as g}from"./accessorSupport/decorators/property.js";import{a as v,n as y}from"../chunks/PropertyOrigin.js";import{schedule as m}from"./scheduling.js";import"./promiseUtils.js";import"../chunks/Message.js";import"./Error.js";import"../chunks/ensureType.js";import{subclass as b}from"./accessorSupport/decorators/subclass.js";class O{constructor(t,e){this._observers=t,this._observer=e}remove(){this._observers.delete(this._observer)}}let w=!1;function A(t){return void 0!==t.flags}class k{constructor(t,e,s){this.host=t,this.propertyName=e,this.metadata=s,this.flags=1,this._observers=null,this._accessed=null,this._handles=[],this.flags=1|(s.nonNullable?8:0)|(s.hasOwnProperty("value")?16:0)|(void 0===s.get?32:0)|(void 0===s.dependsOn?64:0)}destroy(){this._accessed&&(this._accessed.clear(),this._accessed=null),this._observers&&(this._observers.clear(),this._observers=null),this._clearObservationHandles()}onObservableAccessed(t){t!==this&&(null===this._accessed&&(this._accessed=new Set),this._accessed.add(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=32;const t=this._accessed;if(null===t)return;const e=this._handles;for(const s of t)e.push(s.observe(this));t.clear()}observe(t){return null===this._observers&&(this._observers=new Set),new O(this._observers.add(t),t)}notify(){2&~this.flags&&(this.flags|=1),this._notifyObservers()}invalidate(){this.notify()}commit(){this.flags&=-2,this._notifyObservers()}_notifyObservers(){if(null===this._observers)return;const t=this._observers.size,e=new Array(t);let s=t-1;for(const t of this._observers)e[s--]=t;const r=!w;for(;e.length;){const t=e.pop();if(A(t)){if(2&~t.flags&&(t.flags|=1),null===t._observers)continue;for(const s of t._observers)e.push(s)}else r&&t.notify()}}_clearObservationHandles(){for(const t of this._handles)t.remove();this._handles.length=0}}class S{constructor(){this._values=new Map}clone(t){const e=new S;return this._values.forEach(((r,i)=>{t&&t.has(i)||e.set(i,s(r))})),e}get(t){return this._values.get(t)}originOf(){return 6}keys(){return[...this._values.keys()]}set(t,e){this._values.set(t,e)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}let j,I=[];const z=o.getLogger("esri.core.Accessor");function E(t){void 0!==j&&j.onObservableAccessed(t)}let P=!1,C=!1;function q(t,e,s){if(P)return V(t,e,s);D(t);const r=e.call(s);return x(),r}function V(t,e,s){const r=P;P=!0,D(t);let i=null;try{i=e.call(s)}catch(t){C&&z.error(t)}return x(),P=r,i}function D(t){j=t,I.push(t)}function x(){const t=I.pop();j=I.length>0?I[I.length-1]:void 0,void 0!==t&&t.onTrackingEnd()}function N(t,e){if(32&e.flags)return;const s=C;C=!1,64&e.flags?V(e,e.metadata.get,t):T(t,e),C=s}const M=[];function T(t,e){128&e.flags||(e.flags|=128,V(e,(()=>{const s=e.metadata.dependsOn||M;for(const e of s)if("string"==typeof e&&-1===e.indexOf("."))$(t,e,!1);else{const s=a(e);for(let e=0,r=t;e<s.length&&null!=r&&"object"==typeof r;++e)r=$(r,s[e],e!==s.length-1)}})),e.flags&=-129)}function $(t,e,s){const r="?"===e[e.length-1]?e.slice(0,-1):e;if(null!=t.getItemAt||Array.isArray(t)){const e=parseInt(r,10);if(!isNaN(e))return Array.isArray(t)?t[e]:t.getItemAt(e)}const i=c(t),o=null==i?void 0:i.properties.get(r);return o&&(E(o),N(t,o)),s?t[r]:void 0}o.getLogger("esri.core.accessorSupport.Properties");function L(t,e,s){return void 0!==t}function G(t,e,s,r){return void 0!==t&&(!(null==s&&8&t.flags)||(r.lifecycle,!1))}class H{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new S,this._origin=6;const e=this.host.constructor.__accessorMetadata__,s=e.properties;for(const e in s){const r=new k(t,e,s[e]);this.properties.set(e,r)}this.metadatas=s,this._autoDestroy=e.autoDestroy}initialize(){this.lifecycle=1}constructed(){this.lifecycle=2}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[e,s]of this.properties){const r=this.internalGet(e);r&&((t=r)&&"function"==typeof t.destroy)&&(r.destroy(),8&~s.flags&&this._internalSet(s,null)),s.destroy()}else for(const[t,e]of this.properties)e.destroy();var t}get initialized(){return 0!==this.lifecycle}get(t){return this.properties.get(t).metadata.get?this.getterComputed(t):this.getterStatic(t)}getterStatic(t){const e=this.properties.get(t);if(void 0!==e)return E(e),this.store.has(t)?this.store.get(t):e.metadata.value}getterComputed(t){const e=this.properties.get(t);E(e);const s=this.store,r=e.flags,i=this.store.get(t);if(4&r)return i;if(s.has(t)&&(1&~r||w))return i;let o;e.flags|=4;const n=e.metadata.get;64&r?o=q(e,n,this.host):(T(this.host,e),o=n.call(this.host)),s.set(t,o,1);const a=this.store.get(t);return a===i?e.flags&=-2:e.commit(),e.flags&=-5,a}originOf(t){const e=this.store.originOf(t);if(void 0===e){const e=this.properties.get(t);if(void 0!==e&&16&e.flags)return"defaults"}return v(e)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const e=this.properties.get(t);if(L(e))return this.store.has(t)?this.store.get(t):e.metadata.value}internalSet(t,e){const s=this.properties.get(t);L(s)&&this._internalSet(s,e)}getDependsInfo(t,e,s){const r=this.properties.get(e);if(!L(r))return"";const i=new Set,o=q({onObservableAccessed:t=>i.add(t),onTrackingEnd:()=>{}},(()=>{var e;return null==(e=r.metadata.get)?void 0:e.call(t)}));let n=`${s}${t.declaredClass.split(".").pop()}.${e}: ${o}\n`;if(0===i.size)return n;s+="  ";for(const t of i){if(!(t instanceof k))continue;const e=t.host,r=t.propertyName,i=c(e);n+=i?i.getDependsInfo(e,r,s):`${s}${r}: undefined\n`}return n}setAtOrigin(t,e,s){const r=this.properties.get(t);if(L(r))return this._setAtOrigin(r,e,s)}isOverridden(t){const e=this.properties.get(t);return void 0!==e&&!!(2&e.flags)}clearOverride(t){const e=this.properties.get(t);void 0!==e&&2&e.flags&&(e.flags&=-3,e.invalidate())}override(t,e){const s=this.properties.get(t);if(!G(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(U.release(t),!s)return;e=i}s.flags|=2,this._internalSet(s,e)}set(t,e){const s=this.properties.get(t);if(!G(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(U.release(t),!s)return;e=i}const i=s.metadata.set;i?i.call(this.host,e):this._internalSet(s,e)}setDefaultOrigin(t){this._origin=y(t)}getDefaultOrigin(){return v(this._origin)}propertyInvalidated(t){const e=this.properties.get(t);void 0!==e&&e.invalidate()}propertyCommitted(t){const e=this.properties.get(t);void 0!==e&&e.commit()}_internalSet(t,e){const s=0!==this.lifecycle?this._origin:0;this._setAtOrigin(t,e,s)}_setAtOrigin(t,e,s){const i=this.store,o=t.propertyName;i.has(o,s)&&r(e,i.get(o))&&2&~t.flags&&s===i.originOf(o)||(w=!0,t.invalidate(),w=!1,i.set(o,e,s),t.commit(),N(this.host,t))}_cast(t,e){const s=U.acquire();return s.valid=!0,s.value=e,t&&(s.value=t.call(this.host,e,s)),s}}const U=new t(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});class B extends t{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=n(this._set)}acquire(...t){const e=super.acquire(...t);return this._set.delete(e),e}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}class R{constructor(t){this.notify=t,this._accessed=new Set,this._handles=[]}destroy(){this._accessed.clear(),this.clear()}onObservableAccessed(t){this._accessed.add(t)}onTrackingEnd(){for(const t of this._accessed)this._handles.push(t.observe(this));this._accessed.clear()}clear(){for(const t of this._handles)t.remove();this._handles.length=0}}const F={runImmediately:!1};function J(t,e,s=F){let r=new R((function(){if(!r||o)return;const s=i;r.clear(),o=!0,i=q(r,t),o=!1,e(i,s)})),i=null,o=!1;return o=!0,i=q(r,t),o=!1,s.runImmediately&&e(i,i),{remove:function(){r&&(r.destroy(),r=null,i=null)}}}function K(t,e){return J(t,e,{runImmediately:!0})}function Q(t,e){return J((()=>t()),(t=>{t&&e()}),{runImmediately:!0})}function W(t){let e=new R((function(){if(!e||s)return;e.clear(),s=!0,q(e,t),s=!1})),s=!1;return s=!0,q(e,t),s=!1,{remove:function(){e&&(e.destroy(),e=null)}}}class X{constructor(){this.uid=0,this.target=null,this.path=null,this.oldValue=null,this.callback=null,this.getValue=null,this.removed=!1,this.propertyPath=null}acquire(t,e,s,r,i){this.target=t,this.path=e,this.oldValue=s,this.callback=r,this.getValue=i,this.propertyPath=l(e),this.uid=++X.uid,this.removed=!1}release(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null,this.uid=++X.uid,this.removed=!0}}X.pool=new B(X),X.uid=0;const Y=new e,Z=new Set;let tt,et=Y.acquire();function st(t){Z.has(t)?et.splice(et.indexOf(t),1):Z.add(t),et.push(t),tt||(tt=m(ot))}function rt(t){if(t.removed)return;const{callback:e,path:s,oldValue:r,target:i}=t,o=t.getValue();it(r,o)&&(t.oldValue=o,e.call(i,o,r,s,i))}function it(t,e){return!r(t,e)}function ot(){let t=10;for(;tt&&t--;){tt=null;const t=et;et=Y.acquire(),Z.clear();const e=Y.acquire();for(const s of t){const t=s.uid;rt(s),t===s.uid&&s.removed&&e.push(s)}for(let t=0;t<et.length;t++){const s=et[t];s.removed&&(e.push(s),Z.delete(s),et.splice(t,1),t-=1)}for(let t=0;t<e.length;t++)X.pool.release(e[t]);Y.release(t),Y.release(e),nt.forEach((t=>t()))}}const nt=new Set;function at(t){return nt.add(t),{remove(){nt.delete(t)}}}function ct(t,e,s){let r=h(t,e,s,((t,e,s)=>{let i,o,n=function(t,e){let s=new R((function(){e(r,i)})),r=null;function i(){return s?(s.clear(),r=q(s,t),r):null}return i(),{remove:function(){s&&(s.destroy(),s=null),r=null}}}((()=>f(t,e)),((n,a)=>{t.__accessor__.destroyed||i&&i.uid!==o?r.remove():(i||(i=X.pool.acquire(t,e,n,s,a),o=i.uid),st(i))}));return{remove:u((function(){n.remove(),i&&(i.uid!==o||i.removed||(i.removed=!0,st(i)),i=null),r=n=null}))}}));return r}function lt(t,e,s,r=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:r?function(t,e,s){const r=h(t,e,s,((t,e,s)=>{let i=!1;return J((()=>f(t,e)),((o,n)=>{t.__accessor__.destroyed?r.remove():i||(i=!0,it(n,o)&&s.call(t,o,n,e,t),i=!1)}))}));return r}(t,e,s):ct(t,e,s)}function ht(t){return et.some((e=>e.oldValue===t))}function ut(t){if(null==t)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor&&t.constructor.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}class dt{constructor(...t){if(this.constructor===dt)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new H(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:e,declaredClass:s,constructor:r}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const i=this;class o extends i{constructor(...t){super(...t),this.inherited=null,r&&r.apply(this,t)}}d(o.prototype);for(const e in t){const s=t[e];o.prototype[e]="function"==typeof s?function(...t){const r=this.inherited;let o;this.inherited=function(...t){if(i.prototype[e])return i.prototype[e].apply(this,t)};try{o=s.apply(this,t)}catch(t){throw this.inherited=r,t}return this.inherited=r,o}:t[e]}for(const t in e){const s=ut(e[t]);_(s)(o.prototype,t)}return b(s)(o)}postscript(t){const e=this.__accessor__,s=e.ctorArgs||t;e.initialize(),s&&(this.set(s),e.ctorArgs=null),e.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(!function(t){for(let e=0;e<et.length;e++){const s=et[e];s.target===t&&(s.removed=!0)}}(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&2===this.__accessor__.lifecycle||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return p(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}isInstanceOf(t){return i(o.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof t}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,e){return g(this,t,e),this}watch(t,e,s){return lt(this,t,e,s)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,e){return this.__accessor__.override(t,e)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.propertyInvalidated(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,e){return this.__accessor__.internalSet(t,e),this}}export default dt;export{O,B as R,R as S,q as a,at as b,K as c,W as d,ht as i,J as r,E as t,Q as w};
