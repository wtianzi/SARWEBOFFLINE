/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import"../../lang.js";import{s as e}from"../../../chunks/object.js";import"../../../config.js";import{L as t}from"../../../chunks/Logger.js";import"../../../chunks/string.js";import{c as r}from"../../../chunks/metadata.js";import{M as n}from"../../../chunks/Message.js";import{d as o}from"../../../chunks/ensureType.js";class i extends n{constructor(e,t,r){if(super(e,t,r),!(this instanceof i))return new i(e,t,r)}}function s(e){return!!e&&e.prototype&&e.prototype.declaredClass&&0===e.prototype.declaredClass.indexOf("esri.core.Collection")}i.prototype.type="warning";const a=t.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function c(t,r,n){var o,i;t&&(!n&&!r.read||null!=(o=r.read)&&o.reader||!1===(null==(i=r.read)?void 0:i.enabled)||function(e){if("types"in e)return j(e.types);return d(e.type)}(t)&&e("read.reader",u(t),r))}function u(e){var t;const r=null!=(t=e.ndimArray)?t:0;if(r>1)return function(e){var t;const r=p(e),n=f.bind(null,r),o=null!=(t=e.ndimArray)?t:0;return(e,t,r)=>{if(null==e)return e;e=n(e,r,o);let i=o,s=e;for(;i>0&&Array.isArray(s);)i--,s=s[0];if(void 0!==s)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===r)return y(e);if("type"in e&&l(e.type)){var n,o;const t=null==(n=e.type.prototype)||null==(o=n.itemType)?void 0:o.Type,r=y("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return p(e)}function p(e){return"type"in e?function(e){if(e.prototype.read)return(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void a.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i};return e.fromJSON}(e.type):function(e){var t;let n=null;const o=null!=(t=e.errorContext)?t:"type";return(t,s,c)=>{if(null==t)return t;const u=typeof t;if("object"!==u)return void a.error(`Expected JSON value of type 'object' to deserialize, but got '${u}'`);n||(n=function(e){const t={};for(const i in e.typeMap){var n,o;const s=e.typeMap[i],a=r(s.prototype);if("function"==typeof e.key)continue;const c=a.properties[e.key];if(!c)continue;null!=(n=c.json)&&n.type&&Array.isArray(c.json.type)&&1===c.json.type.length&&"string"==typeof c.json.type[0]&&(t[c.json.type[0]]=s);const u=null==(o=c.json)?void 0:o.write;if(!u||!u.writer){t[i]=s;continue}const p=u.target,f="string"==typeof p?p:e.key,y={};u.writer(i,y,f),y[f]&&(t[y[f]]=s)}return t}(e));const p=e.key;if("string"!=typeof p)return;const f=t[p],y=f?n[f]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!y){const e=`Type '${f||"unknown"}' is not supported`;return c&&c.messages&&t&&c.messages.push(new i(`${o}:unsupported`,e,{definition:t,context:c})),void a.error(e)}const l=new y;return l.read(t,c),l}}(e.types)}function f(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map((t=>f(e,t,r,n-1))):e(t,void 0,r)}function y(e){const t=p(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function l(e){if(!s(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?d(t.Type):j(t.Type))}function d(e){return!Array.isArray(e)&&(!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||l(e)))}function j(e){for(const t in e.typeMap){if(!d(e.typeMap[t]))return!1}return!0}function g(e){e.name&&(e.read&&"object"==typeof e.read?void 0===e.read.source&&(e.read.source=e.name):e.read={source:e.name},e.write&&"object"==typeof e.write?void 0===e.write.target&&(e.write.target=e.name):e.write={target:e.name})}function w(e){"boolean"==typeof e.read?e.read={enabled:e.read}:"function"==typeof e.read?e.read={enabled:!0,reader:e.read}:e.read&&"object"==typeof e.read&&void 0===e.read.enabled&&(e.read.enabled=!0)}function b(e){"boolean"==typeof e.write?e.write={enabled:e.write}:"function"==typeof e.write?e.write={enabled:!0,writer:e.write}:e.write&&"object"==typeof e.write&&void 0===e.write.enabled&&(e.write.enabled=!0)}function m(t,r){var n;if(!r.write||r.write.writer||!1===r.write.enabled&&!r.write.overridePolicy)return;const o=null!=(n=null==t?void 0:t.ndimArray)?n:0;var i;t&&(1===o||"type"in t&&s(t.type))?r.write.writer=O:r.write.writer=o>1?(i=o,function(t,r,n,o){let s;if(null===t)s=null;else{s=P(t,o,i);let e=i,r=s;for(;e>0&&Array.isArray(r);)e--,r=r[0];if(void 0!==r)for(let t=0;t<e;t++)s=[s]}e(n,s,r)}):h}function h(t,r,n,o){e(n,v(t,o),r)}function v(e,t){return e&&"function"==typeof e.write?e.write({},t):e&&"function"==typeof e.toJSON?e.toJSON():"number"==typeof e?A(e):e}function A(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function O(t,r,n,o){let i;null===t?i=null:t&&"function"==typeof t.map?(i=t.map((e=>v(e,o))),"function"==typeof i.toArray&&(i=i.toArray())):i=[v(t,o)],e(n,i,r)}function P(e,t,r){return 0!==r&&Array.isArray(e)?e.map((e=>P(e,t,r-1))):v(e,t)}function _(e,t){return C(e,"read",t)}function M(e,t){return C(e,"write",t)}function C(e,t,r){let n=e&&e.json;if(e&&e.json&&e.json.origins&&r){const o=e.json.origins[r.origin];o&&("any"===t||t in o)&&(n=o)}return n}function k(e){const t=function(e){if(e.type)return function(e){if(!e.type)return;let t=0,r=e.type;for(;Array.isArray(r)&&!o(r);)r=r[0],t++;return{type:r,ndimArray:t}}(e);return function(e){if(!e.types)return;let t=0,r=e.types;for(;Array.isArray(r);)r=r[0],t++;return{types:r,ndimArray:t}}(e)}(e);if(e.json.origins)for(const r in e.json.origins){const n=e.json.origins[r];c(t,n,!1),m(t,n)}c(t,e.json,!0),m(t,e.json)}const N=[{processPrototypePropertyMetadata(e,t){(function(e){if(e.json||(e.json={}),w(e.json),b(e.json),g(e.json),e.json.origins)for(const t in e.json.origins)w(e.json.origins[t]),b(e.json.origins[t]),g(e.json.origins[t]);return!0})(t)&&(!function(e){if(e.json&&e.json.origins){const t=e.json.origins,r={"web-document":["web-scene","web-map"]};for(const e in r)if(t[e]){const n=t[e];r[e].forEach((e=>{t[e]=n})),delete t[e]}}}(t),k(t))}}];const T=new Set,z=new Set;function S(e){return t=>{t.prototype.declaredClass=e,function(e,t){for(const r of N)if(r.processPrototypePropertyMetadata)for(const n in e){const o=e[n];r.processPrototypePropertyMetadata(n,o,e,t)}}(r(t.prototype).properties,e),$(t);const n=[],o=[];let i=t.prototype;for(;i;)i.hasOwnProperty("initialize")&&!T.has(i.initialize)&&(T.add(i.initialize),n.push(i.initialize)),i.hasOwnProperty("destroy")&&!z.has(i.destroy)&&(z.add(i.destroy),o.push(i.destroy)),i=Object.getPrototypeOf(i);T.clear(),z.clear();class s extends t{constructor(...e){if(super(...e),this.constructor===s&&"function"==typeof this.postscript){if(n.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let e=n.length-1;e>=0;e--)n[e].call(this)}}),o.length){let e=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!e){e=!0;for(let e=0;e<o.length;e++)o[e].call(this)}}})}this.postscript(...e)}}}return s.__accessorMetadata__=r(t.prototype),s.prototype.declaredClass=e,s}}function x(e,t){return null==t.get?function(){return this.__accessor__.getterStatic(e)}:function(){return this.__accessor__.getterComputed(e)}}function $(e){const t=e.prototype,n=t.declaredClass,o=r(t).properties;!function(e,t){for(const r of N)if(r.processClassPropertyMetadata)for(const n in e){const o=e[n];r.processClassPropertyMetadata(n,o,e,t)}}(o,n);const i={};for(const e of Object.getOwnPropertyNames(o)){const t=o[e];i[e]={enumerable:!0,configurable:!0,get:x(e,t),set(r){const n=this.__accessor__;if(void 0!==n){if(!Object.isFrozen(this)){if(n.initialized&&t.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${e}' of ${this.declaredClass}`);if(2===n.lifecycle&&t.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${e}' of ${this.declaredClass}`);n.set(e,r)}}else Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:r})}}}Object.defineProperties(e.prototype,i)}export{i as W,C as a,M as b,u as c,A as n,_ as o,$ as processClass,S as subclass};
