/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../core/lang.js";import"../../chunks/deprecate.js";import"../../chunks/object.js";import"../../kernel.js";import"../../config.js";import{L as t,u as s,b as r}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{createAbortController as i}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import n from"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import l from"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/shared.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import p from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import{geographicToWebMercator as u}from"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../portal/PortalItem.js";import"../../chunks/mathUtils2.js";import"../../chunks/vec3f64.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import c from"../../support/actions/ActionBase.js";import m from"../../support/actions/ActionButton.js";import h from"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import d from"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols.js";import"../../chunks/uid.js";import g from"../../Graphic.js";import j from"../../core/Handles.js";import y from"../../layers/Layer.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../tasks/support/ColorRamp.js";import"../../tasks/support/AlgorithmicColorRamp.js";import"../../tasks/support/MultipartColorRamp.js";import"../../chunks/colorRamps.js";import"../../renderers/Renderer.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/VisualVariablesMixin.js";import"../../chunks/symbolConversion.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/ClassBreaksRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/normalizeUtilsCommon.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/MemCache.js";import"../../chunks/ItemCache.js";import"../../chunks/utils3.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/LRUCache.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import"../../TimeInterval.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../chunks/MultiOriginJSONSupport.js";import{init as f,watch as b,whenFalse as w}from"../../core/watchUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/fieldType.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/OperationalLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/commonProperties2.js";import"../../chunks/Scheduler.js";import"../../core/HandleOwner.js";import"../../core/workers/RemoteClient.js";import"../../core/workers/Connection.js";import"../../core/workers/workers.js";import"../../form/ExpressionInfo.js";import"../../form/elements/FieldElement.js";import"../../form/support/elements.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/support/inputs.js";import"../../form/elements/GroupElement.js";import"../../form/FormTemplate.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../layers/FeatureLayer.js";import"../../chunks/ArcGISService.js";import"../../chunks/BlendLayer.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/PortalLayer.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../layers/support/TimeInfo.js";import"../../chunks/TemporalLayer.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../chunks/labelUtils.js";import"../../layers/support/LabelClass.js";import"../../chunks/defaultsJSON.js";import"../../chunks/defaults.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/DataLayerSource.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../chunks/utils4.js";import"../../tasks/Task.js";import"../../rest/query/support/AttachmentInfo.js";import"../../chunks/query.js";import"../../chunks/executeRelationshipQuery.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import{getDisplayedSymbol as v}from"../../symbols/support/symbolUtils.js";import"../../chunks/throttle.js";import"../Attachments/AttachmentsViewModel.js";import F from"../Feature/FeatureViewModel.js";import{A as C}from"../../chunks/AnchorElementViewModel.js";import"../../chunks/Queue.js";import{V as k}from"../../chunks/InputManager.js";import{h as P}from"../../chunks/layerViewUtils.js";import{z as _,a as S,b as I,r as V}from"../../chunks/actions.js";import{G as M}from"../../chunks/GoTo.js";const E=t.getLogger("esri.widgets.Popup.PopupViewModel"),L=function(e){const{event:t,view:s}=e,{action:r}=t,o=s&&s.popup;if(!r)return Promise.reject(new n("trigger-action:missing-arguments","Event has no action"));if(!o)return Promise.reject(new n("trigger-action:missing-arguments","view.popup is missing"));const{disabled:i,id:a}=r;if(!a)return Promise.reject(new n("trigger-action:invalid-action","action.id is missing"));if(i)return Promise.reject(new n("trigger-action:invalid-action","Action is disabled"));if(a===_.id)return async function(e){const{location:t,selectedFeature:s,view:r,zoomFactor:o}=e,i=x(e);if(!i){const e=new n("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:i,view:r});return E.error(e),Promise.reject(e)}const a=r.scale/o,l=e.get("selectedFeature.geometry")||t,p=l&&"point"===l.type&&function(e,t){if("3d"!==(null==t?void 0:t.type)||!e||"esri.Graphic"!==e.declaredClass)return!0;const s=t.getViewForGraphic(e);if(s&&"whenGraphicBounds"in s){let t=!1;return s.whenGraphicBounds(e,{useViewElevation:!0}).then((e=>{t=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((()=>{const t=new n("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});E.error(t)})),t}return!0}(s,r);_.active=!0,_.disabled=!0,await e.view.goTo({target:i,scale:p?a:void 0}),_.active=!1,_.disabled=!1,e.zoomToLocation=null,p&&(e.location=l)}(o.viewModel);if(a===S.id)return async function(e){const{selectedFeature:t,view:s}=e;if("2d"!==(null==s?void 0:s.type)){const e=new n("zoomToCluster:invalid-view","View must be 2d MapView.",{view:s});throw E.error(e),e}if(!t.isAggregate){const e=new n("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw E.error(e),e}const r=t.sourceLayer,o=await s.whenLayerView(r),i=o.createQuery();i.aggregateIds=[t.getObjectId()],S.active=!0,S.disabled=!0;const{extent:a}=await o.queryExtent(i);await s.goTo({target:a}),S.active=!1,S.disabled=!1}(o.viewModel);if(o.viewModel.browseClusterEnabled=!1,a===I.id&&(o.featureMenuOpen=!0,o.viewModel.browseClusterEnabled=!0),a===V.id){o.close();const{selectedFeature:e}=o;if(!e)return Promise.reject(new n(`trigger-action:${V.id}`,"selectedFeature is required",{selectedFeature:e}));const{sourceLayer:t}=e;return t?t.remove(e):s.graphics.remove(e),Promise.resolve()}return Promise.resolve()};function x(e){const{selectedFeature:t,location:s,view:r}=e;if(!r)return null;if("3d"===r.type)return t||s;return e.get("selectedFeature.geometry")||s}const A=l.ofType({key:"type",defaultKeyValue:"button",base:c,typeMap:{button:m,toggle:h}}),O=t.getLogger("esri.widgets.Popup.PopupViewModel");let U=class extends(M(C)){constructor(e){super(e),this._handles=new j,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._selectedClusterFeature=null,this.featurePage=null,this.featuresPerPage=20,this.actions=new A,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new g({symbol:new d({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}get isLoadingFeature(){return this.featureViewModels.some((e=>e.waitingForContent))}initialize(){this._handles.add([f(this,["autoOpenEnabled","view"],(()=>this._autoOpenEnabledChange())),this.on("view-change",(()=>this._autoClose())),b(this,["highlightEnabled","selectedFeature","visible","view"],(()=>this._highlightFeature())),b(this,"view.animation.state",(e=>this._animationStateChange(e))),b(this,"location",(e=>this._locationChange(e))),b(this,"selectedFeature",(e=>this._selectedFeatureChange(e))),b(this,["selectedFeatureIndex","featureCount","featuresPerPage"],(()=>this._selectedFeatureIndexChange())),b(this,["featurePage","selectedFeatureIndex","featureCount","featuresPerPage, featureViewModels"],(()=>this._setGraphicOnFeatureViewModels())),b(this,"featureViewModels",(()=>this._featureViewModelsChange())),this.on("trigger-action",(e=>L({event:e,view:this.view}))),w(this,"waitingForResult",(()=>this._waitingForResultChange())),b(this,["features","view","view.map","view.spatialReference"],(()=>this._updateFeatureVMs())),b(this,["view.scale"],this._viewScaleChange),w(this,"visible",(()=>this.browseClusterEnabled=!1)),b(this,"browseClusterEnabled",(e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing()))])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new A;e.removeAll();const{actions:t,defaultActions:s,defaultPopupTemplateEnabled:r,includeDefaultActions:o,selectedFeature:i}=this,n=o?s.concat(t):t,a=i&&("function"==typeof i.getEffectivePopupTemplate&&i.getEffectivePopupTemplate(r)||i.popupTemplate),l=a&&a.actions,p=a&&a.overwriteActions?l:l?l.concat(n):n;return p&&p.filter(Boolean).forEach((t=>e.add(t))),e}get defaultActions(){var e;const t=this._get("defaultActions")||new A;return t.removeAll(),t.addMany(null!=(e=this.selectedFeature)&&e.isAggregate?[S.clone(),I.clone()]:[_.clone()]),t}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:s,promiseCount:r,selectedFeatureIndex:o}=this,i=r&&t.length;i&&s&&-1===o?this.selectedFeatureIndex=0:i&&-1!==o||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=u(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach((e=>{this._pendingPromises.add(e);e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t),this._updatePendingPromises(e)}),(()=>this._updatePendingPromises(e)))})),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;if(-1===t)return null;return e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=x(this);if(!t){const s=new n("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return O.error(s),Promise.reject(s)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:s}=this;if(!s||!e){const t=new n("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:s});return O.error(t),Promise.reject(t)}return s.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:s}=t;delete t.fetchFeatures,s&&this._setFetchFeaturesPromises(t.location),this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){var e;(e=this).features=e.features.filter((e=>e.isAggregate)),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){await async function(e){const{selectedFeature:t,view:s}=e;if("2d"!==(null==s?void 0:s.type)){const e=new n("displayClusterExtent:invalid-view","View must be 2d MapView.",{view:s});throw E.error(e),e}if(!t.isAggregate){const e=new n("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw E.error(e),e}const r=t.sourceLayer,o=await s.whenLayerView(r),i=o.createQuery();i.aggregateIds=[t.getObjectId()];const{extent:a}=await o.queryExtent(i);e.selectedClusterBoundaryFeature.geometry=a,s.graphics.add(e.selectedClusterBoundaryFeature)}(this),await async function(e){const{selectedFeature:t,view:s}=e;if("2d"!==(null==s?void 0:s.type)){const e=new n("browseAggregateFeatures:invalid-view","View must be 2d MapView.",{view:s});throw E.error(e),e}if(!t.isAggregate){const e=new n("browseAggregateFeatures:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw E.error(e),e}const r=t.sourceLayer,o=await s.whenLayerView(r),i=o.createQuery();i.aggregateIds=[t.getObjectId()],I.active=!0,I.disabled=!0;const{features:a}=await o.queryFeatures(i);I.active=!1,I.disabled=!1,e.features=[t].concat(a)}(this)}_animationStateChange(e){this.zoomToLocation||(_.disabled="waiting-for-target"===e)}_clearBrowsedClusterGraphics(){var e;const t=null==(e=this.view)?void 0:e.graphics;t&&(t.remove(this.selectedClusterBoundaryFeature),t.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){var e;(null!=(e=this.selectedFeature)&&e.isAggregate||this.browseClusterEnabled)&&(this.browseClusterEnabled=!1,this.visible=!1)}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:s}=this;s&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:s,featuresPerPage:r,featureViewModels:o}=this;if(null===s)return;const i=((s-1)*r+t)%t,n=i+r;o.slice(i,n).forEach(((t,s)=>{t&&!t.graphic&&(t.graphic=e[i+s])}))}async _selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:r,view:o}=this;if(this.browseClusterEnabled){if(this._selectedClusterFeature&&(o.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),e.isAggregate)return;return e.symbol=await v(e),this._selectedClusterFeature=e,void o.graphics.add(this._selectedClusterFeature)}!r&&t||!e.geometry?r&&!e.geometry&&this.centerAtLocation().then((()=>{this.location=o.center.clone()})):this.location=s(this._getPointFromGeometry(e.geometry))}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:s}=e,r=Promise.resolve(t),o=s.map((e=>e.promise));this.promises=[r,...o]}))}_destroyFeatureVMs(){this.featureViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:s}=this;if(null!=e&&e.isAggregate||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t||!t.length)return;const r=s.slice(0),o=[];t.forEach(((t,s)=>{if(!t)return;let i=null;if(r.some(((e,s)=>(e&&e.graphic===t&&(i=e,r.splice(s,1)),!!i))),i)o[s]=i;else{var n,a;const r=new F({defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:null==(n=this.view)?void 0:n.spatialReference,graphic:t===e?t:null,map:null==(a=this.view)?void 0:a.map,view:this.view});o[s]=r}})),r.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",o)}_getScreenPoint(e){const{view:t}=this;return t&&e&&"function"==typeof t.toScreen?t.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:s}=this;if(t.remove(e),s&&this.view){const s=this.view.on("click",(e=>{"mouse"===e.pointerType&&0!==e.button||this._fetchFeaturesAndOpen(e)}),k.WIDGET);t.add(s,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const s=i(),{signal:r}=s;this._fetchFeaturesController=s,this.notifyChange("waitingForResult");const o=this.fetchFeatures(e,{signal:r,event:t});return o.catch((()=>{})).then((()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")})),o}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:s}=e,{view:r}=this;this._fetchFeaturesWithController(t,e).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:o,location:i}=e,n=[Promise.resolve(t),...o.map((e=>e.promise))];return r.popup.open({location:i||s,promises:n}),e}))}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_getPointFromGeometry(e){return r(e)?null:"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type||"polyline"===e.type?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:s,view:r,visible:o}=this;if(!(t&&r&&s&&o))return;let{layer:i,sourceLayer:n}=t;if(!(i&&i instanceof y))return;"map-notes"===(null==n?void 0:n.type)&&(i=n);const a=this._getLayerView(r,i);this._highlightPromise=a;const l=await a;if(!(l&&P(l)&&this._highlightPromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const p="objectIdField"in i&&i.objectIdField,u=t.attributes,c=u&&p&&u[p],m=l.highlight(c||t);this._handles.add(m,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const s=e.filter((e=>-1===t.indexOf(e)));this.features=t.concat(s)}};e([o()],U.prototype,"featurePage",void 0),e([o()],U.prototype,"featuresPerPage",void 0),e([o()],U.prototype,"isLoadingFeature",null),e([o({type:A})],U.prototype,"actions",void 0),e([o({readOnly:!0})],U.prototype,"active",null),e([o({readOnly:!0})],U.prototype,"allActions",null),e([o({type:Boolean})],U.prototype,"defaultPopupTemplateEnabled",void 0),e([o()],U.prototype,"autoCloseEnabled",void 0),e([o()],U.prototype,"autoOpenEnabled",void 0),e([o()],U.prototype,"browseClusterEnabled",void 0),e([o()],U.prototype,"content",void 0),e([o({type:A,readOnly:!0})],U.prototype,"defaultActions",null),e([o({readOnly:!0})],U.prototype,"featureCount",null),e([o()],U.prototype,"features",null),e([o({readOnly:!0})],U.prototype,"featureViewModels",void 0),e([o()],U.prototype,"highlightEnabled",void 0),e([o()],U.prototype,"includeDefaultActions",void 0),e([o({type:p})],U.prototype,"location",null),e([o({readOnly:!0})],U.prototype,"pendingPromisesCount",null),e([o({readOnly:!0})],U.prototype,"selectedClusterBoundaryFeature",void 0),e([o({readOnly:!0})],U.prototype,"waitingForResult",null),e([o({readOnly:!0})],U.prototype,"promiseCount",null),e([o()],U.prototype,"promises",null),e([o({value:null,readOnly:!0})],U.prototype,"selectedFeature",null),e([o({value:-1})],U.prototype,"selectedFeatureIndex",null),e([o({readOnly:!0})],U.prototype,"selectedFeatureViewModel",null),e([o({readOnly:!0})],U.prototype,"state",null),e([o()],U.prototype,"title",void 0),e([o()],U.prototype,"updateLocationEnabled",void 0),e([o()],U.prototype,"view",void 0),e([o()],U.prototype,"visible",void 0),e([o()],U.prototype,"zoomFactor",void 0),e([o()],U.prototype,"zoomToLocation",void 0),e([o()],U.prototype,"centerAtLocation",null),U=e([a("esri.widgets.Popup.PopupViewModel")],U);var R=U;export default R;
