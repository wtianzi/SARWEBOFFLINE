/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../core/lang.js";import"../../chunks/deprecate.js";import"../../chunks/object.js";import"../../kernel.js";import"../../config.js";import{b as t,i,u as o,L as r,d as s,h as n,g as a}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import c,{r as l}from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{eachAlwaysValues as h,throwIfAborted as d,isAborted as u,createAbortError as m,createAbortController as y,whenOrAbort as g}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import v from"../../core/Error.js";import{n as f}from"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as _}from"../../core/accessorSupport/decorators/subclass.js";import{E as w}from"../../chunks/Evented.js";import G from"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/shared.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import b from"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import j from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../portal/PortalItem.js";import{f as S,s as k}from"../../chunks/mathUtils2.js";import{c as C}from"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import{c as x}from"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import I from"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import{c as T,a as E}from"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import P from"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import O from"../../symbols/SimpleFillSymbol.js";import A from"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import{symbolTypes as M}from"../../symbols.js";import"../../chunks/uid.js";import L from"../../Graphic.js";import H from"../../core/Handles.js";import"../../layers/Layer.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../tasks/support/ColorRamp.js";import"../../tasks/support/AlgorithmicColorRamp.js";import"../../tasks/support/MultipartColorRamp.js";import"../../chunks/colorRamps.js";import"../../renderers/Renderer.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../chunks/sizeVariableUtils.js";import{e as R}from"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/VisualVariablesMixin.js";import"../../chunks/symbolConversion.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/ClassBreaksRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/normalizeUtilsCommon.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/MemCache.js";import"../../chunks/ItemCache.js";import"../../chunks/utils3.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/LRUCache.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import"../../TimeInterval.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../chunks/MultiOriginJSONSupport.js";import{init as D,watch as U,on as F,when as V,whenNotOnce as q,whenOnce as K}from"../../core/watchUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/fieldType.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/projection.js";import"../../chunks/OperationalLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/commonProperties2.js";import"../../chunks/Scheduler.js";import{HandleOwner as z}from"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import"../../core/workers/RemoteClient.js";import"../../core/workers/Connection.js";import"../../core/workers/workers.js";import"../../form/ExpressionInfo.js";import"../../form/elements/FieldElement.js";import"../../form/support/elements.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/support/inputs.js";import"../../form/elements/GroupElement.js";import"../../form/FormTemplate.js";import"../../geometry/support/geodesicUtils.js";import W from"../../geometry/Circle.js";import"../../chunks/vec4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import{f as Z,p as B,a as N,b as Q,l as Y,d as X,i as J,q as $,c as ee,j as te,m as ie}from"../../chunks/vec2.js";import"../../chunks/vec4.js";import"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../support/widget.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../layers/FeatureLayer.js";import"../../chunks/ArcGISService.js";import"../../chunks/BlendLayer.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/PortalLayer.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../layers/support/TimeInfo.js";import"../../chunks/TemporalLayer.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../chunks/labelUtils.js";import"../../layers/support/LabelClass.js";import"../../chunks/defaultsJSON.js";import"../../chunks/defaults.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/DataLayerSource.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../chunks/GraphicsCollection.js";import oe from"../../layers/GraphicsLayer.js";import"../../chunks/utils4.js";import"../../tasks/Task.js";import"../../rest/query/support/AttachmentInfo.js";import"../../chunks/query.js";import"../../chunks/executeRelationshipQuery.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/vec4f32.js";import"../../chunks/quantizationUtils.js";import"../../chunks/mat2d.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/byteSizeEstimations.js";import"../../chunks/dehydratedFeatureComparison.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import{i as re}from"../../chunks/interactiveToolUtils.js";import"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/Queue.js";import{V as se}from"../../chunks/InputManager.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../Popup/PopupViewModel.js";import"../../chunks/GoTo.js";import{s as ne}from"../../chunks/MapUtils.js";import{b as ae}from"../../chunks/screenUtils2.js";import"../../chunks/mat2df64.js";import{c as pe,a as ce,f as le}from"../../chunks/vec2f64.js";import"../../chunks/requestImageUtils.js";import"../../chunks/VertexColor.glsl.js";import"../../chunks/Program.js";import"../../chunks/FramebufferObject.js";import"../../chunks/renderState.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import"../../chunks/stack.js";import"../../chunks/geometryUtils.js";import"../../chunks/ColorMaterial.js";import"../../chunks/Util.js";import"../../chunks/glUtil3D.js";import"../../chunks/Object3D.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/sdfPrimitives.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/GLMaterialTexture.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/RibbonLineMaterial.js";import"../../chunks/Texture.js";import"../../chunks/CameraSpace.glsl.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{d as he}from"../../chunks/Settings.js";import de from"../../views/interactive/snapping/SnappingOptions.js";import{s as ue,b as me,d as ye,e as ge,o as ve,L as fe,P as _e,R as we,I as Ge}from"../../views/draw/DrawAction.js";import{c as be,h as je}from"../../chunks/elevationInfoUtils.js";import"../../chunks/AppendVertex.js";import"../../chunks/Keys.js";import"../../views/draw/MultipointDrawAction.js";import"../../chunks/InteractiveToolBase.js";import"../../chunks/DrawTool.js";import"../../chunks/VisualElement.js";import"../../chunks/LaserlineVisualElement.js";import"../../chunks/Object3DVisualElement.js";import"../../chunks/RightAngleQuadVisualElement.js";import"../../views/draw/PointDrawAction.js";import"../../views/draw/PolygonDrawAction.js";import"../../views/draw/PolylineDrawAction.js";import"../../views/draw/SegmentDrawAction.js";import Se from"../../views/draw/Draw.js";function ke(e){switch(e){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}function Ce(e){var i;if("graphics"!==(null==(i=e.layer)?void 0:i.type))return 1;if(t(e.geometry))return 2;switch(e.geometry.type){case"polygon":case"point":case"polyline":break;case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==be(e)&&je(e)?4:0}function xe(e){var i;if("graphics"!==(null==(i=e.layer)?void 0:i.type))return 1;const o=e.geometry;if(t(o))return 2;switch(o.type){case"polygon":if(o instanceof W)return 3;break;case"polyline":break;case"point":case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==be(e)&&je(e)?4:0}let Ie=null;async function Te(){return Ie||(Ie=await import("../../chunks/createUtils.js")),Ie}function Ee(e,t){if(!t||!e||!e.map)return;const{map:i}=e;i.layers.find((e=>e===t))||i.add(t)}class Pe{constructor(e,t,i){this.coordinateHelper=e,this.targetPoint=t,this.constraint=i}}class Oe extends Pe{constructor({coordinateHelper:e,targetPoint:t,objectId:i,constraint:o}){super(e,t,o),this.objectId=i}}let Ae=class extends z{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return ne(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,o=new Map;if(null!=(e=this.options)&&e.featureSources)for(const e of this.options.featureSources.items){const r=e.layer.uid,s=t.get(r);if(s){t.delete(r),o.set(r,s);continue}if(!e.layer.loaded){this.updatingHandles.addPromise(e.layer.load());continue}const n=this.createSourceInfo(e);i(n)&&o.set(r,n)}for(const[,e]of t)e.destroy();return o}initialize(){var e;(this.updatingHandles.add(this,"snappingSources",(()=>{this.notifyChange("updating")}),1),i(this.view))&&this.handles.add([null==(e=this.view.refreshManager)?void 0:e.on("refresh",(e=>{"interval"===e.trigger&&this.refreshSourceOfLayer(e.layerView.layer)})),this.view.on("layerview-create",(e=>this.updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this.updateLayerView(e.layer,null)))])}refreshSourceOfLayer(e){for(const[,{snappingSource:t}]of this.snappingSources)t.layerSource.layer===e&&t.refresh()}updateLayerView(e,t){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===e&&(i.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,o){if(!this.options.effectiveFeatureEnabled)return[];const r=[],s={distance:this.computeScreeenSizeDistanceParameters(e,t),point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:e,layerView:n}]of this.snappingSources)!e.layerSource.enabled||i(n)&&n.suspended||r.push(e.fetchCandidates(s,o).then((({candidates:i})=>i.filter((i=>!this.candidateIsExcluded(e,i,t.excludeFeature))))));const n=(await h(r)).flat();return d(o),ue(e,n),n}computeScreeenSizeDistanceParameters(e,i){const o=this.options.distance*("touch"===i.pointer?this.options.touchSensitivityMultiplier:1);return t(this.view)?o:"2d"===this.view.type?o*this.view.resolution:this.computeScreeenSizeDistanceParameters3D(e,o,this.view,i)}computeScreeenSizeDistanceParameters3D(e,t,i,o){const{coordinateHelper:r,elevationInfo:s}=o,n=i.state.camera.computeScreenPixelSizeAt(me(e,r,s,i,Le))*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,a=t*n;return{x:a/this.computeScreenMagnitudeOfMapOffset(e,n,0,i,o),y:a/this.computeScreenMagnitudeOfMapOffset(e,0,n,i,o)}}computeScreenMagnitudeOfMapOffset(e,t,i,o,{coordinateHelper:r,elevationInfo:s}){const n=r.clone(e);n[0]+=t,n[1]+=i;const a=ye(e,r,s,o),p=ye(n,r,s,o),c=p.x-a.x,l=p.y-a.y;return Math.sqrt(c*c+l*l)}get types(){return 3}candidateIsExcluded(e,i,o){if(t(o))return!1;const r=this.getCandidateObjectId(i);if(t(r))return!1;const s=e.layerSource.layer;return"graphics"===s.type?o.uid===r:o.sourceLayer===s&&(!(!o.attributes||!("objectIdField"in s))&&o.attributes[s.objectIdField]===r)}getCandidateObjectId(e){return e instanceof Oe?e.objectId:null}createSourceInfo(e){const o=this.createFeatureSnappingSourceType(e);if(t(o))return null;if("loading"in o)return this.updatingHandles.addPromise(o.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const r=i(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new Me(o.source,r)}createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":return this.createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(e)}return null}createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this.getSourceModule("featureService");return i(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":{if("mesh"===e.layer.geometryType)return null;const t=this.getSourceModule("featureCollection");return i(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}createFeatureSnappingSourceGraphicsLayer(e){const t=this.getSourceModule("graphics");return i(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}getSourceModule(e){const i=this.sourceModules[e];if(t(i.loader)){const t=this.loadSourceModule(e).then((e=>{i.module=e}));return i.loader=t,{module:i.module,loader:t}}return{module:i.module,loader:i.loader}}loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(import("../../chunks/FeatureServiceSnappingSource.js"));case"featureCollection":return this.updatingHandles.addPromise(import("../../chunks/FeatureCollectionSnappingSource.js"));case"graphics":return this.updatingHandles.addPromise(import("../../chunks/GraphicsSnappingSource.js"))}return null}};e([p({constructOnly:!0})],Ae.prototype,"spatialReference",void 0),e([p({constructOnly:!0})],Ae.prototype,"view",void 0),e([p()],Ae.prototype,"options",void 0),e([p({readOnly:!0})],Ae.prototype,"updating",null),e([p({readOnly:!0})],Ae.prototype,"snappingSources",null),Ae=e([_("esri.views.interactive.snapping.FeatureSnappingEngine")],Ae);class Me{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new H;const i=this.snappingSource.layerSource.layer;if("refresh"in i){const t=i;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([D(e,"updating",(t=>e.layerSource.updating=t),!0),D(e,"availability",(t=>e.layerSource.availability=t),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const Le=C();class He{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=he.shortLineThreshold*he.shortLineThreshold}snap(e,t){return i(t.vertexHandle)?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.left.pos,e.right.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:i,geometry:o}){const r=o.editGeometry.coordinateHelper;return 0===this.squaredShortLineThreshold||ge(ye(t,r,i,this.view),ye(e,r,i,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}function Re(e,t){return e[0]*t[1]-e[1]*t[0]}function De(e,t,i){const o=(t[0]-e[0])*(i[1]-e[1])-(t[1]-e[1])*(i[0]-e[0]);return Math.abs(o)/X(t,i)}function Ue(e,t,i,o,r=i){return N(Ze,o,i),N(Ne,t,r),function(e,t,i){const o=J(i,t)/$(i);Q(e,i,o)}(Qe,Ne,Ze),Z(e,r,Qe)}function Fe(e,t,i,o){N(Ze,o,i),N(Ne,t,i);const r=J(Ze,Ne)/$(Ze);return r>0?B(e,i,Ze,r):ee(e,i)}function Ve(e,t,i,o){N(Ze,t,i);const r=o/Y(Ze);return B(e,i,Ze,r)}function qe(e,t){return Ue(Ne,t,e.start,e.end),S(Ne[0],t[0])&&S(Ne[1],t[1])?[ce(t)]:[]}function Ke(e,t,i){return Ve(Ne,i,e,t),S(Ne[0],i[0])&&S(Ne[1],i[1])?[ce(i)]:[]}function ze(e,t,i){const o=[],r=N(Ze,e.end,e.start),s=N(Be,e.start,t),n=$(r),a=2*J(r,s),p=a*a-4*n*($(s)-i*i);if(0===p){const t=-a/(2*n);(1===e.type||t>=0)&&o.push(B(Qe,e.start,r,t))}else if(p>0){const t=Math.sqrt(p),i=(-a+t)/(2*n);(1===e.type||i>=0)&&o.push(B(Qe,e.start,r,i));const s=(-a-t)/(2*n);(1===e.type||s>=0)&&o.push(B(Ne,e.start,r,s))}return o}const We=1e-6,Ze=pe(),Be=pe(),Ne=pe(),Qe=pe();class Ye{constructor(e){this.coordinateHelper=e}}class Xe extends Ye{constructor(e,t){super(e),this.point=t}objectEqual(e){return e instanceof Xe&&ve(this.point,e.point)}check(e){return te(e,this.point)<he.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const t=[];return e instanceof Je?t.push(...qe({start:e.start,end:e.end,type:e instanceof et?1:0},this.point)):e instanceof it&&t.push(...Ke(e.center,e.radius,this.point)),t.map((t=>new tt(this.coordinateHelper,t,this,e)))}}class Je extends Ye{constructor(e,t,i){super(e),this.start=t,this.end=i}objectEqual(e){return e instanceof Je&&(ve(this.start,e.start)&&ve(this.end,e.end))}intersect(e){const t=[];return e instanceof Xe?t.push(...qe({start:this.start,end:this.end,type:this instanceof et?1:0},e.point)):e instanceof Je?t.push(...function(e,t){const i=e.start,o=e.end,r=t.start,s=t.end,n=N(Ze,o,i),a=N(Be,s,r),p=Re(n,a);if(Math.abs(p)<=We)return[];const c=N(Ne,i,r),l=Re(a,c)/p,h=Re(n,c)/p;if(l>=0){if(h>=0||1===t.type)return[B(Qe,i,n,l)]}else if(1===e.type&&(h>=0||1===t.type))return[B(Qe,i,n,l)];return[]}({start:this.start,end:this.end,type:this instanceof et?1:0},{start:e.start,end:e.end,type:e instanceof et?1:0})):e instanceof it&&t.push(...ze({start:this.start,end:this.end,type:this instanceof et?1:0},e.center,e.radius)),t.map((t=>new tt(this.coordinateHelper,t,this,e)))}}class $e extends Je{constructor(e,t,i){super(e,t,i),this.dir=pe(),this.p=pe()}objectEqual(e){return e instanceof $e&&super.objectEqual(e)}check(e){return N(this.dir,this.end,this.start),N(this.p,e,this.start),J(this.dir,this.p)>=0&&De(e,this.start,this.end)<he.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Fe(t,e,this.start,this.end),t}}class et extends Je{constructor(e,t,i){super(e,t,i)}objectEqual(e){return e instanceof et&&super.objectEqual(e)}check(e){return De(e,this.start,this.end)<he.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Ue(t,e,this.start,this.end),t}}class tt extends Ye{constructor(e,t,i,o){super(e),this.intersection=t,this.first=i,this.second=o}objectEqual(e){return e instanceof tt&&(this.first.objectEqual(e.first)&&this.second.objectEqual(e.second))}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return ee(t,this.intersection),t}intersect(){return[]}}class it extends Ye{constructor(e,t,i){super(e),this.center=t,this.radius=i}objectEqual(e){return e instanceof it&&(this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius)}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return Ve(t,e,this.center,this.radius),t}intersect(e){const t=[];return e instanceof Je?t.push(...ze({start:e.start,end:e.end,type:e instanceof et?1:0},this.center,this.radius)):e instanceof Xe&&t.push(...Ke(this.center,this.radius,e.point)),t.map((t=>new tt(this.coordinateHelper,t,this,e)))}}class ot extends Pe{constructor({coordinateHelper:e,lineStart:t,lineEnd:i,targetPoint:o}){super(e,o,new et(e,t,i)),this.referenceLineHint=new fe(2,t,i)}get hints(){return[this.referenceLineHint,new fe(0,this.lineEndClosestToTarget(),this.targetPoint)]}lineEndClosestToTarget(){const e=this.constraint.start,t=this.constraint.end;return k(J(N(st,t,e),N(rt,this.targetPoint,e)))>0?t:e}}const rt=pe(),st=pe();class nt extends He{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.edges.length,r=[];if(o<1)return r;const s=t.coordinateHelper,n=ye(e,s,t.elevationInfo,this.view),a=i.edges[o-1];let p=a;do{this.edgeExceedsShortLineThreshold(p,t)&&this._processCandidateProposal(p.left.pos,p.right.pos,e,n,t,r),p=p.left.left}while(p&&p!==a);return r}snapExistingVertex(e,t){const i=[],r=o(t.vertexHandle),s=r.component;if(s.edges.length<2)return i;const n=t.coordinateHelper,a=ye(e,n,t.elevationInfo,this.view),p=r.left,c=r.right;p&&c&&this.edgeExceedsShortLineThreshold(p,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal(p.left.pos,c.right.pos,e,a,t,i);const l=s.edges[0];let h=l;do{h!==r.left&&h!==r.right&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.left.pos,h.right.pos,e,a,t,i),h=h.right.right}while(h&&h!==l);return i}_processCandidateProposal(e,t,i,o,r,s){const n=Ue(pe(),i,e,t),a=r.coordinateHelper,p=a.fromXYZ(n,a.getZ(i,0));ge(o,ye(p,a,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)&&s.push(new ot({coordinateHelper:r.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:p}))}}class at extends Pe{constructor({coordinateHelper:e,referenceLine:t,lineStart:i,targetPoint:o}){const r=e.clone(i);N(r,Z(r,r,t.right.pos),t.left.pos),super(e,o,new et(e,i,r)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new fe(0,this.constraint.start,this.targetPoint),new _e(this.constraint.start,this.targetPoint),...this._referenceLines.map((e=>new fe(1,e.edge.left.pos,e.edge.right.pos,e.fadeLeft,e.fadeRight)))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((i=>{e.right.right===i.edge&&(i.fadeLeft=!1,t.fadeRight=!1),e.left.left===i.edge&&(i.fadeRight=!1,t.fadeLeft=!1)})),this._referenceLines.push(t)}}class pt extends He{constructor(){super(...arguments),this._tmpProjection=pe()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.edges.length,r=i.vertices.length,s=[];if(o<2)return s;const n=ye(e,t.coordinateHelper,t.elevationInfo,this.view),a=i.vertices[r-1],p=i.vertices[0],c=i.edges[o-1];let l=c;do{this.edgeExceedsShortLineThreshold(l,t)&&(this._checkEdgeForParalleLines(l,a.pos,e,n,t,s),this._checkEdgeForParalleLines(l,p.pos,e,n,t,s)),l=l.left.left}while(l&&l!==c);return s}snapExistingVertex(e,t){const i=[],r=o(t.vertexHandle),s=r.component;if(s.edges.length<3)return i;const n=ye(e,t.coordinateHelper,t.elevationInfo,this.view),a=r.left,p=r.right,c=s.vertices[0],l=s.vertices.length,h=s.vertices[l-1],d=s.edges[0];let u=d;do{u!==a&&u!==p&&this.edgeExceedsShortLineThreshold(u,t)&&(a&&this._checkEdgeForParalleLines(u,a.left.pos,e,n,t,i),p&&this._checkEdgeForParalleLines(u,p.right.pos,e,n,t,i),r===c?this._checkEdgeForParalleLines(u,h.pos,e,n,t,i):r===h&&this._checkEdgeForParalleLines(u,c.pos,e,n,t,i)),u=u.right.right}while(u&&u!==d);return i}_checkEdgeForParalleLines(e,t,i,o,r,s){const n=e.left.pos,a=e.right.pos;if(Ue(this._tmpProjection,t,n,a),te(this._tmpProjection,t)<he.parallelLineThreshold)return;Ue(this._tmpProjection,i,n,a,t);const p=r.coordinateHelper,c=p.fromXYZ(this._tmpProjection,p.getZ(i,0));if(ge(o,ye(c,p,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)){if(this.parallelToPreviousCandidate(e,s))return;s.push(new at({coordinateHelper:p,referenceLine:e,lineStart:t,targetPoint:c}))}}parallelToPreviousCandidate(e,t){const i=e.left.pos,o=e.right.pos;for(const r of t)if(Ue(this._tmpProjection,o,r.constraint.start,r.constraint.end,i),te(this._tmpProjection,o)<he.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}class ct extends Pe{constructor({coordinateHelper:e,targetPoint:t,constraint:i,previousVertex:o,centerVertex:r}){super(e,t,i),this.previousVertex=o,this.centerVertex=r,this.referenceLine=new fe(1,o,i.start)}get hints(){return[new fe(0,this.constraint.start,this.targetPoint),this.referenceLine,new we(this.previousVertex,this.centerVertex,this.targetPoint)]}}class lt extends He{constructor(){super(...arguments),this._tmp=pe()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.vertices.length,r=[];if(o<2)return r;const s=ye(e,t.coordinateHelper,t.elevationInfo,this.view),n=i.vertices[o-1];this._checkForSnappingCandidate(r,n.left,n.pos,e,n.left.left.pos,n.pos,t,e,s);const a=i.vertices[0];return this._checkForSnappingCandidate(r,a.right,a.pos,e,a.right.right.pos,a.pos,t,e,s),r}snapExistingVertex(e,t){const i=[],r=o(t.vertexHandle),s=r.component,n=s.vertices.length;if(n<3)return i;const a=ye(e,t.coordinateHelper,t.elevationInfo,this.view),p=r.left,c=r.right,l=s.vertices[0],h=s.vertices[n-1];if(!p)return this._checkForSnappingCandidate(i,l.right.right.right,l.right.right.pos,e,l.right.right.right.right.pos,l.right.right.pos,t,e,a),i;if(!c)return this._checkForSnappingCandidate(i,h.left.left.left,h.left.left.pos,e,h.left.left.left.left.pos,h.left.left.pos,t,e,a),i;if(p&&p.left.left){const o=p.left.left;this._checkForSnappingCandidate(i,o,p.left.pos,e,o.left.pos,p.left.pos,t,e,a)}if(c&&c.right.right){const o=c.right.right;this._checkForSnappingCandidate(i,o,c.right.pos,e,o.right.pos,c.right.pos,t,e,a)}return i}_checkForSnappingCandidate(e,t,i,o,r,s,n,a,p){if(!this.edgeExceedsShortLineThreshold(t,n))return;N(this._tmp,t.right.pos,t.left.pos);const c=le(this._tmp[1],-this._tmp[0]),l=J(c,N(this._tmp,o,i))/$(c),h=n.coordinateHelper,d=h.fromXYZ(B(pe(),s,c,l),h.getZ(a,0));ge(p,ye(d,h,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)&&e.push(new ct({coordinateHelper:h,targetPoint:d,constraint:new $e(h,s,B(h.createNew(),s,c,k(l))),previousVertex:r,centerVertex:s}))}}class ht extends Pe{constructor({coordinateHelper:e,targetPoint:t,point1:i,point2:o}){super(e,t,new it(e,ie(dt,i,o,.5),.5*X(i,o))),this.p1=i,this.p2=o}get hints(){return[new fe(1,this.targetPoint,this.p1),new fe(1,this.targetPoint,this.p2),new we(this.p1,this.targetPoint,this.p2)]}}const dt=pe();class ut extends He{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=[],r=i.vertices.length;if("polygon"!==t.geometry.type||r<2)return o;const s=i.vertices[0],n=i.vertices[r-1];return this._processCandidateProposal(s.pos,n.pos,e,t,o),o}snapExistingVertex(e,t){const i=[],r=o(t.vertexHandle),s=r.component;return s.edges.length<2?i:"polyline"!==t.geometry.type||0!==r.index&&r.index!==s.vertices.length-1?(this._processCandidateProposal(r.left.left.pos,r.right.right.pos,e,t,i),i):i}_processCandidateProposal(e,t,i,o,r){if(!this.exceedsShortLineThreshold(e,t,o))return;const s=ie(pe(),e,t,.5),n=.5*X(e,t),a=Ve(pe(),i,s,n),p=o.coordinateHelper,c=p.fromXYZ(a,p.getZ(i,0)),l=ye(i,p,o.elevationInfo,this.view);ge(l,ye(c,p,o.elevationInfo,this.view))<this.squaredProximityTreshold(o.pointer)&&r.push(new ht({coordinateHelper:p,targetPoint:c,point1:e,point2:t}))}}let mt=class extends c{constructor(e){super(e),this.updating=!1,this._snappers=new G}initialize(){this._snappers.push(new pt(this.view,this.options),new nt(this.view,this.options),new lt(this.view,this.options),new ut(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const o of this._snappers.items)i.push(...o.snap(e,t));return ue(e,i),i}};e([p({readOnly:!0})],mt.prototype,"updating",void 0),e([p({constructOnly:!0})],mt.prototype,"view",void 0),e([p()],mt.prototype,"options",null),mt=e([_("esri.views.interactive.snapping.SelfSnappingEngine")],mt);class yt extends Pe{constructor(e,t,i,o){super(e,t,new tt(e,t,i.constraint,o.constraint)),this.first=i,this.second=o}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Ge(this.targetPoint)]}}let gt=class extends(w.EventedMixin(z)){constructor(e){super(e),this.options=new de,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this.options=new de}initialize(){this.handles.add([l((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:o}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:o}}),(()=>{this.doneSnapping(),this.emit("changed")})),this.watch("options",(e=>{for(const t of this.engines)t.options=e}),!0),D(this.view,"ready",(e=>this.onViewReady(e)),!0)])}destroy(){this.destroyEngines()}get updating(){return this.engines.some((e=>e.updating))}onViewReady(e){var t,i;(this.destroyEngines(),e)&&(this.engines=[new mt({view:this.view,options:this.options}),new Ae({view:this.view,spatialReference:null!=(t=null==(i=this.view)?void 0:i.spatialReference)?t:b.WGS84,options:this.options})])}destroyEngines(){for(const e of this.engines)e.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}async snap(e,t,o){const r=t.coordinateHelper.fromPoint(e),s=await this.fetchCandidates(r,t,o);return{get valid(){return!u(o)},apply:()=>{const{snappedPoint:e,hints:o}=this.processCandidates(r,s,t);return this.removeVisualization(),i(t.visualizer)&&this.handles.add(t.visualizer.draw(o,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),vt),e}}}update(e,t){this.removeVisualization();let o=e;const r=[];if(i(this._currentMainCandidate)){const i=t.coordinateHelper,s=i.fromPoint(e),n=this._currentMainCandidate.constraint.closestTo(s);if(ge(ye(s,i,t.elevationInfo,this.view),ye(n,i,t.elevationInfo,this.view))<this.squaredPointProximityThreshold(t.pointer)){o=i.createDehydratedPoint(n),this._currentMainCandidate.targetPoint=n,r.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=n,r.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return i(t.visualizer)&&this.handles.add(t.visualizer.draw(r,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),vt),o}doneSnapping(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}removeVisualization(){this.handles.remove(vt)}async fetchCandidates(e,t,i){return(await Promise.all(this.engines.map((o=>o.fetchCandidates(e,t,i))))).flat()}processCandidates(e,t,o){if(t.length<1)return this.doneSnapping(),{snappedPoint:o.coordinateHelper.toPoint(e,new j),hints:[]};ue(e,t);const r=this._currentMainCandidate;if(i(r)){const i=this.findOldConstraintInNewCandidates(r,t);if(i>=0){if(!(t[i]instanceof yt))return this.intersectWithOtherCandidates(i,t,e,o);if(te(e,r.targetPoint)<this.squaredPointProximityThreshold(o.pointer))return this.updateSnappingCandidate(r,t,o)}}return this.intersectWithOtherCandidates(0,t,e,o)}findOldConstraintInNewCandidates(e,t){return e instanceof yt?this.findOldCandidateIndex(t,e.first)>=0&&this.findOldCandidateIndex(t,e.second)>=0?0:-1:this.findOldCandidateIndex(t,e)}intersectWithOtherCandidates(e,t,i,o){const r=t[e],s=[],n=o.coordinateHelper;for(let a=0;a<t.length;++a){if(a===e)continue;const p=t[a];for(const e of r.constraint.intersect(p.constraint)){const t=n.fromXYZ(e.intersection,r.targetPoint[2]);s.push([new yt(n,t,r,p),ge(ye(i,o.coordinateHelper,o.elevationInfo,this.view),ye(t,o.coordinateHelper,o.elevationInfo,this.view))])}}return s.length>0&&(s.sort(((e,t)=>e[1]-t[1])),s[0][1]<this.squaredPointProximityThreshold(o.pointer))?this.updateSnappingCandidate(s[0][0],t,o):this.updateSnappingCandidate(r,t,o)}updateSnappingCandidate(e,t,i){this.doneSnapping(),this._currentMainCandidate=e;const o=this._currentMainCandidate.targetPoint,r=[];r.push(...e.hints);for(const i of t){if(e instanceof yt){if(i.constraint.objectEqual(e.first.constraint)||i.constraint.objectEqual(e.second.constraint))continue}else if(i.constraint.objectEqual(e.constraint))continue;i.constraint.check(o)&&(i.targetPoint=o,this._currentOtherActiveCandidates.push(i),r.push(...i.hints))}return{snappedPoint:i.coordinateHelper.createDehydratedPoint(o),hints:r}}squaredPointProximityThreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}findOldCandidateIndex(e,t){let i=-1;for(let o=0;o<e.length;++o)if(t.constraint.objectEqual(e[o].constraint)){i=o;break}return i}get test(){return{visualizationsActive:this.handles.has(vt)}}};e([p({constructOnly:!0})],gt.prototype,"view",void 0),e([p()],gt.prototype,"options",void 0),e([p({readOnly:!0})],gt.prototype,"updating",null),e([p()],gt.prototype,"engines",void 0),e([p()],gt.prototype,"squaredMouseProximityTreshold",null),e([p()],gt.prototype,"squaredTouchProximityThreshold",null),gt=e([_("esri.views.interactive.snapping.SnappingManager")],gt);const vt="visualization-handle";let ft=class extends w.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw":case"draw-3d":return null;default:f(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type||e.refresh())}set undo(e){this._set("undo",(()=>{this.canUndo()&&e()}))}set redo(e){this._set("redo",(()=>{this.canRedo()&&e()}))}};e([p()],ft.prototype,"activeComponent",void 0),e([p()],ft.prototype,"cancelled",void 0),e([p()],ft.prototype,"history",void 0),e([p()],ft.prototype,"tool",null),e([p()],ft.prototype,"type",void 0),e([p()],ft.prototype,"canUndo",null),e([p()],ft.prototype,"canRedo",null),e([p()],ft.prototype,"onEnd",void 0),e([p()],ft.prototype,"undo",null),e([p()],ft.prototype,"redo",null),e([p()],ft.prototype,"toggleTool",void 0),e([p()],ft.prototype,"addToSelection",void 0),e([p()],ft.prototype,"removeFromSelection",void 0),ft=e([_("esri.widgets.Sketch.support.OperationHandle")],ft);const _t=r.getLogger("esri.widgets.Sketch.SketchViewModel"),wt={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Control",cancelKey:"Escape",deleteKeys:["Backspace","Delete"],complete:"c",pan:" "},Gt={defaultZ:0},bt={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0,enableMoveGraphic:!0};let jt=class extends w.EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new A({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new H,this._internalGraphicsLayer=new oe({listMode:"hide",internal:!0}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new H,this._doUnnormalization=!1,this._moveOperationCloneInfos=[],this.activeFillSymbol=new O({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new I({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}}),this.activeVertexSymbol=new A({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.layer=null,this.pointSymbol=new A({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new O({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new P({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new G,this.updateOnGraphicClick=!0,this.updatePointSymbol=new A({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new O({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new P({color:[12,207,255],width:2}),this.vertexSymbol=new A({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=Gt,this.defaultUpdateOptions=bt,this.snappingOptions=new de}initialize(){this._handles.add([U(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=i(this.layer)?this.layer.elevationInfo:null})),F(this,"view.map.layers","change",(e=>{e.removed.indexOf(this.layer)>=0&&this.cancel()})),F(this,"layer.graphics","change",(e=>{if(i(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),D(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=i(this.layer)?this.layer.elevationInfo:null}),!0),D(this,"view",(e=>{s(this._snappingManager),e&&(this._snappingManager=new gt({view:e,options:this.snappingOptions}))}),!0)])}destroy(){this.cancel(),this._handles=s(this._handles),this._viewHandles=s(this._viewHandles),this._removeDefaultLayer(),s(this._draw),s(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new Se({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&i(this.activeComponent)&&"draw-3d"===this.activeComponent.type?o(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...Gt,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...bt,...e})}set snappingOptions(e){i(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(V(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=n(this._moduleLoaderAbortController),this._viewReadyAbortController=n(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,o=t.toArray();i.removeMany(o),this.cancel(),this._emitDeleteEvent({graphics:o,tool:e})}}async create(e,i){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),m();if(this.cancel(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const o=await this._setupCreateOperation(e,i);if(t(o)||this.destroyed)return;Ee(this.view,this._internalGraphicsLayer);o.on("complete",(()=>{if(o===this._operationHandle){const t=this.createGraphic,i=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),o.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:i?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=o,this.view.ready&&re(this.view)&&this.view.focus()}async update(e,i){await this._waitViewReady();const{layer:o,view:r,state:s}=this;if("disabled"===s)throw r||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),m();this.cancel();const n=Array.isArray(e)?e:[e];if(null==e||!n||!n.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(n.some((e=>e.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):t(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===r.type&&!r.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const a=await this._setupUpdateOperation(n,i);this.destroyed||t(a)||It(a)||(Ee(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,i),this.emit("update",{graphics:n,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const r=await this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var i,o;const r=e.graphic;"vector-tile"!==(null==(i=r.layer)?void 0:i.type)&&"imagery"!==(null==(o=r.layer)?void 0:o.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&i.push(e)}));const o=await this.view.hitTest(e,{exclude:i});if(o.results.length>0){const e=o.results[0];(!o.ground.mapPoint||this.view.map.ground.opacity<1||o.ground.distance-e.distance>-Math.min(3*o.ground.distance,"global"===this.view.viewingMode?R(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(t=>{const{_operationHandle:o,defaultUpdateOptions:r,layer:s,state:n,updateGraphics:a,updateOnGraphicClick:p}=this,c="active"===n&&"create"===o.type;"disabled"!==n&&!c&&p&&(this._beginAsyncOperation(),this._getFirstHit(ae(t)).then((i=>{const o=i.results;if(o.length)for(let i=0;i<o.length;++i){const r=o[i];if(r.graphic){const i=r.graphic;if(a.indexOf(i)>-1||i.layer===s)return t.stopPropagation(),i;"2d"!==e.type||this._isComponentGraphic(i)||"active"!==n||this.cancel()}}else"active"===n&&this.cancel();return null})).then((e=>i(e)&&-1===a.indexOf(e)?this.update([e],{...r}):null)).then((()=>{this._endAsyncOperation()})))}),se.WIDGET)]}async _setupCreateOperation(e,i){if(!e)return null;const o={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...i};let r;if("2d"===this.view.type)switch(e){case"point":r=this._setupCreatePointOperation(e,o);break;case"multipoint":r=await this._setupCreateMultipointOperation(e,o);break;case"polygon":case"polyline":r=await this._setupCreatePolyOperation(e,o);break;case"rectangle":r=await this._setupCreateRectangleOperation(e,o);break;case"circle":r=await this._setupCreateCircleOperation(e,o)}else{const i=await this._setupCreate3DOperation(e,this.view,o);if(t(i)||It(i))return null;r=i}return r}async _setupCreate3DOperation(e,r,s){if("multipoint"===e)return null;const n={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol}[e];this._removeCreateOperationGraphics();const a="rectangle"!==e,p="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const c={view:r,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...s,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:n,snapToScene:!i(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingManager:this._snappingManager,forceUniformSize:p,centered:a},l=await this._requireModule(import("../../chunks/editingTools.js"));if(It(l))return l;if(this.destroyed)return null;const h=new l.module.DrawGraphicTool(c);this.view.tools.add(h);let d=null;this.view.activeTool=h;const u=[],m=new ft({activeComponent:h,tool:e,type:"update",onEnd:()=>{var e;u.forEach((e=>e.remove())),u.length=0,null==(e=this.view.tools)||e.remove(h),h.destroy()},undo:()=>{h.canUndo&&h.undo()},redo:()=>{h.canRedo&&h.redo()},canUndo:()=>h.canUndo,canRedo:()=>h.canRedo});return u.push(this.view.on("key-down",(t=>{t.key===wt.pan?(t.stopPropagation(),t.repeat||(h.enabled=!1)):t.key===wt.complete?(t.stopPropagation(),h.completeCreateOperation()):t.key===wt.undoKey?(t.stopPropagation(),m.undo()):t.key===wt.redoKey?(t.stopPropagation(),m.redo()):t.key!==wt.snappingKey||"rectangle"===e||"circle"===e||t.repeat?t.key!==wt.constraintKey||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===wt.centerKey&&(t.repeat||(h.centered=!a,t.stopPropagation())):(h.forceUniformSize=!p,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),se.WIDGET),this.view.on("key-up",(t=>{t.key===wt.pan?h.enabled=!0:t.key===wt.snappingKey&&"rectangle"!==e&&"circle"!==e?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==wt.constraintKey||"rectangle"!==e&&"circle"!==e?t.key===wt.centerKey&&(h.centered=a,t.stopPropagation()):(h.forceUniformSize=p,t.stopPropagation())}),se.WIDGET),h.on("vertex-add",(i=>{switch(d=t(d)?"start":"active",i.operation){case"apply":this.emit("create",{graphic:o(h.createGraphic),state:d,tool:this.activeTool,toolEventInfo:i,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[o(h.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[o(h.createGraphic)],tool:e})}})),h.on("cursor-update",(e=>{h.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:o(h.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),h.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:o(h.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[o(h.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[o(h.createGraphic)],tool:e})}})),h.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",o(e.graphic)),d="complete",e.aborted?m&&m.cancel():m&&m.complete()}))),m}_setupCreatePointOperation(e,t){const o={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,o),s=[r.on("cursor-update",(e=>{i(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),r.on("draw-complete",(e=>{const t=this.createPointFromVertex(e.vertices[0]),i=new L(t,this.pointSymbol);this._set("createGraphic",i),a&&a.complete()}))],n=[this.view.on("key-down",(e=>{e.key===wt.cancelKey&&(a&&a.cancel(),e.stopPropagation())}),se.WIDGET)],a=this._operationHandleForCreateAction(r,[...s,...n],e);return a}async _setupCreateMultipointOperation(e,t){const i=await Te(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,o);let s=null;const n=[],a=this._operationHandleForCreateAction(r,n,e);return n.push(r.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-remove",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-update",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}]},type:"create"})})),r.on("cursor-update",(e=>{s=e})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0),o=i.createMultipoint(t,this.view.spatialReference);o&&this.createGraphic&&(this.createGraphic.geometry=o),a&&a.complete()})),r.on("undo",(e=>{const t=e.vertices,o=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)})),r.on("redo",(e=>{const t=e.vertices,o=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)}))),n.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),se.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(a,e)),se.WIDGET)),a}async _setupCreatePolyOperation(e,t){const o=await Te(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0};let s=null;("polyline"===e||"polygon"===e)&&(s=this._draw.create(e,r));let n=null;const a=[s.on("vertex-add",(t=>{const{type:i,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(o,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),s.on("vertex-remove",(t=>{const{type:i,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(o,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),s.on("vertex-update",(t=>{const{type:i,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(o,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:i,updated:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}]},type:"create"})})),s.on("cursor-update",(t=>{const{type:i,vertices:r}=t;if(t.mapPoint&&(this._snapLastPolygonVertexToFirst(e,r),n=t,this._drawVertexGraphics(o,e,r,{userClicked:!1}),r.length>1)){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),s.on("draw-complete",(t=>{const i=t.vertices.slice(0);let r=null;"polyline"===e?r=o.createPolyline([i],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(r=o.createPolygon([i],this.view.spatialReference,this._doUnnormalization,!0)),r&&(this.createGraphic.geometry=r),c&&c.complete()})),s.on("undo",(t=>{const i=t.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,i),i.length&&this._drawVertexGraphics(o,e,i,{userClicked:r})})),s.on("redo",(t=>{const i=t.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,i),i.length&&this._drawVertexGraphics(o,e,i,{userClicked:r})}))],p=[this.view.on("pointer-move",(e=>{i(s.getCoordsFromScreenPoint(T(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),se.WIDGET),this.view.on("key-down",(e=>{e.key!==wt.snappingKey||e.repeat?e.key===wt.undoKey&&c&&c.canUndo()?(e.stopPropagation(),c.undo()):e.key===wt.redoKey&&c&&c.canRedo()?(e.stopPropagation(),c.redo()):e.key===wt.cancelKey&&c&&c.cancel():(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),se.WIDGET),this.view.on("key-up",(e=>{e.key===wt.snappingKey&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),se.WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const o=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(o,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;p.push(this.view.on("pointer-move",(()=>{i=!1}),se.WIDGET),this.view.on("pointer-down",(o=>{if(t(o))return i=!0,void o.stopPropagation();this._vertexGraphics.some((t=>e(t,o,this._getVertexIntersectDistance())))&&o.stopPropagation()}),se.WIDGET),this.view.on("pointer-up",(e=>{i&&(e.stopPropagation(),s.complete())})))}const c=this._operationHandleForCreateAction(s,[...a,...p],e);return c}async _setupCreateCircleOperation(e,t){const o=await Te(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},s=this._draw.create(e,r);let n=!1,a=!0;const p=[s.on("vertex-add",(t=>{const{type:i,vertexIndex:r,vertices:p}=t,c=p[r];this._drawSegmentGraphic(o,e,p,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),s.on("cursor-update",(t=>{const{type:i,vertices:r}=t;if(this._drawSegmentGraphic(o,e,r,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),s.on("draw-complete",(e=>{const t=e.vertices.slice(0);let i;1===t.length?(t.push(s.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+this._defaultSegmentOffset*this.view.resolution,t[0][1])),i=o.createCircle(t,s.viewAlignedCoordinateSystem,!0,this.view.resolution)):i=n?o.createEllipse(t,s.viewAlignedCoordinateSystem,a):o.createCircle(t,s.viewAlignedCoordinateSystem,a,this.view.resolution),this.createGraphic?this.createGraphic.geometry=i:(this._removeCreateGraphic(),this._set("createGraphic",new L(i,this.polygonSymbol))),l&&l.complete()}))],c=[this.view.on("pointer-move",(e=>{i(s.getCoordsFromScreenPoint(T(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),se.WIDGET),this.view.on("key-down",(t=>{t.key===wt.constraintKey?n||(n=!0,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.centerKey?a&&(a=!1,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.cancelKey&&l&&l.cancel()}),se.WIDGET),this.view.on("key-up",(t=>{t.key===wt.constraintKey?(n=!1,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.centerKey&&(a=!0,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem))}),se.WIDGET)],l=this._operationHandleForCreateAction(s,[...p,...c],e);return l}async _setupCreateRectangleOperation(e,t){const o=await Te(),r={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},s=this._draw.create(e,r);let n=!1,a=!1;const p=[s.on("vertex-add",(t=>{const{type:i,vertexIndex:r,vertices:p}=t,c=p[r];this._drawSegmentGraphic(o,e,p,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),s.on("cursor-update",(t=>{const{type:i,vertices:r}=t;if(this._drawSegmentGraphic(o,e,r,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),s.on("draw-complete",(e=>{const t=e.vertices.slice(0);let i=null;1===t.length&&(n=!1,a=!1),i=n?o.createSquare(t,s.viewAlignedCoordinateSystem,a):o.createRectangle(t,s.viewAlignedCoordinateSystem,a),this.createGraphic?this.createGraphic.geometry=i:(this._removeCreateGraphic(),this._set("createGraphic",new L(i,this.polygonSymbol))),l&&l.complete()}))],c=[this.view.on("pointer-move",(e=>{i(s.getCoordsFromScreenPoint(T(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),se.WIDGET),this.view.on("key-down",(t=>{t.key===wt.constraintKey?n||(n=!0,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.centerKey?a||(a=!0,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.cancelKey&&l&&l.cancel()}),se.WIDGET),this.view.on("key-up",(t=>{t.key===wt.constraintKey?(n=!1,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem)):t.key===wt.centerKey&&(a=!1,this._drawSegmentGraphic(o,e,s.vertices,{centered:a,constrainToggle:n},s.viewAlignedCoordinateSystem))}),se.WIDGET)],l=this._operationHandleForCreateAction(s,[...p,...c],e);return l}async _setupUpdateOperation(e,t){const{_defaultUpdateTool:i,defaultUpdateOptions:o,layer:r,view:s}=this,n={...o,...t},p=n.tool||i;for(const t of e)r.remove(t),r.add(t);if("3d"===s.type){if(0===e.length)return null;switch(p){case"move":return this._setupMove3DOperation(e,n,s,p);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=xe(e[0]);return 0===t?this._setupReshape3DOperation(e[0],n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${ke(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,n,s)}}if("move"===p)return this._setupMoveOperation(e,n,s);if(e.length>1)return"reshape"===p?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshapeOperation(e,p,n,s);if(1===e.length){const t=e[0],i=a(t.geometry,"type");if("point"===i||"multipoint"===i)return this._setupMoveOperation(e,n,s);if("transform"===p||"reshape"===p)return this._setupTransformOrReshapeOperation(e,p,n,s)}return null}async _setupMove3DOperation(e,t,i,o,r=!1){for(const t of e){const e=Ce(t);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${ke(e)}).`),null}const s=await this._requireModule(import("../../chunks/editingTools.js"));if(It(s))return s;const n=new s.module.GraphicMoveTool({view:i,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(n),n.graphics.addMany(e),r||this.updateGraphics.addMany(e);const a=[],p=new ft({activeComponent:n,tool:o,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},undo:()=>{St(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{kt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:e=>{this.updateGraphics.push(e),n.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?n.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==o)return;const e=this.updateGraphics.getItemAt(0);if(0!==xe(e))return;const r=await this._setupReshape3DOperation(e,t,i,!0);It(r)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(r,t))}});return a.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),se.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(p,e)),se.WIDGET)),p}_setupGraphicTransform3DOperation(e,o,r,s=!1){if(1===e.length&&0===function(e){var o;if("graphics"!==(null==(o=e.layer)?void 0:o.type))return 1;if(t(e.geometry))return 2;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":return 0;case"multipoint":case"extent":case"mesh":default:return 3}const r=i(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return r&&r.length>0&&r.some((e=>"object"===e.type))?"on-the-ground"!==be(e)&&je(e)?4:0:5}(e[0])){const t=e[0];if(i(t.geometry)&&"point"===t.geometry.type)return this._setupPointTransform3DOperation(t,o,r);if(i(t.geometry)&&("polygon"===t.geometry.type||"polyline"===t.geometry.type))return this._setupPolyTransform3DOperation(t,o,r,s)}return this._setupMove3DOperation(e,o,r,"transform",s)}async _setupPointTransform3DOperation(e,t,i){const o="transform",{enableRotation:r,enableScaling:s,enableZ:n}=t,a=await this._requireModule(import("../../chunks/editingTools.js"));if(It(a))return a;const p=new a.module.GraphicTransformTool({graphic:e,view:i,enableRotation:r,enableScaling:s,enableZ:n,snappingManager:this._snappingManager});this.view.tools.add(p),this.updateGraphics.add(e);const c=[],l=new ft({activeComponent:p,tool:o,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{St(l,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{kt(l,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:async e=>{this.updateGraphics.add(e);const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);It(o)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(o,t))}});return c.push(...this._getHandlesForComponent(l,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(l,e,t)),se.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(l,e)),se.WIDGET)),l}async _setupPolyTransform3DOperation(e,t,i,o=!1){const r="transform",{enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p}=t,c=await this._requireModule(import("../../chunks/editingTools.js"));if(It(c))return c;const l=new c.module.ExtentTransformTool({graphic:e,view:i,enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p});this.view.tools.add(l),o||this.updateGraphics.add(e);const h=[],d=new ft({activeComponent:l,tool:r,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(l),l.destroyed||l.destroy()},canUndo:()=>l.canUndo(),undo:()=>{l.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},canRedo:()=>l.canRedo(),redo:()=>{l.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);It(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:async e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(0!==xe(e))return;const o=await this._setupReshape3DOperation(e,t,i,!0);It(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))}});return h.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,t)),se.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(d,e)),se.WIDGET),this.view.on("key-down",(e=>{e.key!==wt.constraintKey||e.repeat||(l.preserveAspectRatio=!l.preserveAspectRatio,e.stopPropagation())}),se.WIDGET),this.view.on("key-up",(e=>{e.key===wt.constraintKey&&(l.preserveAspectRatio=!l.preserveAspectRatio,e.stopPropagation())}),se.WIDGET)),d}async _setupMoveOperation(e,t,i){const o="move";this.updateGraphics.addMany(e);const r=await this._getGraphicMover(e,t,i);if(It(r))return r;this._syncCloneInfos();const s=new ft({activeComponent:r,tool:o,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),a.forEach((e=>e.remove())),n.forEach((e=>e.remove())),a=[],n=[],r.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()]),this._removeCloneGraphics()},undo:()=>{const e=this.updateGraphics.toArray();St(s,e),this._syncCloneInfos(),this._emitUndoEvent({graphics:e,tool:o})},redo:()=>{const e=this.updateGraphics.toArray();kt(s,e),this._syncCloneInfos(),this._emitRedoEvent({graphics:e,tool:o})},addToSelection:e=>{this.updateGraphics.push(e),r.graphics=this.updateGraphics.toArray();const t=this._createClone(e);this._moveOperationCloneInfos.push({graphic:e,clone:t}),this._internalGraphicsLayer.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(t,1))),s.history.redo.forEach((e=>e.updates.splice(t,1)));const i=this._moveOperationCloneInfos.findIndex((t=>t.graphic===e)),o=this._moveOperationCloneInfos[i];this._internalGraphicsLayer.remove(o.clone),this.updateGraphics.remove(e),this._moveOperationCloneInfos.splice(i,1);const n=this.updateGraphics.toArray();this.emit("update",{graphics:n,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?r.graphics=n:s.complete()}});let n=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(s,e,t)),se.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==wt.constraintKey||e.repeat||(r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),se.WIDGET),i.on("key-up",(e=>{e.key===wt.constraintKey&&(r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),se.WIDGET)],a=this._getHandlesForComponent(s,t);return a.push(r.on("graphic-move",(e=>{this._moveOperationCloneInfos.forEach((t=>{const i=e.allGraphics.find((e=>e===t.graphic));i&&(t.clone.geometry=i.geometry)}))}))),s}_removeCloneGraphics(){if(this._moveOperationCloneInfos.length){for(const{clone:e}of this._moveOperationCloneInfos)this._internalGraphicsLayer.remove(e),e.destroy();this._moveOperationCloneInfos=[]}}_syncCloneInfos(){this._removeCloneGraphics(),this._moveOperationCloneInfos=this._generateCloneInfos(this.updateGraphics.toArray());for(const{clone:e}of this._moveOperationCloneInfos)this._internalGraphicsLayer.add(e)}_generateCloneInfos(e){return(null==e?void 0:e.map((e=>({graphic:e,clone:this._createClone(e)}))))||[]}_createClone(e){const t=e.clone();return t.symbol=this._getSymbolForClone(e),t}_getSymbolForClone(e){if(t(e.symbol))return null;switch(e.symbol.type){case"cim":return new A({style:"circle",size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case"picture-marker":{const{xoffset:t,yoffset:i,height:o,width:r}=e.symbol,s=o===r?r:Math.max(o,r);return new A({xoffset:t,yoffset:i,size:s,style:"square",color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-marker":{const{xoffset:t,yoffset:i,size:o,style:r}=e.symbol;return new A({xoffset:t,yoffset:i,style:"circle"===r?"circle":"square",size:o+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-fill":return new O({color:[0,0,0,0],outline:{style:"dash",color:[255,127,0,1],width:1}});case"simple-line":return new P({color:[255,127,0,1],style:"dash",width:1});case"text":{const{xoffset:t,yoffset:i}=e.symbol;return new A({xoffset:t,yoffset:i,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}async _setupReshape3DOperation(e,t,i,o=!1){const r="reshape",s=await this._requireModule(import("../../chunks/editingTools.js"));if(It(s))return s;this.snappingOptions.enabledToggled=!1;const n=new s.module.GraphicReshapeTool({view:i,graphic:e,enableZ:t.enableZ,enableMoveGraphic:t.enableMoveGraphic,snappingManager:this._snappingManager});i.tools.add(n),o||this.updateGraphics.add(e);const a=[],p=new ft({activeComponent:n,tool:r,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},undo:()=>{n.beforeUndo(),St(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},redo:()=>{kt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);It(o)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:async e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,i,!0);It(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return a.push(...this._getHandlesForComponent(p,t),i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),se.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===wt.snappingKey&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),se.WIDGET),i.on("key-up",(e=>{e.key===wt.snappingKey&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),se.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,i,o){const{multipleSelectionEnabled:r}=i;this.updateGraphics.addMany(e);const s="transform"===t?await this._getBox(e,i,o):await this._getReshape(e,i,o);if(It(s))return s;const n=new ft({activeComponent:s,type:"update",onEnd:()=>{p.forEach((e=>e.remove())),a.forEach((e=>e.remove())),p=[],a=[],n.activeComponent&&!n.activeComponent.destroyed&&n.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{St(n,this.updateGraphics.toArray()),n.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n.tool})},redo:()=>{kt(n,this.updateGraphics.toArray()),n.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n.tool})},addToSelection:e=>{const t=n.activeComponent;this.updateGraphics.add(e),t.graphics=this.updateGraphics.toArray(),t.refresh(),n.resetHistory(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=n.activeComponent,i=this.updateGraphics.indexOf(e);n.history.undo.forEach((e=>e.updates.splice(i,1))),n.history.redo.forEach((e=>e.updates.splice(i,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?t.graphics=o:n.complete()},toggleTool:async()=>{if(this.updateGraphics.length>1)return;let t=null;"transform"===n.tool?t=await this._getReshape(e,i,o):"reshape"===n.tool&&(t=await this._getBox(e,i,o)),It(t)||(n.activeComponent.destroy(),n.activeComponent=t,n.activeComponent&&(p.forEach((e=>e.remove())),p=this._getHandlesForComponent(n,i)))}});let a=[o.on("immediate-click",(e=>{this._getFirstHit(ae(e)).then((t=>{var i;if(!n)return;if(null==(i=t.results)||!i.length)return void n.complete();const o=n.activeComponent;t.results.some((t=>{if(t.graphic){var i;const s=t.graphic;if("box"===(null==o?void 0:o.type)&&null!=(i=e.native)&&i.shiftKey&&r)return n.addToSelection(s),!0;s.layer===this.layer&&n.complete()}return!1}))&&e.stopPropagation()}))}),se.WIDGET),o.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(n,e),e.key!==wt.snappingKey||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===wt.constraintKey&&!e.repeat&&n){const e=n.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),se.WIDGET),o.on("key-up",(e=>{var t;if(e.key===wt.snappingKey&&"reshape"===(null==n||null==(t=n.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===wt.constraintKey&&n){const e=n.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),se.WIDGET)],p=this._getHandlesForComponent(n,i);return n}async _getGraphicMover(e,t,i){const{enableMoveAllGraphics:o}=t,r=await this._requireModule(import("../../chunks/GraphicMover.js"));return It(r)?r:new r.module.default({enableMoveAllGraphics:o,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,i){const{enableRotation:o,enableScaling:r,preserveAspectRatio:s}=t,n=await this._requireModule(import("../../chunks/Box.js"));return It(n)?n:new n.module.default({graphics:e,enableRotation:o,enableScaling:r,preserveAspectRatio:s,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,i){const{enableMidpoints:o=!0}=t,r=await this._requireModule(import("../../chunks/Reshape.js"));return It(r)?r:new r.module.default({enableMidpoints:o,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:i,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const o=e.map((e=>x(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:o,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const o=e.map((e=>x(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:o,vertices:i,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:t,viewEvent:i})=>{var o;null!=(o=i.native)&&o.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))})),i.on("graphic-move-start",(t=>e.addToHistory(Ct(t.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(Ct(t.graphics)))),i.on("rotate-start",(t=>e.addToHistory(Ct(t.graphics)))),i.on("scale-start",(t=>e.addToHistory(Ct(t.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(Ct([t.mover])))),i.on("reshape-start",(t=>e.addToHistory(Ct([t.graphic])))),i.on("vertex-add",(t=>e.addToHistory(Ct([t.oldGraphic])))),i.on("vertex-remove",(t=>e.addToHistory(Ct([t.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(t=>{e.addToHistory(Ct(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[i.on("graphic-translate-start",(t=>{e.addToHistory(Ct([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(t=>{e.addToHistory(xt([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(t=>{e.addToHistory(xt([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[i.on("reshape",(t=>{"reshape-start"===t.type&&e.addToHistory(Ct([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("move",(t=>{"move-start"===t.type&&e.addToHistory(Ct([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,i,o){var r;const{graphic:s,viewEvent:n}=o;null!=(r=n.native)&&r.shiftKey?(n.stopPropagation(),e.removeFromSelection(s)):i.toggleToolOnClick&&(t(s.geometry)||"extent"!==s.geometry.type?(n.stopPropagation(),e.toggleTool()):this._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."))}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const o=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}}))}_getCommonUpdateOperationClickHandlers(e,t,i){const o=ae(t);this._getFirstHit(o).then((o=>{const r=o.results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,i))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.indexOf(e.graphic)>-1))?t.stopPropagation():e.complete()}))}_toggleSelection(e,t,i){const o=!!i.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!o||e.layer!==this.layer)&&(-1===this.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===wt.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):i===wt.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):i===wt.cancelKey?(t.stopPropagation(),e.cancel()):wt.deleteKeys.indexOf(i)>=0&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const i=this.activeComponent;if(t(i)||"reshape"===i.type||"reshape-3d"===i.type)return;e.stopPropagation();const o=this.updateGraphics.toArray();this.layer.removeMany(o),this._emitDeleteEvent({graphics:o,tool:this.activeTool})}_drawMultipointGraphic(e,t,i){let o=null;if(!i&&t.length>1){const i=t.slice(0);i.pop(),o=e.createMultipoint(i,this.view.spatialReference)}else o=e.createMultipoint(t,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=o:this._set("createGraphic",new L(o,this.pointSymbol)),i&&1===t.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,t,i,o){if(!i.length)return;const{_doUnnormalization:r,activeLineSymbol:s,activeVertexSymbol:n,polygonSymbol:a,polylineSymbol:p,vertexSymbol:c,view:{spatialReference:l}}=this,h=!(!o||!o.userClicked),d="polygon"===t,u=d?a:p;if(1===i.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const t=this.createPointFromVertex(i[0]),o=d?e.createPolygon([i],l,r,!0):e.createPolyline([i],l,r);this._vertexGraphics.length?this._vertexGraphics[0].geometry=t:this._vertexGraphics.push(new L(t,n)),this.createGraphic?this.createGraphic.set({geometry:o,symbol:u}):this._set("createGraphic",new L(o,u)),h&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===i.length){const t=this.createPointFromVertex(i[1]),o=e.createPolyline([i],l,r),s=d?e.createPolygon([i],l,r,!0):e.createPolyline([i],l,r);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(i[0]),t=new L(e,c);this._vertexGraphics.push(t)}if(1===this._vertexGraphics.length){const e=this._vertexGraphics[0],i=new L(t,c);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(i),this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}else this._vertexGraphics[1].geometry=t;this._showActiveLineGraphic(o);const n=this._vertexGraphics[0];h&&(this._activeLineGraphic.symbol=p,n.symbol=c,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.set({geometry:s,symbol:u}):this._set("createGraphic",new L(s,u)),this._internalGraphicsLayer.remove(n),this._internalGraphicsLayer.add(n)}else if(i.length>2){const o=d?e.createPolygon([i],l,r,!0):e.createPolyline([i],l,r);"polygon"===t&&this._showFillGraphic(o);const a=i.map((e=>e.slice())),m=a.pop(),y=[a[a.length-1],m],g=e.createPolyline([a],l,r),v=e.createPolyline([y],l,r);this._showLineGraphic(g),this._showActiveLineGraphic(v);for(let e=0;e<a.length;e++){const t=this._vertexGraphics[e];if(t)h||e!==this._vertexGraphics.length-1?t.symbol=c:t.symbol=n;else{const t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}}if(h){this._activeLineGraphic.symbol=p;const e=i.length-1,t=this.createPointFromVertex(i[e]);this._showVertexGraphic(t)}else this._activeLineGraphic.symbol=s;this.createGraphic?this.createGraphic.set({geometry:o,symbol:u}):(this._removeCreateGraphic(),this._set("createGraphic",new L(o,u)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,t,o,r,s){if(!o.length)return;const n=!(null==r||!r.centered),a=!(null==r||!r.constrainToggle);let p;1===o.length?this._removeCenterIndicatorGraphic():("rectangle"===t?p=a?e.createSquare(o,s,n):e.createRectangle(o,s,n):"circle"===t&&(p=a?e.createEllipse(o,s,n):e.createCircle(o,s,n,this.view.resolution)),i(p)&&p.extent&&p.extent.center&&this._showCenterIndicatorGraphic(p.extent.center)),p?this.createGraphic?this.createGraphic.geometry=p:(this._removeCreateGraphic(),this._set("createGraphic",new L(p,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new L(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:e,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new L(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:e,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new L(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.set({geometry:e,symbol:this.polylineSymbol}),this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new L(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,t){const i=t?this.activeVertexSymbol:this.vertexSymbol,o=new L(e,i);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics(),this._removeCloneGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,i){return new ft({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:i}=this;return!(!e||t(i))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===i.type||"reshape"===i.type)&&i.isUIGraphic(e))}_snapLastPolygonVertexToFirst(e,t){if("polygon"!==e&&t.length<=2)return;const i=t[0],o=t[t.length-1],r=this.view.toScreen(new j(i[0],i[1],this.view.spatialReference)),s=this.view.toScreen(new j(o[0],o[1],this.view.spatialReference));this._isWithinScreenDistance(r,s,this._getVertexIntersectDistance())&&(o[0]=i[0],o[1]=i[1])}_getVertexIntersectDistance(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?E(this.vertexSymbol.size)/2+3:3}_isWithinScreenDistance(e,t,i){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<=i}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,i){_t.error(new v(e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new j(e[0],e[1],e[2],this.view.spatialReference):new j(e[0],e[1],this.view.spatialReference)}test(){return this._operationHandle}wait(){return q(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||i(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const i=this.view.popup;i&&t(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=i.autoOpenEnabled,i.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&i(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(n(this._viewReadyAbortController),this._viewReadyAbortController=y(),await g(K(this.view,"ready"),this._viewReadyAbortController.signal))}};function St(e,t){const o=e.history.undo.pop().updates,r=[];t.forEach(((e,t)=>{const s=o[t],n={};null!=s&&(i(s.geometry)&&(n.geometry=e.geometry,e.geometry=s.geometry),i(s.symbol)&&(n.symbol=e.symbol,e.symbol=s.symbol),r.push(n))})),e.history.redo.push({updates:r})}function kt(e,t){const o=e.history.redo.pop().updates,r=[];t.forEach(((e,t)=>{const s=o[t],n={};null!=s&&(i(s.geometry)&&(n.geometry=e.geometry,e.geometry=s.geometry),i(s.symbol)&&(n.symbol=e.symbol,e.symbol=s.symbol),r.push(n))})),e.history.undo.push({updates:r})}function Ct(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function xt(e){return{updates:e.map((e=>({symbol:e.symbol})))}}function It(e){return"requireError"in e&&"aborted"===e.requireError}e([p({readOnly:!0})],jt.prototype,"_draw",null),e([p()],jt.prototype,"updating",null),e([p()],jt.prototype,"_operationHandle",void 0),e([p({readOnly:!0})],jt.prototype,"activeTool",null),e([p()],jt.prototype,"activeFillSymbol",void 0),e([p()],jt.prototype,"activeLineSymbol",void 0),e([p()],jt.prototype,"activeVertexSymbol",void 0),e([p({readOnly:!0})],jt.prototype,"createGraphic",null),e([p()],jt.prototype,"defaultCreateOptions",null),e([p()],jt.prototype,"defaultUpdateOptions",null),e([p()],jt.prototype,"layer",void 0),e([p({types:M})],jt.prototype,"pointSymbol",void 0),e([p({types:M})],jt.prototype,"polygonSymbol",void 0),e([p({types:M})],jt.prototype,"polylineSymbol",void 0),e([p({type:de,nonNullable:!0})],jt.prototype,"snappingOptions",null),e([p()],jt.prototype,"_snappingManager",void 0),e([p({readOnly:!0})],jt.prototype,"state",null),e([p({readOnly:!0})],jt.prototype,"updateGraphics",void 0),e([p()],jt.prototype,"updateOnGraphicClick",void 0),e([p({types:M})],jt.prototype,"updatePointSymbol",void 0),e([p({types:M})],jt.prototype,"updatePolygonSymbol",void 0),e([p({types:M})],jt.prototype,"updatePolylineSymbol",void 0),e([p({types:M})],jt.prototype,"vertexSymbol",void 0),e([p({value:null})],jt.prototype,"view",null),e([p()],jt.prototype,"cancel",null),e([p()],jt.prototype,"complete",null),e([p()],jt.prototype,"delete",null),e([p()],jt.prototype,"create",null),e([p()],jt.prototype,"update",null),e([p()],jt.prototype,"undo",null),e([p()],jt.prototype,"redo",null),e([p()],jt.prototype,"canUndo",null),e([p()],jt.prototype,"canRedo",null),e([p()],jt.prototype,"toggleUpdateTool",null),jt=e([_("esri.widgets.Sketch.SketchViewModel")],jt);var Tt=jt;export default Tt;export{Oe as F,et as L,Xe as P,xe as a,Ee as b,Ce as i};
