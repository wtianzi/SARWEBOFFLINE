/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import{clone as e}from"../../core/lang.js";import"../../chunks/deprecate.js";import"../../chunks/object.js";import"../../config.js";import{L as i,i as s}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{createTask as n,after as o,isAbortError as l,createAbortController as a}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import{e as m}from"../../chunks/ensureType.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import"../../core/Collection.js";import"../../chunks/JSONSupport.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../geometry/SpatialReference.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import{c as p}from"../../chunks/mathUtils2.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../core/Handles.js";import{C as d}from"../../chunks/CollectionFlattener.js";import{o as h}from"../../chunks/timeUtils.js";import c from"../../TimeExtent.js";import f from"../../TimeInterval.js";import{init as g,whenFalseOnce as v}from"../../core/watchUtils.js";import{b as T,W as w}from"../../chunks/Widgets.js";import{HandleOwner as y}from"../../core/HandleOwner.js";import"../../layers/support/TimeInfo.js";import{i as _}from"../../chunks/TemporalLayer.js";function j(t){return void 0!==t.count}function x(t){return void 0!==t.interval}function E(t){return"esri.WebMap"===t.declaredClass}const S=i.getLogger("esri.widgets.TimeSlider.TimeSliderViewModel");let k=class extends y{constructor(t){super(t),this.timerId=null,this.view=null,this._animationController=null,this._updateTimeSliderTask=null}initialize(){this.handles.add([g(this,"effectiveStops",(()=>{this.values||(this._set("values",this._getDefaultValues()),this.view&&(this.view.timeExtent=this.timeExtent))})),g(this,"view.map",(t=>{s(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null),this._updateTimeSliderTask=n((e=>this._updateTimeSliderFromMap(t,e)))})),g(this,"view",((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),!0)])}destroy(){var t;null!=this.timerId&&(clearInterval(this.timerId),this.timerId=null),this._unregisterWidget(this.view),this.view=null,null==(t=this._animationController)||t.abort(),this._animationController=null,s(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null)}get effectiveStops(){const{fullTimeExtent:t,stops:e}=this;if(!e)return[];if("dates"in e){const{dates:i}=e;if(null==i||0===i.length)return null;const s=i.sort(((t,e)=>t.getTime()-e.getTime()));return t?s.filter((e=>{const{start:i,end:s}=t;return!(e.getTime()<i.getTime()||e.getTime()>s.getTime())})):s}if(j(e)){const i=e.timeExtent||t;return this._divideTimeExtentByCount(i,e.count)}if(x(e)){const i=e.timeExtent||t;return this._divideTimeExtentByInterval(i,e.interval)}return[]}set fullTimeExtent(t){this._override("fullTimeExtent",t)}set loop(t){this._override("loop",t)}set mode(t){this._override("mode",t)}set playRate(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._override("playRate",t))}get state(){return this.values&&this.fullTimeExtent?this._animationController?"playing":"ready":"disabled"}set stops(t){this._override("stops",t)}get timeExtent(){const{mode:t,values:e}=this;if(!e||0===e.length)return null;switch(t){case"instant":return new c({start:e[0],end:e[0]});case"time-window":return e.length>1?new c({start:e[0],end:e[1]}):null;case"cumulative-from-start":return new c({start:null,end:e[0]});case"cumulative-from-end":return new c({start:e[0],end:null});default:return}}set values(t){const{fullTimeExtent:e,view:i}=this;if(e){const{start:i,end:s}=e,r=i.getTime(),n=s.getTime();t=t&&t.filter((t=>t)).map((t=>{const e=t.getTime(),i=p(e,r,n);return new Date(i)}))}i&&(i.timeExtent=this._toTimeExtent(t)),this._override("values",t)}next(){this.values&&this.fullTimeExtent&&this._step({forward:!0,allowRestart:!1})}play(){this._startAnimation()}previous(){this._step({forward:!1,allowRestart:!1})}stop(){this._stopAnimation()}updateWebDocument(t){if(E(t)){const i=new T({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:j(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:x(this.stops)?this.stops.interval:null,stops:(e=this.stops,void 0!==e.dates?this.stops.dates:null)});t.widgets?t.widgets.timeSlider=i:t.widgets=new w({timeSlider:i})}var e}async _animate(){try{await Promise.all([o(this.playRate,null,this._animationController.signal),this.view&&v(this.view,"updating",this._animationController.signal)])}catch(t){return l(t)||S.error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),this._animationController&&this._animate()}_divideTimeExtentByCount(t,e=10){if(!t||!e)return[];const{start:i,end:s}=t;if(!i||!s)return[];if(e>1e4)return this._divideTimeExtentByCount(t);const r=[],n=i.getTime(),o=s.getTime()-n;for(let t=0;t<=e;t++)r.push(new Date(n+t/e*o));return r}_divideTimeExtentByInterval(t,e,i=1e4){if(!t||!e)return[];const{start:s,end:r}=t;if(!s||!r)return[];if((r.getTime()-s.getTime())/e.toMilliseconds()>i)return this._divideTimeExtentByCount(t);const n=[],{value:o,unit:l}=e;let a=s;for(;a.getTime()<=r.getTime();)n.push(new Date(a.getTime())),a=h(a,o,l);return n}_getDefaultValues(){const{effectiveStops:t,mode:e}=this;return t&&e?"time-window"===e?t.length>1?[t[0],t[1]]:null:t.length>0?[t[0]]:null:null}async _getFullTimeExtentFromWebDocument(t,e){const{fullTimeExtent:i}=t.widgets.timeSlider;if(i)return i;const s=new d({root:t,rootCollectionNames:["layers"],getChildrenFunction:t=>function(t){return"group"===(null==t?void 0:t.type)}(t)?t.layers:null,itemFilterFunction:t=>_(t)&&t.useViewTime});await Promise.all(s.map((t=>t.load({signal:e}))));const r=s.map((t=>t.timeInfo));let n;if(r.some((t=>t.hasLiveData))){const t=s.filter((t=>function(t){return"feature"===(null==t?void 0:t.type)}(t)||function(t){return"map-image"===(null==t?void 0:t.type)}(t))).map((t=>t.fetchRecomputedExtents({signal:e})));n=(await Promise.all(t)).map((t=>t.timeExtent))}else n=r.map((t=>t.fullTimeExtent));return n.reduce(((t,e)=>t.union(e)))}_getModeFromTimeSlider(t){var e;const i=null!=(e=t.numThumbs)?e:2,s=t.currentTimeExtent;if(s){const{start:t,end:e}=s;return t&&e&&t.getTime()===e.getTime()?"instant":2===i?"time-window":t&&0!==t.getTime()?"cumulative-from-end":"cumulative-from-start"}return 2===i?"time-window":"cumulative-from-start"}_getStopsFromTimeSlider(t){const{numStops:i,stopInterval:s,stops:r}=t;return r?{dates:e(r)}:s?{interval:s.clone()}:{count:null!=i?i:5}}_getValuesFromTimeSlider(t,e){const i=t.currentTimeExtent;if(i){const{start:t,end:s}=i;switch(e){case"time-window":return[t,s];case"cumulative-from-start":return[s];case"cumulative-from-end":case"instant":return[t]}}return this._getDefaultValues()}_registerWidget(t){(null==t?void 0:t.persistableViewModels.some((t=>t===this)))||null==t||t.persistableViewModels.add(this)}_startAnimation(){this._stopAnimation(),this._animationController=a(),this._step({forward:!0,allowRestart:!0}),this._animate()}_step(t){const{forward:e,allowRestart:i}=t,{effectiveStops:s,values:r}=this;if(!r||0===r.length||r.length>s.length)return;const n=s.map((t=>t.getTime())).sort(((t,e)=>t-e)),o=r.map((t=>t.getTime())).map((t=>{const e=n.indexOf(t);if(-1!==e)return e;const i=n.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return n.indexOf(i)})),l=o.map((t=>t+(e?1:-1))),a=l.some((t=>t<0||t>n.length-1)),{loop:m,state:u}=this;if(a)if(m||i){const t=Math.min(...o),i=Math.max(...o),s=e?o.map((e=>e-t)):o.map((t=>t+(n.length-1-i)));this.values=s.map((t=>new Date(n[t])))}else"playing"===u&&this.stop();else this.values=l.map((t=>new Date(n[t])))}_stopAnimation(){var t;null==(t=this._animationController)||t.abort(),this._animationController=null}_toTimeExtent(t){if(!t||0===t.length)return null;const e=t[0],i=t.length>1?t[1]:t[0];switch(this.mode){case"instant":case"time-window":return new c({start:e,end:i});case"cumulative-from-start":return new c({start:null,end:e});case"cumulative-from-end":return new c({start:e,end:null});default:return null}}_unregisterWidget(t){null==t||t.persistableViewModels.remove(this)}async _updateTimeSliderFromMap(t,e){var i;if(!t||!E(t))return;await t.load({signal:e});const s=null==t||null==(i=t.widgets)?void 0:i.timeSlider;if(!s)return;const r=this._getModeFromTimeSlider(s);var n;(this._isOverridden("mode")||(this.mode=r),this._isOverridden("fullTimeExtent")||(this.fullTimeExtent=await this._getFullTimeExtentFromWebDocument(t,e)),this._isOverridden("playRate"))||(this.playRate=null!=(n=s.stopDelay)?n:2e3);this._isOverridden("stops")||(this.stops=this._getStopsFromTimeSlider(s)),this._isOverridden("values")||(this.values=this._getValuesFromTimeSlider(s,r)),this._isOverridden("loop")||(this.loop=s.loop)}};t([r({readOnly:!0})],k.prototype,"effectiveStops",null),t([r({type:c,value:null})],k.prototype,"fullTimeExtent",null),t([r({nonNullable:!0,value:!1})],k.prototype,"loop",null),t([r({nonNullable:!0,value:"time-window"})],k.prototype,"mode",null),t([r({nonNullable:!0,value:1e3})],k.prototype,"playRate",null),t([r({readOnly:!0})],k.prototype,"state",null),t([r({cast:t=>t?(x(t)&&(t.interval=m(f,t.interval)),(x(t)||j(t))&&(t.timeExtent=m(c,t.timeExtent)),t):null,value:{count:10}})],k.prototype,"stops",null),t([r({readOnly:!0})],k.prototype,"timeExtent",null),t([r()],k.prototype,"timerId",void 0),t([r({value:null})],k.prototype,"values",null),t([r()],k.prototype,"view",void 0),t([r()],k.prototype,"_animationController",void 0),t([r()],k.prototype,"next",null),t([r()],k.prototype,"play",null),t([r()],k.prototype,"previous",null),t([r()],k.prototype,"stop",null),t([r()],k.prototype,"updateWebDocument",null),k=t([u("esri.widgets.TimeSlider.TimeSliderViewModel")],k);var b=k;export default b;
