/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../core/lang.js";import"../../chunks/deprecate.js";import"../../chunks/object.js";import"../../kernel.js";import"../../config.js";import{d as t,i,b as s,L as r}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import n from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import l from"../../core/Collection.js";import{c as p,r as m}from"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/shared.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import u from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../portal/PortalItem.js";import"../../chunks/mathUtils2.js";import{c}from"../../chunks/vec3f64.js";import"../../chunks/common.js";import{g as h,d,b as j,n as y,e as g,s as b,p as f,A as _}from"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import v from"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import{s as k}from"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols.js";import"../../chunks/uid.js";import"../../Graphic.js";import S from"../../core/Handles.js";import"../../layers/Layer.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../tasks/support/ColorRamp.js";import"../../tasks/support/AlgorithmicColorRamp.js";import"../../tasks/support/MultipartColorRamp.js";import"../../chunks/colorRamps.js";import"../../renderers/Renderer.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/VisualVariablesMixin.js";import"../../chunks/symbolConversion.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/ClassBreaksRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/normalizeUtilsCommon.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/MemCache.js";import"../../chunks/ItemCache.js";import"../../chunks/utils3.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/LRUCache.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import"../../TimeInterval.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../chunks/MultiOriginJSONSupport.js";import{init as C,on as O,watch as I}from"../../core/watchUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/fieldType.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/projection.js";import"../../chunks/OperationalLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/commonProperties2.js";import{T as L}from"../../chunks/Scheduler.js";import"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import"../../core/workers/RemoteClient.js";import"../../core/workers/Connection.js";import"../../core/workers/workers.js";import"../../form/ExpressionInfo.js";import"../../form/elements/FieldElement.js";import"../../form/support/elements.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/support/inputs.js";import"../../form/elements/GroupElement.js";import"../../form/FormTemplate.js";import"../../chunks/vec4f64.js";import"../../chunks/earcut.js";import"../../chunks/deduplicate.js";import"../../chunks/triangulationUtils.js";import{c as w}from"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec4.js";import"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../support/widget.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../layers/FeatureLayer.js";import"../../chunks/ArcGISService.js";import"../../chunks/BlendLayer.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/PortalLayer.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../layers/support/TimeInfo.js";import"../../chunks/TemporalLayer.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../chunks/labelUtils.js";import"../../layers/support/LabelClass.js";import"../../chunks/defaultsJSON.js";import"../../chunks/defaults.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/DataLayerSource.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../chunks/utils4.js";import"../../tasks/Task.js";import"../../rest/query/support/AttachmentInfo.js";import"../../chunks/query.js";import"../../chunks/executeRelationshipQuery.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/vec4f32.js";import"../../chunks/quantizationUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/byteSizeEstimations.js";import{g as T}from"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import"../../chunks/interactiveToolUtils.js";import"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/Queue.js";import"../../chunks/InputManager.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../Popup/PopupViewModel.js";import"../../chunks/GoTo.js";import"../../chunks/MapUtils.js";import"../../chunks/vec2f64.js";import"../../chunks/VertexColor.glsl.js";import"../../chunks/Program.js";import"../../chunks/FramebufferObject.js";import"../../chunks/renderState.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import{c as V}from"../../chunks/stack.js";import{x as E,u as M,z as U,Q as R,R as D}from"../../chunks/geometryUtils.js";import{G as P}from"../../chunks/ColorMaterial.js";import"../../chunks/Util.js";import"../../chunks/glUtil3D.js";import"../../chunks/Object3D.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/lineUtils.js";import"../../chunks/intersectorUtils.js";import{I as A}from"../../chunks/Intersector.js";import"../../chunks/Camera.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/RibbonLineMaterial.js";import"../../chunks/PhysicallyBasedRendering.glsl.js";import{g as z}from"../../chunks/tileUtils.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/elevationInfoUtils.js";import{I as G,c as F}from"../../chunks/InteractiveToolBase.js";import"../../chunks/VisualElement.js";import{L as x}from"../../chunks/LaserlineVisualElement.js";import"../../chunks/Object3DVisualElement.js";import{I as H}from"../../chunks/InteractiveToolViewModel.js";import{a as N,M as B}from"../../chunks/manipulatorUtils.js";import{L as W}from"../../chunks/LineVisualElement.js";import{d as q}from"../../chunks/manipulatorUtils2.js";import Q from"./LineOfSightTarget.js";let J=class extends n{constructor(e){super(e),this.laserLineEnabled=!0,this.laserLineGlowColor=new v([255,127,0]),this.laserLineGlowWidth=8,this.laserLineInnerColor=new v([255,255,255]),this.laserLineInnerWidth=.75,this.laserLineGlobalAlpha=.75,this.observerManipulatorSize=.5,this.observerManipulatorColor=new v([255,127,0,.75]),this.targetManipulatorSize=.5,this.targetManipulatorVisibleColor=new v([3,252,111,.75]),this.targetManipulatorOccludedColor=new v([252,3,69,.75]),this.targetManipulatorUndefinedColor=new v([127,127,127,.75]),this.lineOfSightInnerWidth=2,this.lineOfSightOuterWidth=8,this.lineOfSightVisibleInnerColor=new v([3,252,111,1]),this.lineOfSightVisibleOuterColor=new v([3,252,111,.15]),this.lineOfSightOccludedInnerColor=new v([252,3,69,1]),this.lineOfSightOccludedOuterColor=new v([252,3,69,.1]),this.lineOfSightUndefinedInnerColor=new v([255,255,255,1]),this.lineOfSightUndefinedOuterColor=new v([127,127,127,.2])}};function $(e,t,i){return{geometry:P.createSphereGeometry(e,32,32),material:N(v.toUnitRGBA(t)),stateMask:i}}e([o({type:Boolean})],J.prototype,"laserLineEnabled",void 0),e([o({type:v})],J.prototype,"laserLineGlowColor",void 0),e([o({type:Number})],J.prototype,"laserLineGlowWidth",void 0),e([o({type:v})],J.prototype,"laserLineInnerColor",void 0),e([o({type:Number})],J.prototype,"laserLineInnerWidth",void 0),e([o({type:Number})],J.prototype,"laserLineGlobalAlpha",void 0),e([o({type:Number})],J.prototype,"observerManipulatorSize",void 0),e([o({type:v})],J.prototype,"observerManipulatorColor",void 0),e([o({type:Number})],J.prototype,"targetManipulatorSize",void 0),e([o({type:v})],J.prototype,"targetManipulatorVisibleColor",void 0),e([o({type:v})],J.prototype,"targetManipulatorOccludedColor",void 0),e([o({type:v})],J.prototype,"targetManipulatorUndefinedColor",void 0),e([o({type:Number})],J.prototype,"lineOfSightInnerWidth",void 0),e([o({type:Number})],J.prototype,"lineOfSightOuterWidth",void 0),e([o({type:v})],J.prototype,"lineOfSightVisibleInnerColor",void 0),e([o({type:v})],J.prototype,"lineOfSightVisibleOuterColor",void 0),e([o({type:v})],J.prototype,"lineOfSightOccludedInnerColor",void 0),e([o({type:v})],J.prototype,"lineOfSightOccludedOuterColor",void 0),e([o({type:v})],J.prototype,"lineOfSightUndefinedInnerColor",void 0),e([o({type:v})],J.prototype,"lineOfSightUndefinedOuterColor",void 0),J=e([a("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightConfiguration")],J);const Z=l.ofType(Q);let K=class extends G{constructor(e){super(e),this.deferCreation=!0,this.configuration=null,this.updating=!1,this._handles=new S,this._manipulatorHandles=new S,this._laserlineVisualElement=null,this._observer=null,this._tracker=null,this._analyses=new l,this._screenPixelSize=0,this._grabbedManipulator=null,this._showTracker=!0}initialize(){const e=C(this,"state",(e=>{switch(e){case"created":this.complete();break;default:this.create()}}),!0),t=this.configuration=new J;this._intersector=new A(this.view.state.mode),this._intersector.options.hud=!1,this._intersector.options.store=0,this._observer={location:null,intersection:null,manipulator:this._addManipulator({size:t.observerManipulatorSize,color:t.observerManipulatorColor,visible:!1})},this._tracker=this._createLineOfSightAnalysis(new Q({location:new u})),this._tracker.point.manipulator.available=!1,this._tracker.point.manipulator.interactive=!1;const i=this._handles;i.add([e,this.view.state.watch("camera",(()=>this._onCameraChange())),this.view.watch("map.ground.opacity",((e,t)=>this._onGroundOpacityChange(e,t))),C(this.view,"slicePlane",(()=>this._onSlicePlaneChange())),C(this.model,"observer",(e=>this._onObserverChange(e)),!0),O(this.model,"targets","change",(e=>this._onTargetCollectionChange(e)),(e=>this._onTargetsChange(e)),null,!0),I(this.configuration,["laserLineEnabled","laserLineGlowColor","laserLineGlowWidth","laserLineInnerColor","laserLineInnerWidth","laserLineGlobalAlpha","lineOfSightInnerWidth","lineOfSightOuterWidth","lineOfSightVisibleInnerColor","lineOfSightVisibleOuterColor","lineOfSightOccludedInnerColor","lineOfSightOccludedOuterColor","lineOfSightUndefinedInnerColor","lineOfSightUndefinedOuterColor","lineOfSightUndefinedStipplePattern","lineOfSightUndefinedStipplePatternOffColor"],(()=>this._createVisualElements())),I(this.configuration,["observerManipulatorSize","observerManipulatorColor"],(()=>this._recreateManipulator(this._observer))),I(this.configuration,["targetManipulatorSize","targetManipulatorVisibleColor","targetManipulatorOccludedColor","targetManipulatorUndefinedColor"],(()=>this._analyses.forEach((e=>this._recreateManipulator(e.point)))))]),this._createVisualElements();const s=this.view.pointsOfInterest;s&&i.add([s.contentGeometryUpdates.events.on("request-update",(()=>this._onContentChange())),this.view.elevationProvider.on("elevation-change",(()=>this._onContentChange()))]);const r=this.view.resourceController&&this.view.resourceController.scheduler;r&&(this._frameTask=r.registerTask(L.LINE_OF_SIGHT_TOOL,(e=>this._updateAnalyses(e)),(()=>this.updating)),i.add(this._frameTask)),this.continue()}destroy(){this.detach(),this._handles=t(this._handles),this._manipulatorHandles=t(this._manipulatorHandles),this.manipulators.remove(this._observer.manipulator),this._destroyLineOfSightAnalysis(this._tracker),this._analyses.forEach((e=>this._destroyLineOfSightAnalysis(e))),this._removeVisualElements(),this._intersector=null,this._set("model",null)}_removeVisualElements(){i(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}get state(){return this._showTracker?"creating":i(this.model.observer)?"created":"ready"}get cursor(){return this.manipulators.some((({manipulator:e})=>e.focused))?null:this._showTracker?"crosshair":null}get isSupported(){return"3d"===this.get("view.type")}continue(){this.view.activeTool=this,this._showTracker=!0,this._updateTrackerVisibility()}stop(){this._showTracker=!1,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._updateTrackerVisibility()}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){switch(e.type){case"immediate-click":this._clickHandler(e)}}_setDirty(e){this.updating?e===L.LINE_OF_SIGHT_TOOL_INTERACTIVE&&this._frameTask&&(this._frameTask.task=e):(this._set("updating",!0),this._frameTask&&(this._frameTask.task=e))}_updateTrackerVisibility(){this._tracker.shouldRender=this._showTracker&&!this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()}_manipulatorFocusChanged(){this._updateTrackerVisibility(),this.notifyChange("cursor")}_addManipulator(e){const t=function(e,t){const i=[];t.customColor1&&i.push($(t.size,t.customColor1,16)),t.customColor2&&i.push($(t.size,t.customColor2,32)),t.customColor3&&i.push($(t.size,t.customColor3,64)),t.color&&i.push($(t.size,t.color));const s=new B({view:e,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});q(s);for(const e in t)s[e]=t[e];return s}(this.view,e);return this._manipulatorHandles.add([this._createManipulatorDragPipeline(t),t.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),t.events.on("grab-changed",(e=>this._manipulatorGrabChanged(t,e))),t.events.on("immediate-click",(e=>e.stopPropagation()))],t),this.manipulators.add(t),t}_removeManipulator(e){this.manipulators.remove(e),this._manipulatorHandles.remove(e)}_recreateManipulator(e){const t=this.configuration,i=e.manipulator;this._removeManipulator(i);const s=e===this._observer?{size:t.observerManipulatorSize,color:t.observerManipulatorColor,visible:i.available}:{size:t.targetManipulatorSize,customColor1:t.targetManipulatorVisibleColor,customColor2:t.targetManipulatorOccludedColor,customColor3:t.targetManipulatorUndefinedColor};e.manipulator=this._addManipulator(s),e.manipulator.location=i.location,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_screenToIntersection(){return e=>{const t=this._getScreenPointIntersection(e.screenEnd);return s(t)?null:{...e,intersection:t}}}_createManipulatorDragPipeline(e){return F(e,((t,i,s)=>{i.next(this._screenToIntersection()).next(e===this._observer.manipulator?this._updateObserverDragStep():this._updateAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer())),s.next(e===this._observer.manipulator?this._cancelObserverDragStep():this._cancelAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(this.model.observer=e.intersection.point,this._observer.intersection=e.intersection,e)}_cancelObserverDragStep(){const e=i(this.model.observer)?this.model.observer.clone():null,t=this._observer.intersection;return i=>(this.model.observer=e,this._observer.intersection=t,i)}_updateAnalysisDragStep(e){return t=>{const i=this._analyses.find((t=>t.point.manipulator===e));return i.target.location=t.intersection.point,i.point.intersection=t.intersection,t}}_cancelAnalysisDragStep(e){const t=this._analyses.find((t=>t.point.manipulator===e)),s=i(t.target.location)?t.target.location.clone():null,r=t.point.intersection;return e=>(t.target.location=s,t.point.intersection=r,e)}_updateLaserLineRenderer(){if(s(this._laserlineVisualElement))return;const e=this._laserlineVisualElement,t=i(this._grabbedManipulator)?this._grabbedManipulator:this._tracker.shouldRender&&this.model.observer?this._tracker.point.manipulator:null;this.configuration.laserLineEnabled&&i(t)?(e.heightManifoldTarget=t.renderLocation,t!==this._observer.manipulator?e.lineVerticalPlaneSegment=M.fromPoints(this._observer.manipulator.renderLocation,t.renderLocation,ne):e.lineVerticalPlaneSegment=null):(e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createVisualElements(){const e=this.configuration;i(this._laserlineVisualElement)&&this._removeVisualElements(),this._laserlineVisualElement=new x({view:this.view,attached:!0,style:{glowColor:v.toUnitRGB(e.laserLineGlowColor),glowWidth:e.laserLineGlowWidth,innerColor:v.toUnitRGB(e.laserLineInnerColor),innerWidth:e.laserLineInnerWidth,globalAlpha:e.laserLineGlobalAlpha}}),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onObserverChange(e){if(s(e))return this._observer.manipulator.available=!1,void this.model.targets.removeAll();this._observer.location=e,this._observer.intersection=null,this._observer.manipulator.available=!0,this._observer.manipulator.location=e,this._tracker.point.manipulator.location=e,this._analyses.forEach((e=>{e.isDirty=!0,e.isValid=!1})),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onTargetsChange(e){this._analyses.forEach((e=>{this._destroyLineOfSightAnalysis(e)})),this._analyses.removeAll(),e.items&&this._onTargetCollectionChange({target:e,added:e.items,removed:[],moved:[]})}_onTargetCollectionChange(e){e.added.forEach((e=>{if(!this._analyses.some((t=>t.target===e))){const t=this._createLineOfSightAnalysis(e);this._analyses.add(t)}this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)})),e.removed.forEach((e=>{const t=this._analyses.find((t=>t.point.location===e.location));this._destroyLineOfSightAnalysis(t),this._analyses.remove(t)}))}_onTargetLocationChange(e,t){e.isValid=!1,e.point.location=t,e.point.intersection=null,e.point.manipulator.location=t,e.isDirty=!0,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onGroundOpacityChange(e,t){this._analyses.length&&(1!==e&&1!==t||e===t||(this._setDirty(L.LINE_OF_SIGHT_TOOL),this._analyses.forEach((e=>e.isDirty=!0))))}_onContentChange(){this._analyses.forEach((e=>{e.isDirty=!0,e.shouldIntersect=!0})),this._setDirty(L.LINE_OF_SIGHT_TOOL)}_onCameraChange(){if(!this._analyses.length)return;let e=!1;if(i(this.model.observer)){this.view.renderCoordsHelper.toRenderCoords(this.model.observer,X);const t=this.view.state.camera.computeScreenPixelSizeAt(X);e=e||Math.abs((t-this._screenPixelSize)/this._screenPixelSize)>.1}this._analyses.some((e=>!e.isValid))&&(e=!0),e&&(this._setDirty(L.LINE_OF_SIGHT_TOOL),this._analyses.forEach((e=>e.isDirty=!0)))}_onSlicePlaneChange(){this._analyses.length&&(this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._analyses.forEach((e=>e.isDirty=!0)))}_addPointFromClickEvent(e){const t=this._getScreenPointIntersection(e);if(!s(t)&&!s(t.point))if(this.model.observer){const e=new Q({location:t.point}),i=this._createLineOfSightAnalysis(e);this._analyses.add(i),i.point.intersection=t,this.model.targets.add(e)}else this.model.observer=t.point,this._observer.intersection=t}_clickHandler(e){this._showTracker&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())}_doubleClickHandler(e){this._showTracker&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this._showTracker&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(!this._showTracker)return;const t={x:e.x,y:e.y},s=this._getScreenPointIntersection(t);i(s)&&i(s.point)&&(this._tracker.point.manipulator.location=s.point,this._tracker.isDirty=!0,this._updateLaserLineRenderer(),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_getScreenPointIntersection(e){const t=k(e,V.get()),i=U(this.view.state.camera,t,se);return this._getRayIntersection(i)}_getRayIntersection(e){if(s(e))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this._intersector);const t=this._intersector.results.min;if(!t||!t.getIntersectionPoint(X))return null;const r=this.view.renderCoordsHelper.fromRenderCoords(X,this.view.spatialReference),o=c();h(o,t.normal);const n=d(o,e.direction)>0?-1:1;j(o,o,n);const a=t.toGraphic(this.view);if(i(a)){const i=a.layer,s=a.sourceLayer;let n;if(s)switch(s.type){case"scene":n=T(a,s.objectIdField);break;case"integrated-mesh":{const e=t.target;n=`${e.metadata.nodeIndex}/${e.metadata.componentIndex}`;break}default:n=a.uid}else n=a.uid;return{type:"Graphic",id:`${i.uid}/${n}`,ray:R(e),normal:o,point:r}}if("TerrainRenderer"===t.intersector){return{type:"Terrain",id:t.target.metadata.tile.lij.slice(),ray:R(e),normal:o,point:r}}return null}_createLineOfSightAnalysis(e){const t=this.configuration,s=new W({view:this.view,attached:!0,width:t.lineOfSightOuterWidth,color:v.toUnitRGBA(t.lineOfSightVisibleOuterColor),innerWidth:t.lineOfSightInnerWidth,innerColor:v.toUnitRGBA(t.lineOfSightVisibleInnerColor)}),r=new W({view:this.view,attached:!0,width:t.lineOfSightOuterWidth,color:v.toUnitRGBA(t.lineOfSightOccludedOuterColor),innerWidth:t.lineOfSightInnerWidth,innerColor:v.toUnitRGBA(t.lineOfSightOccludedInnerColor)}),o=new W({view:this.view,attached:!0,width:t.lineOfSightOuterWidth,color:v.toUnitRGBA(t.lineOfSightUndefinedOuterColor),innerWidth:t.lineOfSightInnerWidth,innerColor:v.toUnitRGBA(t.lineOfSightUndefinedInnerColor)}),n={isValid:!1,isDirty:!0,shouldRender:!0,shouldIntersect:!1,point:{location:e.location,manipulator:this._addManipulator({size:t.targetManipulatorSize,customColor1:t.targetManipulatorVisibleColor,customColor2:t.targetManipulatorOccludedColor,customColor3:t.targetManipulatorUndefinedColor}),intersection:null},isTargetVisible:!1,hasIntersection:!1,target:e,targetHandle:null,engine:{points:{observer:c(),target:c(),intersection:c(),intersectionObserver:c(),intersectionTarget:c()},visualization:{visibleLineVisualElement:s,occludedLineVisualElement:r,undefinedLineVisualElement:o}}};return i(e.location)&&(n.point.manipulator.location=e.location),n.targetHandle=C(e,"location",(e=>this._onTargetLocationChange(n,e)),!0),this.manipulators.add(n.point.manipulator),n}_destroyLineOfSightAnalysis(e){e.targetHandle.remove(),this.manipulators.remove(e.point.manipulator),e.engine.visualization.visibleLineVisualElement.destroy(),e.engine.visualization.visibleLineVisualElement=null,e.engine.visualization.occludedLineVisualElement.destroy(),e.engine.visualization.occludedLineVisualElement=null,e.engine.visualization.undefinedLineVisualElement.destroy(),e.engine.visualization.undefinedLineVisualElement=null}_canComputeAnalysis(e){if(s(this.model.observer)||s(e.point)||s(e.point.location))return!1;this.view.renderCoordsHelper.toRenderCoords(this.model.observer,X);const t=this.view.frustum.intersectsPoint(X);this.view.renderCoordsHelper.toRenderCoords(e.point.location,X);const i=this.view.frustum.intersectsPoint(X);return t&&i}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._updateTrackerVisibility()}_canUpdateFromIntersectionResult(e,t){if(s(e)||!t||e.type!==t.type)return!1;if("Terrain"===e.type){const i=e.id,s=t.id;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]||z(i,s)}return("Graphic"===e.type||"I3S"===e.type)&&e.id===t.id}_updateFromIntersectionResult(e){let t;if("Terrain"===e.type&&i(e.point)){this.view.renderCoordsHelper.toRenderCoords(e.point,ee),this.view.renderCoordsHelper.worldUpAtPosition(ee,ie);const i=this.view.basemapTerrain.elevationBounds,s=this.view.renderCoordsHelper.getAltitude(ee),r=i?Math.abs(i.max-i.min)/Math.abs(s):100,o=s>0?1:-1;y(ie,ie),j(ie,ie,o*r),g(Y,ee,ie),D(Y,ee,se),t=this._getRayIntersection(se)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null}_updateAnalyses(e){if(this._set("updating",!1),!this.model.observer)return;if(this._analyses.some((e=>e.shouldIntersect))){const e=this._observer.intersection,t=e&&this._updateFromIntersectionResult(e);i(t)&&(this._observer.manipulator.location=t)}this._updateAnalysis(this._tracker,0);for(const t of this._analyses.items){if(e.done)return void this._set("updating",!0);this._updateAnalysis(t,1)&&e.madeProgress()}}_updateAnalysis(e,t){if(e.engine.visualization.visibleLineVisualElement.attached=e.shouldRender,e.engine.visualization.occludedLineVisualElement.attached=e.shouldRender,e.engine.visualization.undefinedLineVisualElement.attached=e.shouldRender,!e.shouldRender)return e.isDirty=!1,!1;if(!e.isDirty)return!1;if(e.shouldIntersect){const t=e.point.intersection,s=t&&this._updateFromIntersectionResult(t);i(s)&&(e.point.manipulator.location=s),e.shouldIntersect=!1}this.view.renderCoordsHelper.toRenderCoords(e.point.manipulator.location,e.engine.points.target),this.view.renderCoordsHelper.toRenderCoords(this._observer.manipulator.location,e.engine.points.observer);const s=0===t||this._canComputeAnalysis(e),r=e.engine,o=r.points.observer,n=r.points.target;this._screenPixelSize=this.view.state.camera.computeScreenPixelSizeAt(o),this._observer.intersection?h(ie,this._observer.intersection.normal):b(ie,n,o);const a=this._screenPixelSize;y(ie,ie),j(ie,ie,Math.min(a,1)),g(Y,o,ie),e.point.intersection?h(ie,e.point.intersection.normal):b(ie,o,n);const l=this.view.state.camera.computeScreenPixelSizeAt(n);if(y(ie,ie),j(ie,ie,Math.min(l,1)),g(ee,n,ie),s){const t=D(Y,ee,se);if(this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this._intersector),e.hasIntersection=!!this._intersector.results.min&&this._intersector.results.min.getIntersectionPoint(te),e.isTargetVisible=!0,e.hasIntersection){h(r.points.intersection,te),h(r.points.intersectionObserver,Y),h(r.points.intersectionTarget,ee),this.view.renderCoordsHelper.fromRenderCoords(r.points.intersection,X,this.view.spatialReference);const t=1-f(ee,n)/f(o,n);e.isTargetVisible=f(o,r.points.intersection)>=t*f(o,n)}e.isValid=!0;const i=new u(X,this.view.spatialReference);e.target.intersectedLocation=e.isTargetVisible?null:i,e.target.intersectedGraphic=e.isTargetVisible?null:this._intersector.results.min.toGraphic(this.view),e.target.visible=!!e.hasIntersection&&e.isTargetVisible}else if(e.isValid){h(te,r.points.intersection);const t=f(e.engine.points.intersectionObserver,r.points.intersection)/f(e.engine.points.intersectionObserver,e.engine.points.intersectionTarget);_(re,Y,e.engine.points.intersectionObserver),j(re,re,1-t),g(te,te,re),_(re,ee,e.engine.points.intersectionTarget),j(re,re,t),g(te,te,re)}else e.hasIntersection=!1,e.target.intersectedLocation=null,e.target.intersectedGraphic=null,e.target.visible=void 0;oe[12]=r.points.observer[0],oe[13]=r.points.observer[1],oe[14]=r.points.observer[2],b(Y,Y,r.points.observer),b(ee,ee,r.points.observer),b(te,te,r.points.observer),e.engine.visualization.visibleLineVisualElement.geometry=null,e.engine.visualization.occludedLineVisualElement.geometry=null,e.engine.visualization.undefinedLineVisualElement.geometry=null;const p=this.configuration;return e.isValid?(e.point.manipulator.state=e.isTargetVisible?16:32,e.isTargetVisible?(e.engine.visualization.visibleLineVisualElement.geometry=[[[Y[0],Y[1],Y[2]],[ee[0],ee[1],ee[2]]]],e.engine.visualization.visibleLineVisualElement.transform=oe,e.engine.visualization.visibleLineVisualElement.color=v.toUnitRGBA(p.lineOfSightVisibleOuterColor)):(e.engine.visualization.visibleLineVisualElement.geometry=[[[Y[0],Y[1],Y[2]],[te[0],te[1],te[2]]]],e.engine.visualization.visibleLineVisualElement.transform=oe,e.engine.visualization.visibleLineVisualElement.color=v.toUnitRGBA(p.lineOfSightOccludedOuterColor),e.engine.visualization.occludedLineVisualElement.geometry=[[[te[0],te[1],te[2]],[ee[0],ee[1],ee[2]]]],e.engine.visualization.occludedLineVisualElement.transform=oe)):(e.point.manipulator.state=64,e.engine.visualization.undefinedLineVisualElement.geometry=[[[Y[0],Y[1],Y[2]],[ee[0],ee[1],ee[2]]]],e.engine.visualization.undefinedLineVisualElement.transform=oe),e.isDirty=!1,!0}};e([o({constructOnly:!0})],K.prototype,"view",void 0),e([o({constructOnly:!0})],K.prototype,"model",void 0),e([o({readOnly:!0})],K.prototype,"state",null),e([o({readOnly:!0})],K.prototype,"cursor",null),e([o({readOnly:!0})],K.prototype,"isSupported",null),e([o({type:J})],K.prototype,"configuration",void 0),e([o({readOnly:!0})],K.prototype,"updating",void 0),e([o()],K.prototype,"_showTracker",void 0),K=e([a("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],K);const X=c(),Y=c(),ee=c(),te=c(),ie=c(),se=E(),re=c(),oe=w(),ne=M.create();let ae=class extends n{constructor(e){super(e),this.observer=null}get targets(){return this._get("targets")||new Z}set targets(e){this._set("targets",m(e,this.targets,Z))}};e([o()],ae.prototype,"observer",void 0),e([o({type:Z,cast:p,nonNullable:!0})],ae.prototype,"targets",null),ae=e([a("esri.views.3d.interactive.graphics.LineOfSight")],ae);const le=r.getLogger("esri.widgets.LineOfSight.LineOfSightViewModel");let pe=class extends H{constructor(e){super(e),this.supportedViewType="3d",this.model=new ae,this.observer=null,this.targets=new Z}get state(){return this.isDisabled?"disabled":this.tool?this.tool.state:"ready"}start(){return this.createTool()}clear(){this.removeTool(),this.observer=null,this.targets.removeAll()}continue(){this.tool&&this.tool.continue()}stop(){this.tool&&this.tool.stop()}createToolParams(){return{toolConstructor:K,constructorArguments:()=>({model:this.model})}}logUnsupportedError(){this.logError("LineOfSight widget is not implemented for MapView")}logError(...e){le.error(...e)}};e([o({readOnly:!0})],pe.prototype,"state",null),e([o()],pe.prototype,"model",void 0),e([o()],pe.prototype,"tool",void 0),e([o({aliasOf:"model.observer"})],pe.prototype,"observer",void 0),e([o({aliasOf:"model.targets"})],pe.prototype,"targets",void 0),pe=e([a("esri.widgets.lineOfSight.LineOfSightViewModel")],pe);var me=pe;export default me;
