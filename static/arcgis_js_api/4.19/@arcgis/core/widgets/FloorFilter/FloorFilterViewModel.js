/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.19/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../core/lang.js";import"../../chunks/deprecate.js";import"../../chunks/object.js";import"../../config.js";import{i}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{createTask as l}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import s from"../../core/Error.js";import"../../chunks/ensureType.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import o from"../../core/Collection.js";import"../../chunks/JSONSupport.js";import"../../core/urlUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../core/Handles.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import"../../TimeInterval.js";import{init as n,watch as a}from"../../core/watchUtils.js";import{a as u,W as h}from"../../chunks/Widgets.js";import{HandleOwner as d}from"../../core/HandleOwner.js";import{G as c}from"../../chunks/GoTo.js";function v(e){return"esri.WebMap"===e.declaredClass}let f=class extends(c(d)){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null}initialize(){this.handles.add([n(this,"view.map",(e=>{i(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=l((()=>this._updateFloorFilterFromMap(e).then((()=>{this._setInitialViewState()}))))})),n(this,"view",((e,i)=>{this._unregisterWidget(i),this._registerWidget(e)}),!0),a(this,"view.widthBreakpoint",(e=>{this._viewWidthBreakpoint=e})),a(this,"view.heightBreakpoint",(e=>{this._viewHeightBreakpoint=e}))])}destroy(){this._unregisterWidget(this.view),this.view=null,i(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){const i=this.getFacility(e);this.hasMultipleSites&&(this.site=(null==i?void 0:i.siteId)||void 0)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.facilityLayer)&&(null==(i=this.filterFeatures)||null==(t=i.facilities)||null==(l=t.facilitiesInfo)?void 0:l.length)>0}get hasLevels(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.levelLayer)&&(null==(i=this.filterFeatures)||null==(t=i.levels)||null==(l=t.levelsInfo)?void 0:l.length)>0}get hasMultipleSites(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.siteLayer)&&(null==(i=this.filterFeatures)||null==(t=i.sites)||null==(l=t.sitesInfo)?void 0:l.length)>1}get isNormalMode(){let e=!0;const i=this._viewWidthBreakpoint,t=this._viewHeightBreakpoint;return"small"!==i&&"xsmall"!==i&&"small"!==t&&"xsmall"!==t||(e=!1),e}set level(e){if(!e)return this._callOverride("level",e),this.facility=void 0,this.site=void 0,void this.setFloors(null);let i=null,t=null;const l=null==e?void 0:e.split("--");var s;(null==l?void 0:l.length)>1&&"all"===l[0]?(t=l[1],i={id:e,facilityId:t,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(i=this.getLevel(e),t=null==(s=i)?void 0:s.facilityId);if(this.level!==e||this.isNormalMode||this.levelsExpanded){if(i&&this.hasFacilities&&this.hasLevels){var r;if(this.facility=t,this.hasMultipleSites)this.site=null==(r=this.getFacility(t))?void 0:r.siteId;this.setFloors(i)}else this._isOverridden("level")&&(this.facility=void 0,this.site=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",e)}else{const e=this.getFacilityLevels(t);(null==e?void 0:e.length)>1&&(this.levelsExpanded=!0)}}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let i=e;this.searchTerm&&(i=e.filter((e=>{const{name:i}=e;return i.toLowerCase().includes(this.searchTerm.toLowerCase())}))),this.site&&(i=i.filter((e=>e.siteId===this.site)));return i.sort(((e,i)=>{const t=e.name,l=i.name;return t>l?1:t===l?0:-1}))}filterSites(e){let i=e;this.searchTerm&&(i=e.filter((e=>{const{name:i}=e;return i.toLowerCase().includes(this.searchTerm.toLowerCase())})));return i.sort(((e,i)=>{const t=e.name,l=i.name;return t>l?1:t===l?0:-1}))}getBaseLevel(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;let s=null;if(e){const{id:i}=e;l&&l.length>0&&l.forEach((e=>{0===e.verticalOrder&&e.facilityId===i&&(s=e)}))}return s}getFacility(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.facilities)||null==(s=l.facilitiesInfo)?void 0:s.find((i=>i.id===e)))?i:null}getFacilityLevels(e){var i,t;if(!e||null==(i=this.filterFeatures)||null==(t=i.levels)||!t.levelsInfo)return[];return this.filterFeatures.levels.levelsInfo.filter((i=>i.facilityId===e)).sort(((e,i)=>{const t=e.verticalOrder,l=i.verticalOrder;return t>l?-1:t===l?0:1}))}getLevel(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.levels)||null==(s=l.levelsInfo)?void 0:s.find((i=>i.id===e)))?i:null}getSite(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.sites)||null==(s=l.sitesInfo)?void 0:s.find((i=>i.id===e)))?i:null}goTo(e){const{view:i}=this;if(!i||!e)return;const{geometry:t}=e;if(t&&t.extent){const e={duration:1e3,easing:"out-back"},i={target:t.extent,options:e};this.callGoTo(i)}}setFloors(e){var i,t,l;null==(i=this.view)||null==(t=i.map)||null==(l=t.layers)||l.forEach((e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)})),this.view.floors=new o(this._computeFloors(e))}updateWebDocument(e){if(v(e)){var i,t,l;const s=new u({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:null!=(i=this.site)?i:null,facility:null!=(t=this.facility)?t:null,level:null!=(l=this.level)?l:null});e.widgets?e.widgets.floorFilter=s:e.widgets=new h({floorFilter:s})}}_computeFloors(e){if("single-floor"===this.filterMode)this._computeSingleFloor(e);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();const i=[];if("all"===(null==e?void 0:e.id)){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)}))}else e&&i.push(e.id);return i}_computeBaseFloors(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;if(!l||!l.length)return this._computeEmptyFloors();const s=[];if("all"===(null==e?void 0:e.id)){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&s.push(e.id)}))}else e&&s.push(e.id);const r=null==e?void 0:e.facilityId;return l.forEach((e=>{const{id:i,facilityId:t,verticalOrder:l}=e;(r||0!==l||s.includes(i))&&(t===r||0!==l||s.includes(i))||s.push(i)})),s}_computeBaseFloors3D(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;if(!l||!l.length)return this._computeEmptyFloors();const s=[],r=null==e?void 0:e.id.split("--");if((null==r?void 0:r.length)>1&&"all"===r[0]){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&s.push(e.id)}))}else e&&s.push(e.id);const o=null==e?void 0:e.facilityId;return l.forEach((e=>{const{id:i,facilityId:t}=e;(o||s.includes(i))&&(t===o||s.includes(i))||s.push(i)})),s}_computeEmptyFloors(){return[]}_setFilterLayers(){const{view:e}=this;if(!this._isOverridden("filterLayers")){if(!v(e.map)&&"esri.WebScene"!==e.map.declaredClass)throw new s("Map must be a webmap or webscene");{var i;const s=e.map,u=null==s?void 0:s.layers;if((null==u||null==(i=u.items)?void 0:i.length)>0){var t,l,r,o,n,a;const e={siteLayer:null,facilityLayer:null,levelLayer:null},i=null==(t=s.floorInfo)||null==(l=t.siteLayer)?void 0:l.layerId,h=null==(r=s.floorInfo)||null==(o=r.facilityLayer)?void 0:o.layerId,d=null==(n=s.floorInfo)||null==(a=n.levelLayer)?void 0:a.layerId;u.items.filter((e=>"feature"===e.type||"scene"===e.type)).forEach((t=>{const l=t.id;l&&(l===i?e.siteLayer=t:l===h?e.facilityLayer=t:l===d&&(e.levelLayer=t))})),this.filterLayers=e}}}}async _getFilterFeatures(){if(this._isOverridden("filterFeatures"))return Promise.resolve(this.filterFeatures);const e={sites:null,facilities:null,levels:null},i=await this._getSites();e.sites=i;const t=await this._getFacilities();e.facilities=t;const l=await this._getLevels();return e.levels=l,e}async _getSites(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{siteLayer:r}=t,o={sitesInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.siteLayer)return o;const n=r.createQuery();n.where="1=1",n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0;const{siteIdField:a,nameField:u}=s.floorInfo.siteLayer,h=await r.queryFeatures(n);if((null==h||null==(i=h.features)?void 0:i.length)>0){h.features.forEach((e=>{const i=e.attributes,t=e.geometry,l=i[a],s=i[u];l&&s&&o.sitesInfo.push({id:l,name:s,geometry:t})}))}return o}async _getFacilities(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{facilityLayer:r}=t,o={facilitiesInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.facilityLayer)return o;const n=r.createQuery();n.where="1=1",n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0;const{facilityIdField:a,siteIdField:u,nameField:h}=s.floorInfo.facilityLayer,d=await r.queryFeatures(n);if((null==d||null==(i=d.features)?void 0:i.length)>0){d.features.forEach((e=>{const i=e.attributes,t=e.geometry,l=i[a],s=i[u],r=i[h];l&&r&&o.facilitiesInfo.push({id:l,siteId:s,name:r,geometry:t})}))}return o}async _getLevels(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{levelLayer:r}=t,o={levelsInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.levelLayer)return o;const n=r.createQuery();n.where="1=1",n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0;const{levelIdField:a,facilityIdField:u,longNameField:h,shortNameField:d,levelNumberField:c,verticalOrderField:v}=s.floorInfo.levelLayer,f=await r.queryFeatures(n);if((null==f||null==(i=f.features)?void 0:i.length)>0){f.features.forEach((e=>{const i=e.attributes,t=i[a],l=i[u],s=i[h],r=i[d],n=i[c],f=i[v];t&&l&&s&&r&&"number"==typeof n&&"number"==typeof f&&o.levelsInfo.push({id:t,facilityId:l,longName:s,shortName:r,levelNumber:n,verticalOrder:f})}))}return o}_registerWidget(e){(null==e?void 0:e.persistableViewModels.some((e=>e===this)))||null==e||e.persistableViewModels.add(this)}_unregisterWidget(e){null==e||e.persistableViewModels.remove(this)}_setInitialViewState(){this.view&&(this._setFilterLayers(),this._getFilterFeatures().then((e=>{if(e)if(this.filterFeatures=e,this.hasFacilities&&this.hasLevels){this.hasMultipleSites||(this.filterMenuType="facility");this.view.when().then((()=>{if(this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getLevel(this.level);this.setFloors(i),this.goTo(e)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getBaseLevel(e);this.site||(this.site=e.siteId||void 0),this.level=(null==i?void 0:i.id)||void 0,this.setFloors(i),this.goTo(e)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),i=this.getFacility(null==e?void 0:e.facilityId);this.facility=(null==i?void 0:i.id)||void 0,this.site||(this.site=(null==i?void 0:i.siteId)||void 0),this.setFloors(e),this.goTo(i)}else if(!this.site||this.facility||this.level)this.setFloors(null);else{this.filterMenuType="site";const e=this.getSite(this.site);this.setFloors(null),this.goTo(e)}}))}else console.error("Facilities and Levels are required for the Floor Filter widget")})).catch((e=>{console.error("Couldn't retrieve sites, facilities, and levels",e)})))}_callOverride(e,i){this._override(e,i)}async _updateFloorFilterFromMap(e){var i;if(!e||!v(e))return;const t=null==e||null==(i=e.widgets)?void 0:i.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))}_computeViewAllModeFloors(e){var i;const{filterFeatures:t}=this;if(null!=(i=e.floorInfo)&&i.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const{level:i,facility:l}=this,s=[];t.levels.levelsInfo.forEach((e=>{const{id:t,facilityId:r}=e;l&&r===l?i&&t===i&&s.push(t):s.push(t)})),e.floorInfo.viewAllLevelIds=new o(s)}}};e([t({value:!1})],f.prototype,"enabled",null),e([t({value:void 0})],f.prototype,"facility",null),e([t({value:null})],f.prototype,"filterFeatures",null),e([t({value:null})],f.prototype,"filterLayers",null),e([t()],f.prototype,"filterMenuOpen",void 0),e([t()],f.prototype,"filterMenuType",void 0),e([t()],f.prototype,"filterMode",void 0),e([t()],f.prototype,"hasFacilities",null),e([t()],f.prototype,"hasLevels",null),e([t()],f.prototype,"hasMultipleSites",null),e([t({readOnly:!0})],f.prototype,"isNormalMode",null),e([t({value:void 0})],f.prototype,"level",null),e([t({value:!1})],f.prototype,"longNames",null),e([t()],f.prototype,"levelsExpanded",void 0),e([t({value:!1})],f.prototype,"minimized",null),e([t({value:!1})],f.prototype,"pinnedLevels",null),e([t()],f.prototype,"searchTerm",void 0),e([t({value:void 0})],f.prototype,"site",null),e([t({readOnly:!0})],f.prototype,"state",null),e([t()],f.prototype,"view",void 0),e([t()],f.prototype,"_viewHeightBreakpoint",void 0),e([t()],f.prototype,"_viewWidthBreakpoint",void 0),e([t()],f.prototype,"updateWebDocument",null),f=e([r("esri/widgets/FloorFilter/FloorFilterViewModel")],f);var p=f;export default p;
