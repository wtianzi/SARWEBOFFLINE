//>>built
define(["../errors/RequestError","./watch","./handlers","./util","../has"],function(t,y,z,l,p){function A(a,b){var c=a.xhr;a.status=a.xhr.status;try{a.text=c.responseText}catch(d){}"xml"===a.options.handleAs&&(a.data=c.responseXML);if(b)this.reject(b);else{try{z(a)}catch(d){var h=d}l.checkStatus(c.status)?h?this.reject(h):this.resolve(a):(b=h?new t("Unable to load "+a.url+" status: "+c.status+" and an error in handleAs: transformation of response",a):new t("Unable to load "+a.url+" status: "+c.status,
a),this.reject(b))}}function B(a){return this.xhr.getResponseHeader(a)}function q(a,b,c){var h=b&&b.data&&b.data instanceof FormData,d=l.parseArgs(a,l.deepCreate(C,b),h);a=d.url;b=d.options;var u=!b.data&&"POST"!==b.method&&"PUT"!==b.method;10>=p("ie")&&(a=a.split("#")[0]);var n,f=l.deferred(d,D,E,F,A,function(){n&&n()}),e=d.xhr=q._create();if(!e)return f.cancel(new t("XHR was not created")),c?f:f.promise;d.getHeader=B;v&&(n=v(e,f,d,b.uploadProgress));var g="undefined"===typeof b.data?null:b.data,
k=!b.sync,G=b.method;try{e.open(G,a,k,b.user||w,b.password||w);b.withCredentials&&(e.withCredentials=b.withCredentials);b.handleAs in x&&(e.responseType=x[b.handleAs]);var m=b.headers;a=h||u?!1:"application/x-www-form-urlencoded";if(m)for(var r in m)"content-type"===r.toLowerCase()?a=m[r]:m[r]&&e.setRequestHeader(r,m[r]);a&&!1!==a&&e.setRequestHeader("Content-Type",a);m&&"X-Requested-With"in m||e.setRequestHeader("X-Requested-With","XMLHttpRequest");l.notify&&l.notify.emit("send",d,f.promise.cancel);
e.send(g)}catch(H){f.reject(H)}y(f);e=null;return c?f:f.promise}p.add("dojo-force-activex-xhr",function(){return 0});p.add("native-blob",function(){return"undefined"!==typeof Blob});p.add("native-arraybuffer",function(){return"undefined"!==typeof ArrayBuffer});var x={blob:"blob",document:"document",arraybuffer:"arraybuffer"},F;var E=function(a){return!this.isFulfilled()};var D=function(a,b){b.xhr.abort()};var v=function(a,b,c,h){function d(g){b.handleResponse(c)}function u(g){g=new t("Unable to load "+
c.url+" status: "+g.target.status,c);b.handleResponse(c,g)}function n(g,k){c.transferType=g;k.lengthComputable?(c.loaded=k.loaded,c.total=k.total,b.progress(c)):3===c.xhr.readyState&&(c.loaded="loaded"in k?k.loaded:k.position,b.progress(c))}function f(g){return n("download",g)}function e(g){return n("upload",g)}a.addEventListener("load",d,!1);a.addEventListener("error",u,!1);a.addEventListener("progress",f,!1);h&&a.upload&&a.upload.addEventListener("progress",e,!1);return function(){a.removeEventListener("load",
d,!1);a.removeEventListener("error",u,!1);a.removeEventListener("progress",f,!1);a.upload.removeEventListener("progress",e,!1);a=null}};var w,C={data:null,query:null,sync:!1,method:"GET"};q._create=function(){throw Error("XMLHTTP not available");};p("dojo-force-activex-xhr")||(q._create=function(){return new XMLHttpRequest});l.addCommonMethods(q);return q});