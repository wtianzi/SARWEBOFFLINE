// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../geometry/Point ../../core/Evented ../../core/Collection ../../intl/locale ../../intl/messages ../../assets ../../intl ../../symbols/PictureMarkerSymbol ../../Graphic ../../core/Handles ../../core/watchUtils ../../geometry/projection ../support/GoTo ../../portal/support/geometryServiceUtils ./support/Conversion ./support/coordinateConversionUtils ./support/formatUtils".split(" "),
function(k,g,f,E,S,h,T,F,n,U,V,W,u,v,G,w,H,I,J,X,K,L,M,x,N,O,P,y,z,Q){const R=new v([0,0,500]),A=`${window.location.pathname}__coordinateConversionWidgetState`,r=E.getLogger("esri.widgets.CoordinateConversion.CoordinateConversionViewModel");let B=0,q=[];f=function(C){function t(a){a=C.call(this,a)||this;a._conversionPromise=null;a._handles=new M;a._locationGraphic=null;a._locale=H.getLocale();a._pointerCount=0;a.conversions=new w;a.formats=new w;a.formatterAvailable=!1;a.geometryServicePromise=null;
a.messages=null;a.requestDelay=300;a.locationSymbol=new K({url:J.getAssetUrl("esri/images/search/search-symbol-32.png"),width:24,height:24});a.view=null;a._instanceNumber=B;B++;a._saveWidgetState=a._saveWidgetState.bind(k._assertThisInitialized(a));a._handleFormatChange=a._handleFormatChange.bind(k._assertThisInitialized(a));a._handleConversionChange=a._handleConversionChange.bind(k._assertThisInitialized(a));a._handleViewChange=a._handleViewChange.bind(k._assertThisInitialized(a));a._onClick=a._onClick.bind(k._assertThisInitialized(a));
a._onPointerMove=a._onPointerMove.bind(k._assertThisInitialized(a));a._onPointerDown=a._onPointerDown.bind(k._assertThisInitialized(a));a._onPointerUp=a._onPointerUp.bind(k._assertThisInitialized(a));return a}k._inheritsLoose(t,C);var c=t.prototype;c.initialize=function(){(async()=>this.messages=await I.fetchMessageBundle("esri/widgets/CoordinateConversion/t9n/CoordinateConversion"))().then(()=>{if(!this.destroyed&&(this.formats.addMany(Q.generateDefaultFormats(this.messages)),this._loadWidgetState(),
this.formats.forEach(a=>{a.viewModel=this;this._handles.add(a.watch("currentPattern",this._saveWidgetState),a.name)}),this._handles.add(this.conversions.on("change",this._handleConversionChange),"conversions"),this._handles.add(this.formats.on("change",this._handleFormatChange),"formats"),this._handles.add(x.init(this,"view.map",()=>{this.geometryServicePromise=P.create(this.get("view.map.portalItem"))}),"view-change"),N.load().then(()=>{this.formatterAvailable=!0}).catch(a=>{r.error(new n("coordinate-conversion:projection-load-failed",
"Failed to load the projection module.",{error:a}));this.formatterAvailable=!1}).then(()=>this._handles.add(x.init(this,"view",this._handleViewChange),"view-change")),0===this.conversions.length)){const a=this.formats.find(b=>"xy"===b.name)||this.formats.getItemAt(0);this.conversions.add(new y({format:a}))}})};c.destroy=function(){this._handles.removeAll();this._cleanUpView(this.view);this.view=null};c.setLocation=function(a){this.view.graphics.remove(this._locationGraphic);a&&(a=a.clone(),a.hasZ&&
(a.z=void 0),this._locationGraphic=new L({geometry:a,symbol:this.get("locationSymbol")}),this.view.graphics.add(this._locationGraphic))};c.convert=function(a,b){return z.isValidPoint(b)?Promise.resolve().then(()=>a.convert(b)):Promise.reject(new n("coordinate-conversion:invalid-point","Invalid point cannot be converted.",{point:b}))};c.goToLocation=function(a){if(this.get("view.clippingArea")||0<this.get("view.map.basemap.baseLayers.length")){const b=this.get("view.clippingArea")||this.view.map.basemap.baseLayers.getItemAt(0).fullExtent;
return b?b.contains(a)?this.callGoTo({target:a}):Promise.reject(new n("coordinate-conversion:go-to-failed","Point outside basemap extent.",{point:a})):this.callGoTo({target:a})}return this.callGoTo({target:a})};c.pause=function(){this.currentLocation=null;this._handles.remove("view");this.view&&(this.view.cursor="default",this.view.graphics.remove(this._locationGraphic))};c.previewConversion=function(a,b=this.currentLocation||R){return this._convertMany([a],b).then(()=>a.displayCoordinate)};c.resume=
function(){"capture"===this.mode?this._startCaptureMode():this._startLiveMode()};c.reverseConvert=function(a,b){return b.reverseConvert(a)};c.updateConversions=async function(a,b){return b&&b.type&&"point"===b.type?this._convertMany(a,b).then(d=>d.client.concat(d.server)):(this._clearConversions(this.conversions),Promise.reject(new n("coordinate-conversion:invalid-input-point","Point is invalid, conversions cannot be updated.",{point:b})))};c._cleanUpView=function(a){a&&(a.graphics.remove(this._locationGraphic),
this._handles.remove("view"),a.cursor="default")};c._clearConversions=function(a){a.forEach(b=>{b.position={location:null,coordinate:null}})};c._convertMany=function(a,b){const {client:d,server:l}=a.reduce((e,p)=>{const m=p.format.getConversionStrategy();e[m].push(p);return e},{client:[],server:[]});a=Promise.all(d.map(e=>e.format.convert(b).then(p=>{e.position=p;return e}).catch(()=>{e.position=null})));const D=e=>{if(!e)return[];this._conversionPromise=null;this.notifyChange("waitingForConversions");
return e.map((p,m)=>{m=l[m];if(p.error)return m.position=null,m;m.position=p.value;return m})};this._conversionPromise=0<l.length?this._debouncedConvert(l.map(e=>e.format),b).then(D,D):Promise.resolve([]);this.notifyChange("waitingForConversions");return Promise.all([a,this._conversionPromise]).then(e=>({client:e[0],server:e[1]}))};c._handleConversionChange=function(a){a.added.forEach(b=>{const d=b.format;d.viewModel=this;this.currentLocation&&(this._set("waitingForConversions",!0),this.convert(d,
this.currentLocation).then(l=>{b.position=l;this._set("waitingForConversions",!1)}))});this._saveWidgetState()};c._handleFormatChange=function(a){a.added.forEach(b=>{this._handles.add(b.watch("currentPattern",this._saveWidgetState),b.name);b.viewModel=this});a.removed.forEach(b=>{b.viewModel=null;this._handles.remove(b.name)})};c._loadWidgetState=function(){if(0===this._instanceNumber)try{const a=JSON.parse(localStorage.getItem(A));a&&(q=a)}catch(a){r.error(new n("coordinate-conversion:invalid-local-storage-json",
"Could not read from localStorge.",{error:a}))}this._setWidgetState()};c._startCaptureMode=function(){this._handles.remove("view");this.view&&(this.view.cursor="crosshair",this.currentLocation&&this.setLocation(this.currentLocation),this._handles.add(this.view.on("click",this._onClick),"view"))};c._startLiveMode=function(){this._pointerCount=0;this._handles.remove("view");this.view&&(this.view.cursor="default",this.view.graphics.remove(this._locationGraphic),this._handles.add([this.view.on("pointer-down",
this._onPointerDown),this.view.on("pointer-up",this._onPointerUp),this.view.on("pointer-move",this._onPointerMove)],"view"))};c._handleViewChange=function(a,b){b&&b!==a&&this._cleanUpView(b);a&&("capture"===this.mode&&this._startCaptureMode(),this._startLiveMode())};c._onClick=function(a){0===a.button&&(a=(a=this.view.toMap(a))&&a.normalize(),this.setLocation(a),this.currentLocation=a)};c._onPointerDown=function(a){const {pointerType:b}=a;this._pointerCount++;"touch"!==b&&"pen"!==b||1!==this._pointerCount||
(this.currentLocation=(a=this.view.toMap(a))&&a.normalize())};c._onPointerMove=function(a){const {pointerType:b}=a;if("mouse"===b||1===this._pointerCount)this.currentLocation=(a=this.view.toMap(a))&&a.normalize()};c._onPointerUp=function(){this._pointerCount--};c._setWidgetState=function(){const a=q[this._instanceNumber];if(a)try{a.formats.forEach(b=>{const d=this.formats.find(l=>l.name===b.name);d&&a.locale===this._locale&&b.currentPattern&&(d.currentPattern=b.currentPattern);d&&0<=b.index&&this.conversions.add(new y({format:d}))})}catch(b){r.warn(new n("coordinate-conversion:local-storage-read-error",
"Could not get widget state from stored JSON.",{error:b})),q[this._instanceNumber]={formats:[],locale:this._locale}}else q[this._instanceNumber]={formats:[],locale:this._locale}};c._saveWidgetState=function(){const a=this._toJSON();q[this._instanceNumber]={formats:a,locale:this._locale};try{localStorage.setItem(A,JSON.stringify(q))}catch(b){r.error(new n("coordinate-conversion:local-storage-write-error","Could not write to localStorage.",{error:b}))}};c._updateConversions=async function(){try{await this.updateConversions(this.conversions.toArray(),
this.currentLocation)}catch{}};c._toJSON=function(){return this.formats.filter(a=>{a=a.name;return"xy"===a||"basemap"===a||z.isSupportedNotation(a)}).map(a=>({name:a.name,currentPattern:a.currentPattern,defaultPattern:a.defaultPattern,index:this.conversions.findIndex(b=>b.format===a)})).sort((a,b)=>a.index-b.index).toArray()};k._createClass(t,[{key:"currentLocation",get:function(){return this._get("currentLocation")||null},set:function(a){this._set("currentLocation",a);this._updateConversions()}},
{key:"mode",get:function(){return this._get("mode")||"live"},set:function(a){switch(a){case "capture":this.currentLocation=null;this._startCaptureMode();this._set("mode",a);break;case "live":this._startLiveMode(),this._set("mode",a)}}},{key:"state",get:function(){const {messages:a,view:b}=this,d=null==b?void 0:b.ready;return a?d?"ready":b?"loading":"disabled":"disabled"}},{key:"waitingForConversions",get:function(){return null!=this._conversionPromise}},{key:"_debouncedConvert",get:function(){return u.debounce((a,
b,d)=>u.eachAlways(a.map(l=>l.convert(b,d))),this.requestDelay)}}]);return t}(O.GoToMixin(G.EventedAccessor));g.__decorate([h.property()],f.prototype,"conversions",void 0);g.__decorate([h.property({type:v})],f.prototype,"currentLocation",null);g.__decorate([h.property()],f.prototype,"formats",void 0);g.__decorate([h.property()],f.prototype,"messages",void 0);g.__decorate([h.property()],f.prototype,"mode",null);g.__decorate([h.property()],f.prototype,"requestDelay",void 0);g.__decorate([h.property({readOnly:!0})],
f.prototype,"state",null);g.__decorate([h.property()],f.prototype,"locationSymbol",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"waitingForConversions",null);g.__decorate([h.property()],f.prototype,"view",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"_debouncedConvert",null);return f=g.__decorate([F.subclass("esri.widgets.CoordinateConversion.CoordinateConversionViewModel")],f)});