// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../geometry/Point ../../geometry/support/coordsUtils ../../geometry ../../core/Evented ../../core/Collection ../../symbols/CIMSymbol ../../core/screenUtils ../../symbols/SimpleLineSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleMarkerSymbol ../../symbols ../../Graphic ../../core/Handles ../../geometry/projectionEllipsoid ../../core/watchUtils ../../layers/GraphicsLayer ../../views/input/InputManager ../../views/DOMContainer ../../views/support/screenUtils ../../views/draw/Draw ../../views/interactive/snapping/SnappingOptions ../../views/3d/interactive/editingTools/isSupportedGraphicUtils ../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic ../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic ../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic ../../views/draw/support/createUtilsAsync ../../views/draw/support/layerUtils ../../views/interactive/snapping/SnappingManager ./support/OperationHandle".split(" "),
function(E,U,u,t,r,da,va,v,wa,ea,fa,xa,ya,za,L,M,V,Aa,ha,ia,ja,N,Q,O,D,I,z,W,ka,F,la,w,ma,R,na,X,Y,oa,S,pa,P,Z,qa,G){function T(y){return Object.freeze({__proto__:null,"default":y})}function J(y,B){const n=y.history.undo.pop().updates,a=[];B.forEach((c,d)=>{d=n[d];const b={};null!=d&&(r.isSome(d.geometry)&&(b.geometry=c.geometry,c.geometry=d.geometry),r.isSome(d.symbol)&&(b.symbol=c.symbol,c.symbol=d.symbol),a.push(b))});y.history.redo.push({updates:a})}function K(y,B){const n=y.history.redo.pop().updates,
a=[];B.forEach((c,d)=>{d=n[d];const b={};null!=d&&(r.isSome(d.geometry)&&(b.geometry=c.geometry,c.geometry=d.geometry),r.isSome(d.symbol)&&(b.symbol=c.symbol,c.symbol=d.symbol),a.push(b))});y.history.undo.push({updates:a})}function C(y){return{updates:y.map(B=>({geometry:B.geometry}))}}function aa(y){return{updates:y.map(B=>({symbol:B.symbol}))}}function x(y){return"requireError"in y&&"aborted"===y.requireError}const ra=da.getLogger("esri.widgets.Sketch.SketchViewModel");var sa=["Backspace","Delete"];
const ba={defaultZ:0},ca={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0,enableMoveGraphic:!0};t=function(y){function B(a){a=y.call(this,a)||this;a._activeFillGraphic=null;a._activeLineGraphic=null;a._centerIndicatorGraphic=null;a._centerSymbol=new D({style:"cross",size:6,color:[255,255,255]});a._defaultSegmentOffset=48;a._numUpdating=0;a._handles=new W;a._internalGraphicsLayer=
new la({listMode:"hide",internal:!0});a._lineGraphic=null;a._operationHandle=null;a._vertexGraphics=[];a._viewHandles=new W;a._doUnnormalization=!1;a._moveOperationCloneInfos=[];a.activeFillSymbol=new O({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}});a.activeLineSymbol=new ja({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],
enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}});a.activeVertexSymbol=new D({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}});a.layer=null;a.pointSymbol=new D({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});a.polygonSymbol=new O({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}});
a.polylineSymbol=new Q({color:[130,130,130,1],width:2});a._snappingManager=null;a.updateGraphics=new ia;a.updateOnGraphicClick=!0;a.updatePointSymbol=new D({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}});a.updatePolygonSymbol=new O({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}});a.updatePolylineSymbol=new Q({color:[12,207,255],width:2});a.vertexSymbol=new D({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});a._moduleLoaderAbortController=
null;a._viewReadyAbortController=null;a._originalAutoOpenEnabled=null;a.defaultCreateOptions=ba;a.defaultUpdateOptions=ca;a.snappingOptions=new X;return a}U._inheritsLoose(B,y);var n=B.prototype;n.initialize=function(){this._handles.add([F.watch(this,"layer",()=>{this.cancel();this._internalGraphicsLayer.elevationInfo=r.isSome(this.layer)?this.layer.elevationInfo:null}),F.on(this,"view.map.layers","change",a=>{0<=a.removed.indexOf(this.layer)&&this.cancel()}),F.on(this,"layer.graphics","change",a=>
{if(r.isSome(this._operationHandle))for(const c of a.removed)this.updateGraphics.includes(c)&&(1<this.updateGraphics.length?this._operationHandle.removeFromSelection(c):this._operationHandle.cancel())}),F.init(this,"layer.elevationInfo",()=>{this.cancel();this._internalGraphicsLayer.elevationInfo=r.isSome(this.layer)?this.layer.elevationInfo:null},!0),F.init(this,"view",a=>{r.destroyMaybe(this._snappingManager);a&&(this._snappingManager=new qa.SnappingManager({view:a,options:this.snappingOptions}))},
!0)])};n.destroy=function(){this.cancel();this._handles=r.destroyMaybe(this._handles);this._viewHandles=r.destroyMaybe(this._viewHandles);this._removeDefaultLayer();r.destroyMaybe(this._draw);r.destroyMaybe(this._snappingManager);this._set("view",null);this.emit("destroy")};n.cancel=function(){this._moduleLoaderAbortController=r.abortMaybe(this._moduleLoaderAbortController);this._viewReadyAbortController=r.abortMaybe(this._viewReadyAbortController);this._operationHandle&&this._operationHandle.cancel()};
n.complete=function(){this._operationHandle&&this._operationHandle.complete()};n.delete=function(){const {state:a,updateGraphics:c}=this;if("active"===a&&c.length){const {activeTool:d,layer:b}=this,h=c.toArray();b.removeMany(h);this.cancel();this._emitDeleteEvent({graphics:h,tool:d})}};n.create=async function(a,c){await this._waitViewReady();if("disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property",
"Property 'view' is missing on SketchViewModel."),L.createAbortError();this.cancel();if(a){var d=await this._setupCreateOperation(a,c);r.isNone(d)||this.destroyed||(Z.addUniqueLayer(this.view,this._internalGraphicsLayer),d.on("complete",()=>{if(d===this._operationHandle){const b=this.createGraphic,h=this._operationHandle.cancelled;this._operationHandle.destroy();this._operationHandle=null;this._set("createGraphic",null);this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer);d.cancelled||
null==b||this.layer.add(b);this.emit("create",{graphic:b,state:h?"cancel":"complete",tool:a,toolEventInfo:null,type:"create"})}}),this._operationHandle=d,this.view.ready&&ma.isDOMContainer(this.view)&&this.view.focus())}else this._logError("sketch:missing-parameter","Missing parameter 'tool'.")};n.update=async function(a,c){await this._waitViewReady();const {layer:d,view:b,state:h}=this;if("disabled"===h)throw b||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),
d||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),L.createAbortError();this.cancel();const g=Array.isArray(a)?a:[a];null!=a&&g&&g.length?g.some(f=>f.layer!==d?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):r.isNone(f.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"!==
b.type||b.spatialReference.equals(f.geometry.spatialReference)?!1:(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))||(a=await this._setupUpdateOperation(g,c),this.destroyed||r.isNone(a)||x(a)||(Z.addUniqueLayer(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,c),this.emit("update",{graphics:g,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))):
this._logError("sketch:missing-parameter","Missing parameter 'graphics'.")};n.undo=function(){this.canUndo()&&this._operationHandle.undo()};n.redo=function(){this.canRedo()&&this._operationHandle.redo()};n.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())};n.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())};n.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()};
n._getFirstHit=async function(a){const c=[];switch(this.view.type){case "2d":var d=await this.view.hitTest(a);if(0<d.results.length&&(d=d.results[0],d.graphic)){var b,h;const g=d.graphic;"vector-tile"!==(null==(b=g.layer)?void 0:b.type)&&"imagery"!==(null==(h=g.layer)?void 0:h.type)&&c.push(d)}break;case "3d":{const g=[this.view.map.ground];this.view.map.allLayers.forEach(f=>{"integrated-mesh"===f.type&&g.push(f)});b=await this.view.hitTest(a,{exclude:g});0<b.results.length&&(h=b.results[0],(!b.ground.mapPoint||
1>this.view.map.ground.opacity||b.ground.distance-h.distance>-Math.min(3*b.ground.distance,"global"===this.view.viewingMode?ka.getReferenceEllipsoid(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&c.push(h))}}return{screenPoint:a,results:c}};n._generateViewHandles=function(a){return[a.on("immediate-click",c=>{const {_operationHandle:d,defaultUpdateOptions:b,layer:h,state:g,updateGraphics:f,updateOnGraphicClick:k}=this,e="active"===
g&&"create"===d.type;"disabled"!==g&&!e&&k&&(this._beginAsyncOperation(),this._getFirstHit(R.createScreenPointFromEvent(c)).then(m=>{m=m.results;if(m.length)for(let p=0;p<m.length;++p){var l=m[p];if(l.graphic){l=l.graphic;if(-1<f.indexOf(l)||l.layer===h)return c.stopPropagation(),l;"2d"!==a.type||this._isComponentGraphic(l)||"active"!==g||this.cancel()}}else"active"===g&&this.cancel();return null}).then(m=>r.isSome(m)&&-1===f.indexOf(m)?this.update([m],{...b}):null).then(()=>{this._endAsyncOperation()}))},
w.ViewEventPriorities.WIDGET)]};n._setupCreateOperation=async function(a,c){if(!a)return null;c={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...c};let d;if("2d"===this.view.type)switch(a){case "point":d=this._setupCreatePointOperation(a,c);break;case "multipoint":d=await this._setupCreateMultipointOperation(a,c);break;case "polygon":d=await this._setupCreatePolyOperation(a,c);break;case "polyline":d=await this._setupCreatePolyOperation(a,c);break;case "rectangle":d=await this._setupCreateRectangleOperation(a,
c);break;case "circle":d=await this._setupCreateCircleOperation(a,c)}else{a=await this._setupCreate3DOperation(a,this.view,c);if(r.isNone(a)||x(a))return null;d=a}return d};n._setupCreate3DOperation=async function(a,c,d){if("multipoint"===a)return null;const b={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol}[a];this._removeCreateOperationGraphics();const h="rectangle"===a?!1:!0,g="rectangle"===a?
!1:!0;this.snappingOptions.enabledToggled=!1;c={view:c,mode:"rectangle"===a||"circle"===a?"hybrid":"click",...d,elevationInfo:this.layer.elevationInfo,geometryType:a,createGraphicSymbol:b,snapToScene:r.isSome(this.layer.elevationInfo)?"absolute-height"===this.layer.elevationInfo.mode:!0,snappingManager:this._snappingManager,forceUniformSize:g,centered:h};d=await this._requireModule(new Promise(function(l,p){E(["../../views/3d/interactive/editingTools"],l,p)}));if(x(d))return d;if(this.destroyed)return null;
const f=new d.module.DrawGraphicTool(c);this.view.tools.add(f);let k=null;this.view.activeTool=f;const e=[],m=new G.OperationHandle({activeComponent:f,tool:a,type:"update",onEnd:()=>{var l;e.forEach(p=>p.remove());e.length=0;null==(l=this.view.tools)?void 0:l.remove(f);f.destroy()},undo:()=>{f.canUndo&&f.undo()},redo:()=>{f.canRedo&&f.redo()},canUndo:()=>f.canUndo,canRedo:()=>f.canRedo});e.push(this.view.on("key-down",l=>{" "===l.key?(l.stopPropagation(),l.repeat||(f.enabled=!1)):"c"===l.key?(l.stopPropagation(),
f.completeCreateOperation()):"z"===l.key?(l.stopPropagation(),m.undo()):"r"===l.key?(l.stopPropagation(),m.redo()):"Control"!==l.key||"rectangle"===a||"circle"===a||l.repeat?"Control"!==l.key||"rectangle"!==a&&"circle"!==a||l.repeat?"Alt"!==l.key||l.repeat||(f.centered=!h,l.stopPropagation()):(f.forceUniformSize=!g,l.stopPropagation()):(this.snappingOptions.enabledToggled=!0,l.stopPropagation())},w.ViewEventPriorities.WIDGET),this.view.on("key-up",l=>{" "===l.key?f.enabled=!0:"Control"===l.key&&"rectangle"!==
a&&"circle"!==a?(this.snappingOptions.enabledToggled=!1,l.stopPropagation()):"Control"!==l.key||"rectangle"!==a&&"circle"!==a?"Alt"===l.key&&(f.centered=h,l.stopPropagation()):(f.forceUniformSize=g,l.stopPropagation())},w.ViewEventPriorities.WIDGET),f.on("vertex-add",l=>{k=r.isNone(k)?"start":"active";switch(l.operation){case "apply":this.emit("create",{graphic:r.unwrap(f.createGraphic),state:k,tool:this.activeTool,toolEventInfo:l,type:"create"});break;case "undo":this._emitUndoEvent({graphics:[r.unwrap(f.createGraphic)],
tool:a});break;case "redo":this._emitRedoEvent({graphics:[r.unwrap(f.createGraphic)],tool:a})}}),f.on("cursor-update",l=>{0<f.drawOperation.numCommittedVertices&&this.emit("create",{graphic:r.unwrap(f.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:l.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),f.on("vertex-remove",l=>{switch(l.operation){case "apply":this.emit("create",{graphic:r.unwrap(f.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:l,
type:"create"});break;case "undo":this._emitUndoEvent({graphics:[r.unwrap(f.createGraphic)],tool:a});break;case "redo":this._emitRedoEvent({graphics:[r.unwrap(f.createGraphic)],tool:a})}}),f.on("complete",l=>{this._removeCreateOperationGraphics();this._set("createGraphic",r.unwrap(l.graphic));k="complete";l.aborted?m&&m.cancel():m&&m.complete()}));return m};n._setupCreatePointOperation=function(a,c){c=this._draw.create(a,{elevationInfo:this.layer.elevationInfo,hasZ:c.hasZ,defaultZ:c.defaultZ,snappingManager:this._snappingManager,
interactiveUndoDisabled:!0});const d=[c.on("cursor-update",g=>{r.isSome(g.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()}),c.on("draw-complete",g=>{g=this.createPointFromVertex(g.vertices[0]);g=new z(g,this.pointSymbol);this._set("createGraphic",g);h&&h.complete()})],b=[this.view.on("key-down",g=>{"Escape"===g.key&&(h&&h.cancel(),g.stopPropagation())},w.ViewEventPriorities.WIDGET)],h=this._operationHandleForCreateAction(c,[...d,...b],a);return h};n._setupCreateMultipointOperation=
async function(a,c){const d=await P.loadCreateUtils();c=this._draw.create(a,{...c,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0});let b=null;const h=[],g=this._operationHandleForCreateAction(c,h,a);h.push(c.on("vertex-add",f=>{const {type:k,vertexIndex:e,vertices:m}=f,l=m[e];b=f;this._drawMultipointGraphic(d,m,!0);this.emit("create",{graphic:this.createGraphic,state:1===m.length?"start":"active",tool:a,toolEventInfo:{added:l,vertices:[{coordinates:l,
componentIndex:0,vertexIndex:e}],type:k},type:"create"})}),c.on("vertex-remove",f=>{const {type:k,vertexIndex:e,vertices:m}=f,l=m[e];b=f;this._drawMultipointGraphic(d,m,!0);this.emit("create",{graphic:this.createGraphic,state:"active",tool:a,toolEventInfo:{removed:l,vertices:[{coordinates:l,componentIndex:0,vertexIndex:e}],type:k},type:"create"})}),c.on("vertex-update",f=>{const {type:k,vertexIndex:e,vertices:m}=f,l=m[e];b=f;this._drawMultipointGraphic(d,m,!0);this.emit("create",{graphic:this.createGraphic,
state:"active",tool:a,toolEventInfo:{type:k,updated:l,vertices:[{coordinates:l,componentIndex:0,vertexIndex:e}]},type:"create"})}),c.on("cursor-update",f=>{b=f}),c.on("draw-complete",f=>{f=f.vertices.slice(0);(f=d.createMultipoint(f,this.view.spatialReference))&&this.createGraphic&&(this.createGraphic.geometry=f);g&&g.complete()}),c.on("undo",f=>{f=f.vertices;const k=b&&"cursor-update"!==b.type;this._resetCreateOperationGraphics();f.length&&this._drawMultipointGraphic(d,f,k)}),c.on("redo",f=>{f=f.vertices;
const k=b&&"cursor-update"!==b.type;this._resetCreateOperationGraphics();f.length&&this._drawMultipointGraphic(d,f,k)}));h.push(this.view.on("pointer-move",()=>this._displayCrosshairCursor(),w.ViewEventPriorities.WIDGET),this.view.on("key-down",f=>this._getCommonUpdateOperationKeyDownHandlers(g,f),w.ViewEventPriorities.WIDGET));return g};n._setupCreatePolyOperation=async function(a,c){const d=await P.loadCreateUtils();c={...c,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,
interactiveUndoDisabled:!0};let b=null;"polyline"===a?b=this._draw.create(a,c):"polygon"===a&&(b=this._draw.create(a,c));let h=null;c=[b.on("vertex-add",k=>{const {type:e,vertexIndex:m,vertices:l}=k,p=l[m];this._snapLastPolygonVertexToFirst(a,l);h=k;this._drawVertexGraphics(d,a,l,{userClicked:!0});this.emit("create",{graphic:this.createGraphic,state:1===l.length?"start":"active",tool:a,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:m}],type:e},type:"create"})}),b.on("vertex-remove",
k=>{const {type:e,vertexIndex:m,vertices:l}=k,p=l[m];this._snapLastPolygonVertexToFirst(a,l);h=k;this._drawVertexGraphics(d,a,l,{userClicked:!0});this.emit("create",{graphic:this.createGraphic,state:"active",tool:a,toolEventInfo:{removed:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:m}],type:e},type:"create"})}),b.on("vertex-update",k=>{const {type:e,vertexIndex:m,vertices:l}=k,p=l[m];this._snapLastPolygonVertexToFirst(a,l);h=k;this._drawVertexGraphics(d,a,l,{userClicked:!0});this.emit("create",
{graphic:this.createGraphic,state:"active",tool:a,toolEventInfo:{type:e,updated:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:m}]},type:"create"})}),b.on("cursor-update",k=>{const {type:e,vertices:m}=k;k.mapPoint&&(this._snapLastPolygonVertexToFirst(a,m),h=k,this._drawVertexGraphics(d,a,m,{userClicked:!1}),1<m.length&&this.emit("create",{graphic:this.createGraphic,state:"active",tool:a,toolEventInfo:{coordinates:m[m.length-1],type:e},type:"create"}))}),b.on("draw-complete",k=>{k=k.vertices.slice(0);
let e=null;"polyline"===a?e=d.createPolyline([k],this.view.spatialReference,this._doUnnormalization):"polygon"===a&&(e=d.createPolygon([k],this.view.spatialReference,this._doUnnormalization,!0));e&&(this.createGraphic.geometry=e);f&&f.complete()}),b.on("undo",k=>{k=k.vertices;const e=h&&"cursor-update"!==h.type;this._resetCreateOperationGraphics();this._snapLastPolygonVertexToFirst(a,k);k.length&&this._drawVertexGraphics(d,a,k,{userClicked:e})}),b.on("redo",k=>{k=k.vertices;const e=h&&"cursor-update"!==
h.type;this._resetCreateOperationGraphics();this._snapLastPolygonVertexToFirst(a,k);k.length&&this._drawVertexGraphics(d,a,k,{userClicked:e})})];const g=[this.view.on("pointer-move",k=>{r.isSome(b.getCoordsFromScreenPoint(N.createScreenPoint(k.x,k.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},w.ViewEventPriorities.WIDGET),this.view.on("key-down",k=>{"Control"!==k.key||k.repeat?"z"===k.key&&f&&f.canUndo()?(k.stopPropagation(),f.undo()):"r"===k.key&&f&&f.canRedo()?(k.stopPropagation(),
f.redo()):"Escape"===k.key&&f&&f.cancel():(this.snappingOptions.enabledToggled=!0,k.stopPropagation())},w.ViewEventPriorities.WIDGET),this.view.on("key-up",k=>{"Control"===k.key&&(this.snappingOptions.enabledToggled=!1,k.stopPropagation())},w.ViewEventPriorities.WIDGET)];if("polygon"===a){const k=(l,p,q)=>{if(!l||!l.layer||!l.visible)return!1;l=this.view.toScreen(l.geometry);return this._isWithinScreenDistance(l,p,q)},e=l=>{if(!(2>=this._vertexGraphics.length))return k(this._vertexGraphics[0],l,this._getVertexIntersectDistance())};
let m=!1;g.push(this.view.on("pointer-move",()=>{m=!1},w.ViewEventPriorities.WIDGET),this.view.on("pointer-down",l=>{e(l)?(m=!0,l.stopPropagation()):this._vertexGraphics.some(p=>k(p,l,this._getVertexIntersectDistance()))&&l.stopPropagation()},w.ViewEventPriorities.WIDGET),this.view.on("pointer-up",l=>{m&&(l.stopPropagation(),b.complete())}))}const f=this._operationHandleForCreateAction(b,[...c,...g],a);return f};n._setupCreateCircleOperation=async function(a,c){const d=await P.loadCreateUtils(),b=
this._draw.create(a,{...c,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0});let h=!1,g=!0;c=[b.on("vertex-add",e=>{const {type:m,vertexIndex:l,vertices:p}=e;e=p[l];this._drawSegmentGraphic(d,a,p,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem);this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:a,toolEventInfo:{added:e,vertices:[{coordinates:e,componentIndex:0,vertexIndex:l}],type:m},type:"create"})}),
b.on("cursor-update",e=>{const {type:m,vertices:l}=e;this._drawSegmentGraphic(d,a,l,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem);2===l.length&&this.emit("create",{graphic:this.createGraphic,state:"active",tool:a,toolEventInfo:{coordinates:l[l.length-1],type:m},type:"create"})}),b.on("draw-complete",e=>{e=e.vertices.slice(0);1===e.length?(e.push(b.viewAlignedCoordinateSystem.makeMapPoint(e[0][0]+this._defaultSegmentOffset*this.view.resolution,e[0][1])),e=d.createCircle(e,b.viewAlignedCoordinateSystem,
!0,this.view.resolution)):e=h?d.createEllipse(e,b.viewAlignedCoordinateSystem,g):d.createCircle(e,b.viewAlignedCoordinateSystem,g,this.view.resolution);this.createGraphic?this.createGraphic.geometry=e:(this._removeCreateGraphic(),this._set("createGraphic",new z(e,this.polygonSymbol)));k&&k.complete()})];const f=[this.view.on("pointer-move",e=>{r.isSome(b.getCoordsFromScreenPoint(N.createScreenPoint(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},w.ViewEventPriorities.WIDGET),
this.view.on("key-down",e=>{"Control"===e.key?h||(h=!0,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Alt"===e.key?g&&(g=!1,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Escape"===e.key&&k&&k.cancel()},w.ViewEventPriorities.WIDGET),this.view.on("key-up",e=>{"Control"===e.key?(h=!1,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Alt"===
e.key&&(g=!0,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem))},w.ViewEventPriorities.WIDGET)],k=this._operationHandleForCreateAction(b,[...c,...f],a);return k};n._setupCreateRectangleOperation=async function(a,c){const d=await P.loadCreateUtils(),b=this._draw.create(a,{...c,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0});let h=!1,g=!1;c=[b.on("vertex-add",e=>{const {type:m,vertexIndex:l,
vertices:p}=e;e=p[l];this._drawSegmentGraphic(d,a,p,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem);this.emit("create",{graphic:this.createGraphic,state:1===p.length?"start":"active",tool:a,toolEventInfo:{added:e,vertices:[{coordinates:e,componentIndex:0,vertexIndex:l}],type:m},type:"create"})}),b.on("cursor-update",e=>{const {type:m,vertices:l}=e;this._drawSegmentGraphic(d,a,l,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem);2===l.length&&this.emit("create",{graphic:this.createGraphic,
state:"active",tool:a,toolEventInfo:{coordinates:l[l.length-1],type:m},type:"create"})}),b.on("draw-complete",e=>{e=e.vertices.slice(0);let m=null;1===e.length&&(g=h=!1);m=h?d.createSquare(e,b.viewAlignedCoordinateSystem,g):d.createRectangle(e,b.viewAlignedCoordinateSystem,g);this.createGraphic?this.createGraphic.geometry=m:(this._removeCreateGraphic(),this._set("createGraphic",new z(m,this.polygonSymbol)));k&&k.complete()})];const f=[this.view.on("pointer-move",e=>{r.isSome(b.getCoordsFromScreenPoint(N.createScreenPoint(e.x,
e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()},w.ViewEventPriorities.WIDGET),this.view.on("key-down",e=>{"Control"===e.key?h||(h=!0,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Alt"===e.key?g||(g=!0,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Escape"===e.key&&k&&k.cancel()},w.ViewEventPriorities.WIDGET),this.view.on("key-up",e=>{"Control"===e.key?(h=!1,this._drawSegmentGraphic(d,
a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem)):"Alt"===e.key&&(g=!1,this._drawSegmentGraphic(d,a,b.vertices,{centered:g,constrainToggle:h},b.viewAlignedCoordinateSystem))},w.ViewEventPriorities.WIDGET)],k=this._operationHandleForCreateAction(b,[...c,...f],a);return k};n._setupUpdateOperation=async function(a,c){const {_defaultUpdateTool:d,defaultUpdateOptions:b,layer:h,view:g}=this;c={...b,...c};var f=c.tool||d;for(var k of a)h.remove(k),h.add(k);if("3d"===g.type){if(0===
a.length)return null;switch(f){case "move":return this._setupMove3DOperation(a,c,g,f);case "reshape":if(1<a.length)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;f=S.isSupportedGraphic(a[0]);if(0===f)return this._setupReshape3DOperation(a[0],c,g);this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Y.isSupportedGraphicResultMessage(f)}).`);return null;case "transform":return this._setupGraphicTransform3DOperation(a,
c,g)}}if("move"===f)return this._setupMoveOperation(a,c,g);if(1<a.length)return"reshape"===f?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshapeOperation(a,f,c,g);if(1===a.length){k=r.get(a[0].geometry,"type");if("point"===k||"multipoint"===k)return this._setupMoveOperation(a,c,g);if("transform"===f||"reshape"===f)return this._setupTransformOrReshapeOperation(a,f,c,g)}return null};n._setupMove3DOperation=async function(a,
c,d,b,h=!1){for(var g of a){const m=oa.isSupportedGraphic(g);if(0!==m)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Y.isSupportedGraphicResultMessage(m)}).`),null}g=await this._requireModule(new Promise(function(m,l){E(["../../views/3d/interactive/editingTools"],m,l)}));if(x(g))return g;const f=new g.module.GraphicMoveTool({view:d,enableZ:c.enableZ,snappingManager:this._snappingManager});this.view.tools.add(f);f.graphics.addMany(a);h||this.updateGraphics.addMany(a);
const k=[],e=new G.OperationHandle({activeComponent:f,tool:b,type:"update",onEnd:()=>{var m;k.forEach(l=>l.remove());k.length=0;null==(m=this.view.tools)?void 0:m.remove(f);f.destroyed||f.destroy()},undo:()=>{J(e,this.updateGraphics.toArray());this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:b})},redo:()=>{K(e,this.updateGraphics.toArray());this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:b})},addToSelection:m=>{this.updateGraphics.push(m);f.graphics.push(m);this.emit("update",
{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[m],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:m=>{const l=this.updateGraphics.indexOf(m);e.history.undo.forEach(p=>p.updates.splice(l,1));e.history.redo.forEach(p=>p.updates.splice(l,1));this.updateGraphics.remove(m);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[m],type:"selection-change"},
type:"update"});0===this.updateGraphics.length?e.complete():f.graphics.remove(m)},toggleTool:async()=>{if(1===this.updateGraphics.length&&!1!==c.toggleToolOnClick&&"transform"===b){var m=this.updateGraphics.getItemAt(0);0===S.isSupportedGraphic(m)&&(m=await this._setupReshape3DOperation(m,c,d,!0),x(m)||(e.onEnd(),e.destroy(),this._setUpdateOperationHandle(m,c)))}}});k.push(...this._getHandlesForComponent(e,c),this.view.on("immediate-click",m=>this._getCommonUpdateOperationClickHandlers(e,m,c),w.ViewEventPriorities.WIDGET),
this.view.on("key-down",m=>this._getCommonUpdateOperationKeyDownHandlers(e,m),w.ViewEventPriorities.WIDGET));return e};n._setupGraphicTransform3DOperation=function(a,c,d,b=!1){if(1===a.length&&0===pa.isSupportedGraphic(a[0])){const h=a[0];if(r.isSome(h.geometry)&&"point"===h.geometry.type)return this._setupPointTransform3DOperation(h,c,d);if(r.isSome(h.geometry)&&("polygon"===h.geometry.type||"polyline"===h.geometry.type))return this._setupPolyTransform3DOperation(h,c,d,b)}return this._setupMove3DOperation(a,
c,d,"transform",b)};n._setupPointTransform3DOperation=async function(a,c,d){const {enableRotation:b,enableScaling:h,enableZ:g}=c,f=await this._requireModule(new Promise(function(l,p){E(["../../views/3d/interactive/editingTools"],l,p)}));if(x(f))return f;const k=new f.module.GraphicTransformTool({graphic:a,view:d,enableRotation:b,enableScaling:h,enableZ:g,snappingManager:this._snappingManager});this.view.tools.add(k);this.updateGraphics.add(a);const e=[],m=new G.OperationHandle({activeComponent:k,
tool:"transform",type:"update",onEnd:()=>{var l;e.forEach(p=>p.remove());e.length=0;null==(l=this.view.tools)?void 0:l.remove(k);k.destroyed||k.destroy()},undo:()=>{J(m,this.updateGraphics.toArray());this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},redo:()=>{K(m,this.updateGraphics.toArray());this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},addToSelection:async l=>{this.updateGraphics.add(l);l=await this._setupMove3DOperation(this.updateGraphics.toArray(),
c,d,"transform",!0);x(l)||(m.onEnd(),m.destroy(),this._setUpdateOperationHandle(l,c))}});e.push(...this._getHandlesForComponent(m,c),this.view.on("immediate-click",l=>this._getCommonUpdateOperationClickHandlers(m,l,c),w.ViewEventPriorities.WIDGET),this.view.on("key-down",l=>this._getCommonUpdateOperationKeyDownHandlers(m,l),w.ViewEventPriorities.WIDGET));return m};n._setupPolyTransform3DOperation=async function(a,c,d,b=!1){const {enableRotation:h,enableScaling:g,enableZ:f,preserveAspectRatio:k}=c,
e=await this._requireModule(new Promise(function(q,A){E(["../../views/3d/interactive/editingTools"],q,A)}));if(x(e))return e;const m=new e.module.ExtentTransformTool({graphic:a,view:d,enableRotation:h,enableScaling:g,enableZ:f,preserveAspectRatio:k});this.view.tools.add(m);b||this.updateGraphics.add(a);const l=[],p=new G.OperationHandle({activeComponent:m,tool:"transform",type:"update",onEnd:()=>{var q;l.forEach(A=>A.remove());l.length=0;null==(q=this.view.tools)?void 0:q.remove(m);m.destroyed||m.destroy()},
canUndo:()=>m.canUndo(),undo:()=>{m.undo();this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},canRedo:()=>m.canRedo(),redo:()=>{m.redo();this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},addToSelection:async q=>{this.updateGraphics.add(q);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[q],removed:[],type:"selection-change"},type:"update"});q=await this._setupMove3DOperation(this.updateGraphics.toArray(),
c,d,"transform",!0);x(q)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(q,c))},removeFromSelection:async q=>{this.updateGraphics.remove(q);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[q],type:"selection-change"},type:"update"});p.complete()},toggleTool:async()=>{if(1===this.updateGraphics.length&&!1!==c.toggleToolOnClick){var q=this.updateGraphics.getItemAt(0);0===S.isSupportedGraphic(q)&&(q=await this._setupReshape3DOperation(q,
c,d,!0),x(q)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(q,c)))}}});l.push(...this._getHandlesForComponent(p,c),this.view.on("immediate-click",q=>this._getCommonUpdateOperationClickHandlers(p,q,c),w.ViewEventPriorities.WIDGET),this.view.on("key-down",q=>this._getCommonUpdateOperationKeyDownHandlers(p,q),w.ViewEventPriorities.WIDGET),this.view.on("key-down",q=>{"Control"!==q.key||q.repeat||(m.preserveAspectRatio=!m.preserveAspectRatio,q.stopPropagation())},w.ViewEventPriorities.WIDGET),
this.view.on("key-up",q=>{"Control"===q.key&&(m.preserveAspectRatio=!m.preserveAspectRatio,q.stopPropagation())},w.ViewEventPriorities.WIDGET));return p};n._setupMoveOperation=async function(a,c,d){this.updateGraphics.addMany(a);const b=await this._getGraphicMover(a,c,d);if(x(b))return b;this._syncCloneInfos();const h=new G.OperationHandle({activeComponent:b,tool:"move",type:"update",onEnd:()=>{var k;this._displayDefaultCursor();f.forEach(e=>e.remove());g.forEach(e=>e.remove());f=[];g=[];b.destroy();
null==(k=this._internalGraphicsLayer)?void 0:k.removeMany([...this.updateGraphics.toArray()]);this._removeCloneGraphics()},undo:()=>{const k=this.updateGraphics.toArray();J(h,k);this._syncCloneInfos();this._emitUndoEvent({graphics:k,tool:"move"})},redo:()=>{const k=this.updateGraphics.toArray();K(h,k);this._syncCloneInfos();this._emitRedoEvent({graphics:k,tool:"move"})},addToSelection:k=>{this.updateGraphics.push(k);b.graphics=this.updateGraphics.toArray();const e=this._createClone(k);this._moveOperationCloneInfos.push({graphic:k,
clone:e});this._internalGraphicsLayer.add(e);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[k],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:k=>{const e=this.updateGraphics.indexOf(k);h.history.undo.forEach(l=>l.updates.splice(e,1));h.history.redo.forEach(l=>l.updates.splice(e,1));var m=this._moveOperationCloneInfos.findIndex(l=>l.graphic===k);this._internalGraphicsLayer.remove(this._moveOperationCloneInfos[m].clone);
this.updateGraphics.remove(k);this._moveOperationCloneInfos.splice(m,1);m=this.updateGraphics.toArray();this.emit("update",{graphics:m,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[k],type:"selection-change"},type:"update"});0===this.updateGraphics.length?h.complete():b.graphics=m}});let g=[d.on("immediate-click",k=>this._getCommonUpdateOperationClickHandlers(h,k,c),w.ViewEventPriorities.WIDGET),d.on("key-down",k=>{this._getCommonUpdateOperationKeyDownHandlers(h,
k);"Control"!==k.key||k.repeat||(b.enableMoveAllGraphics=!b.enableMoveAllGraphics)},w.ViewEventPriorities.WIDGET),d.on("key-up",k=>{"Control"===k.key&&(b.enableMoveAllGraphics=!b.enableMoveAllGraphics)},w.ViewEventPriorities.WIDGET)],f=this._getHandlesForComponent(h,c);f.push(b.on("graphic-move",k=>{this._moveOperationCloneInfos.forEach(e=>{const m=k.allGraphics.find(l=>l===e.graphic);m&&(e.clone.geometry=m.geometry)})}));return h};n._removeCloneGraphics=function(){if(this._moveOperationCloneInfos.length){for(const {clone:a}of this._moveOperationCloneInfos)this._internalGraphicsLayer.remove(a),
a.destroy();this._moveOperationCloneInfos=[]}};n._syncCloneInfos=function(){this._removeCloneGraphics();this._moveOperationCloneInfos=this._generateCloneInfos(this.updateGraphics.toArray());for(const {clone:a}of this._moveOperationCloneInfos)this._internalGraphicsLayer.add(a)};n._generateCloneInfos=function(a){return(null==a?void 0:a.map(c=>({graphic:c,clone:this._createClone(c)})))||[]};n._createClone=function(a){const c=a.clone();c.symbol=this._getSymbolForClone(a);return c};n._getSymbolForClone=
function(a){if(r.isNone(a.symbol))return null;switch(a.symbol.type){case "cim":return new D({style:"circle",size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case "picture-marker":{const {xoffset:c,yoffset:d,height:b,width:h}=a.symbol;return new D({xoffset:c,yoffset:d,size:b===h?h:Math.max(b,h),style:"square",color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case "simple-marker":{const {xoffset:c,yoffset:d,size:b,style:h}=a.symbol;return new D({xoffset:c,yoffset:d,style:"circle"===
h?"circle":"square",size:b+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case "simple-fill":return new O({color:[0,0,0,0],outline:{style:"dash",color:[255,127,0,1],width:1}});case "simple-line":return new Q({color:[255,127,0,1],style:"dash",width:1});case "text":{const {xoffset:c,yoffset:d}=a.symbol;return new D({xoffset:c,yoffset:d,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}};n._setupReshape3DOperation=async function(a,c,d,b=!1){const h=await this._requireModule(new Promise(function(e,
m){E(["../../views/3d/interactive/editingTools"],e,m)}));if(x(h))return h;this.snappingOptions.enabledToggled=!1;const g=new h.module.GraphicReshapeTool({view:d,graphic:a,enableZ:c.enableZ,enableMoveGraphic:c.enableMoveGraphic,snappingManager:this._snappingManager});d.tools.add(g);b||this.updateGraphics.add(a);const f=[],k=new G.OperationHandle({activeComponent:g,tool:"reshape",type:"update",onEnd:()=>{var e;f.forEach(m=>m.remove());f.length=0;null==(e=this.view.tools)?void 0:e.remove(g);g.destroyed||
g.destroy()},undo:()=>{g.beforeUndo();J(k,this.updateGraphics.toArray());this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:"reshape"})},redo:()=>{K(k,this.updateGraphics.toArray());this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"reshape"})},addToSelection:async e=>{this.updateGraphics.add(e);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});
e=await this._setupMove3DOperation(this.updateGraphics.toArray(),c,d,"transform",!0);x(e)||(k.onEnd(),k.destroy(),this._setUpdateOperationHandle(e,c))},removeFromSelection:async e=>{this.updateGraphics.remove(e);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"});k.complete()},toggleTool:async()=>{if(!1!==c.toggleToolOnClick){var e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),
c,d,!0);x(e)||(k.onEnd(),k.destroy(),this._setUpdateOperationHandle(e,c))}}});f.push(...this._getHandlesForComponent(k,c),d.on("immediate-click",e=>this._getCommonUpdateOperationClickHandlers(k,e,c),w.ViewEventPriorities.WIDGET),d.on("key-down",e=>{this._getCommonUpdateOperationKeyDownHandlers(k,e);"Control"===e.key&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())},w.ViewEventPriorities.WIDGET),d.on("key-up",e=>{"Control"===e.key&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())},
w.ViewEventPriorities.WIDGET));return k};n._setupTransformOrReshapeOperation=async function(a,c,d,b){const {multipleSelectionEnabled:h}=d;this.updateGraphics.addMany(a);c="transform"===c?await this._getBox(a,d,b):await this._getReshape(a,d,b);if(x(c))return c;const g=new G.OperationHandle({activeComponent:c,type:"update",onEnd:()=>{k.forEach(e=>e.remove());f.forEach(e=>e.remove());k=[];f=[];g.activeComponent&&!g.activeComponent.destroyed&&g.activeComponent.destroy();this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},
undo:()=>{J(g,this.updateGraphics.toArray());g.refreshComponent();this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:g.tool})},redo:()=>{K(g,this.updateGraphics.toArray());g.refreshComponent();this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:g.tool})},addToSelection:e=>{const m=g.activeComponent;this.updateGraphics.add(e);m.graphics=this.updateGraphics.toArray();m.refresh();g.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,
tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const m=g.activeComponent,l=this.updateGraphics.indexOf(e);g.history.undo.forEach(q=>q.updates.splice(l,1));g.history.redo.forEach(q=>q.updates.splice(l,1));this.updateGraphics.remove(e);const p=this.updateGraphics.toArray();this.emit("update",{graphics:p,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"});
0===this.updateGraphics.length?g.complete():m.graphics=p},toggleTool:async()=>{if(!(1<this.updateGraphics.length)){var e=null;"transform"===g.tool?e=await this._getReshape(a,d,b):"reshape"===g.tool&&(e=await this._getBox(a,d,b));x(e)||(g.activeComponent.destroy(),g.activeComponent=e,g.activeComponent&&(k.forEach(m=>m.remove()),k=this._getHandlesForComponent(g,d)))}}});let f=[b.on("immediate-click",e=>{this._getFirstHit(R.createScreenPointFromEvent(e)).then(m=>{var l;if(g)if(null!=(l=m.results)&&l.length){var p=
g.activeComponent;m.results.some(q=>{if(q.graphic){var A;q=q.graphic;if("box"===(null==p?void 0:p.type)&&null!=(A=e.native)&&A.shiftKey&&h)return g.addToSelection(q),!0;q.layer===this.layer&&g.complete()}return!1})&&e.stopPropagation()}else g.complete()})},w.ViewEventPriorities.WIDGET),b.on("key-down",e=>{this._getCommonUpdateOperationKeyDownHandlers(g,e);"Control"!==e.key||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation());"Control"===e.key&&!e.repeat&&g&&(e=g.activeComponent)&&
"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)},w.ViewEventPriorities.WIDGET),b.on("key-up",e=>{var m;"Control"===e.key&&"reshape"===(null==g?void 0:null==(m=g.activeComponent)?void 0:m.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation());"Control"===e.key&&g&&(e=g.activeComponent)&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)},w.ViewEventPriorities.WIDGET)],k=this._getHandlesForComponent(g,d);return g};n._getGraphicMover=async function(a,c,d){({enableMoveAllGraphics:c}=
c);const b=await this._requireModule(new Promise(function(h,g){E(["../../views/draw/support/GraphicMover"],function(f){h(T(f))},g)}));return x(b)?b:new b.module.default({enableMoveAllGraphics:c,graphics:a,view:d,callbacks:{onGraphicMoveStart:({dx:h,dy:g,graphic:f})=>{this._displayGrabbingCursor();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:"move-start"},type:"update"})},onGraphicMove:({dx:h,dy:g,graphic:f})=>
this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:"move"},type:"update"}),onGraphicMoveStop:({dx:h,dy:g,graphic:f})=>{this._displayPointerCursor();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})};
n._getBox=async function(a,c,d){const {enableRotation:b,enableScaling:h,preserveAspectRatio:g}=c;c=await this._requireModule(new Promise(function(f,k){E(["../../views/draw/support/Box"],function(e){f(T(e))},k)}));return x(c)?c:new c.module.default({graphics:a,enableRotation:b,enableScaling:h,preserveAspectRatio:g,layer:this._internalGraphicsLayer,view:d,callbacks:{onMoveStart:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},
type:"update"}),onMove:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onMoveStop:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onScaleStart:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onScale:f=>this.emit("update",
{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onScaleStop:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onRotateStart:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onRotate:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"}),onRotateStop:f=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...f},type:"update"})}})};n._getReshape=async function(a,c,d){({enableMidpoints:c=!0}=c);const b=await this._requireModule(new Promise(function(h,g){E(["../../views/draw/support/Reshape"],function(f){h(T(f))},g)}));return x(b)?b:new b.module.default({enableMidpoints:c,graphic:a[0],
layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:d,callbacks:{onReshapeStart:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onReshape:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onReshapeStop:({mover:h,type:g})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",
aborted:!1,tool:this.activeTool,toolEventInfo:{mover:h,type:g},type:"update"}),onMoveStart:({dx:h,dy:g,mover:f,type:k})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:k},type:"update"}),onMove:({dx:h,dy:g,mover:f,type:k})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:k},type:"update"}),onMoveStop:({dx:h,
dy:g,mover:f,type:k})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:h,dy:g,mover:f,type:k},type:"update"}),onVertexAdd:({added:h,type:g,vertices:f})=>{h=h.map(k=>V.geometryToCoordinates(k.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:h,vertices:f,type:g},type:"update"})},onVertexRemove:({removed:h,type:g,vertices:f})=>{h=h.map(k=>
V.geometryToCoordinates(k.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:h,vertices:f,type:g},type:"update"})}}})};n._getHandlesForComponent=function(a,c){const d=a.activeComponent;switch(d.type){case "graphic-mover":return[d.on("graphic-click",({graphic:b,viewEvent:h})=>{var g;null!=(g=h.native)&&g.shiftKey&&(h.stopPropagation(),a.removeFromSelection(b))}),d.on("graphic-move-start",b=>a.addToHistory(C(b.allGraphics)))];
case "box":return[d.on("graphic-click",b=>this._onTransformOrReshape2DGraphicClick(a,c,b)),d.on("move-start",b=>a.addToHistory(C(b.graphics))),d.on("rotate-start",b=>a.addToHistory(C(b.graphics))),d.on("scale-start",b=>a.addToHistory(C(b.graphics)))];case "reshape":return[d.on("graphic-click",b=>this._onTransformOrReshape2DGraphicClick(a,c,b)),d.on("move-start",b=>a.addToHistory(C([b.mover]))),d.on("reshape-start",b=>a.addToHistory(C([b.graphic]))),d.on("vertex-add",b=>a.addToHistory(C([b.oldGraphic]))),
d.on("vertex-remove",b=>a.addToHistory(C([b.oldGraphic])))];case "move-3d":return[d.on("graphic-move-start",b=>{a.addToHistory(C(b.allGraphics));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move-start"},type:"update"})}),d.on("graphic-move",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:b.dx,
dy:b.dy,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move"},type:"update"})}),d.on("graphic-move-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move-stop"},type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})];case "transform-3d":return[d.on("graphic-translate-start",b=>{a.addToHistory(C([b.graphic]));
this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move-start"},type:"update"})}),d.on("graphic-translate-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move-stop"},type:"update"})}),d.on("graphic-rotate-start",b=>{a.addToHistory(aa([b.graphic]));
this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate-start"},type:"update"})}),d.on("graphic-rotate-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate-stop"},type:"update"})}),d.on("graphic-scale-start",b=>{a.addToHistory(aa([b.graphic]));this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,type:"scale-start"},type:"update"})}),d.on("graphic-scale-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,type:"scale-stop"},type:"update"})}),d.on("graphic-translate",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,
toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move"},type:"update"})}),d.on("graphic-rotate",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate"},type:"update"})}),d.on("graphic-scale",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,type:"scale"},
type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})];case "reshape-3d":return[d.on("reshape",b=>{"reshape-start"===b.type&&a.addToHistory(C([b.mover]));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("move",b=>{"move-start"===b.type&&a.addToHistory(C([b.mover]));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,
tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("vertex-add",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("vertex-remove",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})];case "draw":case "draw-3d":return null}};
n._onTransformOrReshape2DGraphicClick=function(a,c,d){var b;const {graphic:h,viewEvent:g}=d;null!=(b=g.native)&&b.shiftKey?(g.stopPropagation(),a.removeFromSelection(h)):c.toggleToolOnClick&&(r.isNone(h.geometry)||"extent"!==h.geometry.type?(g.stopPropagation(),a.toggleTool()):this._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."))};n._setUpdateOperationHandle=function(a,c){this._operationHandle=a;const d=this.view.map;this._disablePopup(c);
a.on("complete",()=>{if(a===this._operationHandle){const b=this.updateGraphics.toArray(),h=this._operationHandle.tool;this._operationHandle.destroy();this._operationHandle=null;this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray());this.updateGraphics.removeAll();d&&d.remove(this._internalGraphicsLayer);this._restorePopup(c);this.emit("update",{graphics:b,state:"complete",aborted:a.cancelled,tool:h,toolEventInfo:null,type:"update"})}})};n._getCommonUpdateOperationClickHandlers=function(a,
c,d){const b=R.createScreenPointFromEvent(c);this._getFirstHit(b).then(h=>{h=h.results;h.length?c.native.shiftKey&&this._toggleSelection(h.map(g=>g.graphic),a,d)?c.stopPropagation():h.some(g=>g.graphic&&-1<this.updateGraphics.indexOf(g.graphic))?c.stopPropagation():a.complete():a.complete()})};n._toggleSelection=function(a,c,d){const b=!!d.multipleSelectionEnabled;return a.some(h=>null==h?!1:b&&h.layer===this.layer?(-1===this.updateGraphics.indexOf(h)?c.addToSelection(h):c.removeFromSelection(h),
!0):!1)};n._getCommonUpdateOperationKeyDownHandlers=function(a,c){if(a){var d=c.key;"z"===d&&a.canUndo()?(c.stopPropagation(),a.undo()):"r"===d&&a.canRedo()?(c.stopPropagation(),a.redo()):"Escape"===d?(c.stopPropagation(),a.cancel()):0<=sa.indexOf(d)&&this._onDeleteKey(c)}};n._onDeleteKey=function(a){if(this._operationHandle&&"update"===this._operationHandle.type){var c=this.activeComponent;r.isNone(c)||"reshape"===c.type||"reshape-3d"===c.type||(a.stopPropagation(),a=this.updateGraphics.toArray(),
this.layer.removeMany(a),this._emitDeleteEvent({graphics:a,tool:this.activeTool}))}};n._drawMultipointGraphic=function(a,c,d){var b=null;!d&&1<c.length?(b=c.slice(0),b.pop(),b=a.createMultipoint(b,this.view.spatialReference)):b=a.createMultipoint(c,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=b:this._set("createGraphic",new z(b,this.pointSymbol));d&&1===c.length&&this._internalGraphicsLayer.add(this.createGraphic)};n._drawVertexGraphics=function(a,c,d,b){if(d.length){var {_doUnnormalization:h,
activeLineSymbol:g,activeVertexSymbol:f,polygonSymbol:k,polylineSymbol:e,vertexSymbol:m,view:{spatialReference:l}}=this,p=!(!b||!b.userClicked),q="polygon"===c;b=q?k:e;if(1===d.length){this._removeLineGraphic();this._removeActiveLineGraphic();var A=this.createPointFromVertex(d[0]);d=q?a.createPolygon([d],l,h,!0):a.createPolyline([d],l,h);this._vertexGraphics.length?this._vertexGraphics[0].geometry=A:this._vertexGraphics.push(new z(A,f));this.createGraphic?this.createGraphic.set({geometry:d,symbol:b}):
this._set("createGraphic",new z(d,b));p&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===d.length){var H=this.createPointFromVertex(d[1]);A=a.createPolyline([d],l,h);a=q?a.createPolygon([d],l,h,!0):a.createPolyline([d],l,h);this._vertexGraphics.length||(d=this.createPointFromVertex(d[0]),d=new z(d,m),this._vertexGraphics.push(d));1===this._vertexGraphics.length?(d=this._vertexGraphics[0],H=new z(H,m),this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(H),
this._internalGraphicsLayer.remove(d),this._internalGraphicsLayer.add(d)):this._vertexGraphics[1].geometry=H;this._showActiveLineGraphic(A);d=this._vertexGraphics[0];p&&(this._activeLineGraphic.symbol=e,d.symbol=m,this._internalGraphicsLayer.add(this._vertexGraphics[1]));this.createGraphic?this.createGraphic.set({geometry:a,symbol:b}):this._set("createGraphic",new z(a,b));this._internalGraphicsLayer.remove(d);this._internalGraphicsLayer.add(d)}else if(2<d.length){H=q?a.createPolygon([d],l,h,!0):a.createPolyline([d],
l,h);"polygon"===c&&this._showFillGraphic(H);q=d.map(ta=>ta.slice());c=q.pop();const ua=[q[q.length-1],c];c=a.createPolyline([q],l,h);a=a.createPolyline([ua],l,h);this._showLineGraphic(c);this._showActiveLineGraphic(a);for(a=0;a<q.length;a++)(c=this._vertexGraphics[a])?c.symbol=p||a!==this._vertexGraphics.length-1?m:f:(c=this.createPointFromVertex(d[a]),this._showVertexGraphic(c));p?(this._activeLineGraphic.symbol=e,p=this.createPointFromVertex(d[d.length-1]),this._showVertexGraphic(p)):this._activeLineGraphic.symbol=
g;this.createGraphic?this.createGraphic.set({geometry:H,symbol:b}):(this._removeCreateGraphic(),this._set("createGraphic",new z(H,b)));for(A of this._vertexGraphics)this._internalGraphicsLayer.remove(A),this._internalGraphicsLayer.add(A)}}};n._drawSegmentGraphic=function(a,c,d,b,h){if(d.length){var g=!(null==b||!b.centered);b=!(null==b||!b.constrainToggle);var f;1===d.length?this._removeCenterIndicatorGraphic():("rectangle"===c?f=b?a.createSquare(d,h,g):a.createRectangle(d,h,g):"circle"===c&&(f=b?
a.createEllipse(d,h,g):a.createCircle(d,h,g,this.view.resolution)),r.isSome(f)&&f.extent&&f.extent.center&&this._showCenterIndicatorGraphic(f.extent.center));f?this.createGraphic?this.createGraphic.geometry=f:(this._removeCreateGraphic(),this._set("createGraphic",new z(f,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}};n._showCenterIndicatorGraphic=function(a){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=a:(this._centerIndicatorGraphic=
new z(a,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))};n._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)};n._showActiveLineGraphic=function(a){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:a,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=
new z(a,this.activeLineSymbol);this._internalGraphicsLayer.add(this._activeLineGraphic)};n._showFillGraphic=function(a){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:a,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new z(a,this.activeFillSymbol);this._internalGraphicsLayer.add(this._activeFillGraphic)};n._showLineGraphic=function(a){this._lineGraphic?(this._lineGraphic.set({geometry:a,symbol:this.polylineSymbol}),
this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new z(a,this.polylineSymbol);this._internalGraphicsLayer.add(this._lineGraphic)};n._showVertexGraphic=function(a,c){a=new z(a,c?this.activeVertexSymbol:this.vertexSymbol);this._vertexGraphics.push(a);this._internalGraphicsLayer.add(a)};n._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic();this._removeLineGraphic();this._removeActiveLineGraphic();this._removeVertexGraphics();this._removeCloneGraphics()};n._removeCreateGraphic=
function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))};n._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic();this._removeActiveLineGraphic();this._removeActiveFillGraphic();this._removeLineGraphic();this._removeVertexGraphics()};n._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=
null)};n._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)};n._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)};n._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(a=>
a.destroy()),this._vertexGraphics=[])};n._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)};n._operationHandleForCreateAction=function(a,c,d){return new G.OperationHandle({activeComponent:this._draw,tool:d,type:"create",onEnd:()=>{c.forEach(b=>b.remove());c.length=0;this._removeCreateOperationGraphics();this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic);
this._displayDefaultCursor()},undo:()=>{a.undo();this._emitUndoEvent({graphics:[this.createGraphic],tool:d})},redo:()=>{a.redo();this._emitRedoEvent({graphics:[this.createGraphic],tool:d})},canUndo:()=>a&&a.canUndo(),canRedo:()=>a&&a.canRedo()})};n._isComponentGraphic=function(a){const {activeComponent:c}=this;return!a||r.isNone(c)?!1:a.attributes&&a.attributes.esriSketchTool?!0:("box"===c.type||"reshape"===c.type)&&c.isUIGraphic(a)};n._snapLastPolygonVertexToFirst=function(a,c){if(!("polygon"!==
a&&2>=c.length)){a=c[0];c=c[c.length-1];var d=this.view.toScreen(new M(a[0],a[1],this.view.spatialReference)),b=this.view.toScreen(new M(c[0],c[1],this.view.spatialReference));this._isWithinScreenDistance(d,b,this._getVertexIntersectDistance())&&(c[0]=a[0],c[1]=a[1])}};n._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?N.pt2px(this.vertexSymbol.size)/2+3:3};n._isWithinScreenDistance=function(a,c,d){const b=a.x-c.x;a=a.y-c.y;return Math.sqrt(b*
b+a*a)<=d};n._displayPointerCursor=function(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")};n._displayGrabbingCursor=function(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")};n._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")};n._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=
null)};n._logError=function(a,c,d){ra.error(new fa(a,c,d))};n._requireModule=async function(a){const c=new AbortController;this._moduleLoaderAbortController=c;a=await a;return this._moduleLoaderAbortController!==c||c.signal.aborted?{requireError:"aborted"}:{module:a}};n._emitUndoEvent=function(a){this.emit("undo",{...a,type:"undo"})};n._emitRedoEvent=function(a){this.emit("redo",{...a,type:"redo"})};n._emitDeleteEvent=function(a){this.emit("delete",{...a,type:"delete"})};n.createPointFromVertex=function(a){return 2<
a.length?new M(a[0],a[1],a[2],this.view.spatialReference):new M(a[0],a[1],this.view.spatialReference)};n.test=function(){return this._operationHandle};n.wait=function(){return F.whenNotOnce(this,"updating")};n._beginAsyncOperation=function(){this._numUpdating+=1;this.notifyChange("updating")};n._endAsyncOperation=function(){--this._numUpdating;this.notifyChange("updating")};n._disablePopupEnabled=function(a){var c;return"3d"!==(null==(c=this.view)?void 0:c.type)||this.updateOnGraphicClick||r.isSome(a)&&
a.toggleToolOnClick};n._disablePopup=function(a){this._disablePopupEnabled(a)&&(a=this.view.popup)&&r.isNone(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=a.autoOpenEnabled,a.autoOpenEnabled=!1)};n._restorePopup=function(a){this._disablePopupEnabled(a)&&(a=this.view.popup)&&r.isSome(this._originalAutoOpenEnabled)&&(a.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)};n._waitViewReady=async function(){this.view&&(r.abortMaybe(this._viewReadyAbortController),
this._viewReadyAbortController=L.createAbortController(),await L.whenOrAbort(F.whenOnce(this.view,"ready"),this._viewReadyAbortController.signal))};U._createClass(B,[{key:"_defaultUpdateTool",get:function(){return"3d"===this.view.type?"move":"transform"}},{key:"_draw",get:function(){return"ready"===this.state||"active"===this.state?new na({view:this.view}):null}},{key:"updating",get:function(){return 0<this._numUpdating}},{key:"activeTool",get:function(){return this._operationHandle&&this._operationHandle.tool?
this._operationHandle.tool:null}},{key:"activeComponent",get:function(){return this._operationHandle?this._operationHandle.activeComponent:null}},{key:"createGraphic",get:function(){return this.view&&"3d"===this.view.type&&r.isSome(this.activeComponent)&&"draw-3d"===this.activeComponent.type?r.unwrap(this.activeComponent.createGraphic):this._get("createGraphic")}},{key:"defaultCreateOptions",set:function(a){this._set("defaultCreateOptions",{...ba,...a})}},{key:"defaultUpdateOptions",set:function(a){this._set("defaultUpdateOptions",
{...ca,...a})}},{key:"snappingOptions",set:function(a){r.isSome(this._snappingManager)&&(this._snappingManager.options=a);this._set("snappingOptions",a)}},{key:"state",get:function(){var a;const c=!(null==(a=this.view)||!a.ready||!this.layer);a=this._operationHandle;return c&&a?"active":c?"ready":"disabled"}},{key:"view",get:function(){return this._get("view")},set:function(a){const c=this._get("view");if(c){const {container:d,map:b}=c;d&&(c.cursor=null);b&&b.remove(this._internalGraphicsLayer);this._viewHandles.removeAll();
this.cancel()}this._doUnnormalization=null!=a&&"3d"===a.type&&"global"===a.viewingMode;this._handles.remove("view-ready");a&&this._handles.add(F.when(a,"ready",d=>{this._viewHandles.removeAll();d&&this._viewHandles.add(this._generateViewHandles(a))},!0),"view-ready");this._set("view",a)}}]);return B}(ha.EventedAccessor);u.__decorate([v.property({readOnly:!0})],t.prototype,"_draw",null);u.__decorate([v.property()],t.prototype,"updating",null);u.__decorate([v.property()],t.prototype,"_operationHandle",
void 0);u.__decorate([v.property({readOnly:!0})],t.prototype,"activeTool",null);u.__decorate([v.property()],t.prototype,"activeFillSymbol",void 0);u.__decorate([v.property()],t.prototype,"activeLineSymbol",void 0);u.__decorate([v.property()],t.prototype,"activeVertexSymbol",void 0);u.__decorate([v.property({readOnly:!0})],t.prototype,"createGraphic",null);u.__decorate([v.property()],t.prototype,"defaultCreateOptions",null);u.__decorate([v.property()],t.prototype,"defaultUpdateOptions",null);u.__decorate([v.property()],
t.prototype,"layer",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"pointSymbol",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"polygonSymbol",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"polylineSymbol",void 0);u.__decorate([v.property({type:X,nonNullable:!0})],t.prototype,"snappingOptions",null);u.__decorate([v.property()],t.prototype,"_snappingManager",void 0);u.__decorate([v.property({readOnly:!0})],t.prototype,"state",null);
u.__decorate([v.property({readOnly:!0})],t.prototype,"updateGraphics",void 0);u.__decorate([v.property()],t.prototype,"updateOnGraphicClick",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"updatePointSymbol",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"updatePolygonSymbol",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"updatePolylineSymbol",void 0);u.__decorate([v.property({types:I.symbolTypes})],t.prototype,"vertexSymbol",void 0);
u.__decorate([v.property({value:null})],t.prototype,"view",null);u.__decorate([v.property()],t.prototype,"cancel",null);u.__decorate([v.property()],t.prototype,"complete",null);u.__decorate([v.property()],t.prototype,"delete",null);u.__decorate([v.property()],t.prototype,"create",null);u.__decorate([v.property()],t.prototype,"update",null);u.__decorate([v.property()],t.prototype,"undo",null);u.__decorate([v.property()],t.prototype,"redo",null);u.__decorate([v.property()],t.prototype,"canUndo",null);
u.__decorate([v.property()],t.prototype,"canRedo",null);u.__decorate([v.property()],t.prototype,"toggleUpdateTool",null);return t=u.__decorate([ea.subclass("esri.widgets.Sketch.SketchViewModel")],t)});