// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../geometry/SpatialReference ../../geometry/support/webMercatorUtils ../../geometry/support/contains ../../geometry ../../core/Collection ../../core/asyncUtils ../../core/watchUtils ../../core/HandleOwner".split(" "),
function(t,u,q,G,H,v,I,A,J,K,L,B,w,C,M,x,D,y,E){function z(f,g){return f&&"copyright"in f&&(!g||"function"===typeof f.originOf&&"user"===f.originOf("copyright"))}function F(f,g){return f.length!==g.length||f.some((m,b)=>m.text!==g[b].text)}function r(f,g,m){m&&g&&(f.find(b=>b.layerView===g&&b.text===m)||f.push({text:m,layerView:g}))}const n=[];q=function(f){function g(b){var a=f.call(this,b)||this;a.clear=()=>{a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");
a.notifyChange("state")};a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new x;a.view=null;a._allLayerViewsChange=c=>{a.handles.remove("suspension");const d=a.get("view.allLayerViews");d&&a.handles.add(d.map(e=>e.watch(["suspended","attributionVisible"],a._updateAttributionItems)),"suspension");c&&c.removed&&c.removed.forEach(e=>{a._pendingAttributions.delete(e);a._fetchedAttributionData.delete(e)});a._updateAttributionItems()};a._updateAttributionItems=()=>{const c=a.get("view.allLayerViews");
n.length=0;c?(c.forEach(d=>{if(!d.suspended&&d.get("layer.attributionVisible")){var e=d.layer;if(z(e,"user"))r(n,d,e.copyright);else if(e.hasAttributionData)if(a._fetchedAttributionData.has(d)){var h=a._fetchedAttributionData.get(d);h?r(n,d,a._getDynamicAttribution(h,a.view,e)):z(e)&&r(n,d,e.copyright)}else a._fetchAttributionData(d);else(h=e.get("portalItem.accessInformation"))?r(n,d,h):r(n,d,e.copyright)}}),F(a.items,n)&&(a.items.removeAll(),a.items.addMany(n)),n.length=0,a.notifyChange("state")):
a.clear()};a.handles.add([y.on(t._assertThisInitialized(a),"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),y.whenTrue(t._assertThisInitialized(a),"view.stationary",()=>a._updateAttributionItems())]);return a}t._inheritsLoose(g,f);var m=g.prototype;m.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};m._fetchAttributionData=async function(b){if(!this._pendingAttributions.has(b)){this._pendingAttributions.add(b);
var a=await D.result(b.layer.fetchAttributionData());this._pendingAttributions.has(b)&&(a=a.ok?this._createContributionIndex(a.value,"bing-maps"===b.layer.type):null,this._pendingAttributions.delete(b),this._fetchedAttributionData.set(b,a));this._updateAttributionItems()}};m._createContributionIndex=function(b,a){b=b.contributors;const c={};if(!b)return c;for(let p=0;p<b.length;p++){const l=b[p];var d=l.coverageAreas;if(!d)return;for(const k of d){var e=k.bbox,h=k.zoomMin-(a&&k.zoomMin?1:0);d=k.zoomMax-
(a&&k.zoomMax?1:0);for(e={extent:w.geographicToWebMercator({xmin:e[1],ymin:e[0],xmax:e[3],ymax:e[2],spatialReference:B.WGS84}),attribution:l.attribution||"",score:null!=k.score?k.score:100,id:p};h<=d;h++)c[h]=c[h]||[],c[h].push(e)}}c.maxKey=Math.max.apply(null,Object.keys(c));return c};m._getDynamicAttribution=function(b,a,c){const {extent:d,scale:e}=a;c=c.tileInfo.scaleToZoom(e);c=Math.min(b.maxKey,Math.round(c));if(!d||null==c||-1>=c)return"";b=b[c];const h=w.project(d.center.clone().normalize(),
a.spatialReference),p={};return b?b.filter(l=>{const k=!p[l.id]&&h&&C.extentContainsPoint(l.extent,h);k&&(p[l.id]=!0);return k}).sort((l,k)=>k.score-l.score||l.objectId-k.objectId).map(l=>l.attribution).join(", "):""};t._createClass(g,[{key:"state",get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"}}]);return g}(E.HandleOwner);u.__decorate([v.property({readOnly:!0,type:x})],q.prototype,"items",void 0);u.__decorate([v.property({readOnly:!0})],
q.prototype,"state",null);u.__decorate([v.property()],q.prototype,"view",void 0);return q=u.__decorate([A.subclass("esri.widgets.Attribution.AttributionViewModel")],q)});