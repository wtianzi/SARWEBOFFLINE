// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../core/Collection ../../core/watchUtils ../../webdoc/widgets/FloorFilter ../../webdoc/Widgets ../../core/HandleOwner ../support/GoTo".split(" "),
function(z,l,k,A,O,P,m,Q,H,I,R,S,T,J,B,x,K,L,M,N){k=function(C){function y(a){a=C.call(this,a)||this;a.filterMenuOpen=!1;a.filterMenuType="site";a.filterMode="base-floors";a.levelsExpanded=!0;a.searchTerm=null;a.view=null;a._updateFloorFilterTask=null;return a}z._inheritsLoose(y,C);var h=y.prototype;h.initialize=function(){this.handles.add([x.init(this,"view.map",a=>{A.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null);this._updateFloorFilterTask=
J.createTask(()=>this._updateFloorFilterFromMap(a).then(()=>{this._setInitialViewState()}))}),x.init(this,"view",(a,b)=>{this._unregisterWidget(b);this._registerWidget(a)},!0),x.watch(this,"view.widthBreakpoint",a=>{this._viewWidthBreakpoint=a}),x.watch(this,"view.heightBreakpoint",a=>{this._viewHeightBreakpoint=a})])};h.destroy=function(){this._unregisterWidget(this.view);this.view=null;A.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)};
h.filterFacilities=function(a){let b=a;this.searchTerm&&(b=a.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));this.site&&(b=b.filter(c=>c.siteId===this.site));return b.sort((c,e)=>{c=c.name;e=e.name;return c>e?1:c===e?0:-1})};h.filterSites=function(a){let b=a;this.searchTerm&&(b=a.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));return b.sort((c,e)=>{c=c.name;e=e.name;return c>e?1:c===e?0:-1})};h.getBaseLevel=function(a){var b,
c;const e=null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:c.levelsInfo;let d=null;if(a){const {id:f}=a;e&&0<e.length&&e.forEach(g=>{0===g.verticalOrder&&g.facilityId===f&&(d=g)})}return d};h.getFacility=function(a){var b,c,e,d;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(e=c.facilities)?void 0:null==(d=e.facilitiesInfo)?void 0:d.find(f=>f.id===a))?b:null};h.getFacilityLevels=function(a){var b,c;return a&&null!=(b=this.filterFeatures)&&null!=(c=b.levels)&&c.levelsInfo?
this.filterFeatures.levels.levelsInfo.filter(e=>e.facilityId===a).sort((e,d)=>{e=e.verticalOrder;d=d.verticalOrder;return e>d?-1:e===d?0:1}):[]};h.getLevel=function(a){var b,c,e,d;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(e=c.levels)?void 0:null==(d=e.levelsInfo)?void 0:d.find(f=>f.id===a))?b:null};h.getSite=function(a){var b,c,e,d;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(e=c.sites)?void 0:null==(d=e.sitesInfo)?void 0:d.find(f=>f.id===a))?b:null};h.goTo=function(a){const {view:b}=
this;b&&a&&({geometry:a}=a,a&&a.extent&&this.callGoTo({target:a.extent,options:{duration:1E3,easing:"out-back"}}))};h.setFloors=function(a){var b,c,e;null==(b=this.view)?void 0:null==(c=b.map)?void 0:null==(e=c.layers)?void 0:e.forEach(d=>{"feature"===d.type&&this._computeViewAllModeFloors(d)});this.view.floors=new B(this._computeFloors(a))};h.updateWebDocument=function(a){if("esri.WebMap"===a.declaredClass){var b,c,e;const d=new K({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,
pinnedLevels:this.pinnedLevels,site:null!=(b=this.site)?b:null,facility:null!=(c=this.facility)?c:null,level:null!=(e=this.level)?e:null});a.widgets?a.widgets.floorFilter=d:a.widgets=new L({floorFilter:d})}};h._computeFloors=function(a){if("single-floor"===this.filterMode)this._computeSingleFloor(a);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(a):this._computeBaseFloors(a);return this._computeEmptyFloors()};h._computeSingleFloor=function(a){if(!a)return this._computeEmptyFloors();
const b=[];"all"===(null==a?void 0:a.id)?this.getFacilityLevels(a.facilityId).forEach(c=>{c.id&&b.push(c.id)}):a&&b.push(a.id);return b};h._computeBaseFloors=function(a){var b,c;const e=null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:c.levelsInfo;if(!e||!e.length)return this._computeEmptyFloors();const d=[];"all"===(null==a?void 0:a.id)?this.getFacilityLevels(a.facilityId).forEach(g=>{g.id&&d.push(g.id)}):a&&d.push(a.id);const f=null==a?void 0:a.facilityId;e.forEach(g=>{const {id:n,
facilityId:q,verticalOrder:p}=g;f||0!==p||d.includes(n)?q===f||0!==p||d.includes(n)||d.push(n):d.push(n)});return d};h._computeBaseFloors3D=function(a){var b,c;const e=null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:c.levelsInfo;if(!e||!e.length)return this._computeEmptyFloors();const d=[];b=null==a?void 0:a.id.split("--");1<(null==b?void 0:b.length)&&"all"===b[0]?this.getFacilityLevels(a.facilityId).forEach(g=>{g.id&&d.push(g.id)}):a&&d.push(a.id);const f=null==a?void 0:a.facilityId;
e.forEach(g=>{const {id:n,facilityId:q}=g;f||d.includes(n)?q===f||d.includes(n)||d.push(n):d.push(n)});return d};h._computeEmptyFloors=function(){return[]};h._setFilterLayers=function(){var {view:a}=this;if(!this._isOverridden("filterLayers")){if("esri.WebMap"!==a.map.declaredClass&&"esri.WebScene"!==a.map.declaredClass)throw new I("Map must be a webmap or webscene");{var b;a=a.map;const q=null==a?void 0:a.layers;if(0<(null==q?void 0:null==(b=q.items)?void 0:b.length)){var c,e,d,f,g,n;const p={siteLayer:null,
facilityLayer:null,levelLayer:null},r=null==(c=a.floorInfo)?void 0:null==(e=c.siteLayer)?void 0:e.layerId,v=null==(d=a.floorInfo)?void 0:null==(f=d.facilityLayer)?void 0:f.layerId,w=null==(g=a.floorInfo)?void 0:null==(n=g.levelLayer)?void 0:n.layerId;q.items.filter(t=>"feature"===t.type||"scene"===t.type).forEach(t=>{const u=t.id;u&&(u===r?p.siteLayer=t:u===v?p.facilityLayer=t:u===w&&(p.levelLayer=t))});this.filterLayers=p}}}};h._getFilterFeatures=async function(){if(this._isOverridden("filterFeatures"))return Promise.resolve(this.filterFeatures);
const a={sites:null,facilities:null,levels:null};var b=await this._getSites();a.sites=b;b=await this._getFacilities();a.facilities=b;b=await this._getLevels();a.levels=b;return a};h._getSites=async function(){var a,b;const {filterLayers:c,view:e}=this;var d=e.map;const {siteLayer:f}=c,g={sitesInfo:[]};if(!f||null==d||null==(a=d.floorInfo)||!a.siteLayer)return g;a=f.createQuery();a.where="1\x3d1";a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;const {siteIdField:n,nameField:q}=d.floorInfo.siteLayer;
d=await f.queryFeatures(a);0<(null==d?void 0:null==(b=d.features)?void 0:b.length)&&d.features.forEach(p=>{var r=p.attributes;p=p.geometry;const v=r[n];r=r[q];v&&r&&g.sitesInfo.push({id:v,name:r,geometry:p})});return g};h._getFacilities=async function(){var a,b;const {filterLayers:c,view:e}=this;var d=e.map;const {facilityLayer:f}=c,g={facilitiesInfo:[]};if(!f||null==d||null==(a=d.floorInfo)||!a.facilityLayer)return g;a=f.createQuery();a.where="1\x3d1";a.returnGeometry=!0;a.outFields=["*"];a.returnZ=
!0;const {facilityIdField:n,siteIdField:q,nameField:p}=d.floorInfo.facilityLayer;d=await f.queryFeatures(a);0<(null==d?void 0:null==(b=d.features)?void 0:b.length)&&d.features.forEach(r=>{var v=r.attributes;r=r.geometry;const w=v[n],t=v[q];v=v[p];w&&v&&g.facilitiesInfo.push({id:w,siteId:t,name:v,geometry:r})});return g};h._getLevels=async function(){var a,b;const {filterLayers:c,view:e}=this;var d=e.map;const {levelLayer:f}=c,g={levelsInfo:[]};if(!f||null==d||null==(a=d.floorInfo)||!a.levelLayer)return g;
a=f.createQuery();a.where="1\x3d1";a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;const {levelIdField:n,facilityIdField:q,longNameField:p,shortNameField:r,levelNumberField:v,verticalOrderField:w}=d.floorInfo.levelLayer;d=await f.queryFeatures(a);0<(null==d?void 0:null==(b=d.features)?void 0:b.length)&&d.features.forEach(t=>{var u=t.attributes;t=u[n];const D=u[q],E=u[p],F=u[r],G=u[v];u=u[w];t&&D&&E&&F&&"number"===typeof G&&"number"===typeof u&&g.levelsInfo.push({id:t,facilityId:D,longName:E,shortName:F,
levelNumber:G,verticalOrder:u})});return g};h._registerWidget=function(a){(null==a?0:a.persistableViewModels.some(b=>b===this))||(null==a?void 0:a.persistableViewModels.add(this))};h._unregisterWidget=function(a){null==a?void 0:a.persistableViewModels.remove(this)};h._setInitialViewState=function(){this.view&&(this._setFilterLayers(),this._getFilterFeatures().then(a=>{a&&(this.filterFeatures=a,this.hasFacilities&&this.hasLevels?(this.hasMultipleSites||(this.filterMenuType="facility"),this.view.when().then(()=>
{if(this.facility&&this.level){this.filterMenuType="facility";var b=this.getFacility(this.facility),c=this.getLevel(this.level);this.setFloors(c);this.goTo(b)}else this.facility&&!this.level?(this.filterMenuType="facility",b=this.getFacility(this.facility),c=this.getBaseLevel(b),this.site||(this.site=b.siteId||void 0),this.level=(null==c?void 0:c.id)||void 0,this.setFloors(c),this.goTo(b)):!this.facility&&this.level?(this.filterMenuType="facility",b=this.getLevel(this.level),c=this.getFacility(null==
b?void 0:b.facilityId),this.facility=(null==c?void 0:c.id)||void 0,this.site||(this.site=(null==c?void 0:c.siteId)||void 0),this.setFloors(b),this.goTo(c)):!this.site||this.facility||this.level?this.setFloors(null):(this.filterMenuType="site",b=this.getSite(this.site),this.setFloors(null),this.goTo(b))})):console.error("Facilities and Levels are required for the Floor Filter widget"))}).catch(a=>{console.error("Couldn't retrieve sites, facilities, and levels",a)}))};h._callOverride=function(a,b){this._override(a,
b)};h._updateFloorFilterFromMap=async function(a){var b;a&&"esri.WebMap"===a.declaredClass&&(a=null==a?void 0:null==(b=a.widgets)?void 0:b.floorFilter)&&(this._isOverridden("enabled")||(this.enabled=a.enabled),this._isOverridden("longNames")||(this.longNames=a.longNames),this._isOverridden("minimized")||(this.minimized=a.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=a.pinnedLevels),this._isOverridden("site")||(this.site=a.site),this._isOverridden("facility")||(this.facility=a.facility),
this._isOverridden("level")||(this.level=a.level))};h._computeViewAllModeFloors=function(a){var b;const {filterFeatures:c}=this;if(null!=(b=a.floorInfo)&&b.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const {level:e,facility:d}=this,f=[];c.levels.levelsInfo.forEach(g=>{const {id:n,facilityId:q}=g;d&&q===d?e&&n===e&&f.push(n):f.push(n)});a.floorInfo.viewAllLevelIds=new B(f)}};z._createClass(y,[{key:"enabled",set:function(a){this._callOverride("enabled",a)}},{key:"facility",
set:function(a){if(a&&this._isOverridden("facility")){const b=this.getFacility(a);this.hasMultipleSites&&(this.site=(null==b?void 0:b.siteId)||void 0)}this._callOverride("facility",a)}},{key:"filterFeatures",set:function(a){this._callOverride("filterFeatures",a)}},{key:"filterLayers",set:function(a){this._callOverride("filterLayers",a)}},{key:"hasFacilities",get:function(){var a,b,c,e;return(null==(a=this.filterLayers)?void 0:a.facilityLayer)&&0<(null==(b=this.filterFeatures)?void 0:null==(c=b.facilities)?
void 0:null==(e=c.facilitiesInfo)?void 0:e.length)}},{key:"hasLevels",get:function(){var a,b,c,e;return(null==(a=this.filterLayers)?void 0:a.levelLayer)&&0<(null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:null==(e=c.levelsInfo)?void 0:e.length)}},{key:"hasMultipleSites",get:function(){var a,b,c,e;return(null==(a=this.filterLayers)?void 0:a.siteLayer)&&1<(null==(b=this.filterFeatures)?void 0:null==(c=b.sites)?void 0:null==(e=c.sitesInfo)?void 0:e.length)}},{key:"isNormalMode",get:function(){let a=
!0;const b=this._viewWidthBreakpoint,c=this._viewHeightBreakpoint;if("small"===b||"xsmall"===b||"small"===c||"xsmall"===c)a=!1;return a}},{key:"level",set:function(a){if(a){var b=null,c=null;b=null==a?void 0:a.split("--");if(1<(null==b?void 0:b.length)&&"all"===b[0])c=b[1],b={id:a,facilityId:c,shortName:null,longName:null,levelNumber:null,verticalOrder:null};else{var e;b=this.getLevel(a);c=null==(e=b)?void 0:e.facilityId}if(this.level!==a||this.isNormalMode||this.levelsExpanded){if(b&&this.hasFacilities&&
this.hasLevels){this.facility=c;if(this.hasMultipleSites){var d;this.site=null==(d=this.getFacility(c))?void 0:d.siteId}this.setFloors(b)}else this._isOverridden("level")&&(this.site=this.facility=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",a)}else a=this.getFacilityLevels(c),1<(null==a?void 0:a.length)&&(this.levelsExpanded=!0)}else this._callOverride("level",a),this.site=this.facility=void 0,this.setFloors(null)}},{key:"longNames",
set:function(a){this._callOverride("longNames",a)}},{key:"minimized",set:function(a){this._callOverride("minimized",a)}},{key:"pinnedLevels",set:function(a){this._callOverride("pinnedLevels",a)}},{key:"site",set:function(a){this._callOverride("site",a)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}}]);return y}(N.GoToMixin(M.HandleOwner));l.__decorate([m.property({value:!1})],k.prototype,
"enabled",null);l.__decorate([m.property({value:void 0})],k.prototype,"facility",null);l.__decorate([m.property({value:null})],k.prototype,"filterFeatures",null);l.__decorate([m.property({value:null})],k.prototype,"filterLayers",null);l.__decorate([m.property()],k.prototype,"filterMenuOpen",void 0);l.__decorate([m.property()],k.prototype,"filterMenuType",void 0);l.__decorate([m.property()],k.prototype,"filterMode",void 0);l.__decorate([m.property()],k.prototype,"hasFacilities",null);l.__decorate([m.property()],
k.prototype,"hasLevels",null);l.__decorate([m.property()],k.prototype,"hasMultipleSites",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"isNormalMode",null);l.__decorate([m.property({value:void 0})],k.prototype,"level",null);l.__decorate([m.property({value:!1})],k.prototype,"longNames",null);l.__decorate([m.property()],k.prototype,"levelsExpanded",void 0);l.__decorate([m.property({value:!1})],k.prototype,"minimized",null);l.__decorate([m.property({value:!1})],k.prototype,"pinnedLevels",
null);l.__decorate([m.property()],k.prototype,"searchTerm",void 0);l.__decorate([m.property({value:void 0})],k.prototype,"site",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"state",null);l.__decorate([m.property()],k.prototype,"view",void 0);l.__decorate([m.property()],k.prototype,"_viewHeightBreakpoint",void 0);l.__decorate([m.property()],k.prototype,"_viewWidthBreakpoint",void 0);l.__decorate([m.property()],k.prototype,"updateWebDocument",null);return k=l.__decorate([H.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],
k)});