// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require exports ../../core/has ../../core/maybe ../../core/promiseUtils ../../layers/support/fieldUtils ../../core/screenUtils ../../Graphic ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../core/accessorSupport/diffUtils ../../symbols/support/symbolUtils ../../views/support/hitTestSelectUtils ../../renderers/support/clickToleranceUtils ../../views/support/drapedUtils".split(" "),
function(G,v,ba,r,z,H,B,K,L,M,N,O,P,C,Q,R,S){function I(a){const b=a.layer;a:switch(b.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":var c=!0;break a;default:c=!1}var e=(a=c&&N.getVisualVariableValues(b.renderer,a))?a.map(d=>d.variable):[];c=e.filter(d=>"rotation"===d.type&&(!d.axis||"heading"===d.axis));a=c[0];c=1===c.length&&a.field&&!a.valueExpression;var g=e.filter(d=>"size"===d.type);e=g[0];g=1===g.length&&"real-world-size"===L.getTransformationType(e)&&
e.field&&!e.useSymbolValue&&!e.valueExpression;return{rotation:c?T(a,b):null,size:g?U(e,b):null}}function T(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,e=a.field,g=(a=b.fields&&b.fields.filter(h=>h.name===e))&&1===a.length?a[0].type:"double";var d=0,k=0;return{field:e,getDefault:()=>Promise.resolve(0),getValue:h=>{k=d-c*h;return D((k+360)%360,g)},initValue:h=>{d=null!=h?h:k;k=0},isUpdatingInteractively:!1}}function V(a,b){switch(b){case "width":return a[0];case "depth":return a[1];
case "height":return a[2];default:return a[2]||a[1]||a[0]}}async function W(a,b,c){if(r.isNone(b))return 0;({symbol:b}=O.to3D(b));if(r.isNone(b)||"web-style"===b.type)return 0;b=b.symbolLayers.getItemAt(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=await new Promise(function(e,g){G(["../../symbols/support/symbolLayerUtils"],e,g)}),b.size||Math.min(w.icon,(await c(b,w.icon))[0])||w.icon;case "text":return b.size||w.text;case "line":return b.size||w.line;case "object":{const {computeObjectLayerResourceSize:e}=
await new Promise(function(g,d){G(["../../symbols/support/symbolLayerUtils"],g,d)});a=await e(b,a.scale/w.viewScaleSizeFactor);return V(a,c)}case "path":case "extrude":return b.size||a.scale/w.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}}function U(a,b){const c=a.field,e=a.axis,g=(b=b.fields&&b.fields.filter(f=>f.name===c))&&1===b.length?b[0].type:"double";var d=0,k=0;const h=M.meterIn[a.valueUnit];let l;l="area"===a.valueRepresentation?f=>(f*h/2)**2*Math.PI:"radius"===
a.valueRepresentation||"distance"===a.valueRepresentation?f=>f*h/2:f=>f*h;return{field:c,getDefault:async(f,m)=>D(l(await W(m,f,e)),g),getValue:(f,m)=>{d||(d=m.pixelSizeAt(m.center));k=d*f;return D(k,g)},initValue:f=>{d=null!=f?f:k;k=0},isUpdatingInteractively:!1}}function D(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}async function A(a){const b=await C.getDisplayedSymbol(a,{ignoreGraphicSymbol:!0}),c=P.diff(a.symbol,
b);r.isSome(c)&&(a.symbol=b)}async function X(a,b,c){var e;if("3d"===c.type){var g=b.layer;b={...b.template.prototype.attributes};g=new K({layer:g,sourceLayer:g,attributes:b});var {rotation:d,size:k}=I(g),h=await C.getDisplayedSymbol(g),l=!1;for(const f of[k,d])r.isNone(f)||null!=b[f.field]||(b[f.field]=await f.getDefault(h,c),l=!0);l&&(h=await C.getDisplayedSymbol(g));switch(null==(e=h)?void 0:e.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=h;break;case "simple-line":case "line-3d":a.polylineSymbol=
h;break;case "simple-marker":case "point-3d":a.pointSymbol=h}}}async function Y(a,b,c,e){if(0===a.length)return[];const {updatable:g,graphicsByLayer:d}=await c.async(async()=>{var {results:k}=await z.whenOrAbort(Q.hitTestSelectSameDistance(b,c),e);const h=new Map,l=({layer:f})=>{var m=h.get(f);return m?m:(m=[],h.set(f,m),m)};k.forEach(({graphic:f})=>l(f).push(f));k=a.filter(({supports:f,layer:m})=>-1<f.indexOf("update")&&h.has(m));0!==k.length&&c.stopPropagation();return{updatable:k,graphicsByLayer:h}});
return z.whenOrAbort(z.eachAlways(g.map(async({layer:k})=>{const {objectIdField:h,displayField:l}=k,f=[h];H.hasField(k.fields,l)&&f.push(l);const m=d.get(k);if(m.some(u=>f.some(x=>!(x in u.attributes)))){const u=k.createQuery();u.outFields=f;u.returnGeometry=!1;u.objectIds=m.map(x=>x.getObjectId());return k.queryFeatures(u,{signal:e}).then(({features:x})=>x)}return m})),e)}async function Z(a,b,c,e){if(0===a.length)return[];const g=await c.async(async()=>{var {results:d}=await z.whenOrAbort(b.hitTest(c),
e);if(0===d.length)return[];const k=new Set;d.forEach(({graphic:h})=>k.add(h.layer));d=a.items.filter(({layer:h,supports:l})=>-1<l.indexOf("update")&&k.has(h));0<d.length&&c.stopPropagation();return d});return z.whenOrAbort(z.eachAlways(g.map(({layer:d})=>{const {objectIdField:k,displayField:h}=d;var l=[k];H.hasField(d.fields,h)&&l.push(h);const f=d.createQuery();f.outFields=l;f.returnGeometry=!1;l=R.calculateTolerance({renderer:d.renderer,event:c});f.geometry=S.createQueryGeometry(c.mapPoint,l,b);
f.outSpatialReference=b.spatialReference;return d.queryFeatures(f,{signal:e}).then(({features:m})=>m)})),e)}const w={icon:B.px2pt(24),text:B.px2pt(12),line:B.px2pt(1),viewScaleSizeFactor:100};v.fetchCandidates=async function(a,b,c,e){switch(b.type){case "3d":return Y(a,b,c,e);case "2d":return Z(a,b,c,e)}};v.fetchFullFeature=async function(a,b,c){const e=a.layer,g=e.createQuery();g.objectIds=[a.getAttribute(e.objectIdField)];g.outFields=["*"];g.outSpatialReference=b.spatialReference;g.returnM=e.capabilities.data.supportsM;
g.returnZ=e.capabilities.data.supportsZ;return(await e.queryFeatures(g,{signal:c})).features[0]};v.findLayerInfo=function(a,b){return a&&a.find(c=>c.layer===b)};v.getVisualVariableAttributes=I;v.setUpFeatureAdd=async function(a,b,c,e){const g=b.layer;await X(a,b,c);a.layer.elevationInfo=g.elevationInfo;await a.create(g.geometryType,{hasZ:g.capabilities.data.supportsZ});const d=a.on("create",async k=>{const {state:h,graphic:l}=k;"cancel"===h?a.create(g.geometryType,{hasZ:g.capabilities.data.supportsZ}):
"complete"===h&&(k=l.clone(),k.attributes={...b.template.prototype.attributes},k.layer=g,a.layer.remove(l),await A(k),e(k))});c.map.add(a.layer);return{remove:()=>{d.remove();c.map.remove(a.layer);a.cancel()}}};v.setUpGeometryUpdate=async function(a,b,c,e,g){const d=a.clone();await A(d);c.layer.add(d);d.sourceLayer=a.layer;const k=(()=>{const {layer:n}=a;if("graphics"===n.type)return{remove(){}};const {objectIdField:q}=n,t=a.attributes[q],p=e.whenLayerView(n);p.then(y=>y.setVisibility(t,!1),()=>{});
return{remove(){p.then(y=>y.setVisibility(t,!0),()=>{})}}})(),h=a.layer,l=b.size,f=b.rotation,m={multipleSelectionEnabled:!1};"point"===h.geometryType&&(m.enableRotation=!!f,m.enableScaling=!!l);c.layer.elevationInfo=h.elevationInfo;c.update(d,m);const u=(r.isSome(l)||r.isSome(f))&&a.watch("attributes",async n=>{let q=!1;for(const t in n){const p=n[t];p!==d.attributes[t]&&(d.setAttribute(t,p),q=!0,r.isSome(l)&&!l.isUpdatingInteractively&&l.field===t&&l.initValue(p),r.isSome(f)&&!f.isUpdatingInteractively&&
f.field===t&&f.initValue(p))}q&&"3d"===e.type&&await A(d)});[f,l].forEach(async n=>{if(!r.isNone(n)){var q=a.attributes[n.field];null!=q?n.initValue(q):(q=await n.getDefault(d.symbol,e),n.initValue(q),d.setAttribute(n.field,q),"3d"===e.type&&await A(d))}});const x=c.on("update",async n=>{const {graphics:[q],state:t,toolEventInfo:p}=n;if("complete"===t)c.update(q,m);else{if(r.isSome(f)&&p){const {field:y,getValue:E,initValue:F}=f;"rotate-stop"===p.type?(f.isUpdatingInteractively=!1,F()):null!=p.angle&&
(f.isUpdatingInteractively=!0,d.attributes[y]=E(p.angle,e))}if(r.isSome(l)&&p){const {field:y,getValue:E,initValue:F}=l;"scale-stop"===p.type?(l.isUpdatingInteractively=!1,F()):null!=p.xScale&&(l.isUpdatingInteractively=!0,d.attributes[y]=E(p.xScale,e))}"3d"===e.type&&await A(d);g(q.clone())}}),aa=c.on(["undo","redo"],async n=>{({graphics:[n]}=n);g(n.clone())});e.map.add(c.layer);const J=()=>{};return{interactive:{remove(){aa.remove();x.remove();c.cancel();u&&u.remove();this.remove=J}},visual:{remove(){k.remove();
e.map.remove(c.layer);c.layer.removeAll();this.remove=J}}}};v.sizeDefaults=w;Object.defineProperty(v,"__esModule",{value:!0})});