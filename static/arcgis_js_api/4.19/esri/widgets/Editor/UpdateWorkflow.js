// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/handleUtils ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../core/watchUtils ../../views/support/layerViewUtils ./Edits ./Workflow ./workflowUtils ./UpdateWorkflowData".split(" "),
function(F,G,v,y,P,Q,z,R,S,H,T,U,V,q,I,J,K,L,r,M){var w;v=w=function(A){function t(b){b=A.call(this,b)||this;b.type="update";return b}F._inheritsLoose(t,A);t.create=function(b,n,a){b=new M({edits:new K,viewModel:b});a=new w({data:b,afterCommit:a});a._set("steps",this._createWorkflowSteps(a,n));return a};var B=t.prototype;B.highlight=function(b){var {data:{viewModel:{view:n}}}=this;n=b&&n.allLayerViews.items.find(({layer:a})=>a===b.layer);J.highlightsSupported(n)&&this.handles.add(n.highlight(b),"candidate-highlight")};
B.unhighlight=function(){this.handles.remove("candidate-highlight")};t._createWorkflowSteps=function(b,n="awaiting-feature-to-update"){const {data:a,handles:g}=b,O={"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const {spinnerViewModel:e,view:c}=a.viewModel;let f=null;g.add({remove(){f&&(f.abort(),f=null)}},this.id);a.edits.feature=null;const l=c.on("immediate-click",m=>{e.location=m.mapPoint;e.visible=!0;f&&f.abort();const {editableItems:h}=a.viewModel;f=q.createAbortController();
(new Promise((p,k)=>{q.onAbort(f.signal,()=>k(q.createAbortError()));p(r.fetchCandidates(h,c,m,f.signal))})).then(p=>{a.viewModel.spinnerViewModel.visible=!1;q.throwIfAborted(f);a.candidates=p.reduce((k,d)=>d.error?k:[...k,...d.value],[]);0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature")):a.viewModel.activeWorkflow.next())})});g.add(l,this.id)},async tearDown(){g.remove(this.id)}}),"awaiting-update-feature-candidate":()=>
({id:"awaiting-update-feature-candidate",async setUp(){const {edits:e}=a;e.feature=null;g.add(I.watch(e,"feature",c=>{b.unhighlight();b.highlight(c)}),this.id)},async tearDown(){b.unhighlight();g.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const e=a.edits.feature,c=a.viewModel;a.editableItem=c.editableItems.find(d=>d.layer===e.layer);const f=q.createAbortController();g.add({remove:()=>f.abort()},this.id);var l=c.view.whenLayerView(e.layer),m=r.fetchFullFeature(e,
c.view,f.signal);l=await l;const h=await m;if(!q.isAborted(f)){a.edits.updateGeometry(h.geometry);a.edits.updateAttributes(h.attributes);a.edits.trackChanges();m=h.layer;var p=r.findLayerInfo(c.layerInfos,m);p=p&&p.fieldConfig;c.attachmentsViewModel.set({graphic:h,mode:"view"});c.featureFormViewModel.set({feature:h,fieldConfig:p});var k="createInteractiveEditSession"in l?l.createInteractiveEditSession(e):null;l=[c.featureFormViewModel.on("value-change",d=>{a.edits.updateAttributes(c.featureFormViewModel.getValues());
h.attributes=a.edits.feature.attributes;k&&k.setAttribute(d.fieldName,d.value)}),c.attachmentsViewModel.watch("mode",d=>{"add"===d&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===d&&a.viewModel.activeWorkflow.go("editing-attachment")})];k&&(l.push(z.makeHandle(()=>k.rollback())),g.add(z.makeHandle(()=>k.commit()),b._handleKeys.afterCommit));({supportsGeometryUpdate:m}=m.capabilities.editing);if(m){const d=r.getVisualVariableAttributes(h),{interactive:C,visual:D}=await r.setUpGeometryUpdate(h,
d,c.sketchViewModel,c.view,({geometry:N,attributes:x})=>{if(y.isSome(d.rotation)){var {field:u}=d.rotation;c.featureFormViewModel.setValue(u,x[u])}y.isSome(d.size)&&({field:u}=d.size,c.featureFormViewModel.setValue(u,x[u]));a.edits.updateAttributes(x);a.edits.updateGeometry(N)});l.push(C,D);g.add(C,b._handleKeys.beforeCommit);g.add(D,b._handleKeys.afterCommit)}else b.highlight(h);g.add(l,this.id)}},async tearDown(){b.unhighlight();g.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",
parent:"editing-existing-feature",async setUp(){},async tearDown(){}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){}})};let E=!1;return["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"].filter(e=>E?!0:E=e===n).map(e=>O[e]())};return t}(L);return v=w=G.__decorate([H.subclass("esri.widgets.Editor.UpdateWorkflow")],v)});