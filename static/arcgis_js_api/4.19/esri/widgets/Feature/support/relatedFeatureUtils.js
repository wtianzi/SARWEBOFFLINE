// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/Error ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../request ../../../tasks/support/StatisticDefinition ../../../tasks/support/Query ../../../tasks/support/RelationshipQuery ../../../tasks/QueryTask ./featureUtils".split(" "),function(h,v,p,l,q,w,x,m,y,z,A){function B(b,a){if(!a.relationships)return null;let d=null;({relationships:a}=a);a.some(e=>e.id===parseInt(b,10)?(d=e,!0):!1);return d}function r({originRelationship:b,
relationships:a,layerId:d}){let e;a&&a.some(c=>{`${c.relatedTableId}`===d&&c.id===b.id&&(e=c);return!!e});return e}function C(b,a){a=a.toLowerCase();for(const d in b)if(d.toLowerCase()===a)return b[d];return null}function D(b,a,d,e){const c=new y;c.outFields=["*"];c.relationshipId="number"===typeof a.id?a.id:parseInt(a.id,10);c.objectIds=[b.attributes[d.objectIdField]];return d.queryRelatedFeatures(c,e)}function E(b,a,d){let e=0;const c=[];for(;e<a.length;)c.push(`${b} IN (${a.slice(e,d+e)})`),e+=
d;return c.join(" OR ")}async function F(b,a,d,e){var c=d.layerId.toString();const {layerInfo:f,queryTask:g,relation:k,relatedFields:G,outStatistics:n}=a;c=r({originRelationship:k,relationships:f.relationships,layerId:c});if(c.relationshipTableId&&c.keyFieldInRelationshipTable){d=(await D(b,c,d,e))[b.attributes[d.objectIdField]];if(!d)return null;const I=d.features.map(H=>H.attributes[f.objectIdField]);if(0<(null==n?void 0:n.length)&&f.supportsStatistics)return a=new m,a.where=E(f.objectIdField,I,
1E3),a.outFields=G,a.outStatistics=n,a={features:Promise.resolve(d),statsFeatures:g.execute(a)},l.eachAlways(a)}return(c=null==c?void 0:c.keyField)?(d=q.isNumericField(q.getField(f.fields,c)),b=C(b.attributes,k.keyField),c=d?`${c}=${b}`:`${c}='${b}'`,b=g.execute(new m({where:c,outFields:a.relatedFields}),e),a=a.outStatistics&&0<a.outStatistics.length&&f.supportsStatistics?g.execute(new m({where:c,outFields:a.relatedFields,outStatistics:a.outStatistics}),e):null,e={features:b},a&&(e.statsFeatures=
a),l.eachAlways(e)):null}const t=v.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),u=new Map;h.createRelatedInfo=function(b,a){if(b=B(b,a)){var d=`${a.url}/${b.relatedTableId}`;a=new z({url:d,sourceSpatialReference:a.spatialReference});return{url:d,queryTask:a,relation:b,relatedFields:[],outStatistics:[]}}};h.getDestinationRelation=r;h.getRelatedFieldInfo=function(b){if(!A.isRelatedField(b))return null;const [a,d]=b.split("/").slice(1);return{layerId:a,fieldName:d}};h.queryLayerInfos=
function({relatedInfos:b,layer:a},d){const e={};b.forEach((c,f)=>{({relation:c}=c);if(!c)throw f=new p("relation-required","A relation is required on a layer to retrieve related records."),t.error(f),f;({relatedTableId:c}=c);if("number"!==typeof c)throw f=new p("A related table ID is required on a layer to retrieve related records."),t.error(f),f;c=`${a.url}/${c}`;const g=u.get(c),k=g?g:w(c,{query:{f:"json"},signal:d&&d.signal});g||u.set(c,k);e[f]=k});return l.eachAlways(e)};h.queryRelatedFeatures=
function({graphic:b,relatedInfos:a,layer:d},e){const c={};a.forEach((f,g)=>{f.layerInfo&&(c[g]=F(b,f,d,e))});return l.eachAlways(c)};h.setRelatedFeatures=function(b,a){if(a&&b){var {features:d,statsFeatures:e}=b;b=d&&d.value;a.relatedFeatures=b?b.features:[];b=e&&e.value;a.relatedStatsFeatures=b?b.features:[]}};h.updateRelatedInfo=function({relatedInfo:b,fieldName:a,fieldInfo:d}){b.relatedFields.push(a);d.statisticType&&(a=new x({statisticType:d.statisticType,onStatisticField:a,outStatisticFieldName:a}),
b.outStatistics.push(a))};Object.defineProperty(h,"__esModule",{value:!0})});