// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../core/string ../../../core/Logger ../../../core/Error ../../../layers/support/fieldUtils ../../../intl/date ../../../intl/number ../../../popup/support/FieldInfoFormat ../../../intl".split(" "),function(f,E,m,F,t,G,l,u,H,Y){function v(a){return w.test(a)}function I(a,b){if(!v(b)||!a)return null;const c=b.replace(w,"").toLowerCase();let e;a.some(d=>d.name.toLowerCase()===c?(e=d,!0):!1);return e}function n(a,b){return(b=p(b,a))?b.name:a}function p(a,b){return a&&
"function"===typeof a.getField?a.getField(b):null}function x({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${m.replace(m.replace(b,e=>{{const d=c.get(e.toLowerCase());e=`{${d&&d.fieldName||e}}`}return e}),a).replace(J,"")}`.trim()}function K(a,b,c=!1){const e=b[a];"string"===typeof e&&(c=(c?encodeURIComponent(e):e).replace(L,"%27"),b[a]=c)}function M(a,b=!1){const c={...a};Object.keys(c).forEach(e=>K(e,c,b));return c}function y(a,b){return a.replace(N,(c,e,d)=>(c=p(b,d))?`{${c.name}}`:
e)}function O(a,b,c){return(a=y(a,c))?a.replace(P,(e,d,g)=>{d=`${d||g}`.trim();return m.replace(e,M(b,d&&"{"!==d[0]))}):a}function z(a,b){const c=b.fieldName;var e=A(b.fieldInfos,c),d=null==e?void 0:e.clone();e=b.preventPlacesFormatting;b=p(b.layer,c);d&&b&&"date"===b.type&&(b=d.format||new H,b.dateFormat=b.dateFormat||"short-date-short-time",d.format=b);d=d&&d.format;"string"!==typeof a||!d||null!=d.dateFormat||null==d.places&&null==d.digitSeparator||(b=Number(a),isNaN(b)||(a=b));return"string"===
typeof a||null==a||null==d?a:e?u.formatNumber(a,{...u.convertNumberFormatToIntlOptions(d),minimumFractionDigits:0,maximumFractionDigits:20}):d.format(a)}function A(a,b){if(a&&a.length&&b){var c=b.toLowerCase(),e=void 0;a.some(d=>d.fieldName&&d.fieldName.toLowerCase()===c?(e=d,!0):!1);return e}}function Q({fieldName:a,graphic:b,layer:c}){if(q(a)||!c||"function"!==typeof c.getFeatureType)return null;const {typeIdField:e}=c;return e&&a===e?(a=c.getFeatureType(b))?a.name:null:null}function R({fieldName:a,
value:b,graphic:c,layer:e}){return q(a)||!e||"function"!==typeof e.getFieldDomain?null:(a=e.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null}function B(a){return"string"===typeof a?a.replace(S,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function T(a){const {value:b,fieldName:c,fieldInfos:e,fieldInfoMap:d,layer:g,graphic:h}=a;return null==b?"":(a=R({fieldName:c,value:b,graphic:h,layer:g}))||(a=Q({fieldName:c,graphic:h,layer:g}))?a:d.get(c.toLowerCase())?z(b,{fieldInfos:e,
fieldName:c,layer:g}):(a=g&&g.fieldsIndex)&&a.isDateField(c)?l.formatDate(b,r):B(b)}async function U(a,b){const {layer:c,graphic:e,outFields:d,objectIds:g,returnGeometry:h,spatialReference:k}=a;a=g[0];if("number"!==typeof a&&"string"!==typeof a)throw b={layer:c,graphic:e,objectId:a,requiredFields:d},a=new t("layer-query-features-invalid-objectid","Could not query required fields for the specified feature. The feature's ID is invalid.",b),C.warn("Could not query required fields for the specified feature. The feature's ID is invalid.",
b),a;if("function"!==typeof c.queryFeatures)throw b={layer:c,graphic:e,requiredFields:d},a=new t("layer-query-features-unsupported","The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",b),C.warn("The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",b),a;a=c.createQuery();a.objectIds=g;a.outFields=d;a.returnGeometry=!!h;a.outSpatialReference=k;return(await c.queryFeatures(a,b)).features[0]}
function q(a=""){return a?-1!==a.indexOf("relationships/"):!1}function D({attributes:a,graphic:b,relatedInfo:c}){a&&b&&c&&Object.keys(b.attributes).forEach(e=>{var d={layerId:c.relation.id.toString(),fieldName:e};a[d?`${"relationships/"}${d.layerId}/${d.fieldName}`:""]=b.attributes[e]})}function V(a,b){a&&b&&(b.relatedFeatures&&b.relatedFeatures&&b.relatedFeatures.forEach(c=>D({attributes:a,graphic:c,relatedInfo:b})),b.relatedStatsFeatures&&b.relatedStatsFeatures&&b.relatedStatsFeatures.forEach(c=>
D({attributes:a,graphic:c,relatedInfo:b})))}const C=F.getLogger("esri.widgets.Feature.support.featureUtils"),J=/href=(""|'')/gi,N=/(\{([^\{\r\n]+)\})/g,L=/'/g,w=/^\s*expression\//i,S=/(\n)/gi,W=/[\u00A0-\u9999<>&]/gim,P=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,X=/^(?:mailto:|tel:)/,r=l.convertDateFormatToIntlOptions("short-date-short-time");f.applyTextFormattingHTML=B;f.createfieldInfoMap=function(a,b){const c=new Map;a&&a.forEach(e=>{const d=n(e.fieldName,b);e.fieldName=d;c.set(d.toLowerCase(),e)});
return c};f.fixTokens=y;f.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:e,fieldInfoMap:d,relatedInfos:g}){const h={...b};null==g?void 0:g.forEach(k=>V(h,k));Object.keys(h).forEach(k=>{h[k]=T({fieldName:k,fieldInfos:a,fieldInfoMap:d,layer:c,value:h[k],graphic:e})});return h};f.formatEditInfo=function(a,b){const {creatorField:c,creationDateField:e,editorField:d,editDateField:g}=a;if(b){a=b[g];if("number"===typeof a)return b=b[d],{type:"edit",date:l.formatDate(a,r),user:b};a=b[e];
return"number"===typeof a?(b=b[c],{type:"create",date:l.formatDate(a,r),user:b}):null}};f.formatValueToFieldInfo=z;f.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:e}=a;c&&b.push(...c);if(!e||!Array.isArray(e))return b;e.forEach(d=>{"fields"===d.type&&(d=d&&d.fieldInfos)&&b.push(...d)});return b};f.getFieldInfo=A;f.getFieldInfoLabel=function(a,b){return(b=I(b,null==a?void 0:a.fieldName))?b.title||null:a?a.label||a.fieldName:null};f.getFixedFieldName=n;f.getFixedFieldNames=
function(a,b){return a&&a.map(c=>n(c,b))};f.getSourceLayer=function(a){if(!E.isNone(a))return a.get("sourceLayer")||a.get("layer")};f.graphicCallback=async function(a,b){return"function"===typeof a?a.call(null,b):a};f.htmlEntities=function(a){return a.replace(W,b=>`&#${b.charCodeAt(0)};`)};f.isExpressionField=v;f.isRelatedField=q;f.queryUpdatedFeature=async function({graphic:a,popupTemplate:b,layer:c,spatialReference:e},d){if(c&&b){var {returnGeometry:g}=b;"function"===typeof c.load&&await c.load(d);
var h=a.attributes[c.objectIdField];if(null!=h){h=[h];b=await b.getRequiredFields(c.fields);var k=G.featureHasFields(b,a);if(!k||g)if(c=await U({layer:c,graphic:a,outFields:k?[]:b,objectIds:h,returnGeometry:g,spatialReference:e},d))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes={...a.attributes,...c.attributes})}}};f.shouldOpenInNewTab=function(a=""){if(a)return!X.test(a.trim().toLowerCase())};f.substituteAttributes=x;f.substituteFieldsInLinksAndAttributes=function({attributes:a,
globalAttributes:b,layer:c,text:e,fieldInfoMap:d}){return e?x({formattedAttributes:b,template:O(e,{...b,...a},c),fieldInfoMap:d}):""};Object.defineProperty(f,"__esModule",{value:!0})});