// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/Accessor ../../../core/Collection ../../../layers/support/fieldUtils ../../../Color ../../../core/screenUtils ../../../kernel ../../../request ../../../symbols/SimpleFillSymbol ../../../symbols/SimpleMarkerSymbol ../../../symbols ../../../core/Handles ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/utils ../../../renderers/support/jsonUtils ../../../core/watchUtils ../../../layers/support/ExportImageParameters ../../../symbols/support/symbolUtils ../../../renderers/support/rendererConversion ./clusterUtils ./utils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils".split(" "),
function(R,S,v,u,H,da,Ja,x,ea,fa,ha,Ka,La,B,ia,ja,ka,T,la,ma,U,na,V,Ma,oa,pa,qa,ra,sa,C,ta,A,ua,va,wa,I,xa,W,M){function D(q){return"esri.renderers.SimpleRenderer"===q.declaredClass}function E(q){return"esri.renderers.ClassBreaksRenderer"===q.declaredClass}function N(q){return"esri.renderers.UniqueValueRenderer"===q.declaredClass}function X(q){return"esri.renderers.HeatmapRenderer"===q.declaredClass}function O(q){return"esri.renderers.PointCloudClassBreaksRenderer"===q.declaredClass}function P(q){return"esri.renderers.PointCloudStretchRenderer"===
q.declaredClass}function Q(q){return"esri.renderers.PointCloudUniqueValueRenderer"===q.declaredClass}function Y(q){return"esri.renderers.DotDensityRenderer"===q.declaredClass}function Z(q){return"esri.layers.BuildingSceneLayer"===q.declaredClass}function ya(q){q="authoringInfo"in q&&(null==q?void 0:q.authoringInfo);return"univariate-color-size"===(null==q?void 0:q.type)}function za(q){q="authoringInfo"in q&&(null==q?void 0:q.authoringInfo);return"univariate-color-size"===(null==q?void 0:q.type)&&
"above-and-below"===(null==q?void 0:q.univariateTheme)}const z=da.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),J=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Aa=new ea.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Ba={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,
3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},K=new V({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ca=new na({style:"solid"}),Da=new V({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let F={};u=function(q){function L(a){a=q.call(this,a)||this;a._handles=new oa;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=
new ja;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=null;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}S._inheritsLoose(L,q);var h=L.prototype;h.initialize=function(){const a=()=>this.notifyChange("ready");this._handles.add([C.on(this,"children","change",b=>{const {added:c,removed:d}=b,e=this._handles;c.map(f=>{const k=`activeLayerInfo-ready-watcher-${f.layer.uid}`;e.add(C.init(f,"ready",a),k)});d.forEach(f=>e.remove(f.layer.uid));
a()})]);this.keepCacheOnDestroy||(F={})};h.destroy=function(){this._handles.destroy();this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=this._handles=null;this.keepCacheOnDestroy||(F=null)};h.buildLegendElementsForFeatureCollections=async function(a){a=a.map(b=>{if("esri.layers.FeatureLayer"===b.declaredClass)return this._getRendererLegendElements(b.renderer,{title:b.title});if(b.featureSet&&b.featureSet.features.length){var c=b.layerDefinition,d=c&&c.drawingInfo;d=
d&&sa.fromJSON(d.renderer);c=Aa.read(c.geometryType);return d?this._getRendererLegendElements(d,{title:b.name,geometryType:c}):(z.warn("drawingInfo not available!"),null)}return null});try{const b=[];await B.eachAlways(a).then(c=>{c.forEach(({value:d})=>d&&b.push(...d))});this.legendElements=b;this.notifyChange("ready")}catch(b){z.warn("error while building legend for layer!",b)}};h.buildLegendElementsForRenderer=async function(a){try{this.legendElements=await this._getRendererLegendElements(a),this.notifyChange("ready")}catch(b){z.warn("error while building legend for layer!",
b)}};h.buildLegendElementsForTools=async function(){const a=this.layer;"esri.layers.WMTSLayer"===a.declaredClass?this._constructLegendElementsForWMTSlayer():"esri.layers.WMSLayer"===a.declaredClass?await this._constructLegendElementsForWMSSublayers():Z(a)?await this._constructLegendElementsForBuildingSceneLayer():"esri.layers.MapImageLayer"===a.declaredClass||"esri.layers.TileLayer"===a.declaredClass||Z(a)?await this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),
await this._getLegendLayers(`${a.uid}-default`).then(async b=>{this.legendElements=[];this.notifyChange("ready");b=b.map(async c=>{if("esri.layers.ImageryLayer"===a.declaredClass||"esri.layers.ImageryTileLayer"===a.declaredClass){const d=a.watch(["renderingRule","bandIds"],()=>B.debounce(async()=>{F["default"]=null;a.renderer?await this.buildLegendElementsForRenderer(a.renderer):await this.buildLegendElementsForTools()})());this._handles.add(d,"imageryLayers-watcher")}(c=this._generateSymbolTableElementForLegendLayer(c))&&
c.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(c.title=a.title),this.legendElements.push(c));this.notifyChange("ready")});await B.eachAlways(b)}).catch(b=>{z.warn("Request to server for legend has failed!",b)}))};h._getParentLayerOpacity=function(a){let b=1;const c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));return a.opacity*b};h._isGroupActive=function(){const a=this.children;return a.length?a.some(b=>b.ready):!1};h._isScaleDrivenSizeVariable=function(a){if(a&&"size"!==
a.type)return!1;const b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!a.expression||J.test(a.valueExpression)};h._isLayerScaleDriven=function(a){if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&a.sublayers)return a.sublayers.some(c=>this._isLayerScaleDriven(c));const b=a.parent;if(!1===a.loaded&&b&&"esri.layers.MapImageLayer"===b.declaredClass&&"source"in a&&
a.source&&"map-layer"===a.source.type)for(const c of b.sourceJSON.layers)if(c.id===a.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1};h._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this._handles.remove("wmts-activeLayer-watcher");const a=this.layer.activeLayer;this._handles.add(C.watch(this.layer,"activeLayer",()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");if(a.styleId&&a.styles){let b=null;a.styles.some(c=>a.styleId===c.id?
(b=c.legendUrl,!0):!1);b&&(this.legendElements=[{type:"symbol-table",title:a.title,infos:[{src:b,opacity:this.opacity}]}])}this.notifyChange("ready")};h._constructLegendElementsForWMSSublayers=async function(){this.legendElements=[];this._handles.remove("wms-sublayers-watcher");const a=this.layer;let b=null;if(a.customParameters||a.customLayerParameters)b={...a.customParameters,...a.customLayerParameters};this._handles.add(C.watch(this.layer,"sublayers",()=>this._constructLegendElementsForWMSSublayers()),
"wms-sublayers-watcher");this.legendElements=await this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};h._generateLegendElementsForWMSSublayers=async function(a,b){const c=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");a=a.toArray();for(const d of a)a=d.watch(["title","visible","legendEnabled"],()=>this._constructLegendElementsForWMSSublayers()),this._handles.add(a,"wms-sublayers-watcher"),d.visible&&
d.legendEnabled&&(a=await this._generateSymbolTableElementForWMSSublayer(d,b))&&a.infos.length&&c.unshift(a);return c};h._generateSymbolTableElementForWMSSublayer=async function(a,b){return!a.legendUrl&&a.sublayers?(b=(await this._generateLegendElementsForWMSSublayers(a.sublayers,b)).filter(c=>c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)};h._generateSymbolTableElementForLegendUrl=async function(a,b){var c;let d=a.legendUrl;if(d){var e={type:"symbol-table",
title:a.title||a.name||a.id&&a.id+"",infos:[]};b&&(d+="?"+ha.objectToQuery(b));b=null;a=null==(c=a.layer)?void 0:c.opacity;try{if(b=(await U(d,{responseType:"image"})).data)b.style.opacity=a}catch{}e.infos.push({src:d,preview:b,opacity:a});return e}};h._getLegendLayers=function(a,b){const c=F&&F[a];return c?Promise.resolve(c):this._legendRequest(b).then(d=>{d=d.layers;return F[a]=d})};h._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=
b.exportImageServiceParameters.renderingRule;c&&(a.renderingRule=JSON.stringify(c.toJSON()));b.bandIds&&(a.bandIds=b.bandIds.join());if(b.raster||b.viewId){const {raster:d,viewId:e}=b;a={raster:d,viewId:e,...a}}}c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+
"\x26returnbytes\x3dtrue");return U(c,{query:a}).then(d=>d.data)};h._constructLegendElementsForBuildingSceneLayer=async function(){this.legendElements=[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(C.watch(a,"sublayers",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){z.warn("Request to server for legend has failed!",
b)}};h._generateLegendElementsForBuildingSublayers=async function(a,b){let c=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");a=a.toArray();for(const e of a)if(a=e.watch(["renderer","opacity","title","visible"],()=>this._constructLegendElementsForBuildingSceneLayer()),this._handles.add(a,"sublayers-watcher"),e.visible){a=e&&null!=e.opacity?e.opacity:null;var d=null!=a?a*b:b;"building-group"===e.type?(a={type:"symbol-table",title:e.title,
infos:[]},d=await this._generateLegendElementsForBuildingSublayers(e.sublayers,d),a.infos.push(...d),c=[a,...c]):e.renderer&&(c=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:d,sublayer:e}),...c])}return c.filter(e=>!!e&&("infos"in e?0<e.infos.length:!0))};h._constructLegendElementsForSublayers=async function(){this.legendElements=[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(C.watch(a,"sublayers",()=>this._constructLegendElementsForSublayers),
"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){z.warn("Request to server for legend has failed!",b)}};h._generateLegendElementsForSublayers=async function(a,b,c){const d=this.layer;let e=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");a=a.toArray();!c&&this.sublayerIds&&this.sublayerIds.length&&(a=this.sublayerIds.map(f=>d.findSublayerById(f)).filter(Boolean));
for(const f of a)a=f.watch("renderer, opacity, title, visible, legendEnabled",()=>this._constructLegendElementsForSublayers()),this._handles.add(a,"sublayers-watcher"),f.visible&&f.legendEnabled&&(!this.respectLayerVisibility||this._isSublayerInScale(f))&&(a=f&&null!=f.opacity?f.opacity:null,a=null!=a?a*b:b,f.renderer&&!f.sublayers&&2<f.originIdOf("renderer")?(await f.load(),e=[...await this._getRendererLegendElements(f.renderer,{title:f.title,opacity:a,sublayer:f}),...e]):(a=await this._generateSymbolTableElementForSublayer(f,
a,c))&&e.unshift(a));return e.filter(f=>!!f&&("infos"in f?0<f.infos.length:!0))};h._generateSymbolTableElementForSublayer=async function(a,b,c){if(!c){c=new Map;var d=new ta.ExportImageParameters({layer:this.layer});const e=d.hasDynamicLayers?d.dynamicLayers:null;d.destroy();(await this._getLegendLayers(e||`${this.layer.uid}-${a.id}-default`,e)).forEach(f=>c.set(f.layerId,f))}d=c.get(a.id);return!d&&a.sublayers?(b=await this._generateLegendElementsForSublayers(a.sublayers,b,c),{type:"symbol-table",
title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,b)};h._generateSymbolTableElementForLegendLayer=function(a,b,c){var d;if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var e=null==b?void 0:b.renderer;let f=(null==b?void 0:b.title)||a.layerName;e&&(!b||2<(null==b?void 0:b.originIdOf("renderer")))&&(e=(null==b?void 0:b.title)||this._getRendererTitle(e,b))&&(f&&"string"!==typeof e&&"title"in e&&(e.title=f),f=e);const k={type:"symbol-table",
title:f,legendType:a.legendType?a.legendType:null,infos:[]},g=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;0<(null==(d=a.legendGroups)?void 0:d.length)?a.legendGroups.forEach(l=>{var w;const n={type:"symbol-table",title:l.heading,legendType:a.legendType?a.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(g.filter(m=>m.groupId===l.id),a.layerId,c)};0<(null==(w=n.infos)?void 0:w.length)&&k.infos.push(n)}):k.infos=this._generateSymbolTableElementInfosForLegendLayer(g,
a.layerId,c);return 0<k.infos.length?k:null};h._generateSymbolTableElementInfosForLegendLayer=function(a,b,c){return a.map(d=>{let e=d.url;if(d.imageData&&0<d.imageData.length)e=`data:image/png;base64,${d.imageData}`;else if(0!==e.indexOf("http"))e=ma.addTokenParameter(`${this.layer.url}/${b}/images/${e}`);else return null;return{label:d.label,src:e,opacity:null==c?this.opacity:c,width:d.width,height:d.height}}).filter(d=>!!d)};h._isSublayerInScale=function(a){const b=a.minScale||0;a=a.maxScale||
0;return 0<b&&b<this.scale||a>this.scale?!1:!0};h._isLegendLayerInScale=function(a,b){b=b||this.layer;let c=null,d=null,e=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)e=!1;return e};h._sanitizeLegendForSublayer=function(a,
b){if("version"in this.layer&&10.1>this.layer.version||0===a.length)return a;b=b.renderer;let c=null,d=null;a.some(e=>e.values)&&a.some((e,f)=>{e.values||(c=f,d=e,d.label||(d.label="others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};h._getRendererLegendElements=async function(a,b={}){var c=this.view;c=D(a)||E(a)||N(a)||X(a)||Y(a)?"2d"===c.type||ua.isSupportedRenderer3D(a):
"raster-stretch"===a.type||"raster-colormap"===a.type||"raster-shaded-relief"===a.type||O(a)||P(a)||Q(a)||"vector-field"===a.type;return c?O(a)||P(a)||Q(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass?this._constructPointCloudRendererLegendElements(a,b):Y(a)?this._constructDotDensityRendererLegendElements(a):this._constructRendererLegendElements(a,b):(z.warn(`Renderer of type '${a.type}' not supported!`),[])};h._getPointCloudRendererTitle=function(a){return a.legendOptions&&a.legendOptions.title||
a.field};h._constructPointCloudRendererLegendElements=function(a,b={}){b=b.title;const c=[];let d=null;var e=null;if(O(a))d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(f=>{d.infos.unshift({label:f.label||f.minValue+" - "+f.maxValue,value:[f.minValue,f.maxValue],symbol:this._getAppliedCloneSymbol(K,f.color)})});else if(P(a)){e=a.stops;let f=null;if(e.length&&(1===e.length&&(f=e[0].color),!f)){const k=e[0].value,g=e[e.length-1].value;null!=
k&&null!=g&&(f=I.getColorFromPointCloudStops(k+(g-k)/2,e))}d={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(K,f||K.color)}]};e=I.getRampStopsForPointCloud(a.stops);e={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),infos:e,preview:A.renderColorRampPreviewHTML(e.map(k=>k.color))}}else Q(a)&&(d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos.forEach(f=>{d.infos.push({label:f.label||f.values.join(", "),
value:f.values.join(", "),symbol:this._getAppliedCloneSymbol(K,f.color)})}));d&&d.infos.length&&c.push(d);e&&e.infos.length&&c.push(e);b=c.reduce((f,k)=>f.concat(k.infos),[]).filter(f=>!!f.symbol).map(f=>this._getSymbolPreview(f,this.opacity,{symbolConfig:{applyColorModulation:!!a.colorModulation}}));return B.eachAlways(b).then(()=>c)};h._getElementInfoForDotDensity=function(a,b){const {backgroundColor:c,outline:d,dotSize:e}=a,f=e+"-"+b+"-"+c+"-"+(d&&JSON.stringify(d.toJSON())),k=this._dotDensityUrlCache;
a=k.has(f)?k.get(f):A.renderDotDensityPreviewHTML(a,b);k.set(f,a);return{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}};h._constructDotDensityRendererLegendElements=function(a){const b=a.calculateDotValue(this.view.scale),c={type:"symbol-table",title:{value:b&&Math.round(b),unit:a.legendOptions&&a.legendOptions.unit||""},infos:[]};a.attributes.forEach(d=>{const e=this._getElementInfoForDotDensity(a,d.color);e.label=d.label||d.valueExpressionTitle||d.field;c.infos.push(e)});return Promise.resolve([c])};
h._constructRendererLegendElements=async function(a,b={}){const {title:c,sublayer:d}=b,e=d||this.layer;a=await this._loadRenderer(a);this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const f=await this._getVisualVariableLegendElements(a,e)||[],k={type:"symbol-table",title:c||this._getRendererTitle(a,e),infos:[]};let g=null,l=!1;const w=new Set;if(ya(a)){var n=c,m=za(a)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",r=f.findIndex(p=>"color-ramp"===
p.type);r=f.splice(r,1)[0];var t=f.findIndex(p=>"size-ramp"===p.type);t=f.splice(t,1)[0];var G=[];r&&(n=r.title,G.push(r));t&&(n=t.title,G.push(t));0<G.length&&f.push({type:m,title:n,infos:G})}else if(X(a))n=xa.getHeatmapRampStops(a),f.push({type:"heatmap-ramp",title:c,infos:n,preview:A.renderColorRampPreviewHTML(n.map(p=>p.color))});else if(N(a)){if((m=a&&a.authoringInfo)&&"relationship"===m.type){const {focus:p,numClasses:y,field1:aa,field2:ba}=m;if(y&&aa&&ba){r=[aa,ba];m=W.getRotationAngleForFocus(p)||
0;for(n of r){const {field:Ea,normalizationField:ca,label:Fa}=n;r=Fa||{field:this._getFieldAlias(Ea,e),normField:ca&&this._getFieldAlias(ca,e)};t=Da.clone();t.angle=m;k.infos.push({label:r,symbol:t});w.add(t);m+=90}n=W.getRelationshipRampElement({focus:p,numClasses:y,infos:a.uniqueValueInfos});f.unshift(n)}}else{const p=a.field;a.uniqueValueInfos.forEach(y=>{y.symbol&&k.infos.push({label:y.label||this._getDomainName(p,y.value,e)||y.value,value:y.value,symbol:y.symbol})})}a.defaultSymbol&&(k.infos.push({label:a.defaultLabel||
"others",symbol:a.defaultSymbol}),l=!0)}else if(E(a))g=this._isUnclassedRenderer(a),g&&this._hasSizeRamp||(a.classBreakInfos.forEach(p=>{p.symbol&&k.infos.unshift({label:p.label||(g?null:p.minValue+" - "+p.maxValue),value:[p.minValue,p.maxValue],symbol:p.symbol})}),g&&(k.title=null),this._updateInfosforClassedSizeRenderer(a,k.infos)),a.defaultSymbol&&!g&&(k.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),l=!0);else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===
this.layer.declaredClass&&"Map"===(null==(t=this.layer)?void 0:null==(G=t.raster)?void 0:G.tileType))this._getServerSideLegend();else if("esri.layers.ImageryTileLayer"===this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)n=this._constructTileImageryStretchRendererElements(a),"stretch-ramp"===n.type?f.push(n):k.infos=n;else{n=this.layer;a.statistics&&a.statistics.length?(t=null!=a.statistics[0].min?a.statistics[0].min:a.statistics[0][0],r=null!=a.statistics[0].max?a.statistics[0].max:
a.statistics[0][1]):(t=null==(r=a)?void 0:r.outputMin,r=null==(m=a)?void 0:m.outputMax);m=[];m=H.unwrap(n.renderingRule?await n.generateRasterInfo(n.renderingRule):n.serviceRasterInfo);const p=m.keyProperties.BandProperties;1===m.bandCount?(t=null!=t?t:m.statistics&&m.statistics[0].min,r=null!=r?r:m.statistics&&m.statistics[0].max,t||r?f.push(this._getStretchLegendElements(a,{min:t,max:r})):this._getServerSideLegend()):n.bandIds&&1===n.bandIds.length?(t=null!=t?t:m.statistics&&m.statistics[n.bandIds[0]].min,
r=null!=r?r:m.statistics&&m.statistics[n.bandIds[0]].max,t||r?f.push(this._getStretchLegendElements(a,{min:t,max:r})):this._getServerSideLegend()):3<=m.bandCount?p&&p.length>=m.bandCount?n.bandIds&&3===n.bandIds.length?(m=n.bandIds.map(y=>p[y].BandName),k.infos=this._createSymbolTableElementMultiBand(m)):"lerc"===n.format?(m=[0,1,2].map(y=>p[y].BandName),k.infos=this._createSymbolTableElementMultiBand(m)):this._getServerSideLegend():"lerc"===n.format?(m=["band1","band2","band3"],k.infos=this._createSymbolTableElementMultiBand(m)):
this._getServerSideLegend():this._getServerSideLegend()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(p=>{k.infos.push({label:p.label,value:p.value,symbol:this._getAppliedCloneSymbol(Ca,p.color)})});else if(D(a)){n=a.symbol;switch(b.geometryType){case "point":n="pointSymbol"in e&&e.pointSymbol;break;case "polyline":n="lineSymbol"in e&&e.lineSymbol;break;case "polygon":n="polygonSymbol"in e&&e.polygonSymbol}a.symbol&&!this._hasSizeRamp&&k.infos.push({label:a.label,symbol:n})}else"vector-field"===
a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+")"),k.title=a.attributeField,n=a.getClassBreakInfos(),null!=n&&n.length?n.forEach(p=>{k.infos.push({label:p.minValue+" - "+p.maxValue,symbol:p.symbol})}):k.infos.push({label:a.attributeField,symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&f.push(this._getStretchLegendElements(a,{min:0,max:255}));n=a.defaultSymbol;!n||l||D(a)||g&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||f.push({type:"symbol-table",infos:[{label:a.defaultLabel||
"others",symbol:n}]});k.infos.length&&f.unshift(k);const Ga=null==b.opacity?this.opacity:b.opacity,Ha=this._isTallSymbol("visualVariables"in a&&a.visualVariables),Ia="esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass;b=f.reduce((p,y)=>p.concat(this._getAllInfos(y)),[]).filter(p=>!(!p||!p.symbol)).map(p=>this._getSymbolPreview(p,Ga,{applyScaleDrivenSize:!w.has(p.symbol),symbolConfig:{isTall:Ha,isSquareFill:Ia}}));a=null;await B.eachAlways(b);
return f};h._getServerSideLegend=function(){setTimeout(()=>this.buildLegendElementsForTools(),0)};h._getAllInfos=function(a){const b=null==a?void 0:a.infos;return b?b.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[a]};h._constructTileImageryStretchRendererElements=function(a){function b(w){var n;const m=(null!=e&&null!=(n=e.bandIds)&&n.length?e.bandIds:Array.from(Array(Math.min(f.bandCount,3)).keys())).map(r=>w&&w[r]&&w[r].BandName||"band"+(r+1));3>m.length?m.push(m[1]):3<m.length&&m.splice(3);
return m}var c,d;const e=this.layer,f=e.rasterInfo,k=f.bandCount||a.statistics.length;var g,l=[];l=f.keyProperties&&f.keyProperties.BandProperties;(g=null!=a&&null!=(c=a.statistics)&&c.length?a.statistics:null==f?void 0:f.statistics)?(c=void 0!==g[0].min?g[0].min:g[0][0],g=g[0].max||g[0][1]):(g=Ba[e.rasterInfo.pixelType.toLowerCase()],c=g[0],g=g[1]);if(1===f.bandCount||1===(null==(d=e.bandIds)?void 0:d.length))return this._getStretchLegendElements(a,{min:c,max:g});l=l&&l.length>=k?b(l):b();return this._createSymbolTableElementMultiBand(l)};
h._getStretchLegendElements=function(a,b){a=I.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:A.renderColorRampPreviewHTML(a.map(c=>c.color))}};h._createSymbolTableElementMultiBand=function(a){const b=[],c=["red","green","blue"];a.forEach((d,e)=>{b.push({label:{colorName:c[e],bandName:d},src:wa.RGB_IMG_SOURCE[e],opacity:1})});return b};h._updateInfosforClassedSizeRenderer=function(a,b){const c=a.authoringInfo&&"class-breaks-size"===a.authoringInfo.type,d=a.classBreakInfos.some(e=>
ra.isVolumetricSymbol(e.symbol));if(c&&d){const e=M.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;const f=(e-M.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach((k,g)=>{k.size=e-f*g})}};h._isTallSymbol=function(a){let b=!1,c=!1;if(a)for(let d=0;d<a.length&&(!b||!c);d++){const e=a[d];"size"===e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c};h._getSymbolPreview=async function(a,b,c){var d=null==a.size&&this._hasSizeRamp?la.px2pt(22):a.size;this._scaleDrivenSizeVariable&&
null!=c&&c.applyScaleDrivenSize&&({getSize:d}=await new Promise(function(e,f){R(["../../../renderers/visualVariables/support/visualVariableUtils"],e,f)}),d=d(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}));return A.renderPreviewHTML(a.symbol,{size:d,opacity:b,scale:!1,symbolConfig:null==c?void 0:c.symbolConfig}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})};h._loadRenderer=async function(a){var b,
c;const d=[];var e=this.layer;a=a.clone();this._hasClusterSizeVariable=!1;const f="visualVariables"in a&&(null==(b=a.visualVariables)?void 0:b.some(g=>"size"===g.type&&"outline"!==g.target&&!J.test(g.valueExpression)));if(a&&"visualVariables"in a&&!f&&"featureReduction"in e&&"cluster"===(null==(c=e.featureReduction)?void 0:c.type)&&(b=H.unwrap(va.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view)))){e=e.featureReduction;if("clusterMinSize"in e&&"clusterMaxSize"in e){const {clusterMinSize:g,
clusterMaxSize:l}=e;b.legendOptions=new pa({showLegend:g!==l})}a.visualVariables=(a.visualVariables||[]).concat([b]);this._hasClusterSizeVariable=!0}const k=await this._getMedianColor(a);if(E(a)||N(a))e=(a.classBreakInfos||a.uniqueValueInfos).map(g=>this._fetchSymbol(g.symbol,k).then(l=>{g.symbol=l}).catch(()=>{g.symbol=null})),Array.prototype.push.apply(d,e);d.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:k).then(g=>{this._applySymbolToRenderer(a,g,D(a))}).catch(()=>{this._applySymbolToRenderer(a,
null,D(a))}));return B.eachAlways(d).then(()=>a)};h._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};h._getMedianColor=async function(a){if(!("visualVariables"in a&&a.visualVariables))return null;a=a.visualVariables.find(d=>"color"===d.type);if(!a)return null;var b=null,c=null;if(a.stops){if(1===a.stops.length)return a.stops[0].color;b=a.stops[0].value;c=a.stops[a.stops.length-1].value}b+=(c-b)/2;({getColor:c}=await new Promise(function(d,e){R(["../../../renderers/visualVariables/support/visualVariableUtils"],
d,e)}));return c(a,b)};h._fetchSymbol=function(a,b){if(!a)return Promise.reject();if("web-style"===a.type){var c=a.portal;c=a.name+"-"+a.styleName+"-"+a.styleUrl+"-"+(c&&c.url)+"-"+(c&&c.user&&c.user.username);const d=this._webStyleSymbolCache;d.has(c)||("2d"===this.view.type?d.set(c,a.fetchCIMSymbol()):d.set(c,a.fetchSymbol()));return d.get(c).then(e=>this._getAppliedCloneSymbol(e,b)).catch(()=>{z.warn("Fetching web-style failed!");return Promise.reject()})}return Promise.resolve(this._getAppliedCloneSymbol(a,
b))};h._getAppliedCloneSymbol=function(a,b){if(!a||!b)return a;a=a.clone();const c=b&&b.toRgba();-1<a.type.indexOf("3d")?this._applyColorTo3dSymbol(a,c):"cim"===a.type?qa.applyCIMSymbolColor(a,b):a.color&&(a.color=new T(c||a.color));return a};h._applyColorTo3dSymbol=function(a,b){b&&a.symbolLayers.forEach(c=>{c&&(c.material||(c.material={}),c.material.color=new T(b))})};h._getVisualVariableLegendElements=async function(a,b){if(!("visualVariables"in a&&a.visualVariables)||"vector-field"===a.type)return null;
var c=a.visualVariables,d=[];const e=[],f=[];for(const l of c)"color"===l.type?d.push(l):"size"===l.type?e.push(l):"opacity"===l.type&&f.push(l);c=[...d,...e,...f];let k;if(0===d.length&&E(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var g=(g=a.classBreakInfos[0])&&g.symbol;0===d.length&&D(a)&&(g=a.symbol);g&&(-1<g.type.indexOf("3d")?(d=g.symbolLayers.getItemAt(0),"water"===d.type?H.isSome(d.color)&&(k=d.color):H.isSome(d.material)&&H.isSome(d.material.color)&&(k=d.material.color)):g.url||
(k=g.color));return(await Promise.all(c.map(async l=>{if(!l.legendOptions||!1!==l.legendOptions.showLegend){const n=this._getRampTitle(l,b);let m=null;var w="getField"in b&&b.getField&&b.getField(l.field);w=w&&ka.isDateField(w);"color"===l.type?(l=await I.getRampStops(l,null,w),m={type:"color-ramp",title:n,infos:l,preview:A.renderColorRampPreviewHTML(l.map(r=>r.color))},this._hasColorRamp||(this._hasColorRamp=!(null==m.infos||!m.infos.length))):"size"===l.type&&"outline"!==l.target?J.test(l.valueExpression)?
this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=l):(m={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(l):n,infos:await M.getRampStops(a,l,await this._getMedianColor(a),this.scale,this.view.type,w)},this._hasSizeRamp||(this._hasSizeRamp=!(null==m.infos||!m.infos.length))):"opacity"===l.type&&(l=await I.getRampStops(l,k,w),m={type:"opacity-ramp",title:n,infos:l,preview:A.renderColorRampPreviewHTML(l.map(r=>r.color))},this._hasOpacityRamp||(this._hasOpacityRamp=
!(null==m.infos||!m.infos.length)));return m&&m.infos?m:null}}))).filter(l=>!!l)};h._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField&&c.getField(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null)&&"coded-value"===c.type?c.getName(b):null:null};h._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in
b&&b.popupTemplate)&&b.fieldInfos))for(const c of b)if(c.fieldName===a)return"cluster_count"===a?c.label||{showCount:!0}:c.label;return{showCount:!0}};h._getRampTitle=function(a,b){let c=a.field,d=a.normalizationField,e=!1,f=!1,k=!1;var g=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;g=a.legendOptions&&a.legendOptions.title;if(null==g)if(a.valueExpressionTitle)g=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&
b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,g=0;g<a.length;g++){const l=a[g];if("color"===l.type){if("ratio"===l.style){e=!0;break}if("percent"===l.style){f=!0;break}if("percent-of-total"===l.style){k=!0;break}}}g={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:k}}return g};h._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;
let c=a.field,d=null,e=null;E(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?null:d;a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a};h._getFieldAlias=function(a,b){var c="popupTemplate"in b&&b.popupTemplate;c=c&&c.fieldInfos;let d=null;c&&c.some(f=>a===f.fieldName?(d=f,!0):!1);c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in b&&b.fieldsIndex&&
(c=b.fieldsIndex.get(a));b=d||c;let e=null;b&&(e=d&&d.label||c&&c.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName);return e};h._isUnclassedRenderer=function(a){const b=a.visualVariables;let c=!1;E(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(d=>!(!d||a.field!==d.field||(a.normalizationField||d.normalizationField)&&a.normalizationField!==d.normalizationField)):!!b.length);return c};S._createClass(L,[{key:"opacity",get:function(){var a;const b=this.layer.opacity,
c=null==(a=this.parent)?void 0:a.opacity;a=(a=this.layer.parent)&&"uid"in a?this._getParentLayerOpacity(a):null;return null!=c?c*b:null!=a?a*b:b}},{key:"ready",get:function(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length}},{key:"scale",get:function(){return this.view&&this.view.scale}},{key:"isScaleDriven",get:function(){var a=this.layer;if(null===a)return!1;if("featureReduction"in a&&a.featureReduction&&"cluster"===a.featureReduction.type)return!0;
if("renderer"in a&&a.renderer){if("dot-density"===a.renderer.type)return!0;const b=a.get("renderer.valueExpression");if(J.test(b))return!0;if(a=a.get("renderer.visualVariables"))return a.some(c=>this._isScaleDrivenSizeVariable(c))}return this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]);return L}(ia);v.__decorate([x.property()],u.prototype,"children",void 0);v.__decorate([x.property()],u.prototype,"layerView",void 0);v.__decorate([x.property()],
u.prototype,"layer",void 0);v.__decorate([x.property()],u.prototype,"legendElements",void 0);v.__decorate([x.property({readOnly:!0})],u.prototype,"opacity",null);v.__decorate([x.property()],u.prototype,"parent",void 0);v.__decorate([x.property({readOnly:!0,dependsOn:[]})],u.prototype,"ready",null);v.__decorate([x.property()],u.prototype,"keepCacheOnDestroy",void 0);v.__decorate([x.property()],u.prototype,"respectLayerVisibility",void 0);v.__decorate([x.property({readOnly:!0})],u.prototype,"scale",
null);v.__decorate([x.property()],u.prototype,"sublayerIds",void 0);v.__decorate([x.property({readOnly:!0})],u.prototype,"isScaleDriven",null);v.__decorate([x.property()],u.prototype,"title",void 0);v.__decorate([x.property({readOnly:!0,dependsOn:["ready"],value:0})],u.prototype,"version",null);v.__decorate([x.property()],u.prototype,"view",void 0);return u=v.__decorate([fa.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],u)});