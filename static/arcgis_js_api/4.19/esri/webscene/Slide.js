// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/accessorSupport/decorators/cast ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../core/JSONSupport ../core/Collection ../core/collectionUtils ../core/asyncUtils ../Basemap ../chunks/vec3f64 ../chunks/vec3 ../views/3d/support/mathUtils ../support/basemapUtils ../layers/Layer ../Viewpoint ../webdoc/support/Thumbnail ./Lighting ../layers/mixins/OperationalLayer ../views/support/Scheduler ./support/Description ./support/SlideEnvironment ./support/SlideGround ./support/SlideVisibleLayer ./support/Title".split(" "),
function(D,g,f,y,P,z,m,r,fa,Q,ha,ia,ja,w,R,E,S,T,U,A,F,V,G,W,X,q,Y,Z,aa,x,H,I,J,t){function K(d){if("building-scene"===d.type||"map-image"===d.type)return d.allSublayers.toArray()}function L(d){if(d=K(d))return d.filter(l=>l.visible).map(l=>l.id)}function ba(d,l){d=l-d;43200<d&&(d-=86400);-43200>d&&(d+=86400);return d}let ca=0;const B=E.ofType(J["default"]),da=P.getLogger("esri.webscene.Slide");f=function(d){function l(a){a=d.call(this,a)||this;a.id=Date.now().toString(16)+"-slide-"+ca++;a.title=
new t;a.description=new x;a.thumbnail=new q;a.viewpoint=null;a.basemap=null;a.ground=null;a.environment=new H.SlideEnvironment;a.visibleLayers=new B;return a}D._inheritsLoose(l,d);var e=l.prototype;e.destroy=function(){this.visibleLayers.removeAll();this.basemap=null;this.thumbnail&&this.thumbnail.destroy();this.thumbnail=this.title=this.description=null};e.castTitle=function(a){return"string"===typeof a?new t({text:a}):z.ensureType(t,a)};e.castDescription=function(a){return"string"===typeof a?new x({text:a}):
z.ensureType(x,a)};e.castThumbnail=function(a){return"string"===typeof a?new q({url:a}):z.ensureType(q,a)};e.castBasemap=function(a){return G.ensureType(a)};e.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(b=>{if("string"===typeof b)return{id:b};if(b instanceof W){const c=L(b);return{id:b.id,sublayerIds:c}}if(b.id)return{id:b.id,sublayerIds:b.sublayerIds};da.warn('Invalid visible layer, expected { id }, Layer or "id"');return b}):null};e.clone=function(){return new this.constructor({id:this.id,
title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};e._updateVisibleLayersFrom=function(a){const b=[];return w.eachAlways(this._getLayers(a.map).map(c=>a.whenLayerView(c).then(k=>
{if(k.visible){const h=L(c);b.push(new J["default"]({id:k.layer.id,sublayerIds:h}))}})).toArray()).then(()=>{this.visibleLayers.removeAll();this.visibleLayers.addMany(b)})};e.updateFrom=function(a,b){b={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...b&&b.screenshot}};return a.when(()=>{this.viewpoint=a.viewpoint.clone();this.environment.lighting=Y.prototype.clone.apply(a.environment.lighting);this.basemap=a.map.basemap&&a.map.basemap.clone()||null;this.ground=a.map.ground?
I.fromGround(a.map.ground):null;return this._updateVisibleLayersFrom(a)}).then(()=>a.takeScreenshot(b.screenshot)).then(c=>{this.thumbnail=new q({url:c.dataUrl});return this})};e.applyTo=async function(a,b){y.isSome(this._applyToController)&&this._applyToController.abort();let c=w.createAbortController();this._applyToController=c;const k=w.onAbortOrThrow(b,()=>c.abort()),h=a.resourceController.scheduler.registerTask(aa.Task.SLIDE,u=>h.processQueue(u),()=>!1),n={animate:!0,...b,signal:this._applyToController.signal};
b=await T.result(a.addUpdatingPromise((async()=>{await h.schedule(()=>this._applyBasemap(a,n),n.signal);h.schedule(()=>this._applyLayerVisibility(a),n.signal);h.schedule(()=>this._applyGround(a),n.signal);await h.schedule(()=>this._applyViewpoint(a,n),n.signal)})()));h.remove();this._applyToController===c&&(this._applyToController=null);c=null;null==k?void 0:k.remove();if(!1===b.ok)throw b.error;return this};e._applyBasemap=async function(a,b){if(this.basemap){try{await this.basemap.load(b)}catch(c){if(w.isAbortError(c))throw c;
}a.map.basemap=G.clonePreservingTiledLayers(this.basemap,a.map.basemap)}};e._applyGround=function(a){this.ground&&(a.map.ground=this.ground.cloneAndApplyTo(a.map.ground))};e._getLayers=function(a){const b=new E;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};e._collectLayers=function(a,b){a.layers.forEach(c=>{Z.isOperationalLayer(c)&&(b.add(c),c.layers&&this._collectLayers(c,b))})};e._applyLayerVisibility=function(a){this.visibleLayers&&this._getLayers(a.map).forEach(b=>{var c=
this.visibleLayers.find(h=>h.id===b.id);b.visible=null!=c;const k=c&&c.sublayerIds;c=K(b);k&&c&&c.forEach(h=>h.visible=0<=k.indexOf(h.id))})};e._applyViewpoint=async function(a,b){if(this.viewpoint&&!b.ignoreViewpoint){y.isSome(this.viewpoint.camera)&&(this.viewpoint.camera.fov=a.camera.fov);if(b.animate&&this.get("environment.lighting.date")){await this._animateToLighting(a,b);return}b.animate&&(a.environment.applyLighting(this.environment.lighting.clone()),await a.goTo(this.viewpoint,b));a.viewpoint=
this.viewpoint}a.environment.applyLighting(this.environment.lighting.clone())};e._animateToLighting=async function(a,b){let c=null;"global"===a.viewingMode&&(c=this._animateLightingWithCamera(a));a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);return a.goTo(this.viewpoint,b).then(()=>
{a.environment.applyLighting(this.environment.lighting.clone());c&&c.remove();a.environment.lighting.cameraTrackingEnabled=!0},k=>{c&&c.remove();a.environment.lighting.cameraTrackingEnabled=!0;throw k;})};e._getTime=function(a){const b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};e._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};e._animateLightingWithCamera=function(a){const [b,c]=
this._getTime(new Date(a.environment.lighting.date.toString())),[k,h]=this._getTime(this.environment.lighting.date),n=ba(c,h),u=a.renderCoordsHelper,M=A.create();u.toRenderCoords(a.camera.position,M);const N=A.create(),C=A.create();y.isSome(this.viewpoint.camera)&&u.toRenderCoords(this.viewpoint.camera.position,N);const ea=new Date;return a.watch("camera",p=>{u.toRenderCoords(p.position,C);var v=F.squaredDistance(M,C);const O=F.squaredDistance(N,C);p=0;0!==v+O&&(p=v/(v+O));v=b+(k-b)*p;p=V.moduloPositive(c+
n*p,86400);a.environment.lighting.date=this._setTime(ea,v,p)})};l.createFrom=function(a,b){return(new this).updateFrom(a,b)};D._createClass(l,[{key:"visibleLayers",set:function(a){this._set("visibleLayers",S.referenceSetter(a,this._get("visibleLayers"),B))}}]);return l}(R.JSONSupport);g.__decorate([m.property({type:String,json:{write:{isRequired:!0}}})],f.prototype,"id",void 0);g.__decorate([m.property({type:t,json:{default:()=>new t({text:""}),write:{isRequired:!0}}})],f.prototype,"title",void 0);
g.__decorate([r.cast("title")],f.prototype,"castTitle",null);g.__decorate([m.property({type:x,json:{write:{overridePolicy(d){return{enabled:!(!d||!d.text)}}}}})],f.prototype,"description",void 0);g.__decorate([r.cast("description")],f.prototype,"castDescription",null);g.__decorate([m.property({type:q,json:{default:()=>new q({url:""}),write:{isRequired:!0}}})],f.prototype,"thumbnail",void 0);g.__decorate([r.cast("thumbnail")],f.prototype,"castThumbnail",null);g.__decorate([m.property({type:X,nonNullable:!0,
json:{write:{isRequired:!0}}})],f.prototype,"viewpoint",void 0);g.__decorate([m.property({type:U,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],f.prototype,"basemap",void 0);g.__decorate([r.cast("basemap")],f.prototype,"castBasemap",null);g.__decorate([m.property({type:I,json:{write:!0}})],f.prototype,"ground",void 0);g.__decorate([m.property({type:B,json:{write:{isRequired:!0}}})],f.prototype,"visibleLayers",null);g.__decorate([r.cast("visibleLayers")],f.prototype,"castVisibleLayers",
null);g.__decorate([m.property({type:H.SlideEnvironment,json:{write:!0}})],f.prototype,"environment",void 0);return f=g.__decorate([Q.subclass("esri.webscene.Slide")],f)});