// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/lang ../core/object ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/accessorSupport/decorators/cast ../core/accessorSupport/decorators/enumeration ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../chunks/persistableUrlUtils ../support/arcadeOnDemand ../layers/support/fieldUtils ../portal/Portal ../symbols/WebStyleSymbol ../symbols ./support/LegendOptions ./Renderer ./mixins/VisualVariablesMixin ./support/commonProperties ../core/accessorSupport/diffUtils ./support/UniqueValueInfo ../symbols/support/styleUtils".split(" "),
function(x,f,e,q,F,n,G,y,h,H,I,z,J,A,K,U,V,W,B,C,u,w,L,M,N,O,P,D,Q,v,R){var t;const p=G.getLogger("esri.renderers.UniqueValueRenderer"),S=y.ensureType(v);e=t=function(E){function r(a){a=E.call(this,a)||this;a._valueInfoMap={};a._isDefaultSymbolDerived=!1;a.type="unique-value";a.backgroundFillSymbol=null;a.field=null;a.field2=null;a.field3=null;a.valueExpression=null;a.valueExpressionTitle=null;a.legendOptions=null;a.defaultLabel=null;a.fieldDelimiter=null;a.portal=null;a.styleOrigin=null;a.diff={uniqueValueInfos(b,
c){if(b||c){if(!b||!c)return{type:"complete",oldValue:b,newValue:c};var d=!1,k={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let l=0;l<c.length;l++){const m=b.find(T=>T.value===c[l].value);m?Q.diff(m,c[l])?(k.changed.push({type:"complete",oldValue:m,newValue:c[l]}),d=!0):k.unchanged.push({oldValue:m,newValue:c[l]}):(k.added.push(c[l]),d=!0)}for(let l=0;l<b.length;l++)c.find(m=>m.value===b[l].value)||(k.removed.push(b[l]),d=!0);return d?k:void 0}}};a._set("uniqueValueInfos",[]);
return a}x._inheritsLoose(r,E);var g=r.prototype;g.castField=function(a){return null==a||"function"===typeof a?a:y.ensureString(a)};g.writeField=function(a,b,c,d){"string"===typeof a?b[c]=a:d&&d.messages?d.messages.push(new K("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):p.error(".field: cannot write field to JSON since it's not a string value")};g.readPortal=function(a,b,c){return c.portal||w.getDefault()};g.readStyleOrigin=function(a,b,c){if(b.styleName)return Object.freeze({styleName:b.styleName});
if(b.styleUrl)return a=B.fromJSON(b.styleUrl,c),Object.freeze({styleUrl:a})};g.writeStyleOrigin=function(a,b,c,d){a.styleName?b.styleName=a.styleName:a.styleUrl&&(b.styleUrl=B.toJSON(a.styleUrl,d))};g.addUniqueValueInfo=function(a,b){this.styleOrigin?p.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(a="object"===typeof a?S(a):new v({value:a,symbol:M.ensureType(b)}),this.uniqueValueInfos.push(a),this._valueInfoMap[a.value]=a)};g.removeUniqueValueInfo=
function(a){if(this.styleOrigin)p.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let b=0;b<this.uniqueValueInfos.length;b++)if(this.uniqueValueInfos[b].value===a+""){delete this._valueInfoMap[a];this.uniqueValueInfos.splice(b,1);break}};g.getUniqueValueInfo=async function(a,b){let c=b;this.valueExpression&&(n.isNone(b)||n.isNone(b.arcade))&&(c={...c,arcade:await C.loadArcade()});return this._getUniqueValueInfo(a,c)};
g.getSymbol=function(a,b){if(this.valueExpression&&(n.isNone(b)||n.isNone(b.arcade)))p.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");else return(a=this._getUniqueValueInfo(a,b))&&a.symbol||this.defaultSymbol};g.getSymbolAsync=async function(a,b){if(this.valueExpression&&(n.isNone(b)||n.isNone(b.arcade))){const c=await C.loadArcade(),{arcadeUtils:d}=c;d.hasGeometryOperations(this.valueExpression)&&await d.enableGeometryOperations();b={...b,arcade:c}}return(a=this._getUniqueValueInfo(a,
b))&&a.symbol||this.defaultSymbol};g.getSymbols=function(){const a=[];for(const b of this.uniqueValueInfos)b.symbol&&a.push(b.symbol);this.defaultSymbol&&a.push(this.defaultSymbol);return a};g.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((a,b)=>a+b.getAttributeHash(),"")};g.getMeshHash=function(){const a=JSON.stringify(this.backgroundFillSymbol),b=JSON.stringify(this.defaultSymbol),c=this.uniqueValueInfos.reduce((d,k)=>d+k.getMeshHash(),"");return`${a}.${b}.${c}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`};
g.clone=function(){const a=new t({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:q.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:q.clone(this.visualVariables),legendOptions:q.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:q.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&
(a._isDefaultSymbolDerived=!0);a._set("portal",this.portal);const b=q.clone(this.uniqueValueInfos);this.styleOrigin&&(a._set("styleOrigin",Object.freeze(q.clone(this.styleOrigin))),Object.freeze(b));a._set("uniqueValueInfos",b);a._updateValueInfoMap();return a};g.collectRequiredFields=async function(a,b){a=[this.collectVVRequiredFields(a,b),this.collectSymbolFields(a,b)];await Promise.all(a)};g.collectSymbolFields=async function(a,b){const c=[...this.getSymbols().map(d=>d.collectRequiredFields(a,
b)),u.collectArcadeFieldNames(a,b,this.valueExpression)];u.collectField(a,b,this.field);u.collectField(a,b,this.field2);u.collectField(a,b,this.field3);await Promise.all(c)};g.populateFromStyle=function(){return R.fetchStyle(this.styleOrigin,{portal:this.portal}).then(a=>{const b=[];this._valueInfoMap={};a&&a.data&&Array.isArray(a.data.items)&&a.data.items.forEach(c=>{var d=new L({styleUrl:a.styleUrl,styleName:a.styleName,portal:this.portal,name:c.name});this.defaultSymbol||c.name!==a.data.defaultItem||
(this.defaultSymbol=d,this._isDefaultSymbolDerived=!0);d=new v({value:c.name,symbol:d});b.push(d);this._valueInfoMap[c.name]=d});this._set("uniqueValueInfos",Object.freeze(b));!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0);return this})};g._updateValueInfoMap=function(){this._valueInfoMap={};this.uniqueValueInfos.forEach(a=>this._valueInfoMap[a.value+""]=a)};g._getUniqueValueInfo=function(a,b){return this.valueExpression?
this._getUnqiueValueInfoForExpression(a,b):this._getUnqiueValueInfoForFields(a)};g._getUnqiueValueInfoForExpression=function(a,b){const {viewingMode:c,scale:d,spatialReference:k,arcade:l}=n.unwrapOr(b,{});var m=this._cache.compiledFunc;b=n.unwrap(l).arcadeUtils;m||(m=b.createSyntaxTree(this.valueExpression),m=b.createFunction(m),this._cache.compiledFunc=m);a=b.executeFunction(m,b.createExecContext(a,b.getViewInfo({viewingMode:c,scale:d,spatialReference:k})));return this._valueInfoMap[a+""]};g._getUnqiueValueInfoForFields=
function(a){const b=this.field,c=a.attributes;if("function"!==typeof b&&this.field2){a=this.field2;var d=this.field3;const k=[];b&&k.push(c[b]);a&&k.push(c[a]);d&&k.push(c[d]);d=k.join(this.fieldDelimiter||"")}else"function"===typeof b?d=b(a):b&&(d=c[b]);return this._valueInfoMap[d+""]};r.fromPortalStyle=function(a,b){const c=new t(b&&b.properties);c._set("styleOrigin",Object.freeze({styleName:a}));c._set("portal",b&&b.portal||w.getDefault());b=c.populateFromStyle();b.catch(d=>{p.error(`#fromPortalStyle('${a}'[, ...])`,
"Failed to create unique value renderer from style name",d)});return b};r.fromStyleUrl=function(a,b){b=new t(b&&b.properties);b._set("styleOrigin",Object.freeze({styleUrl:a}));b=b.populateFromStyle();b.catch(c=>{p.error(`#fromStyleUrl('${a}'[, ...])`,"Failed to create unique value renderer from style URL",c)});return b};x._createClass(r,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"defaultSymbol",set:function(a){this._isDefaultSymbolDerived=!1;this._set("defaultSymbol",a)}},{key:"uniqueValueInfos",
set:function(a){this.styleOrigin?p.error("#uniqueValueInfos\x3d","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",a),this._updateValueInfoMap())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}}]);return r}(P.VisualVariablesMixin(O));f.__decorate([h.property({readOnly:!0})],e.prototype,"_cache",null);f.__decorate([I.enumeration({uniqueValue:"unique-value"})],e.prototype,"type",
void 0);f.__decorate([h.property(D.rendererBackgroundFillSymbolProperty)],e.prototype,"backgroundFillSymbol",void 0);f.__decorate([h.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],e.prototype,"field",void 0);f.__decorate([H.cast("field")],e.prototype,"castField",null);f.__decorate([A.writer("field")],e.prototype,"writeField",null);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"field2",void 0);f.__decorate([h.property({type:String,json:{write:!0}})],
e.prototype,"field3",void 0);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"valueExpression",void 0);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"valueExpressionTitle",void 0);f.__decorate([h.property({type:N["default"],json:{write:!0}})],e.prototype,"legendOptions",void 0);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"defaultLabel",void 0);f.__decorate([h.property(F.deepMerge({...D.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},
origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],e.prototype,"defaultSymbol",null);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"fieldDelimiter",void 0);f.__decorate([h.property({type:w,readOnly:!0})],e.prototype,"portal",void 0);f.__decorate([z.reader("portal",["styleName"])],e.prototype,"readPortal",null);f.__decorate([h.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],e.prototype,"styleOrigin",
void 0);f.__decorate([z.reader("styleOrigin",["styleName","styleUrl"])],e.prototype,"readStyleOrigin",null);f.__decorate([A.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],e.prototype,"writeStyleOrigin",null);f.__decorate([h.property({type:[v],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],e.prototype,"uniqueValueInfos",null);return e=t=f.__decorate([J.subclass("esri.renderers.UniqueValueRenderer")],e)});