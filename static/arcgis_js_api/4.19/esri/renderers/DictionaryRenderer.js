// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/lang ../core/maybe ../core/string ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../support/arcadeOnDemand ../layers/support/fieldUtils ../Color ../symbols/CIMSymbol ../request ./Renderer ./mixins/VisualVariablesMixin ../core/LRUCache".split(" "),
function(x,n,m,u,q,C,D,O,r,P,E,y,F,Q,R,S,G,z,H,I,J,A,K,L,M){var w;const B=D.getLogger("esri.renderers.DictionaryRenderer"),N={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};m=w=function(t){function v(a){a=t.call(this,a)||this;a._ongoingRequests=new Map;a._symbolCache=new M(100);a.config=null;a.fieldMap=null;a.scaleExpression=null;a.scaleExpressionTitle=null;a.url=null;a.type="dictionary";return a}x._inheritsLoose(v,
t);var k=v.prototype;k.writeData=function(a,c){a&&(c.scalingExpressionInfo={expression:a,returnType:"number"})};k.writeVisualVariables=function(a,c,b,d){null!=d&&d.origin||t.prototype.writeVisualVariables.call(this,a,c,b,d)};k.clone=function(){return new w({config:u.clone(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:u.clone(this.fieldMap),url:u.clone(this.url),visualVariables:u.clone(this.visualVariables)})};k.getSymbolAsync=async function(a,
c){this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(c));try{var b=await this._dictionaryPromise}catch(h){if(G.isAbortError(h))return this._dictionaryPromise=null}var d={};if(this.fieldMap)for(var g of this._symbolFields){var f=this.fieldMap[g];d[g]=f&&null!==a.attributes[f]&&void 0!==a.attributes[f]?""+a.attributes[f]:""}b=b(d,c);if(!b||"string"!==typeof b)return null;const l=C.numericHash(b).toString();if(d=this._symbolCache.get(l))return d.catch(()=>{this._symbolCache.pop(l)}),
d;g=b.split(";");b=[];d=[];for(const h of g)if(h&&0!==h.length)if(-1!==h.indexOf("po:")){var e=h.substr(3).split("|");3===e.length&&(g=e[0],f=e[1],e=e[2],"DashTemplate"===f?e=e.split(" ").map(p=>Number(p)):"Color"===f?(e=(new I(e)).toRgba(),e=[e[0],e[1],e[2],255*e[3]]):e=Number(e),d.push({primitiveName:g,propertyName:f,value:e}))}else if(-1!==h.indexOf("|"))for(const p of h.split("|"))this._itemNames.has(p)&&b.push(p);else this._itemNames.has(h)&&b.push(h);a=q.isSome(a.geometry)&&(a.geometry.hasZ||
"point"!==a.geometry.type)?!1:!0;c=this._cimPartsToCIMSymbol(b,d,a,c);this._symbolCache.put(l,c,1);return c};k.collectRequiredFields=async function(a,c){await this.collectVVRequiredFields(a,c);this.scaleExpression&&await H.collectArcadeFieldNames(a,c,this.scaleExpression);c=c.map(b=>b.name);for(const b in this.fieldMap)0>c.indexOf(this.fieldMap[b])||a.add(this.fieldMap[b])};k.fetchResources=async function(a){if(this._dictionaryPromise)return this._dictionaryPromise;if(this.url){var c=q.isSome(a)?
a.abortOptions:null;c=A(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},...c});var [{data:b}]=await Promise.all([c,z.loadArcade()]);if(!b)throw this._dictionaryPromise=null,new F("esri.renderers.DictionaryRenderer","Bad dictionary data!");c=b.expression;var d=b.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+b.cimRefTemplateUrl;this._itemNames=new Set(b.itemsNames);this._symbolFields=d.symbol;b={};if(this.config){const l=this.config;for(var g in l)b[g]=
l[g]}if(d.configuration)for(var f of d.configuration)b.hasOwnProperty(f.name)||(b[f.name]=f.value);g=[];if(q.isSome(a)&&a.fields&&this.fieldMap)for(const l of this._symbolFields){const e=this.fieldMap[l];f=a.fields.filter(h=>h.name===e);0<f.length&&g.push({...f[0],name:l})}return this._dictionaryPromise=z.createDictionaryExpression(c,q.isSome(a)?a.spatialReference:null,g,b).then(l=>{const e={scale:0};return(h,p)=>{h=l.repurposeFeature({geometry:null,attributes:h});e.scale=q.isSome(p)?p.scale:void 0;
return l.evaluate({$feature:h,$view:e})}}).catch(l=>{B.error("Creating dictinoary expression failed:",l);return null})}B.error("no valid URL!")};k.getSymbol=function(){return null};k.getSymbols=function(){return[]};k.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((a,c)=>a+c.getAttributeHash(),"")};k.getMeshHash=function(){return`${this.url}-${JSON.stringify(this.fieldMap)}`};k.getSymbolFields=function(){return this._symbolFields};k._getSymbolPart=async function(a,
c){if(this._ongoingRequests.has(a))return this._ongoingRequests.get(a).then(d=>d.data);const b=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);c=A(b,{responseType:"json",query:{f:"json"},...c});this._ongoingRequests.set(a,c);try{return(await c).data}catch(d){return this._ongoingRequests.delete(a),Promise.reject(d)}};k._combineSymbolParts=function(a,c,b){if(!a||0===a.length)return null;const d={...a[0]};if(1<a.length){d.symbolLayers=[];for(const g of a)d.symbolLayers.unshift(...g.symbolLayers)}b&&
(d.callout=N);return{type:"CIMSymbolReference",symbol:d,primitiveOverrides:c}};k._cimPartsToCIMSymbol=async function(a,c,b,d){const g=Array(a.length);for(let f=0;f<a.length;f++)g[f]=this._getSymbolPart(a[f],d);a=await Promise.all(g);return new J({data:this._combineSymbolParts(a,c,b)})};x._createClass(v,[{key:"arcadeRequired",get:function(){return!0}}]);return v}(L.VisualVariablesMixin(K));n.__decorate([r.property({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],
m.prototype,"config",void 0);n.__decorate([r.property({type:Object,json:{write:!0}})],m.prototype,"fieldMap",void 0);n.__decorate([r.property({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],m.prototype,"scaleExpression",void 0);n.__decorate([y.writer("scaleExpression")],m.prototype,"writeData",null);n.__decorate([r.property({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&
!!this.scaleExpression}}}}})],m.prototype,"scaleExpressionTitle",void 0);n.__decorate([r.property({type:String,json:{write:!0}})],m.prototype,"url",void 0);n.__decorate([y.writer("visualVariables")],m.prototype,"writeVisualVariables",null);return m=w=n.__decorate([E.subclass("esri.renderers.DictionaryRenderer")],m)});