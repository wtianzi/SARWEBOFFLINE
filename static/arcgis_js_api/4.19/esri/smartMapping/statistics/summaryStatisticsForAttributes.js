// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define(["../../core/maybe","../../core/Error","../support/utils","./support/utils","../support/adapters/support/layerUtils"],function(u,q,v,w,t){async function x(a){if(!(a&&a.layer&&a.attributes))throw new q("summary-statistics-for-attributes:missing-parameters","'layer' and 'attributes' parameters are required");if(a.attributes.some(n=>!!n.valueExpression)&&!a.view)throw new q("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");
var b=[2,1];const {layer:c,...h}=a,e=t.createLayerAdapter(c,b);a={layerAdapter:e,...h};a.includeZeros=null==a.includeZeros||a.includeZeros;a.includeNegatives=null==a.includeNegatives||a.includeNegatives;if(!e)throw new q("summary-statistics-for-attributes:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(b).join(", "));b=a.view;var k=u.isSome(a.signal)?{signal:a.signal}:null;await Promise.all([b&&b.when(),e.load(k)]);b=[];for(var f of a.attributes)k=await v.getFieldsList({field:f.field,
valueExpression:f.valueExpression}),Array.prototype.push.apply(b,k);if(f=w.verifyBasicFieldValidity(e,b,"summary-statistics-for-attributes:invalid-parameters"))throw f;return a}function y(a,b,c){const h=[],e=[],k=[],f=[],n=[];a.forEach((l,d)=>{const m=l.field?"field":"expression",r=l.field||l.valueExpression;l.field?(n.push(r),e.push(`var ${m}${d} = Number($feature["${r}"]);`)):(h.push(`function getValueForExpr${d}() {\n  ${r} \n}`),e.push(`var ${m}${d} = Number(getValueForExpr${d}());`));c||k.push(`${m}${d} = IIf(${m}${d} < 0, 0, ${m}${d});`);
f.push(`${m}${d}`)});a="return sum;";const g=h.length?null:n.reduce((l,d)=>`${l} + ${d}`);let p=null;b||c?b?c||(a="return IIf(sum \x3e\x3d 0, sum, null);",g&&(p=`(( ${g} ) >= 0)`)):(a="return IIf(sum !\x3d 0, sum, null);",g&&(p=`(( ${g} ) <> 0)`)):(a="return IIf(sum \x3e 0, sum, null);",g&&(p=`(( ${g} ) > 0)`));return{valueExpression:[h.length?h.join("\n"):"",e.join("\n"),k.join("\n"),`var sum = ${f.join(" + ")};`,a].filter(Boolean).join("\n\n"),sqlExpression:g,sqlWhere:p}}return async function(a){const {layerAdapter:b,
...c}=await x(a);a=y(c.attributes,c.includeZeros,c.includeNegatives);return b.summaryStatistics({valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,view:c.view,signal:c.signal})}});