// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/property ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/urlUtils ../../../../../core/uuid ../../../../../portal/support/resourceExtension ../../../../../core/Accessor ../../../../../intl/locale ../../../../../core/mathUtils ../../../../../core/screenUtils ../../../../../intl/messages ../../../../../intl ../../../../../chunks/vec3f64 ../../../../../chunks/vec3 ../../../../../core/Handles ../../../../../geometry/projectionEllipsoid ../../../../../core/unitUtils ../../../../../core/watchUtils ../../../../../core/quantityFormatUtils ../../../../../chunks/vec2 ../../../../../chunks/vec4f32 ../../../webgl-engine/materials/lineStippleUtils ../../visualElements/RightAngleQuadVisualElement ../../measurementTools/support/viewUtils ../../visualElements/LabelVisualElement ../../visualElements/LineVisualElement ../../visualElements/support/Segment ../../visualElements/MeasurementArrowVisualElement".split(" "),
function(l,H,r,da,p,ea,fa,t,ha,O,ia,ja,ka,P,Q,x,y,R,la,z,B,S,T,I,J,h,K,U,E,V,F,A,C,w,W){function L(n,u){return p.isSome(n.measurement)&&n.measurement.horizontalDistance&&n.measurement.horizontalDistance.value>u}function M(n,u){if(!n.state)return!1;const k=n.renderCoordsHelper;n=n.state.camera.computeScreenPixelSizeAt(u);return 10<=k.getAltitude(u)/n}l.DirectLineMeasurement3DView=function(n){function u(a){a=n.call(this,a)||this;a._params={...X};a._handles=new S;a._segmentVisualElement=null;a._triangleVisualElement=
null;a._rightAngleQuad=null;a._projectedGeodesicLine=null;a._geodesicStartHint=null;a._geodesicEndHint=null;a._segmentLabel=null;a._verticalLabel=null;a._horizontalLabel=null;a._segmentLabelDisplayedMeasurement="euclidean";a._startPosition=z.create();a._endPosition=z.create();a._cornerPosition=z.create();a._startPositionAtSeaLevel=z.create();a._endPositionAtSeaLevel=z.create();a._viewMode="none";a._geometryDirty=!0;a.state="pending";a.messages=null;a._visualizedMeasurement="auto";a._actualVisualizedMeasurement=
"euclidean";a._visualElementOrientation="auto";a._triangleOrientationOverride=null;a._triangleCollapseRatioThreshold=.03;a._geodesicDistanceThreshold=1E5;return a}H._inheritsLoose(u,n);var k=u.prototype;k.initialize=function(){this._handles.add(J.whenOnce(this.view,"ready",()=>this._initialize(),!0))};k._initialize=function(){switch(this.state){case "ready":throw Error("invalid state");case "destroyed":return}this._segmentVisualElement=new W.MeasurementArrowVisualElement({attached:!0,view:this.view,
geometry:null,renderOccluded:4});this._triangleVisualElement=new C.LineVisualElement({attached:!0,view:this.view,width:this._params.triangleLineWidth,color:this._params.triangleColor,renderOccluded:4});this._rightAngleQuad=new V.RightAngleQuadVisualElement({attached:!0,view:this.view,color:D,renderOccluded:4});this._projectedGeodesicLine=new C.LineVisualElement({attached:!0,view:this.view,width:this._params.geodesicProjectionLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,
stipplePattern:E.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4});this._geodesicStartHint=new C.LineVisualElement({attached:!0,view:this.view,width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:E.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4});this._geodesicEndHint=new C.LineVisualElement({attached:!0,view:this.view,
width:this._params.guideLineWidth,color:this._params.geodesicProjectionLineColor,polygonOffset:!0,stipplePattern:E.createStipplePatternSimple(this._params.guideStippleLengthPixels),stippleIntegerRepeats:!1,renderOccluded:4});this._segmentLabel=new A.LabelVisualElement({attached:!0,view:this.view,fontSize:this._params.direcLabelFontSize});this._verticalLabel=new A.LabelVisualElement({attached:!0,view:this.view,fontSize:this._params.verticalLabelFontSize});this._horizontalLabel=new A.LabelVisualElement({attached:!0,
view:this.view,fontSize:this._params.horizontalLabelFontSize});this._handles.add([this.dataObject.watch("visible",()=>this._update(!1),!0),this.dataObject.watch("startPoint",()=>this._update(),!0),this.dataObject.watch("endPoint",()=>this._update(),!0),this.dataObject.watch("measurement",()=>this._update(),!0),this.dataObject.watch("settings.unit",()=>{this._updateLabels();this._updateSegmentStripeLength()},!0),this.view.state.watch("camera",()=>this._update(),!0),Q.onLocaleChange(async()=>this._updateMessageBundle())]);
this._set("state","ready");this._updateMessageBundle();this._update()};k.whenReady=async function(){return J.whenOnce(this,"ready").then(()=>{})};k._update=function(a=!0){switch(this.state){case "destroyed":case "pending":return}const b=this.dataObject.visible;(this._geometryDirty=a)&&b&&(this._updateGeometryAndViewMode(),this._geometryDirty=!1);switch(this._viewMode){case "none":this._segmentVisualElement.visible=!1;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=
!1;this._geodesicStartHint.visible=!1;this._geodesicEndHint.visible=!1;break;case "segment":this._segmentVisualElement.visible=b;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=!1;this._geodesicEndHint.visible=!1;break;case "segment-and-triangle":this._segmentVisualElement.visible=b;this._triangleVisualElement.visible=b;this._rightAngleQuad.visible=b;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=
!1;this._geodesicEndHint.visible=!1;break;case "segment-and-projection":this._segmentVisualElement.visible=b,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}this._updateLabels()};k.destroy=function(){switch(this.state){case "destroyed":case "pending":return}this._handles.destroy();this._segmentVisualElement.destroy();this._segmentVisualElement=null;this._triangleVisualElement.destroy();this._triangleVisualElement=null;this._rightAngleQuad.destroy();
this._rightAngleQuad=null;this._projectedGeodesicLine.destroy();this._projectedGeodesicLine=null;this._geodesicStartHint.destroy();this._geodesicStartHint=null;this._geodesicEndHint.destroy();this._geodesicEndHint=null;this._segmentLabel.destroy();this._segmentLabel=null;this._verticalLabel.destroy();this._verticalLabel=null;this._horizontalLabel.destroy();this._horizontalLabel=null;this.set("view",null);this._set("state","destroyed")};k._updateGeometryAndViewMode=function(){var a=this.view,b=a.renderCoordsHelper;
if(p.isNone(this.dataObject.startPoint)||p.isNone(this.dataObject.endPoint)||this.dataObject.startPoint.equals(this.dataObject.endPoint))this._viewMode="none",this._actualVisualizedMeasurement="auto"===this._visualizedMeasurement?"euclidean":this._visualizedMeasurement;else{b.toRenderCoords(this.dataObject.startPoint,this._startPosition);b.toRenderCoords(this.dataObject.endPoint,this._endPosition);var c=this._getActualVisualElementsOrientation(),d=this._updateActualVisualizedMeasurement();this._viewMode=
this._computeViewMode(d);var f=this._startPosition,g=this._endPosition,q="above-segment"===c?1:-1,e=q*(b.getAltitude(g)-b.getAltitude(f));0>e&&(f=this._endPosition,g=this._startPosition);var m="geodesic"===d?new w.GeodesicSegment(this._startPosition,this._endPosition,b.spatialReference):new w.EuclideanSegment(this._startPosition,this._endPosition);this._segmentVisualElement.geometry=m;this._updateSegmentStripeLength();this._segmentLabelDisplayedMeasurement=d;switch(this._viewMode){case "segment":this._segmentLabel.anchor=
"above-segment"===c?"top":"bottom";this._segmentLabel.geometry={type:"segment",segment:m,sampleLocation:"center"};break;case "segment-and-triangle":d=this._cornerPosition;b.worldUpAtPosition(f,d);B.scale(d,d,q*Math.abs(e));B.add(d,d,f);this._triangleVisualElement.geometry=[[[f[0],f[1],f[2]],[d[0],d[1],d[2]],[g[0],g[1],g[2]]]];this._rightAngleQuad.geometry={previous:f,center:d,next:g};b=new w.EuclideanSegment(f,d);q=new w.EuclideanSegment(d,g);a=a.state.camera;e=Y;var v=Z;a.projectToRenderScreen(d,
e);a.projectToRenderScreen(g,v);e={segment:"bottom",horizontal:"top",vertical:e[0]<v[0]?"left":"right"};{const G=aa;v=ba;F.screenSpaceTangent(f,d,G,a);F.screenSpaceTangent(f,g,v,a);K.dot(G,v)>=N?e.segment=x.sign(G[1])===x.sign(v[1])?A.mirrorPosition(e.vertical):e.vertical:(f=ca,F.screenSpaceTangent(d,g,f,a),K.dot(f,v)>=N&&(e.segment=x.sign(f[0])===x.sign(v[0])?A.mirrorPosition(e.horizontal):e.horizontal))}"below-segment"===c&&(e.segment="top"===e.segment?"bottom":"top",e.horizontal="top"===e.horizontal?
"bottom":"top",e.vertical="top"===e.vertical?"bottom":"top");c=e;this._segmentLabel.geometry={type:"segment",segment:m,sampleLocation:"center"};this._segmentLabel.anchor=c.segment;this._verticalLabel.geometry={type:"segment",segment:b,sampleLocation:"center"};this._verticalLabel.anchor=c.vertical;this._horizontalLabel.geometry={type:"segment",segment:q,sampleLocation:"center"};this._horizontalLabel.anchor=c.horizontal;break;case "segment-and-projection":B.copy(this._startPositionAtSeaLevel,this._startPosition),
B.copy(this._endPositionAtSeaLevel,this._endPosition),b.setAltitude(0,this._startPositionAtSeaLevel),b.setAltitude(0,this._endPositionAtSeaLevel),m=new w.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,b.spatialReference),this._projectedGeodesicLine.setGeometryFromSegment(m),this._geodesicStartHint.setGeometryFromSegment(new w.EuclideanSegment(this._startPositionAtSeaLevel,this._startPosition)),this._geodesicEndHint.setGeometryFromSegment(new w.EuclideanSegment(this._endPositionAtSeaLevel,
this._endPosition)),this._segmentLabel.geometry={type:"segment",segment:m,sampleLocation:"center"},this._segmentLabel.anchor="above-segment"===c?"top":"bottom"}}};k._updateLabels=function(){switch(this.state){case "pending":case "destroyed":return}var a=this.messages,b=this.dataObject.measurement;if(p.isNone(b)||!a)this._segmentLabel.visible=!1,this._horizontalLabel.visible=!1,this._verticalLabel.visible=!1;else{var c="",d="",f="",g="";d=b.directDistance;var q=b.horizontalDistance,e=b.verticalDistance,
m=b.geodesicDistance;b=b.geodesicAngle;switch(this.dataObject.settings.unit){case "metric":f=d&&h.formatMetricLength(a,d);d=q&&h.formatMetricLength(a,q);c=e&&h.formatMetricVerticalLength(a,e);g=m&&h.formatMetricLength(a,m);break;case "imperial":f=d&&h.formatImperialLength(a,d);d=q&&h.formatImperialLength(a,q);c=e&&h.formatImperialVerticalLength(a,e);g=m&&h.formatImperialLength(a,m);break;case "degrees":g=d=f=a=b&&h.formatDecimal(a,b,"degrees");break;case "degrees-minutes-seconds":d=b&&h.formatDMS(b);
break;default:g=this.dataObject.settings.unit,f=d&&h.formatDecimal(a,d,g),d=q&&h.formatDecimal(a,q,g),c=e&&h.formatDecimal(a,e,g),g=m&&h.formatDecimal(a,m,g)}this._segmentLabel.text="euclidean"===this._segmentLabelDisplayedMeasurement?f:g;this._horizontalLabel.text=d;this._verticalLabel.text=c;c=this.dataObject.visible;switch(this._viewMode){case "none":this._segmentLabel.visible=!1;this._horizontalLabel.visible=!1;this._verticalLabel.visible=!1;break;case "segment":this._segmentLabel.visible=c;this._horizontalLabel.visible=
!1;this._verticalLabel.visible=!1;break;case "segment-and-triangle":this._segmentLabel.visible=c;this._horizontalLabel.visible=c;this._verticalLabel.visible=c;break;case "segment-and-projection":this._segmentLabel.visible=c,this._horizontalLabel.visible=!1,this._verticalLabel.visible=!1}this.notifyChange("segmentLabel");this.notifyChange("horizontalLabel");this.notifyChange("verticalLabel")}};k._updateSegmentStripeLength=function(){var a=this.view;var b=this.dataObject,c=null;if(p.isSome(b.measurement))switch(c=
b.measurement.directDistance,b.settings.unit){case "metric":c=c&&c.toUnit("meters");break;case "imperial":c=c&&c.toUnit(I.preferredImperialLengthUnit(c.value,c.unit));break;case "degrees":case "degrees-minutes-seconds":c=(b=b.measurement.geodesicAngle)&&b.toUnit("degrees");break;default:c=c&&c.toUnit(b.settings.unit)}c?(b=1,b=x.nextHighestPowerOfTen(c.value/30),a=b*="degrees"===c.unit?T.getReferenceEllipsoid(a.spatialReference).metersPerDegree:I.convertUnit(1,c.unit,"meters")):a=null;p.isSome(a)?
(this._segmentVisualElement.stripeLength=a,this._segmentVisualElement.stripesEnabled=!0):this._segmentVisualElement.stripesEnabled=!1};k._computeViewMode=function(a){const b=this.dataObject,c=b.measurement;if("geodesic"===a){if(!L(b,this.geodesicDistanceThreshold))return"segment";if(M(this.view,this._startPosition)||M(this.view,this._endPosition))return"segment-and-projection"}return p.isNone(c)?"segment":Math.min(c.verticalDistance.value/c.horizontalDistance.value,c.horizontalDistance.value/c.verticalDistance.value)<
this.triangleCollapseRatioThreshold?"segment":"segment-and-triangle"};k._getActualVisualElementsOrientation=function(){return p.isSome(this._triangleOrientationOverride)?this._triangleOrientationOverride:"auto"===this.visualElementsOrientation?this.view.state.camera.aboveGround?"above-segment":"below-segment":this.visualElementsOrientation};k._updateActualVisualizedMeasurement=function(){if("auto"===this._visualizedMeasurement){this._actualVisualizedMeasurement="euclidean";const a=this.dataObject.settings.unit;
if("degrees"===a||"degrees-minutes-seconds"===a)this._actualVisualizedMeasurement="geodesic";L(this.dataObject,this.geodesicDistanceThreshold)&&(this._actualVisualizedMeasurement="geodesic")}else this._actualVisualizedMeasurement=this._visualizedMeasurement;return this._actualVisualizedMeasurement};k._updateMessageBundle=function(){R.fetchMessageBundle("esri/core/t9n/Units").then(a=>{this.messages=a;this.view&&this._updateLabels()})};H._createClass(u,[{key:"ready",get:function(){return"ready"===this.state}},
{key:"viewMode",get:function(){return this._viewMode}},{key:"visualizedMeasurement",get:function(){return this._visualizedMeasurement},set:function(a){a!==this._visualizedMeasurement&&(this._visualizedMeasurement=a,this._update())}},{key:"actualVisualizedMeasurement",get:function(){return this._actualVisualizedMeasurement}},{key:"visualElementsOrientation",get:function(){return this._visualElementOrientation},set:function(a){a!==this._visualElementOrientation&&(this._visualElementOrientation=a,this._update())}},
{key:"allowVisualElementsOrientationChange",get:function(){return p.isNone(this._triangleOrientationOverride)},set:function(a){p.isNone(this._triangleOrientationOverride)!==a&&(p.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():(this._triangleOrientationOverride=null,this._update()))}},{key:"triangleCollapseRatioThreshold",get:function(){return this._triangleCollapseRatioThreshold},set:function(a){this._triangleCollapseRatioThreshold=
a;this._update()}},{key:"geodesicDistanceThreshold",get:function(){return this._geodesicDistanceThreshold},set:function(a){this._geodesicDistanceThreshold=a;this._update()}},{key:"segmentLabel",get:function(){return this._segmentLabel}},{key:"horizontalLabel",get:function(){return this._horizontalLabel}},{key:"verticalLabel",get:function(){return this._verticalLabel}},{key:"testData",get:function(){var a=null;a="geodesic"===this.actualVisualizedMeasurement;a={direct:a?this.horizontalLabel:this.segmentLabel,
horizontal:a?this.segmentLabel:this.horizontalLabel,vertical:this.verticalLabel};return{labels:a,stripeLength:this._segmentVisualElement.stripeLength}}}]);return u}(P);r.__decorate([t.property({readOnly:!0})],l.DirectLineMeasurement3DView.prototype,"state",void 0);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"ready",null);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"messages",void 0);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,
"view",void 0);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"dataObject",void 0);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"viewMode",null);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"segmentLabel",null);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"horizontalLabel",null);r.__decorate([t.property()],l.DirectLineMeasurement3DView.prototype,"verticalLabel",null);l.DirectLineMeasurement3DView=r.__decorate([O.subclass("esri.views.3d.interactive.graphics.DirectLineMeasurement3D.DirectLineMeasurement3DView")],
l.DirectLineMeasurement3DView);const D=U.fromValues(1,.5,0,.75),X={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:D,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,
arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:D,guideLineWidth:2,guideLineColor:D,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},N=Math.cos(x.deg2rad(12)),Y=y.createRenderScreenPointArray3(),Z=y.createRenderScreenPointArray3(),aa=y.createRenderScreenPointArray(),ba=y.createRenderScreenPointArray(),ca=y.createRenderScreenPointArray();Object.defineProperty(l,"__esModule",{value:!0})});