// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/compilerUtils ../../../core/maybe ../../../core/accessorSupport/utils ../../../geometry/Point ../../../geometry ../../../core/Evented ../../../core/mathUtils ../../../core/screenUtils ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../geometry/projectionEllipsoid ../../../chunks/mat4 ../../../geometry/support/aaBoundingRect ../../../geometry/projection ../../../chunks/mat3f64 ../../../chunks/mat4f64 ../../../chunks/mat3 ../../../chunks/vec2 ../support/ElevationProvider ../support/stack ../support/geometryUtils ../webgl-engine/lib/Object3D ../webgl-engine/lib/Camera ../../../layers/graphics/hydratedFeatures ../webgl-engine/lib/WebGLLayer".split(" "),
function(G,T,U,k,V,w,H,W,I,t,q,l,X,u,Y,x,Z,y,J,aa,E,z,m,ba,ca,K,da){function L(r){return 0!==r[12]||0!==r[13]||0!==r[14]}H=function(){function r(a){this.idHint=0;this.camera=new ca;this._elevation={offset:0,override:null};this.collisionType={type:"point"};this.collisionPriority=0;this._renderObjects=[];this._available=this.autoScaleRenderObjects=!0;this._noDisplayCount=0;this._radius=10;this._worldSized=!1;this.focusMultiplier=2;this.touchMultiplier=2.5;this.worldOriented=!1;this._modelTransform=
y.create();this._worldFrame=null;this._renderLocation=q.create();this._renderLocationDirty=!0;this._location=new w({x:0,y:0,z:0});this._elevationAlignedLocation=new w;this.interactive=this._elevationAlignedLocationDirty=!0;this.selectable=!1;this.grabbable=!0;this.cursor=null;this._selected=this._hovering=this.dragging=this._grabbing=!1;this._state=0;this._focused=!1;this.events=new W.EventEmitter;this._screenLocation={screenPointArray:t.createScreenPointArray(),renderScreenPointArray:t.createRenderScreenPointArray3(),
pixelSize:0};this._screenLocationDirty=!0;this._applyObjectTransform=null;this._engineResourcesAddedToStage=!1;this._engineResources=null;this._attached=!1;this._materialIdReferences=this._engineLayer=null;this._location.spatialReference=a.view.spatialReference;for(const b in a)this[b]=a[b];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}var h=r.prototype;h.destroy=function(){this._removeResourcesFromStage();this.camera=this.view=this._engineResources=null};h.disableDisplay=
function(){this._noDisplayCount++;1===this._noDisplayCount&&this._updateEngineObject();return{remove:V.once(()=>{this._noDisplayCount--;0===this._noDisplayCount&&this._updateEngineObject()})}};h._updateElevationAlignedLocation=function(){this._elevationAlignedLocation.x=this.location.x;this._elevationAlignedLocation.y=this.location.y;const a=k.isSome(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=a+this._elevation.offset;this._elevationAlignedLocation.spatialReference=
this.location.spatialReference;this._screenLocationDirty=this._renderLocationDirty=!0;this._elevationAlignedLocationDirty=!1};h.grabbableForEvent=function(){return!0};h.updateStateEnabled=function(a,b){this.state=b?this.state|a:this.state&~a};h._setFocused=function(a){a!==this._focused&&(this._focused=a,this.events.emit("focus-changed",{action:!0===a?"focus":"unfocus"}))};h.ensureScreenLocation=function(){if(this._screenLocationDirty){this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation);
this._screenLocationDirty=!1;if(L(this._modelTransform)){var a=this._calculateModelTransformOffset(ea);a=l.add(a,a,this.renderLocation)}else a=this.renderLocation;this.camera.projectToRenderScreen(a,this._screenLocation.renderScreenPointArray);this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}};h.intersectionDistance=function(a,b){if(!this.available)return null;a=t.screenPointObjectToArray(a,fa);var f=this._getCollisionRadius(b);b=-1*this.collisionPriority;
switch(this.collisionType.type){case "point":if(aa.squaredDistance(this.screenLocation.screenPointArray,a)<f*f)return this.screenLocation.renderScreenPointArray[2]+b;break;case "line":var d=this.collisionType.paths,c=this._getWorldToScreenObjectScale();c=this._calculateObjectTransform(c,A);f*=this.screenLocation.pixelSize;a=m.ray.fromScreen(this.camera,a,F);if(k.isNone(a))break;for(var g of d)if(0!==g.length){d=l.transformMat4(v,g[0],c);for(var e=1;e<g.length;e++){var n=l.transformMat4(M,g[e],c),
p=m.lineSegment.closestRayDistance2(m.lineSegment.fromPoints(d,n,N),a);if(null!=p&&p<f*f)return c=l.add(z.sv3d.get(),d,n),l.scale(c,c,.5),a=t.castRenderScreenPointArray(z.sv3d.get()),this.camera.projectToRenderScreen(c,a),a[2]+b;l.copy(d,n)}}break;case "disc":g=this.collisionType.direction;c=null!=(d=this.collisionType.offset)?d:q.ZEROS;d=this._getWorldToScreenObjectScale();d=this._calculateObjectTransform(d,A);f*=this.screenLocation.pixelSize;a=m.ray.fromScreen(this.camera,a,F);if(k.isNone(a))break;
e=J.fromMat4(O,d);g=l.transformMat3(P,g,e);c=l.transformMat4(Q,c,d);m.plane.fromPositionAndNormal(c,g,B);g=R;if(m.plane.intersectRay(B,a,g)&&l.squaredDistance(g,c)<f*f)return this.screenLocation.renderScreenPointArray[2]+b;break;case "ribbon":{const {paths:C,direction:D}=this.collisionType;g=this._getWorldToScreenObjectScale();g=this._calculateObjectTransform(g,A);f*=this.camera.computeScreenPixelSizeAt(this.renderLocation);d=m.ray.fromScreen(this.camera,a,F);if(k.isNone(d))break;a=J.fromMat4(O,g);
a=l.transformMat3(P,D,a);e=this._calculateModelTransformPosition(Q);m.plane.fromPositionAndNormal(e,a,B);a=R;if(!m.plane.intersectRay(B,d,a))break;for(c of C)if(0!==c.length)for(d=l.transformMat4(v,c[0],g),e=1;e<c.length;e++){n=l.transformMat4(M,c[e],g);p=m.lineSegment.distance2(m.lineSegment.fromPoints(d,n,N),a);if(null!=p&&p<f*f)return c=l.add(z.sv3d.get(),d,n),l.scale(c,c,.5),a=t.castRenderScreenPointArray(z.sv3d.get()),this.camera.projectToRenderScreen(c,a),a[2]+b;l.copy(d,n)}break}default:U.neverReached(this.collisionType)}return null};
h.attach=function(a={manipulator3D:{}}){if(this.view._stage){a=a.manipulator3D;if(k.isNone(a.engineLayerId)){var b=new da.WebGLLayer({isPickable:!1});this.view._stage.add(b);a.engineLayerId=b.id;this._engineLayer=b}else null!=(b=this.view._stage)&&b.getObject&&(this._engineLayer=this.view._stage.getObject(a.engineLayerId));a.engineLayerReferences=(a.engineLayerReferences||0)+1;this._materialIdReferences=a.materialIdReferences;k.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,
a.materialIdReferences=this._materialIdReferences);this.camera.copyFrom(this.view.state.camera);this._attached=!0;this._updateEngineObject();x.canProjectWithoutEngine(this._location.spatialReference,this.view.spatialReference)||(this.location=new w({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}};h.detach=function(a={manipulator3D:{}}){a=a.manipulator3D;a.engineLayerReferences--;const b=0===a.engineLayerReferences;b&&(a.engineLayerId=null);this._removeResourcesFromStage(b);this._materialIdReferences=
this._engineLayer=this._engineResources=null;this._attached=!1};h.onViewChange=function(){this.camera.copyFrom(this.view.state.camera);this._screenLocationDirty=!0;this._updateEngineObject()};h.onElevationChange=function(a){x.projectPoint(this.location,S,a.spatialReference);Y.containsPointObject(a.extent,S)&&(this.location=this._location)};h._evaluateElevationAlignment=function(a=this.location){if(k.isNone(this.elevationInfo))return!1;let b=null,f=0;const d=k.unwrapOr(this.elevationInfo.offset,0);
switch(this.elevationInfo.mode){case "on-the-ground":b=k.unwrapOr(E.getElevationAtPoint(this.view.elevationProvider,a,"ground"),0);break;case "relative-to-ground":f=k.unwrapOr(E.getElevationAtPoint(this.view.elevationProvider,a,"ground"),0)+d;break;case "relative-to-scene":f=k.unwrapOr(E.getElevationAtPoint(this.view.elevationProvider,a,"scene"),0)+d;break;case "absolute-height":f=d}return f!==this._elevation.offset||b!==this._elevation.override?(this._elevation.offset=f,this._elevation.override=
b,!0):!1};h._updateEngineObject=function(){if(this._attached)if(this.available){var a=this._getWorldToScreenObjectScale(),b=A;!0===this.autoScaleRenderObjects?(a*=this._getFocusedSize(this._radius,this.focused),this._calculateObjectTransform(a,b)):this._calculateObjectTransform(a,b);var {objectsByState:f}=this._ensureEngineResources();a=(this.focused?2:1)|(this.selected?8:4);var d=0<this._noDisplayCount;for(const {stateMask:c,objects:g}of f)if(d)for(const e of g)e.setVisible(!1);else if(f=0===(c&
65520)||(this.state&c)===(c&65520),0!==(c&15)&&(a&c)!==(c&15)||!f)for(const e of g)e.setVisible(!1);else for(const e of g)e.setVisible(!0),e.transformation=b;k.isSome(this._engineLayer)&&this._engineLayer.commit()}else this._removeResourcesFromStage()};h._ensureEngineResources=function(){if(k.isNone(this._engineResources)){const a=k.unwrap(this._engineLayer),b=[],f=new Set;this.renderObjects.forEach(({material:e})=>{f.has(e)||(b.push(e),f.add(e))});const d=(e,n)=>{const {geometry:p,material:C,transform:D}=
n;Array.isArray(p)?p.forEach(ha=>e.addGeometry(ha,C,D)):e.addGeometry(p,C,D)},c=new Map;this._renderObjects.forEach(e=>{const n=new ba.Object3D({castShadow:!1});d(n,e);e=e.stateMask||0;const p=c.get(e)||[];p.push(n);c.set(e,p)});const g=[];c.forEach((e,n)=>g.push({stateMask:n,objects:e}));this._engineResources={objectsByState:g,layer:a,materials:b}}this._addResourcesToStage();return this._engineResources};h._addResourcesToStage=function(){if(!this._engineResourcesAddedToStage&&!k.isNone(this._engineResources)){var {objectsByState:a,
layer:b,materials:f}=this._engineResources;f.forEach(d=>{const c=k.unwrap(this._materialIdReferences),g=c.get(d.id)||0;0===g&&this.view._stage.add(d);c.set(d.id,g+1)});a.forEach(({objects:d})=>d.forEach(c=>{b.add(c);this.view._stage.add(c)}));this._engineResourcesAddedToStage=!0}};h._removeResourcesFromStage=function(a=!1){if(this._engineResourcesAddedToStage&&!k.isNone(this._engineResources)){var {objectsByState:b,layer:f,materials:d}=this._engineResources;b.forEach(({objects:c})=>{f.removeMany(c);
this.view._stage.removeMany(c)});d.forEach(c=>{const g=k.unwrap(this._materialIdReferences),e=g.get(c.id);1===e?(this.view._stage.remove(c),g.delete(c.id)):g.set(c.id,e-1)});a&&this.view._stage.remove(f);this._engineResourcesAddedToStage=!1}};h._getCollisionRadius=function(a){return this._getFocusedSize(this.radius,!0)*("touch"===a?this.touchMultiplier:1)};h._getFocusedSize=function(a,b){return a*(b?this.focusMultiplier:1)};h._getWorldToScreenObjectScale=function(){return this._worldSized?1:this.screenLocation.pixelSize};
h._calculateModelTransformPosition=function(a){var b=this._getWorldToScreenObjectScale();b=this._calculateObjectTransform(b,ia);return l.set(a,b[12],b[13],b[14])};h._calculateModelTransformOffset=function(a){const b=this._calculateModelTransformPosition(a);return l.subtract(a,b,this.renderLocation)};h._calculateObjectTransform=function(a,b){u.set(b,a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1);this._worldFrame&&u.multiply(b,b,this._worldFrame);u.multiply(b,b,this._modelTransform);b[12]+=this.renderLocation[0];
b[13]+=this.renderLocation[1];b[14]+=this.renderLocation[2];b[15]=1;k.isSome(this._applyObjectTransform)&&this._applyObjectTransform(b);return b};T._createClass(r,[{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(a){this._elevationInfo=a;this._renderLocationDirty=this._elevationAlignedLocationDirty=!0;this._updateEngineObject()}},{key:"renderObjects",get:function(){return this._renderObjects},set:function(a){this._removeResourcesFromStage();this._engineResources=null;this._renderObjects=
a.slice();this._updateEngineObject()}},{key:"available",get:function(){return this._available},set:function(a){a!==this._available&&(this._available=a,this._updateEngineObject())}},{key:"radius",get:function(){return this._radius},set:function(a){a!==this._radius&&(this._radius=a,this._updateEngineObject())}},{key:"worldSized",get:function(){return this._worldSized},set:function(a){a!==this._worldSized&&(this._worldSized=a,this._updateEngineObject())}},{key:"modelTransform",get:function(){return this._modelTransform},
set:function(a){L(a)&&(this._screenLocationDirty=!0);u.copy(this._modelTransform,a);this._updateEngineObject()}},{key:"renderLocation",get:function(){if(this._renderLocationDirty)if(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented){this._worldFrame||(this._worldFrame=y.create());a:{var a=this.view,b=this._renderLocation,f=this._worldFrame;switch(a.viewingMode){case "local":u.identity(f);break a;case "global":a=
X.getReferenceEllipsoid(a.renderCoordsHelper.spatialReference),x.sphericalPCPFtoLonLatElevation(b,0,v,0,a.radius),x.computeLatLonToENURotation(I.deg2rad(v[1]),I.deg2rad(v[0]),f)}}}else this._worldFrame&&(this._worldFrame=null);return this._renderLocation},set:function(a){this.view.renderCoordsHelper.fromRenderCoords(a,this._location);this.elevationAlignedLocation=this._location}},{key:"location",get:function(){return this._location},set:function(a){K.clonePoint(a,this._location);this._elevationAlignedLocationDirty=
this._screenLocationDirty=this._renderLocationDirty=!0;this._updateEngineObject();this.events.emit("location-update",{location:this._location})}},{key:"elevationAlignedLocation",get:function(){if(!this._elevationAlignedLocationDirty)return this._elevationAlignedLocation;this._evaluateElevationAlignment();this._updateElevationAlignedLocation();return this._elevationAlignedLocation},set:function(a){K.clonePoint(a,this._location);this._evaluateElevationAlignment();this._location.z-=this._elevation.offset;
this._updateElevationAlignedLocation();this._updateEngineObject();this.events.emit("location-update",{location:this._location})}},{key:"grabbing",get:function(){return this._grabbing},set:function(a){a!==this._grabbing&&(this._grabbing=a,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"hovering",get:function(){return this._hovering},set:function(a){a!==this._hovering&&(this._hovering=a,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},
{key:"selected",get:function(){return this._selected},set:function(a){a!==this._selected&&(this._selected=a,this._updateEngineObject(),this.events.emit("select-changed",{action:a?"select":"deselect"}))}},{key:"state",get:function(){return this._state},set:function(a){a!==this._state&&(this._state=a,this._updateEngineObject())}},{key:"focused",get:function(){return this._focused}},{key:"screenLocation",get:function(){this.ensureScreenLocation();return this._screenLocation}},{key:"applyObjectTransform",
get:function(){return this._applyObjectTransform},set:function(a){this._applyObjectTransform=a;this._screenLocationDirty=!0;this._updateEngineObject()}},{key:"test",get:function(){let a=!1;if(k.isSome(this._engineResources))for(const b in this._engineResources.objectsByState){const f=this._engineResources.objectsByState[b];for(const d of f.objects)if(d.isVisible){a=!0;break}if(a)break}return{areAnyResourcesVisible:a}}}]);return r}();const fa=t.createScreenPointArray(),N=m.lineSegment.create(),F=m.ray.create(),
O=Z.create(),ia=y.create(),A=y.create(),B=m.plane.create(),v=q.create(),M=q.create(),R=q.create(),P=q.create(),Q=q.create(),ea=q.create(),S=new w({x:0,y:0,z:0,spatialReference:null});G.Manipulator3D=H;Object.defineProperty(G,"__esModule",{value:!0})});