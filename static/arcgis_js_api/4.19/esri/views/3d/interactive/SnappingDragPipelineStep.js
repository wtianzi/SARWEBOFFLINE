// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../core/promiseUtils ../../support/Scheduler ../../../layers/graphics/dehydratedFeatureComparison ../../interactive/snapping/SnappingContext ../../interactive/dragEventPipeline".split(" "),function(p,d,y,q,z,A,r){let E=function(){function t(){this.next=new r.EventPipeline}t.prototype.createSnapDragEventPipelineStep=function({predicate:B=()=>!0,cancel:C,snappingManager:e,snappingContext:f}){if(d.isNone(e))return a=>a;let g=null,b=null;const u=()=>{g=d.abortMaybe(g);
e.doneSnapping();d.isSome(b)&&b.frameTask.remove();b=null};C.next(a=>{u();return a});this.next=new r.EventPipeline;return a=>{if(!B(a))return a;g=d.abortMaybe(g);if("start"===a.action){const c="3d"===e.view.type?e.view.resourceController.scheduler.registerTask(q.Task.SNAPPING,h=>d.unwrap(c).processQueue(h),()=>!1):q.ImmediateTask;b={context:new A.SnappingContext({geometry:f.geometry,elevationInfo:f.elevationInfo,pointer:f.pointer,vertexHandle:d.isSome(a.info)?a.info.handle:null,excludeFeature:f.excludeFeature,
visualizer:f.visualizer}),originalPos:d.isSome(a.snapOrigin)?f.coordinateHelper.createDehydratedPoint(a.snapOrigin):a.mapStart,frameTask:c}}if(d.isSome(b)){const c=b.context.coordinateHelper.createDehydratedPoint(b.context.coordinateHelper.fromArray([b.originalPos.x,b.originalPos.y,b.originalPos.z]));c.x+=a.mapEnd.x-a.mapStart.x;c.y+=a.mapEnd.y-a.mapStart.y;const h=a.mapStart.x-b.originalPos.x,v=a.mapStart.y-b.originalPos.y,k={...a,action:"udpate"},D=b.context,l=e.update(c,b.context);a.mapEnd.x=l.x+
h;a.mapEnd.y=l.y+v;if("end"!==a.action){const w=b.frameTask;g=y.createTask(async m=>{const x=await w.schedule(()=>e.snap(c,D,m),m);if(x.valid){const n=await w.schedule(()=>x.apply(),m);z.pointEquals(n,l)||(k.mapEnd.x=n.x+h,k.mapEnd.y=n.y+v,this.next.execute(k))}})}}"end"===a.action&&u();return a}};return t}();p.SnappingPipeline=E;Object.defineProperty(p,"__esModule",{value:!0})});