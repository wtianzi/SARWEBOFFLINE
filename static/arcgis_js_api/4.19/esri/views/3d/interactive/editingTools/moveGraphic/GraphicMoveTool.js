// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/handleUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/urlUtils ../../../../../core/uuid ../../../../../portal/support/resourceExtension ../../../../../core/Evented ../../../../../core/Collection ../../../../../core/Handles ../../../../../support/elevationInfoUtils ../../../../../layers/graphics/dehydratedFeatures ../../../../interactive/editGeometry/EditGeometry ../../../../interactive/editGeometry/EditGeometryHelper ../../../../interactive/snapping/SnappingContext ../../../../interactive/dragEventPipeline ../../SnappingDragPipelineStep ../../SnappingVisualizer3D ../../../../interactive/InteractiveToolBase ../../manipulatorUtils ./isSupportedGraphic ../manipulatorUtils ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../visualElementUtils ../manipulations/config ../manipulations/moveUtils ../manipulations/MoveManipulation ../manipulations/MoveXYGraphicManipulation".split(" "),
function(l,z,t,ba,w,ca,da,H,u,ea,I,fa,ha,ia,J,K,A,v,L,M,N,O,B,P,Q,R,S,T,U,C,V,W,X,Y,D,Z){let E=function(m){this.allGraphics=m;this.type="graphic-move-start"},F=function(m,r,k){this.dx=m;this.dy=r;this.allGraphics=k;this.type="graphic-move"},x=function(m){this.allGraphics=m;this.type="graphic-move-stop"};l.GraphicMoveTool=function(m){function r(a){a=m.call(this,a)||this;a.graphics=new K;a.enableZ=!0;a.type="move-3d";a._toolHandles=new A;a._handles=new A;a.snappingPipeline=new P.SnappingPipeline;return a}
z._inheritsLoose(r,m);var k=r.prototype;k.initialize=function(){this._toolHandles.add([this.graphics.on("change",()=>this._refreshManipulators())]);this._refreshManipulators()};k.destroy=function(){this._handles.destroy();this._handles=null;this._toolHandles.destroy();this._toolHandles=null;this.graphics.removeAll();this._set("view",null)};k.reset=function(){};k._refreshManipulators=function(){this._handles.removeAll();this._moveManipulation&&this._moveManipulation.destroy();this.manipulators.removeAll();
const a=this.graphics.toArray().filter(b=>0===T.isSupportedGraphic(b)).map(b=>new aa(b));a.length&&(this.createManipulators(a),this.createVisualElements(a),this._handles.add(a.map(b=>this.view.trackGraphicState(b.state))),this.updateMoveManipulation(a))};k.createManipulators=function(a){for(const b of a){const e=b.state;b.manipulationXY=new Z.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:e});b.manipulationXY.forEachManipulator(c=>this._handles.add(c.events.on("immediate-click",
d=>{this.emit("immediate-click",{...d,graphic:e.graphic});d.stopPropagation()})));this._handles.add(b.manipulationXY.createDragPipeline((c,d,f,n)=>this.buildDragEventPipeline(a,0,c,d,f,n)))}this.createMoveManipulation(a)};k.createMoveManipulation=function(a){const b=new D.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?D.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):X.DISC_RADIUS});this._moveManipulation=b;b.elevationInfo=
{mode:"absolute-height",offset:0};b.forEachManipulator(d=>{this._handles.add(d.events.on("immediate-click",f=>{b.zManipulation.hasManipulator(d)||1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.getItemAt(0)});f.stopPropagation()}))});const e=()=>this.updateMoveManipulation(a);for(const d of a)this._handles.add([d.state.on("changed",e),d.state.watch("displaying",e)]);const c=a[a.length-1];this._handles.add(c.state.on("changed",()=>this.updateMoveManipulationAngle(c)));
this._handles.add(b.createDragPipeline((d,f,n,h,p)=>this.buildDragEventPipeline(a,d,f,n,h,p),v.getGraphicEffectiveElevationInfo(c.graphic),w.unwrap(c.graphic.geometry).spatialReference,c.graphic));this.updateMoveManipulationAngle(c)};k.createVisualElements=function(a){for(const b of a){const e=W.createVisualElements({view:this.view,graphic:b.graphic,forEachManipulator:c=>{b.manipulationXY.forEachManipulator(c);this._moveManipulation.forEachManipulator(c)},onManipulatorsChanged:()=>H.makeHandle()});
b.geometryRepresentation=e.visualElement;b.geometryRepresentation instanceof C.OutlineVisualElement&&this._handles.add([b.geometryRepresentation.events.on("attachment-origin-changed",()=>{b.state.isDraped||this.updateMoveManipulation(a)}),b.state.watch("isDraped",()=>this.updateMoveManipulation(a))]);this._handles.add(e)}};k.updateMoveManipulationAngle=function(a){this._moveManipulation.angleDeferred=()=>Y.shapeOrientation(a.graphic.geometry)};k.updateMoveManipulation=function(a){const b=L.makeDehydratedPoint(0,
0,0,this.view.spatialReference);let e=0,c=!1;const d=this._moveManipulation;for(const f of a)f.state.displaying&&(a=f.state.graphic,this.enableZ&&U.canMoveZ(a)&&(c=!0),a=f.geometryRepresentation instanceof C.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:S.getGraphicAttachmentOrigin(this.view,a),w.isSome(a)&&(b.x+=a.x,b.y+=a.y,b.z+=a.z,e++));0<e?(b.x/=e,b.y/=e,b.z/=e,d.location=b,d.xyManipulation.available=!0,d.xyAxisManipulation.available=!0,d.zManipulation.available=
c):d.available=!1};k.buildDragEventPipeline=function(a,b,e,c,d,f){const n=[],h=[];let p=null,y=null;const G=()=>{for(const g of n)g.dragging=!1;n.length=0;h.length=0;y=p=null;this._moveManipulation.interactive=!0};1===a.length&&0===b&&(b=a[0].graphic,c=this.buildSnappingPipelineSteps(b,v.getGraphicEffectiveElevationInfo(b),c,d,f));c=c.next(g=>{if("start"===g.action){n.length=0;h.length=0;for(const q of a)q.dragging||!q.manipulationXY.hasManipulator(e)&&q.manipulationXY.grabbing||(n.push(q),h.push(q.graphic),
q.dragging=!0);if(0!==h.length&&(this._moveManipulation.interactive=!1,p=B.dragGraphicMany(h),y=B.resetGraphicMany(h),this.emit("graphic-move-start",new E(h)),this.destroyed))return null}return 0!==h.length?g:null}).next(g=>p(g)).next(g=>{switch(g.action){case "start":case "update":if(g.translationX||g.translationY||g.translationZ){const q=this.view.toScreen(g.mapStart);g=this.view.toScreen(g.mapEnd);this.emit("graphic-move",new F(g.x-q.x,g.y-q.y,h));if(this.destroyed)return null}break;case "end":this.emit("graphic-move-stop",
new x(h));if(this.destroyed)return null;G()}});d.next(g=>y(g)).next(()=>{this.emit("graphic-move-stop",new x(h));if(this.destroyed)return null;G()});return c};k.buildSnappingPipelineSteps=function(a,b,e,c,d){const f=a.geometry;if(w.isNone(f)||"point"!==f.type)return e;const n=new O.SnappingContext({elevationInfo:b,pointer:d,geometry:new N.EditGeometryHelper(M.EditGeometry.fromGeometry(f,this.view.viewingMode),"point"),visualizer:new Q.SnappingVisualizer3D,excludeFeature:a});b=this.snappingManager;
return e.next(h=>{var p=f.clone();p.z=v.getConvertedElevation(this.view,p,v.getGraphicEffectiveElevationInfo(a),{mode:"absolute-height",offset:0});p=n.coordinateHelper.fromPoint(p);return{...h,snapOrigin:p}}).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:n,snappingManager:b,cancel:c}),this.snappingPipeline.next)};return r}(J.EventedMixin(R.InteractiveToolBase));t.__decorate([u.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,"view",void 0);t.__decorate([u.property({readOnly:!0})],
l.GraphicMoveTool.prototype,"graphics",void 0);t.__decorate([u.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,"enableZ",void 0);t.__decorate([u.property({constructOnly:!0})],l.GraphicMoveTool.prototype,"snappingManager",void 0);t.__decorate([u.property({readOnly:!0})],l.GraphicMoveTool.prototype,"type",void 0);l.GraphicMoveTool=t.__decorate([I.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],l.GraphicMoveTool);let aa=function(){function m(r){this.manipulationXY=
this.geometryRepresentation=this.state=null;this.dragging=!1;this.state=new V.GraphicState({graphic:r})}z._createClass(m,[{key:"graphic",get:function(){return this.state.graphic}}]);return m}();l.GraphicMoveEvent=F;l.GraphicMoveStartEvent=E;l.GraphicMoveStopEvent=x;Object.defineProperty(l,"__esModule",{value:!0})});