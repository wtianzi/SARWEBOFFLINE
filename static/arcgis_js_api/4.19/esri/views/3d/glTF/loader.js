// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../chunks/mat4f64 ./DefaultErrorContext ./LoaderResult ./internal/Resource".split(" "),function(t,p,w,x,u,y){function z(f){let a=null;f.json.nodes.forEach(d=>{d=d.extras;p.isSome(d)&&(d.ESRI_proxyEllipsoid||d.ESRI_lod)&&(a=d)});return a}async function A(f,a){async function d(e,c){const g=k.nodes[e];e=f.getNodeTransform(e);m.warnUnsupportedIf(null!=g.weights,"Morph targets are not supported.");if(null!=g.mesh){const l=k.meshes[g.mesh];for(const q of l.primitives)await a(q,
e,c,l.name)}for(const l of g.children||[])await d(l,c)}const k=f.json;var b=k.scenes[k.scene||0].nodes;const h=1<b.length;for(const e of b){b=k.nodes[e];const c=[d(e,0)];b.extensions&&b.extensions.MSFT_lod&&Array.isArray(b.extensions.MSFT_lod.ids)&&!h&&c.push(...b.extensions.MSFT_lod.ids.map((g,l)=>d(g,l+1)));await Promise.all(c)}}function B(f,a,d){const k=h=>{const e=`${d}_tex_${h&&h.id}${h&&h.name?"_"+h.name:""}`;if(h&&!f.textures.has(e)){const c=u.makeTextureSource(h.data,{wrap:{s:v(h.wrapS),t:v(h.wrapT)},
mipmap:C.some(g=>g===h.minFilter),noUnpackFlip:!0});f.textures.set(e,c)}return e},b=`${d}_mat_${a.id}_${a.name}`;f.materials.has(b)||(a=u.makeMaterialParameters({color:[a.color[0],a.color[1],a.color[2]],opacity:a.color[3],alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,colorMixMode:a.ESRI_externalColorMixMode,textureColor:a.colorTexture?k(a.colorTexture):void 0,textureNormal:a.normalTexture?k(a.normalTexture):void 0,textureOcclusion:a.occlusionTexture?k(a.occlusionTexture):
void 0,textureEmissive:a.emissiveTexture?k(a.emissiveTexture):void 0,textureMetallicRoughness:a.metallicRoughnessTexture?k(a.metallicRoughnessTexture):void 0,emissiveFactor:[a.emissiveFactor[0],a.emissiveFactor[1],a.emissiveFactor[2]],metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor}),f.materials.set(b,a));return b}function v(f){if(33071===f||33648===f||10497===f)return f;m.error(`Unexpected TextureSampler WrapMode: ${f}`)}let D=0;const m=new x.DefaultErrorContext,C=[9987,9985],E=
"POINTS LINES LINE_LOOP LINE_STRIP TRIANGLES TRIANGLE_STRIP TRIANGLE_FAN".split(" ");t.load=async function(f,a,d={},k=!0){const b=await y.Resource.load(f,m,a,d),h=`gltf_${D++}`,e={lods:[],materials:new Map,textures:new Map,meta:z(b)};f=!(!b.json.asset.extras||"symbolResource"!==b.json.asset.extras.ESRI_type);await A(b,async(c,g,l,q)=>{var n=void 0!==c.mode?c.mode:4;a:switch(n){case 4:case 5:case 6:var r=n;break a;default:r=null}p.isNone(r)?m.warnUnsupported("Unsupported primitive mode ("+E[n]+"). Skipping primitive."):
b.hasPositions(c)?(n=await b.getMaterial(c,d,k),g={transform:w.clone(g),attributes:{position:await b.getPositionData(c,d),normal:null,texCoord0:null,color:null,tangent:null},indices:await b.getIndexData(c,d),primitiveType:r,material:B(e,n,h)},b.hasNormals(c)&&(g.attributes.normal=await b.getNormalData(c,d)),b.hasTangents(c)&&(g.attributes.tangent=await b.getTangentData(c,d)),b.hasTextureCoordinates(c)&&(g.attributes.texCoord0=await b.getTextureCoordinates(c,d)),b.hasVertexColors(c)&&(g.attributes.color=
await b.getVertexColors(c,d)),c=null,p.isSome(e.meta)&&p.isSome(e.meta.ESRI_lod)&&"screenSpaceRadius"===e.meta.ESRI_lod.metric&&(c=e.meta.ESRI_lod.thresholds[l]),e.lods[l]=e.lods[l]||{parts:[],name:q,lodThreshold:c},e.lods[l].parts.push(g)):m.warn("Skipping primitive without POSITION vertex attribute.")});return{model:e,meta:{isEsriSymbolResource:f,uri:b.uri},customMeta:{}}};Object.defineProperty(t,"__esModule",{value:!0})});