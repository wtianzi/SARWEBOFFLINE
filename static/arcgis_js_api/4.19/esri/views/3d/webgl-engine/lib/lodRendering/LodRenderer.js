// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/vec3f64 ../../../../../chunks/vec3 ../../../../../chunks/mat4f64 ../../../../../chunks/vec2f64 ../../../../../chunks/vec4f64 ../../../../../geometry/support/aaBoundingBox ../DefaultVertexAttributeLocations ../../../support/buffer/glUtil ../Util ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject ../../materials/renderers/utils ../intersectorUtils ../Camera ../../../support/debugFlags ../../materials/internal/MaterialUtil ../../core/shaderLibrary/output/OutputHighlight.glsl ../../materials/DefaultMaterial ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData".split(" "),
function(v,B,S,w,u,T,U,V,x,C,F,y,W,G,X,D,Y,Z,H,aa,ba,ca,p,da,ea,I){function J(h,g,a){const b=h.allocateHead();h=h.view;D.encodeDoubleVec3(g.modelOrigin,a,h.modelOriginHi,h.modelOriginLo,b);h.model.copyFrom(b,g.model,a);h.modelNormal.copyFrom(b,g.modelNormal,a);g.color&&h.color&&h.color.copyFrom(b,g.color,a);g.featureAttribute&&h.featureAttribute&&h.featureAttribute.copyFrom(b,g.featureAttribute,a)}let K=function(h){const g=h.baseBoundingSphere.radius;h=h.levels.map(a=>a.minScreenSpaceRadius);return new ea.LevelSelector(g,
h)},L=function(){function h(a,b){const c=a.renderContext.rctx,e=b.geometry;b=b.material;this.materialRep=a.materialRep;b.setParameterValues({instancedDoublePrecision:!0});a=b.createBufferWriter();const f=a.vertexBufferLayout,k=a.elementCount(e),d=a.allocate(k);a.write({},e,d,0);this.geometry=e;this.material=b;this.glMaterials=D.acquireMaterials(b,this.materialRep);this.vertexBufferLayout=f;this.vbo=W.createVertex(c,35044,d.buffer);this.vao=new X(c,C.Default3D,{geometry:F.glLayout(f)},{geometry:this.vbo});
this.vertexCount=k}var g=h.prototype;g.destroy=function(){D.releaseMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};g.intersect=function(a,b,c,e,f,k){const d=this.geometry.id,l=f.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,c,e,(m,n,q,t)=>{if(0<=m&&(null==b||b(a.rayBeginPoint,a.rayEndPoint,m))){var z={type:"external",metadata:{layerUid:k.layerUid,graphicUid:k.graphicUid(f)}};if(null==a.results.min.drapedLayerOrder||t>=a.results.min.drapedLayerOrder)if(null==
a.results.min.dist||m<a.results.min.dist)a.results.min.set(z,l,m,n,a.transform.transform,t,null,d,q),a.results.min.intersector="LodRenderer";0!==a.options.store&&(null==a.results.max.drapedLayerOrder||t>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||m>a.results.max.dist)&&(a.results.max.set(z,l,m,n,a.transform.transform,t,null,d,q),a.results.min.intersector="LodRenderer");if(2===a.options.store){const E=new Y.IntersectorResult(a.results.min.ray);E.set(z,l,m,n,a.transform.transform,t,
null,d,q);E.intersector="LodRenderer";a.results.all.push(E)}}})};B._createClass(h,[{key:"boundingInfo",get:function(){return this.geometry.boundingInfo}},{key:"triangleCount",get:function(){return this.vertexCount/3}}]);return h}(),M=function(){function h(a,b){this.components=[];this.minScreenSpaceRadius=b.minScreenSpaceRadius;b.components.forEach(c=>{this.components.push(new L(a,c))})}var g=h.prototype;g.destroy=function(){this.components.forEach(a=>{a.destroy()})};g.intersect=function(a,b,c,e,f,
k){this.components.forEach(d=>{d.intersect(a,b,c,e,f,k)})};B._createClass(h,[{key:"boundingBox",get:function(){if(!this._boundingBox){const a=x.empty();this.components.forEach(b=>{S.isSome(b.boundingInfo)&&(x.expandWithVec3(a,b.boundingInfo.bbMin),x.expandWithVec3(a,b.boundingInfo.bbMax))});this._boundingBox=a}return this._boundingBox}},{key:"boundingSphere",get:function(){if(!this._boundingSphere){const a=this.boundingBox,b=w.create();x.center(a,b);this._boundingSphere={center:b,radius:.5*x.diameter(a)}}return this._boundingSphere}},
{key:"triangleCount",get:function(){return this.components.reduce((a,b)=>a+b.triangleCount,0)}}]);return h}(),fa=function(){function h(a,b,c,e){this.type="Lod";this.isGround=!1;this._inverseViewport=U.create();this._levels=[];this._defaultRenderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new Z;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.canRender=!0;this._symbol=a;this._optionalFields=
b;this._metadata=c;this._instanceBufferLayout=ca.DefaultMaterial.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._glInstanceBufferLayout=F.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new p.InstanceData(this._optionalFields,e);this._instanceData.on("instance-added",()=>{this.requestUpdateCycle()});this._instanceData.on("instance-removed",()=>{this.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",f=>{this.requestUpdateCycle();
this._metadata.notifyGraphicGeometryChanged(f.index)});this._instanceData.on("instance-visibility-changed",f=>{this.requestUpdateCycle(!0);this._metadata.notifyGraphicVisibilityChanged(f.index)});this._instanceData.on("instance-highlight-changed",()=>{this.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;A.push(this)}var g=h.prototype;g.destroy=function(){A.splice(A.indexOf(this),1)};g.initializeRenderContext=function(a){this._context=a;const b=a.renderContext.rctx;
this._symbol.levels.forEach(c=>{this._levels.push(new M(a,c));this._defaultRenderInstanceData.push(new I.RenderInstanceData(b,this._instanceBufferLayout));this._highlightRenderInstanceData.push(new I.RenderInstanceData(b,this._instanceBufferLayout))});this._levelSelector=K(this)};g.uninitializeRenderContext=function(){this.invalidateOctree();this._levels.forEach(a=>{a.destroy()});this._defaultRenderInstanceData.forEach(a=>{a.destroy()});this._highlightRenderInstanceData.forEach(a=>{a.destroy()})};
g.prepareRender=function(a){this.runUpdates(a)};g.render=function(a){var b=a.rctx;const c=4===a.slot?3:6===a.slot?5:null;if(c){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var e=a.camera;this._inverseViewport[0]=1/e.fullViewport[2];this._inverseViewport[1]=1/e.fullViewport[3];e={slot:c,origin:[0,0,0],camera:e,inverseViewport:this._inverseViewport,shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,
screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:a.sliceHelper&&a.sliceHelper.plane,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:a.scenelightingData,transparencyPassType:a.transparencyPassType,
terrainLinearDepthTexture:a.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:a.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:a.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:a.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:a.multipassGeometryParams.multipassGeometryEnabled};b.bindVAO();b=6!==a.pass;5!==a.pass&&7!==a.pass&&this.renderComponents(a,c,e,this._defaultRenderInstanceData);b&&this.renderComponents(a,
c,e,this._highlightRenderInstanceData);return!0}};g.intersect=function(a,b,c,e){if(this.baseMaterial.isVisible()){var f=w.create();u.subtract(f,e,c);var k=d=>{this._instanceData.getCombinedModelTransform(d,N);a.transform.set(N);u.transformMat4(O,c,a.transform.inverse);u.transformMat4(P,e,a.transform.inverse);const l=this._instanceData.getState(d),m=this._instanceData.getLodLevel(d);y.assert(l&p.StateFlags.ACTIVE,"invalid instance state");y.assert(0<=m&&m<this._levels.length,"invaid lod level");this._levels[m].intersect(a,
b,O,P,d,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(k):this.octree.forEachAlongRay(c,f,k)}};g.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};g.notifyShaderTransformationChanged=function(){this.invalidateOctree()};g.requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._context.requestRender()};g.runUpdates=function(a){if(!H.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var b=
a.equals(this._lastCamera);this._lastCamera.copyFrom(a);b||this.requestUpdateCycle()}b=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,b);this.needsUpdates&&this._context.requestRender()}};g.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};g.buildOctree=function(){const a=new da.InstanceOctree(this._instanceData,this.baseBoundingSphere);var b=this._instanceData;b=b.view?b.view.state:null;for(let c=0;c<this._instanceData.capacity;++c)b.get(c)&
p.StateFlags.ACTIVE&&a.addInstance(c);return a};g.queryDepthRangeOctree=function(a){var b=a.eye;const c=a.viewForward;var e=this.octree.findClosest(c,"front-to-back",a.frustum);const f=this.octree.findClosest(c,"back-to-front",a.frustum);return null!=e&&null!=f?(this._instanceData.view.boundingSphere.getVec(e,r),u.subtract(r,r,b),e=u.dot(r,c)-r[3],this._instanceData.view.boundingSphere.getVec(f,r),u.subtract(r,r,b),b=u.dot(r,c)+r[3],{near:Math.max(a.near,e),far:Math.min(a.far,b)}):{near:Infinity,
far:-Infinity}};g.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._defaultRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this.needsUpdates&&this._context.requestRender()};g.updateInstances=function(a,b){const c=this._enableLevelSelection,e=this._levelSelector;e.updateCamera(a);this._defaultRenderInstanceData.forEach(n=>{n.beginUpdate()});this._highlightRenderInstanceData.forEach(n=>{n.beginUpdate()});
a=this._instanceData;const f=this._instanceData.view,k=a.capacity;let d=this._instanceIndex;b=Math.min(a.size,b);for(let n=0;n<b;++n){0===d&&this.startUpdateCycle();const q=f.state.get(d);var l=0;if(q&p.StateFlags.ALLOCATED){var m=f.lodLevel.get(d);q&p.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail();q&p.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail();q&p.StateFlags.REMOVE?a.freeInstance(d):q&p.StateFlags.VISIBLE?(m=0,c&&(f.modelOrigin.getVec(d,
Q),m=e.selectLevel(Q,a.getCombinedMedianScaleFactor(d))),l=q&~(p.StateFlags.ACTIVE|p.StateFlags.TRANSFORM_CHANGED),0<=m&&(q&p.StateFlags.HIGHLIGHT?(J(this._highlightRenderInstanceData[m],f,d),l|=p.StateFlags.HIGHLIGHT_ACTIVE):(J(this._defaultRenderInstanceData[m],f,d),l|=p.StateFlags.DEFAULT_ACTIVE)),f.state.set(d,l),f.lodLevel.set(d,m)):(l=q&~(p.StateFlags.ACTIVE|p.StateFlags.TRANSFORM_CHANGED),f.state.set(d,l));this._octree&&(m=!!(q&p.StateFlags.ACTIVE),l=!!(l&p.StateFlags.ACTIVE),!m&&l?this._octree.addInstance(d):
m&&!l?this._octree.removeInstance(d):m&&l&&q&p.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(d),this._octree.addInstance(d)));d=(d+1)%k}else d=(d+1)%k,b++}this._instanceIndex=d;this._defaultRenderInstanceData.forEach(n=>{n.endUpdate()});this._highlightRenderInstanceData.forEach(n=>{n.endUpdate()})};g.renderComponents=function(a,b,c,e){this.levels.forEach((f,k)=>{f.components.forEach(d=>{this.renderComponent(a,b,c,e[k],d,k)})})};g.renderComponent=function(a,b,c,e,f,k){var d=f.glMaterials.get(a.pass);
if(d&&d.beginSlot(b)&&0!==e.size){var l=a.rctx,m=l.capabilities.instancing;d.ensureParameters(c);var n=d.getTechnique();b=d.getPipelineState(b);l.setPipelineState(b);d.bind(l,c);l.bindVAO(f.vao);n.ensureAttributeLocations(f.vao);d=n.program;a.isHighlightPass&&ba.OutputHighlight.bindOutputHighlight(l,d,c);n.bindDraw(c);H.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(d.setUniform4fv("externalColor",R[Math.min(k,R.length-1)]),d.setUniform1i("colorMixMode",aa.colorMixModes.replace));a=e.capacity;
c=e.headIndex;k=e.tailIndex;d=e.firstIndex;var q=this._glInstanceBufferLayout;b=(t,z)=>{G.bindVertexBufferLayout(l,C.Default3D,e.buffer,q,t);m.drawArraysInstanced(n.primitiveType,0,f.vertexCount,z-t);G.unbindVertexBufferLayout(l,C.Default3D,e.buffer,q)};f.material.params.transparent&&null!=d?c>k?(y.assert(d>=k&&d<=c,"invalid firstIndex"),b(d,c),b(k,d)):c<k&&(d<=c?(y.assert(0<=d&&d<=c,"invalid firstIndex"),b(d,c),b(k,a),b(0,d)):(y.assert(d>=k&&d<=a,"invalid firstIndex"),b(d,a),b(0,c),b(k,d))):c>k?
b(k,c):c<k&&(b(0,c),b(k,a));l.bindVAO(null)}};B._createClass(h,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlane",get:function(){return this._slicePlane},set:function(a){this._slicePlane=
a}},{key:"intersectionHandlerId",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};this._defaultRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a}},{key:"renderStats",get:function(){const a=this._instanceData.size,b=[];this._levels.forEach((c,e)=>{e=this._defaultRenderInstanceData[e].size+
this._highlightRenderInstanceData[e].size;c=c.triangleCount;b.push({renderedInstances:e,renderedTriangles:e*c,trianglesPerInstance:c})});return{totalInstances:a,renderedInstances:b.reduce((c,e)=>c+e.renderedInstances,0),renderedTriangles:b.reduce((c,e)=>c+e.renderedTriangles,0),levels:b}}},{key:"slots",get:function(){return[4,6]}},{key:"needsHighlight",get:function(){return 0<this._highlightRenderInstanceData.reduce((a,b)=>a+b.size,0)}},{key:"needsUpdates",get:function(){return 0<this._instanceData.size&&
1>this._updateCyclesWithStaticCamera}},{key:"octree",get:function(){this._octree||(this._octree=this.buildOctree());return this._octree}}]);return h}();const A=[],Q=w.create(),r=V.create(),N=T.create(),O=w.create(),P=w.create(),R=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];v.LodComponentData=L;v.LodLevelData=M;v.LodRenderer=fa;v.lodRenderers=A;v.setLevelSelectorFactory=function(h){K=h};Object.defineProperty(v,"__esModule",{value:!0})});