// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/typedArrayUtil ../../../../core/maybe ../../../../core/Error ../../../../core/urlUtils ../../../../core/promiseUtils ../../../../core/Evented ../../../../core/mathUtils ../../../../support/requestUtils ../../../../support/requestImageUtils ./Util ./ContentObject ../../../webgl/capabilities/isWebGL2Context ../../../webgl/Texture ../../../webgl/Util ./glUtil3D ../../../webgl/FramebufferObject ./BasisUtil ./DDSUtil".split(" "),
function(w,x,B,n,k,C,u,v,D,t,E,F,G,q,H,p,I,J,K,y,L){q=function(z){function h(a,c){var b=z.call(this)||this;b.data=a;b.type=4;b.glTexture=null;b.powerOfTwoStretchInfo=null;b.loadingPromise=null;b.loadingController=null;b.events=new D;b.params=c||{};b.params.mipmap=!1!==b.params.mipmap;b.params.noUnpackFlip=b.params.noUnpackFlip||!1;b.params.preMultiplyAlpha=b.params.preMultiplyAlpha||!1;b.params.wrap=b.params.wrap||{s:10497,t:10497};b.params.powerOfTwoResizeMode=b.params.powerOfTwoResizeMode||1;b.estimatedTexMemRequired=
h.estimateTexMemRequired(b.data,b.params);b.startPreload();return b}x._inheritsLoose(h,z);var f=h.prototype;f.startPreload=function(){const a=this.data;k.isNone(a)||(a instanceof HTMLVideoElement?this.startPreloadVideoElement(a):a instanceof HTMLImageElement&&this.startPreloadImageElement(a))};f.startPreloadVideoElement=function(a){u.isBlobProtocol(a.src)||"auto"===a.preload&&a.crossOrigin||(a.preload="auto",a.crossOrigin="anonymous",a.src=a.src)};f.startPreloadImageElement=function(a){u.isDataProtocol(a.src)||
u.isBlobProtocol(a.src)||a.crossOrigin||(a.crossOrigin="anonymous",a.src=a.src)};h.getDataDimensions=function(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a};h.estimateTexMemRequired=function(a,c){if(k.isNone(a))return 0;if(n.isArrayBuffer(a)||n.isUint8Array(a))return c.encoding===h.BASIS_ENCODING?y.estimateBasisTextureMemoryUsage(a):a.byteLength;const {width:b,height:d}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?
h.getDataDimensions(a):c;return(c.mipmap?4/3:1)*b*d*(c.components||4)||0};f.dispose=function(){this.data=void 0};f.createDescriptor=function(a){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.mipmap&&!this.params.disableAnisotropy?a.parameters.maxMaxAnisotropy:void 0}};f.load=function(a,c){if(k.isSome(this.glTexture))return this.glTexture;
if(k.isSome(this.loadingPromise))return this.loadingPromise;const b=this.data;return k.isNone(b)?(this.glTexture=new p(a,this.createDescriptor(a),null),a.bindTexture(this.glTexture,0),this.glTexture):"string"===typeof b?this.loadFromURL(a,c,b):b instanceof Image?this.loadFromImageElement(a,c,b):b instanceof HTMLVideoElement?this.loadFromVideoElement(a,c,b):b instanceof ImageData||b instanceof HTMLCanvasElement?this.loadFromImage(a,b,c):(n.isArrayBuffer(b)||n.isUint8Array(b))&&this.params.encoding===
h.DDS_ENCODING?this.loadFromDDSData(a,b):(n.isArrayBuffer(b)||n.isUint8Array(b))&&this.params.encoding===h.BASIS_ENCODING?this.loadFromBasis(a,b):n.isUint8Array(b)?this.loadFromPixelData(a,b):n.isArrayBuffer(b)?this.loadFromPixelData(a,new Uint8Array(b)):null};f.frameUpdate=function(a,c,b){if(!(this.data instanceof HTMLVideoElement)||k.isNone(this.glTexture)||2>this.data.readyState||b===this.data.currentTime)return b;if(k.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:d,vao:g,sourceTexture:e}=
this.powerOfTwoStretchInfo;e.setData(this.data);this.drawStretchedTexture(a,c,d,g,e,this.glTexture)}else{const {width:d,height:g}=this.data,{width:e,height:l}=this.glTexture.descriptor;d!==e||g!==l?this.glTexture.updateData(0,0,0,Math.min(d,e),Math.min(g,l),this.data):this.glTexture.setData(this.data)}this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap();return this.data.currentTime};f.loadFromDDSData=function(a,c){this.glTexture=L.createDDSTexture(a,this.createDescriptor(a),c,this.params.mipmap);
a.bindTexture(this.glTexture,0);return this.glTexture};f.loadFromBasis=function(a,c){return this.loadAsync(()=>y.createTextureFromBasis(a,this.createDescriptor(a),c).then(b=>this.glTexture=b))};f.loadFromPixelData=function(a,c){G.assert(0<this.params.width&&0<this.params.height);const b=this.createDescriptor(a);b.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408;b.width=this.params.width;b.height=this.params.height;this.glTexture=new p(a,b,c);a.bindTexture(this.glTexture,
0);return this.glTexture};f.loadAsync=async function(a){const c=v.createAbortController();this.loadingController=c;const b=a(c.signal);this.loadingPromise=b;a=()=>{this.loadingController===c&&(this.loadingController=null);this.loadingPromise===b&&(this.loadingPromise=null)};b.then(a,a);return b};f.loadFromURL=function(a,c,b){return this.loadAsync(async d=>{d=await F.requestImage(b,{signal:d});return this.loadFromImage(a,d,c)})};f.loadFromImageElement=function(a,c,b){return b.complete?this.loadFromImage(a,
b,c):this.loadAsync(async d=>{d=await E.loadImageAsync(b,b.src,!1,d);return this.loadFromImage(a,d,c)})};f.loadFromVideoElement=function(a,c,b){return 2<=b.readyState?this.loadFromImage(a,b,c):this.loadFromVideoElementAsync(a,c,b)};f.loadFromVideoElementAsync=function(a,c,b){return this.loadAsync(d=>new Promise((g,e)=>{const l=()=>{b.removeEventListener("loadeddata",r);b.removeEventListener("error",m);k.isSome(A)&&A.remove()},r=()=>{2<=b.readyState&&(l(),g(this.loadFromImage(a,b,c)))},m=M=>{l();e(M||
new C("Failed to load video"))};b.addEventListener("loadeddata",r);b.addEventListener("error",m);const A=v.onAbort(d,()=>m(v.createAbortError()))}))};f.loadFromImage=function(a,c,b){const d=h.getDataDimensions(c);this.params.width=d.width;this.params.height=d.height;const g=this.createDescriptor(a);g.pixelFormat=3===this.params.components?6407:6408;if(this.requiresPowerOfTwo(a,g)&&(!t.isPowerOfTwo(d.width)||!t.isPowerOfTwo(d.height)))return this.glTexture=this.makePowerOfTwoTexture(a,c,d,g,b),a.bindTexture(this.glTexture,
0),this.glTexture;g.width=d.width;g.height=d.height;this.glTexture=new p(a,g,c);a.bindTexture(this.glTexture,0);return this.glTexture};f.requiresPowerOfTwo=function(a,c){const b="number"===typeof c.wrapMode?33071===c.wrapMode:33071===c.wrapMode.s&&33071===c.wrapMode.t;return!H(a.gl)&&(c.hasMipmap||!b)};f.makePowerOfTwoTexture=function(a,c,b,d,g){const {width:e,height:l}=b;b=t.nextHighestPowerOfTwo(e);const r=t.nextHighestPowerOfTwo(l);d.width=b;d.height=r;let m;switch(this.params.powerOfTwoResizeMode){case 2:d.textureCoordinateScaleFactor=
[e/b,l/r];m=new p(a,d);m.updateData(0,0,0,e,l,c);break;case 1:case null:case void 0:m=this.stretchToPowerOfTwo(a,c,d,g);break;default:B.neverReached(this.params.powerOfTwoResizeMode)}d.hasMipmap&&m.generateMipmap();return m};f.stretchToPowerOfTwo=function(a,c,b,d){const g=new p(a,b),e=new K(a,{colorTarget:0,depthStencilTarget:0},g);c=new p(a,{target:3553,pixelFormat:b.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!b.flipped,maxAnisotropy:8,preMultiplyAlpha:b.preMultiplyAlpha},
c);b=J.createQuadVAO(a);this.drawStretchedTexture(a,d,e,b,c,g);this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:b,sourceTexture:c,framebuffer:e}:(b.dispose(!0),c.dispose(),e.detachColorTexture(),a.bindFramebuffer(null),e.dispose());return g};f.drawStretchedTexture=function(a,c,b,d,g,e){a.bindFramebuffer(b);b=a.getViewport();a.setViewport(0,0,e.descriptor.width,e.descriptor.height);e=c.program;a.bindProgram(e);e.setUniform4f("color",1,1,1,1);e.setUniform1i("tex",0);a.bindTexture(g,0);a.bindVAO(d);
a.setPipelineState(c.pipeline);a.drawArrays(5,0,I.vertexCount(d,"geometry"));a.bindFramebuffer(null);a.setViewport(b.x,b.y,b.width,b.height)};f.unload=function(){if(k.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:a,vao:c,sourceTexture:b}=this.powerOfTwoStretchInfo;c.dispose(!0);b.dispose();a.dispose();this.powerOfTwoStretchInfo=this.glTexture=null}k.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null);if(k.isSome(this.loadingController)){const a=this.loadingController;this.loadingPromise=
this.loadingController=null;a.abort()}this.events.emit("unloaded")};x._createClass(h,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"requiresFrameUpdates",get:function(){return this.data instanceof HTMLVideoElement}}]);return h}(q.ContentObject);q.DDS_ENCODING="image/vnd-ms.dds";q.BASIS_ENCODING="image/x.basis";w.Texture=q;Object.defineProperty(w,"__esModule",{value:!0})});