// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/typedArrayUtil ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/property ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/urlUtils ../../../../../core/uuid ../../../../../portal/support/resourceExtension ../../../../../core/arrayUtils ../../../../../core/promiseUtils ../../../../../core/Accessor ../../../../../core/mathUtils ../../../../../chunks/vec3f64 ../../../../../chunks/vec3 ../../../../../chunks/mat4 ../../../../support/WatchUpdatingTracking ../../../../../chunks/mat3f64 ../../../../../chunks/mat4f64 ../../../../../chunks/mat3 ../../../../../chunks/sphere ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject ../Object3D ../GridLocalOriginFactory ../../core/shaderLibrary/attributes/VertexPosition.glsl ../../../../../chunks/vec33 ../../core/util/TwoVectorPosition ../TextureBackedBuffer/BufferManager ../localOriginHelper ../LocalOriginManager ./bufferLayouts ./edgeBufferWriters ./EdgeRenderer ./EdgeWorkerHandle ./strokes ./util".split(" "),
function(v,I,y,ja,P,w,ka,la,B,ma,Q,na,oa,pa,R,S,T,J,F,C,U,V,K,L,G,W,H,M,X,Y,Z,aa,ba,ca,da,ea,z,N,A,fa,ha,r){function ia(x){let t=null,k=null;for(let a=0;a<x.geometries.length;a++){const b=x.geometryRecords[a];if(b.material.supportsEdges){if(!t)t=b.transformation;else if(!R.equals(t,b.transformation))return!1;if(!k&&b.origin)k=b;else if(k&&b.origin&&k.origin.id!==b.origin.id)return!1}}return!0}v.EdgeView=function(x){function t(a){a=x.call(this,a)||this;a.updatingHandles=new V.WatchUpdatingTracking;
a.perObjectData=new Map;a.renderers=new Map;a.localOrigins=new ea.LocalOriginManager(new Y);a.numberOfRenderedEdges=0;a.gpuMemoryUsage=0;a.workerAbort=S.createAbortController();a.tmpModelPosition=F.create();a.tmpCameraPosition=F.create();return a}I._inheritsLoose(t,x);var k=t.prototype;k.initialize=function(){this.worker=new fa(this.scheduler);this.componentColorManager=new ca.BufferManager(this.rctx,2);const a=z.VertexLayout.createBuffer(4);for(let b=0;4>b;b++)a.sideness.set(b,0,0===b||3===b?0:1),
a.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=H.createVertex(this.rctx,35044,a.buffer)};k.destroy=function(){this.destroyed||(this.perObjectData.forEach((a,b)=>{this.perObjectData.delete(b);a.renderables.forEach(c=>{this.removeRenderable(c)})}),this.strokesTexture=w.disposeMaybe(this.strokesTexture),this.componentColorManager=w.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=w.disposeMaybe(this.verticesBufferObject),
this.perObjectData.clear(),this.renderers.clear(),this.updatingHandles.destroy())};k.shouldRender=function(){return 0<this.renderers.size};k.addComponentObject=async function(a,b,c,d,e,f,h,l){if(!this.hasObject(a)){var g;c=new O(new Promise(m=>g=m),c);this.perObjectData.set(a,c);await this.updatingHandles.addPromise(this.addComponentGeometry(b,c,d,e,f,h,l));this.setNeedsRender();g()}};k.addOrUpdateObject3D=async function(a,b,c,d){const e=[];let f;const h=new O(new Promise(g=>f=g)),l=this.perObjectData.get(a);
this.perObjectData.set(a,h);if(c.mergeGeometries&&1<a.geometries.length&&ia(a))e.push(this.addObjectMergedGeometries(a,h,b,c,d));else for(let g=0;g<a.geometries.length;g++){const m=a.geometryRecords[g];m.material.supportsEdges&&e.push(this.addGeometry(a,h,a.geometries[g],m,b[0],c,d))}await this.updatingHandles.addPromise(Promise.all(e));l&&l.waitLoaded(()=>{l.renderables.forEach(g=>this.removeRenderable(g));this.setNeedsRender()},this.updatingHandles);this.setNeedsRender();f()};k.hasObject=function(a){return this.perObjectData.has(a)};
k.updateAllComponentOpacities=async function(a,b){const c=b instanceof Array?d=>b[d]:()=>b;(await this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(d=>{const e=d.components.meta.length;for(let f=0;f<e;f++){const h=c(f),l=d.components.meta[f],g=l.index;l.material.opacity=h;d.components.buffer.textureBuffer.setDataElement(g,1,3,255*h)}this.updateTransparency(d)});this.setNeedsRender()};k.updateAllComponentMaterials=async function(a,b,c,d){const e=a instanceof X.Object3D,f=
!!c.slicePlaneEnabled,h=r.determineRendererType(b),l=A.EdgeRenderer.getKey(h,f,e);(await this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(g=>{if(l!==g.rendererKey){var m=this.renderers.get(g.rendererKey);const n=this.acquireRenderer(h,f,e);m.removeRenderable(g);m.refCount.decrement();g.rendererKey=l;n.addRenderable(g)}for(m=0;m<b.length;m++)g.components.meta[m].material=b[m];d&&this.updateComponentBuffer(g.components);this.updateTransparency(g)});this.setNeedsRender()};
k.updateObjectVisibility=async function(a,b){(await this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(c=>c.visible=b);this.setNeedsRender()};k.removeObject=function(a){const b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),b.waitLoaded(()=>{b.renderables.forEach(c=>this.removeRenderable(c));this.setNeedsRender()},this.updatingHandles))};k.getObjectEntry=async function(a){a=this.perObjectData.get(a);if(!a)throw"no object";await a.loaded;return a};k.removeAll=
function(){this.perObjectData.forEach((a,b)=>this.removeObject(b))};k.render=function(a,b){if(!w.isNone(this.componentColorManager)){this.localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,d=F.create(),e=new ba.TwoVectorPosition,f=new Z.VertexPosition.ViewProjectionTransform,h=K.create();C.set(d,c[3],c[7],c[11]);e.set(d);C.copy(f.worldFromView_TH,e.high);C.copy(f.worldFromView_TL,e.low);G.fromMat4(f.viewFromCameraRelative_RS,a.camera.viewMatrix);U.copy(f.projFromView,
a.camera.projectionMatrix);c=K.create();G.transpose(c,f.viewFromCameraRelative_RS);G.invert(h,c);this.renderers.forEach(n=>{0===n.refCount.value&&(this.renderers.delete(n.key),n.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var l=0,g=0;this.renderers.forEach(n=>n.forEachRenderable(p=>{l+=p.statistics.averageEdgeLength;g++},b));if(0!==g){c=40*l/g;d=r.estimateLengthAtDistance(a.camera.fullViewport[3],a.camera.fovY,1,3.5*a.camera.pixelRatio);var m=
{distanceFalloffFactor:c,minimumEdgeLength:d,transparency:b,viewProjectionTransform:f,transformNormal_ViewFromGlobal:h};this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(n=>{this.renderRegularEdges(n,a,m);this.renderSilhouetteEdges(n,a,m)})}}};k.updateTransparency=function(a){const b=r.determineEdgeTransparency(a.components.meta),c=r.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=
c,this.renderers.get(a.rendererKey).setRenderablesDirty()};k.computeModelTransformWithLocalOrigin=function(a,b,c){a.getCombinedStaticTransformation(b,c);b.origin?this.localOrigins.register(b.origin):(a=C.set(this.tmpModelPosition,c[12],c[13],c[14]),b.origin=this.localOrigins.acquire(a));da.applyToModelMatrix(b.origin.vec3,c);return c};k.updateComponentBuffer=function(a){const {meta:b,buffer:c}=a;for(a=0;a<b.length;a++){var d=b[a].material;const e=b[a].index,f=J.clamp(Math.round(d.size*A.LINE_WIDTH_FRACTION_FACTOR),
0,255),h=J.clamp(d.extensionLength,-A.EXTENSION_LENGTH_OFFSET,255-A.EXTENSION_LENGTH_OFFSET)+A.EXTENSION_LENGTH_OFFSET,l="solid"===d.type?0:1,g=255*d.opacity;d=d.color;c.textureBuffer.setData(e,0,255*d[0],255*d[1],255*d[2],255*d[3]);c.textureBuffer.setData(e,1,f,h,l,g)}};k.createComponentBuffers=function(a){if(w.isNone(this.componentColorManager))return null;const b=[],c=this.componentColorManager.getBuffer(a.length);for(let d=0;d<a.length;d++){const e=a[d],f=c.acquireIndex();b.push({index:f,material:e})}a=
{meta:b,buffer:c};this.updateComponentBuffer(a);return a};k.extractEdges=function(a,b,c,d,e,f=e.length){return this.worker.process({data:b,indices:e,indicesLength:f,writerSettings:a,skipDeduplicate:c},this.workerAbort.signal,d)};k.createEdgeResources=function(a){const b={};if(w.isNone(this.verticesBufferObject))return b;if(0<a.regular.lodInfo.lengths.length){var c=new M(this.rctx,z.EdgeShaderAttributeLocations,{vertices:z.glVertexLayout,instances:N.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,
instances:H.createVertex(this.rctx,35044,a.regular.instancesData.buffer)});b.regular={vao:c,lod:a.regular.lodInfo}}0<a.silhouette.lodInfo.lengths.length&&(c=new M(this.rctx,z.EdgeShaderAttributeLocations,{vertices:z.glVertexLayout,instances:N.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),b.silhouette={vao:c,lod:a.silhouette.lodInfo});return b};k.addGeometry=async function(a,b,c,d,e,f,h){const l=
c.vertexAttributes.get("position"),g=c.indices.get("position");a=this.computeModelTransformWithLocalOrigin(a,d,L.create());return this.addPositionData(b,{position:l,indices:g,modelTransform:a,origin:d.origin},c.edgeIndicesLength,e,f,h)};k.addPositionData=async function(a,b,c,d,e,f=!1){var h=this.createComponentBuffers([d]);if(!(w.isNone(h)||0>=c)){d=this.acquireRenderer(d.type,!!e.slicePlaneEnabled);var {modelTransform:l,origin:g}=b;e=b.indices;b=b.position;var m=b.data.length/b.size,n=z.EdgeInputBufferLayout.createBuffer(m);
for(let u=0;u<m;u++)n.position.set(u,0,b.data[u*b.size]),n.position.set(u,1,b.data[u*b.size+1]),n.position.set(u,2,b.data[u*b.size+2]);r.fillComponenBufferIndices(h.meta,[0,n.componentIndex.count],n.componentIndex);f=await this.updatingHandles.addPromise(this.extractEdges(d.writerSettings,n,!1,f,e,c));var {regular:p,silhouette:q}=this.createEdgeResources(f);c=(p?p.vao.size:0)+(q?q.vao.size:0);h={regular:p,silhouette:q,transform:{modelMatrix:l,origin:g},statistics:{gpuMemoryUsage:c,averageEdgeLength:f.averageEdgeLength},
components:h,visible:!0,edgeTransparency:r.determineEdgeTransparency(h.meta),objectTransparency:r.determineObjectTransparency(h.meta),distanceToCamera:0,rendererKey:d.key};a.renderables.push(h);d.addRenderable(h);this.gpuMemoryUsage+=c}};k.addComponentGeometry=async function(a,b,c,d,e,f,h){const l=this.createComponentBuffers(f);if(!w.isNone(l)){f=r.determineRendererType(f);h=this.acquireRenderer(f,h.slicePlaneEnabled||!1,!1);f=z.EdgeInputBufferLayout.createBuffer(c.count);aa.copy(f.position,c);r.fillComponenBufferIndices(l.meta,
e,f.componentIndex,d);d=await this.updatingHandles.addPromise(this.extractEdges(h.writerSettings,f,!0,!1,d));var {regular:g,silhouette:m}=this.createEdgeResources(d);c=(g?g.vao.size:0)+(m?m.vao.size:0);a={regular:g,silhouette:m,transform:a,statistics:{gpuMemoryUsage:c,averageEdgeLength:d.averageEdgeLength},components:l,visible:!0,edgeTransparency:r.determineEdgeTransparency(l.meta),objectTransparency:r.determineObjectTransparency(l.meta),distanceToCamera:0,rendererKey:h.key};b.renderables.push(a);
h.addRenderable(a);this.gpuMemoryUsage+=c}};k.addObjectMergedGeometries=async function(a,b,c,d,e){var f=new Map,h=0,l=null,g=null;for(var m=0;m<a.geometries.length;m++){var n=a.geometries[m],p=a.geometryRecords[m];p.material.supportsEdges&&(!g&&p.origin&&(g=p),p=n.indices.get("position"),h+=n.edgeIndicesLength,null==l||l===Uint16Array)&&(l=P.isUint16Array(p)?Uint16Array:Uint32Array)}h=h?new l(h):null;l=[];m=0;for(n=0;n<a.geometries.length;n++){p=a.geometries[n];if(!a.geometryRecords[n].material.supportsEdges)continue;
var q=p.vertexAttributes.get("position");const u=p.indices.get("position");let E=f.get(q.data);if(null==E){E=l.length/3;for(let D=0;D<q.data.length;D+=q.size)l.push(q.data[D+0]),l.push(q.data[D+1]),l.push(q.data[D+2]);f.set(q.data,E)}if(u)for(q=0;q<p.edgeIndicesLength;q++)h[m++]=E+u[q]}g=g||a.geometryRecords[0];f=this.computeModelTransformWithLocalOrigin(a,g,L.create());g=g.origin;for(m=0;m<a.geometryRecords.length;m++)a.geometryRecords[m].origin=g;await this.updatingHandles.addPromise(this.addPositionData(b,
{position:{data:l,size:3},indices:h,modelTransform:f,origin:g},h.length,c[0],d,e))};k.acquireRenderer=function(a,b,c=!0){const d=A.EdgeRenderer.getKey(a,b,c);let e=this.renderers.get(d);w.isNone(this.strokesTexture)&&(this.strokesTexture=ha.generateStrokesTexture(this.rctx));e||(e=new A.EdgeRenderer(this.rctx,this.techniqueRepository,{type:a,slicePlaneEnabled:b,strokesTexture:this.strokesTexture,legacy:c}),this.renderers.set(d,e));e.refCount.increment();return e};k.removeRenderable=function(a){const b=
this.renderers.get(a.rendererKey);if(b){b.removeRenderable(a);b.refCount.decrement();a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),a.silhouette.vao.dispose(!1),a.silhouette.vao=null);"origin"in a.transform&&this.localOrigins.release(a.transform.origin);this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}};
k.updateObjectCameraDistances=function(a){a=a.camera.viewInverseTransposeMatrix;C.set(this.tmpCameraPosition,a[3],a[7],a[11]);this.perObjectData.forEach((b,c)=>{c=w.isSome(b.center)?b.center:W.getCenter(c.getBounds());const d=C.distance(c,this.tmpCameraPosition);b.renderables.forEach(e=>e.distanceToCamera=d)})};k.renderRegularEdges=function(a,b,c){a.bindRegularEdges(b,c);a.forEachRenderable(d=>{if(d.visible&&d.regular){var e=r.computeEdgeCount(d.regular.lod.lengths,d.distanceToCamera,c);"origin"in
d.transform&&(b.localViewMatrixForEdges=this.localOrigins.getViewMatrix(d.transform.origin));a.renderRegularEdges(d,b,e);this.numberOfRenderedEdges+=e}},c.transparency)};k.renderSilhouetteEdges=function(a,b,c){a.bindSilhouetteEdges(b,c);a.forEachRenderable(d=>{if(d.visible&&d.silhouette){var e=r.computeEdgeCount(d.silhouette.lod.lengths,d.distanceToCamera,c);"origin"in d.transform&&(b.localViewMatrixForEdges=this.localOrigins.getViewMatrix(d.transform.origin));a.renderSilhouetteEdges(d,b,e);this.numberOfRenderedEdges+=
e}},c.transparency)};I._createClass(t,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"usedMemory",get:function(){return this.gpuMemoryUsage}},{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges}}]);return t}(T);y.__decorate([B.property({constructOnly:!0})],v.EdgeView.prototype,"rctx",void 0);y.__decorate([B.property({constructOnly:!0})],v.EdgeView.prototype,"techniqueRepository",void 0);y.__decorate([B.property({constructOnly:!0})],v.EdgeView.prototype,
"setNeedsRender",void 0);y.__decorate([B.property({constructOnly:!0})],v.EdgeView.prototype,"scheduler",void 0);y.__decorate([B.property({readOnly:!0})],v.EdgeView.prototype,"updatingHandles",void 0);y.__decorate([B.property({readOnly:!0})],v.EdgeView.prototype,"updating",null);v.EdgeView=y.__decorate([Q.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],v.EdgeView);let O=function(){function x(t,k=null){this.center=k;this.renderables=[];this.loaded=t;this.loaded.then(()=>this.loaded=
!0)}x.prototype.waitLoaded=function(t,k){!0===this.loaded?t():k.addPromise(this.loaded.then(()=>t()))};return x}();Object.defineProperty(v,"__esModule",{value:!0})});