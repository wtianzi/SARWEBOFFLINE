// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Logger ../../../../chunks/vec3 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../chunks/vec4 ../../../../support/requestImageUtils ./Util ../../../webgl/Texture ../../../webgl/Util ./glUtil3D ./DefaultTextureUnits ../../../webgl/FramebufferObject ./SSAOTechnique".split(" "),function(z,A,q,r,B,C,w,D,E,x,F,n,y,G,t,u){const H=r.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper");r=
function(){function v(a,b,f){this._enabled=!1;this._BLUR_F=2;this._attenuation=.5;this._radius=3;this._samples=16;this._viewportToRestore=w.create();this.quadVAO=null;this._rctx=b;this._techniqueRep=a;this._requestRender=f;this._ssaoTechniqueConfig=new u.SSAOTechniqueConfiguration;this._emptyTexture=y.createColorTexture(b,[1,1,1,1])}var k=v.prototype;k.dispose=function(){this._emptyTexture.dispose();this._emptyTexture=null;q.isSome(this.quadVAO)&&(this.quadVAO=q.disposeMaybe(this.quadVAO))};k.computeSSAO=
function(a,b,f){if(this._noiseTexture){x.assert(this.enabled);var c=this._rctx,l=a.fullViewport,d=l[2],g=l[3];l=d/this._BLUR_F;var m=g/this._BLUR_F;this._ssaoFBO.resize(d,g);this._blur0FBO.resize(l,m);this._blur1FBO.resize(l,m);l=1*d;m=1*g;c.bindFramebuffer(this._ssaoFBO);D.copy(this._viewportToRestore,a.fullViewport);c.setViewport(0,0,d,g);var e=this._ssaoTechnique.program,h=this._blurTechnique.program;c.bindProgram(e);c.setPipelineState(this._ssaoTechnique.pipeline);e.setUniform2f("rnmScale",d/
this._noiseTexture.descriptor.width,g/this._noiseTexture.descriptor.height);e.setUniform3fv("pSphere",8>=this._samples?this._data.random8:16>=this._samples?this._data.random16:32>=this._samples?this._data.random32:this._data.random64);d=this._data.minDiscrepancy;e.setUniform1f("numSpiralTurns",this._samples<d.length?d[this._samples]:5779);d=I;g=J;x.inverseProjectionInfo(a.projectionMatrix,a.fullWidth,a.fullHeight,d,g);e.setUniform4fv("projInfo",d);e.setUniform2fv("zScale",g);e.setUniform2f("nearFar",
a.near,a.far);d=1/a.computeRenderPixelSizeAtDist(1);e.setUniform1f("projScale",1*d);e.setUniform2f("screenDimensions",l,m);var p=2*this._radius;g=B.distance(a.eye,a.center);p=20*a.computeRenderPixelSizeAtDist(g);p=Math.max(.1,p);e.setUniform1f("radius",p);e.setUniform1f("intensity",4*this._attenuation/p**6);e.setUniform1i("rnm",0);e.setUniform1i("normalMap",1);e.setUniform1i("depthMap",2);c.bindTexture(this._noiseTexture,0);c.bindTexture(f,1);c.bindTexture(b,2);q.isSome(this.quadVAO)||(this.quadVAO=
y.createQuadVAO(this._rctx));b=this.quadVAO;c.bindVAO(b);c.drawArrays(5,0,n.vertexCount(b,"geometry"));c.bindTexture(this._ssaoFBO.colorTexture,0);c.setViewport(0,0,l/this._BLUR_F,m/this._BLUR_F);c.bindFramebuffer(this._blur0FBO);c.bindProgram(h);h.setUniform2f("screenDimensions",l,m);h.setUniform1i("tex",0);h.setUniform1i("normalMap",1);h.setUniform1i("depthMap",2);h.setUniform2f("blurSize",0,1*this._BLUR_F/m);h.setUniform1i("radius",4);h.setUniform1f("g_BlurFalloff",.08);h.setUniform2f("nearFar",
a.near,a.far);5E4<g&&(d=Math.max(0,d-(g-5E4)));h.setUniform1f("projScale",d);h.setUniform2f("zScale",1,0);c.drawArrays(5,0,n.vertexCount(b,"geometry"));h.setUniform2f("blurSize",1*this._BLUR_F/l,0);c.bindFramebuffer(this._blur1FBO);c.bindTexture(this._blur0FBO.colorTexture,0);c.drawArrays(5,0,n.vertexCount(b,"geometry"));c.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}};k.setUniforms=function(a,b){const f=this.enabled&&this._noiseTexture,
c=this._rctx;c.bindTexture(f?this._blur1FBO.colorTexture:this._emptyTexture,b);c.setActiveTexture(0);a.setUniform1i("ssaoTex",b);f?a.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):a.setUniform4f("viewportPixelSz",-1,-1,-1,-1)};k.bindToAllPrograms=function(a){a=a.getProgramsUsingUniform("viewportPixelSz");for(const b of a)this.setUniforms(b,G.DefaultTextureUnits.SSAO)};k.selectPrograms=function(){this._ssaoTechniqueConfig.samples=
8>=this._samples?8:16>=this._samples?16:32>=this._samples?32:64;this._ssaoTechniqueConfig.radius=4;this._ssaoTechniqueConfig.output=0;this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(u.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique);this._ssaoTechniqueConfig.output=1;this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(u.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)};k.enable=function(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources(()=>
{this._enabled&&this.initialize()})):H.warn("SSAO is not supported for this browser or hardware"))};k.loadResources=function(a){this._data?a():(new Promise(function(b,f){z(["./SSAOHelperData"],b,f)})).then(b=>{this._data=b;a()})};k.initialize=function(){const a={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},b={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new t(this._rctx,b,a);this._blur0FBO=new t(this._rctx,b,a);this._blur1FBO=new t(this._rctx,
b,a);E.requestImage(this._data.noiseTexture).then(f=>{this._enabled&&(this._noiseTexture=new F(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:f.width,height:f.height},f),this._requestRender())});this.selectPrograms()};k.disable=function(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&
(this._ssaoFBO.dispose(),this._ssaoFBO=null))};k.getGpuMemoryUsage=function(){return n.getGpuMemoryUsage(this._blur0FBO)+n.getGpuMemoryUsage(this._blur1FBO)+n.getGpuMemoryUsage(this._ssaoFBO)};A._createClass(v,[{key:"isSupported",get:function(){var a=this._rctx;const b=-1!==a.parameters.versionString.indexOf("WebGL 0.93");a=-1!==a.parameters.versionString.indexOf("WebGL 0.94");return!(b||a)}},{key:"enabled",get:function(){return this._enabled},set:function(a){a?this.enable():this.disable()}},{key:"attenuation",
get:function(){return this._attenuation},set:function(a){this._attenuation=a}},{key:"radius",get:function(){return this._radius},set:function(a){this._radius=a}},{key:"filterRadius",get:function(){return 4}},{key:"samples",get:function(){return this._samples},set:function(a){this._samples=a;this._enabled&&this.selectPrograms()}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]);return v}();const J=C.create(),I=w.create();return r});