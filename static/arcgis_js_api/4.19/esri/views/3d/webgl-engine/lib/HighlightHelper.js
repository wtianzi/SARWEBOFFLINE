// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/vec4f64 ../../../../chunks/vec4 ../../../../chunks/vec4f32 ./DefaultVertexAttributeLocations ../../../webgl/BufferObject ../../../webgl/Util ../../../webgl/VertexArrayObject ./DefaultVertexBufferLayouts ./glUtil3D ../../support/debugFlags ../../../webgl/FramebufferObject ../shaders/HighlightTechnique".split(" "),function(v,w,x,q,y,z,m,A,B,C,u,r,n){return function(){function t(a,b){this._rctx=b;this._grid={coverageMipmap:null,
vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};this.quadVAO=C.createQuadVAO(this._rctx);b={colorTarget:0,depthStencilTarget:0,width:0,height:0};const l={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new r(this._rctx,b,l);this.blur1Fbo=new r(this._rctx,b,l);this.viewportToRestore=w.create();this.defaultOptions={color:q.fromValues(1,0,1,1),haloColor:q.fromValues(1,0,1,1),
haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:q.fromValues(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075};b=new n.HighlightCompositionTechniqueConfiguration;b.highlightStage=0;b.gridOptimization=!1;this.blurTechnique=a.acquireAndReleaseExisting(n.HighlightCompositionTechnique,b,this.blurTechnique);b.highlightStage=0;b.gridOptimization=!0;this.blurGridTechnique=a.acquireAndReleaseExisting(n.HighlightCompositionTechnique,b,this.blurGridTechnique);b.highlightStage=
1;b.gridOptimization=!1;this.applyTechnique=a.acquireAndReleaseExisting(n.HighlightCompositionTechnique,b,this.applyTechnique);b.highlightStage=1;b.gridOptimization=!0;this.applyGridTechnique=a.acquireAndReleaseExisting(n.HighlightCompositionTechnique,b,this.applyGridTechnique);b.highlightStage=2;b.gridOptimization=!1;this.downsampleTechnique=a.acquireAndReleaseExisting(n.HighlightCompositionTechnique,b,this.downsampleTechnique)}var p=t.prototype;p.dispose=function(){if(null!=!this.quadVAO){if(this._grid.coverageMipmap)for(let a=
1;a<this._grid.coverageMipmap.length;a++)this._grid.coverageMipmap[a].dispose();this._grid.vao&&this._grid.vao.dispose(!0);this.quadVAO.dispose(!0);this.blur1Fbo.dispose();this.blur0Fbo.dispose();this.blur1Fbo=this.blur0Fbo=this.quadVAO=null}};p.setDefaultOptions=function(a){this.defaultOptions=a};p.render=function(a,b,l){var d=a.pixelRatio;const g=u.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,c=this._rctx;x.copy(this.viewportToRestore,a.fullViewport);var f=Math.ceil(a.fullWidth/d);d=Math.ceil(a.fullHeight/
d);this.blur0Fbo.resize(f,d);this.blur1Fbo.resize(f,d);c.bindVAO(this.quadVAO);let e=a=null;g?(this._gridUpdateResources(b,32),this._gridComputeMipmap(),a=this._grid.vao,e=this.blurGridTechnique,c.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),e.program.setUniform1i("coverageTex",1)):(a=this.quadVAO,e=this.blurTechnique);e.bindPipelineState(c);c.bindProgram(e.program);c.bindVAO(a);c.bindFramebuffer(this.blur0Fbo);c.setViewport(0,0,f,d);c.setClearColor(0,0,0,0);c.clear(16384);
e.program.setUniform1i("tex",0);c.bindTexture(b.colorTexture,0);e.program.setUniform2f("blurSize",1/f,0);c.drawArrays(e.primitiveType,0,m.vertexCount(a,"geometry"));c.bindFramebuffer(this.blur1Fbo);c.clear(16384);c.bindTexture(this.blur0Fbo.colorTexture,0);e.program.setUniform2f("blurSize",0,1/d);c.drawArrays(e.primitiveType,0,m.vertexCount(a,"geometry"));f=g?this.applyGridTechnique:this.applyTechnique;c.bindFramebuffer(l);f.bindPipelineState(c);c.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],
this.viewportToRestore[2],this.viewportToRestore[3]);c.bindProgram(f.program);c.bindTexture(this.blur1Fbo.colorTexture,0);c.bindTexture(b.colorTexture,1);g&&c.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,2);f.bindApplyPass(this.defaultOptions);c.drawArrays(f.primitiveType,0,m.vertexCount(a,"geometry"));c.bindVAO(null)};p._gridUpdateResources=function(a,b){const l=this._rctx,d=this._grid;var g=!1;null===d.coverageMipmap&&(d.coverageMipmap=[a],g=!0);if(d.viewportWidth!==
a.width||d.viewportHeight!==a.height)g=!0,d.viewportWidth=a.width,d.viewportHeight=a.height;d.coverageMipmap[0]=a;d.cellPixelSize!==b&&(d.cellPixelSize=b,g=!0);if(g){for(b=1;b<d.coverageMipmap.length;b++)d.coverageMipmap[b].dispose();d.mipmapLevels=Math.ceil(Math.log(d.cellPixelSize)*Math.LOG2E);d.coverageMipmap.length=d.mipmapLevels+1;for(b=0;b<d.mipmapLevels;b++)g=d.coverageMipmap[b],d.coverageMipmap[b+1]=new r(l,{colorTarget:0,depthStencilTarget:0,width:Math.ceil(g.width/2),height:Math.ceil(g.height/
2)},{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(g.width/2),height:Math.ceil(g.height/2)})}g=Math.ceil(a.height/d.cellPixelSize);var c=Math.ceil(a.width/d.cellPixelSize);if(!d.vao||d.verticalCellCount!==g||d.horizontalCellCount!==c){d.verticalCellCount=g;d.horizontalCellCount=c;a=g+1;b=c+1;g=1/g;c=1/c;const f=new Float32Array(24*a*b);let e=0;for(let h=0;h<a;h++)for(let k=0;k<b;k++)f[e+0]=(k-.5)*c*2-1,f[e+1]=(h-.5)*g*2-1,f[e+2]=k*c,f[e+3]=h*g,f[e+4]=
(k+.5)*c*2-1,f[e+5]=(h-.5)*g*2-1,f[e+6]=k*c,f[e+7]=h*g,f[e+8]=(k-.5)*c*2-1,f[e+9]=(h+.5)*g*2-1,f[e+10]=k*c,f[e+11]=h*g,f[e+12]=(k-.5)*c*2-1,f[e+13]=(h+.5)*g*2-1,f[e+14]=k*c,f[e+15]=h*g,f[e+16]=(k+.5)*c*2-1,f[e+17]=(h-.5)*g*2-1,f[e+18]=k*c,f[e+19]=h*g,f[e+20]=(k+.5)*c*2-1,f[e+21]=(h+.5)*g*2-1,f[e+22]=k*c,f[e+23]=h*g,e+=24;d.vao&&d.vao.dispose(!0);d.vao=new A(l,y.Default3D,{geometry:B.Pos2Tex},{geometry:z.createVertex(l,35044,f)})}};p._gridComputeMipmap=function(){const a=this._rctx,b=this._grid,l=
this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(a);a.bindVAO(this.quadVAO);for(let d=0;d<b.mipmapLevels;d++){a.bindFramebuffer(b.coverageMipmap[d+1]);a.bindTexture(b.coverageMipmap[d].colorTexture,0);const g=b.coverageMipmap[d+1].width,c=b.coverageMipmap[d+1].height;a.bindProgram(l);l.setUniform1i("tex",0);l.setUniform2f("invFramebufferDim",1/g,1/c);a.setViewport(0,0,g,c);a.drawArrays(5,0,m.vertexCount(this.quadVAO,"geometry"))}};p.getGpuMemoryUsage=function(){let a=m.getGpuMemoryUsage(this.blur0Fbo)+
m.getGpuMemoryUsage(this.blur1Fbo);if(this._grid.coverageMipmap)for(const b of this._grid.coverageMipmap)a+=m.getGpuMemoryUsage(b);return a};v._createClass(t,[{key:"profilingCallback",get:function(){return u.HIGHLIGHTS_PROFILE_TO_CONSOLE?a=>console.log(a):null}},{key:"test",get:function(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}]);return t}()});