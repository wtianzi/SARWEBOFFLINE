// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../chunks/vec3f64 ../../../../core/Handles ../../../../core/watchUtils ../../../../chunks/mat4 ../../../../core/MapUtils ../../../../core/TimeProfiler ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ./BoundingInfo ./glUtil3D ./Camera ../../support/debugFlags ./Material ./RenderContext ./rendererUtils ../../../webgl/Measurement ../statistics/RendererPerformanceInfo ../materials/renderers/MergedRenderer ../lighting/SceneLighting ./depthRange ./depthRangeUtils ../core/renderPasses/RenderPassManager ./HighlightHelper ./OffscreenRendering ./RenderPluginManager ./ShadowHighlightHelper ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView".split(" "),
function(E,z,k,F,G,H,m,u,A,p,I,J,K,L,v,B,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,da){z=function(){function w(a,b,c,d,f,e,h,l,x){this._materialRep=a;this._shaderTechniqueRepository=c;this._rctx=d;this._compositingHelper=f;this._magnifierHelper=e;this.requestRender=h;this._stage=x;this._materialRenderers=new Map;this._hasWater=this._hasOccludees=this._hasHighlights=!1;this._camera=new L(F.fromValues(0,100,-100));this._content=new Map;this._isRendering=!1;this._bindParameters={slot:null,camera:null,inverseViewport:I.create(),
shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:new R.SceneLighting};this._fallbackDepthStencilTexture=
null;this.performanceInfo=new P.RendererPerformanceInfo;this._antialiasing=1;this._oitEnabled=!1;this._opaqueTerrain=this._multipassTerrain=!0;this._handles=new G;this.renderHiddenTransparentEdges=()=>{};this._smaaPass=new ba(this._rctx);this._oitEnabled=this._hasOITSupport;this.camera.viewport[2]=l[0];this.camera.viewport[3]=l[1];this.requestRender();this._offscreenRendering=new W.OffscreenRendering(this._rctx,this._compositingHelper);this._sliceHelper=new aa;this._shadowMap=new Z(this._rctx,c.viewingMode,
2);this._ssaoHelper=new ca(c,this._rctx,()=>this.requestRender());this._highlightHelper=new V(c,this._rctx);this._shadowHighlightHelper=new Y(c,this._rctx,0,1);this._renderContext=new M(this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._renderPlugins=new X.RenderPluginManager({renderContext:this._renderContext,shaderTechniqueRep:c,textureRep:b,materialRep:this._materialRep,requestRender:this.requestRender});this.renderPassManager=
new U.RenderPassManager(this._rctx,this._shaderTechniqueRepository);this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager);this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1};this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!0,terrainLinearDepthTexture:null};this._renderContext.multipassGeometryParams=
{multipassGeometryEnabled:!1,geometryLinearDepthTexture:null};this._handles.add(H.init(v,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",y=>{this.renderHiddenTransparentEdges=y?()=>this.renderEdges(1):()=>{};this.requestRender()}))}var g=w.prototype;g.dispose=function(){this._handles.destroy();this._smaaPass.disable();this._materialRenderers.forEach(a=>a.dispose());this._materialRenderers.clear();this._edgeView=k.destroyMaybe(this._edgeView);this._offscreenRendering.dispose();this._fallbackDepthStencilTexture=
k.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap.enabled=!1;this._shadowMap.dispose();this._ssaoHelper.enabled=!1;this._ssaoHelper.dispose();this._highlightHelper.dispose();this._shadowHighlightHelper.dispose();J.BoundingInfo.prune();this._content.clear()};g.ensureEdgeView=function(){k.isNone(this._edgeView)&&(this._edgeView=new da.EdgeView({rctx:this._rctx,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),scheduler:this._stage.scheduler}),
this._handles.add(this._edgeView.watch("updating",()=>this.requestRender(),!0)),this.requestRender());return this._edgeView};g.setLighting=function(a){this._bindParameters.lighting.set(a)};g.setRenderParameters=function(a){const {renderPassManager:b,_shadowMap:c,_ssaoHelper:d}=this;void 0!==a.screenSpaceReflectionsEnabled&&b.screenSpaceReflectionsEnabled!==a.screenSpaceReflectionsEnabled&&(b.screenSpaceReflectionsEnabled=a.screenSpaceReflectionsEnabled,this.requestRender());void 0===a.shadowMap||
c.enabled===a.shadowMap&&b.shadowCastingEnabled===a.shadowMap||(c.enabled=a.shadowMap,b.shadowCastingEnabled=a.shadowMap,this.requestRender());void 0!==a.shadowMapMaxCascades&&c.maxCascades!==a.shadowMapMaxCascades&&(c.maxCascades=a.shadowMapMaxCascades,this.requestRender());void 0!==a.ssao&&d.enabled!==a.ssao&&(d.enabled=a.ssao,this.requestRender());void 0!==a.ssaoAttenuation&&d.attenuation!==a.ssaoAttenuation&&(d.attenuation=a.ssaoAttenuation,this.requestRender());void 0!==a.ssaoRadius&&d.radius!==
a.ssaoRadius&&(d.radius=a.ssaoRadius,this.requestRender());void 0!==a.ssaoSamples&&d.samples!==a.ssaoSamples&&(d.samples=a.ssaoSamples,this.requestRender());a.background&&this._offscreenRendering.background!==a.background&&(this._offscreenRendering.background=a.background,this.requestRender());var f=a.antialiasingEnabled?1:0;void 0!==a.antialiasingEnabled&&this._antialiasing!==f&&(this._antialiasing=f,this.requestRender());void 0!==a.highQualityTransparency&&this._multipassTerrain!==a.highQualityTransparency&&
(this._oitEnabled=(this._multipassTerrain=a.highQualityTransparency)&&this._hasOITSupport,this.requestRender());void 0!==a.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(a.defaultHighlightOptions),this.requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=k.unwrap(a.slicePlane),this.requestRender());f=10<=this._rctx.parameters.maxTextureImageUnits&&a.waterReflectionEnabled;
void 0!==a.waterReflectionEnabled&&this._waterReflectionEnabled!==f&&(this._waterReflectionEnabled=f,this.requestRender());void 0!==a.opaqueTerrain&&this._opaqueTerrain!==a.opaqueTerrain&&(this._opaqueTerrain=a.opaqueTerrain,this.requestRender())};g.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();
case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture;default:return null}};g.modify=function(a){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:b,removes:c,updates:d}=a;if(0!==b.length||0!==c.length||0!==d.length){c.forAll(({id:e})=>this._content.delete(e));b.forAll(e=>this._content.set(e.id,e));var f=!1;N.splitRenderGeometryChangeSetByMaterial(a).forEach((e,
h)=>{let l=this._materialRenderers.get(h);if(!l)if(0<e.adds.length)l=new Q(this._rctx,this._materialRep,h),this._materialRenderers.set(h,l);else return;l.modify(e);l.isEmpty&&(f=!0)});f&&this._materialRenderers.forEach((e,h)=>{e.isEmpty&&(this._materialRenderers.delete(h),e.dispose())});this._hasHighlights=u.someMap(this._materialRenderers,e=>e.hasHighlights);this._hasOccludees=u.someMap(this._materialRenderers,e=>e.hasOccludees);this._hasWater=u.someMap(this._materialRenderers,e=>e.hasWater);this.requestRender()}};
g.updateLogic=function(a){let b=!1;this._materialRenderers.forEach(c=>{c.updateLogic&&(b=c.updateLogic(a)||b)});return b};g.render=function(a,b,c){this._isRendering=!0;this.performanceInfo.prerender(this._rctx);this.setLighting(this._stage.lighting);this._renderContext.hasOccludees=this._hasOccludees;this._renderContext.transparencyPassType=3;this._bindParameters.transparencyPassType=3;const d=this._offscreenRendering;d.needLastFrameColorTexture=this._waterReflectionEnabled;d.advanceCurrentRenderTarget();
const f=this._sliceHelper.plane;c&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);b.setGLViewport(this._rctx);this._renderPlugins.prepareRender(b);this.performanceInfo.advance(0);this._shadowHighlightHelper.setup(b,this._stage.mainLightDirection);this.renderShadowMap(a,b,this._stage.mainLightDirection);this.performanceInfo.advance(1);d.initializeFrame(b);this.ensureBindParameters(b);this.renderLinearDepth();this.performanceInfo.advance(2);this.renderNormal();this.performanceInfo.advance(3);
this.ensureBindParametersSSR();this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(b,d.linearDepthTexture,d.normalTexture);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this.performanceInfo.advance(4);this.performanceInfo.stats.reset();this._renderContext.pass=0;d.bindFramebuffer();this.renderSlot(0);this.renderOpaqueGeometry();this.performanceInfo.advance(5);b=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(b);this.setMultipassFlags(b);this.setTerrainCulling(b);
this.renderEdges(2);this.performanceInfo.advance(6);this.renderHiddenTransparentEdges();this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry();this.performanceInfo.advance(7);this.renderGeometryLinearDepth(b);var e=!1,h=!1;e=this.renderHUDVisibility();b||this.renderInternalSlot(20);this.performanceInfo.advance(9);this.renderEdges(1,b);this.performanceInfo.advance(8);(h=this.renderTransparentTerrain())&&e&&(d.compositeTransparentTerrainOntoHUDVisibility(),
b&&this.renderLineCallouts(0),this.renderHUD(0,d.framebuffer),this.performanceInfo.advance(16));this.performanceInfo.advance(10);this.setTerrainCulling(!1);h&&(d.compositeTransparentTerrainOntoMain(),b&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8)));b&&this.renderLineCallouts(1);
this.setMultipassFlags(!1);d.renderToTargets(()=>{this.renderInternalSlot(8);this.renderSlot(15);this.renderSlot(16)},d.currentColorTarget,d.mainDepth);this.performanceInfo.advance(11);this._renderPlugins.needsLaserlineWithContrastControl&&d.renderTmpAndCompositeToMain(()=>{this.renderSlot(17)},2);this.performanceInfo.advance(12);this.renderOccluded();this.performanceInfo.advance(13);b=(c=!c&&this._magnifierHelper.enabled)&&k.isNone(a)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,
this._offscreenRendering.tmpDepth):a;this._rctx.bindFramebuffer(b);this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0);this.performanceInfo.advance(14);this.renderHUD(1,b);this.performanceInfo.advance(17);this.renderHighlights(b,d.linearDepthTexture);this.performanceInfo.advance(15);c&&this._magnifierHelper.render(this._rctx,this._bindParameters);b!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,
0));this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera);this._sliceHelper.plane=f;this._isRendering=!1;if(this.onPostRender)this.onPostRender();this.performanceInfo.postrender()};g.readDepthPixels=function(a,b,c,d,f){const e=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);this.needsLinearDepth()||(this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(17664,255),this.renderGeometryAndTransparentTerrainPass(2),
this._rctx.gl.flush(),this._rctx.gl.finish());e.readPixels(a,b,c,d,6408,5121,f)};g.setMultipassFlags=function(a){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=a;this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=a};g.setTerrainCulling=function(a){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=a};g.renderSlot=function(a){this._renderContext.slot=
a;return this._renderPlugins.render()};g.renderEdges=function(a,b=!1){const c=this._edgeView;k.isSome(c)&&c.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>c.render(this._bindParameters,a),1,b)};g.renderShadowMap=function(a,b,c){const d=this._shadowMap;if(d.enabled){v.ENABLE_PROFILE_DEPTH_RANGE&&A.begin("depthRange");var f=this.computeDepthRange(b);v.ENABLE_PROFILE_DEPTH_RANGE&&A.end("depthRange");d.prepare(b,c,f);c=d.getCascades();if(this.needsShadowHighlight()){f=this._shadowHighlightHelper;
for(var e=0;e<c.length;++e){var h=c[e];h.camera.setGLViewport(this._rctx);this.ensureCameraBindParameters(h.camera);this.renderGeometryAndTransparentTerrainPass(7);d.takeCascadeSnapshotTo(h,f.highlightShadowMapSlot)}d.clear();for(e=0;e<c.length;++e)h=c[e],h.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(h.camera),this.renderGeometryAndTransparentTerrainPass(6),d.takeCascadeSnapshotTo(h,f.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}else for(f=0;f<c.length;++f)e=
c[f],e.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(e.camera),this.renderGeometryAndTransparentTerrainPass(4);d.finish(a);b.setGLViewport(this._rctx)}d.bindToAllPrograms(this._shaderTechniqueRepository)};g.needsLinearDepth=function(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight()};g.renderLinearDepth=function(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets(()=>this.renderGeometryAndTransparentTerrainPass(2),
this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};g.renderTerrainLinearDepth=function(a){a?(a=this._renderContext.pass,this._renderContext.pass=2,this._offscreenRendering.renderToTargets(()=>this.renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1E10,-1E10,-1E10,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);
this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture};g.renderGeometryLinearDepth=function(a){a?(a=this._renderContext.pass,this._offscreenRendering.renderToTargets(()=>this.renderGeometryPass(2),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=a):this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);
this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture};g.needsNormal=function(){return this._ssaoHelper.enabled};g.renderNormal=function(){this.needsNormal()?this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(3)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};
g.computeDepthRange=function(a){const b=T.depthRangeFromScene(a,this._content,this._stage.layers);S.union(b,this.renderPlugins.queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b};g.renderGeometryAndTransparentTerrainPass=function(a){this._renderContext.pass=a;this.renderGeometryPass(a);this.renderTransparentTerrain()};g.renderGeometryPass=function(a){this._renderContext.pass=a;this.renderOpaqueGeometry();this.renderTransparentGeometry()};g.renderOpaqueGeometry=
function(){this.renderSlot(1);this.renderSlot(2);this.renderInternalSlot(3);this.renderSlot(4);this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this.renderSlot(14)};g.renderTransparentGeometry=function(){this.renderInternalSlot(5);this.renderSlot(6);this._bindParameters.ssaoEnabled&&this._renderContext.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)};g.renderTransparentTerrain=function(){return this.renderSlot(7)};g.renderHUDVisibility=
function(){let a=!1;this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null;a=this.renderInternalSlot(12)});return a};g.renderLineCallouts=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;0===a?this._offscreenRendering.renderToTargets(()=>this.renderInternalSlot(20),
this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20)};g.renderHUD=function(a,b){this._oitEnabled?(this.renderOrderIndependentTransparency(()=>this.renderHUDElements(a),!0),this._rctx.bindFramebuffer(b),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===a?this._offscreenRendering.renderToTargets(()=>this.renderHUDElements(0),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,
void 0,!0,!0):this.renderHUDElements(a)};g.renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(21);this.renderInternalSlot(18);this.renderInternalSlot(19)};g.needsHighlight=function(){return this._hasHighlights||this._renderPlugins.needsHighlight};g.needsShadowHighlight=function(){return this._shadowMap.enabled&&this._shadowHighlightHelper.wouldRender&&this.needsHighlight()};g.renderHighlights=function(a,b){if(this.needsHighlight()){var c=this._highlightHelper,
d=c.profilingCallback&&O.startMeasurement(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;var f=this._offscreenRendering.renderToTargets(()=>{this.renderGeometryAndTransparentTerrainPass(5);this._rctx.clearSafe(256);this.renderHUDElements(2)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this.needsShadowHighlight()&&this._shadowHighlightHelper.render(this._renderContext.camera,b,this._shadowMap,
this._stage.mainLightDirection,f,a);c.render(this._renderContext.camera,f,a);k.isSome(d)&&c.profilingCallback&&d.stop(e=>{c.profilingCallback&&c.profilingCallback(e)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};g.renderOrderIndependentTransparency=function(a,b){const c=f=>{this._renderContext.transparencyPassType=f;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._offscreenRendering.renderOITPass(()=>a(),f,b)},d=this._renderContext.pass;
this._renderContext.pass=1;c(1);this._renderContext.pass=0;c(0);c(2);this._offscreenRendering.compositeTransparentOntoOpaque(b);this._renderContext.transparencyPassType=3;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._renderContext.pass=d};g.renderOccluded=function(){let a=0;this._materialRenderers.forEach((e,h)=>{h&&h.isVisible()&&8===h.renderOccluded&&(a|=h.renderOccluded,q.push(h))});const b=this._offscreenRendering,c=(e,h,l=()=>f(h),x=!0,y=!0)=>{0!==(a&
h)&&(b.renderToTargets(l,b.tmpColor,b.mainDepth,[0,0,0,0],x,y),b.compositeOccludedOntoMain(e))};0!==q.length&&(this.renderInternalSlot(10,q),c(.5,8,()=>this.renderInternalSlot(11,q),!1,!1),q.length=0);this._materialRenderers.forEach((e,h)=>{h&&h.isVisible()&&(4===h.renderOccluded||2===h.renderOccluded||16===h.renderOccluded)&&(a|=h.renderOccluded,r.push(h))});const d=this._renderPlugins.renderOccludedFlags;if(a|=d){var f=e=>{this._renderContext.renderOccludedMask=e;1<d&&this.renderSlot(9);this.renderInternalSlot(3,
r);this.renderInternalSlot(5,r);this.renderInternalSlot(8,r);this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0;c(.5,4,()=>f(4),!0,2);c(.5,2,()=>f(2),!0,2);c(1,16,()=>f(16),!0,2);r.length=0}};g.renderAntiAliasing=function(a,b){if(1===a){if(this._smaaPass.loadResources(()=>this.requestRender()),this._smaaPass.enable())return this._smaaPass.render({colorTexture:b}),!0}else this._smaaPass.disable();return!1};g.ensureCameraBindParameters=function(a){this._renderContext.camera=a;
this._bindParameters.camera=this._renderContext.camera;this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2];this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]};g.ensureBindParameters=function(a){this.ensureCameraBindParameters(a);a=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap;this._bindParameters.shadowMappingEnabled=!!this._renderContext.shadowMap&&this._renderContext.shadowMap.enabled;
this._bindParameters.ssaoEnabled=!!this._renderContext.ssaoHelper&&this._renderContext.ssaoHelper.enabled;this._bindParameters.slicePlane=this._renderContext.sliceHelper&&this._renderContext.sliceHelper.plane;this._bindParameters.hasOccludees=this._renderContext.hasOccludees;this._bindParameters.linearDepthTextureUnit=3;this._bindParameters.lastFrameColorTextureUnit=4;this._renderContext.multipassTerrainParams.camera=this._renderContext.camera;this._bindParameters.hudVisibilityTexture=a?a.hudVisibilityTexture:
null;this._bindParameters.highlightDepthTexture=a&&a.depthTexture||this.getFallbackDepthTexture()};g.ensureBindParametersSSR=function(){this._waterReflectionEnabled?(m.translate(C,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),m.translate(t,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),m.invert(t,t),m.invert(D,this._renderContext.camera.projectionMatrix),m.multiply(n,t,D),m.multiply(n,
C,n),m.multiply(n,this._renderContext.lastFrameCamera.projectionMatrix,n),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=n,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=
this._bindParameters.lastFrameColorTexture=null;this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled};g.renderInternalSlot=function(a,b){const c=0===this._renderContext.pass?this.performanceInfo.stats:null;let d=!1;this._bindParameters.slot=a;k.isSome(b)?b.forEach(f=>{B.materialPredicate(f,this._renderContext)&&(f=this._materialRenderers.get(f),k.isSome(f)&&(d=f.render(a,this._renderContext,this._bindParameters)||d))}):this._materialRenderers.forEach((f,
e)=>{B.materialPredicate(e,this._renderContext)&&(d=f.render(a,this._renderContext,this._bindParameters,c)||d)});return d};g.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=K.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};g.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():
0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};E._createClass(w,[{key:"updating",get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||k.isSome(this._edgeView)&&this._edgeView.updating||!this.isCameraFinal}},{key:"camera",get:function(){return this._camera},set:function(a){this._camera.copyFrom(a);this.requestRender()}},
{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return null===this._bindParameters.reprojectionMat?!0:m.equals(this._bindParameters.reprojectionMat,ea)}},{key:"hasShadowsEnabled",get:function(){var a;return!(null==(a=this._shadowMap)||!a.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"canRender",get:function(){return 0<this._camera.fullWidth&&0<this._camera.fullHeight}},
{key:"_hasOITSupport",get:function(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}},{key:"test",get:function(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper}}}]);
return w}();const r=[],q=[],C=p.create(),D=p.create(),t=p.create(),n=p.create(),ea=p.create();return z});