// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../chunks/mat3f64 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../chunks/vec2 ../../../../chunks/vec4 ./Util ../../../webgl/Texture ../../../webgl/Util ./glUtil3D ./Camera ./DefaultTextureUnits ../../../webgl/FramebufferObject".split(" "),function(na,S,Q,G,E,oa,H,p,W,d,X,t,Y,Z,pa,qa,M,ra){function w(C,
h){d.set(aa,C[h],C[h+3]);return aa}let sa=function(){this.camera=new qa;this.lightMat=H.create()},ua=function(){function C(a,b,e=0){this.rctx=a;this.viewingMode=b;this._enabled=!1;this.snapshots=[];this.maxTextureSize=this.textureSize=0;this.numCascades=1;this.maxNumCascades=4;this.splitSchemeLambda=0;this.warp=!0;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.emptyTexture=pa.createColorTexture(this.rctx,[1,1,1,1]);this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(a=0;4>a;++a)this.cascades.push(new sa);
this.snapshotCount=e}var h=C.prototype;h.dispose=function(){this.emptyTexture.dispose();this.emptyTexture=null;this.discardDepthTexture();this.discardAllSnapshots()};h.getDepthTexture=function(){return this.depthTexture};h.getSnapshot=function(a){return this.snapshots[a]};h.getCascades=function(){for(let a=0;a<this.numCascades;++a)T[a]=this.cascades[a];T.length=this.numCascades;return T};h.prepare=function(a,b,e){t.assert(this.enabled);this.textureSize=this.computeTextureSize(a.fullWidth,a.fullHeight);
this.assertDepthTexture();const {near:f,far:g}=this.clampNearFar(e);this.computeCascadeDistances(g,f);this.setupMatrices(a,b);e=a.viewMatrix;a=a.projectionMatrix;for(let l=0;l<this.numCascades;++l)this.constructCascade(l,a,e,b);this.lastOrigin=null;this.clear()};h.finish=function(a){t.assert(this.enabled);this.rctx.bindFramebuffer(a)};h.bind=function(a,b=M.DefaultTextureUnits.SHADOW_MAP){const e=this.rctx;e.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,b);e.bindProgram(a);a.setUniform1i("uShadowMapTex",
b);this.setUniforms(a)};h.bindToAllPrograms=function(a){a=a.getProgramsUsingUniform("uShadowMapDistance");for(let b=0;b<a.length;b++)this.bind(a[b],M.DefaultTextureUnits.SHADOW_MAP)};h.bindView=function(a,b){if(this.enabled){var e=this.lastOrigin;if(!e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2])for(this.lastOrigin=this.lastOrigin||Q.create(),G.copy(this.lastOrigin,b),e=0;e<this.numCascades;++e){E.translate(ba,this.cascades[e].lightMat,b);for(let f=0;16>f;++f)ca[16*e+f]=ba[f]}a.setUniformMatrix4fv("uShadowMapMatrix",
ca)}};h.setUniforms=function(a){this.rctx.bindProgram(a);a.setUniform1f("uDepthHalfPixelSz",this.enabled?.5/this.textureSize:-1);a.setUniform1i("uShadowMapNum",this.numCascades);a.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],1<this.numCascades?this.cascadeDistances[1]:Infinity,2<this.numCascades?this.cascadeDistances[2]:Infinity,3<this.numCascades?this.cascadeDistances[3]:Infinity)};h.bindSnapshot=function(a,b){this.rctx.bindTexture(this.enabled?this.snapshots[a]:this.emptyTexture,b)};
h.takeCascadeSnapshotTo=function(a,b){t.assert(this.enabled);const e=this.rctx;this.assertSnapshot(b);this.bindFbo();e.bindTexture(this.snapshots[b],M.DefaultTextureUnits.SHADOW_MAP);e.gl.copyTexSubImage2D(3553,0,a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[2],a.camera.viewport[3]);e.bindTexture(null,M.DefaultTextureUnits.SHADOW_MAP)};h.clear=function(){const a=this.rctx;this.bindFbo();a.setClearColor(1,1,1,1);a.clearSafe(16640)};h.computeTextureSize=
function(a,b){return Math.min(this.maxTextureSize,2*2**Math.round(.5*Math.log(a*a+b*b)*Math.LOG2E+.35))};h.assertDepthTexture=function(){if(null==this.depthTexture||this.depthTexture.descriptor.width!==this.textureSize)this.discardDepthTexture(),this.depthTexture=new Y(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize}),this.fbo=new ra(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,
height:this.textureSize},this.depthTexture)};h.assertSnapshot=function(a){const b=this.snapshots[a];if(null===b||b.descriptor.width!==this.textureSize)this.discardSnapshot(a),this.snapshots[a]=new Y(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize})};h.discardDepthTexture=function(){this.fbo&&(this.fbo.dispose(),this.fbo=null);this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)};h.discardSnapshot=
function(a){this.snapshots[a]&&(this.snapshots[a].dispose(),this.snapshots[a]=null)};h.discardAllSnapshots=function(){for(let a=0;a<this.snapshotCount;++a)this.discardSnapshot(a)};h.bindFbo=function(){const a=this.rctx;a.bindFramebuffer(this.fbo);a.bindTexture(null,M.DefaultTextureUnits.SHADOW_MAP)};h.constructCascade=function(a,b,e,f){const g=this.cascades[a];var l=-this.cascadeDistances[a],k=-this.cascadeDistances[a+1];l=(b[10]*l+b[14])/Math.abs(b[11]*l+b[15]);b=(b[10]*k+b[14])/Math.abs(b[11]*k+
b[15]);t.assert(l<b);for(k=0;8>k;++k){X.set(da,0===k%4||3===k%4?-1:1,0===k%4||1===k%4?-1:1,4>k?l:b,1);X.transformMat4(u[k],da,ea);for(let q=0;3>q;++q)u[k][q]/=u[k][3]}G.negate(U,u[0]);E.translate(fa,ha,U);g.camera.viewMatrix=fa;for(l=0;8>l;++l)G.transformMat4(u[l],u[l],g.camera.viewMatrix);G.copy(z,u[0]);G.copy(A,u[0]);for(l=1;8>l;++l)for(b=0;3>b;++b)z[b]=Math.min(z[b],u[l][b]),A[b]=Math.max(A[b],u[l][b]);z[2]-=200;A[2]+=200;g.camera.near=-A[2];g.camera.far=-z[2];this.warp?this.constructTrapezoidalProjection(e,
f,g):this.constructOrthogonalProjection(g);E.multiply(g.lightMat,g.camera.projectionMatrix,g.camera.viewMatrix);e=this.textureSize/2;g.camera.viewport[0]=0===a%2?0:e;g.camera.viewport[1]=0===Math.floor(a/2)?0:e;g.camera.viewport[2]=e;g.camera.viewport[3]=e};h.constructOrthogonalProjection=function(a){E.ortho(a.camera.projectionMatrix,z[0],A[0],z[1],A[1],a.camera.near,a.camera.far)};h.constructTrapezoidalProjection=function(a,b,e){var f=1/u[0][3],g=1/u[4][3];t.assert(f<g);f+=Math.sqrt(f*g);var l=Math.sin(S.acosClamped(a[2]*
b[0]+a[6]*b[1]+a[10]*b[2]));a=u;var k=f/l;b=ia;var q=ja,m=ta;g=ka;f=la;d.set(x,0,0);for(var r=0;4>r;++r)d.add(x,x,a[r]);d.scale(x,x,.25);d.set(I,0,0);for(r=4;8>r;++r)d.add(I,I,a[r]);d.scale(I,I,.25);d.lerp(F[0],a[4],a[5],.5);d.lerp(F[1],a[5],a[6],.5);d.lerp(F[2],a[6],a[7],.5);d.lerp(F[3],a[7],a[4],.5);r=0;var B=d.squaredDistance(F[0],x);for(var y=1;4>y;++y){var J=d.squaredDistance(F[y],x);J<B&&(B=J,r=y)}d.subtract(n,F[r],a[r+4]);r=n[0];n[0]=-n[1];n[1]=r;d.subtract(V,I,x);0>d.dot(V,n)&&d.negate(n,
n);d.lerp(n,n,V,l);d.normalize(n,n);l=r=d.dot(d.subtract(D,a[0],x),n);for(B=1;8>B;++B)y=d.dot(d.subtract(D,a[B],x),n),y<l?l=y:y>r&&(r=y);d.copy(b,x);d.scale(D,n,l-k);d.add(b,b,D);y=-1;J=1;k=B=0;for(let N=0;8>N;++N){d.subtract(O,a[N],b);d.normalize(O,O);const P=n[0]*O[1]-n[1]*O[0];0<P?P>y&&(y=P,B=N):P<J&&(J=P,k=N)}t.verify(0<y,"leftArea");t.verify(0>J,"rightArea");d.scale(K,n,l);d.add(K,K,x);d.scale(L,n,r);d.add(L,L,x);R[0]=-n[1];R[1]=n[0];q=t.rayRay2D(b,a[k],L,d.add(D,L,R),1,q);m=t.rayRay2D(b,a[B],
L,D,1,m);g=t.rayRay2D(b,a[B],K,d.add(D,K,R),1,g);a=t.rayRay2D(b,a[k],K,D,1,f);t.verify(q,"rayRay");t.verify(m,"rayRay");t.verify(g,"rayRay");t.verify(a,"rayRay");m=ia;a=ja;b=ka;g=la;f=e.camera.projectionMatrix;d.subtract(v,b,g);d.scale(v,v,.5);c[0]=v[0];c[1]=v[1];c[2]=0;c[3]=v[1];c[4]=-v[0];c[5]=0;c[6]=v[0]*v[0]+v[1]*v[1];c[7]=v[0]*v[1]-v[1]*v[0];c[8]=1;c[6]=-d.dot(w(c,0),m);c[7]=-d.dot(w(c,1),m);m=d.dot(w(c,0),b)+c[6];q=d.dot(w(c,1),b)+c[7];k=d.dot(w(c,0),g)+c[6];g=d.dot(w(c,1),g)+c[7];m=-(m+k)/
(q+g);c[0]+=c[1]*m;c[3]+=c[4]*m;c[6]+=c[7]*m;m=1/(d.dot(w(c,0),b)+c[6]);q=1/(d.dot(w(c,1),b)+c[7]);c[0]*=m;c[3]*=m;c[6]*=m;c[1]*=q;c[4]*=q;c[7]*=q;c[2]=c[1];c[5]=c[4];c[8]=c[7];c[7]+=1;m=d.dot(w(c,1),a)+c[7];q=d.dot(w(c,2),a)+c[8];k=d.dot(w(c,1),b)+c[7];g=d.dot(w(c,2),b)+c[8];m=-.5*(m/q+k/g);c[1]+=c[2]*m;c[4]+=c[5]*m;c[7]+=c[8]*m;m=d.dot(w(c,1),a)+c[7];q=d.dot(w(c,2),a)+c[8];k=-q/m;c[1]*=k;c[4]*=k;c[7]*=k;f[0]=c[0];f[1]=c[1];f[2]=0;f[3]=c[2];f[4]=c[3];f[5]=c[4];f[6]=0;f[7]=c[5];f[8]=0;f[9]=0;f[10]=
1;f[11]=0;f[12]=c[6];f[13]=c[7];f[14]=0;f[15]=c[8];e.camera.projectionMatrix[10]=2/(z[2]-A[2]);e.camera.projectionMatrix[14]=-(z[2]+A[2])/(z[2]-A[2])};h.setupMatrices=function(a,b){E.multiply(ma,a.projectionMatrix,a.viewMatrix);E.invert(ea,ma);a=1===this.viewingMode?a.eye:G.set(U,0,0,1);E.lookAt(ha,[0,0,0],[-b[0],-b[1],-b[2]],a)};h.clampNearFar=function(a){let {near:b,far:e}=a;2>b&&(b=2);2>e&&(e=2);b>=e&&(b=2,e=4);return{near:b,far:e}};h.computeCascadeDistances=function(a,b){this.numCascades=Math.min(1+
Math.floor(t.logWithBase(a/b,4)),this.maxNumCascades);const e=(a-b)/this.numCascades;a=(a/b)**(1/this.numCascades);let f=b;for(let g=0;g<this.numCascades+1;++g)this.cascadeDistances[g]=S.lerp(f,b,this.splitSchemeLambda),f*=a,b+=e};h.getGpuMemoryUsage=function(){return this.snapshots.reduce((a,b)=>a+Z.getGpuMemoryUsage(b),Z.getGpuMemoryUsage(this.fbo))};na._createClass(C,[{key:"maxCascades",get:function(){return this.maxNumCascades},set:function(a){this.maxNumCascades=S.clamp(Math.floor(a),1,4)}},
{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a;a||(this.discardDepthTexture(),this.discardAllSnapshots())}},{key:"snapshotCount",get:function(){return this.snapshots.length},set:function(a){var b=this.snapshots.length;if(a>b){var e=a-b;this.snapshots.length=a;for(a=0;a<e;++a)this.snapshots[b+a]=null}else if(a<this.snapshotCount){b-=a;for(e=0;e<b;++e)this.discardSnapshot(a+e);this.snapshots.length=a}}},{key:"test",get:function(){const a=this;return{maxNumCascades:this.maxNumCascades,
cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(b){a.splitSchemeLambda=b},get splitSchemeLambda(){return a.splitSchemeLambda},set warp(b){a.warp=b},get warp(){return a.warp}}}}]);return C}();const fa=H.create(),ma=H.create(),ea=H.create(),da=W.create(),u=[];for(let C=0;8>C;++C)u.push(W.create());const z=Q.create(),A=Q.create(),ia=p.create(),ja=p.create(),ta=p.create(),ka=p.create(),la=p.create(),ha=H.create(),U=Q.create(),T=[],ba=H.create(),ca=new Float32Array(64),x=p.create(),
I=p.create(),F=[p.create(),p.create(),p.create(),p.create()],n=p.create(),V=p.create(),D=p.create(),O=p.create(),K=p.create(),L=p.create(),R=p.create(),aa=p.create(),v=p.create(),c=oa.create();return ua});