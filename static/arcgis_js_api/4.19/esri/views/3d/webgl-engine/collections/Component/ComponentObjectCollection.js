// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/Logger ../../../../../chunks/vec3f64 ../../../../../chunks/vec3 ../../../../../chunks/mat3 ../../../../../chunks/vec4 ../../../../../chunks/vec4f32 ../../../../../chunks/mat3f32 ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ../../lib/Util ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ./ComponentData ./interface ../../core/util/BucketedObjectStore ./ComponentObject ../../lib/ComponentUtils ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./Material/ComponentTechnique ./Material/ComponentMaterial ../../core/util/TwoVectorPosition ../../lib/TextureBackedBuffer/BufferManager".split(" "),
function(D,K,p,A,E,q,v,L,M,F,G,N,O,B,P,Q,R,S,r,T,U,H,V,W,X,Y,Z,aa,x,ba,ca){const I=A.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");A=function(){function C(a){this._renderManager=a;this._objects=new T.BucketedObjectStore;this._renderSubmit=new Y.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);this._componentBufferManager=new ca.BufferManager(a.rctx)}var d=C.prototype;d.dispose=function(){O.assert(0===this._objects.count,"ObjectCollection should be empty upon disposal");
this._componentBufferManager.destroy()};d.createObject=function(a){const b=new U;b.toMapSpace=a.toMapSpace.slice();b.transform=a.transform;b.obb=R.clone(a.obb);b.components=new S(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=this._createRenderable(a,b.components);b.intersectionGeometry=new V(a.geometry.positionData,b.components);this._objects.add(a.visible?r.VISIBLE_BIT:0,b);return b};d.destroyObject=function(a){this._objects.remove(a);a.dispose();this._notifyDirty()};d.setObjectVisibility=
function(a,b){b!==a.visible&&(this._objects.updateKey(a,b?a.bucketKey|r.VISIBLE_BIT:a.bucketKey&~r.VISIBLE_BIT),this._notifyDirty())};d.preSubmit=function(a){const b=a.camera.eye;this._objects.forEach((c,e)=>{e&r.VISIBLE_BIT&&c.forEach(l=>{const f=q.squaredDistance(b,l.obb.center);l.renderable.meta.cameraDepthSquared=f})})};d.getMaterial=function(a){return a.renderable.material};d.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};d.setAllComponentVisibilities=
function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};d.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};d.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};d.setComponentData=function(a,b){const c=a.renderable.material;if(r.isVaryingComponentParameters(b)){a=a.components;var e=a.materialDataBuffer;const l=a.materialDataIndices,f={castShadows:!0,
pickable:!0,externalColor:M.create(),externalColorMixMode:1};e=e.textureBuffer;const h=new Uint8Array(4),w=new Uint32Array(h.buffer);let k=0,g=0,n=0,m=!1,t=0;for(let u=0;u<a.count;u++)b(u,f),k+=+(1>f.externalColor[3]),g+=+(3===f.externalColorMixMode&&1===f.externalColor[3]),n+=+f.castShadows,Q.encodeSymbolColor(f.externalColor,f.externalColorMixMode,h),h[2]=h[2]&254|+f.castShadows,e.setData(l[u],0,h[0],h[1],h[2],h[3]),m=m||0<u&&t!==w[0],t=w[0],f.pickable!==H.getVisibility(a.pickability,u)&&(a.pickability=
H.updateVisibilityWithCount(a.pickability,a.count,u,f.pickable));m?(c.componentParameters=new x.ComponentParametersVarying,c.componentParameters.castShadows=n===a.count?0:0===n?2:1,c.componentParameters.transparent=k===a.count?0:0===k?2:1,c.componentParameters.opaqueOverride=g===a.count?0:0===g?2:1,c.componentParameters.texture=e,e.updateTexture()):(c.componentParameters=new x.ComponentParametersUniform,c.componentParameters.castShadows=f.castShadows?0:2,c.componentParameters.externalColor=f.externalColor,
c.componentParameters.externalColorMixMode=f.externalColorMixMode)}else c.componentParameters=new x.ComponentParametersUniform,c.componentParameters.castShadows=b.castShadows?0:2,c.componentParameters.externalColor=b.externalColor,c.componentParameters.externalColorMixMode=b.externalColorMixMode;this._notifyDirty()};d.getComponentAabb=function(a,b,c){return a.intersectionGeometry.getComponentAabb(b,c)};d.getComponentObb=function(a){return a.obb};d.getObjectTransform=function(a){return a.transform};
d.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};d.intersect=function(a,b,c,e,l,f){p.isSome(l)&&(l.localOrigin=a.transform.position);const h=v.invert(J,a.transform.rotationScale);q.sub(y,b,a.transform.position);q.sub(z,c,a.transform.position);q.transformMat3(y,y,h);q.transformMat3(z,z,h);b=v.transpose(J,h);return a.intersectionGeometry.intersect(y,z,e,b,l,f)};d.addEdges=function(a,b,c,e){const {indices:l,positions:f}=a.intersectionGeometry;return b.addComponentObject(a,
a.transform,a.obb.center,f,l,a.components.offsets,c,e)};d.addComponentHighlight=function(a,b){a=a.components;p.isNone(a.highlightCounts)&&(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};d.removeComponentHighlight=function(a,b){a=a.components;if(p.isNone(a.highlightCounts))I.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],e=a.highlightCounts[a.count];0===c?I.warn("Removing non-existing highlight."):
1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=e-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===e?a.highlightCounts=null:a.highlightCounts[a.count]=e-1)}};d.clearHighlights=function(a){a=a.components;p.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};d.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};d._createRenderable=function(a,b){const c=this._renderManager.rctx,e=a.geometry,l=e.vertices.layoutParameters,
f=B.createVertex(c,35044,e.vertices.data),h=p.applySome(e.indices,t=>B.createIndex(c,35044,t));var w=G.glLayout(Z.createVertexBufferLayout(l)),k=new Uint16Array(e.vertices.count);for(var g=0;g<b.count;g++){var n=b.offsets[g],m=b.offsets[g+1];const t=b.materialDataIndices[g];if(p.isSome(e.indices))for(;n<m;n++)k[e.indices[n]]=t;else for(;n<m;n++)k[n]=t}b=B.createVertex(c,35044,k.buffer);g=new ba.TwoVectorPosition(a.transform.position);m=F.clone(a.transform.rotationScale);v.invert(m,m);v.transpose(m,
m);k=new aa.ComponentDrawParameters;q.copy(k.worldFromModel_TL,g.low);q.copy(k.worldFromModel_TH,g.high);v.copy(k.worldFromModel_RS,a.transform.rotationScale);v.copy(k.transformNormal_GlobalFromModel,m);L.copy(k.toMapSpace,a.toMapSpace);a=new x.ComponentMaterial;w=new P(c,a.attributeLocations,{data:w,componentIndices:da},{data:f,componentIndices:b},p.unwrap(h));g=new W;g.material=a;g.drawParameters=k;g.geometry=new X.RenderGeometry(w,e.primitiveType,l,p.isSome(h));g.meta.cameraDepthSquared=.5;g.meta.gpuMemoryEstimate=
f.byteSize+b.byteSize+(p.isSome(h)?h.byteSize:0);return g};d._notifyDirty=function(){this._renderManager.notifyDirty()};K._createClass(C,[{key:"visibleObjects",get:function(){return this._objects.getBucket(r.VISIBLE_BIT)}},{key:"performanceInfo",get:function(){const a=this._objects.getPerformanceInfo(r.VISIBLE_BIT);return{shown:a.added,hidden:a.removed}}}]);return C}();const da=G.glLayout(N.newLayout().u16("componentIndex")),J=F.create(),y=E.create(),z=E.create();D.ComponentObjectCollection=A;Object.defineProperty(D,
"__esModule",{value:!0})});