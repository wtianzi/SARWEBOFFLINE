// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/mat4 ../../../../../core/MapUtils ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../lib/Util ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject ./utils ../../lib/ResizableFloat32Array ../WaterGLMaterial ./Instance ../../statistics/RendererPerformanceInfo".split(" "),function(H,u,B,F,C,I,z,J,K,L,D,M,N,v,G){function O(y,p,c,a){const d=new Map,
e=p.vertexBufferLayout.stride/4,h=(f,l)=>{var b=f.origin;const g=y.get(b.id);let k=d.get(b.id);null==k&&(k={optimalCount:null==g?0:g.optimalCount,sparseCount:null==g?0:g.buffer.size,toAdd:[],toRemove:[],origin:b.vec3},d.set(b.id,k));b=p.elementCount(f.data)*e;l?(k.optimalCount+=b,k.sparseCount+=b,k.toAdd.push(f)):(k.optimalCount-=b,k.toRemove.push(f))};for(const f of c)h(f,!0);for(const f of a)h(f,!1);return d}let R=function(){function y(c,a,d){this.type="MergedRenderer";this._dataByOrigin=new Map;
this._hasOccludees=this._hasHighlights=!1;this._rctx=c;this._material=d;this._materialRep=a;this._glMaterials=D.acquireMaterials(this._material,this._materialRep);this._bufferWriter=d.createBufferWriter()}var p=y.prototype;p.dispose=function(){D.releaseMaterials(this._material,this._materialRep);this._dataByOrigin&&(this._dataByOrigin.forEach(c=>{c.vao.dispose(!0);c.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null);this._glMaterials&&(this._glMaterials.forEach(c=>{c&&c.dispose()}),this._glMaterials.clear(),
this._glMaterials=null)};p.modify=function(c){this.updateGeometries(c.updates);this.addAndRemoveGeometries(c.adds,c.removes);this.updateRenderCommands()};p.addAndRemoveGeometries=function(c,a){const d=this._bufferWriter,e=d.vertexBufferLayout,h=e.stride/4,f=this._dataByOrigin,l=O(f,d,c,a);l.forEach((b,g)=>{l.delete(g);var k=b.optimalCount;const q=b.sparseCount;let n=f.get(g);if(null==n)z.assert(0<k),n=this.createData(e,k,b.origin),f.set(g,n);else if(0===k){n.vao.dispose(!0);n.vao=null;f.delete(g);
return}const t=k<b.sparseCount/2;g=P;const m=n.buffer.size,A=n.buffer.array;k=n.buffer.resize(t?k:q,!1);t||k?this.removeAndRebuild(n,b.toRemove,h,A,g):0<b.toRemove.length?(this.removeByErasing(n,b.toRemove,h,g),0<b.toAdd.length&&(g.end=m)):(g.begin=m,g.end=m);k=Q;z.setMatrixTranslation3(k,-b.origin[0],-b.origin[1],-b.origin[2]);this.append(n,b.toAdd,h,k,g);b=n.vao.vertexBuffers.geometry;if(b.byteSize!==n.buffer.array.buffer.byteLength)b.setData(n.buffer.array);else{const {begin:r,end:w}=g;r<w&&(g=
4*r,b.setSubData(n.buffer.array,g,g,4*w))}n.drawCommandsDirty=!0})};p.updateGeometries=function(c){const a=this._bufferWriter,d=a.vertexBufferLayout.stride/4;for(const f of c){var e=f.updateType;c=f.renderGeometry;const l=this._dataByOrigin.get(c.origin.id),b=l&&l.instances.get(c.id);if(!b)break;e&1&&(b.isVisible=c.instanceParameters.visible);if(e&9){var h=c.instanceParameters.visible;b.hasHighlights=!!c.instanceParameters.highlights&&h}e&16&&(b.hasOccludees=!!c.instanceParameters.occludees);e&6&&
(e=l.buffer.array,h=l.vao,D.calculateTransformRelToOrigin(c,E,x),a.write({transformation:E,invTranspTransformation:x},c.data,a.vertexBufferLayout.createView(e.buffer),b.from),z.assert(b.from+a.elementCount(c.data)===b.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(e,b.from*d*4,b.from*d*4,b.to*d*4));l.drawCommandsDirty=!0}};p.updateRenderCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.hasHiddenInstances=!1;a.hasHighlights=!1;
a.hasOccludees=!1;F.someMap(a.instances,d=>{d.isVisible?(d.hasHighlights&&(this._hasHighlights=!0,a.hasHighlights=!0),d.hasOccludees&&(this._hasOccludees=!0,a.hasOccludees=!0)):a.hasHiddenInstances=!0;return a.hasHiddenInstances&&a.hasHighlights&&a.hasOccludees})});const c=a=>{a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.drawCommandsShadowHighlightRest=null;a.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0};if(0!==a.instances.size)if(a.hasOccludees||
a.hasHighlights||a.hasHiddenInstances){var d=v.sortInstancesAccordingToRange([...a.instances.values()]);a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];a.drawCommandsShadowHighlightRest=[];for(const e of d)e.isVisible&&(e.hasOccludees?v.addOrMerge(a.drawCommandsOccludees,e):v.addOrMerge(a.drawCommandsDefault,e),e.hasHighlights?v.addOrMerge(a.drawCommandsHighlight,e):v.addOrMerge(a.drawCommandsShadowHighlightRest,e));d=e=>{let h=0;for(const f of e)h+=f.count;return h/
3};a.stats={default:d(a.drawCommandsDefault),highlight:d(a.drawCommandsHighlight),occludees:d(a.drawCommandsOccludees),shadowHighlightRest:d(a.drawCommandsShadowHighlightRest)}}else d=4*a.buffer.size/K.getStride(a.vao.layout.geometry),a.drawCommandsDefault=[{first:0,count:d}],a.stats={default:d,highlight:0,occludees:0,shadowHighlightRest:0}};this._dataByOrigin.forEach(a=>{a.drawCommandsDirty&&(c(a),a.drawCommandsDirty=!1)})};p.updateLogic=function(c){return this._material.update(c)};p.render=function(c,
a,d,e){const h=this._rctx,f=this._glMaterials.get(a.pass),l=5===a.pass||7===a.pass,b=6===a.pass,g=!(l||b);let k=c;3===a.pass&&null===k&&(k=22);if(!f||2!==f.ensureResources(h)||null!=k&&!f.beginSlot(k)||l&&!this._hasHighlights)return!1;f.ensureParameters(d);const q=f.getTechnique(),n=f.getPipelineState(k,!1);h.setPipelineState(n);f.bind(h,d);let t=!1;this._dataByOrigin.forEach(m=>{if(!(u.isNone(m.drawCommandsDefault)&&u.isNone(m.drawCommandsHighlight)&&u.isNone(m.drawCommandsOccludees)&&u.isNone(m.drawCommandsShadowHighlightRest)||
l&&!m.hasHighlights)){d.origin=m.origin;q.bindDraw(d);q.ensureAttributeLocations(m.vao);h.bindVAO(m.vao);var A=q.primitiveType,r=l?m.drawCommandsHighlight:b&&(m.hasOccludees||m.hasHighlights||m.hasHiddenInstances)?m.drawCommandsShadowHighlightRest:m.drawCommandsDefault,w=l?m.stats.highlight:b&&(m.hasOccludees||m.hasHighlights||m.hasHiddenInstances)?m.stats.shadowHighlightRest:m.stats.default;u.isSome(r)&&(this.renderCommands(h,A,r),G.addToRenderStats(r.length,w,e),t=!0);g&&(r=m.drawCommandsOccludees,
u.isSome(r)&&(w=f.getPipelineState(k,!0),h.setPipelineState(w),this.renderCommands(h,A,r),h.setPipelineState(n),G.addToRenderStats(r.length,m.stats.occludees,e),t=!0))}});return t};p.renderCommands=function(c,a,d){for(let e=0;e<d.length;e++)c.drawArrays(a,d[e].first,d[e].count)};p.createData=function(c,a,d){return{instances:new Map,vao:new L(this._rctx,this._material.vertexAttributeLocations,{geometry:I.glLayout(c)},{geometry:J.createVertex(this._rctx,35044)}),buffer:new M.ResizableFloat32Array(a),
optimalCount:0,origin:d,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}};p.removeAndRebuild=function(c,a,d,e,h){for(const q of a){a=q.id;const n=c.instances.get(a);c.optimalCount-=(n.to-n.from)*d;c.instances.delete(a)}let f=0;const l=c.buffer.array;h.begin=0;h.end=0;let b=-1,g=-1,k=0;c.instances.forEach(q=>
{const n=q.from*d,t=q.to*d,m=t-n;b!==g&&g!==n?(l.set(e.subarray(b,g),k),k+=g-b,b=n):-1===b&&(b=n);g=t;q.from=f/d;f+=m;q.to=f/d});b!==g&&l.set(e.subarray(b,g),k);h.end=f};p.removeByErasing=function(c,a,d,e){e.begin=Infinity;e.end=-Infinity;let h=-1,f=-1;for(const b of a){a=b.id;var l=c.instances.get(a);const g=l.from*d;l=l.to*d;h!==f&&f!==g?(c.buffer.erase(h,f),h=g):-1===h&&(h=g);f=l;c.instances.delete(a);c.optimalCount-=l-g;g<e.begin&&(e.begin=g);l>e.end&&(e.end=l)}h!==f&&c.buffer.erase(h,f)};p.append=
function(c,a,d,e,h){const f=this._bufferWriter;for(const b of a){var l=u.isSome(b.transformation)?B.multiply(E,e,b.transformation):e;B.invert(x,l);B.transpose(x,x);a=h.end;f.write({transformation:l,invTranspTransformation:x},b.data,f.vertexBufferLayout.createView(c.buffer.array.buffer),h.end/d);l=f.elementCount(b.data)*d;const g=a+l;z.assert(null==c.instances.get(b.id));const k=b.instanceParameters.visible;a=new v.Instance(a/d,g/d,k,!!b.instanceParameters.highlights&&k,!!b.instanceParameters.occludees);
c.instances.set(b.id,a);c.optimalCount+=l;h.end+=l}};H._createClass(y,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&F.someMap(this._glMaterials,c=>c instanceof N.WaterGLMaterial)}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,
glMaterials:this._glMaterials}}}]);return y}();const P={begin:0,end:0},Q=C.create(),E=C.create(),x=C.create();return R});