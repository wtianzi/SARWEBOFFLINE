// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/vec2 ../../support/buffer/InterleavedLayout ../../support/geometryUtils ../lib/Util ../lib/geometryDataUtils ./renderers/utils ../lib/GLMaterial ../lib/Material ./VisualVariableMaterialParameters ../shaders/RibbonLineTechnique".split(" "),function(Z,aa,N,O,P,J,x,l,ia,
ja,m,ka,la,ma,na,ba,oa,Q){function R(B,u,c,a,b){for(let g=0;g<b;g++)c[a++]=B[u++];return a}function S(B,u,c){u=u.get("position").data;c=c?c.get("position"):null;return B.isClosed?c?2<c.length:6<u.length:!1}const pa=O.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");O=function(B){function u(a){a=B.call(this,a,qa)||this;a._vertexAttributeLocations=Q.ribbonVertexAttributeLocations;a.techniqueConfig=new Q.RibbonLineTechniqueConfiguration;a.layout=a.createLayout();return a}aa._inheritsLoose(u,
B);var c=u.prototype;c.isClosed=function(a,b){return this.params.isClosed?b?2<b.length:6<a.length:!1};c.dispose=function(){};c.getPassParameters=function(){return this.params};c.getTechniqueConfig=function(a,b){this.techniqueConfig.output=a;a=N.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.stippleOffColorEnabled=a&&N.isSome(this.params.stippleOffColor);this.techniqueConfig.slicePlaneEnabled=
this.params.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.params.join;this.techniqueConfig.roundCaps="round"===this.params.cap;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled;
this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.params.innerWidth&&N.isSome(this.params.innerColor);this.techniqueConfig.falloffEnabled=0<this.params.falloff;this.techniqueConfig.occluder=8===this.params.renderOccluded;this.techniqueConfig.transparencyPassType=b?b.transparencyPassType:3;this.techniqueConfig.multipassTerrainEnabled=b?b.multipassTerrainEnabled:!1;this.techniqueConfig.cullAboveGround=b?b.cullAboveGround:!0;return this.techniqueConfig};
c.intersect=function(a,b,g,f,d,h,e,k,r){r?this.intersectDrapedLineGeometry(a,f,h,e):this.intersectLineGeometry(a,b,g,f,this.params.width,e)};c.intersectDrapedLineGeometry=function(a,b,g,f){if(b.options.selectionMode){b=a.vertexAttributes.get("position").data;var d=a.vertexAttributes.get("size"),h=this.params.width;this.params.vvSizeEnabled?(d=a.vertexAttributes.get("sizeFeatureAttribute").data[0],h*=P.clamp(this.params.vvSizeOffset[0]+d*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])):
d&&(h*=d.data[0]);d=g[0];g=g[1];a=(h/2+4)*a.screenToWorldRatio;h=Number.MAX_VALUE;for(let p=0;p<b.length-5;p+=3){var e=b[p],k=b[p+1],r=d-e,t=g-k;e=b[p+3]-e;k=b[p+4]-k;const E=P.clamp((e*r+k*t)/(e*e+k*k),0,1);r=e*E-r;t=k*E-t;t=r*r+t*t;t<h&&(h=t)}h<a*a&&f()}};c.intersectLineGeometry=function(a,b,g,f,d,h){if(f.options.selectionMode&&!ma.isInstanceHidden(b))if(ka.isTranslationMatrix(g)){var e=a.vertexAttributes;b=e.get("position").data;if(this.params.vvSizeEnabled){var k=e.get("sizeFeatureAttribute").data[0];
d*=P.clamp(this.params.vvSizeOffset[0]+k*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else e.has("size")&&(d*=e.get("size").data[0]);k=f.camera;var r=ra;ia.copy(r,f.point);d=d*k.pixelRatio/2+4*k.pixelRatio;l.set(M[0],r[0]-d,r[1]+d,0);l.set(M[1],r[0]+d,r[1]+d,0);l.set(M[2],r[0]+d,r[1]-d,0);l.set(M[3],r[0]-d,r[1]-d,0);for(var t=0;4>t;t++)if(!k.unprojectFromRenderScreen(M[t],F[t]))return;m.plane.fromPoints(k.eye,F[0],F[1],T);m.plane.fromPoints(k.eye,F[1],F[2],
U);m.plane.fromPoints(k.eye,F[2],F[3],V);m.plane.fromPoints(k.eye,F[3],F[0],W);t=Number.MAX_VALUE;a=S(this.params,e,a.indices)?b.length-2:b.length-5;for(e=0;e<a;e+=3){v[0]=b[e]+g[12];v[1]=b[e+1]+g[13];v[2]=b[e+2]+g[14];var p=(e+3)%b.length;w[0]=b[p]+g[12];w[1]=b[p+1]+g[13];w[2]=b[p+2]+g[14];if(!(0>m.plane.signedDistance(T,v)&&0>m.plane.signedDistance(T,w)||0>m.plane.signedDistance(U,v)&&0>m.plane.signedDistance(U,w)||0>m.plane.signedDistance(V,v)&&0>m.plane.signedDistance(V,w)||0>m.plane.signedDistance(W,
v)&&0>m.plane.signedDistance(W,w))){k.projectToRenderScreen(v,G);k.projectToRenderScreen(w,H);if(0>G[2]&&0<H[2])l.subtract(D,v,w),p=k.frustum,p=-m.plane.signedDistance(p[4],v)/l.dot(D,m.plane.normal(p[4])),l.scale(D,D,p),l.add(v,v,D),k.projectToRenderScreen(v,G);else if(0<G[2]&&0>H[2])l.subtract(D,w,v),p=k.frustum,p=-m.plane.signedDistance(p[4],w)/l.dot(D,m.plane.normal(p[4])),l.scale(D,D,p),l.add(w,w,D),k.projectToRenderScreen(w,H);else if(0>G[2]&&0>H[2])continue;G[2]=0;H[2]=0;p=m.lineSegment.distance2(m.lineSegment.fromPoints(G,
H,ca),r);p<t&&(t=p,l.copy(da,v),l.copy(ea,w))}}g=f.rayBeginPoint;f=f.rayEndPoint;t<d*d&&(b=Number.MAX_VALUE,m.lineSegment.closestLineSegmentPoint(m.lineSegment.fromPoints(da,ea,ca),m.lineSegment.fromPoints(g,f,sa),I)&&(l.subtract(I,I,g),b=l.length(I),l.scale(I,I,1/b),b/=l.distance(g,f)),h(b,I))}else pa.error("intersection assumes a translation-only matrix")};c.computeAttachmentOrigin=function(a,b){const g=a.vertexAttributes;if(!g)return null;a=a.indices;const f=g.get("position");return la.computeAttachmentOriginLines(f,
a?a.get("position"):null,a&&S(this.params,g,a),b)};c.createLayout=function(){const a=ja.newLayout().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");this.params.vvSizeEnabled?a.f32("sizeFeatureAttribute"):a.f32("size");this.params.vvColorEnabled?a.f32("colorFeatureAttribute"):a.vec4f("color");this.params.vvOpacityEnabled&&a.f32("opacityFeatureAttribute");return a};c.createBufferWriter=function(){return new ta(this.layout,this.params)};c.getGLMaterial=function(a){return 0===
a.output||7===a.output||4===a.output||1===a.output?new ua(a):void 0};c.validateParameterValues=function(a){"miter"!==a.join&&(a.miterLimit=0);this.requiresTransparent(a)&&(a.transparent=!0)};c.requiresTransparent=function(a){return!!(1>(a.color&&a.color[3])||0<a.innerWidth&&this.colorRequiresTransparent(a.innerColor)||a.stipplePattern&&this.colorRequiresTransparent(a.stippleOffColor)||0<a.falloff)};c.colorRequiresTransparent=function(a){return N.isSome(a)&&1>a[3]&&0<a[3]};return u}(ba.Material);let ua=
function(B){function u(a){a=B.call(this,a)||this;a.updateParameters();return a}aa._inheritsLoose(u,B);var c=u.prototype;c.updateParameters=function(a){this.technique=this.techniqueRep.acquireAndReleaseExisting(Q.RibbonLineTechnique,this.material.getTechniqueConfig(this.output,a),this.technique)};c.beginSlot=function(a){return this.technique.configuration.occluder?3===a||10===a||11===a:0===this.output||7===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,a===this.targetSlot):
3===a};c._updateOccludeeState=function(a){a.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:a.hasOccludees})};c.ensureParameters=function(a){0!==this.output&&7!==this.output||this._updateOccludeeState(a);this.updateParameters(a)};c.bind=function(a,b){a.bindProgram(this.technique.program);this.technique.bindPass(a,this.material.getPassParameters(),b)};c.getPipelineState=function(a,b){return this.technique.getPipelineState(a,b)};return u}(na);
const qa={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...ba.materialParametersDefaults,...oa.Default};let ta=function(){function B(c,a){this.params=a;this.numJoinSubdivisions=0;this.vertexBufferLayout=c;switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=
a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=1}}var u=B.prototype;u.isClosed=function(c){return S(this.params,c.vertexAttributes,c.indices)};u.numCapSubdivisions=function(c){if(this.isClosed(c))return 0;switch(this.params.cap){case "butt":return 0;case "square":return 1;case "round":return 3}};u.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};u.elementCount=function(c){var a=2*this.numCapSubdivisions(c)+2,b=c.indices.get("position").length/2+1;const g=this.isClosed(c);
a=g?2:2*a;var f=g?0:1;b=g?b:b-1;if(c.vertexAttributes.has("subdivisions"))for(c=c.vertexAttributes.get("subdivisions").data;f<b;++f)a+=4+2*c[f];else a+=(b-f)*(2*this.numJoinSubdivisions+4);return a+2};u.write=function(c,a,b,g){const f=va,d=wa,h=xa;var e=a.vertexAttributes.get("position").data,k=a.indices&&a.indices.get("position");const r=this.numCapSubdivisions(a);k&&k.length!==2*(e.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");k=null;a.vertexAttributes.has("subdivisions")&&
(k=a.vertexAttributes.get("subdivisions").data);let t=1,p=0;this.params.vvSizeEnabled?p=a.vertexAttributes.get("sizeFeatureAttribute").data[0]:a.vertexAttributes.has("size")&&(t=a.vertexAttributes.get("size").data[0]);let E=[1,1,1,1],fa=0;this.params.vvColorEnabled?fa=a.vertexAttributes.get("colorFeatureAttribute").data[0]:a.vertexAttributes.has("color")&&(E=a.vertexAttributes.get("color").data);let ha=0;this.params.vvOpacityEnabled&&(ha=a.vertexAttributes.get("opacityFeatureAttribute").data[0]);
const X=e.length/3;c=c.transformation;const q=new Float32Array(b.buffer);b=this.vertexBufferLayout.stride/4;let n=g*b;g=n;const y=(C,K,Y,ya,za,Aa,Ba)=>{q[n++]=K[0];q[n++]=K[1];q[n++]=K[2];q[n++]=ya;q[n++]=za;q[n++]=Aa;q[n++]=C[0];q[n++]=C[1];q[n++]=C[2];q[n++]=Y[0];q[n++]=Y[1];q[n++]=Y[2];this.params.vvSizeEnabled?q[n++]=p:q[n++]=t;this.params.vvColorEnabled?q[n++]=fa:(C=Math.min(4*Ba,E.length-4),q[n++]=E[C+0],q[n++]=E[C+1],q[n++]=E[C+2],q[n++]=E[C+3]);this.params.vvOpacityEnabled&&(q[n++]=ha)};n+=
b;l.set(d,e[0],e[1],e[2]);c&&l.transformMat4(d,d,c);if(a=this.isClosed(a)){var z=e.length-3;l.set(f,e[z],e[z+1],e[z+2]);c&&l.transformMat4(f,f,c)}else{l.copy(f,d);l.set(h,e[3],e[4],e[5]);c&&l.transformMat4(h,h,c);for(z=0;z<r;++z){var A=1-z/r;y(f,d,h,A,1,-4,0);y(f,d,h,A,1,4,0)}y(f,d,h,0,0,-4,0);y(f,d,h,0,0,4,0);l.copy(f,d);l.copy(d,h)}A=a?0:1;for(z=a?X:X-1;A<z;A++){var L=(A+1)%X*3;l.set(h,e[L+0],e[L+1],e[L+2]);c&&l.transformMat4(h,h,c);y(f,d,h,0,1,-1,A);y(f,d,h,0,1,1,A);L=k?k[A]:this.numJoinSubdivisions;
for(let C=0;C<L;++C){const K=(C+1)/(L+1);y(f,d,h,K,1,-2,A);y(f,d,h,K,1,2,A)}y(f,d,h,1,0,-2,A);y(f,d,h,1,0,2,A);l.copy(f,d);l.copy(d,h)}if(a)n=R(q,g+b,q,n,2*b);else for(y(f,d,h,0,1,-5,z),y(f,d,h,0,1,5,z),e=0;e<r;++e)k=(e+1)/r,y(f,d,h,k,1,-5,z),y(f,d,h,k,1,5,z);R(q,g+b,q,g,b);n=R(q,n-b,q,n,b)};return B}();const v=x.create(),w=x.create(),D=x.create(),I=x.create(),ra=x.create(),G=J.createRenderScreenPointArray3(),H=J.createRenderScreenPointArray3(),da=x.create(),ea=x.create(),ca=m.lineSegment.create(),
sa=m.lineSegment.create(),va=x.create(),wa=x.create(),xa=x.create(),M=[J.createRenderScreenPointArray3(),J.createRenderScreenPointArray3(),J.createRenderScreenPointArray3(),J.createRenderScreenPointArray3()],F=[x.create(),x.create(),x.create(),x.create()],T=m.plane.create(),U=m.plane.create(),V=m.plane.create(),W=m.plane.create();Z.RibbonLineMaterial=O;Object.defineProperty(Z,"__esModule",{value:!0})});