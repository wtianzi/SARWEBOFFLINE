// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/support/aaBoundingRect ../../../../chunks/mat3f64 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/mat3 ../../../../chunks/vec2 ../../support/buffer/InterleavedLayout ../lib/Util ../lib/geometryDataUtils ./renderers/utils ../lib/screenSizePerspectiveUtils ../../../../core/libs/gl-matrix-2/types/mat4 ../lib/GLMaterialTexture ./internal/MaterialUtil ../lib/Material ./internal/bufferWriterUtils ../../../../chunks/HUDMaterial.glsl ../shaders/HUDMaterialTechnique".split(" "),
function(S,I,M,N,da,C,k,ea,fa,T,U,V,W,ha,ia,ja,ka,la,J,ma,K,na,X,G,Y,L){function oa(q,n,f,a=pa){ha.copy(a,q.anchorPos);a[0]*=-n[0];a[1]*=-n[1];a[0]+=q.screenOffset[0]*f;a[1]+=q.screenOffset[1]*f;return a}function Z(q,n,f,a,c,d,b,g){n=n-c-(0<g[0]?a[0]*g[0]:0);let e=n+a[0]+2*c;f=f-c-(0<g[1]?a[1]*g[1]:0);c=f+a[1]+2*c;b.textureIsSignedDistanceField&&(b=b.distanceFieldBoundingBox,n+=a[0]*b[0],f+=a[1]*b[1],e-=a[0]*(1-b[2]),c-=a[1]*(1-b[3]),n-=d,e+=d,f-=d,c+=d);return q[0]>n&&q[0]<e&&q[1]>f&&q[1]<c}let xa=
function(q){function n(a){a=q.call(this,a,qa)||this;a.techniqueConfig=new L.HUDMaterialTechniqueConfiguration;return a}I._inheritsLoose(n,q);var f=n.prototype;f.getTechniqueConfig=function(a,c){this.techniqueConfig.output=a;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.verticalOffset=!!this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective;this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?
1:0;this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset;this.techniqueConfig.isDraped=this.params.isDraped;this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest;this.techniqueConfig.pixelSnappingEnabled=this.params.pixelSnappingEnabled;this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField;this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled;this.techniqueConfig.vvColor=!!this.params.vvColorEnabled;0===a&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder);
4===a&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion);this.techniqueConfig.depthEnabled=this.params.depthEnabled;this.techniqueConfig.transparencyPassType=c?c.transparencyPassType:3;this.techniqueConfig.multipassGeometryEnabled=c?c.multipassGeometryEnabled:!1;return this.techniqueConfig};f.intersect=function(a,c,d,b,g,e,p,l,h){h?this.intersectDrapedHudGeometry(a,e,p,l):this.intersectHudGeometry(a,c,d,b,p,l)};f.intersectDrapedHudGeometry=function(a,c,d,b){const g=
a.vertexAttributes.get("position"),e=a.vertexAttributes.get("size"),p=this.params,l=Y.calculateAnchorPosForRendering(p);let h=1;var r=1;M.isSome(b)&&(r=b(aa),h=r[0],r=r[5]);h*=a.screenToWorldRatio;r*=a.screenToWorldRatio;b=2*a.screenToWorldRatio;for(let t=0;t<g.data.length/g.size;t++){var v=t*g.size;const D=g.data[v];v=g.data[v+1];const z=t*e.size;A[0]=e.data[z]*h;A[1]=e.data[z+1]*r;let w;p.textureIsSignedDistanceField&&(w=p.outlineSize*a.screenToWorldRatio/2);Z(c,D,v,A,b,w,p,l)&&d()}};f.intersectHudGeometry=
function(a,c,d,b,g,e){if(b.options.selectionMode&&b.options.hud&&!la.isInstanceHidden(c)){c=this.params;var p=1,l=1;W.fromMat4(O,d);if(M.isSome(e)){l=e(aa);p=l[0];l=l[5];{e=O;var h=e[0],r=e[1],v=e[2],t=e[3],D=e[4],z=e[5],w=e[6],m=e[7],x=e[8],B=1/Math.sqrt(h*h+r*r+v*v);const F=1/Math.sqrt(t*t+D*D+z*z),P=1/Math.sqrt(w*w+m*m+x*x);e[0]=h*B;e[1]=r*B;e[2]=v*B;e[3]=t*F;e[4]=D*F;e[5]=z*F;e[6]=w*P;e[7]=m*P;e[8]=x*P}}e=a.vertexAttributes.get("position");h=a.vertexAttributes.get("size");r=a.vertexAttributes.get("normal");
a=a.vertexAttributes.get("auxpos1");ja.assert(3<=e.size);v=b.point;t=b.camera;D=Y.calculateAnchorPosForRendering(c);p*=t.pixelRatio;l*=t.pixelRatio;z="screen"===this.params.centerOffsetUnits;for(w=0;w<e.data.length/e.size;w++)if(m=w*e.size,k.set(u,e.data[m],e.data[m+1],e.data[m+2]),k.transformMat4(u,u,d),m=w*h.size,A[0]=h.data[m]*p,A[1]=h.data[m+1]*l,k.transformMat4(u,u,t.viewMatrix),m=w*a.size,k.set(y,a.data[m+0],a.data[m+1],a.data[m+2]),z||(u[0]+=y[0],u[1]+=y[1],0!==y[2]&&(m=y[2],k.normalize(y,
u),k.subtract(u,u,k.scale(y,y,m)))),m=w*r.size,k.set(H,r.data[m],r.data[m+1],r.data[m+2]),this.normalAndViewAngle(H,O,t,Q),this.applyVerticalOffsetTransformationView(u,Q,t,R),t.applyProjection(u,E),-1<E[0]){m=Math.floor(E[0])+this.params.screenOffset[0];x=Math.floor(E[1])+this.params.screenOffset[1];z&&(m+=y[0],0!==y[1]&&(x+=J.applyScaleFactor(y[1],R.factorAlignment)));J.applyPrecomputedScaleFactor(A,R.factor,A);B=1*t.pixelRatio;let F;c.textureIsSignedDistanceField&&(F=c.outlineSize*t.pixelRatio/
2);Z(v,m,x,A,B,F,c,D)&&(x=b.ray,k.transformMat4(ba,u,ea.invert(ra,t.viewMatrix)),E[0]=v[0],E[1]=v[1],t.unprojectFromRenderScreen(E,u)&&(m=C.create(),k.copy(m,x.direction),B=1/k.length(m),k.scale(m,m,B),x=k.distance(x.origin,u)*B,g(x,m,-1,1,!0,ba)))}}};f.computeAttachmentOrigin=function(a,c){var d=a.vertexAttributes;if(!d)return!1;d=d.get("position");a=a.indices.get("position");return ka.computeAttachmentOriginPoints(d,a,c)};f.createBufferWriter=function(){return new sa(this)};f.normalAndViewAngle=
function(a,c,d,b){ma.isMat4(c)&&(c=W.fromMat4(ta,c));k.transformMat3(b.normal,a,c);k.transformMat4(b.normal,b.normal,d.viewInverseTransposeMatrix);b.cosAngle=k.dot(ca,ua);return b};f.updateScaleInfo=function(a,c,d){const b=this.params;b.screenSizePerspective?J.precomputeScaleFactor(d,c,b.screenSizePerspective,a.factor):(a.factor.scale=1,a.factor.factor=0,a.factor.minPixelSize=0,a.factor.paddingPixels=0);b.screenSizePerspectiveAlignment?J.precomputeScaleFactor(d,c,b.screenSizePerspectiveAlignment,
a.factorAlignment):(a.factorAlignment.factor=a.factor.factor,a.factorAlignment.scale=a.factor.scale,a.factorAlignment.minPixelSize=a.factor.minPixelSize,a.factorAlignment.paddingPixels=a.factor.paddingPixels)};f.applyShaderOffsetsView=function(a,c,d,b,g,e,p){c=this.normalAndViewAngle(c,d,g,Q);this.applyVerticalGroundOffsetView(a,c,g,p);this.applyVerticalOffsetTransformationView(p,c,g,e);this.applyPolygonOffsetView(p,c,b[3],g,p);this.applyCenterOffsetView(p,b,p);return p};f.applyShaderOffsetsNDC=function(a,
c,d,b,g){this.applyCenterOffsetNDC(a,c,d,b);M.isSome(g)&&k.copy(g,b);this.applyPolygonOffsetNDC(b,c,d,b);return b};f.applyPolygonOffsetView=function(a,c,d,b,g){var e=b.aboveGround?1:-1;d=N.sign(d);0===d&&(d=e);e*=d;if(0>=this.params.shaderPolygonOffset)return k.copy(g,a);c=N.clamp(Math.abs(c.cosAngle),.01,1);b=1-Math.sqrt(1-c*c)/c/b.viewport[2];0<e?k.scale(g,a,b):k.scale(g,a,1/b);return g};f.applyVerticalGroundOffsetView=function(a,c,d,b){const g=k.length(a),e=d.aboveGround?1:-1;d=.5*d.computeRenderPixelSizeAtDist(g);
c=k.scale(u,c.normal,e*d);k.add(b,a,c);return b};f.applyVerticalOffsetTransformationView=function(a,c,d,b){const g=this.params;if(!g.verticalOffset||!g.verticalOffset.screenLength){if(g.screenSizePerspective||g.screenSizePerspectiveAlignment){var e=k.length(a);this.updateScaleInfo(b,e,c.cosAngle)}else b.factor.scale=1,b.factorAlignment.scale=1;return a}e=k.length(a);d=na.verticalOffsetAtDistance(d,e,g.verticalOffset,c.cosAngle,g.screenSizePerspectiveAlignment||g.screenSizePerspective);this.updateScaleInfo(b,
e,c.cosAngle);k.scale(c.normal,c.normal,d);return k.add(a,a,c.normal)};f.applyCenterOffsetView=function(a,c,d){const b="screen"!==this.params.centerOffsetUnits;d!==a&&k.copy(d,a);b&&(d[0]+=c[0],d[1]+=c[1],c[2]&&(k.normalize(H,d),k.add(d,d,k.scale(H,H,c[2]))));return d};f.applyCenterOffsetNDC=function(a,c,d,b){const g="screen"!==this.params.centerOffsetUnits;b!==a&&k.copy(b,a);g||(b[0]+=c[0]/d.fullWidth*2,b[1]+=c[1]/d.fullHeight*2);return b};f.applyPolygonOffsetNDC=function(a,c,d,b){const g=this.params.shaderPolygonOffset;
a!==b&&k.copy(b,a);g&&(a=d.aboveGround?1:-1,c=a*N.sign(c[3]),b[2]-=(c||a)*g);return b};f.getGLMaterial=function(a){if(0===a.output||7===a.output)return new va(a);if(4===a.output)return new wa(a)};f.calculateRelativeScreenBounds=function(a,c,d=fa.create()){oa(this.params,a,c,d);d[2]=d[0]+a[0];d[3]=d[1]+a[1];return d};return n}(X.Material);K=function(q){function n(a){a=q.call(this,{...a,...a.material.params})||this;a.updateParameters();return a}I._inheritsLoose(n,q);var f=n.prototype;f.beginSlot=function(a){return a===
(this.material.params.drawInSecondSlot?19:18)};f.updateParameters=function(a){this.updateTexture(this.material.params.textureId);this.selectProgram(a)};f.selectProgram=function(a){this.technique=this.techniqueRep.acquireAndReleaseExisting(L.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output,a),this.technique)};f.ensureParameters=function(a){this.updateParameters(a)};f.bind=function(a,c){a.bindProgram(this.technique.program);this.bindTexture(a,this.technique.program);this.bindTextureScale(a,
this.technique.program);this.technique.bindPass(a,this.material.params,c)};return n}(K);let va=function(q){function n(a){a=q.call(this,a)||this;a.isOcclusionSlot=!1;return a}I._inheritsLoose(n,q);var f=n.prototype;f.beginSlot=function(a){const c=this.material.params.drawInSecondSlot?19:18;if(this.material.params.occlusionTest)return this.isOcclusionSlot=12===a,12===a||a===c;this.isOcclusionSlot=!1;return a===c};f.getTechnique=function(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique};
f.selectProgram=function(a){this.technique=this.techniqueRep.acquireAndReleaseExisting(L.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output,a),this.technique);this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(L.HUDMaterialTechnique,this.material.getTechniqueConfig(6,a),this.occlusionTechnique)};f.bind=function(a,c){const d=this.getTechnique();a.bindProgram(d.program);this.isOcclusionSlot||(this.bindTexture(a,d.program),this.bindTextureScale(a,d.program));d.bindPass(a,
this.material.params,c)};return n}(K),wa=function(q){function n(f){return q.call(this,{...f,output:4})||this}I._inheritsLoose(n,q);return n}(K);const R={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},pa=V.create(),u=C.create(),H=C.create(),E=da.createRenderScreenPointArray3(),ca=C.create(),ba=C.create(),O=T.create(),ta=T.create(),ra=U.create(),y=C.create(),Q={normal:ca,cosAngle:0},aa=U.create(),A=[0,0],ua=C.fromValues(0,
0,1),qa={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,
screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:V.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...X.materialParametersDefaults},ya=ia.newLayout().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");let sa=function(){function q(f){this.material=f;this.vertexBufferLayout=ya}var n=q.prototype;n.allocate=
function(f){return this.vertexBufferLayout.createBuffer(f)};n.elementCount=function(f){return 6*f.indices.get("position").length};n.write=function(f,a,c,d){G.writePosition(a.indices.get("position"),a.vertexAttributes.get("position").data,f.transformation,c.position,d,6);G.writeNormal(a.indices.get("normal"),a.vertexAttributes.get("normal").data,f.invTranspTransformation,c.normal,d,6);var b=a.vertexAttributes.get("uv0").data;if(null==b||4>b.length){b=this.material.params;var g=f=0;var e=b.texCoordScale[0];
b=b.texCoordScale[1]}else f=b[0],g=b[1],e=b[2],b=b[3];e=Math.min(1.99999,e+1);b=Math.min(1.99999,b+1);var p=a.indices.get("position").length,l=c.uv0,h=d;for(var r=0;r<p;++r)l.set(h,0,f),l.set(h,1,g),h+=1,l.set(h,0,e),l.set(h,1,g),h+=1,l.set(h,0,e),l.set(h,1,b),h+=1,l.set(h,0,e),l.set(h,1,b),h+=1,l.set(h,0,f),l.set(h,1,b),h+=1,l.set(h,0,f),l.set(h,1,g),h+=1;G.writeColor(a.indices.get("color"),a.vertexAttributes.get("color").data,4,c.color,d,6);f=a.indices.get("size");g=a.vertexAttributes.get("size").data;
e=f.length;b=c.size;p=d;for(l=0;l<e;++l){h=g[2*f[l]];r=g[2*f[l]+1];for(let v=0;6>v;++v)b.set(p,0,h),b.set(p,1,r),p+=1}a.indices.get("auxpos1")&&a.vertexAttributes.get("auxpos1")&&G.writeBufferVec4(a.indices.get("auxpos1"),a.vertexAttributes.get("auxpos1").data,c.auxpos1,d,6);a.indices.get("auxpos2")&&a.vertexAttributes.get("auxpos2")&&G.writeBufferVec4(a.indices.get("auxpos2"),a.vertexAttributes.get("auxpos2").data,c.auxpos2,d,6)};return q}();S.HUDMaterial=xa;Object.defineProperty(S,"__esModule",
{value:!0})});