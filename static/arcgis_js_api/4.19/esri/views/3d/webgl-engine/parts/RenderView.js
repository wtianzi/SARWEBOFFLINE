// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/scheduling ../../../../core/Accessor ../../../../core/Evented ../../../../layers/support/timeUtils ../../../../core/watchUtils ../../../webgl/context-util ../lib/AutoDisposable ../../../webgl/RenderingContext ../core/shaderTechnique/CommonUniformStore ../core/shaderTechnique/ShaderTechniqueRepository ../lib/GLMaterialRep ../materials/lineStippleUtils ../lib/WebGLDriverTest ../../support/animationUtils ./requireUtils ../statistics/tracer ../collections/Component/ComponentObjectCollection ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/MagnifierHelper ../lib/Renderer ../lib/TextureRepository ../materials/internal/WaterTextureRepository ./ScreenshotManager".split(" "),
function(c,r,f,u,v,w,V,m,W,x,X,Y,Z,y,z,A,B,C,D,g,E,F,G,H,I,t,J,K,n,L,M,N,O,P,Q,R,S){const T=w.getLogger("esri.views.3d.webgl-engine.parts.View");let p=null;c.RenderView=function(q){function l(a){var b=q.call(this,{})||this;b.events=new A;b._stippleTextureRepository=new I.StippleTextureRepository;b.waterTextureRepository=new R.WaterTextureRepository;b._magnifierHelper=new O.MagnifierHelper;b._commonUniformStore=new F.CommonUniformStore;b._componentObjectCollection=null;b._needsUpdate=!0;b._needsRender=
!0;b._idleSuspend=!0;b._logicUpdateLast=0;b._container=a.container;b._initializeContext(a.options);C.init(b.waterTextureRepository,"loadingState",()=>b.setNeedsRender());b._magnifierHelper.events.on("request-render",()=>b.setNeedsRender());b._shaderTechniqueRepository=new G.ShaderTechniqueRepository({rctx:b._rctx,viewingMode:a.options.viewingMode,commonUniformStore:b._commonUniformStore,stippleTextureRepository:b._stippleTextureRepository,waterTextureRepository:b.waterTextureRepository});b._textureRepository=
new Q.TextureRepository(a,b._shaderTechniqueRepository,b._rctx);b._textureRepository.events.on("changed",d=>b.setNeedsRender(d));b._materialRepository=new H(b._textureRepository,b._shaderTechniqueRepository,()=>b.setNeedsRender());b._compositingHelper=new M(b._rctx,b._shaderTechniqueRepository);const h=b._container.getBoundingClientRect();b._renderer=new P(b._materialRepository,b._textureRepository,b._shaderTechniqueRepository,b._rctx,b._compositingHelper,b._magnifierHelper,(d=1)=>b.setNeedsRender(d),
[h.width,h.height],a);b._screenshotManager=new S.ScreenshotManager(b._rctx,(d,k,U)=>b._render(d,k,U),()=>b.setNeedsRender(),a.options.screenshot.renderOverlay,d=>b.events.emit("force-camera-for-screenshot",d));b._registerFrameTask(a);return b}r._inheritsLoose(l,q);var e=l.prototype;e.normalizeCtorArgs=function(){return{}};e.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._shaderTechniqueRepository.dispose();
this._shaderTechniqueRepository=null;t.clearTestWebGLDriver(this._rctx);q.prototype.dispose.call(this);this._rctx=null};e.setNeedsRender=function(a=1){1===a?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};e.evaluateUpdating=function(){return this.needsUpdate||this._renderer.updating||0<this._textureRepository.loadingCount||this.waterTextureRepository.updating||this._magnifierHelper.updating};e.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};
e.setRenderParameters=function(a){void 0!==a.idleSuspend&&this._idleSuspend!==!!a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend,this.setNeedsRender());this._renderer.setRenderParameters(a)};e.has=function(a){switch(a){case 0:return!!this._rctx.capabilities.compressedTextureETC;case 1:return!!this._rctx.capabilities.compressedTextureS3TC;case 2:return!!this._rctx.capabilities.shaderTextureLOD;case 3:return this._renderer.hasShadowsEnabled;default:return!1}};e.modify=function(a){this._renderer.modify(a);
a.clear()};e.takeScreenshot=function(a){return this._screenshotManager.takeScreenshot(a)};e.getMinimalDepthForArea=function(a,b,h,d=80,k=1){a=h.constrainWindowSize(a,b,d*h.pixelRatio,k);p=new Uint8Array(4*a[2]*a[3]);this._renderer.readDepthPixels(a[0],a[1],a[2],a[3],p);b=Number.MAX_VALUE;for(d=0;d<a[2]*a[3];d++)k=N.texure2depth(4*d,p,h.nearFar),b>k&&k!==h.nearFar[0]&&k!==h.nearFar[1]&&(b=k);return b===Number.MAX_VALUE?void 0:b};e.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};
e.hotReloadShaders=async function(){K.removeLoadedShaderModules();await this._shaderTechniqueRepository.hotReload();this.setNeedsRender()};e._registerFrameTask=function(a){const b={viewCamera:this._renderer.camera,frameHasDecorations:!1};let h=!1;this._frameTask=y.addFrameTask({preRender:d=>{h=this.evaluateUpdating();n.begin();a.commitDirtyLayers();var k=B.Milliseconds(d.time-this._logicUpdateLast);k>J.DESIRED_ANIMATION_MS&&(k={camera:this._renderer.camera,dt:k},this._logicUpdateLast=d.time,this._renderer.updateLogic(k)&&
this.setNeedsRender(0))},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsUpdate=this._needsRender=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{h===this.updating&&h===this.evaluateUpdating()||this.notifyChange("updating");n.end()},update:()=>{b.viewCamera=this._renderer.camera;b.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(b)}})};
e._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const b=n.instrumentContext(D.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,powerPreference:"high-performance"},a.renderContext));this._rctx=new E(b,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||
{}});t.testWebGLDriver(this._rctx);null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8));this._loadShaderOnlyExtensions(this._rctx);!a.alpha&&this._rctx.contextAttributes.alpha&&T.error("WebGL context has alpha channel even though no alpha channel was requested");!this._rctx.contextAttributes.alpha&&11<=u("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas)};e._render=
function(a,b,h){this._renderer.render(a,b,h)};e._loadShaderOnlyExtensions=function(a){a=a.capabilities;a.enable("standardDerivatives");a.enable("shaderTextureLOD");a.enable("textureFloat")};r._createClass(l,[{key:"performanceInfo",get:function(){const a=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==a.getUsedTextureMemory?a.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==a.getUsedRenderbufferMemory?a.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==
a.getUsedVBOMemory?a.getUsedVBOMemory():void 0}}},{key:"canRender",get:function(){return this._renderer.canRender}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(a){this._magnifierHelper.magnifier=
a}},{key:"renderingContext",get:function(){return this._rctx}},{key:"camera",get:function(){return this._renderer.camera},set:function(a){this._renderer.camera=a}},{key:"canvas",get:function(){return this._canvas}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){v.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new L.ComponentObjectCollection(this._renderer.renderPassManager));
return this._componentObjectCollection},set:function(a){this._componentObjectCollection=a}}]);return l}(g.AutoDisposableMixin(z));f.__decorate([m.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"]})],c.RenderView.prototype,"updating",null);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_rctx",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_container",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_canvas",
void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_stippleTextureRepository",void 0);f.__decorate([g.autoDispose(),m.property()],c.RenderView.prototype,"waterTextureRepository",void 0);f.__decorate([g.autoDispose(),m.property()],c.RenderView.prototype,"_magnifierHelper",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_textureRepository",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_commonUniformStore",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,
"_compositingHelper",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_renderer",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_screenshotManager",void 0);f.__decorate([g.autoDispose()],c.RenderView.prototype,"componentObjectCollection",null);f.__decorate([g.autoDispose()],c.RenderView.prototype,"_componentObjectCollection",void 0);c.RenderView=f.__decorate([x.subclass("esri.views.3d.webgl-engine.parts.RenderView")],c.RenderView);Object.defineProperty(c,"__esModule",
{value:!0})});