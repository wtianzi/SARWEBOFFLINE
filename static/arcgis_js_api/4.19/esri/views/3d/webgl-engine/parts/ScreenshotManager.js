// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../../../support/screenshotUtils ../lib/AutoDisposable ../../../webgl/FramebufferObject".split(" "),function(p,r,t,u,v,l,m,w){m=function(q){function n(b,c,a,d=null,f,k=!0){var e=q.call(this)||this;e._rctx=b;e._renderScene=c;e._requestRenderScene=a;e._renderOverlay=d;e.forceCameraHook=f;e.supersample=k;e._screenshotQueue=[];return e}r._inheritsLoose(n,q);var h=
n.prototype;h.dispose=function(){this._rctx=null};h.takeScreenshot=function(b){this._requestRenderScene();const c=u.createResolver();this._screenshotQueue.push({settings:b,resolver:c});return c.promise};h.update=function(b){if(0!==this._screenshotQueue.length){for(const a of this._screenshotQueue){if(this.isDisposed){a.resolver.reject();continue}var c={...a.settings,pixelRatio:a.settings.pixelRatio*b.viewCamera.pixelRatio};const d=this._ensureScreenshotEncodeCanvas(),f=this._renderScreenshot(b,c);
c=l.encodeResult(f,c,d,{flipY:!0,premultipliedAlpha:!0});a.resolver(c)}this._screenshotQueue=[]}};h._renderScreenshotOverlay=function(b,c,a){if(!t.isNone(this._renderOverlay)){b.width=c.width;b.height=c.height;var d=b.getContext("2d"),f=a.pixelRatio;d.save();d.translate(0,c.height);d.scale(1,-1);a.region&&d.translate(-a.region.x,-a.region.y);d.scale(f,f);this._renderOverlay(b,c);d.restore()}};h._readbackScreenshot=function(b){return b.resample?this._readbackScreenshotResampled(b):this._readbackScreenshotImmediate(b)};
h._readbackScreenshotResampled=function(b){const {framebufferWidth:c,framebufferHeight:a,region:d,resample:f}=b,k=this._ensureScreenshotEncodeCanvas(),e=l.createEmptyImageData(c,a,k);this._rctx.gl.readPixels(0,0,c,a,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(k,e,{...b,region:null});b=l.createEmptyImageData(d.width,d.height,k);return l.resampleHermite(e,b,!0,f.region.x,a-(f.region.y+f.region.height),f.region.width,f.region.height)};h._readbackScreenshotImmediate=function(b){const {framebufferHeight:c,
region:a}=b,d=this._ensureScreenshotEncodeCanvas(),f=l.createEmptyImageData(a.width,a.height,d);this._rctx.gl.readPixels(a.x,c-(a.y+a.height),a.width,a.height,6408,5121,new Uint8Array(f.data.buffer));this._renderScreenshotOverlay(d,f,b);return f};h._renderScreenshot=function(b,c){var a=null;const d=b.viewCamera,{framebufferWidth:f,framebufferHeight:k}=c;var e=!1;b=c.disableDecorations&&b.frameHasDecorations;var g=c.ignorePadding&&d.pixelRatio!==c.pixelRatio;if(b=f!==d.fullWidth||k!==d.fullHeight||
b||g){g=d.clone();if(c.ignorePadding){a=v.clone(g.padding);for(e=0;4>e;e++)a[e]=Math.round(a[e]/g.pixelRatio*c.pixelRatio);g.padding=a}g.fullWidth=f;g.fullHeight=k;g.pixelRatio=c.pixelRatio;a=d.fovX-g.fovX;e=d.fovY-g.fovY;0>a&&a<e?g.fovX=d.fovX:0>e&&e<a&&(g.fovY=d.fovY);this.forceCameraHook(g);e=!0;a=new w(this._rctx,{width:g.fullWidth,height:g.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(a,g,c.disableDecorations)}c=this._readbackScreenshot(c);if(b&&!this._rctx.contextAttributes.alpha)for(b=
3;b<c.data.length;b+=4)c.data[b]=255;a&&a.dispose();this._rctx.bindFramebuffer(null);e&&this.forceCameraHook(d);return c};h._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return n}(m.AutoDisposable);p.ScreenshotManager=m;Object.defineProperty(p,"__esModule",{value:!0})});