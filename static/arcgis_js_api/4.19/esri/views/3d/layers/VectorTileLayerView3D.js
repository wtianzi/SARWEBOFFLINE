// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/watchUtils ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/style/StyleRepository ../terrain/terrainUtils ./LayerView3D ./TiledLayerView3D ../../layers/LayerView ../../2d/engine/vectorTiles/TileHandler3D ../../2d/engine/vectorTiles/VTLPainter3D".split(" "),
function(p,e,c,m,U,V,f,W,E,X,Y,Z,n,F,G,q,H,I,J,K,r,t){c=function(u){function g(a){return u.call(this,a)||this}p._inheritsLoose(g,u);var v=g.prototype;v.initialize=function(){var a=this._getTileInfoSupportError(H.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,this.layer.fullExtent);if(a)this.addResolvingPromise(Promise.reject(a));else{var {basemapTerrain:w,spatialReference:L,pixelRatio:x}=this.view;a=F.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{var b=
w.tilingScheme,d=b.pixelSize;this.schemaHelper=new G(d,L.isGeographic);d=256===d?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;if(b=this._getTileInfoCompatibilityError(d,b))throw b;this._set("tileInfo",d)});this._tileHandlerController=n.createAbortController();var {memoryController:M,scheduler:y}=this.view.resourceController;this._memCache=M.getMemCache(this.layer.uid,b=>b.release());var {style:N,spriteUrl:O,glyphsUrl:P}=
this.layer.currentStyleInfo,h=new q(N,{spriteUrl:O,glyphsUrl:P}),z=w.mapTileRequester;this.tileHandler=new r(this.layer,h,x,this._memCache,z);var A=this._tileHandlerController.signal;h=this.tileHandler.start({signal:A,scheduler:y});var B=this.tileHandler.spriteMosaic;B.then(b=>{!n.isAborted(A)&&this.tileHandler&&(this.painter=new t(b,this.tileHandler.glyphMosaic))});h.then(()=>this._tileHandlerController=null);var D=()=>{this._tileHandlerController&&this._tileHandlerController.abort();this._tileHandlerController=
n.createAbortController();this._memCache.clear();const {style:b,spriteUrl:d,glyphsUrl:Q}=this.layer.currentStyleInfo;var k=new q(b,{spriteUrl:d,glyphsUrl:Q});const l=new r(this.layer,k,x,this._memCache,z);k=l.start({signal:this._tileHandlerController.signal,scheduler:y});const R=l.spriteMosaic;k.then(()=>this._tileHandlerController=null);this.updatingHandles.addPromise(Promise.all([k,R]).then(([,S])=>{const T=this.tileHandler,C=this.painter;this.painter=new t(S,l.glyphMosaic);this.tileHandler=l;this.emit("data-changed");
T.destroy();C&&C.dispose()}))};this.updatingHandles.add(this,"layer.currentStyleInfo",D);this.updatingHandles.add(this,"view.pixelRatio",D);a=Promise.all([a,h,B]);this.addResolvingPromise(a)}};v.destroy=function(){this.painter=m.disposeMaybe(this.painter);this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null);m.destroyMaybe(this.tileHandler);this._memCache=m.destroyMaybe(this._memCache);this.tileHandler=null};p._createClass(g,[{key:"dataLevelRange",get:function(){var a=
this.tileInfo.lods;a=this.levelRangeFromScaleRange(a[0].scale,a[a.length-1].scale);1===a.minLevel&&256===this.tileInfo.size[0]&&(a.minLevel=0);return a}}]);return g}(J.TiledLayerView3D(I.LayerView3D(K)));e.__decorate([f.property({aliasOf:"layer.fullExtent"})],c.prototype,"fullExtent",void 0);e.__decorate([f.property()],c.prototype,"layer",void 0);e.__decorate([f.property()],c.prototype,"tileInfo",void 0);e.__decorate([f.property()],c.prototype,"dataLevelRange",null);e.__decorate([f.property()],c.prototype,
"updatingProgressValue",void 0);return c=e.__decorate([E.subclass("esri.views.3d.layers.VectorTileLayerView3D")],c)});