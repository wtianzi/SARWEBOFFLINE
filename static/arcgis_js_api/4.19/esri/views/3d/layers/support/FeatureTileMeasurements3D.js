// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/screenUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/support/aaBoundingRect ../../support/geometryUtils ../../webgl-engine/lib/Camera ./FeatureTileVisibility3D".split(" "),function(x,k,l,A,d,t,F,G){let E=function(){function B(a){this.camera=new F;this.focusOnMap=[0,0];this.screenRect=d.create();this.tileSize=a.tileSize;this.maxVerticalScreenSize=a.maxVerticalScreenSize;this.renderCoordsHelper=a.renderCoordsHelper;this.tilingScheme=a.tilingScheme;
this.visibility=new G(a.renderCoordsHelper)}var f=B.prototype;f.begin=function(a,c,b){this.camera.copyFrom(a);this.surfaceElevation=b;this.focusOnMap[0]=c.x;this.focusOnMap[1]=c.y;d.fromValues(0,0,a.fullWidth,a.fullHeight,this.screenRect);this.visibility.begin(this.camera,b)};f.end=function(){this.visibility.end()};f.updateTile=function(a){a.measures.visibility=this.visibility.calculate(a);a.measures.distance=d.distance(a.extent,this.focusOnMap);0!==a.measures.visibility&&this.updateScreenMeasure(a)};
f.updateScreenMeasure=function(a){const c=a.measures.screenRect;d.empty(c);let b=0;const g=a.lij[0]+2,m=a.lij[1]<<2,e=a.lij[2]<<2;var u=this.tileSizeWithBias(a);u*=u;var v=!1;for(let y=0;4>y;y++){for(let z=0;4>z&&!(v=this.computeScreenArea(a,g,m+y,e+z,c),b+=v.area,v=b>u&&d.height(c)>this.maxVerticalScreenSize);z++);if(v)break}a.measures.shouldSplit=b>u};f.tileSizeWithBias=function(a){return 1===a.measures.visibility?5*this.tileSize:this.tileSize};f.computeScreenArea=function(a,c,b,g,m){const e=w.points;
this.projectToScreen(c,b,g,1===a.measures.visibility,e);d.empty(n);for(a=0;4>a;a++)d.expandPointInPlace(n,e[a]);d.expand(m,n);d.intersection(n,this.screenRect,C);w.screenOverlap=d.area(C)/d.area(n);w.area=t.triangle.areaPoints2d(e[0],e[1],e[2])+t.triangle.areaPoints2d(e[0],e[2],e[3]);return w};f.projectToScreen=function(a,c,b,g,m){this.tilingScheme.ensureMaxLod(a);this.tilingScheme.getExtent(a,c,b,p);this.toRenderCoords(p,0,3,h[0]);this.toRenderCoords(p,2,3,h[1]);this.toRenderCoords(p,2,1,h[2]);this.toRenderCoords(p,
0,1,h[3]);g&&(this.projectToPlane(h,this.camera.frustum[4]),this.projectToPlane(h,this.camera.frustum[3]),this.projectToPlane(h,this.camera.frustum[2]));for(a=0;4>a;a++)this.camera.projectToRenderScreen(h[a],D),this.camera.renderToScreen(D,m[a])};f.projectToPlane=function(a,c){for(var b=0;4>b;b++)q[b]=t.plane.signedDistance(c,a[b]);b=Math.max(q[0],q[1],q[2],q[3]);if(0<b)for(c=A.scale(r,t.plane.normal(c),-b),b=0;4>b;b++)A.add(a[b],a[b],c)};f.toRenderCoords=function(a,c,b,g){r[0]=a[c];r[1]=a[b];r[2]=
this.surfaceElevation;this.renderCoordsHelper.toRenderCoords(r,this.tilingScheme.spatialReference,g);return g};return B}();const n=d.create(),C=d.create(),w={points:[k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray()],area:0,screenOverlap:0},p=d.create(),r=l.create(),h=[l.create(),l.create(),l.create(),l.create()],q=[0,0,0,0],D=k.createRenderScreenPointArray3();x.FeatureTileMeasurements3D=E;x.default=E;Object.defineProperty(x,"__esModule",{value:!0})});