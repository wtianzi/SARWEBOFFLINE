// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/compilerUtils ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/watchUtils ../../layers/RefreshableLayerView ../../../layers/graphics/hydratedFeatures ./LayerView3D ./support/layerViewUpdatingProperties ../../layers/LayerView ../../layers/FeatureLayerView ../../../layers/graphics/controllers/FeatureTileController3D ../support/EventedSet ./FeatureLikeLayerView3D ./support/FeatureTileFetcher3DLayerViewContext".split(" "),
function(p,g,e,r,n,H,I,h,J,t,u,K,L,M,v,w,x,y,z,A,B,C,D,E,F){e=function(l){function m(a){a=l.call(this,a)||this;a._controllerTotal=0;a._graphicsCoreTotal=0;a.suspendResumeExtentMode="data";return a}p._inheritsLoose(m,l);var d=m.prototype;d.initialize=function(){this.updatingHandles.add(this,"view.floors",()=>this.graphics3d.filterVisibility.filterChanged())};d.destroy=function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)};d.fetchPopupFeatures=async function(a,b){return(a=
this.validateFetchPopupFeatures(b))?Promise.reject(a):this.fetchClientPopupFeatures(b)};d.setVisibility=function(a,b){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(a,b)};d.createQuery=function(){return l.prototype.createQuery.call(this)};d.queryFeatures=function(a,b){const c=()=>l.prototype.queryFeatures.call(this,a,b);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(a),c):c()};d.beforeSetController=function(a){a.maximumNumberOfFeatures=this.maximumNumberOfFeatures};
d.createController=function(){this.fetcherContext=new F.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const a=new C({layerView:this,context:this.fetcherContext,graphics:new D.EventedSet,extent:this.clippingExtent});this.updatingHandles.add(a,"serviceDataExtent",b=>{this.graphics3d&&(this.graphics3d.dataExtent=b)},2);this.handles.add(v.init(this,"suspended",b=>{b?a.suspend():a.resume()},!0));this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",
()=>this.updateDisplayFeatureLimit(a),2);this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",()=>this.updateDisplayFeatureLimit()));return a};d.doRefresh=async function(){!this.suspended&&this.controller&&this.controller.refetch()};d.getUsedMemory=function(){const a=this.graphics3d&&this.graphics3d.graphicsCore;return(a?a.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)};d.getUnloadedMemory=function(){const a=this.graphics3d&&this.graphics3d.graphicsCore;
return(a?a.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*a.usedMemoryPerGraphic:0)};d.ignoresMemoryFactor=function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride};d.updateDisplayFeatureLimit=function(a=this.controller){if(a&&this.graphics3d&&this.graphics3d.graphicsCore){var b=this.graphics3d.graphicsCore.displayFeatureLimit,c=this.view.resourceController.memoryController.memoryFactor;a.displayFeatureLimit=1===c?b:{...b,maximumNumberOfFeatures:Math.ceil(b.maximumNumberOfFeatures*
c),maximumTotalNumberOfFeatures:Math.ceil(b.maximumTotalNumberOfFeatures*c),minimumTotalNumberOfFeatures:Math.ceil(b.minimumTotalNumberOfFeatures*c)}}};d._queryFeaturesMesh=async function(a,b){await this._validateQueryFeaturesMesh(a);b=await b();if(a&&a.outStatistics)return b;a=this.layer.objectIdField;const c=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,f=[];for(const k of b.features)if(k.geometry){const q=c.get(k.attributes[a]);q&&(k.geometry=x.hydrateGeometry(q.graphic.geometry),f.push(k))}else f.push(k);
b.features=f;return b};d._validateQueryFeaturesMesh=async function(a){if(a){var b=f=>{throw new u("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${f}'`);},c=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const f of c)null!=a[f]&&b(f);"returnM"in a&&a.returnM&&b("returnM");"returnCentroid"in a&&a.returnCentroid&&b("returnCentroid");n.isSome(a.outSpatialReference)&&!a.outSpatialReference.equals(this.view.spatialReference)&&
b("outSpatialReference")}};p._createClass(m,[{key:"updatingProgressValue",get:function(){let a=1;if(this.controller&&this.controller.updating){var b=this.controller.updatingRemaining,c=this.controller.updatingTotal;0<c&&(this._controllerTotal=Math.max(c,this._controllerTotal),a=(c-b)/c)}b=1;if(this.graphics3d&&this.graphics3d.graphicsCore){c=this.graphics3d.graphicsCore.updatingRemaining;const f=this.graphics3d.graphicsCore.updatingTotal;0<f&&(this._graphicsCoreTotal=Math.max(f,this._graphicsCoreTotal),
b=(f-c)/f)}1===a&&1===b&&(this._graphicsCoreTotal=this._controllerTotal=0);return.5*(a+b)}},{key:"maximumNumberOfFeatures",get:function(){var a,b;return null!=(a=null==(b=this.controller)?void 0:b.maximumNumberOfFeatures)?a:this._get("maximumNumberOfFeatures")},set:function(a){this._set("maximumNumberOfFeatures",a);this.controller&&(this.controller.maximumNumberOfFeatures=a)}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):
!1}},{key:"asyncGraphicsUpdates",get:function(){if(this.controller)switch(this.controller.mode){case "snapshot":{const a=G[this.layer.geometryType];return null==a||this.controller.serviceDataCount>a}case "tiles":break;default:r.neverReached(this.controller.mode)}return!0}},{key:"hasZ",get:function(){const a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsZ?"returnZ"in a&&null!=a.returnZ?a.returnZ:b.supportsZ:!1}},{key:"hasM",get:function(){const a=this.layer,b=a.capabilities&&
a.capabilities.data;return b&&b.supportsM?"returnM"in a&&null!=a.returnM?a.returnM:!1:!1}},{key:"performanceInfo",get:function(){var a=this.controller&&this.controller.displayFeatureLimit;a=n.isSome(a)&&a.averageSymbolComplexity;a=n.isSome(a)?`f:${a.primitivesPerFeature},v:${a.primitivesPerCoordinate}`:"n/a";a={...this._getResourceInfo(),storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:a,nodes:this.controller?
this.controller.tileDescriptors.length:0};if(this.controller&&a.displayedNumberOfFeatures){const b=this.controller.debug;a.storedFeatures=b.storedFeatures;a.totalVertices=b.totalVertices}return a}}]);return m}(w.RefreshableLayerView(E.FeatureLikeLayerView3D(B.FeatureLayerView(y.LayerView3D(A)))));g.__decorate([h.property()],e.prototype,"layer",void 0);g.__decorate([h.property()],e.prototype,"controller",void 0);g.__decorate([h.property({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal",
"graphics3d.graphicsCore.updatingRemaining","graphics3d.graphicsCore.updatingTotal"]})],e.prototype,"updatingProgressValue",null);g.__decorate([h.property()],e.prototype,"maximumNumberOfFeatures",null);g.__decorate([h.property()],e.prototype,"maximumNumberOfFeaturesExceeded",null);g.__decorate([h.property(z.updatingProgress)],e.prototype,"updatingProgress",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"asyncGraphicsUpdates",null);g.__decorate([h.property({readOnly:!0})],e.prototype,
"hasZ",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"hasM",null);g.__decorate([h.property()],e.prototype,"suspendResumeExtentMode",void 0);e=g.__decorate([t.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],e);const G={point:5E3,polygon:500,polyline:1E3};return e});