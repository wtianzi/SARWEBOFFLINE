// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../Color ../../../../core/screenUtils ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/projection ../../../../chunks/mat4f64 ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ./graphicUtils ./elevationAlignmentUtils ./ElevationAligners ./ElevationContext ./primitiveObjectSymbolUtils ../../webgl-engine/lib/lodRendering/LodResources ./symbolComplexity ./Graphics3DSymbolLayer ./pointUtils ../../webgl-engine/materials/DefaultMaterial ../support/FastSymbolUpdates ../../../../symbols/support/symbolLayerUtils3D ./Graphics3DLodInstanceGraphicLayer ./lodResourceUtils ./objectResourceUtils ../../webgl-engine/lib/lodRendering/LodRenderer".split(" "),
function(O,S,f,P,T,Z,m,t,G,U,V,y,u,C,Q,aa,ba,W,x,ca,H,I,da,z,J,ea,X,fa,ha){H=function(K){function L(b,a,c,d){b=K.call(this,b,a,c,d)||this;b._resources=null;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;b.hasLoadedPBRTextures=!1;b.ensureDrapedStatus(!1);b.hasLoadedPBRTextures=c.physicalBasedRenderingEnabled;return b}S._inheritsLoose(L,K);var h=L.prototype;h.getCachedSize=function(){const [b,a,c]=f.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:b,depth:a,height:c}};
h.doLoad=async function(b){if(!this._drivenProperties.size&&C.validateSymbolLayerSize(this.symbolLayer))throw Error();const a=this.symbolLayer;this._resources=this.isPrimitive?this._createResourcesForPrimitive(a.resource?a.resource.primitive:Z.defaultPrimitive):await this._createResourcesForUrl(a.resource.href,b);this.complexity=this.computeComplexity()};h.setMaterialTransparencyParams=function(b,a=f.get(this.symbolLayer,"material","color")){a=this._getCombinedOpacity(a);b.transparent=1>a||this.needsDrivenTransparentPass;
b.opacity=a;return b};h._createResourcesForPrimitive=function(b){if(!W.isValidPrimitive(b))throw Error(`Unknown object symbol primitive: ${b}`);var a=this.symbolLayer;const c=u.create(J.objectSymbolLayerPrimitiveBoundingBox(b)),d=m.fromArray(u.size(c)),e=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(d,a)),k=t.length(e);var g={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:m.ONES,diffuse:m.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,
sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const q=g.usePBR;this.setMaterialTransparencyParams(g);var l=this.symbol;if("point-3d"===l.type&&l.verticalOffset){const {screenLength:n,minWorldLength:D,maxWorldLength:r}=l.verticalOffset;g.verticalOffset={screenLength:T.pt2px(n),minWorldLength:D||0,maxWorldLength:null!=r?r:Infinity};g.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(g.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);
this._drivenProperties.color?g.externalColor=y.ONES:(a=f.isSome(a.material)&&a.material.color,a=f.isSome(a)?P.toUnitRGBA(a):y.ONES,g.externalColor=a);this._fastUpdates=z.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(c,e,d,f.none));this._fastUpdates.enabled?(Object.assign(g,this._fastUpdates.materialParameters),g.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(g.instanced.push("color"),this._optionalFields.push("color"));
g=new da.DefaultMaterial(g);g=W.primitiveLodResources(b,g);if(!g)throw Error(`Unknown object symbol primitive: ${b}`);b=x.materialsFromLodResources(g).map(n=>({opacity:1,transparent:n.params.transparent}));a=this._createStageResources(g,q);l=this._createLodRenderer(g);return{lodResources:g,lodRenderer:l,stageResources:a,symbolSize:e,extentPadding:k,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:b,physicalBasedRenderingEnabled:q,resourceBoundingBox:c,resourceSize:d,dispose:f.none,pivotOffset:f.none}};
h._createResourcesForUrl=async function(b,a){var c=["transformation"],d={materialParamsMixin:{instanced:c,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=z.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(f.none,f.none,f.none,f.none));this._fastUpdates.enabled?(Object.assign(d.materialParamsMixin,
this._fastUpdates.materialParameters),c.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.push("color"),this._optionalFields.push("color"));c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const {screenLength:p,minWorldLength:A,maxWorldLength:E}=c.verticalOffset;d.materialParamsMixin.verticalOffset={screenLength:T.pt2px(p),minWorldLength:A||0,maxWorldLength:null!=E?E:Infinity};d.materialParamsMixin.castShadows=!1}d.signal=a;d.usePBR=this._context.physicalBasedRenderingEnabled;
a=d.usePBR;var e=await fa.fetch(b,d);b=e.isEsriSymbolResource;d=e.isWosr;c=e.remove;const k=X.makeLodResources(e.lods);X.fillEstimatedMinScreenSpaceRadius(k);k.levels.sort((p,A)=>p.minScreenSpaceRadius-A.minScreenSpaceRadius);k.levels[0].minScreenSpaceRadius=Math.min(2,k.levels[0].minScreenSpaceRadius);const g=this._context,q=this._getExternalColorParameters(this.symbolLayer.material);var l=f.get(this.symbolLayer,"material","color");const n=this._getCombinedOpacity(l,{hasIntrinsicColor:!0}),D=this.needsDrivenTransparentPass;
var r=x.materialsFromLodResources(k);l=x.materialsFromLodResources(k).map(p=>{p=p.params;return{opacity:p.opacity||1,transparent:p.transparent}});r.forEach(p=>{const A=p.params;p.setParameterValues(q);const E=A.opacity*n;p.setParameterValues({opacity:E,transparent:1>E||D||A.transparent});g.screenSizePerspectiveEnabled&&p.setParameterValues({screenSizePerspective:g.sharedResources.screenSizePerspectiveSettings})});e=e.referenceBoundingBox;const v=m.fromArray(u.size(e)),w=m.fromArray(k.levels[0].pivotOffset),
F=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(v,this.symbolLayer)),ia=t.length(F);z.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(e,F,v,w))&&r.forEach(p=>p.setParameterValues(this._fastUpdates.materialParameters));r=this._createStageResources(k,a);const ja=this._createLodRenderer(k);return{lodResources:k,lodRenderer:ja,stageResources:r,symbolSize:F,extentPadding:ia,isEsriSymbolResource:b,isWosr:d,originalMaterialParameters:l,physicalBasedRenderingEnabled:a,
resourceBoundingBox:e,resourceSize:v,dispose:c,pivotOffset:w}};h._createStageResources=function(b,a){const c=this._context.stage,d=x.materialsFromLodResources(b);a!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();c.addMany(d);a=x.texturesFromLodResources(b);c.addMany(a);b=x.geometriesFromLodResources(b);c.addMany(b);return{materials:d,textures:a,geometries:b}};h._createLodRenderer=function(b){const a=this._context.stage;b=new ha.LodRenderer(b,this._optionalFields,
{layerUid:this._context.layer.uid,graphicUid:c=>this._instanceIndexToGraphicUid.get(c),notifyGraphicGeometryChanged:c=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(c)),notifyGraphicVisibilityChanged:c=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(c))},this._fastUpdates.enabled?{applyTransform:(c,d,e)=>{c.getFeatureAttribute(d,M);G.copy(e,z.evaluateModelTransform(this._fastUpdates.materialParameters,M,e))},scaleFactor:(c,d,e)=>{d.getFeatureAttribute(e,
M);return z.evaluateModelTransformScale(c,this._fastUpdates.materialParameters,M)}}:null);b.slicePlane=this._context.slicePlaneEnabled;a.addRenderPlugin(b.slots,b);return b};h._getExternalColorParameters=function(b){const a={};this._drivenProperties.color?a.externalColor=y.ONES:f.isSome(b)&&f.isSome(b.color)?a.externalColor=P.toUnitRGBA(b.color):(a.externalColor=y.ONES,a.colorMixMode="ignore");return a};h.destroy=function(){K.prototype.destroy.call(this);const b=this._context.stage;if(f.isSome(this._resources)){b.removeRenderPlugin(this._resources.lodRenderer);
this._resources.lodRenderer.destroy();const a=this._resources.stageResources;b.removeMany(a.materials);b.removeMany(a.textures);b.removeMany(a.geometries);f.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=null};h.createGraphics3DGraphic=function(b){const a=b.graphic;if(!this._validateGeometry(a.geometry))return null;const c=I.placePointOnGeometry(a.geometry);if(f.isNone(c))return this.logger.warn(`unsupported geometry type for icon symbol: ${a.geometry.type}`),null;const d=
this.setGraphicElevationContext(a,new ba.ElevationContext);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid)};h.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};h.graphicLayerToGraphicId=function(){return 0};h.layerOpacityChanged=function(){if(f.isNone(this._resources))return!0;const b=this._drivenProperties.opacity,a=!this.isPrimitive,c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let k=0;k<c.length;k++){const g=
c[k];var e=f.get(this.symbolLayer,"material","color");const q=d[k];e=this._getCombinedOpacity(e,{hasIntrinsicColor:a})*q.opacity;g.setParameterValues({opacity:e,transparent:1>e||b||q.transparent})}return!0};h.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,Q.needsElevationUpdates3D)};h.slicePlaneEnabledChanged=function(){if(f.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const b of this._resources.stageResources.materials)b.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
return!0};h.physicalBasedRenderingChanged=function(){if(f.isNone(this._resources))return!0;const {stageResources:b,isWosr:a}=this._resources;for(const c of b.materials)this.isPrimitive?c.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a||c.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1===this.hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this.hasLoadedPBRTextures=!0,!1):!0};h.pixelRatioChanged=
function(){return!0};h.applyRendererDiff=function(b,a){if(f.isNone(this._resources))return!0;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:e,symbolSize:k,resourceSize:g,pivotOffset:q}=this._resources;for(const l in b.diff)switch(l){case "visualVariables":if(z.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(e,k,g,q))){for(const n of c)n.setParameterValues(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return!1;
break;default:return!1}return!0};h.computeComplexity=function(){if(f.isNone(this._resources))return K.prototype.computeComplexity.call(this);const b=x.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce((c,d)=>c+d.indices.get("position").length,0)/3,a=ca.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:a}};h.hasLodRenderer=function(){return f.isSome(this._resources)};
h._createAs3DShape=function(b,a,c,d,e){if(!this.hasLodRenderer()||f.isNone(this._resources))return null;b=this.getFastUpdateAttrValues(b);const k=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?C.mixinColorAndOpacity(c.color,c.opacity):null;var g=this._context.clippingExtent;U.projectPointToVector(a,B,this._context.elevationProvider.spatialReference);if(f.isSome(g)&&!u.containsPoint(g,B))return null;g=this._requiresTerrainElevation(d);const q=this._computeGlobalTransform(a,d,R,g?N:null);c=
this._computeLocalTransform(this._resources,this.symbolLayer,c,Y);const l=this._resources.lodRenderer.instanceData,n=l.addInstance();this._instanceIndexToGraphicUid.set(n,e);l.setLocalTransform(n,c,!1);l.setGlobalTransform(n,q);b&&l.setFeatureAttribute(n,b);k&&l.setColor(n,k);e=new ea(this,n,aa.perLodInstanceElevationAligner,d);g&&(e.alignedSampledElevation=N.sampledElevation);e.needsElevationUpdates=Q.needsElevationUpdates3D(d.mode);I.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);
return e};h._computeGlobalTransform=function(b,a,c,d){a=Q.evaluateElevationAlignmentAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,d);B[0]=b.x;B[1]=b.y;B[2]=a;U.computeLinearTransformation(b.spatialReference,B,c,this._context.renderCoordsHelper.spatialReference);return c};h._computeLocalTransform=function(b,a,c,d){G.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,a,d);return d};h._applyObjectScale=
function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=C.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||G.scale(c,c,b))};h.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};h.updateGeometry=function(b,a){if(f.isNone(this._resources))return!0;
const c=a&&I.placePointOnGeometry(a);if(f.isNone(c))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(c,b.elevationContext,R,a?N:null);a&&(b.alignedSampledElevation=N.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,R,!0);I.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0};h._preparePatchTransform=function(b,
a){if((a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition)&&!f.isNone(this._resources)){var c=(v,w,F)=>f.unwrapOr(null!=v&&"complete"===v.type?v.newValue:w,F),d=c(a.heading,this.symbolLayer.heading,0),e=c(a.tilt,this.symbolLayer.tilt,0),k=c(a.roll,this.symbolLayer.roll,0),g=c(a.width,this.symbolLayer.width,void 0),q=c(a.height,this.symbolLayer.height,void 0),l=c(a.depth,this.symbolLayer.depth,void 0),n=c(a.anchor,this.symbolLayer.anchor,void 0);c=c(a.anchorPosition,
this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var D={heading:d,tilt:e,roll:k,anchor:n,anchorPosition:c},r=this._resources;1===this.loadStatus&&b.symbolLayerStatePatches.push(()=>{r.symbolSize=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(r.resourceSize,{width:g,height:q,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push((v,w)=>{w=this._computeLocalTransform(r,
D,w,Y);r.lodRenderer.instanceData.setLocalTransform(v.instanceIndex,w,!0)})}};h._preparePatchColor=function(b,a){if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var c=a.color.newValue,d=f.isSome(c)?P.toUnitRGBA(c):y.ONES;delete a.color;var e=this._resources;f.isNone(e)||b.graphics3DGraphicPatches.push(k=>{this._hasPerInstanceColor()?(e.lodRenderer.instanceData.setColor(k.instanceIndex,d),k=this.setMaterialTransparencyParams({},
c)):k=this.setMaterialTransparencyParams({externalColor:d},c);for(const g of e.stageResources.materials)g.setParameterValues(k)})}};h._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};h._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return C.computeObjectRotation(b.heading,b.tilt,b.roll,c)};h._computeAnchor=function(b,a,c){const d=m.create();switch(c.anchor){case "center":t.copy(d,u.center(b));t.negate(d,
d);break;case "top":a=u.center(b);t.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=u.center(b);t.set(d,-a[0],-a[1],-b[2]);break;case "relative":a=u.center(b);b=u.size(b);c=(c=c.anchorPosition)?m.fromValues(c.x,c.y,c.z):m.ZEROS;t.multiply(d,b,c);t.add(d,d,a);t.negate(d,d);break;default:f.isSome(a)?t.negate(d,a):t.copy(d,m.ZEROS)}return d};h._applyAnchor=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b.resourceBoundingBox,b.pivotOffset,
a))&&G.translate(c,c,b)};h._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};h._fastVisualVariableConvertOptions=function(b,a,c,d){const e=f.isSome(b)?m.fromArray(u.size(b)):m.ONES;b=f.isSome(b)?this._computeAnchor(b,d,this.symbolLayer):m.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=C.computeObjectScale(f.isSome(a)?a:void 0,a,c,d);const k=m.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:e,
symbolSize:f.isSome(a)?a:m.ONES,unitInMeters:d,transformation:{anchor:b,scale:c,rotation:k}}};S._createClass(L,[{key:"extentPadding",get:function(){return f.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return f.get(this._resources,"lodRenderer")}}]);return L}(H.Graphics3DSymbolLayer);const B=m.create(),Y=V.create(),R=V.create(),M=y.create(),N={verticalDistanceToGround:0,
sampledElevation:0};O.Graphics3DObjectSymbolLayer=H;O.default=H;Object.defineProperty(O,"__esModule",{value:!0})});