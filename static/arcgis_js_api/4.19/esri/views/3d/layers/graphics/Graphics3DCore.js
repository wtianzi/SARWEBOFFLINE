// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/Error ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/scheduling ../../../../core/Accessor ../../../../geometry/Point ../../../../geometry/Extent ../../../../geometry ../../../../support/arcadeOnDemand ../../../../core/mathUtils ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol ../../../../symbols ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../core/Handles ../../../../layers/Layer ../../../../renderers/Renderer ../../../../symbols/support/symbolConversion ../../../../renderers/ClassBreaksRenderer ../../../../core/accessorSupport/diffUtils ../../../../renderers/UniqueValueRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/SimpleRenderer ../../../../renderers/support/jsonUtils ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ../../../../geometry/projection ../../../support/Scheduler ../../../../core/MapUtils ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ./graphicUtils ./featureExpressionInfoUtils ./symbolComplexity ./Graphics3DGraphicCreationContext ./Graphics3DGraphic ../../webgl-engine/lib/WebGLLayer ../../webgl-engine/lib/GridLocalOriginFactory ./Graphics3DWebStyleSymbol ../../support/extentUtils ../../support/PropertiesPool ./ElevationQuery ../../../../renderers/support/rendererConversion ../../../../symbols/support/defaults3D ./Graphics3DFeatureStore ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./GraphicStateTracking ./SpatialIndex2D ../support/StageLayerElevationProvider".split(" "),
function(k,J,l,Ca,f,W,Da,m,Ea,X,z,Fa,Ga,Ha,Q,t,Y,Z,aa,ba,Ia,ca,x,R,da,ea,Ja,E,A,fa,ha,Ka,S,La,K,F,Ma,Na,Oa,Pa,Qa,B,ia,w,G,T,C,L,M,ja,H,U,ka,la,ma,na,oa,pa,qa,ra,V,sa,ta,ua,va,wa,xa,ya){var N;const O=E.create(),p=C.create(),r=W.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");k.Graphics3DCore=N=function(D){function I(a){a=D.call(this,a)||this;a.propertiesPool=new qa.PropertiesPool({computedExtent:ba},J._assertThisInitialized(a));a.computedExtent=null;a.currentRenderer=null;a.rendererHasGeometryOperations=
!1;a.graphicStateTracking=null;a.symbolCreationContext=new ua.Graphics3DSymbolCreationContext;a.graphics3DGraphics=new Map;a.stageLayer=null;a.stage=null;a.graphicsDrapedUids=new Set;a.graphicsBySymbol=new Map;a.symbolConversionCache=new Map;a.symbols=new Map;a.graphicsWithoutSymbol=new Map;a.graphicsWaitingForSymbol=new Set;a._handles=new fa;a._frameTask=G.ImmediateTask;a.suspendSymbolCleanup=!1;a._spatialReference=null;a.arcadeOnDemand=null;a.rendererChangeAbortController=null;a.elevationInfoChangeAbortController=
null;a.setupAbortController=null;a.elevationAlignment=null;a.scaleVisibility=null;a.filterVisibility=null;a._spatialIndex=null;a.extentPadding=0;a._updatingPendingLoadedGraphicsChange=null;a.featureStore=null;a.deconflictor=null;a.labeler=null;a.objectStates=null;a.viewElevationProvider=null;a.stageLayerElevationProvider=null;a.sharedSymbolResourcesOwnerHandle=null;a.whenGraphics3DGraphicRequests={};a.pendingUpdates=new Map;a.numberOfGraphics=0;a.numberOfGraphicsProvidingElevation=0;a.pendingAdds=
0;a.pendingRemoves=0;a.pendingUpdatesPool=new Q({allocator:b=>b||new za,deallocator:b=>{b.clear();return b}});a.symbolWarningLogged=!1;a.geometryWarningLogged=!1;a.objectIdInvisibleSet=new Set;a._whenSymbolRemoved=new Q;a.preferredUpdatePolicy=0;a.forcedUpdatePolicy=null;a._asyncUpdates=!1;a.elevationFeatureExpressionEnabled=!0;a.owner=null;a.layer=null;a.graphicSymbolSupported=!0;a.getRenderingInfoWithoutRenderer=!1;a.hasZ=null;a.hasM=null;a._usedMemory=0;a._visible=void 0;a._startCreateGraphics=
!1;a.maxPendingUpdates=0;return a}J._inheritsLoose(I,D);var e=I.prototype;e.getConvertedSymbol=function(a){if("web-style"===a.type)return a.clone();var b=this.symbolConversionCache.get(a.id);if(void 0!==b)return b;b=S.to3D(a,!0,!1,this.hasLabelingContext(a));const c=b.symbol||null;c||b.error&&r.error(b.error.message);this.symbolConversionCache.set(a.id,c);return c};e.getSymbolComplexitiesUsedOrRenderer=function(a){if(f.isNone(a))return[];var b=a.getSymbols(),c="backgroundFillSymbol"in a&&a.backgroundFillSymbol;
if(!(c||b&&b.length))return[];a=[];c=this.getSymbolComplexityUsedOrRenderer(c);f.isSome(c)&&a.push(c);for(const d of b)b=this.getSymbolComplexityUsedOrRenderer(d),f.isSome(b)&&a.push(b);return a};e.getSymbolComplexityUsedOrRenderer=function(a){if(f.isNone(a))return null;const b=this.symbols.get(a.id);return f.isSome(b)?b.complexity:(a=this.getConvertedSymbol(a))?U.defaultSymbolComplexity(a):null};e.getSymbolComplexitiesUsed=function(){const a=[];this.symbols.forEach(b=>{f.isSome(b)&&a.push(b.complexity)});
return a};e.initialize=function(){this._spatialReference=this.owner.view.spatialReference;this._set("featureStore",new ta["default"]({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:a=>this.graphics3DGraphics.forEach(a)}))};e.setup=async function(a){this.setupAbortController=t.createAbortController();const b=this.setupAbortController.signal;this._set("elevationAlignment",
a.elevationAlignment);this._set("scaleVisibility",a.scaleVisibility);this._set("filterVisibility",a.filterVisibility);this._set("deconflictor",a.deconflictor);this._set("labeler",a.labeler);this._set("objectStates",a.objectStates);const c=this.owner.view;this.viewElevationProvider=new ra.ViewElevationProvider(this._spatialReference,c);this.initializeStage(c,this.layer.uid);this.symbolCreationContext.sharedResources=c.sharedSymbolResources;this.sharedSymbolResourcesOwnerHandle=c.sharedSymbolResources.addGraphicsOwner(this.owner);
f.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.sharedSymbolResources.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=c.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.layerView=this.owner;this.symbolCreationContext.localOriginFactory=new na;this.symbolCreationContext.elevationProvider=c.elevationProvider;
this.symbolCreationContext.notifyGraphicGeometryChanged=d=>this.notifyGraphicGeometryChanged(d);this.symbolCreationContext.notifyGraphicVisibilityChanged=d=>this.notifyGraphicVisibilityChanged(d);a=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(a,this._spatialReference,r);t.throwIfAborted(b);this.symbolCreationContext.screenSizePerspectiveEnabled=c.screenSizePerspectiveEnabled&&
this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;a="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",()=>this._frameTask.reschedule(()=>this.updateLayerVisibility())),this.owner.watch(a,
()=>{const d=c.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=d,this.recreateAllGraphics())}),B.init(this,"preferredUpdatePolicy",()=>this.updateUpdatePolicy(),!0),this.owner.watch("slicePlaneEnabled",d=>this.slicePlaneEnabledChange(!!d)),this.owner.view.watch("pixelRatio",()=>this.pixelRatioChange()),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",
d=>this.physicalBasedRenderingChange(d)),B.when(c.basemapTerrain,"tilingScheme",d=>{d.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=c.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([B.on(this.owner,"loadedGraphics","change",g=>this.graphicsCollectionChanged(g),()=>this.recreateAllGraphics()),B.on(this.owner,"loadedGraphics","after-changes",()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange(),
()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange())],"loaded-graphics")})]);this._frameTask=c.resourceController.scheduler.registerTask(G.Task.GRAPHICS_CORE,d=>this._update(d),()=>this.needsUpdate);this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",()=>this.deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer)}catch{}t.throwIfAborted(b);this.setupAbortController=
null};e.abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)};e.destroy=function(){this.abortSetup();this.abortRendererChange();this.abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null);this.clear();f.isSome(this.graphicStateTracking)&&
(this.graphicStateTracking.destroy(),this.graphicStateTracking=null);this.stage&&(this.stage.remove(this.stageLayer),this.stage=this.stageLayer=null);this._handles=f.destroyMaybe(this._handles);this._frameTask.remove();this._frameTask=G.ImmediateTask;this._spatialReference=null;this._set("owner",null);for(const a in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[a].reject(new z("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle=
f.removeMaybe(this.sharedSymbolResourcesOwnerHandle);this.propertiesPool=f.destroyMaybe(this.propertiesPool);this.pendingUpdatesPool=null;this.symbolConversionCache.clear();this.objectIdInvisibleSet.clear();this._spatialIndex=f.destroyMaybe(this._spatialIndex);this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))};e.clear=function(){var a;this.objectStates&&this.objectStates.allGraphicsDeleted();f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted();
this.graphics3DGraphics.forEach(b=>b.destroy());null==(a=this._spatialIndex)?void 0:a.clear();this.graphics3DGraphics.clear();this._usedMemory=this.numberOfGraphics=0;this.updateLayerVisibility();this.symbols.forEach(b=>{f.isSome(b)&&b.destroy()});this.symbols.clear();this.graphicsBySymbol.clear();this.graphicsWithoutSymbol.clear();this.graphicsWaitingForSymbol.clear();this.pendingUpdates.clear();this.pendingUpdatesPool.clear();this.pendingRemoves=this.pendingAdds=this.maxPendingUpdates=0;this.notifyChange("updating");
this.notifyChange("needsUpdate");this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining");this.featureStore.events.emit("changed")};e.initializeStage=function(a,b){this.stage=a._stage;this.stageLayer=new ma.WebGLLayer({isPickable:!this.suspendedOrOutsideOfView},b);this.stage.add(this.stageLayer);a=this.stageLayer.events;a.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.metadata.graphicUid));a.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.metadata.graphicUid));
a.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));a.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));a.on("vertexAttrsUpdated",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid))};e.notifyGraphicGeometryChanged=function(a){f.isNone(this.graphicStateTracking)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicGeometry(a)};e.notifyGraphicVisibilityChanged=function(a){f.isNone(this.graphicStateTracking)||
(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicVisibility(a)};e.updateLayerVisibility=function(){var a=this.numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())};e.updateStageLayerVisibility=function(){this.stageLayer.isVisible=
this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};e.getGraphics3DGraphicById=function(a){return this.graphics3DGraphics.get(a)};e.getGraphics3DGraphicByObjectId=function(a){var b;return null!=(b=this.owner.layer)&&b.objectIdField?this._findGraphics3DGraphicByObjectId(a):null};e._getGraphicObjectID=function(a,b=this.owner.layer&&this.owner.layer.objectIdField){return L.getObjectId(a,b)};e.updateLabelingInfo=async function(a){const b=this.deconflictor&&this.deconflictor.labelingInfoChange(a);
a=this.labeler&&this.labeler.labelingInfoChange(a);await t.eachAlways([b,a])};e.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange();this.labeler&&this.labeler.visibilityInfoChange()};e._update=function(a){this._frameTask.processQueue(a);this._applyPendingUpdates(a);this.notifyChange("needsUpdate");this.needsUpdate||this.notifyChange("updating");this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};e.setObjectIdVisibility=function(a,b){b?this.objectIdInvisibleSet.delete(a):
this.objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);f.isSome(a)&&this._updateUserVisibility(a)};e._findGraphics3DGraphicByObjectId=function(a){return T.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)};e._updateUserVisibility=function(a){if(f.isNone(a))return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(f.isNone(c)||!this.objectIdInvisibleSet.has(c));return a.setVisibilityFlag(0,b,0)};e.whenGraphics3DGraphic=
function(a){var b=this.graphics3DGraphics.get(a.uid);if(b)return Promise.resolve(b);if(b=this.whenGraphics3DGraphicRequests[a.uid])return b.promise;b=t.createDeferred();this.whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};e.boundsForGraphics3DGraphic=async function(a,b){const c=this._spatialReference,d=this.owner.view.renderSpatialReference,g=this.owner.view.basemapTerrain.spatialReference;var h=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:f.isSome(b)&&
b.useViewElevation,minDemResolution:f.isSome(b)&&b.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null;a=await a.getProjectedBoundingBox((n,q,v)=>w.projectBuffer(n,d,q,n,c,q,v),(n,q,v)=>w.projectBuffer(n,g,q,n,c,q,v),h,f.get(b,"signal"));if(!a)return null;b=a.boundingBox;a.requiresDrapedElevation&&(h=this.symbolCreationContext.elevationProvider)&&(C.center(b,O),h=f.unwrapOr(h.getElevation(O[0],O[1],0,c,"ground"),0),b[2]=Math.min(b[2],h),b[5]=Math.max(b[5],h));return{boundingBox:b,
screenSpaceObjects:a.screenSpaceObjects}};e.whenGraphicBounds=function(a,b){return B.whenOnce(this.owner,"loadedGraphics").then(()=>{const c=this.owner.layer&&this.owner.layer.objectIdField,d=this.owner.loadedGraphics.find(g=>g===a?!0:c&&g.attributes&&a.attributes&&g.attributes[c]===a.attributes[c]);if(d)return this.whenGraphics3DGraphic(d);throw new z("internal:graphic-not-part-of-view","Graphic is not part of this view");}).then(c=>this.boundsForGraphics3DGraphic(c,b))};e.computeAttachmentOrigin=
function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;A.set(u,0,0,0);a=0;if(0<c.render.num){if(!w.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,y,b))return null;A.add(u,u,y);a++}if(0<c.draped.num){const [d,g]=c.draped.origin;c=f.unwrapOr(this.viewElevationProvider.getElevation(d,g,"ground"),0);A.set(y,d,g,c);if(!w.projectVectorToVector(y,this.viewElevationProvider.spatialReference,
y,b))return null;A.add(u,u,y);a++}1<a&&A.scale(u,u,1/a);return new aa({x:u[0],y:u[1],z:u[2],spatialReference:b})};e.getSymbolLayerSize=function(a,b){var c=this.symbols.get(a.id);if(f.isNone(c))throw new z("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);if(-1===a)throw new z("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);if(null==c)throw new z("internal:missing-size","Symbol layer has no valid size");return c};
e.graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};e.graphicUpdateHandler=function(a){var b=a.graphic.uid;const c=this.graphics3DGraphics.get(b);b=this.graphicsWithoutSymbol.get(b);if(c||b){switch(a.property){case "visible":this.graphicUpdateVisibleHandler(c);break;case "geometry":this.graphicUpdateGeometryHandler(c,a);break;case "symbol":this.graphicUpdateSymbolHandler(c,a)}0===this.preferredUpdatePolicy&&this.stageLayer.commit()}};e.graphicUpdateGeometryHandler=
function(a,b){const c=b.graphic.geometry;if(f.isNone(c))this.recreateGraphic(b.graphic);else if(f.isNone(a)){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this.symbols.get(a),f.isSome(a)&&0===a.loadStatus)return;this.recreateGraphic(b.graphic)}else{var d=a.graphics3DSymbol;!f.isNone(b.newValue)&&d.updateGeometry(a,b.newValue)||this.recreateGraphic(a.graphic);this.expandComputedExtent(c)}};e.graphicUpdateSymbolHandler=function(a,b){var c=b.graphic;const d=f.isSome(a)?a.graphics3DSymbol:f.isSome(b.oldValue)&&
this.symbols.get(b.oldValue.id);if(f.isNone(d)||f.isNone(b.newValue))this.recreateGraphic(c);else{var g=d.symbol;b=this.getConvertedSymbol(b.newValue);if(b.type!==g.type||"web-style"===b.type||"web-style"===g.type)this.recreateGraphic(c);else{var h=this.graphicsBySymbol.get(g.id);if(h&&1!==h.size)this.recreateGraphic(c);else if(h=K.diff(g,b),f.isNone(h))this.updateSymbolMapping(g.id,b);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(h),K.isEmpty(h.diff)){var n=
this._getRenderingInfo(c);if(f.isNone(n))this.recreateGraphic(c);else{c=d.extentPadding;for(const q of h.symbolStatePatches)q();c!==d.extentPadding&&this.recomputeExtentPadding();if(f.isSome(a))for(const q of h.graphics3DGraphicPatches)q(a,n);this.updateSymbolMapping(g.id,b)}}else this.recreateGraphic(c)}}};e.graphicUpdateVisibleHandler=function(a){this._updateUserVisibility(a)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};e.recreateGraphics=function(a){this.suspendSymbolCleanup=
!0;this.remove(a);this.add(a);this.suspendSymbolCleanup=!1;this.asyncUpdates||this._cleanupSymbols()};e.recreateGraphic=function(a){this.recreateGraphics([a])};e._beginGraphicUpdate=function(a){this.graphicsWaitingForSymbol.add(a.uid);1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating")};e._endGraphicUpdate=function(a){a&&(this.graphicsWaitingForSymbol.delete(a.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))};e.recomputeExtentPadding=
function(){let a=0;this.symbols.forEach(b=>{f.isSome(b)&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)};e.expandComputedExtent=function(a){var b=a.spatialReference;L.computeAABB(a,p);a=this._spatialReference;var c=N.tmpVec;!b.equals(a)&&w.projectXYZToVector(p[0],p[1],0,b,c,a)&&(p[0]=c[0],p[1]=c[1],w.projectXYZToVector(p[3],p[4],0,b,c,a),p[3]=c[0],p[4]=c[1]);if(x.isFinite(p[0])&&x.isFinite(p[3])&&x.isFinite(p[1])&&x.isFinite(p[4])){b=this.computedExtent;c=null;var d=x.isFinite(p[2])&&
x.isFinite(p[5]),g=d&&(!b||null==b.zmin||p[2]<b.zmin);d=d&&(!b||null==b.zmax||p[5]>b.zmax);if(b){if(p[0]<b.xmin||p[1]<b.ymin||p[3]>b.xmax||p[4]>b.ymax||g||d)c=this.propertiesPool.get("computedExtent"),c.xmin=Math.min(p[0],b.xmin),c.ymin=Math.min(p[1],b.ymin),c.xmax=Math.max(p[3],b.xmax),c.ymax=Math.max(p[4],b.ymax),c.spatialReference=a}else c=this.propertiesPool.get("computedExtent"),c.xmin=p[0],c.ymin=p[1],c.xmax=p[3],c.ymax=p[4],c.spatialReference=a;c&&(g&&(c.zmin=p[2]),d&&(c.zmax=p[5]),this._set("computedExtent",
c))}};e.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)};e.elevationInfoChange=async function(){this.abortElevationInfoChange();const a=t.createAbortController();this.elevationInfoChangeAbortController=a;const b=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(b,
this._spatialReference,r);t.throwIfAborted(a);this.elevationInfoChangeAbortController=null;this.labeler&&this.labeler.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,g)=>{c.globalPropertyChanged("elevationInfo",d)?d.forEach(h=>{const n=h.graphic;h=h.labelGraphics;for(const q of h)q.graphics3DSymbolLayer.updateGraphicElevationContext(n,q)}):this._recreateSymbol(g)});this.updateStageLayerElevationProvider();this.elevationAlignment&&this.elevationAlignment.elevationInfoChange()};e.updateStageLayerElevationProvider=
function(){if(this.stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this.numberOfGraphicsProvidingElevation&&(this.stageLayerElevationProvider=
new ya.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))};e.clearSymbolsAndGraphics=function(){this.clear();this.filterVisibility&&this.filterVisibility.clear();this.labeler&&this.labeler.reset();this.deconflictor&&this.deconflictor.clear();this.elevationAlignment&&this.elevationAlignment.clear();this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayerElevationProvider&&
(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)};e.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};e.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,
this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))};e._recreateSymbol=function(a){var b=this.graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,g)=>{var h;const n=d.usedMemory;this._conditionalRemove(d,g);null==(h=this._spatialIndex)?void 0:h.remove(d);c.push(d.graphic);d.destroy();this.removeGraphics3DGraphic(g,n);this.updateLayerVisibility();
this.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(a,new Map));b=this.symbols.get(a);f.isSome(b)&&b.destroy();this.symbols.delete(a);this.add(c)};e._conditionalRemove=function(a,b){a.isDraped&&this.graphicsDrapedUids.delete(b);this.objectStates&&this.objectStates.removeGraphic(a);this.labeler&&this.labeler.removeGraphic(a);this.deconflictor&&this.deconflictor.removeGraphic(a);f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(a)};e.add=function(a){a&&0!==
a.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this.asyncUpdates?this._addDelayed(a):this._addImmediate(a),this.notifyChange("updating")):r.error("#add()","Cannot add graphics before terrain surface has been initialized"))};e._addImmediate=function(a){this.symbolWarningLogged=this.geometryWarningLogged=!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,r));this._cleanupSymbols();this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());
this.owner.view.deconflictor.setDirty()};e._addDelayed=function(a){for(const b of a){a=b.uid;let c=this.pendingUpdates.get(a);c?c.add?0!==c.state&&c.abortController.abort():this.pendingAdds++:(c=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(a,c));c.add=b}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("needsUpdate");this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};e.remove=function(a){this.asyncUpdates?
this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("updating")};e._removeImmediate=function(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};e._removeDelayed=function(a){for(const c of a){a=c.uid;var b=this.pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this.pendingUpdates.delete(a),1===b.state&&b.abortController.abort(),this.pendingAdds--):(b=this.pendingUpdatesPool.pushNew(),
b.remove=c,this.pendingUpdates.set(a,b),this.pendingRemoves++)}0===this.pendingUpdates.size&&this._finishPendingUpdates();this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("needsUpdate");this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};e._finishPendingUpdates=function(){this.pendingUpdatesPool.clear();this.maxPendingUpdates=0;this._cleanupSymbols();(this.pendingAdds||this.pendingRemoves)&&r.warn("pendingAdds/Removes in inconsistent state!");
this.pendingRemoves=this.pendingAdds=0};e._applyPendingUpdates=function(a){var b;this.symbolWarningLogged=this.geometryWarningLogged=!1;if(0===this.pendingUpdates.size&&null!=(b=this._spatialIndex)&&b.updating)this._spatialIndex.update();else{for(const [c,d]of this.pendingUpdates){if(a.done)break;d.add&&0===d.state&&this._startAddRenderingInfo(d);!d.remove||d.add&&2!==d.state||(this.pendingRemoves--,a.madeProgress(),this._removeGraphic(d.remove),d.remove=null);if(d.add)switch(d.state){case 2:this._addGraphic(d.add,
d.renderingInfo);d.add=null;this.pendingAdds--;a.madeProgress();break;case 3:d.add=null,this.pendingAdds--}null==d.remove&&null==d.add&&this.pendingUpdates.delete(c)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("needsUpdate"))}};e._startAddRenderingInfo=function(a){f.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(a.state=1,a.abortController=t.createAbortController(),this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal}).then(b=>
{f.isNone(b)||f.isNone(b.symbol)?(r&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,r.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=b;a.state=2},b=>{a.abortController=null;t.isAbortError(b)?a.state=0:a.state=3})):(a.renderingInfo=this._getRenderingInfo(a.add,r),a.state=2)};e._addGraphic=function(a,b){this.graphicsWithoutSymbol.set(a.uid,a);if(!f.isNone(b)&&!f.isNone(b.symbol)&&L.hasGeometry(a)){var c=this.getOrCreateGraphics3DSymbol(b.symbol,
b.renderer);if(!f.isNone(c)){this.expandComputedExtent(a.geometry);this._beginGraphicUpdate(a);var d=new ka(a,b,this.layer),g=!1,h=n=>{n===c.symbol.id&&(g=!0)};this._whenSymbolRemoved.push(h);c.load(()=>{if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(h);if(!(g||c.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==c.symbol.id)){if(this.graphicsWaitingForSymbol.has(a.uid)){const n=this.createGraphics3DGraphic(c,d);this._spatialIndex&&f.isSome(n)&&this._spatialIndex.add(n)}this._endGraphicUpdate(a)}--c.referenced;
this.featureStore.events.emit("changed");this.labeler&&this.owner.view.labeler.setDirty()}},n=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(h),g||(t.isAbortError(n)?this.add([a]):c.destroyed||this._endGraphicUpdate(a)))})}}};e._removeGraphic=function(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){var c;b.graphics3DSymbol.onRemoveGraphic(b);const d=b.usedMemory,g=b.isElevationSource;this._conditionalRemove(b,a);null==(c=this._spatialIndex)?void 0:c.remove(b);this.graphicsBySymbol.get(b.graphics3DSymbol.symbol.id).delete(a);
this.graphicsWithoutSymbol.delete(a);this.removeGraphics3DGraphic(a,d,g);b.destroy();this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(a),this.graphicsWaitingForSymbol.delete(a),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};e.hasLabelingContext=function(a){if(a instanceof R||a instanceof da){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1};e.hasValidSymbolCreationContext=
function(a){return a instanceof R&&!this.hasLabelingContext(a)?(r.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};e._getRenderingInfo=function(a,b){const c=a.geometry;if(f.isNone(c))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!w.canProjectWithoutEngine(c.spatialReference,this._spatialReference))return b&&
!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&f.isSome(a.symbol))return b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?M.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||
f.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,f.unwrap(this.arcadeOnDemand)):{symbol:a.symbol||sa.getDefaultSymbol3D(a.geometry)};return f.isNone(a)||f.isNone(a.symbol)?(b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a};e._getRenderingInfoAsync=function(a,b){if(f.isNone(a.geometry))return r&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,r.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),
null;if(!this.graphicSymbolSupported&&f.isSome(a.symbol))return r&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,r.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?M.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,f.unwrap(this.currentRenderer),f.unwrap(this.arcadeOnDemand),b)};e.createGraphics3DSymbol=function(a,b){if(!this.hasValidSymbolCreationContext(a))return null;a=
this.getConvertedSymbol(a);if(!a)return null;let c;f.isSome(b)&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=S.to3D(b.backgroundFillSymbol,!1,!0),b.symbol&&"web-style"!==b.symbol.type&&(c=b.symbol.symbolLayers));const d=va.make(a,this.symbolCreationContext,c);d.load(()=>{const g=d.extentPadding;g>this.extentPadding&&this._set("extentPadding",g);this.notifyChange("averageSymbolComplexity")},()=>{});return d};e.getOrCreateGraphics3DSymbol=function(a,b){let c=this.symbols.get(a.id);void 0===
c&&(c=a instanceof ea?new oa(a,d=>this.createGraphics3DSymbol(d,b)):this.createGraphics3DSymbol(a,b),this.symbols.set(a.id,c));f.isSome(c)&&++c.referenced;return c};e.trackGraphicState=function(a){f.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new wa.GraphicStateTracking(this));return this.graphicStateTracking.add(a)};e.addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this.numberOfGraphics++;a.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,
this.updateStageLayerElevationProvider());this.updateLayerVisibility()};e.removeGraphics3DGraphic=function(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this.numberOfGraphics--;c&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());this.updateLayerVisibility()};e.createGraphics3DGraphic=function(a,b){const c=b.graphic;this.graphicsWithoutSymbol.delete(c.uid);if(!this.symbols.has(a.symbol.id))return this.add([c]),null;if(this.graphics3DGraphics.has(c.uid))return null;
b=a.createGraphics3DGraphic(b);if(f.isNone(b))return null;this.addGraphics3DGraphic(b);a=a.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map);this.graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&this.graphicsDrapedUids.add(c.uid);b.centroid=null;f.isSome(c.geometry)&&"point"!==c.geometry.type&&b instanceof la&&(b.centroid=ja.computeCentroid(c.geometry,this._spatialReference));this._updateUserVisibility(b);f.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(b);
this.filterVisibility&&this.filterVisibility.updateVisibility(b);this.deconflictor&&this.deconflictor.addGraphic(b);this.labeler&&this.labeler.addGraphic(b);this.objectStates&&this.objectStates.addGraphic(b);this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stage,this.stageLayer,this.owner);f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(b);if(a=this.whenGraphics3DGraphicRequests[c.uid])delete this.whenGraphics3DGraphicRequests[c.uid],
a.resolve(b);return b};e.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)};e.rendererChange=async function(a){this.abortRendererChange();if(a!==this.currentRenderer)if(this.validateRenderer(a),f.isNone(a)&&this.currentRendererChange(null,!1),V.isSupportedRenderer3D(a))if(f.isSome(a)&&a.arcadeRequired){var b=t.createAbortController();this.rendererChangeAbortController=b;const {arcadeUtils:c}=await this.ensureArcade();
t.throwIfAborted(b);c.hasGeometryOperations(a)&&(await c.enableGeometryOperations(),t.throwIfAborted(b));this.asyncUpdates?await this._frameTask.schedule(()=>this.currentRendererChange(a,!0),b.signal):this.currentRendererChange(a,!0);this.rendererChangeAbortController=null}else this.asyncUpdates?(this.rendererChangeAbortController=b=t.createAbortController(),await this._frameTask.schedule(()=>this.currentRendererChange(a,!1),b.signal),this.rendererChangeAbortController=null):this.currentRendererChange(a,
!1);else this.currentRendererChange(a,!1)};e.ensureArcade=async function(){f.isNone(this.arcadeOnDemand)&&(this.arcadeOnDemand=await ca.loadArcade());return this.arcadeOnDemand};e.currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=f.unwrap(this.arcadeOnDemand);b=this.symbolCreationContext.renderer;if(a!==b)if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),f.isNone(a))this.symbolCreationContext.renderer=null,
this.recreateAllGraphics();else{var c=K.diff(b,a);this.updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;f.isNone(c)||("complete"===c.type?this.recreateAllGraphics():"partial"===c.type&&(this.applyRendererDiff(c,a,b)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("averageSymbolComplexity"))}};e.diffHasSymbolChange=function(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete a.diff[b];
break;default:return!0}return!1};e.applySymbolSetDiff=function(a,b,c){a=a||[];b=b||[];const d=[];for(const g of b){const h=this.graphicsBySymbol.get(g.id);h&&h.forEach((n,q)=>{var v=n.graphic,P=this.layer instanceof ha?this.layer:null;const Aa=f.unwrap(this.arcadeOnDemand);if(g!==c.defaultSymbol||c.getSymbol(M.hydrateGraphic(v,P),{arcade:Aa})!==c.defaultSymbol)P=n.usedMemory,a.length||c.defaultSymbol?d.push(v):this.graphicsWithoutSymbol.set(q,v),v=this.graphics3DGraphics.get(q),this._conditionalRemove(v,
q),n.destroy(),h.delete(q),this.removeGraphics3DGraphic(q,P),this.updateLayerVisibility()});this._whenSymbolRemoved.forAll(n=>n(g.id))}if(a.length||d.length)this.graphicsWithoutSymbol.forEach(g=>d.push(g)),this.graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};e.applyUniqueValueRendererDiff=function(a,b,c){const d=a.diff.defaultSymbol,g=a.diff.uniqueValueInfos;if(d||g){const h=g?g.added.map(q=>
q.symbol):[],n=g?g.removed.map(q=>q.symbol):[];if(g)for(let q=0;q<g.changed.length;q++)h.push(g.changed[q].newValue.symbol),n.push(g.changed[q].oldValue.symbol);d?(c.defaultSymbol&&n.push(c.defaultSymbol),b.defaultSymbol&&h.push(b.defaultSymbol)):c.defaultSymbol&&h.length&&n.push(b.defaultSymbol);this.applySymbolSetDiff(h,n,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};e.calculateUnchangedSymbolMapping=function(a,b,c){const d=h=>f.isSome(h)?h.id:null;if(b instanceof
F&&c instanceof F&&(f.isNone(a)||"partial"===a.type)){var g=a&&a.diff;a=g&&g.defaultSymbol;g=(g=g&&g.uniqueValueInfos)?g.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)})):c.uniqueValueInfos.map((h,n)=>({oldId:d(h.symbol),newId:d(b.uniqueValueInfos[n].symbol)}));!a&&c.defaultSymbol&&g.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return g}return[]};e.updateSymbolMapping=function(a,b){const c=b?"string"===typeof b?b:b.id:null;b="string"===typeof b?null:b;if(a&&
a!==c){var d=this.graphicsBySymbol.get(a);this.graphicsBySymbol.delete(a);void 0!==d&&this.graphicsBySymbol.set(c,d);d=this.symbols.get(a);void 0!==d&&(this.symbols.delete(a),this.symbols.set(c,d),f.isSome(d)&&(f.isSome(b)?d.symbol=b:d.symbol.id=c))}};e.updateUnchangedSymbolMappings=function(a,b,c){a=this.calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:g}of a)this.updateSymbolMapping(d,g)};e.applyRendererDiff=function(a,b,c){if(this.diffHasSymbolChange(a))return!1;if(b instanceof F&&
c instanceof F&&this.applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this.graphicsBySymbol)if(c=this.symbols.get(d),f.isSome(c)&&!c.applyRendererDiff(a,b))return!1;return!0};e.opacityChange=function(){this.forEachGraphics3DSymbol((a,b)=>a.globalPropertyChanged("opacity",b));this.updateStageLayerVisibility()};e.updateUpdatePolicy=function(){const a=f.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;f.isSome(this.forcedUpdatePolicy)?
this._asyncUpdates=1===this.forcedUpdatePolicy:this._asyncUpdates=1===this.preferredUpdatePolicy||a;(this.symbolCreationContext.isAsync=this._asyncUpdates)||this._update(G.noBudget)};e.slicePlaneEnabledChange=function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.isSliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&
this.labeler.slicePlaneEnabledChange())};e.physicalBasedRenderingChange=function(a){a!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=a,this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)}))};e.pixelRatioChange=function(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})};e._signalUpdatingDuringAsyncLoadedGraphicsChange=
function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=Y.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};e.setClippingExtent=function(a,b){const c=this.symbolCreationContext.clippingExtent,d=ia.create();pa.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=C.fromRect(C.create(),d):this.symbolCreationContext.clippingExtent=null;return!C.equals(this.symbolCreationContext.clippingExtent,
c)};e.modifyGraphics3DGraphicVisibilities=function(a){let b=!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};e.forEachGraphics3DSymbol=function(a){for(const [b,c]of this.symbols){if(f.isNone(c))break;const d=this.graphicsBySymbol.get(b);a(c,d||Ba,b)}};e.updateAllGraphicsVisibility=function(){this.filterVisibility&&(this.filterVisibility.dirty=!0);this.modifyGraphics3DGraphicVisibilities(a=>{const b=
this._updateUserVisibility(a);a=f.isSome(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(a);return b||a})};e.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(0,!1,0))};e.validateRenderer=function(a){(a=V.validateTo3D(a))&&r.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,a.message)};e.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset();this.stageLayer.shaderTransformationChanged();
this.notifyChange("updating")};e._cleanupSymbols=function(){if(!(0<this.graphicsWaitingForSymbol.size||this.suspendSymbolCleanup)){var a=!1;this.symbols.forEach((b,c)=>{if(!(f.isNone(b)||0<b.referenced)){var d=this.graphicsBySymbol.get(c);d&&0!==d.size||(this.graphicsBySymbol.delete(c),this.symbols.delete(c),b&&b.destroy(),a=!0)}});a&&(this.recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};e.snapshotInternals=function(){return{graphics:[...this.graphics3DGraphics.keys()].sort(),
symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map(a=>({symbolId:a,graphics:[...this.graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}};J._createClass(I,[{key:"spatialIndex",get:function(){this._spatialIndex||(this._spatialIndex=new xa.SpatialIndex2D({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,
spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}},{key:"asyncUpdates",get:function(){return this._asyncUpdates}},{key:"updating",get:function(){var a,b;return!!(0<this.graphicsWaitingForSymbol.size||this.needsUpdate||null!=(a=this.elevationAlignment)&&a.updating||f.isSome(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(b=this.filterVisibility)&&
b.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}},{key:"needsUpdate",get:function(){var a;return 0<this.pendingUpdates.size||!(null==(a=this._spatialIndex)||!a.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var a;return this.owner.suspended||(null==(a=this.owner.suspendInfo)?void 0:a.outsideOfView)}},{key:"updatingRemaining",get:function(){var a;return this.updating?this.pendingUpdates.size+
.1*((null==(a=this._spatialIndex)?void 0:a.updatingRemaining)||0):0}},{key:"updatingTotal",get:function(){return this.updating?this.maxPendingUpdates:0}},{key:"displayFeatureLimit",get:function(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const b=a?a.graphics3D.minTotalNumberOfFeatures:0,c=a?a.graphics3D.maxTotalNumberOfFeatures:0;a=a?a.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;var g=Math.max(1,f.isSome(d)?d.primitivesPerFeature:1),h=f.isSome(d)&&
0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;g=Math.max(b,Math.min(c,Math.ceil(a/g),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===b&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===a&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===g?h:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:c,maximumTotalNumberOfPrimitives:a,averageSymbolComplexity:d,maximumNumberOfFeatures:g}}},{key:"averageSymbolComplexity",get:function(){const a=
U.averageSymbolComplexities(this.symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||f.isSome(b)&&(a.estimated&&(b.primitivesPerFeature>=a.primitivesPerFeature||b.primitivesPerCoordinate>=a.primitivesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.primitivesPerFeature===a.primitivesPerFeature&&b.primitivesPerCoordinate===a.primitivesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}},{key:"spatialReference",get:function(){return this._spatialReference}},
{key:"usedMemory",get:function(){const a=f.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+a}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this.numberOfGraphics?30<Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics?0:this._usedMemory/this.numberOfGraphics:f.isSome(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+
(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()}},{key:"graphics3DGraphicsByObjectID",get:function(){const a=this.owner.layer&&this.owner.layer.objectIdField;if(!a)return null;
const b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);f.isSome(d)&&b.set(d,c)}});return b}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<this.pendingUpdates.size)return"unknown";let a=0,b=0;return T.someMap(this.symbols,(c,d)=>{if(f.isSome(c)){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this.graphicsBySymbol.has(d)&&(b+=c.fast,a+=c.slow)}return!1})?
"unknown":0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}},{key:"test",get:function(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:a=>{this.forcedUpdatePolicy=a;this.updateUpdatePolicy()}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]);return I}(Z);k.Graphics3DCore.tmpVec=E.create();l.__decorate([m.property({readOnly:!0})],
k.Graphics3DCore.prototype,"computedExtent",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"currentRenderer",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_frameTask",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"elevationInfoChangeAbortController",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"setupAbortController",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"elevationAlignment",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"scaleVisibility",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"filterVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_spatialIndex",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"extentPadding",
void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"featureStore",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"deconflictor",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"labeler",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"objectStates",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,
"preferredUpdatePolicy",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"owner",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"layer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,
"getRenderingInfoWithoutRenderer",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"needsUpdate",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"updatingRemaining",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,
"updatingTotal",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],k.Graphics3DCore.prototype,"displayFeatureLimit",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"averageSymbolComplexity",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasZ",void 0);l.__decorate([m.property({constructOnly:!0})],
k.Graphics3DCore.prototype,"hasM",void 0);k.Graphics3DCore=N=l.__decorate([X.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],k.Graphics3DCore);let za=function(){function D(){this.renderingInfo=this.add=null;this.state=0;this.remove=null}D.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=0;this.remove=this.abortController=null};return D}();const u=E.create(),y=E.create(),Ba=new Map;Object.defineProperty(k,"__esModule",{value:!0})});