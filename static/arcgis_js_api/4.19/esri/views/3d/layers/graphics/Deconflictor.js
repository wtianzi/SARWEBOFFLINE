// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/PooledArray ../../../../core/Accessor ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/projectionEllipsoid ../../../../chunks/mat4 ../../../../geometry/support/aaBoundingRect ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../chunks/vec4 ../../../../chunks/sphere ../../support/geometryUtils ../../webgl-engine/lib/Camera ../../support/debugFlags ./deconflictorDebug ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/materials/HUDMaterial".split(" "),
function(n,z,A,ha,w,ia,ja,E,ka,K,la,ma,na,F,L,G,r,u,M,N,p,O,P,H,x,Q,t,R,S,B,T,U){function*I(h){if(Map.prototype.entries){h=h.entries();for(let k=h.next();!k.done;k=h.next())yield k.value[1]}else yield*h.values()}function*V(h,k,g){k.clear();h.forEach((c,b)=>{const d=k.pushNew();d.id=b;d.prio=c.info?-c.info[g].distance:Number.MAX_VALUE});yield;const a=k.iterableSort((c,b)=>b.prio-c.prio);for(let c=a.next();!c.done;c=a.next())yield;k.forAll(c=>{const b=h.get(c.id);b&&(h.delete(c.id),h.set(c.id,b))});
k.clear()}const m=r.create(),v=H.create(),y=H.create(),C=r.create(),W=O.create(),X=t.sphere.create(),D=t.ray.create(),Y=r.create(),Z=p.create();let aa=function(){this.aabr=p.create();this.distance=0;this.visible=this.culled=!1},ba=function(){function h(){this.active=new Map;this.visible=new Map}h.prototype.clear=function(){this.active.clear();this.visible.clear()};return h}(),ca=function(){},da=function(){this.sortArray=new F({allocator:h=>h||new ca})},J=function(){function h(){this.camera=new R;
this.slicePlane=t.boundedPlane.create();this.slicePlaneEnabled=!1}h.prototype.copyFrom=function(k){this.camera.copyFrom(k.camera);t.boundedPlane.copy(k.slicePlane,this.slicePlane);this.slicePlaneEnabled=k.slicePlaneEnabled};return h}();n.Deconflictor=function(h){function k(){var a=h.apply(this,arguments)||this;a._dirty=!1;a._runningViewState=new J;a._state=0;a.graphics=new ba;a.iterators=new da;a.accBinsNumX=15;a.accBinsNumY=20;a.accBinsSizeX=0;a.accBinsSizeY=0;a.accBins=null;a.accNumTests=0;return a}
z._inheritsLoose(k,h);var g=k.prototype;g.destroy=function(){this.graphics.clear();this.iterators=null};g.setDirty=function(){!this._dirty&&0<this.graphics.active.size&&(this._dirty=!0,this.notifyChange("updating"))};g.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating};g.update=function(a){switch(this._state){case 0:this.startUpdate(),a.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(a))break;case 2:if(this._state=2,!this.sortVisibleGraphics(a))break;
case 3:if(this._state=3,!this.deconflictVisibleGraphics(a))break;default:B.drawAccelerationStruct(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}};g.modifyGraphics=function(a,c){c?a.forEach(b=>this.addToActiveGraphics(b)):a.forEach(b=>this.removeFromActiveGraphics(b));this.setDirty()};g.layerSupportsDeconfliction=function(a){if(w.isNone(a)||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof U.HUDMaterial?
!0:!1};g.startUpdate=function(){B.prepare(this.view);this._dirty=!1;this._runningViewState.copyFrom(this.viewState);const {fullWidth:a,fullHeight:c}=this._runningViewState.camera;this.initBins(a,c);this.resetIterators()};g.addToActiveGraphics=function(a){a.info[this.visibilityGroup]=new aa;this.graphics.active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()};g.removeFromActiveGraphics=function(a){this.removeFromVisibleGraphics(a);{const c=a.graphics3DGraphic;c.destroyed||c.clearVisibilityFlag(3,
this.visibilityGroup)}delete a.info[this.visibilityGroup];this.graphics.active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()};g.addToVisibleGraphics=function(a){this.graphics.visible.set(a.graphics3DGraphic.graphic.uid,a)};g.removeFromVisibleGraphics=function(a){this.graphics.visible.delete(a.graphics3DGraphic.graphic.uid)};g.processActiveGraphics=function(a){const c=this.ensureActiveGraphicsIterator(),b=N.invert(W,this._runningViewState.camera.projectionMatrix),d="global"===this.view.viewingMode&&
1===this.view.map.ground.opacity&&0<this._runningViewState.camera.relativeElevation?X:null;let f=0;w.isSome(d)&&(u.transformMat4(d,r.ZEROS,this._runningViewState.camera.viewMatrix),d[3]=M.getReferenceEllipsoid(this.view.spatialReference).radius,f=t.sphere.distanceToSilhouette(d,r.ZEROS));for(;!a.done;){a.madeProgress();var e=c.next();if(e.done)return this.resetActiveGraphicsIterator(),!0;const l=(e=e.value)&&e.info[this.visibilityGroup];l&&(this.collectGraphics3DGraphics(e,b,d,f),l.culled?this.removeFromVisibleGraphics(e):
this.addToVisibleGraphics(e))}return!1};g.sortVisibleGraphics=function(a){const c=this.ensureSortGraphicsIterator();for(;!a.done;){const b=c.next();a.madeProgress();if(b.done)return this.resetSortGraphicsIterator(),!0}return!1};g.deconflictVisibleGraphics=function(a){const c=this.ensureVisibleGraphicsIterator(),b=1===this.visibilityGroup;for(;!a.done;){a.madeProgress();var d=c.next();if(d.done)return this.resetVisibleGraphicsIterator(),!0;d=d.value;const e=d.info[this.visibilityGroup];if(e&&!e.culled){var f=
d.graphics3DGraphic;(f=(!b||f.isVisible())&&!this.isConflicted(d))&&this.addToBins(d);e.visible=f;this.setGraphicVisibility(d,f);B.drawPoly(e,f)}}return!1};g.resetIterators=function(){this.iterators.active=null;this.iterators.visible=null;this.iterators.sort=null};g.ensureActiveGraphicsIterator=function(){this.iterators.active||(this.iterators.active=I(this.graphics.active));return this.iterators.active};g.resetActiveGraphicsIterator=function(){this.iterators.active=null};g.ensureVisibleGraphicsIterator=
function(){this.iterators.visible||(this.iterators.visible=I(this.graphics.visible));return this.iterators.visible};g.resetVisibleGraphicsIterator=function(){this.iterators.visible=null};g.ensureSortGraphicsIterator=function(){this.iterators.sort||(this.iterators.sort=V(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup));return this.iterators.sort};g.resetSortGraphicsIterator=function(){this.iterators.sort=null};g.collectGraphics3DGraphics=function(a,c,b,d){var f=a.graphics3DGraphic;
if(!f.destroyed){var e=a.info[this.visibilityGroup];if(f.isVisible(0,3)){var l=this.getGraphicsLayers(f);p.empty(e.aabr);f=null;for(const q of l)if(this.layerSupportsDeconfliction(q)){l=q.stageObject.getGeometryRecord(0).material;if(w.isNone(f)){f=this.getProjectionInfo(q,c,ea);if(f.isOutsideScreen||this.isCulledBySlice(a,m)||w.isSome(b)&&this.isCulledByHorizon(f,b,d)){e.culled=!0;return}!S.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&e.visible&&(f.distance*=.7)}this.expandBoundingRect(e,q,l,f)}w.isNone(f)?
e.culled=!0:(e.distance=f.distance,e.culled=!1)}else e.culled=!0}};g.getProjectionInfo=function(a,c,b){const d=this._runningViewState.camera;a=a.stageObject;var f=a.getGeometryRecord(0);const e=f.material;var l=t.sphere.getCenter(a.getBounds());u.transformMat4(m,l,d.viewMatrix);l=f.geometry.vertexAttributes;f=l.get("normal").data;l=l.get("auxpos1").data;e.applyShaderOffsetsView(m,f,a.transformation,l,d,b.scaleInfo,m);x.set(v,m[0],m[1],m[2],1);x.transformMat4(y,v,d.projectionMatrix);u.scale(b.positionNDC,
y,1/y[3]);e.applyShaderOffsetsNDC(b.positionNDC,l,d,b.positionNDC,C);b.distanceWithoutPolygonOffset=d.depthNDCToWorld(C[2]);b.distance=C[2]===b.positionNDC[2]?b.distanceWithoutPolygonOffset:d.depthNDCToWorld(b.positionNDC[2]);x.set(y,b.positionNDC[0],b.positionNDC[1],b.positionNDC[2],1);x.transformMat4(v,y,c);x.scale(v,v,1/v[3]);u.set(b.positionView,m[0],m[1],m[2]);return b};g.isCulledByHorizon=function(a,c,b){u.copy(D.direction,a.positionView);u.set(D.origin,0,0,0);return Q.intersectRay(c,D,Y)?a.distanceWithoutPolygonOffset>
b:!1};g.isCulledBySlice=function(a,c){return a.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&t.boundedPlane.extrusionContainsPoint(this._runningViewState.slicePlane,c)};g.expandBoundingRect=function(a,c,b,{positionNDC:d,scaleInfo:f}){const e=this._runningViewState.camera;c=c.getScreenSize(fa);T.applyPrecomputedScaleFactor(c,f.factor,c);c[0]*=e.pixelRatio;c[1]*=e.pixelRatio;b=p.offset(b.calculateRelativeScreenBounds(c,f.factorAlignment.scale,Z),G.lerp(0,e.fullWidth,.5+.5*d[0]),G.lerp(0,
e.fullHeight,.5+.5*d[1]));d=this.iconMarginFactor;0!==d&&(d*=Math.min(p.width(b),p.height(b)),b[0]-=d,b[1]-=d,b[2]+=d,b[3]+=d);p.expand(a.aabr,b)};g.isConflicted=function(a){const c=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];for(let b=Math.floor(a.aabr[0]/this.accBinsSizeX);b<=Math.floor(a.aabr[2]/this.accBinsSizeX);b++)if(!(0>b||b>=this.accBinsNumX))for(let d=Math.floor(a.aabr[1]/this.accBinsSizeY);d<=Math.floor(a.aabr[3]/this.accBinsSizeY);d++){if(0>d||d>=this.accBinsNumY)continue;
const f=this.accBins[b][d];for(let e=0;e<f.length;e++){const l=f.data[e],q=l.info[this.visibilityGroup];if(q&&q.visible&&l.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,p.intersects(q.aabr,a.aabr)))return!0}}return!1};g.initBins=function(a,c){if(null==this.accBins){this.accBins=[];for(var b=0;b<this.accBinsNumX;b++){this.accBins.push([]);var d=this.accBins[this.accBins.length-1];for(let f=0;f<this.accBinsNumY;f++)d.push(new F)}}else for(b=0;b<this.accBinsNumX;b++)for(d=0;d<this.accBinsNumY;d++)this.accBins[b][d].clear();
this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};g.addToBins=function(a){var c=a.info[this.visibilityGroup],b=Math.floor(c.aabr[0]/this.accBinsSizeX);const d=Math.floor(c.aabr[2]/this.accBinsSizeX),f=Math.floor(c.aabr[1]/this.accBinsSizeY);for(c=Math.floor(c.aabr[3]/this.accBinsSizeY);b<=d;b++)if(!(0>b||b>=this.accBinsNumX))for(let e=f;e<=c;e++)0>e||e>=this.accBinsNumY||this.accBins[b][e].push(a)};g.setGraphicVisibility=function(a,c){a=a.graphics3DGraphic;
a.destroyed||(a.setVisibilityFlag(3,c,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(a,c))};z._createClass(k,[{key:"dirty",get:function(){return this._dirty}},{key:"state",get:function(){return this._state}},{key:"updating",get:function(){return 0!==this._state||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;const a=this._state/4;return this._dirty?.5*a:a}}]);return k}(L);A.__decorate([E.property({constructOnly:!0})],n.Deconflictor.prototype,
"view",void 0);A.__decorate([E.property({type:Boolean,readOnly:!0})],n.Deconflictor.prototype,"updating",null);n.Deconflictor=A.__decorate([K.subclass("esri.views.3d.layers.graphics.Deconflictor")],n.Deconflictor);const fa=P.create(),ea=new (function(){function h(){this.positionView=r.create();this.positionNDC=r.create();this.distanceWithoutPolygonOffset=this.distance=0;this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}
z._createClass(h,[{key:"isOutsideScreen",get:function(){const k=this.positionNDC;return-1>k[0]||-1>k[1]||-1>k[2]||1<=k[0]||1<=k[1]}}]);return h}());n.DeconflictorGraphic=function(h,k,g={}){this.graphics3DGraphic=h;this.slicePlaneEnabled=k;this.info=g};n.DeconflictorViewState=J;Object.defineProperty(n,"__esModule",{value:!0})});