// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Error ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/projection ../../../../chunks/vec2f64 ../../../../chunks/vec2 ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ../../../../chunks/vec3f32 ../../webgl-engine/lib/Object3D ./graphicUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ../../webgl-engine/materials/DefaultMaterial ../support/FastSymbolUpdates ../../../../chunks/mat2 ../../webgl-engine/lib/PathGeometry ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/PathMaterial".split(" "),
function(A,X,B,Y,D,L,m,M,Z,N,E,aa,O,ba,P,F,ca,da,G,ea,Q,fa,R,k,ha){function S(e,w,l){switch(w){case "world":for(const a of e.vertices)m.add(x,a.pos,e.offset),l.worldUpAtPosition(x,u),a.setFrameFromUpVector(u),a.computeRotationAxisAndAngleFromUpVector();break;case "path":m.add(x,e.vertices[0].pos,e.offset);l.worldUpAtPosition(x,u);k.computeMinimumRotationTangentFrame(e,u);for(const a of e.vertices)e=D.sign(m.dot(a.frame.right,a.vRight)),m.cross(a.rotationFrame.up,a.vRight,a.vLeft),m.scale(a.rotationFrame.up,
a.rotationFrame.up,e),m.normalize(a.rotationFrame.up,a.rotationFrame.up),w=m.dot(a.rotationFrame.up,a.frame.up),l=m.dot(a.rotationFrame.up,a.frame.right),m.scale(x,a.frame.up,-l),m.scale(T,a.frame.right,w),m.add(x,x,T),m.normalize(a.rotationFrame.right,x),k.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right),m.negate(x,a.vLeft),a.rotationAngle=-e*(Math.PI-D.acosClamped(m.dot(x,a.vRight))),0<Math.abs(a.rotationAngle)&&(e=D.reciprocalClamped(Math.cos(.5*a.rotationAngle)),fa.set(a.miterStretch,
1+(e-1)*a.rotationRight[0]*a.rotationRight[0],(e-1)*a.rotationRight[0]*a.rotationRight[1],(e-1)*a.rotationRight[0]*a.rotationRight[1],1+(e-1)*a.rotationRight[1]*a.rotationRight[1])),a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*D.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}function U(e,w,l){switch(e){case "symbol-value":return l;case "proportional":return w;default:return e}}function ia(e,w,l,a){e=e.stageObject;const b=e.geometryRecords,d=b.length;var g=0;ja.spatialReference=
a.spatialReference;for(let v=0;v<d;v++){const t=b[v].geometry;if(!R.isPathGeometry(t))continue;const y=t.path,f=y.builder.path;{var c=f;var n=w,z=l,r=a;let h=0;for(const p of c.vertices){const q=F.evaluateElevationAlignmentAtPoint(p.posES,z,n,r,V);h+=V.sampledElevation;m.add(u,p.pos,c.offset);r.setAltitude(q,u);m.subtract(p.pos,u,c.offset)}c.updatePathVertexInformation();c=h/c.vertices.length}g+=c;"world"!==t.upVectorAlignment&&S(f,t.upVectorAlignment,a);y.onPathChanged();t.invalidateBoundingInfo();
e.geometryVertexAttrsUpdated(v)}return g/d}const ka=["polyline"];let W=function(e){function w(a,b,d,g){a=e.call(this,a,b,d,g)||this;a._intrinsicSize=Z.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}X._inheritsLoose(w,e);var l=w.prototype;l.doLoad=async function(){const a=B.isSome(this.symbolLayer.width)?this.symbolLayer.width:B.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,b=B.isSome(this.symbolLayer.height)?this.symbolLayer.height:
a;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[a,1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?Q.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};var d=this.symbolLayer.anchor||"center";
this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");var g=this.symbolLayer.profile||"circle";switch(g){default:this._profile=k.Profile.circle(10);break;case "quad":this._profile=k.Profile.rect()}var c=[0,0];"center"!==d&&(c={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[d],this._profile.translate(c[0],c[1]));switch(this.symbolLayer.join||"simple"){case "round":this._extruder=new k.MiterExtruder(0,3);break;case "bevel":this._extruder=
new k.MiterExtruder(0,1);break;case "miter":this._extruder=new k.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new k.SimpleExtruder}d=this.symbolLayer.cap||"butt";switch(d){case "none":this._startCap=new k.NoCapBuilder;this._endCap=new k.NoCapBuilder;break;default:this._startCap=new k.TriangulationCapBuilder(this._profile,0);this._endCap=new k.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new k.TriangulationCapBuilder(this._profile,-.5);this._endCap=new k.TriangulationCapBuilder(this._profile,
.5,!0);break;case "round":g="quad"===g?!0:!1,this._startCap=new k.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:g,subdivisions:3}),this._endCap=new k.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:g,subdivisions:3})}g=B.get(this.symbolLayer,"material","color");c=this._getCombinedOpacityAndColor(g);g=L.fromArray(c);c=c[3];d={diffuse:g,ambient:g,opacity:c,transparent:1>c||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,
cullFace:"none"===d?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(N.set(this._intrinsicSize,a,b),!P.isValidSize(this._intrinsicSize[0])||!P.isValidSize(this._intrinsicSize[1])))throw new Y("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||N.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(Object.assign(d,
this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new ha.PathMaterial(d)):(d.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ea.DefaultMaterial(d));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(this._material)};l.destroy=function(){e.prototype.destroy.call(this);this._context.stage.remove(this._material);this._material=
null};l.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,ka,this.symbolLayer.type))return null;const d=this.setGraphicElevationContext(b,new ca.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,d,b.uid)};l.layerOpacityChanged=function(){var a=B.get(this.symbolLayer,"material","color");a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,transparent:1>a||this.needsDrivenTransparentPass});return!0};l.layerElevationInfoChanged=
function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,F.needsElevationUpdates3D)};l.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};l.pixelRatioChanged=function(){return!0};l.applyRendererDiff=function(a,b){for(const d in a.diff)switch(d){case "visualVariables":if(Q.updateFastSymbolUpdatesState(this._fastUpdates,
b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};l.getVertexData=function(a){let b=0;const d=a.paths,g=[],c=a.spatialReference,n=this._context.elevationProvider.spatialReference,z=this._context.renderCoordsHelper.spatialReference;for(var r of d)b+=r.length;r=new Float64Array(3*b);const v=new Float64Array(3*b),t=new Float64Array(3*b);let y=0;for(const f of d){g.push({index:y,numVertices:f.length});for(const h of f)r[y++]=
h[0],r[y++]=h[1],r[y++]=a.hasZ?h[2]:0}a=!0;c.equals(n)?this._copyVertices(r,0,v,0,b):a=M.projectBuffer(r,c,0,v,n,0,b);n.equals(z)?this._copyVertices(v,0,t,0,b):M.projectBuffer(v,n,0,t,z,0,b);return{pathVertexDataInfos:g,vertexDataGS:r,vertexDataES:v,vertexDataRS:t,projectionSuccess:a,terrainElevation:0}};l._copyVertices=function(a,b,d,g,c){b*=3;g*=3;for(let n=0;n<c;++n)d[g++]=a[b++],d[g++]=a[b++],d[g++]=a[b++]};l._createAs3DShape=function(a,b,d,g){var c=a.geometry,n=[];const z=[],r=[],v=c.spatialReference,
t=E.create(),y=this._context.renderCoordsHelper;c=this.getVertexData(c);if(!c.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0<c.pathVertexDataInfos.length){for(let H=0;H<c.pathVertexDataInfos.length;++H){var f=c.pathVertexDataInfos[H],h=f.index;f=f.numVertices;if(2>f){this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");continue}if(B.isSome(this._context.clippingExtent)&&
(E.empty(t),E.expandWithBuffer(t,c.vertexDataES,3*h,f),!E.intersectsClippingArea(t,this._context.clippingExtent)))continue;var p=[];for(var q=h;q<h+3*f;){const I=q++,J=q++,K=q++,C=new k.PathVertex;m.set(C.posGS,c.vertexDataGS[I],c.vertexDataGS[J],c.vertexDataGS[K]);m.set(C.posES,c.vertexDataES[I],c.vertexDataES[J],c.vertexDataES[K]);const la=F.evaluateElevationAlignmentAtPoint(C.posES,this._context.elevationProvider,d,y,null);m.set(u,c.vertexDataRS[I],c.vertexDataRS[J],c.vertexDataRS[K]);y.setAltitude(la,
u);m.set(C.pos,u[0],u[1],u[2]);p.push(C)}h=new k.Path(p);S(h,this.upVectorAlignment,this._context.renderCoordsHelper);h=new k.Builder(h,this._profile,this._extruder,this._startCap,this._endCap);f=null;this._fastUpdates.enabled?(q=this._fastUpdates.visualVariables,f=q.size?G.getAttributeValue(q.size.field,a):0,p=q.color?G.getAttributeValue(q.color.field,a):0,q=q.opacity?G.getAttributeValue(q.opacity.field,a):0,f=new k.FastUpdatePathGeometry(h,f,p,q)):(f=[this._intrinsicSize[0],this._intrinsicSize[1]],
this._drivenProperties.size&&(f[0]*=U(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),f[1]*=U(b.size[2],"symbol-value"===b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),p=null,this._drivenProperties.color&&(p=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(p=p?[p[0],p[1],p[2],b.opacity]:[1,1,1,b.opacity]),h=new k.StaticPathGeometry(h),h.bake(f),p&&h.bakeVertexColors(p),f=h);const {vertexAttributes:ma,indices:na}=
f.createGeometryData();h=new R.PathGeometry(ma,na,f,v,this.upVectorAlignment,this.stencilWidth);n.push(h);z.push(this._material);r.push(f.xform)}if(0<n.length)return a=new ba.Object3D({geometries:n,materials:z,transformations:r,metadata:{layerUid:this._context.layer.uid,graphicUid:g}}),n=new da(this,a,n,null,null,ia,d),n.alignedSampledElevation=c.terrainElevation,n.needsElevationUpdates=F.needsElevationUpdates3D(d.mode),n}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");
return null};return w}(G.Graphics3DSymbolLayer);const ja=aa.makeDehydratedPoint(0,0,0,null),u=L.create(),x=O.create(),T=O.create(),V={verticalDistanceToGround:0,sampledElevation:0};A.Graphics3DPathSymbolLayer=W;A.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;A.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;A.NUM_ROUND_JOIN_SUBDIVISIONS=3;A.default=W;Object.defineProperty(A,"__esModule",{value:!0})});