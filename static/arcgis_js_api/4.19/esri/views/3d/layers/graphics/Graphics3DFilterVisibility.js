// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/promiseUtils ../../../../core/Accessor ../../../../core/Handles ../../../../core/watchUtils ../../../support/Scheduler ../../../layers/support/FeatureFilter ./QueryEngine ../support/floorFilterUtils".split(" "),
function(f,h,k,A,e,n,B,p,C,q,D,E,F,r,t,u,v,l,w,x,y){const z=n.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");f.Graphics3DFilterVisibility=function(m){function g(...a){a=m.call(this,...a)||this;a.filter=null;a._dirty=!1;a._querying=!1;a._handles=new u;return a}h._inheritsLoose(g,m);var d=g.prototype;d.setup=function(a,b){this._layerView=a;this._core=b;this._objectIdField=a.layer.objectIdField;this._queryEngine=new x["default"]({layerView:this._layerView,task:l.Task.FILTER_VISIBILITY});
this._handles.add(this._layerView.view.resourceController.scheduler.registerTask(l.Task.FILTER_VISIBILITY,c=>this._update(c),()=>this._needsUpdate()));this._handles.add(v.on(b.owner,"loadedGraphics","after-changes",c=>this._graphicsChanged(c),()=>this.dirty=!0));this.filterChanged()};d.destroy=function(){this._handles.destroy();this._handles=null;this.clear();this._core=this._layerView=null};d.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(2)),
this._queryResult=null,this._querying=!1);this.dirty=!1;this.notifyChange("updating")};d._graphicsChanged=function(a){this._queryEngine&&0===(a.type&1)||(this.dirty=!0)};d.updateVisibility=function(a){this.active&&(a.hasVisibilityFlag(2,0)||a.setVisibilityFlag(2,!1,0),this.dirty=!0)};d.filterChanged=function(){const a=this.recomputeFilter();a!==this.filter&&(this.filter=a,this.dirty=!0)};d.recomputeFilter=function(){var a="filter"in this._layerView?this._layerView.filter:null;const b="timeExtent"in
this._layerView?this._layerView.timeExtent:null,c=y.getFloorFilterClause(this._layerView);if(e.isNone(b)&&e.isNone(c))return a;a=e.isSome(a)?a.clone():new w;e.isSome(b)&&(a.timeExtent=e.isSome(a.timeExtent)?a.timeExtent.intersection(b):b);e.isSome(c)&&(a.where=null==a.where||""===a.where?c:`(${a.where}) AND (${c})`);return a};d._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult};d._update=function(a){this.active?(!this._dirty||this._querying||a.done||(this._querying=
!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then(b=>{this._queryResult=b;this._querying=!1}).catch(b=>{r.isAbortError(b)||(z.warn("FeatureFilter query failed: "+b,{error:b}),this._queryResult=new Set,this._core.graphics3DGraphics.forEach(c=>this._queryResult.add(this._getFeatureId(c.graphic))),this._querying=!1)}),a.madeProgress()),this._queryResult&&!a.done&&(this._core.modifyGraphics3DGraphicVisibilities(b=>{if(a.done)return!1;const c=this._queryResult.has(this._getFeatureId(b.graphic));
return b.setVisibilityFlag(2,c,0)?(a.madeProgress(),!0):!1}),a.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()};d._getFeatureId=function(a){return null==a.objectId?a.attributes[this._objectIdField]:a.objectId};h._createClass(g,[{key:"updating",get:function(){return this._dirty||this._querying||null!=this._queryResult}},{key:"active",get:function(){return this.filter&&0<this._core.graphics3DGraphics.size}},{key:"dirty",set:function(a){this._dirty!==a&&(this._dirty=a,this.notifyChange("updating"))}}]);
return g}(t);k.__decorate([p.property({readOnly:!0})],f.Graphics3DFilterVisibility.prototype,"updating",null);f.Graphics3DFilterVisibility=k.__decorate([q.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],f.Graphics3DFilterVisibility);Object.defineProperty(f,"__esModule",{value:!0})});