// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Logger ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../intl/number ../../../../request ../../../../core/asyncUtils ../../../../core/byteSizeEstimations ../../../../layers/support/featureQueryAll".split(" "),function(u,v,h,q,w,x,A,B,r,y,t){const C=q.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");q=function(){function p(a,b){this.layer=a;this.warnMaximumChangedObjectsExceeded=
!1;this.changedObjectIds=new Set;this.pendingFetchAbortController=x.createAbortController();this.interactiveEditingSessions=null;this._maximumNumberOfEditOVerrides=5E4;this.memCache=b.getMemCache(`${a.uid}-attribute-overrides`);this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal);this.pendingFetchChangedObjectIds.then(()=>this.pendingFetchAbortController=null)}var g=p.prototype;g.destroy=function(){this.layer=null;this.memCache.destroy();this.memCache=
null;this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null);this.pendingFetchChangedObjectIds=null};g.createInteractiveEditSession=function(a){this.changedObjectIds.add(a);h.isNone(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const b=this.interactiveEditingSessions,c=new D(a,{rollback:()=>{w.remove(b,c);0===b.length&&(this.interactiveEditingSessions=null)},commit:e=>{for(const [d,k]of e)this.updateValue(a,d,k)}});
b.unshift(c);return c};g.apply=async function(a,b,c){if(!h.isNone(b)){var {loadedAttributes:e,attributeData:d}=b;if(!h.isNone(e)&&0!==e.length&&!h.isNone(d)&&(await x.whenOrAbort(this.pendingFetchChangedObjectIds,c),0!==this.changedObjectIds.size)){b={loadedAttributes:e,attributeData:d};var k=this.getOverridesFromCache(a,b,this.changedObjectIds),{objectIds:f,fieldNames:n}=k;c=await this.queryOverridesFromAssociatedLayer(f,n,c);h.isNone(c)||this.processOverridesFromAssociatedLayer(a,c,n,b)}}};g.updateValue=
function(a,b,c){this.changedObjectIds.add(a);this.cacheValue(a,b,c)};g.cacheValue=function(a,b,c){this.memCache.put(this.getCacheKey(a,b),c,this.memCacheValueSize(c))};g.getOverridesFromCache=function(a,{loadedAttributes:b,attributeData:c},e){const d=new Set,k=[];for(var f of b)k[f.index]=c[f.name];c=new Set;for(f=0;f<a.length;f++){const n=a[f];if(e.has(n))for(const l of b){const m=this.fromCache(n,l.index);void 0!==m?k[l.index][f]=m:(d.add(n),c.add(l.name))}}return{objectIds:Array.from(d),fieldNames:Array.from(c)}};
g.fromCache=function(a,b){const c=this.fromInteractiveEditingSession(a,b);if(void 0!==c)return c;a=this.getCacheKey(a,b);return this.memCache.get(a)};g.fromInteractiveEditingSession=function(a,b){if(!h.isNone(this.interactiveEditingSessions))for(const c of this.interactiveEditingSessions){if(c.objectId!==a)continue;const e=c.get(b);if(void 0!==e)return e}};g.getCacheKey=function(a,b){return`${a}-${b}`};g.queryOverridesFromAssociatedLayer=async function(a,b,c){if(0===a.length||0===b.length)return null;
a=a.sort((k,f)=>k-f);this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const e=h.unwrap(this.layer.associatedLayer),d=e.createQuery();d.where="1\x3d1";d.returnGeometry=!1;d.outFields=[e.objectIdField,...b];d.cacheHint=!0;d.objectIds=a;b=t.getMaximumQuerySize(e);a=a.length>b?w.splitIntoChunks(a,b).map(k=>{const f=d.clone();f.objectIds=k;return r.resultOrAbort(t.queryAllJSON(e,f,{signal:c}))}):[r.resultOrAbort(t.queryAllJSON(e,
d,{signal:c}))];return(await Promise.all(a)).reduce((k,f)=>k.concat(f.ok?f.value.features:[]),[])};g.logMaximumObjectsExceededWarning=function(){let a=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${A.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const b=this.layer.portalItem;a=b&&b.loaded?a+` (${b.portal.url}/home/item.html?id=${b.id}#settings)`:
a+` (${this.layer.parsedUrl.path})`;C.warn(`("${this.layer.title}"):`,`${a}.`)};g.processOverridesFromAssociatedLayer=function(a,b,c,{loadedAttributes:e,attributeData:d}){const k=h.unwrap(this.layer.associatedLayer).objectIdField,f=c.map(l=>d[l]),n=new Map(e.map(l=>[l.name,l.index]));e=c.map(l=>n.get(l));a=new Map(Array.from(a,(l,m)=>[l,m]));for(const l of b){b=l.attributes[k];for(let m=0;m<c.length;m++){const E=e[m],F=a.get(b),z=l.attributes[c[m]];f[m][F]=z;this.cacheValue(b,E,z)}}};g.memCacheValueSize=
function(a){return"string"===typeof a?y.estimateStringByteSize(a):y.estimateNumberByteSize()};g.fetchChangedObjectIds=async function(a){var b,c,e,d=this.layer;await d.load({signal:a});this.changedObjectIds.clear();if(!h.isNone(d.associatedLayer)&&null!=(b=d.associatedLayer.capabilities)&&null!=(c=b.operations)&&c.supportsChangeTracking){b=this.getFetchChangedObjectIdsServerGen();if(h.isNone(b))return null;c=d.associatedLayer.layerId;a=await r.result(B(`${d.associatedLayer.url}/extractChanges`,{method:"post",
query:{f:"json",returnIdsOnly:!0,layers:`${c}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:c,serverGen:b}])},timeout:1E4,signal:a}));a=a.ok&&null!=(e=a.value.data)&&e.edits?h.get(a.value.data.edits[0],"objectIds","updates"):null;if(h.isSome(a))for(e=Math.min(this._maximumNumberOfEditOVerrides,a.length),e<a.length&&(this.warnMaximumChangedObjectsExceeded=!0),a=a.sort((k,f)=>k-f),d=0;d<e;d++)this.changedObjectIds.add(a[d])}};g.getFetchChangedObjectIdsServerGen=
function(){var a=this.layer;if(h.isSome(a.serviceUpdateTimeStamp)&&h.isSome(a.serviceUpdateTimeStamp.lastUpdate))return a.serviceUpdateTimeStamp.lastUpdate;a=a.associatedLayer;return h.isSome(a)&&h.isSome(a.serverGens)&&h.isSome(a.serverGens.minServerGen)?a.serverGens.minServerGen:null};v._createClass(p,[{key:"test",get:function(){const a=this;return{changedObjectIds:Array.from(this.changedObjectIds),pendingFetchChangedObjectIds:this.pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return a._maximumNumberOfEditOVerrides},
set maximumNumberOfEditOVerrides(b){a._maximumNumberOfEditOVerrides=b}}}}]);return p}();let D=function(){function p(a,b){this.objectId=a;this.options=b;this.updates=new Map;this.state=0}var g=p.prototype;g.get=function(a){return this.updates.get(a)};g.set=function(a,b){this.isActive&&this.updates.set(a,b)};g.rollback=function(){this.isActive&&(this.state=2,this.options.rollback())};g.commit=function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())};v._createClass(p,
[{key:"isActive",get:function(){return 0===this.state}}]);return p}();u.I3SAttributeOverrides=q;Object.defineProperty(u,"__esModule",{value:!0})});