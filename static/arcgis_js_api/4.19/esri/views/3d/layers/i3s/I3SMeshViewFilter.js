// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/arrayUtils ../../../../core/Accessor ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../geometry ../../../../chunks/vec3 ../../../../core/unitUtils ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ../../../../geometry/projection ../../../../core/sql/WhereClause ../../../../geometry/support/aaBoundingBox ../../../layers/support/FeatureFilter ./I3SUtil".split(" "),
function(V,p,N,r,oa,v,W,pa,t,qa,X,ra,sa,ta,O,Y,E,F,ua,u,Z,aa,G,w,ba,ca,da,P){async function ea(){return q?q:q=await new Promise(function(c,b){V(["../../../../geometry/geometryEngine"],c,b)})}function C(c,b){if(!c)return null;if("disjoint"===b&&"polygon"===c.type){const a=Array(c.rings.length);for(b=0;b<c.rings.length;++b){var k=G.fromValues(Infinity,Infinity,-Infinity,-Infinity);G.expandWithNestedArray(k,c.rings[b]);a[b]={type:"polygon",rings:[c.rings[b]],spatialReference:c.spatialReference,aabr:k}}a.sort((d,
g)=>d.aabr[0]-g.aabr[0]);const f=new Set,n=new O.PositionHint;for(c=0;c<a.length;++c){const d=a[c];for(b=c+1;b<a.length;++b){k=a[b];if(k.aabr[0]>=d.aabr[2])break;f.add(k)}f.forEach(g=>{d!==g&&(g.aabr[2]<=d.aabr[0]?f.delete(g):q.intersects(d,g)&&(d.rings=d.rings.concat(g.rings),G.expand(d.aabr,g.aabr),delete d._geVersion,f.delete(g),g=O.indexOf(a,g,a.length,n),a.splice(g,1)))});f.add(d)}for(const d of a)delete d.aabr;return a}return[c]}function fa(c,b,k,a){const f=Q(c,k);return b.every(n=>1!==R(n,
f,a))}function ha(c,b,k,a,f,n,d){const g=n[0].spatialReference||a.spatialReference;if(w.projectBoundingSphere(b.node.mbs,f,D,g)){f=Q(D,g);var l=ia(d,a,g,k,b.objectHandle);for(const e of n){if(0===c.length)break;switch(R(e,f,d)){case 1:c.length=0;return;case 0:continue}P.filterInPlace(c,b.featureIds,h=>ja(e,h,l))}}else z.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}function ia(c,b,k,a,f){b=b.renderSpatialReference;const n=new Map,d={rings:[[[0,
0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:k};d.rings[0][3]=d.rings[0][0];let g,l;switch(c){case "intersects":g=(e,h)=>q.intersects(e,h)?0:2;l=H;break;case "contains":g=(e,h)=>q.contains(e,h)?2:1;l=H;break;default:g=(e,h)=>q.disjoint(e,h)?2:1,l=S}return{collection:a,object:f,type:c,maskSR:k,renderSR:b,aabbCache:n,triangle:d,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:g,geometryTest:l}}function Q(c,b){const k={x:c[0],y:c[1],hasZ:!1,
hasM:!1,type:"point",spatialReference:b};c=b.isWGS84||b.isWebMercator?q.geodesicBuffer(k,c[3],1):q.buffer(k,c[3],1);c.type="polygon";return c}function R(c,b,k){switch(k){case "intersects":case "contains":return H(c,b);case "disjoint":return S(c,b)}}function H(c,b){return q.intersects(c,b)?q.contains(c,b)?0:2:1}function S(c,b){return q.intersects(c,b)?q.contains(c,b)?1:2:0}function ja(c,b,k){const {collection:a,object:f,renderSR:n,maskSR:d,geometryTest:g,aabbCache:l}=k;var e=l.get(b);if(!e){e=a.getObjectTransform(f);
a.getComponentAabb(f,b,x);var h=[[x[0],x[1],0],[x[0],x[4],0],[x[3],x[4],0],[x[3],x[1],0]];for(var m=0;4>m;++m)u.transformMat3(h[m],h[m],e.rotationScale),u.add(h[m],h[m],e.position),w.projectVectorToVector(h[m],n,h[m],d);e={rings:[h],hasZ:!1,hasM:!1,type:"polygon",spatialReference:d};e.rings[0][4]=e.rings[0][0];l.set(b,e)}switch(g(c,e)){case 1:return!1;case 0:return!0}const {triangle:B,triangleTest:ka,positions:T}=k;e=B.rings[0][0];h=B.rings[0][1];m=B.rings[0][2];const A=a.getObjectTransform(f);a.getComponentPositions(f,
b,T);const {indices:I,data:y,stride:J,startIndex:la,endIndex:ma}=T;for(b=la;b<ma;b+=3){const K=J*I[b+0],L=J*I[b+1],M=J*I[b+2];u.set(e,y[K+0],y[K+1],y[K+2]);u.set(h,y[L+0],y[L+1],y[L+2]);u.set(m,y[M+0],y[M+1],y[M+2]);u.transformMat3(e,e,A.rotationScale);u.transformMat3(h,h,A.rotationScale);u.transformMat3(m,m,A.rotationScale);u.add(e,e,A.position);u.add(h,h,A.position);u.add(m,m,A.position);w.projectVectorToVector(e,n,e,d);w.projectVectorToVector(h,n,h,d);w.projectVectorToVector(m,n,m,d);if(!(Math.abs((h[0]-
e[0])*(m[1]-e[1])-(h[1]-e[1])*(m[0]-e[0]))<na))switch(delete B._geVersion,ka(c,B)){case 1:return!1;case 0:return!0}}switch(k.type){case "intersects":return!1;default:return!0}}const z=W.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");p.I3SMeshViewFilter=function(c){function b(a){a=c.call(this,a)||this;a._projectionEngineLoaded=!1;return a}N._inheritsLoose(b,c);var k=b.prototype;k.initialize=function(){aa.whenOnce(this,"filter.geometry").then(()=>this.loadAsyncModule(ea().then(a=>{this.destroyed||
(this._geometryEngine=a,this.applyFilters())})))};k.addFilters=function(a,f,n,d){const g=this.sortedObjectIds;v.isSome(g)&&a.push(e=>P.objectIdFilter(g,!0,e));this.addSqlFilter(a,this.parsedWhereClause);const l=this.parsedGeometry;if(v.isSome(l)){const e=this.spatialRelationship;a.push((h,m)=>ha(h,m,d,f,n,l,e))}};k.isMBSGeoemtryVisible=function(a,f,n){const d=this.parsedGeometry;if(v.isSome(d)){const g=this.spatialRelationship;f=d[0].spatialReference||f;return w.projectBoundingSphere(a,n,D,f)?fa(D,
d,f,g):(z.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0};b.checkSupport=function(a){if(a.timeExtent)return z.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1;a=a.spatialRelationship;return null!=a&&0<=U.indexOf(a)?!0:(z.warn(`Filters with spatialRelationship other than ${U.join(", ")} are not supported for mesh scene layers`),!1)};N._createClass(b,[{key:"sortedObjectIds",get:function(){if(v.isNone(this.filter.objectIds))return null;
const a=new Float64Array(this.filter.objectIds);a.sort();return a}},{key:"parsedWhereClause",get:function(){const a=v.isSome(this.filter)?this.filter.where:null;if(v.isNone(a)||!a)return null;try{return ba.WhereClause.create(a,this.layerFieldsIndex)}catch(f){z.error(`Failed to parse filter where clause: ${f}`)}return null}},{key:"parsedGeometry",get:function(){if(v.isNone(this.filter)||!this._geometryEngine)return null;var {geometry:a}=this.filter;if(v.isNone(a))return null;const {distance:f,units:n}=
this.filter,d=this.spatialRelationship;a="mesh"===a.type?a.extent:a;if(v.isNone(f)||0===f)return C(a,d);const g=n||Z.getUnitString(a.spatialReference);if(a.spatialReference.isWGS84)return a=this._geometryEngine.geodesicBuffer(a,f,g),C(a,d);if(F.canProject(a,E.WGS84))return a=F.project(this._geometryEngine.geodesicBuffer(F.project(a,E.WGS84),f,g),a.spatialReference),C(a,d);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(w.load().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;
let l=null;try{l=w.project(a,E.WGS84)}catch(e){}if(l)try{l=w.project(this._geometryEngine.geodesicBuffer(l,f,g),a.spatialReference)}catch(e){l=null}l||z.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${a.spatialReference.wkid}) to WGS84.`);return C(l,d)}},{key:"spatialRelationship",get:function(){return v.isSome(this.filter)?this.filter.spatialRelationship:"intersects"}}]);return b}(Y);r.__decorate([t.property({type:da})],p.I3SMeshViewFilter.prototype,"filter",
void 0);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"applyFilters",void 0);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"addSqlFilter",void 0);r.__decorate([t.property({readOnly:!0})],p.I3SMeshViewFilter.prototype,"sortedObjectIds",null);r.__decorate([t.property({readOnly:!0})],p.I3SMeshViewFilter.prototype,
"parsedWhereClause",null);r.__decorate([t.property({readOnly:!0})],p.I3SMeshViewFilter.prototype,"parsedGeometry",null);r.__decorate([t.property({readOnly:!0})],p.I3SMeshViewFilter.prototype,"spatialRelationship",null);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0);r.__decorate([t.property()],p.I3SMeshViewFilter.prototype,"_geometryEngine",void 0);p.I3SMeshViewFilter=r.__decorate([X.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],p.I3SMeshViewFilter);
let q;const U=["contains","intersects","disjoint"],D=[0,0,0,0],na=2**-32,x=ca.create();Object.defineProperty(p,"__esModule",{value:!0})});