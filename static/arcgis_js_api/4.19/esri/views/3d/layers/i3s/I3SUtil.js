// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/typedArrayUtil ../../../../core/maybe ../../../../core/Error ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../request ../../../../chunks/vec3 ../../../../geometry/projectionEllipsoid ../../../../chunks/mat4 ../../../../geometry/support/aaBoundingRect ../../../../geometry/projection ../../../../tasks/support/Query ../../../../chunks/mat4f64 ../../../../chunks/vec4f64 ../../../../chunks/quat ../../../../geometry/support/aaBoundingBox ../support/edgeUtils ../../webgl-engine/lib/Texture ../support/symbolColorUtils ../../../../chunks/quatf32 ../../support/orientedBoundingBox ./I3SBinaryReader ./I3SProjectionUtil".split(" "),
function(m,O,P,w,v,F,fa,Q,ha,ia,q,C,ja,z,A,ka,R,K,D,la,S,T,ma,na,G,oa,pa){function L(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function U(a,b){var c=b[0],d=b[1];b=b[3];const e=a[0]-c;c-=a[2];const f=a[1]-d;a=d-a[3];d=Math.max(e,c,0);const g=Math.max(f,a,0);d=d*d+g*g;return d>b*b?0:0<d?1:-Math.max(e,c,f,a)>b?3:2}function V(a,b,c){const d=[],e=c&&c.missingFields;c=c&&c.originalFields;for(const f of a){a=f.toLowerCase();let g=!1;for(const l of b)if(a===l.name.toLowerCase()){d.push(l.name);
g=!0;c&&c.push(f);break}!g&&e&&e.push(f)}return d}function qa(a,b,c){const d=new Map,e=[];c=c();for(const l of a){var f=l.attributes[b];for(var g=0;g<c.length;g++){a=c[g];const r=a.featureIds.indexOf(f);if(0<=r){f=d.get(a.node);f||(f={node:a.node,indices:[],graphics:[]},e.push(f),d.set(a.node,f));f.indices.push(r);for(f.graphics.push(l);0<g;g--)c[g]=c[g-1];c[0]=a;break}}}return e}async function ra(a,b,c,d){b.sort((g,l)=>g.attributes[c]-l.attributes[c]);var e=b.map(g=>g.attributes[c]);const f=[];d=
V(d,a.fields,{originalFields:f});a=await W(a,e,d);for(e=0;e<b.length;e++){const g=b[e],l=a[e],r={};if(g.attributes)for(const n in g.attributes)r[n]=g.attributes[n];for(let n=0;n<f.length;n++)r[f[n]]=l[d[n]];g.attributes=r}return b}function W(a,b,c){var d=a.capabilities.query.maxRecordCount;if(null!=d&&b.length>d)return d=F.splitIntoChunks(b,d),Promise.all(d.map(e=>W(a,e,c))).then(F.flatten);d=new ka({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return a.queryFeatures(d).then(e=>{if(e&&
e.features&&e.features.length===b.length)return e.features.map(f=>f.attributes);throw new v("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer");})}function sa(a,b,c,d,e){const f=[];for(const g of b)g&&-1!==e.indexOf(g.name)&&f.push({url:`${a}/nodes/${c.resources.attributes}/attributes/${g.key}/0`,storageInfo:g});return fa.eachAlways(f.map(g=>ia(g.url,{responseType:"array-buffer"}).then(l=>oa.readBinaryAttribute(g.storageInfo,l.data)))).then(g=>{const l=[];
for(const r of d){const n={};for(let t=0;t<g.length;t++)null!=g[t].value&&(n[f[t].storageInfo.name]=X(g[t].value,r));l.push(n)}return l})}function X(a,b){if(!a)return null;b=a[b];return P.isInt16Array(a)?-32768===b?null:b:P.isInt32Array(a)?b===ta?null:b:b!==b?null:b}function Y(a){var b=a.store.indexCRS||a.store.geographicCRS;const c=void 0===b?a.store.indexWKT:void 0;if(c)if(a.spatialReference){if(c!==a.spatialReference.wkt)throw new v("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",
{});}else throw new v("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});b=b?new Q(L(b)):a.spatialReference;return b.equals(a.spatialReference)?a.spatialReference:b}function Z(a){var b=a.store.vertexCRS||a.store.projectedCRS;const c=void 0===b?a.store.vertexWKT:void 0;if(c)if(a.spatialReference){if(c!==a.spatialReference.wkt)throw new v("layerview:store-spatial-reference-wkt-vertex-incompatible",
"The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{});}else throw new v("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});b=b?new Q(L(b)):a.spatialReference;return b.equals(a.spatialReference)?a.spatialReference:b}function H(a,b,c){if(!ha.canProject(a,b))throw new v("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",
{});if("local"===c&&a.isGeographic)throw new v("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{});}function aa(a,b,c){const d=Y(a);a=Z(a);H(d,b,c);H(a,b,c)}function ba(a,b,c,d,e=0){if(d===C.getSphericalPCPF(d))if(b.isGeographic){var f=C.getReferenceEllipsoid(b);d=1+Math.max(0,e)/(f.radius+a.center[2]);q.set(c.center,a.center[0],a.center[1],a.center[2]+e);A.projectBuffer(c.center,b,0,c.center,C.getSphericalPCPF(b),0,1);D.copy(c.quaternion,a.quaternion);
D.conjugate(y,a.quaternion);q.set(h,0,0,1);q.transformQuat(h,h,y);q.set(h,a.halfSize[0]*Math.abs(h[0]),a.halfSize[1]*Math.abs(h[1]),a.halfSize[2]*Math.abs(h[2]));q.scale(h,h,f.inverseFlattening);q.add(c.halfSize,a.halfSize,h);q.scale(c.halfSize,c.halfSize,d)}else{{G.corners(a,M);q.set(c.center,a.center[0],a.center[1],a.center[2]+e);A.computeLinearTransformation(b,c.center,u,C.getSphericalPCPF(b));q.set(c.center,u[12],u[13],u[14]);d=2*Math.sqrt(1+u[0]+u[5]+u[10]);y[0]=(u[6]-u[9])/d;y[1]=(u[8]-u[2])/
d;y[2]=(u[1]-u[4])/d;y[3]=.25*d;D.multiply(c.quaternion,y,a.quaternion);D.conjugate(y,c.quaternion);let g=d=a=0;for(f of M)f[2]+=e,A.projectBuffer(f,b,0,f,C.getSphericalPCPF(b),0,1),q.sub(h,f,c.center),q.transformQuat(h,h,y),a=Math.max(a,Math.abs(h[0])),d=Math.max(d,Math.abs(h[1])),g=Math.max(g,Math.abs(h[2]));q.set(c.halfSize,a,d,g)}}else a===c?(c.center[2]+=e,A.projectBuffer(c.center,b,0,c.center,d,0,1)):(q.set(c.center,a.center[0],a.center[1],a.center[2]+e),A.projectBuffer(c.center,b,0,c.center,
d,0,1),D.copy(c.quaternion,a.quaternion),q.copy(c.halfSize,a.halfSize))}const B=la.create(),ua=K.create(),ta=-(2**31);K=S.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});let ca=function(){this.material=this.edgeMaterial=null;this.castShadows=!0};const u=R.create(),y=na.create(),M=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],N=z.create(),I=z.create(),da=G.create(),h=[0,0,0],ea={data:Array(72),size:3},J=R.create();m.SymbolInfo=ca;m.addWraparound=function(a,b){return(a|0)+(b|
0)|0};m.checkPointCloudLayerCompatibleWithView=function(a,b){H(a.spatialReference,b.spatialReference,b.viewingMode)};m.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new v("pointcloud:unsupported-geometry-schema",
"The geometry schema of this point cloud scene layer is not supported.",{});};m.checkSceneLayerCompatibleWithView=function(a,b){aa(a,b.spatialReference,b.viewingMode)};m.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(b=a.store.defaultGeometrySchema,b=!!(null!=b.geometryType&&"triangles"!==b.geometryType||null!=b.topology&&"PerAttributeArray"!==b.topology||null==b.vertexAttributes||null==b.vertexAttributes.position));if(b)throw new v("scenelayer:unsupported-geometry-schema",
"The geometry schema of this scene layer is not supported.",{url:a.parsedUrl.path});};m.checkSpatialReference=H;m.checkSpatialReferences=aa;m.computeVisibilityObb=function(a,b,c,d,e,f){if(!f||0===f.length||w.isNone(b))return null;const g=pa.computeGlobalTransformation(a.mbs,e,c,b);ja.invert(J,g);let l;const r=()=>{if(!l)if(l=M,z.empty(I),w.isSome(a.serviceObb)){ba(a.serviceObb,c,da,b,e);G.corners(da,l);for(var k of l)q.transformMat4(k,k,J),z.expandPointInPlace(I,k)}else{var p=a.mbs;k=p[3];A.projectVectorToVector(p,
c,h,b);q.transformMat4(h,h,J);h[2]+=e;for(p=0;8>p;++p){const x=l[p];q.copy(x,[h[0]+(p&1?k:-k),h[1]+(p&2?k:-k),h[2]+(p&4?k:-k)]);z.expandPointInPlace(I,x)}}};let n=Infinity,t=-Infinity;const E=k=>{if("replace"===k.type&&(k=k.geometry,k.hasZ)){z.empty(N);var p=k.spatialReference||d;k=k.rings.reduce((x,va)=>va.reduce((wa,xa)=>{A.projectVectorToVector(xa,p,h,b);q.transformMat4(h,h,J);z.expandPointInPlace(N,h);return Math.min(h[2],wa)},x),Infinity);r();z.intersects(I,N)&&(n=Math.min(n,k),t=Math.max(t,
k))}};f.forEach(k=>E(k));if(Infinity===n)return null;f=(k,p,x)=>{q.transformMat4(h,x,g);k[p+0]=h[0];k[p+1]=h[1];k[p+2]=h[2];p+=24;x[2]=n;q.transformMat4(h,x,g);k[p+0]=h[0];k[p+1]=h[1];k[p+2]=h[2];p+=24;x[2]=t;q.transformMat4(h,x,g);k[p+0]=h[0];k[p+1]=h[1];k[p+2]=h[2]};for(let k=0;8>k;++k)f(ea.data,3*k,l[k]);return G.compute(ea)};m.containsDraco=function(a){if(O("disable-feature:i3s-draco")||!a)return!1;for(const b of a)for(const c of b.geometryBuffers)if("draco"===c.compressedAttributes.encoding)return!0;
return!1};m.encodingToMimeType=function(a){switch(a){case 1:return T.Texture.BASIS_ENCODING;case 2:return T.Texture.DDS_ENCODING;case 4:return"image/png";case 8:return"image/jpeg";case 16:return"image/ktx";default:return""}};m.extractWkid=L;m.filterInPlace=function(a,b,c){let d=0,e=0;for(let f=0;f<b.length&&d<a.length;f++)a[d]===b[f]&&(c(f)&&(a[e]=a[d],e++),d++);a.length=e};m.findFieldsCaseInsensitive=V;m.findIntersectingNodes=function(a,b,c,d,e,f){e.traverse(c,g=>{var l=g.mbs;b!==d&&(l=ua,A.projectBoundingSphere(g.mbs,
d,l,b));l=U(a,l);if(0===l)return!1;f(g,l);return!0})};m.getCacheKeySuffix=function(a,b){return w.isNone(b)?"@null":b===C.getSphericalPCPF(b)?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};m.getCachedAttributeValue=X;m.getClipAABB=function(a,b){if(0===b.rotationScale[1]&&0===b.rotationScale[2]&&0===b.rotationScale[3]&&0===b.rotationScale[5]&&0===b.rotationScale[6]&&0===b.rotationScale[7])return B[0]=(a[0]-b.position[0])/b.rotationScale[0],B[1]=(a[1]-b.position[1])/b.rotationScale[4],B[2]=(a[2]-
b.position[2])/b.rotationScale[8],B[3]=(a[3]-b.position[0])/b.rotationScale[0],B[4]=(a[4]-b.position[1])/b.rotationScale[4],B[5]=(a[5]-b.position[2])/b.rotationScale[8],B};m.getIndexCrs=Y;m.getSupportedEncodings=function(a){const b=a._stage.renderView.has(1);a=a._stage.renderView.has(0);const c=O("disable-feature:i3s-basis")?0:1;return 12|(b?c|2:0)|(a?c:0)};m.getSymbolInfo=function(a){const b=new ca;var c=!1;let d=!1;for(const f of a.symbolLayers.items)if("fill"===f.type&&f.enabled){var e=f.material;
a=f.edges;w.isSome(e)&&!c&&(c=e.color,e=ma.parseColorMixMode(e.colorMixMode),w.isSome(c)?b.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:e}:b.material={color:[1,1,1],alpha:1,colorMixMode:1},b.castShadows=f.castShadows,c=!0);w.isSome(a)&&!d&&(b.edgeMaterial=S.createMaterialFromEdges(a,{}),d=!0)}b.material||(b.material={color:[1,1,1],alpha:1,colorMixMode:1});return b};m.getVertexCrs=Z;m.intersectBoundingBoxWithMbs=function(a,b){var c=b[0],d=b[1],e=b[2];b=b[3];const f=a[0]-c;c-=a[3];
const g=a[1]-d;d-=a[4];const l=a[2]-e;a=e-a[5];e=Math.max(f,c,0);const r=Math.max(g,d,0),n=Math.max(l,a,0);e=e*e+r*r+n*n;return e>b*b?0:0<e?1:-Math.max(f,c,g,d,l,a)>b?3:2};m.intersectBoundingRectWithMbs=U;m.objectIdFilter=function(a,b,c){let d=0,e=0;for(;d<c.length;)0<=F.binaryIndexOf(a,c[d])===b&&(c[e]=c[d],e++),d++;c.length=e};m.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==
a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(const b of a){if("mesh-3d"!==b.type||0===b.symbolLayers.length)return!0;for(const c of b.symbolLayers.items)if("fill"!==c.type||w.isNone(c.material)||w.isNone(c.material.color)||"replace"!==c.material.colorMixMode)return!0}return!1};m.selectEncoding=function(a,b){return a.find(c=>0!==(c.encoding&b))};m.transformObb=ba;m.transparentEdgeMaterial=K;m.whenGraphicAttributes=async function(a,b,c,d,e){if(0===b.length)return[];const f=
a.attributeStorageInfo;if(w.isSome(a.associatedLayer))try{return await ra(a.associatedLayer,b,c,d)}catch(g){if(a.associatedLayer.loaded)throw g;}if(f){b=qa(b,c,e);if(w.isNone(b))throw new v("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const g=a.parsedUrl.path;a=await Promise.all(b.map(l=>sa(g,f,l.node,l.indices,d).then(r=>{for(let n=0;n<l.graphics.length;n++){const t=l.graphics[n],E=r[n];if(t.attributes)for(const k in t.attributes)k in E||(E[k]=t.attributes[k]);
t.attributes=E}return l.graphics})));return F.flatten(a)}throw new v("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available");};Object.defineProperty(m,"__esModule",{value:!0})});