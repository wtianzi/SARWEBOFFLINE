// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../chunks/vec3 ../../../../chunks/vec4f64 ../../support/orientedBoundingBox ./I3SNode ./I3SUtil".split(" "),function(B,L,g,y,E,M,F,G,z,v){function H(n){g.isSome(n.node)&&(n.node.renderMbs[3]=-1,g.isSome(n.node.serviceObbInRenderSR)&&(n.node.serviceObbInRenderSR.halfSize[0]=-1));g.isSome(n.ref)&&(n.ref.renderMbs[3]=-1,g.isSome(n.ref.serviceObbInRenderSR)&&
(n.ref.serviceObbInRenderSR.halfSize[0]=-1))}function C(n,f){return 0===f?0:n/f|0}function A(n,f){return 0===f?n:n%f}function I(n){if(n)for(let f=0;f<n.length;f++)for(const a of N)if(a[0]===n[f].metricType)return{lodMetric:a[1],maxError:n[f].maxError};return{lodMetric:0,maxError:0}}function O(n){return Math.sqrt(4/Math.PI*n)}let J=function(n,f,a,b,c){this.childOffset=n;this.childCount=f;this.visibilityCache=a;this.ref=b;this.node=c;this.useAsHole=0},Q=function(){function n(a,b,c,h,d,e,p,q,r,k,l,w,
m,u){this.streamDataController=c;this.viewportQueries=h;this.logger=d;this.holeFilling=e;this._isLoaded=p;this._isReloading=q;this._isSelected=r;this._enable=k;this._needsUpdate=l;this._canRequest=w;this._computeVisibilityObb=m;this._computeNodeFiltering=u;this._dirty=!0;this._nodePages=[];this.lodMetric=this.rootIndex=this.nodesPerPage=this.nodeCount=0;this.lodConversion=x=>x;this.urlPrefix="";this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=
Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState=new Map;this._version=v.addWraparound(0,2);this._visibilityCacheVersion=v.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=0;this._missing=new y({deallocator:null});this._prefetch=new y({deallocator:null});this._updates=new P;this._imModificationUncategorized=new y({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=
0;this._layerHasFilter=this.layerHasModifications=!1;this.logLayer=a;a.serviceUpdateTimeStamp&&a.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${a.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;this.init(b)}var f=n.prototype;f.init=function(a){if("page"===a.type){this.urlPrefix=a.urlPrefix;this.nodesPerPage=a.pageSize;this.rootIndex=a.rootIndex;switch(a.lodMetric){case "maxScreenThreshold":this.lodMetric=1;break;case "maxScreenThresholdSQ":this.lodMetric=
1,this.lodConversion=O}this.addPage(C(this.rootIndex,this.nodesPerPage),a.rootPage)}else"node"===a.type&&(this.urlPrefix=a.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new z.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,a.rootNode))&&this.addNode(a,0))};f.loadPage=function(a){this._loading.add(a);this.streamDataController.request(this.urlPrefix+a,"json").then(b=>{this._loading.delete(a);this.addPage(a,b)}).catch(b=>{this._loading.delete(a);
E.isAbortError(b)||(this._failedPages.add(a),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${a}`,b))})};f.addPage=function(a,b){for(let d=this._nodePages.length;d<a;d++)this._nodePages[d]=null;const c=[],h=[];b=b.nodes.map((d,e)=>{const p=c.length,q=d.children?d.children.length:0;h.push(-1);for(var r=0;r<q;r++)c.push(d.children[r]);const k=`${d.index}`;r=G.clone(d.obb);const l=F.fromArray([r.center[0],r.center[1],r.center[2],M.length(r.halfSize)]),w=d.mesh&&d.mesh.attribute,
m=d.mesh&&d.mesh.geometry,u=d.mesh&&d.mesh.material;d=new z.Node(k,a*this.nodesPerPage+e,l,q,0,{hasSharedResource:!1,hasFeatureData:!!m,attributes:w&&null!=w.resource?`${w.resource}`:null,geometry:m&&null!=m.resource?`${m.resource}`:null,texture:u&&null!=u.resource?`${u.resource}`:null,geometryDefinition:m?m.definition:-1,materialDefinition:u?u.definition:-1},this.lastUpdate,this.lodMetric,this.lodConversion(d.lodThreshold),m?m.featureCount:null);d.serviceObb=r;d.visibilityObb=this._computeVisibilityObb(d);
d.vertexCount=m?m.vertexCount:0;return new J(p,q,v.addWraparound(this._visibilityCacheVersion,-2),null,d)});this._nodePages[a]={nodes:b,children:c,parents:h};this.nodeCount+=b.length;this.updateParentsAndLevel()};f.updateParentsAndLevel=function(){const a=[],b=(c,h,d)=>{const e=this.getPage(c);if(g.isSome(e)){const p=A(c,this.nodesPerPage);e.parents[p]=h;h=e.nodes[p].node;g.isSome(h)&&(h.level=d,a.push(c))}};for(b(this.rootIndex,-1,0);a.length;){const c=a.pop(),h=this.getNode(c);if(g.isSome(h))for(let d=
0;d<h.childCount;d++){const e=this.getChildIndex(h,d);b(e,c,h.level+1);this._maxLevel=Math.max(this._maxLevel,h.level+1)}}};f.getPage=function(a){return this._nodePages[C(a,this.nodesPerPage)]};f.getNodeInternal=function(a){const b=this.getPage(a);return g.isNone(b)?null:b.nodes[A(a,this.nodesPerPage)]};f.addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);c=g.isSome(c)?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,a.children?c+1:c);const {lodMetric:h,
maxError:d}=I(a.lodSelection),e=g.unwrap(this.getNodeInternal(b));e.node=new z.Node(a.id,b,F.fromArray(a.mbs),e.childCount,c,a.resources,a.version,h,d,a.numFeatures);a.obb&&(e.node.serviceObb=G.clone(a.obb));e.node.visibilityObb=this._computeVisibilityObb(e.node);g.isSome(e.ref)&&(null==e.ref.mbs&&(e.ref.mbs=a.mbs),e.node.renderMbs=e.ref.renderMbs,e.node.serviceObbInRenderSR=e.ref.serviceObbInRenderSR,e.ref.visibilityObb=e.node.visibilityObb);return e.node};f.makeRefNode=function(a,b){const c=this._nodePages[0],
h=c.nodes.length;c.nodes.push(new J(0,0,v.addWraparound(this._visibilityCacheVersion,-2),a,null));this.nodeCount++;c.parents.push(b);a.renderMbs[3]=-1;g.isSome(a.serviceObbInRenderSR)&&(a.serviceObbInRenderSR.halfSize[0]=-1);return h};f.populateChildren=function(a,b){var c=g.unwrap(this.getNodeInternal(a));const h=g.unwrap(this.getPage(a));c.childOffset=h.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const d=this.makeRefNode(b[c],a);h.children.push(d)}};f.getNode=function(a){a=this.getNodeInternal(a);
return g.isSome(a)?a.node:null};f.getIndexById=function(a){let b;this.forAllNodes((c,h)=>{g.isSome(c.node)&&c.node.id===a?b=h:g.isSome(c.ref)&&c.ref.id===a&&(b=h)});return b};f.getNodeById=function(a){a=this.getIndexById(a);return 0<=a?this.getNode(a):null};f.getChildIndex=function(a,b){const c=this.getPage(a.index);if(g.isNone(c))return-1;a=c.nodes[A(a.index,this.nodesPerPage)];return c.children[a.childOffset+b]};f.getParentIndex=function(a){const b=this.getPage(a);return g.isSome(b)?b.parents[A(a,
this.nodesPerPage)]:-1};f.getParent=function(a){a=this.getParentIndex(a);return 0<=a?this.getNode(a):null};f.isLeaf=function(a){a=this.getNodeInternal(a);return g.isSome(a)&&0===a.childCount};f.invalidateVisibilityCache=function(){this._visibilityCacheVersion=v.addWraparound(this._visibilityCacheVersion,2)};f.invalidateNodeVisibilityCache=function(a){a=this.getNodeInternal(a);g.isSome(a)&&this.invalidateNodeVisibilityCacheInternal(a)};f.invalidateNodeVisibilityCacheInternal=function(a){a.visibilityCache=
v.addWraparound(this._visibilityCacheVersion,-2)};f.invalidateBoundingVolumeCache=function(a){a=this.getNodeInternal(a);g.isSome(a)&&(H(a),this.invalidateNodeVisibilityCacheInternal(a))};f.invalidateGeometryVisibility=function(a){a=this.getNodeInternal(a);g.isSome(a)&&g.isSome(a.node)&&(a.node.geometryObb=null,a.node.renderMbs[3]=-1,g.isSome(a.node.serviceObbInRenderSR)&&(a.node.serviceObbInRenderSR.halfSize[0]=-1))};f.invalidateVisibilityObbs=function(){g.isNone(this.rootNode)||this.traverse(this.rootNode,
a=>{a.visibilityObb=this._computeVisibilityObb(a);a.geometryObb=null;return!0})};f.isNodeVisible=function(a){a=this.getNodeInternal(a);if(g.isNone(a)||g.isSome(a.ref)&&!a.ref.mbs)return!0;if((a.visibilityCache&-2)!==this._visibilityCacheVersion){var b=a.node;const c=g.isSome(b)&&(g.isNone(a.ref)||g.isSome(b.visibilityObb))?b:g.isSome(a.ref)?a.ref:null;this._layerHasFilter&&this._computeNodeFiltering&&g.isSome(b)&&2===b.filterImpact&&this._computeNodeFiltering(b);const h=g.isSome(b)&&1===b.filterImpact;
b=!(g.isSome(b)&&2===b.imModificationImpact)&&(!c||this.viewportQueries.isNodeVisible(c))&&!h;a.visibilityCache=this._visibilityCacheVersion+(b?1:0);return b}return 1===(a.visibilityCache&1)};f.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this.getNodeInternal(a);return g.isSome(a)&&g.isSome(a.node)&&g.isSome(a.node.geometryObb)&&(!this.layerHasModifications||4!==a.node.imModificationImpact)?this.viewportQueries.isGeometryVisible(a.node):!0};f._traverseCoverage=function(a,b,c,
h,d){a=this.getPage(a);if(!g.isNone(a)&&0!==b.childCount){var e=b.childOffset+b.childCount,p=[];for(b=b.childOffset;b<e;++b){const q=a.children[b],r=this.getNodeInternal(q);g.isSome(r)&&g.isSome(r.node)&&this.isGeometryVisible(q)&&p.push(r)}h/=p.length;for(const q of p)a=g.unwrap(q.node).index,this._isLoaded(a)||this._isReloading(a)?(d.delta=Math.max(d.delta,c),d.coverage+=h):this._traverseCoverage(a,q,c+1,h,d)}};f.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;const b=this.getNodeInternal(a);
if(g.isNone(b))return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+(a?1:0);return a};f.destroy=function(){this._updates.add.prune();this._updates.update.prune()};f.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;this._version=v.addWraparound(this._version,2)};f.imModificationsChanged=function(a){this.layerHasModifications=
a;this.forAllNodes(({node:b})=>{g.isSome(b)&&(b.imModificationImpact=4,b.visibilityObb=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()};f.layerFilterChanged=function(a){this._layerHasFilter=a;this.forAllNodes(({node:b})=>{g.isSome(b)&&(b.filterImpact=2,this.invalidateNodeVisibilityCache(b.index),b.visibilityObb=this._computeVisibilityObb(b),this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()};
f.update=function(a,b,c){if(this._dirty){this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a,this._missing);t.clear();var h=!0,d=new D,e=new D,p=this._imModificationUncategorized;p.clear();var q=new Set;this.traverseVisible((k,l,w)=>{if(g.isNone(l))l=this.entryPriority(k),Infinity===l&&(l=this.entryPriority(w)),k=C(k,this.nodesPerPage),t.set(k,Math.max(l,t.get(k)||0)),this._loading.has(k)||this._failedPages.has(k)||
this._missing.push(k),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{var m=l.node;this._updateNodeFeatureEstimate(m,e);if(g.isNone(m))l=this.entryPriority(k),this._loading.has(k)||this._failedNodes.has(k)||(this._missing.push(k),t.set(k,l)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{w=g.unwrap(this.getPage(k));if(0===this._missing.length&&0===this.nodesPerPage)for(let u=0;u<l.childCount;u++){const x=w.children[l.childOffset+u],K=this.getNodeInternal(x);!g.isSome(K)||
K.node||this._loading.has(x)||this._failedNodes.has(x)||(t.set(x,this.entryPriority(x)),this._prefetch.push(x))}!m.failed&&m.resources.hasFeatureData&&(q.add(m.id),this._isLoaded(k)?(d.known+=m.memory,++d.knownNodes,this._isSelected(m)?0<l.childCount&&(h=!1):(d.unremoved+=m.memory,h=!1),this._needsUpdate(m)&&(l=this.entryPriority(k),t.set(k,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.update.push(k))):(m.memory&&(d.known+=m.memory,++d.knownNodes),this._isSelected(m)?
(0<l.childCount&&(h=!1),m.memory?(d.missing+=m.memory,d.known+=m.memory,++d.knownNodes):++d.missingNodes,0<=a.indexOf(m.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(k)),this._updates.cancel=this._updates.cancel.filter(u=>u!==m.index)):!b.done&&this._enable(m)?b.madeProgress():(l=this.entryPriority(k),t.set(k,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.add.push(k),this.layerHasModifications&&c&&g.isSome(m)&&4===m.imModificationImpact&&
p.push(k))):this._isReloading(k)&&this._updates.remove.push(k)))}}});var r=this._updates.add;0<r.length&&this.layerHasModifications&&(0<p.length&&c(p),r.filterInPlace(k=>{var l=this.getNodeInternal(k);(l=g.isNone(l)||g.isNone(l.node)||2!==l.node.imModificationImpact)||this.invalidateNodeVisibilityCache(k);return l}));this._unloadedMemoryEstimate=d.missing-d.unremoved;3<d.knownNodes&&0<d.missingNodes&&(this._unloadedMemoryEstimate+=d.known/d.knownNodes*d.missingNodes);this._unloadedMemoryEstimate=
.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(e);this._featureEstimate.leavesReached=h;this._missing.sort((k,l)=>k-l);this._missing.filterInPlace((k,l)=>1>l||this._missing.data[l-1]!==k);this._missing.sort((k,l)=>t.get(k)-t.get(l));0<this._missing.length?(this._maxUnloadedPrio=t.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort((k,l)=>t.get(k)-t.get(l));this._updates.add.filterInPlace(k=>t.get(k)>=this._maxUnloadedPrio).sort((k,
l)=>t.get(k)-t.get(l));this._updates.update.sort((k,l)=>t.get(k)-t.get(l));this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;t.clear()}};f.checkFeatureTarget=function(a,b){const c=this.viewportQueries.updateScreenSpaceErrorBias(b);let h=b,d=b,e=c,p=10;for(;p--;){const q=new D;this._updateFeatureEstimate(h,q);if(this._computeFeatureEstimate(q)<=a){if(h>=b||0<q.missingNodes||0===p)break;e=h;h=.5*(h+d)}else d=h,h=.5*(h+e)}this._version=v.addWraparound(this._version,
2);this.viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,h)};f._updateFeatureEstimate=function(a,b){this._version=v.addWraparound(this._version,2);this.viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,h)=>this._updateNodeFeatureEstimate(g.isSome(h)&&h.node,b))};f._updateNodeFeatureEstimate=function(a,b){g.isNone(a)||a.failed||g.isNone(a.numFeatures)||(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):
this._isSelected(a)&&(g.isSome(a.numFeatures)?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};f._computeFeatureEstimate=function(a){let b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};f.load=function(){return this._load(this._missing)};f.prefetch=function(){return this._load(this._prefetch)};f._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();)0===
this.nodesPerPage?this._loadNode(a.pop()):this.loadPage(a.pop());return!0};f.isLoading=function(){return 0<this._indexMissing};f.getIndexLoading=function(){return this._loading.size};f.getIndexMissing=function(){return this._indexMissing};f.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};f.nodeTraversalState=function(a){if(g.isNone(a))return null;let b=this._nodeTraversalState.get(a.index);if(b&&(b.version&-2)===this._version)return b;const c=this.viewportQueries.getLodLevel(a),
h=this.viewportQueries.hasLOD(a);var d=!0;h?(d=this.getParentIndex(a.index),d=0<=d?(d=this._nodeTraversalState.get(d))&&c>d.lodLevel:0<c):d=0===a.childCount;if(b)return b.lodLevel=c,b.isChosen=d,b.version=this._version+1,b;b=new z.NodeTraversalState(h,d,c,this._version+1);this._nodeTraversalState.set(a.index,b);return b};f._loadNode=function(a){this._loading.add(a);const b=g.unwrap(this.getNodeInternal(a)).ref;if(g.isNone(b))this._failedNodes.add(a);else{var c=b.id,h=this.urlPrefix+c,d=()=>{this._loading.delete(a);
0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(h,"json").then(e=>{d();e=this._validateNode(c,e);null!=e&&(e.obb&&this.invalidateNodeVisibilityCache(a),e=this.addNode(e,a),this.nodeTraversalState(e))},e=>{d();E.isAbortError(e)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+h),this._failedNodes.add(a))})}};f._validateNode=function(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this.logger.error("#validateNode()",
this.logLayer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${a}.`),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${a}"`);null==b.geometryData||Array.isArray(b.geometryData)&&1===b.geometryData.length&&"./geometries/0"===b.geometryData[0].href||
this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${a}"`);null==b.attributeData||Array.isArray(b.attributeData)&&!b.attributeData.some((e,p)=>e.href!==`./attributes/f_${p}/0`)||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this.logger.warn("#validateNode()",this.logLayer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);const c=b.hasOwnProperty("obb")&&
!this.ignoreServiceObb?b.obb:null,h=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:null;var d=e=>{if(null==e)return null;var p=q=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${a}: ${q}`);if("number"===typeof e.id)p(`id ${e.id} is a number instead of a string.`);else if("string"!==typeof e.id||!Array.isArray(e.mbs))return p("Missing or invalid id."),null;if(!Array.isArray(e.mbs))return p(`Invalid bounding volume on reference ${e.id}.`),
null;e.href&&e.href!=="../"+e.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${a}"`);p=e.hasOwnProperty("obb")&&!this.ignoreServiceObb?e.obb:null;e=new z.NodeBase(`${e.id}`,e.mbs);e.serviceObb=p;e.visibilityObb=this._computeVisibilityObb(e);return e};d=Array.isArray(b.children)?b.children.map(d).filter(e=>null!=e):null;return{id:a,mbs:b.mbs,obb:c,children:d,resources:{hasFeatureData:b.featureData&&0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?
a:null,texture:b.textureData&&0<b.textureData.length?a:null,geometry:null!=b.geometryData?a:null},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:h}};f.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this.forAllNodes(a=>{g.isSome(a.node)&&(a.node.failed=!1)})};f.entryPriority=function(a){var b=this.getNodeInternal(a),c=this.getParentIndex(a);if(g.isNone(b)||0>c&&null==b.node)return 0>c?Infinity:
this.entryPriority(c);let h=0;b.node&&0<=c&&(c=this._nodeTraversalState.get(c),null!=c&&(h=c.lodLevel));for(c=this.progressiveLoadPenalty;0<=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=g.isSome(b.ref)?this.viewportQueries.distToPOI(b.ref):g.isSome(b.node)?this.viewportQueries.distToPOI(b.node):0;return-b-h*(b+this.progressiveLoadPenalty)+c};f.traverseVisible=function(a){const b=this.getNodeInternal(this.rootIndex);g.isNone(b)?a(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,
-1,b,a)};f._traverseVisible=function(a,b,c,h){if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&h(a,c,b);else if(this.isNodeVisible(a)&&(h(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b.nodeHasLOD||b.lodLevel!==this._maxLodLevel))){b=g.unwrap(this.getPage(a));for(let d=0;d<c.childCount;d++){const e=b.children[c.childOffset+d],p=this.getNodeInternal(e);g.isSome(p)?this._traverseVisible(e,a,p,h):h(e,null,a)}}};f.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};f.traverseChildren=
function(a,b){a=a.index;const c=this.getNodeInternal(a);g.isSome(c)&&this._traverseChildren(a,c,b)};f._traverseChildren=function(a,b,c){a=this.getPage(a);if(!g.isNone(a)){var h=b.childOffset+b.childCount;for(b=b.childOffset;b<h;++b){const d=a.children[b],e=this.getNodeInternal(d);g.isSome(e)&&g.isSome(e.node)&&c(e.node)&&this._traverseChildren(d,e,c)}}};f.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=
" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){const b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};f.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)};f.updateElevationInfo=function(a){this.forAllNodes(H);this.viewportQueries.updateElevationInfo(a)};f.forAllNodes=function(a){for(let b=0;b<this._nodePages.length;b++){const c=this._nodePages[b];
if(c){const h=b*this.nodesPerPage;for(let d=0;d<c.nodes.length;d++)a(c.nodes[d],h+d)}}};L._createClass(n,[{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"test",get:function(){return{addNode:(a,b)=>
this.addNode(a,b)}}}]);return n}();const t=new Map;let P=function(){function n(){this.update=new y({deallocator:null});this.add=new y({deallocator:null});this.remove=new y({deallocator:null});this.cancel=[]}n.prototype.reset=function(f,a){this.add.clear();this.update.clear();this.cancel=f;this.missing=a};return n}();const N=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];let D=function(){this.unremoved=this.missingNodes=this.missing=
this.knownNodes=this.known=0};B.I3SIndex=Q;B.selectErrorMetric=I;Object.defineProperty(B,"__esModule",{value:!0})});