// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/typedArrayUtil ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/PooledArray ../../../core/promiseUtils ../../../core/scheduling ../../../core/Collection ../../../support/arcadeOnDemand ../../../layers/support/fieldUtils ../../../core/mathUtils ../../../Color ../../../symbols/Symbol3D ../../../Graphic ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../core/unitUtils ../../../renderers/visualVariables/support/visualVariableUtils ../../../core/watchUtils ../../../chunks/mat4 ../../../geometry/projection ../../../symbols/support/unitConversionUtils ../../../core/MapUtils ../../../chunks/mat4f64 ../../../chunks/mat3 ../../../chunks/vec4 ../../../layers/support/SceneModification ../../../geometry/support/aaBoundingBox ../../../layers/support/layerUtils ../../../chunks/mat3f32 ../support/buffer/glUtil ../support/debugFlags ../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl ./graphics/graphicUtils ../webgl-engine/lib/BasisUtil ../webgl-engine/lib/Texture ../support/extentUtils ./support/layerViewUpdatingProperties ../support/orientedBoundingBox ../webgl-engine/collections/Component/SourceGeometry ./i3s/I3SProjectionUtil ./i3s/I3SUtil ../../../layers/graphics/controllers/I3SOnDemandController ./i3s/I3SGeometryUtil ./I3SMeshViewLabeler ./I3SMeshWorkerHandle ./SceneLayerWorker ./i3s/Highlights ./i3s/I3SAttributeOverrides ./i3s/I3SCrossfadeHelper ./i3s/I3SElevationProvider ./i3s/I3SIntersectionHandler ./i3s/IDBCache ./support/attributeUtils ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/util/EllipsoidMode".split(" "),
function(Ca,ea,T,t,fa,ha,g,Da,rb,v,sb,Ea,tb,ub,vb,Fa,X,Ga,Ha,Ia,ia,Y,Ja,Ka,U,ja,ka,La,la,ma,na,I,Ma,oa,pa,Na,Oa,Pa,J,Qa,Ra,Sa,M,Ta,qa,ra,Ua,Va,Wa,Z,Xa,aa,r,Ya,Za,$a,sa,V,ab,bb,ta,cb,db,eb,ba,N,fb){function ua(k){const n=k.metallicRoughness;return n&&0<=n.baseColorTextureId||n&&0<=n.metallicRoughnessTextureId||0<=k.normalTextureId||0<=k.emissiveTextureId||0<=k.occlusionTextureId}function O(k,n,q){if(g.isNone(k)||0===q)return null;for(let e=0;e<k.length;e++){const a=k[e];if(g.isSome(a)&&0!==(a.usage&
q))return n[e].id}return null}function va(k){return g.isSome(k)&&ha.isArrayBuffer(k.data)}function wa(k,n){k=1024+k.interleavedVertexData.byteLength+(k.indices?k.indices.byteLength:0)+k.positionData.data.byteLength+k.positionData.indices.byteLength;if(g.isSome(n))for(const q of n)g.isSome(q)&&ha.isArrayBuffer(q.data)&&(k+=q.data.byteLength);return k}function xa(k,n){return 104857600<n.byteSize?(H.warn(`Node is too big to store in IndexedDB cache: ${k.id} (${n.byteSize} bytes)`),!1):0<n.byteSize}function gb(k){if(0===
k.length)return null;const n=new Float64Array(10*k.length);k.forAll((q,e)=>{let a=q.serviceObb;g.isNone(a)&&(a=hb,ka.copy(a.center,q.mbs),a.halfSize[0]=a.halfSize[1]=a.halfSize[2]=q.mbs[3]);q=10*e;n[q+0]=a.center[0];n[q+1]=a.center[1];n[q+2]=a.center[2];n[q+3]=a.halfSize[0];n[q+4]=a.halfSize[1];n[q+5]=a.halfSize[2];n[q+6]=a.quaternion[0];n[q+7]=a.quaternion[1];n[q+8]=a.quaternion[2];n[q+9]=a.quaternion[3]});return n}function P(k,n){k.forEach(q=>q.opacity=n)}const H=Da.getLogger("esri.views.3d.layers.SceneLayerView3D"),
ya=[1,1,1,1];let ib=function(k){function n(q,e,a,b,c,d,f){var h=k.call(this)||this;h.node=q;h.featureIds=e;h.objectHandle=a;h.cachedRendererVersion=b;h.attributeInfo=c;h.material=d;h.textures=f;h.cachedEdgeMaterials=[];h.cachedSymbology=null;return h}T._inheritsLoose(n,k);return n}(ta.NodeCrossfadeMetaData);const jb=J.create(),kb=J.create(),hb=Z.create(),Q=[0,0,0,0],lb=new Ja([0,0,0,0]),za=[0,0,0,0],mb={remove(){},pause(){},resume(){}};ea.I3SMeshView3D=k=>{k=function(n){function q(){var a=n.apply(this,
arguments)||this;a._elevationProvider=null;a._intersectionHandler=null;a._nodeId2Meta=new Map;a._nodeId2MetaReloading=new Map;a._i3sWasmLoaded=!1;a._hasLoadedPBRTextures=!1;a._asyncModuleLoading=0;a._addTasks=new Map;a._rendererVersion=0;a._colorVariable=null;a._opacityVariable=null;a._rendererFields=null;a._symbologyFields=null;a._symbologyOverride=null;a._symbologyOverrideFields=null;a._symbolInfos=new Map;a._idbCache=new eb.IDBCache("esri-scenelayer-cache","geometries");a.holeFilling="auto";a._hasColors=
!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._modifications=[];a._layerUrl="";a._cacheKeySuffix=null;a._arcade=null;a._tmpAttributeOnlyGraphic=new U(null,null,{});a._crossfadeHelper=new ta.I3SCrossfadeHelper(T._assertThisInitialized(a));return a}T._inheritsLoose(q,n);var e=q.prototype;e.initialize=function(){var a;this.preLoadBasis();this.addResolvingPromise(this.i3slayer.indexInfo);this.attributeOverrides=new bb.I3SAttributeOverrides(this.i3slayer,null==(a=this.view.resourceController)?
void 0:a.memoryController);this._worker=new sa.I3SMeshWorkerHandle(this.view.resourceController.scheduler);this.addResolvingPromise(this._worker.promise);this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema);r.checkSceneLayerValid(this.i3slayer);r.checkSceneLayerCompatibleWithView(this.i3slayer,this.view);this._layerUrl=this.i3slayer.parsedUrl.path;this._controller=new Ya({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=
this.view._stage;this._collection=this._stage.renderView.componentObjectCollection;this._highlights=new ab({collection:this._collection,forAllFeatures:b=>this._forAllFeatures(b,null,1),forAllFeaturesOfNode:(b,c)=>this._forAllFeaturesOfNode(b,c)});this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema?this._hasSymbolColors=!1:(a=this.i3slayer.store.defaultGeometrySchema.featureAttributes,this._hasSymbolColors=!!(a&&a.faceRange&&a.id));this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&
(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,b=>this._deleteComponentObject(b));this._intersectionHandler=new db.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:b=>
{this._nodeId2Meta.forEach(c=>g.isSome(c)&&b(c.node,c.objectHandle));this._nodeId2MetaReloading.forEach(c=>g.isSome(c)&&b(c.node,c.objectHandle))}});this._elevationProvider=new cb({layerView:this,intersectionHandler:this._intersectionHandler});this._hasLoadedPBRTextures=this._usePBR();this.updatingHandles.add(this,"view.clippingArea",()=>this._clippingAreaChanged(),2);this.updatingHandles.add(this,"fullOpacity",b=>this._opacityChange(b));this.updatingHandles.add(this,"slicePlaneEnabled",b=>this._slicePlaneEnabledChange(b));
this.updatingHandles.add(this,"elevationOffset",(b,c)=>{this._reloadAll(c);this._controller.invalidateVisibilityObbs()});this.updatingHandles.add(this,"filter",()=>this._filterChange(),2);this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",()=>this._updatePBR());a=()=>{this._reloadAll();this.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",a);this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",a);this.updatingHandles.add(this,
"suspended",b=>this._suspendedChange(b),2);this.updatingHandles.add(this.i3slayer,"labelsVisible",()=>this._labelingChanged(),2);this.updatingHandles.add(this.i3slayer,"labelingInfo",()=>this._labelingChanged(),2);this.updatingHandles.add(this,"_modifications",()=>this._modificationsChanged(),2);this.handles.add([ma.init(M,"I3S_TREE_SHOW_TILES",b=>{if(b&&!this._treeDebugger){const c=this._controller.crsIndex;(new Promise(function(d,f){Ca(["./support/I3STreeDebugger"],d,f)})).then(({I3STreeDebugger:d})=>
{!this._treeDebugger&&M.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new d({lv:this,view:this.view,nodeSR:c}))})}else b||M.I3S_TREE_SHOW_TILES||(this._treeDebugger=g.destroyMaybe(this._treeDebugger))}),ma.init(M,"I3S_SHOW_MODIFICATIONS",()=>this._showModifications())]);this._cacheKeySuffix=r.getCacheKeySuffix(this.i3slayer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(b=>H.warn(`Failed to initialize IndexedDB cache: ${b}`))};e.destroy=function(){this._clearAddTasks();
this.attributeOverrides=g.destroyMaybe(this.attributeOverrides);this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null);this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const a=this._worker;a&&(a.destroyContext(this.i3slayer.uid).then(()=>a.destroy()),this._worker=null);this._removeAllNodeDataFromStage();
this._memCache=g.destroyMaybe(this._memCache);this._edgeView=this._stage=this._collection=null;this._labeler=g.destroyMaybe(this._labeler);this._treeDebugger=g.destroyMaybe(this._treeDebugger);this._controller=g.destroyMaybe(this._controller);this._highlights.destroy();this._nodeId2Meta.clear();this._nodeId2MetaReloading.clear();this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=
null)};e.memEstimateTextureAdded=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};e.memEstimateTextureRemoved=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};e.memEstimateGeometryAdded=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};e.memEstimateGeometryRemoved=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate-=
a;this.geoMemoryEstimate-=a};e.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};e.isNodeReloading=function(a){return this._nodeId2MetaReloading.has(a)};e.getUsedMemory=function(){let a=g.isSome(this._labeler)?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(b=>a+=g.isSome(b)?b.node.memory:0);this._nodeId2MetaReloading.forEach(b=>a+=g.isSome(b)?b.node.memory:0);return a};e.getUnloadedMemory=function(){return(g.isSome(this._controller)?this._controller.unloadedMemoryEstimate:0)+(g.isSome(this._labeler)?
this._labeler.unloadedMemoryEstimate:0)};e.ignoresMemoryFactor=function(){return!1};e._labelingChanged=function(){if(!Qa.areLabelsVisible(this.i3slayer)||!this._supportsLabeling)g.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);else if(!g.isSome(this._labeler)){var a=new $a({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach(b=>g.isSome(b)&&this._addMetaToLabeler(a,b));this._labeler=a}};e._loadAsyncModule=function(a){++this._asyncModuleLoading;
return a.then(b=>{--this._asyncModuleLoading;return b},b=>{--this._asyncModuleLoading;throw b;})};e._modificationsChanged=function(){if(!this._i3sWasmLoaded&&this._hasModifications)this._i3sWasmLoaded=V.initialize().then(()=>{this._i3sWasmLoaded=!0;this._modificationsChanged();this.notifyUpdate()}),this.notifyUpdate();else if(!0===this._i3sWasmLoaded){var a=this.i3slayer.uid,b=this.i3slayer.spatialReference;this._worker.setModifications(a,this._modifications,b);var c=sa.toWasmModification(this._modifications,
b);V.setModificationsSync({context:a,modifications:c,isGeodetic:b.isGeographic});this._controller.modificationsChanged();var d=this._hasModifications?new Fa:null;this._nodeId2Meta.forEach((f,h)=>{g.isNone(f)?this._nodeId2Meta.delete(h):f.node.hasModifications?(this._nodeId2Meta.delete(h),this._nodeId2MetaReloading.set(h,f)):g.isSome(d)&&d.push(f.node)});g.isSome(d)&&this._nodeId2MetaReloading.forEach(f=>d.push(f.node));g.isSome(d)&&0<d.length&&(this.updateNodeModificationStatus(d),d.forAll(f=>{if(2!==
f.imModificationImpact){const h=this._nodeId2Meta.get(f.index);this._controller.invalidateGeometryVisibility(f.index);this._nodeId2Meta.delete(f.index);g.isSome(h)&&this._nodeId2MetaReloading.set(f.index,h)}}));this.clearMemCache();this._controller.restartNodeLoading();this._showModifications()}};e._showModifications=function(){g.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null);if(M.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var a=
{clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},b={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const c of this._modifications)c.geometry.spatialReference=this.i3slayer.spatialReference,this._modificationGraphics.push(new U({geometry:c.geometry,symbol:{...b,color:a[c.type]}}));this.view.graphics.addMany(this._modificationGraphics)}};e._addMetaToLabeler=function(a,b){a.addNodeMeta(b,(c,d)=>this._createAttributes(c,d))};e._suspendedChange=
function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))};e.getLoadedAttributes=function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.loadedAttributes};
e.getAttributeData=function(a){a=this._nodeId2Meta.get(a);if(g.isSome(a)&&g.isSome(a.attributeInfo))return a.attributeInfo.attributeData};e.setAttributeData=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&g.isSome(a.attributeInfo)&&(a.attributeInfo.attributeData=b,this._attributeValuesChanged(a))};e.updateAttributes=async function(a,b,c){a=this._nodeId2Meta.get(a);g.isSome(a)&&(await this.attributeOverrides.apply(a.featureIds,b,c),a.attributeInfo=b,this._attributeValuesChanged(a))};e._attributeValuesChanged=
function(a){a.cachedRendererVersion=this._getInvalidRendererVersion();a.filteredIds=null;g.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(a,(b,c)=>this._createAttributes(b,c));this._updateEngineObject(a)};e.clearMemCache=function(){g.isSome(this._memCache)&&this._memCache.clear()};e.getVisibleNodes=function(){const a=[];this._nodeId2Meta.forEach(b=>g.isSome(b)&&a.push(b.node));return a};e.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach((b,c)=>a.push(c));this._nodeId2MetaReloading.forEach((b,
c)=>a.push(c))};e.preLoadBasis=function(){!fa("disable-feature:i3s-basis")&&0!==(this.supportedTextureEncodings&1)&&g.applySome(this.i3slayer.textureSetDefinitions,a=>a.some(b=>b.formats.some(c=>"basis"===c.format)))&&ra.loadBasis()};e._createTexture=function(a,b,c,d){if(g.isNone(c)||null==c.data)return null;const {data:f,encoding:h}=c,l=b.wrapTextures;b=c.usage&1?"opaque"===b.alphaMode?3:4:3;c=!0;f instanceof HTMLImageElement&&(c=Y.isPowerOfTwo(f.width)&&Y.isPowerOfTwo(f.height));c=(!this.uncompressedTextureDownsamplingEnabled||
8!==h&&4!==h)&&c;d={mipmap:c,wrap:d||!l?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:d&&c&&this._disableAtlasAnisotropy,encoding:r.encodingToMimeType(h),noUnpackFlip:!0,components:b};d=new Ua.Texture(f,d);this._stage.add(d);a.memory+=this.memEstimateTextureAdded(d);return d};e._getVertexBufferLayout=function(a,b){a={hasTexture:ua(a.params.material),hasNormals:b.normal,hasRegions:b.uvRegion};return Sa.glLayout(Xa.createVertexBufferLayout(this._getGeometryParameters(a)))};e._getObjectIdField=
function(){return this.i3slayer.objectIdField||"OBJECTID"};e._findGraphicNodeAndIndex=function(a){const b=ba.attributeLookup(this.i3slayer.fieldsIndex,a.attributes,this._getObjectIdField());let c=null;oa.someMap(this._nodeId2Meta,d=>{if(g.isNone(d))return!1;const f=d.featureIds.indexOf(b);if(-1===f)return!1;c={node:d.node,index:f};return!0});return c};e._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.index);if(g.isNone(a))return[];const c=[],d=this._getObjectIdField(),f=this.i3slayer.fieldsIndex;
for(const h of b)b=ba.attributeLookup(f,h.attributes,d),b=a.featureIds.indexOf(b),-1!==b&&c.push(b);return c};e.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return Promise.reject();var b=this._nodeId2Meta.get(a.node.index);if(g.isNone(b))return Promise.reject();a=Za.boundingBoxCornerPoints(a.index,this._collection,b.objectHandle,new Float64Array(24));if(I.projectBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=J.empty(),J.expandWithBuffer(b,
a,0,8),Promise.resolve({boundingBox:b,screenSpaceObjects:[]})};e.whenGraphicAttributes=function(a,b){return r.whenGraphicAttributes(this.i3slayer,a,this._getObjectIdField(),b,()=>[...this._nodeId2Meta.values()].filter(g.isSome))};e.getGraphicFromIntersectorMetadata=function(a){if(null==a.nodeIndex||null==a.componentIndex)return null;const b=this._nodeId2Meta.get(a.nodeIndex);return g.isNone(b)||null==b.featureIds||a.componentIndex>=b.featureIds.length?null:this._createGraphic(a.componentIndex,b)};
e._getCacheKey=function(a){return`${this._layerUrl}/v${17}/${a.id}${this._cacheKeySuffix}`};e._getMemCacheKey=function(a,b=this.elevationOffset){return a+"#"+b};e.loadCachedGPUData=function(a){return g.isSome(this._memCache)?this._memCache.pop(this._getMemCacheKey(a.index)):null};e.deleteCachedGPUData=function(a){g.isSome(a)&&this._deleteComponentObject(a)};e._cacheGPUData=function(a,b=this.elevationOffset){if(g.isNone(this._memCache))this._deleteComponentObject(a);else{var c=this._controller.indexDepth-
a.node.level;this._memCache.put(this._getMemCacheKey(a.node.index,b),a,a.node.memory,c)}};e.loadMissingTextures=function(a,b,c,d){const f=a.filter((h,l)=>{if(0===(h.usage&this.rendererTextureUsage))return!1;if(g.isNone(b))return!0;h=r.selectEncoding(h.encodings,this.supportedTextureEncodings);l=b[l];return g.isNone(l)||null==l.data||h&&l.encoding!==h.encoding?!0:!1});return 0===f.length?Promise.resolve(!1):c(f,d).then(h=>{let l=0;for(let m=0;m<a.length;m++)l<h.length&&h[l].id===a[m].id&&(b[m]=h[l],
l++);return!0})};e.loadCachedNodeData=function(a,b,c){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(a),b).then(d=>{if(null==d)return null;if(d.nodeVersion!==a.version)return this._idbCache.remove(this._getCacheKey(a)),null;a.geometryObb=d.geometryObb;return this.loadMissingTextures(d.requiredTextures,d.textureData,c,b).then(f=>{f&&this._idbCache.initialized&&g.isSome(d.textureData)&&(d.byteSize=wa(d.transformedGeometry,d.textureData),d.textureData.every(va)&&xa(a,d)&&this._idbCache.put(this._getCacheKey(a),
d).catch(h=>H.warn(`Failed to update node with textures in IndexedDB cache: ${a.id}: ${h}`)));X.throwIfAborted(b);return d})}):Promise.resolve(null)};e.addNode=function(a,b,c){return"geometryData"in b?this._addData(a,b.attributeDataInfo,()=>this._transformNode(a,b,c).then(d=>this._safeReschedule(()=>{if(g.isNone(d))return a.hasModifications=!1,this._addCachedNodeData(a,null,c);a.hasModifications=d.transformedGeometry.hasModifications;const {obb:f,componentOffsets:h,featureIds:l,transformedGeometry:m}=
d;var w=aa.computeGlobalTransformation(a.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference);a.geometryObb=Z.create([f.center.x,f.center.y,f.center.z],[f.extents.x,f.extents.y,f.extents.z],[f.orientation.x,f.orientation.y,f.orientation.z,f.orientation.w]);ka.transformMat4(a.geometryObb.center,a.geometryObb.center,w);b.geometryData.componentOffsets=h;l&&(b.geometryData.featureIds=Array.prototype.slice.call(l));w={nodeVersion:a.version,geometryData:b.geometryData,requiredTextures:b.requiredTextures,
textureData:b.textureData,transformedGeometry:m,globalTrafo:w,geometryObb:a.geometryObb,byteSize:wa(m,b.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&xa(a,w)){const z=g.isSome(w.textureData)?w.textureData.map(u=>va(u)?u:null):null;this._idbCache.put(this._getCacheKey(a),{...w,textureData:z}).catch(u=>H.warn(`Failed to store node in IndexedDB cache: ${a.id}: ${u}`))}return this._addCachedNodeData(a,w,c)},c))):Promise.reject()};e.computeVisibilityObb=function(a){return r.computeVisibilityObb(a,
this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)};e._transformNode=function(a,b,c){var d=b.geometryData.geometries;const f=Array(d.length);for(var h=0;h<d.length;++h)f[h]=this._getVertexBufferLayout(d[h],b.geometryDescriptor);d=a.mbs;h=this.elevationOffset;var l=this._controller.crsIndex,m=this._controller.crsVertex;const w=this.view.renderSpatialReference,z=aa.getLocalOrigin(d,h,l),u=aa.computeGlobalTransformation(d,
h,l,w);l=I.getProjectorName(l,m);m=I.getProjectorName(m,w);return g.isNone(l)||g.isNone(m)?Promise.resolve(null):this._worker.invoke({context:this.i3slayer.uid,geometryBuffer:b.geometryBuffer,geometryData:b.geometryData,geometryDescriptor:b.geometryDescriptor,layouts:f,localOrigin:z,globalTrafo:u,mbs:d,obb:a.serviceObb,elevationOffset:h,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:l,vertexToRenderProjector:m},
c)};e._setNewNodeOpacity=function(a){this._setNodeOpacity(a,this.nodeCrossfadingEnabled?0:this.fullOpacity)};e.addCachedGPUData=function(a,b,c){a.geometryObb=Z.clone(this._collection.getComponentObb(b.objectHandle));this._controller.isGeometryVisible(a)?(g.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,b),a=a.index,this._addNodeMeta(a,b),this.updateNodeState(a,c),this._collection.setObjectVisibility(b.objectHandle,!0),this._updateMaterial(b),this._setNewNodeOpacity(b),this._updateEngineObject(b),
this._highlights.objectCreated(b),g.isSome(this._treeDebugger)&&this._treeDebugger.update()):this._cacheGPUData(b)};e.addCachedNodeData=function(a,b,c,d){return this._addData(a,c,()=>this._addCachedNodeData(a,b,d))};e._addCachedNodeData=async function(a,b,c){if(this.suspended||!this._controller.isGeometryVisible(a))this._removeNodeStageData(a.index,this.elevationOffset,this._nodeId2MetaReloading);else if(g.isNone(b))this._addNodeMeta(a.index,null);else{var d=this._addTasks.get(a.index),{geometryData:f,
transformedGeometry:h,globalTrafo:l}=b;await this.attributeOverrides.apply(f.featureIds,d.attributeInfo,c);var m=g.isSome(b.textureData)?b.textureData.filter(y=>g.isSome(y)&&0!==(y.usage&this.rendererTextureUsage)):[];!fa("disable-feature:i3s-basis")&&m.some(y=>g.isSome(y)&&1===y.encoding)&&await ra.loadBasis();a.memory=0;var {componentOffsets:w,geometries:z,featureIds:u}=f,C=this._collection,D=z[0],{layout:E,indices:p,interleavedVertexData:x,positionData:B,hasColors:G}=h,F=this._materialParameters(D,
E),R=w||new Uint32Array([0,p?p.length:x.byteLength/E[0].stride]);R={vertices:{data:x,count:x.byteLength/E[0].stride,layoutParameters:F.geometryParams},positionData:{positions:B.data,indices:B.indices},indices:p,primitiveType:4,componentOffsets:R};var K=D.transformation?pa.clone(D.transformation):pa.create();na.multiply(K,l,K);var L=na.getTranslation(ja.create(),K);K=Na.fromMat4(Ra.create(),K);var Aa=this.view.renderSpatialReference,Ba=this.view.basemapTerrain.spatialReference,ca=ja.create(),da=[1,
1,1];I.localLinearScaleFactors(L,Aa,da,Ba);I.projectVectorToVector(L,Aa,ca,Ba);var W=C.createObject({toMapSpace:[ca[0],ca[1],da[0],da[1]],geometry:R,obb:g.unwrap(a.geometryObb),transform:{position:L,rotationScale:K},visible:!1});R={hasParametersFromSource:!!D.params.material.hasParametersFromSource,isOpaque:"blend"!==D.params.material.alphaMode&&1<=D.params.material.metallicRoughness.baseColorFactor[3]};var nb=2===F.geometryParams.textureCoordinates;L=m.map(y=>this._createTexture(a,F.material,y,nb));
this._configureMaterial(W,D.params.material,L,m);a.memory+=this.memEstimateGeometryAdded(W);var A=new ib(a,u,W,this._getInvalidRendererVersion(),d.attributeInfo,R,L);d.meta=A;!this._hasTextures&&b.requiredTextures.some(({usage:y})=>0!==(y&19))&&(this._hasTextures=!0);this._hasData=!0;this._hasColors=this._hasColors||G;this._hasTextures=this._hasTextures||!!a.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var ob=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(A).then(y=>
{g.isSome(y)&&y.updateObjectVisibility(A.objectHandle,!1);return this._safeReschedule(()=>{var S=this._addTasks.get(a.index);if(S)if(g.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,A),this._addNodeMeta(a.index,A),S.meta=null,this.suspended)this._removeNodeStageData(a.index,this.elevationOffset);else{C.setObjectVisibility(W,!0);g.isSome(y)&&y.updateObjectVisibility(A.objectHandle,!0);A.attributeInfo=S.attributeInfo;S=A.cachedRendererVersion!==this._rendererVersion;var pb=ob!==this.slicePlaneEnabled;
this._setObjectSymbolColors(A);var qb=this._applyFiltersToNode(A);(S||g.isSome(y)&&(pb||qb))&&this._addOrUpdateEdgeRendering(A);this._visibleGeometryChanged(A);this._highlights.objectCreated(A);this._updateMaterial(A);this._setNewNodeOpacity(A);g.isSome(this._treeDebugger)&&this._treeDebugger.update()}},c)}).catch(y=>{g.isSome(d.meta)&&(this._deleteComponentObject(d.meta),d.meta=null);throw y;})}};e._addNodeMeta=function(a,b){this._removeNodeStageData(a,this.elevationOffset,this._nodeId2MetaReloading);
if(this._nodeId2Meta.has(a)){H.error("Removing duplicated node");const c=this._nodeId2Meta.get(a);g.isSome(c)&&this._deleteComponentObject(c)}g.isSome(b)&&(b.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&P(b.cachedEdgeMaterials,0));this._nodeId2Meta.set(a,b)};e._safeReschedule=function(a,b){X.throwIfAborted(b);return this._controller.reschedule(a,b)};e._materialParameters=function(a,b){a=a.params.material;const c=b.some(f=>"uvRegion"===f.name);b=b.some(f=>"normalCompressed"===f.name);const d=
ua(a);return{geometryParams:this._getGeometryParameters({hasTexture:d,hasNormals:b,hasRegions:c}),material:a}};e._configureMaterial=function(a,b,c,d){const f=this.rendererTextureUsage;this._collection.updateMaterial(a,h=>{var l=b.metallicRoughness.baseColorFactor,m=Y.clamp(b.metallicRoughness.baseColorFactor[3],0,1);h.baseColor=[l[0],l[1],l[2],m];h.hasParametersFromSource=!!b.hasParametersFromSource;h.usePBR=this._usePBR();h.mrrFactors=[b.metallicRoughness.metallicFactor,b.metallicRoughness.roughnessFactor,
b.hasParametersFromSource?.2:.5];h.emissiveFactor=b.emissiveFactor;h.isIntegratedMesh=this._isIntegratedMesh;h.alphaCutoff="mask"===b.alphaMode?b.alphaCutoff:Ta.defaultMaskAlphaCutoff;h.alphaDiscardMode="opaque"===b.alphaMode?1:"mask"===b.alphaMode?2:3;l=this._stage.renderView.textureRepository;if(m=O(d,c,33&f))h.baseColorTexture=new N.RenderTexture(l,m);if(m=O(d,c,2&f))h.metallicRoughnessTexture=new N.RenderTexture(l,m);if(m=O(d,c,16&f))h.emissionTexture=new N.RenderTexture(l,m);if(m=O(d,c,8&f))h.occlusionTexture=
new N.RenderTexture(l,m);if(m=O(d,c,4&f))h.normalTexture=new N.RenderTexture(l,m);h.commonMaterialParameters.slicePlaneEnabled=this.slicePlaneEnabled;h.commonMaterialParameters.doubleSided=b.doubleSided;h.commonMaterialParameters.cullFace=b.cullFace;h.ellipsoidMode=fb.getEllipsoidMode(this.view.spatialReference);this._updateMaterialOverlay(h)})};e._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture?a.hasRegions?2:1:0,colors:this._hasVertexColors,normals:a.hasNormals&&!this._isIntegratedMesh}};
e._addData=function(a,b,c){let d=this._addTasks.get(a.index);d?d.attributeInfo=b:(d={...X.createResolver(),attributeInfo:b,meta:null},this._addTasks.set(a.index,d),c().then(d.resolve,d.reject).then(()=>this._addTasks.delete(a.index)).catch(f=>{this._addTasks.delete(a.index);throw f;}));return d.promise};e._clearAddTasks=function(){this._addTasks.forEach(a=>{g.isSome(a.meta)&&(this._deleteComponentObject(a.meta),a.meta=null)});this._addTasks.clear()};e._clippingAreaChanged=function(){const a=J.create();
Va.projectToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};e._geometryFilterChange=function(){this._controller.geometryFilterChanged(this.hasGeometryFilter)};e._filterChange=function(){this._applyFilters(!1)};e._applyFilters=function(a){this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(b=>
{g.isSome(b)&&this._applyFiltersToNode(b)&&(this._addOrUpdateEdgeRendering(b),this._visibleGeometryChanged(b))})};e.getFilters=function(){const a=[];this._clippingArea&&a.push((b,c)=>this._boundingboxFilter(b,c,this._clippingArea));return a};e.addSqlFilter=function(a,b,c){if(g.isSome(b)){const d=b.fieldNames;a.push((f,h)=>this._sqlFilter(f,h,b,d,c))}};e._sqlFilter=function(a,b,c,d,f){const h={},l=this._createLayerGraphic(h),m=this.i3slayer.objectIdField,w=b.featureIds,z=g.isSome(b.attributeInfo)&&
b.attributeInfo.attributeData;d.every(u=>null!=z[u]||u===m)&&r.filterInPlace(a,w,u=>{h[m]=w[u];for(const C of d)C!==m&&(h[C]=r.getCachedAttributeValue(z[C],u));try{return c.testFeature(l)}catch(C){return f(C),!1}})};e._boundingboxNodeTest=function(a,b){I.projectBoundingSphere(a.node.mbs,this._controller.crsIndex,za,this.view.renderSpatialReference);return r.intersectBoundingBoxWithMbs(b,za)};e._boundingboxFeatureTest=function(a,b,c){return J.intersects(c,this._collection.getComponentAabb(a.objectHandle,
b,jb))};e._boundingboxFilter=function(a,b,c){var d=this._collection;const f=this._boundingboxNodeTest(b,c);if(3!==f)if(0===f)a.length=0;else if(d=d.getComponentCount(b.objectHandle),d.invisible+d.visible===b.featureIds.length){var h=this._transformAABB(kb,c,b.objectHandle);r.filterInPlace(a,b.featureIds,l=>this._boundingboxFeatureTest(b,l,h))}};e._transformAABB=function(a,b,c){var d=this._collection.getObjectTransform(c);c=d.position;d=d.rotationScale;a[0]=(b[0]-c[0])/d[0];a[1]=(b[1]-c[1])/d[4];a[2]=
(b[2]-c[2])/d[8];a[3]=(b[3]-c[0])/d[0];a[4]=(b[4]-c[1])/d[4];a[5]=(b[5]-c[2])/d[8];return a};e._addOrUpdateEdgeRendering=function(a,b=!0){if(g.isNone(this._edgeView))return Promise.resolve(null);const c=a.objectHandle,d=this._edgeView.hasObject(c),{hasEdges:f,perFeatureEdgeMaterials:h}=this._getFilteredEdgeMaterials(a),l={slicePlaneEnabled:this.slicePlaneEnabled};if(f)return d?(this.nodeCrossfadingEnabled&&(a=this.getNodeOpacity(a),P(h,a)),this._edgeView.updateAllComponentMaterials(c,h,l,b),this._edgeView.updateObjectVisibility(c,
!0),Promise.resolve(this._edgeView)):this._collection.addEdges(c,this._edgeView,h,l).then(()=>this._edgeView);d&&this._edgeView.removeObject(c);return Promise.resolve(null)};e._removeEdgeRendering=function(a){g.isSome(this._edgeView)&&this._edgeView.hasObject(a.objectHandle)&&this._edgeView.removeObject(a.objectHandle)};e._applyFiltersToNode=function(a){return this._applyFiltersToNodeComponents(a)?(g.isSome(this._labeler)&&this._labeler.applyFilterChange(a),!0):!1};e._applyFiltersToNodeComponents=
function(a){const b=this._collection;var c=0===b.getComponentCount(a.objectHandle).invisible;b.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!c;this._updateCachedFilteredIds(a);if(a.filteredIds===a.featureIds)return!c;c=this._computeFilteredComponentIndices(a);b.setAllComponentVisibilities(a.objectHandle,c);return!0};e._updateCachedFilteredIds=function(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),
a.appliedFilters=this._filters};e._computeFilteredIds=function(a){const b=a.featureIds.slice();for(const c of this._filters)if(c(b,a),0===b.length)break;return b.length===a.featureIds.length?a.featureIds:b};e._computeFilteredComponentIndices=function(a){const b=[];a.featureIds.forEach((c,d)=>{a.filteredIds[b.length]===c&&b.push(d)});return b};e._removeAllNodeDataFromStage=function(a=this.elevationOffset){this._nodeId2Meta.forEach((b,c)=>this._removeNodeStageData(c,a));this._nodeId2MetaReloading.forEach((b,
c)=>this._removeNodeStageData(c,a,this._nodeId2MetaReloading))};e.removeNode=function(a){const b=this.elevationOffset;this._removeNodeStageData(a,b);this._removeNodeStageData(a,b,this._nodeId2MetaReloading)};e._removeNodeStageData=function(a,b,c=this._nodeId2Meta){const d=c.get(a);g.isNone(d)?c.delete(a):(this._collection.setObjectVisibility(d.objectHandle,!1),this._visibleGeometryChanged(d),this._removeEdgeRendering(d),g.isSome(this._labeler)&&this._labeler.removeNodeMeta(d),c.delete(a),this._highlights.objectDeleted(d),
c===this._nodeId2Meta?(this._cacheGPUData(d,b),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(d)):this._deleteComponentObject(d),g.isSome(this._treeDebugger)&&this._treeDebugger.update())};e._deleteComponentObject=function(a){g.isSome(this._edgeView)&&this._edgeView.removeObject(a.objectHandle);this.memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);if(a.textures)for(const b of a.textures)this.memEstimateTextureRemoved(b),this._stage.remove(b)};
e.updateNodeState=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&this._collection.updateMaterial(a.objectHandle,c=>c.polygonOffsetEnabled=0===b)};e._invalidateAllSymbols=function(){this._rendererVersion=r.addWraparound(this._rendererVersion,1);this._controller&&this._controller.requestUpdate()};e._getInvalidRendererVersion=function(){return r.addWraparound(this._rendererVersion,-1)};e._rendererChange=async function(a){this._currentRenderer=a;this.notifyChange("rendererTextureUsage");this._rendererVersion=
r.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;this._invalidateAllSymbols();a&&(this._rendererFields=ia.fixFields(this.i3slayer.fields,await a.getRequiredFields(this.i3slayer.fields)));this._updateSymbologyFields();!this._arcade&&a&&"arcadeRequired"in a&&a.arcadeRequired&&(this._arcade=await Ia.loadArcade());if(a&&"visualVariables"in a&&a.visualVariables)for(const b of a.visualVariables)"color"===b.type?this._colorVariable=b:"opacity"===
b.type?this._opacityVariable=b:H.warn(`Unsupported visual variable type for 3D Object Scene Services: ${b.type}`);if(a)for(const b of a.getSymbols())"mesh-3d"!==b.type&&H.error(`Symbols of type '${b.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()};e._getCachedEdgeMaterials=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedEdgeMaterials};e._getSymbolColors=
function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);const b=a.cachedSymbology;return(c,d)=>{c*=5;Oa.set(d.externalColor,b[c+0]/255,b[c+1]/255,b[c+2]/255,b[c+3]/255);d.externalColorMixMode=b[c+4]&15;d.castShadows=0!==(b[c+4]&16);d.pickable=0!==(b[c+4]&32)}};e._getSymbolInfo=function(a,b){b=a&&a.getSymbol(b,{arcade:this._arcade});if(!(b instanceof Ka))return null;a=b.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);b=r.getSymbolInfo(b);
this._symbolInfos.set(a,b);return b};e._setSymbologyOverride=function(a,b){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=b,this._invalidateAllSymbols(),this._updateSymbologyFields())};e._updateSymbologyFields=function(){this._symbologyFields=g.isSome(this._symbologyOverrideFields)&&0<this._symbologyOverrideFields.length?g.isSome(this._rendererFields)&&0<this._rendererFields.length?ia.fixFields(this.i3slayer.fields,[...this._rendererFields,...this._symbologyOverrideFields]):
this._symbologyOverrideFields:this._rendererFields};e._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var b=this._tmpAttributeOnlyGraphic,c={};b.attributes=c;var d=this._currentRenderer,f=g.isSome(a.attributeInfo)&&a.attributeInfo.attributeData,h=null!=a.featureIds?this.i3slayer.objectIdField:null,l=null!=f&&g.isSome(this._symbologyFields)&&0<this._symbologyFields.length,m=l?[]:null,w=l?[]:null;if(l&&g.isSome(this._symbologyFields))for(var z of this._symbologyFields){var u=
f[z];u&&(m.push(z),w.push(u))}a.cachedSymbology||(a.cachedSymbology=new Uint8Array(5*a.featureIds.length));f={color:Q,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null};z=this.fullOpacity;z=this.nodeCrossfadingEnabled?this.getNodeOpacity(a):z;u=null;var C=2,D=r.transparentEdgeMaterial,E=0;for(let G=0;G<a.featureIds.length;G++){null!=h&&(c[h]=a.featureIds[G]);if(l)for(var p=0;p<m.length;p++)c[m[p]]=r.getCachedAttributeValue(w[p],G);var x=this._getSymbolInfo(d,b);let F=p=null;if(d&&"visualVariables"in
d){if(this._colorVariable){var B=la.getColor(this._colorVariable,b,{color:lb,arcade:this._arcade});B&&(p=Q,p[0]=B.r/255,p[1]=B.g/255,p[2]=B.b/255,this._opacityVariable||null===B.a||(F=B.a))}this._opacityVariable&&(F=la.getOpacity(this._opacityVariable,b,{arcade:this._arcade}))}x&&x.material&&(B=x.material,p=g.isNone(p)||g.isNone(F)?qa.overrideColor(p,F,B.color,B.alpha,ya,Q):qa.overrideColor(p,F,null,null,ya,Q));g.isNone(p)&&(p=Q,p[0]=1,p[1]=1,p[2]=1,p[3]=1);f.pickable=!0;f.castShadows=x?x.castShadows:
!0;f.colorMixMode=x&&x.material?x.material.colorMixMode:1;f.edgeMaterial=x?x.edgeMaterial:null;g.isSome(this._symbologyOverride)&&(f.color=p,this._symbologyOverride(b,f),p=f.color);if(g.isSome(f.edgeMaterial)){x=0>=p[3]?0:1<=p[3]&&(a.material.isOpaque||3===f.colorMixMode)?2:1;if(f.edgeMaterial!==u||x!==C)D={...f.edgeMaterial,opacity:z,objectTransparency:x},u=f.edgeMaterial,C=x;a.cachedEdgeMaterials[G]=D}else a.cachedEdgeMaterials[G]=r.transparentEdgeMaterial;a.cachedSymbology[E+0]=Math.round(255*
p[0]);a.cachedSymbology[E+1]=Math.round(255*p[1]);a.cachedSymbology[E+2]=Math.round(255*p[2]);a.cachedSymbology[E+3]=Math.round(255*p[3]);a.cachedSymbology[E+4]=f.colorMixMode|+f.castShadows<<4|+f.pickable<<5;E+=5}}};e._getFilteredEdgeMaterials=function(a){var b=this._getCachedEdgeMaterials(a);this.nodeCrossfadingEnabled||P(b,this.fullOpacity);if(g.isNone(a.filteredIds))return{hasEdges:b.some(f=>f!==r.transparentEdgeMaterial),perFeatureEdgeMaterials:b};let c=0,d=!1;b=b.map((f,h)=>{if(a.featureIds[h]!==
a.filteredIds[c])return r.transparentEdgeMaterial;d=d||f!==r.transparentEdgeMaterial;c++;return f});return{hasEdges:d,perFeatureEdgeMaterials:b}};e._setObjectSymbolColors=function(a){if(this._hasSymbolColors){var b=a.objectHandle;a=this._getSymbolColors(a);this._collection.setComponentData(b,a);this._stage.renderView.setNeedsRender()}};e._reloadAll=function(a=this.elevationOffset){this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};e._opacityChange=function(a){this.nodeCrossfadingEnabled&&
this._crossfadeHelper.stopAllNodeFading();this._nodeId2Meta.forEach(b=>{g.isNone(b)||(this._collection.updateMaterial(b.objectHandle,c=>c.objectOpacity=a),P(b.cachedEdgeMaterials,a),this._updateEdgeRendering(b))})};e._updateMaterial=function(a){this._collection.updateMaterial(a.objectHandle,b=>{b.commonMaterialParameters.slicePlaneEnabled=this.slicePlaneEnabled;b.usePBR=this._usePBR();this._updateMaterialOverlay(b)})};e._updateMaterialOverlay=function(a){};e._updateEngineObject=function(a){this._setObjectSymbolColors(a);
this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this._visibleGeometryChanged(a)};e._slicePlaneEnabledChange=function(a){this._intersectionHandler&&(this._intersectionHandler.slicePlane=a);g.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(b=>{g.isNone(b)||(this._collection.updateMaterial(b.objectHandle,c=>{c.commonMaterialParameters.slicePlaneEnabled=a}),this._updateEdgeRendering(b,!1))})};e._updatePBR=function(){this._nodeId2Meta.forEach(a=>{g.isNone(a)||
this._collection.updateMaterial(a.objectHandle,b=>{b.usePBR=this._usePBR()})});this._hasLoadedPBRTextures=!0};e._usePBR=function(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled};e._updateEdgeRendering=function(a,b=!0){g.isSome(this._edgeView)&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,b)};e._forAllNodes=function(a){this._nodeId2Meta.forEach(a)};e._forAllFeatures=function(a,b,c=0){oa.someMap(this._nodeId2Meta,d=>{if(g.isNone(d))return!1;
if(g.isSome(b))switch(b(d)){case 0:return!0;case 2:return!1}let f=1;switch(c){case 1:f=this._forAllFeaturesOfNode(d,a);break;case 0:f=this._forVisibleFeaturesOfNode(d,a);break;case 2:f=this._forAllFeaturesOfNodeInClippingArea(d,a)}return 0===f})};e._forAllFeaturesOfNode=function(a,b){let c=1;const d=a.featureIds;for(let f=0;f<d.length&&(c=b(d[f],f,a),0!==c);f++);return c};e._forVisibleFeaturesOfNode=function(a,b){let c=1;const d=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,
f=>{c=b(d[f],f,a);return 1===c});return c};e._forAllFeaturesOfNodeInClippingArea=function(a,b){if(null==this._clippingArea)return this._forAllFeaturesOfNode(a,b);var c=this._boundingboxNodeTest(a,this._clippingArea);if(0===c)return 1;if(3===c)return this._forAllFeaturesOfNode(a,b);c=a.featureIds;const d=r.getClipAABB(this._clippingArea,this._collection.getObjectTransform(a.objectHandle));for(let f=0;f<c.length;f++){if(!this._boundingboxFeatureTest(a,f,d))continue;const h=b(c[f],f,a);if(0===h)return h}return 1};
e._createAttributes=function(a,b){const c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=g.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;if(g.isSome(b))for(const d of Object.keys(b))c[d]=r.getCachedAttributeValue(b[d],a);return c};e._createGraphic=function(a,b){return this._createLayerGraphic(this._createAttributes(a,b))};e.highlight=function(a){const b=this._highlights;"number"===typeof a?a=[a]:a instanceof U?a=[a]:a instanceof Ha&&(a=a.toArray());if(Array.isArray(a)&&
0<a.length){if(a[0]instanceof U){const c=this.i3slayer.fieldsIndex,d=this._getObjectIdField();a=a.map(l=>ba.attributeLookup(c,l.attributes,d));const {set:f,handle:h}=b.acquireSet();b.setFeatureIds(f,a);return h}if("number"===typeof a[0]){const {set:c,handle:d}=b.acquireSet();b.setFeatureIds(c,a);return d}}return mb};e._visibleGeometryChanged=function(a){this._elevationProvider&&(this._elevationProvider.objectChanged(a.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=
Ga.schedule(()=>{this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null})))};e.getNodeOpacityByIndex=function(a){a=this._nodeId2Meta.get(a);return this.getNodeOpacity(a)};e.getNodeOpacity=function(a){return g.isSome(a)?this._collection.getMaterial(a.objectHandle).objectOpacity:0};e.isNodeFullyFadedIn=function(a){return this._crossfadeHelper.isNodeFullyFadedIn(a)};e.getNodeCrossfadeMetaData=function(a){return this._nodeId2Meta.get(a)};e.markNodeToRemove=function(a){this._controller&&
this._controller.markNodeToRemove(a)};e.removeMarkedNodes=function(){this._controller&&this._controller.removeMarkedNodes()};e.foreachCrossfadeNode=function(a){this._nodeId2Meta.forEach((b,c)=>a(c,b))};e.fadeNode=function(a,b,c){if(this.nodeCrossfadingEnabled){var d=this._nodeId2Meta.get(a);g.isSome(d)&&this._crossfadeHelper.fadeNode(a,d,b,c)}};e.setNodeOpacityByIndex=function(a,b){a=this._nodeId2Meta.get(a);g.isSome(a)&&this._setNodeOpacity(a,b)};e._setNodeOpacity=function(a,b){this._collection.updateMaterial(a.objectHandle,
c=>c.objectOpacity=b);this._setNodeEdgeOpacity(a,b)};e._setNodeEdgeOpacity=function(a,b){g.isSome(this._edgeView)&&a.cachedEdgeMaterials&&(P(a.cachedEdgeMaterials,b),a=a.objectHandle,this._edgeView.hasObject(a)&&this._edgeView.updateAllComponentOpacities(a,b))};e.updateNodeModificationStatus=function(a){var b=a.length;if(this._hasModifications&&!(0>=b)&&!0===this._i3sWasmLoaded){b=this.i3slayer.uid;var c=gb(a);if(g.isSome(c)){V.filterObbsForModificationsSync({context:b,buffer:c.buffer});const d=new Float64Array(c.buffer);
a.forAll((f,h)=>{h=V.interpretObbModificationResults(d[h]);f.imModificationImpact=h;0!==h&&this._controller.invalidateGeometryVisibility(f.index)})}}};e.notifyUpdate=function(){this.notifyChange("updating")};e.notifyLODUpdate=function(){this._controller.notifyLODUpdate()};e.isUpdating=function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||g.isSome(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof
Promise||0<this._asyncModuleLoading};e.computeNodeFiltering=function(a){a.filterImpact=0};T._createClass(q,[{key:"lodCrossfadeoutDuration",get:function(){return 0}},{key:"lodCrossfadeinDuration",get:function(){return 0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return 0}},{key:"layerUid",get:function(){return this.i3slayer&&this.i3slayer.uid}},{key:"sublayerUid",get:function(){return null}},{key:"hasTexturesOrVertexColors",get:function(){return this._hasData?this._hasTextures||this._hasColors?
"yes":"probably-not":"unknown"}},{key:"rendererTextureUsage",get:function(){return r.rendererNeedsTextures(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}},{key:"elevationOffset",get:function(){const a=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){const b=La.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference),c=Ma.getMetersPerUnit(a.unit);return g.unwrapOr(a.offset,0)*
c/b}return 0}},{key:"supportedTextureEncodings",get:function(){return r.getSupportedEncodings(this.view)}},{key:"uncompressedTextureDownsamplingEnabled",get:function(){var a;const b=null==(a=this.view)?void 0:a.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled;a=0===(this.supportedTextureEncodings&2);return b&&a}},{key:"_disableAtlasAnisotropy",get:function(){var a,b;return!(null!=(a=this.view)&&null!=(b=a._stage)&&b.renderView.has(2))}},{key:"_idbCacheEnabled",get:function(){return!this._controller.disableIDBCache&&
0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix}},{key:"supportsNodeCrossFading",get:function(){var a,b;return!(null!=(a=this.view)&&null!=(b=a._stage)&&b.renderView.has(3))}},{key:"nodeCrossfadingEnabled",get:function(){return this.supportsNodeCrossFading&&(0<this.lodCrossfadeinDuration||0<this.lodCrossfadeoutDuration||0<this.lodCrossfadeUncoveredDuration)}},{key:"nodeFadeoutEnabled",get:function(){return this.supportsNodeCrossFading&&0<this.lodCrossfadeoutDuration}},
{key:"hasGeometryFilter",get:function(){return!1}},{key:"performanceInfo",get:function(){const a={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/
1048576).toFixed(1)+"MB",...this._collection?this._collection.performanceInfo:{shown:0,hidden:0}};g.isSome(this._memCache)&&(a.MemCache=Math.round(100*this._memCache.hitRate)+"% hit");this._controller&&(this._idbCacheEnabled&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a}},{key:"test",get:function(){const a=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const b=[];a._forAllFeatures(c=>{b.push(c);return 1},
null,0);b.sort((c,d)=>c-d);return b},get numNodes(){return a._nodeId2Meta.size}}}},{key:"_hasModifications",get:function(){return this._modifications&&0<this._modifications.length}}]);return q}(k);t.__decorate([v.property()],k.prototype,"_hasLoadedPBRTextures",void 0);t.__decorate([v.property()],k.prototype,"_asyncModuleLoading",void 0);t.__decorate([v.property()],k.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);t.__decorate([v.property()],k.prototype,"view",void 0);t.__decorate([v.property()],
k.prototype,"i3slayer",void 0);t.__decorate([v.property()],k.prototype,"_controller",void 0);t.__decorate([v.property()],k.prototype,"_labeler",void 0);t.__decorate([v.property()],k.prototype,"updating",void 0);t.__decorate([v.property()],k.prototype,"suspended",void 0);t.__decorate([v.property()],k.prototype,"holeFilling",void 0);t.__decorate([v.property(Wa.updatingProgress)],k.prototype,"updatingProgress",void 0);t.__decorate([v.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],k.prototype,
"updatingProgressValue",void 0);t.__decorate([v.property({readOnly:!0})],k.prototype,"hasTexturesOrVertexColors",null);t.__decorate([v.property({readOnly:!0})],k.prototype,"rendererTextureUsage",null);t.__decorate([v.property({readOnly:!0})],k.prototype,"elevationOffset",null);t.__decorate([v.property({type:Boolean})],k.prototype,"slicePlaneEnabled",void 0);t.__decorate([v.property()],k.prototype,"supportedTextureEncodings",null);t.__decorate([v.property()],k.prototype,"uncompressedTextureDownsamplingEnabled",
null);t.__decorate([v.property({type:[Pa]})],k.prototype,"_modifications",void 0);return k=t.__decorate([Ea.subclass("esri.views.3d.layers.I3SMeshView3D")],k)};Object.defineProperty(ea,"__esModule",{value:!0})});