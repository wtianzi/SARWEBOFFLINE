// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/Accessor ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../core/Handles ../../../../core/watchUtils ../../../support/Scheduler ../../../../chunks/ray ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/lib/Intersector ../debugFlags ../PropertiesPool ../debugUtils ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates".split(" "),
function(c,u,d,T,q,U,V,e,W,E,X,Y,Z,F,y,r,G,z,m,v,H,A,I,J,n,B,w,K,L,M,N){c.PointsOfInterest=function(C){function t(a){a=C.call(this,a)||this;a._handles=new G;a._tmpRay=v.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new J.PropertiesPool({renderPointOfView:O},u._assertThisInitialized(a));a.renderPointOfView=y.create();a._pois=[];a._debugCenters=new Map;return a}u._inheritsLoose(t,
C);var f=t.prototype;f.initialize=function(){var a;const {state:b,basemapTerrain:g,renderCoordsHelper:p,map:D}=this.view;this._surfaceIntersector=new A.Intersector(b.mode);this._surfaceIntersector.options.backfacesTerrain=b.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._contentIntersector=new A.Intersector(b.mode);var h=()=>this._estimateSurfaceAltitudeAtCenter();const P=this.view.resourceController.scheduler,x=q.unwrap(null==(a=this.view.basemapTerrain)?void 0:a.elevationQueryCache);
a={state:b,scheduler:P,surface:g,renderCoordsHelper:p};this._set("centerOnSurfaceInfrequent",new w["default"]({...a,task:m.Task.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnSurfaceFrequent",new w["default"]({...a,task:m.Task.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnContent",new w["default"]({...a,task:m.Task.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",
new B["default"]({...a,cache:x,task:m.Task.POINT_OF_INTEREST_INFREQUENT,map:D}));this._set("contentCameraOnSurface",new B["default"]({...a,cache:x,task:m.Task.POINT_OF_INTEREST_INFREQUENT,map:D,cameraName:"contentCamera"}));this._set("surfaceGeometryUpdates",new N["default"]({...a,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new K.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:p}));
this._set("surfaceOrigin",new M.StableSurfaceCenter({cache:x,view:this.view}));this._set("focus",new L["default"]({state:b,surface:g,renderCoordsHelper:p,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(k,Q)=>this._estimateSurfaceIntersectionAtRenderPoint(k,Q)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);h=this.view.graphics;this._debugCenters.set(this.centerOnContent,
new n.GraphicsHandle(h,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new n.GraphicsHandle(h,"red","CenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new n.GraphicsHandle(h,"blue","CameraOnSurface"));this._debugCenters.set(this.contentCameraOnSurface,new n.GraphicsHandle(h,"blue","CameraOfInterestOnSurface"));this._debugCenters.set(this.focus,new n.GraphicsHandle(h,"green","Focus"));this._handles.add([b.watch("camera",k=>this._cameraChanged(k),!0),g.watch("extent",
()=>this._updateCenterPointsOfInterest()),this.surfaceGeometryUpdates.events.on("request-update",()=>this._updateCenterPointsOfInterest()),this.contentGeometryUpdates.events.on("request-update",()=>this._updateCenterOnContent()),z.init(I,"SHOW_POI",k=>this._setDebug(k))]);this._cameraChanged(this.view.state.camera);for(const k of this._pois)k.update()};f.destroy=function(){this._setDebug(!1);this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};
f._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this.centerRay;if(q.isNone(a))return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,l,R)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(l):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};f._estimateSurfaceAltitudeAtCenter=
function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this.centerRay;if(q.isNone(a))return this._surfaceAltitudeAtCenter;const b=a.origin,g=r.add(l,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a);this._surfaceIntersector.intersect(null,null,this.view.state.camera);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,b,g);this._surfaceIntersector.results.min.getIntersectionPoint(l)&&
(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(l));return this._surfaceAltitudeAtCenter};f._estimateSurfaceIntersectionAtRenderPoint=function(a,b){a=v.fromRenderAtEye(this.view.state.camera,a,S);if(q.isNone(a))return null;const g=a.origin,p=r.add(l,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a);this._surfaceIntersector.intersect(null,null,this.view.state.camera);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,g,p);return this._surfaceIntersector.results.min.getIntersectionPoint(b)?
b:null};f._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;r.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",r.copy(this._propertiesPool.get("renderPointOfView"),a))};f._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};f._updateCenterOnContent=function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};
f._setDebug=function(a){if(a)for(const b of this._pois)this._handles.add(z.init(b,"renderLocation",g=>this._debugCenters.get(b).showPoint(g,b.renderCoordsHelper.spatialReference)),"debug");else this._debugCenters.forEach(b=>b.remove()),this._handles.remove("debug")};u._createClass(t,[{key:"updating",get:function(){var a;return!!(null!=(a=this.surfaceGeometryUpdates)&&a.updating||this._pois.some(b=>b.updating))}},{key:"centerRay",get:function(){this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,
this._tmpRay),this._centerRayDirty=!1);return this._centerRay}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.update();for(const a of this._pois)a.update()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return t}(F);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"centerOnContent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,
"centerOnSurfaceInfrequent",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"contentCameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"focus",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"surfaceOrigin",
void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0);d.__decorate([e.property({constructOnly:!0})],c.PointsOfInterest.prototype,"view",void 0);d.__decorate([e.property({readOnly:!0})],c.PointsOfInterest.prototype,"updating",null);c.PointsOfInterest=d.__decorate([E.subclass("esri.views.3d.support.PointsOfInterest")],c.PointsOfInterest);const O=
Array,l=y.create(),S=v.create(),R={exclude:new Set([H.TERRAIN_ID])};c.default=c.PointsOfInterest;Object.defineProperty(c,"__esModule",{value:!0})});