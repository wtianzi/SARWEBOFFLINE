// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/compilerUtils ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../support/mathUtils ../../../../geometry/projectionEllipsoid ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../navigation/gamepadAndKeyboardUtils ../Constraints ../../support/stack ../../support/geometryUtils ../utils/viewUtils ../../camera/constraintUtils ../../webgl-engine/lib/Camera ../utils/navigationUtils ./InteractiveController ../../support/cameraUtilsInternal ../../support/cameraUtils".split(" "),
function(r,K,A,Z,L,M,aa,ba,E,ca,N,da,ea,fa,p,O,e,P,G,n,H,t,x,m,B,I,v,J,w,Q,R,S){r.GamepadKeyboardController=function(C){function D(a){a=C.call(this,a)||this;a.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0};a.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0];a.tmpCamera=new J;a.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new J,interactionFactor:0,interactionDirection:null,tiltMode:1};return a}K._inheritsLoose(D,C);var h=D.prototype;h.handleEventGamepad=function(a){const b=
t.extractTransformation(a,this.view.navigation.gamepad,this.transformation);("end"===a.action||t.isZeroTransformation(b))&&this.finishController()};h.activateDirection=function(a){this.keysButtonState[a]=1;t.extractTransformationKeyboard(this.keysButtonState,this.transformation)};h.deactivateDirection=function(a){this.keysButtonState[a]=0;a=t.extractTransformationKeyboard(this.keysButtonState,this.transformation);t.isZeroTransformation(a)&&this.finishController()};h.onControllerStart=function(a){this.filteredSurfaceElevation=
this.view.pointsOfInterest.cameraOnSurface.location.z;this.headingStart=this.view.camera.heading;C.prototype.onControllerStart.call(this,a)};h.updateFilteredSurfaceElevation=function(a){this.filteredSurfaceElevation+=(this.view.pointsOfInterest.cameraOnSurface.location.z-this.filteredSurfaceElevation)*a};h.stepController=function(a,b){this.updateStartHeading();this.updateFilteredSurfaceElevation(a);this.currentCamera.copyViewFrom(b);this.updateCameraCenter();this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera);
this.calculateControlTransformation(a,this.currentCamera,u);this.applyDisabledMovementTypes(u);this.applyPan(u.pan);this.applyRotate(u.rotate);this.applyZoom(u.zoom);this.applyAscend(u.ascend);this.constraintOptions.interactionType=0;this.constraintOptions.selection=8;v.applyAll(this.view,this.currentCamera,this.constraintOptions);C.prototype.stepController.call(this,a,b)};h.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)};h.applyRotate=
function(a){if(a.enabled){var b=this.currentCamera,{center:c,up:f,eye:g}=b;e.subtract(c,c,g);e.transformMat4(c,c,a.matrix);e.add(c,c,g);e.transformMat4(f,f,a.matrix);b.markViewDirty();this.constraintOptions.interactionType=3;this.constraintOptions.selection=7;v.applyAll(this.view,b,this.constraintOptions)}};h.applyPan=function(a,b=this.currentCamera){if(a.enabled){var {center:c,eye:f,up:g}=b;e.transformMat4(f,f,a.matrix);e.transformMat4(c,c,a.matrix);this.view.state.isGlobal&&e.transformMat4(g,g,
a.matrix);b.markViewDirty();this.constraintOptions.interactionType=4;this.constraintOptions.selection=15;v.applyAll(this.view,b,this.constraintOptions)}};h.applyZoom=function(a){if(a){var {eye:b,viewForward:c}=this.currentCamera;e.add(b,b,e.scale(m.sv3d.get(),c,a));this.currentCamera.markViewDirty();e.copy(y,c);e.negate(y,y);this.constraintOptions.interactionDirection=y;this.constraintOptions.interactionType=1;this.constraintOptions.selection=7;v.applyAll(this.view,this.currentCamera,this.constraintOptions);
this.constraintOptions.interactionDirection=null}};h.applyAscend=function(a){if(a){var {center:b,eye:c}=this.currentCamera,f=this.view.renderCoordsHelper.worldUpAtPosition(c,m.sv3d.get());this.constraintOptions.interactionDirection=e.copy(y,f);this.view.state.isGlobal?(f=e.length(c),a=(f+a)/f,e.scale(c,c,a),e.scale(b,b,a)):(a=e.scale(m.sv3d.get(),f,a),e.add(c,c,a),e.add(b,b,a));this.currentCamera.markViewDirty();this.updateCameraCenter();this.constraintOptions.interactionType=5;this.constraintOptions.selection=
8;v.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter();this.constraintOptions.selection=7;v.applyAll(this.view,this.currentCamera,this.constraintOptions);this.constraintOptions.interactionDirection=null}};h.calculateControlTransformation=function(a,b,c){c.zoom=0;c.ascend=0;c.pan.enabled=!1;n.identity(c.pan.matrix);c.rotate.enabled=!1;n.identity(c.rotate.matrix);a=this.computeVelocities(a);this.view.state.isLocal?this.calculateControlTransformationLocal(a,b,c):
this.calculateControlTransformationGlobal(a,b,c)};h.updateCameraCenter=function(){const {ray:a,center:b}=this.currentCamera;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(a,this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,b);this.currentCamera.markViewDirty()};h.calculateControlTransformationLocal=function(a,b,c){const {viewRight:f,viewForward:g}=b,d=this.transformation;var l=this.view.navigation.gamepad,k=e.set(m.sv3d.get(),g[0],g[1],0);e.normalize(k,k);
var q=d.translation[0]*a.pan;0!==q&&(q=e.scale(m.sv3d.get(),f,q),n.translate(c.pan.matrix,c.pan.matrix,q),c.pan.enabled=!0);switch(l.mode){case "pan":l=-d.translation[1]*a.pan;0!==l&&(k=e.scale(m.sv3d.get(),k,l),n.translate(c.pan.matrix,c.pan.matrix,k),c.pan.enabled=!0);c.zoom=d.zoom*a.zoom;break;case "zoom":c.zoom=(-d.translation[1]+d.zoom)*a.zoom;break;default:L.neverReached(l.mode)}c.ascend=d.translation[2]*a.ascend;k=-d.heading*a.rotate;0!==k&&(n.rotate(c.rotate.matrix,c.rotate.matrix,k,this.view.renderCoordsHelper.worldUpAtPosition(b.eye,
m.sv3d.get())),c.rotate.enabled=!0);a=d.tilt*a.rotate;b=I.viewAngle(this.view.renderCoordsHelper,b.center,b.eye);if(b=p.clamp(b+a,x.TiltDefault.min,x.TiltDefault.max)-b)n.rotate(c.rotate.matrix,c.rotate.matrix,b,f),c.rotate.enabled=!0};h.calculateControlTransformationGlobal=function(a,b,c){const {eye:f,viewRight:g}=b,d=this.transformation;var l=this.view.navigation.gamepad,k=e.cross(m.sv3d.get(),g,f);e.normalize(k,k);e.negate(k,k);w.panMotionToRotationMatrix(this.beginCamera,b,d,a,this.view.camera.heading,
this.headingStart,this.view.camera.tilt,c,l);this.tmpCamera.copyFrom(this.currentCamera);this.applyPan(u.pan,this.tmpCamera);l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.ascend=d.translation[2]*a.ascend;k=-d.heading*a.rotate;0!==k&&(n.rotate(c.rotate.matrix,c.rotate.matrix,k,this.tmpCamera.eye),c.rotate.enabled=!0);b=this.clampTiltDeltaGlobalToValidRange(d.tilt*a.rotate,b.ray,l);0!==b&&(n.rotate(c.rotate.matrix,c.rotate.matrix,b,this.tmpCamera.viewRight),c.rotate.enabled=
!0);c.zoom+=d.zoom*a.zoom};h.clampTiltDeltaGlobalToValidRange=function(a,b,c){const f=G.getReferenceEllipsoid(this.view.spatialReference),g=w.onSurfaceTiltToEyeTiltGlobal(x.TiltDefault.min,b.origin,c,f);var d=0;let l=0;d=m.sv3d.get();this.view.renderCoordsHelper.intersectManifold(b,c,d)?(d=I.viewAngle(this.view.renderCoordsHelper,d,b.origin),d=w.onSurfaceTiltToEyeTiltGlobal(d,b.origin,c,f),l=w.onSurfaceTiltToEyeTiltGlobal(x.TiltDefault.max,b.origin,c,f)):(B.sphere.closestPointOnSilhouette(B.sphere.fromRadius(c+
f.radius),b,d),d=p.acosClamped(-e.dot(b.direction,e.normalize(d,d))),d=w.offSurfaceTiltToEyeTiltGlobal(d,b.origin,c,f),l=w.offSurfaceTiltToEyeTiltGlobal(x.TiltDefault.max,b.origin,c,f));return p.clamp(d+a,g,l)-d};h.getPointAbsoluteSurfaceElevation=function(a,b,c){const {renderCoordsHelper:f}=this.view,g=f.getAltitude(a);b+=Math.abs(g-b);e.copy(c,a);f.setAltitude(b,c);return b};h.clampedDistanceToSurface=function(a,b){const {renderCoordsHelper:c}=this.view,{camera:f}=this.view.state;var {direction:g}=
S.headingTiltToDirectionUp(this.view,b,0,80,T);g=c.intersectManifoldClosestSilhouette(B.ray.wrap(b,g),a,m.sv3d.get());g=e.distance(b,g);a=c.intersectManifoldClosestSilhouette(B.ray.wrap(b,P.directionFromTo(m.sv3d.get(),b,f.center)),a,m.sv3d.get());b=e.distance(b,a);return Math.min(g,b)};h.computeHeadingRotateRadius=function(a){const {renderCoordsHelper:b,state:c}=this.view,{camera:f,isGlobal:g}=c;var d=b.intersectManifoldClosestSilhouette(f.ray,this.filteredSurfaceElevation,m.sv3d.get());if(g){const l=
e.subtract(m.sv3d.get(),a,d);d=e.length(l);e.scale(l,l,1/d);a=e.normalize(m.sv3d.get(),a);a=p.acosClamped(e.dot(a,l));return d*Math.sin(Math.min(U,a))}a=e.copy(m.sv3d.get(),a);b.setAltitude(this.filteredSurfaceElevation,a);return e.distance(d,a)};h.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:5};h.computeVelocities=function(a){var b=this.filteredSurfaceElevation,c=b+G.getReferenceEllipsoid(this.view.spatialReference).radius;const {camera:f,isGlobal:g}=this.view.state;
var d=m.sv3d.get();const l=this.getPointAbsoluteSurfaceElevation(f.eye,b,d);var k=this.clampedDistanceToSurface(b,d);const q=f.width/2,F=.75*f.width,V=.75*f.width;var z=k*Math.tan(.5*f.fovX)/q;c=z/c;d=z/this.computeHeadingRotateRadius(d);z=(g?c:z)*F*a;b=l-b;b=Math.max(this.minimumAscendVelocity()*a,2**(F*a/q)*b-b);k=2**(F*a/q)*k-k;a*=p.clamp(d*V,W,X);return{pan:z,ascend:b,zoom:k,rotate:a}};h.applyDisabledMovementTypes=function(a){!M.isSome(this.disableMovements)||void 0!==this.disableMovements.mode&&
this.view.state.mode!==this.disableMovements.mode||(a.zoom=this.disableMovements.zoom?0:a.zoom,a.ascend=this.disableMovements.ascend?0:a.ascend,a.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&n.identity(a.pan.matrix),a.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&n.identity(a.rotate.matrix))};D.activatesFor=function(a,b){a=t.extractTransformation(b,a.navigation.gamepad,Y);return!("end"===b.action||t.isZeroTransformation(a))};return D}(Q.InteractiveController);
A.__decorate([E.property({constructOnly:!0})],r.GamepadKeyboardController.prototype,"view",void 0);A.__decorate([E.property({constructOnly:!0})],r.GamepadKeyboardController.prototype,"gamepadDevice",void 0);A.__decorate([E.property({constructOnly:!0})],r.GamepadKeyboardController.prototype,"disableMovements",void 0);r.GamepadKeyboardController=A.__decorate([N.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],r.GamepadKeyboardController);const Y={translation:[0,0,0],heading:0,
tilt:0,zoom:0},U=p.deg2rad(80),W=p.deg2rad(30),X=p.deg2rad(80),u={zoom:0,ascend:0,pan:{enabled:!1,matrix:H.create()},rotate:{enabled:!1,matrix:H.create()}},y=O.create(),T=R.createDirectionUp();Object.defineProperty(r,"__esModule",{value:!0})});