// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/PooledArray ../../../core/Accessor ../../../core/uid ../../../chunks/vec3f64 ../../../core/Handles ../../../core/watchUtils ../../../chunks/mat4 ../../support/Scheduler ../../../core/MapUtils ../../../chunks/vec2f64 ../../webgl/Texture ../../webgl/Util ../webgl-engine/lib/glUtil3D ../webgl-engine/lighting/Lightsources ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/Camera ../support/debugFlags ../webgl-engine/lib/AutoDisposable ./OverlayRenderTarget ./Overlay ../webgl-engine/core/shaderTechnique/CommonUniformStore ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/GLMaterialRep ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/RenderContext ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/lineStippleUtils".split(" "),
function(m,C,n,ja,h,M,ka,r,la,N,ma,na,oa,O,P,Q,y,R,D,z,S,t,T,U,V,E,W,X,Y,F,u,Z,G,aa,ba,ca,da,ea,fa,H,ha,ia){const I=M.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");m.OverlayRenderer=function(v){function q(a){a=v.call(this,a)||this;a._overlays=null;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._lighting=new ha.SceneLighting;a._localOrigins=new da;a._handles=new R;a._layerRenderers=new Map;a._sortedLayerRenderersDirty=!1;a._sortedLayerRenderers=new O;a._geometries=new Map;
a.globalUnitScale=1;a.longitudeCyclical=null;return a}C._inheritsLoose(q,v);var e=q.prototype;e.initialize=function(){this._rctx=this.renderView.renderingContext;this._renderContext=new ea(this._rctx,null,null,null,null,null);this._stippleTextureRepository=new ia.StippleTextureRepository;this.waterTextureRepository=this.renderView.waterTextureRepository;this._shaderTechniqueRepository=new ba.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:2,commonUniformStore:new aa.CommonUniformStore,stippleTextureRepository:this._stippleTextureRepository,
waterTextureRepository:this.waterTextureRepository});D.init(this.waterTextureRepository,"loadingState",()=>this.emitContentChanged());this._materialRepository=new ca(this.renderView.textureRepository,this._shaderTechniqueRepository);this._materialRepository.onMaterialChanged=a=>{0<(a.renderOccluded&4)!==this._rendersOccluded&&this.updateRendersOccluded();this.emitContentChanged();this.notifyChange("updating")};this._compositingHelper=this.renderView.compositingHelper;this._lighting.set({lights:[new W.AmbientLight(y.fromValues(1,
1,1))],groundLightingFactor:1,globalFactor:0});this._bindParameters={slot:null,highlightDepthTexture:E.createEmptyDepthTexture(this._rctx),camera:p,inverseViewport:T.create(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,
geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!0,multipassGeometryEnabled:!1};this._handles.add(this.scheduler.registerTask(S.Task.STAGE,()=>this.commitChanges(),()=>this.updating))};e.dispose=function(){this._handles.destroy();this._layerRenderers.forEach(a=>a.dispose());this._layerRenderers.clear();this._bindParameters.highlightDepthTexture=h.disposeMaybe(this._bindParameters.highlightDepthTexture);this._shaderTechniqueRepository=h.disposeMaybe(this._shaderTechniqueRepository);
this._temporaryRenderTarget=h.disposeMaybe(this._temporaryRenderTarget);this._debugPatternTexture=h.disposeMaybe(this._debugPatternTexture);this._quadVAO=h.disposeMaybe(this._quadVAO)};e.forEachOverlay=function(a){h.isSome(this._overlays)&&(a(this._overlays[0],0),a(this._overlays[1],1))};e.ensureOverlays=function(){if(h.isNone(this._overlays)){const a=this.renderView.renderingContext;this._overlays=[new G.Overlay(a),new G.Overlay(a)]}};e.disposeOverlays=function(){h.isSome(this._overlays)&&(this._overlays.forEach(a=>
a.dispose()),this._overlays=null)};e.commitChanges=function(){let a=!1;this._layerRenderers.forEach((b,c)=>{b.commitChanges()&&(a=!0);b.isEmpty&&(this._layerRenderers.delete(c),this._sortedLayerRenderersDirty=!0,this._handles.remove(c))});this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),a=!0);a&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())};e.addGeometries=function(a,b,c){for(const d of a)null==
d.origin&&(d.origin=this._localOrigins.getOrigin(d.boundingSphere)),h.isNone(d.id)&&(d.id=Q.generateUID()),this._geometries.set(d.id,d);this.ensureLayerRenderer(b).add(a);2===c&&this.notifyGraphicGeometryChanged(a,b)};e.removeGeometries=function(a,b,c){for(var d of a)this._geometries.delete(h.unwrap(d.id));if(d=this._layerRenderers.get(b))d.remove(a),2===c&&this.notifyGraphicGeometryChanged(a,b)};e.updateGeometries=function(a,b,c){const d=this._layerRenderers.get(b);if(d)switch(d.modify(a,c),c){case 4:case 2:return this.notifyGraphicGeometryChanged(a,
b);case 1:return this.notifyGraphicVisibilityChanged(a,b)}else I.warn("Attempted to update geometry for nonexistent layer")};e.notifyGraphicGeometryChanged=function(a,b){if(!h.isNone(b.notifyGraphicGeometryChanged))for(const d of a)if(a=d.graphicUid,a!==c){b.notifyGraphicGeometryChanged(a);var c=a}};e.notifyGraphicVisibilityChanged=function(a,b){if(!h.isNone(b.notifyGraphicVisibilityChanged))for(const d of a)if(a=d.graphicUid,a!==c){b.notifyGraphicVisibilityChanged(a);var c=a}};e.updateHighlights=
function(a,b){(b=this._layerRenderers.get(b))?b.modify(a,8):I.warn("Attempted to update highlights for nonexistent layer")};e.isEmpty=function(){return 0===this._geometries.size&&!F.OVERLAY_DRAW_DEBUG_TEXTURE};e.updateLogic=function(a){let b=!1;this._layerRenderers.forEach(c=>{c.updateLogic(a)&&(b=!0)});return b};e.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};e.drawPass=function(a,b,c,d=0){if(0===c.numViews)return!1;this._screenToWorldRatio=c.pixelRatio*Math.abs(c.views[0].extent[2]-
c.views[0].extent[0])/Math.abs(c.views[0].viewport[2]-c.views[0].viewport[0]);if(this.isEmpty()||5===a&&!this.hasHighlights||3===a&&!this.hasWater||!this.hasNonZeroSizedView(c))return!1;const f=c.width,g=c.height;if(!b.isValid())return!1;b.resize(f,g);const l=this._rctx;p.pixelRatio=c.pixelRatio||1;this._renderContext.pass=a;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale;b.bind(l);l.setClearColor(0,
0,0,0);l.clearSafe(16384);1===d&&(this._renderContext.renderOccludedMask=4);if(F.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==d)for(let k=0;k<c.numViews;k++)this.setViewParameters(c.views[k],p),this.drawDebugTexture(f,g,J[c.index%J.length]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forAll(({layerView:k,renderer:A})=>{if(2!==d||!h.isSome(k)||0!==k.drapeSourceType){var K=h.isSome(k)&&h.isSome(k.fullOpacity)&&1>k.fullOpacity&&0===a;K&&(this.bindTemporaryFramebuffer(this._rctx,f,g),l.clearSafe(16384));
for(let B=0;B<c.numViews;B++)this.setViewParameters(c.views[B],p),A.draw(this._renderContext,this._bindParameters);K&&h.isSome(this._temporaryRenderTarget)&&(b.bind(l),this._compositingHelper.composite(this._temporaryRenderTarget.getTexture(),2,h.unwrap(h.unwrap(k).fullOpacity)))}});l.bindFramebuffer(null);b.generateMipMap();this._renderContext.resetRenderOccludedMask();return!0};e.bindTemporaryFramebuffer=function(a,b,c){h.isNone(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new Z.OverlayRenderTarget(a,
!1));this._temporaryRenderTarget.resize(b,c);this._temporaryRenderTarget.bind(a)};e.reloadShaders=async function(){await this._shaderTechniqueRepository.hotReload()};e.intersect=function(a,b,c){let d=0;this._geometries.forEach(f=>{if(!c||c(f)){this.intersectRenderGeometry(f,b,0,a,d);var g=this.longitudeCyclical;g&&(f.boundingSphere[0]-f.boundingSphere[3]<g.min&&this.intersectRenderGeometry(f,b,g.range,a,d),f.boundingSphere[0]+f.boundingSphere[3]>g.max&&this.intersectRenderGeometry(f,b,-g.range,a,
d));d++}})};e.intersectRenderGeometry=function(a,b,c,d,f){if(a.instanceParameters.visible){var g=0;h.isSome(a.transformation)&&(c+=a.transformation[12],g=a.transformation[13]);w[0]=b[0]-c;w[1]=b[1]-g;w[2]=1;x[0]=b[0]-c;x[1]=b[1]-g;x[2]=0;a.screenToWorldRatio=this._screenToWorldRatio;a.material.intersect(a,null,a.getShaderTransformation(),d,w,x,(l,k,A)=>{this.addIntersectionResult(A,a.material.renderPriority,f,d,a.layerUid,a.graphicUid)},a.calculateShaderTransformation,!0)}};e.addIntersectionResult=
function(a,b,c,d,f,g){const l={type:"external",metadata:{layerUid:f,graphicUid:g}};f=k=>{k.set(l,null,d.results.ground.dist,d.results.ground.normal,d.results.ground.transformation,b,null,null,a,c);k.intersector="OverlayRenderer"};(null==d.results.min.drapedLayerOrder||b>=d.results.min.drapedLayerOrder)&&(null==d.results.min.dist||d.results.ground.dist<=d.results.min.dist)&&f(d.results.min);0!==d.options.store&&(null==d.results.max.drapedLayerOrder||b<d.results.max.drapedLayerOrder)&&(null==d.results.max.dist||
d.results.ground.dist>d.results.max.dist)&&f(d.results.max);2===d.options.store&&(g=new X.IntersectorResult(d.ray),f(g),d.results.all.push(g))};e.stopAnimationsAtTime=function(a){this._sortedLayerRenderers.forAll(b=>b.renderer.stopAnimationsAtTime(a))};e.ensureLayerRenderer=function(a){let b=this._layerRenderers.get(a);b||(b=new fa.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(a,b),this._sortedLayerRenderersDirty=!0,"fullOpacity"in
a&&this._handles.add(a.watch("fullOpacity",()=>this.emitContentChanged()),a),this._handles.add(D.init(b,"updating",()=>this.notifyChange("updating")),a));return b};e.updateSortedLayerRenderers=function(){if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var [{view:{allLayerViews:a}}]=this._layerRenderers.keys(),b=new Set(this._layerRenderers.values());a.forEach(c=>{const d=this._layerRenderers.get(c);d&&(this._sortedLayerRenderers.push(new L(c,
d)),b.delete(d))});b.forEach(c=>{this._sortedLayerRenderers.push(new L(null,c))})}};e.setViewParameters=function(a,b){b.viewport=a.viewport;const c=a.extent;z.ortho(b.projectionMatrix,0,c[2]-c[0],0,c[3]-c[1],b.near,b.far);z.identity(b.viewMatrix);z.translate(b.viewMatrix,b.viewMatrix,[-a.extent[0],-a.extent[1],0]);b.setGLViewport(this._rctx);this._renderContext.camera=b;this._bindParameters.camera=b;this._bindParameters.inverseViewport[0]=1/b.fullViewport[2];this._bindParameters.inverseViewport[1]=
1/b.fullViewport[3]};e.hasNonZeroSizedView=function(a){for(let b=0;b<a.numViews;b++){const c=a.views[b];if(c.extent[0]!==c.extent[2]&&c.extent[1]!==c.extent[3])return!0}return!1};e.emitContentChanged=function(){if(this.onContentChanged)this.onContentChanged()};e.updateHasWater=function(){const a=t.someMap(this._layerRenderers,b=>b.hasWater);a!==this._hasWater&&(this._hasWater=a)};e.updateHasHighlights=function(){const a=t.someMap(this._layerRenderers,b=>b.hasHighlights);if(a!==this._hasHighlights&&
(this._hasHighlights=a,this.onHasHighlightsChanged))this.onHasHighlightsChanged(this._hasHighlights)};e.updateRendersOccluded=function(){const a=t.someMap(this._layerRenderers,b=>b.rendersOccluded);if(a!==this._rendersOccluded&&(this._rendersOccluded=a,this.onRendersOccludedChanged))this.onRendersOccludedChanged(this.rendersOccluded)};e.drawDebugTexture=function(a,b,c){const d=this._rctx;this.ensureDebugPatternResources(a,b);a=this._debugTextureTechnique.program;d.bindProgram(a);d.setPipelineState(this._debugTextureTechnique.pipeline);
a.setUniform4f("color",c[0],c[1],c[2],1);a.setUniform1i("tex",0);d.bindTexture(this._debugPatternTexture,0);d.bindVAO(this._quadVAO);d.drawArrays(5,0,V.vertexCount(this._quadVAO,"geometry"))};e.ensureDebugPatternResources=function(a,b){if(!this._debugPatternTexture){var c=new Uint8Array(a*b*4),d=0;for(let f=0;f<b;f++)for(let g=0;g<a;g++){const l=Math.floor(g/10),k=Math.floor(f/10);2>l||2>k||10*l>a-20||10*k>b-20?(c[d++]=255,c[d++]=255,c[d++]=255,c[d++]=255):(c[d++]=255,c[d++]=255,c[d++]=255,l&1&&k&
1?c[d++]=g&1^f&1?0:255:c[d++]=l&1^k&1?0:128)}this._debugPatternTexture=new U(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:a,height:b},c);a=new H.TextureTechniqueConfiguration;a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(H.TextureTechnique,a,this._debugTextureTechnique);this._quadVAO=E.createQuadVAO(this._rctx)}};C._createClass(q,[{key:"updating",get:function(){return this._sortedLayerRenderersDirty||t.someMap(this._layerRenderers,
a=>a.updating)||this.waterTextureRepository.updating}},{key:"hasOverlays",get:function(){return h.isSome(this._overlays)}},{key:"gpuMemoryUsage",get:function(){return h.isSome(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}},{key:"overlays",get:function(){return this._overlays}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},
{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]);return q}(u.AutoDisposableMixin(P));n.__decorate([u.autoDispose()],m.OverlayRenderer.prototype,"_shaderTechniqueRepository",void 0);n.__decorate([u.autoDispose()],m.OverlayRenderer.prototype,"_stippleTextureRepository",void 0);n.__decorate([r.property(),u.autoDispose()],m.OverlayRenderer.prototype,"waterTextureRepository",void 0);n.__decorate([r.property({constructOnly:!0})],m.OverlayRenderer.prototype,"renderView",void 0);
n.__decorate([r.property({constructOnly:!0})],m.OverlayRenderer.prototype,"scheduler",void 0);n.__decorate([r.property()],m.OverlayRenderer.prototype,"globalUnitScale",void 0);n.__decorate([r.property({type:Boolean,readOnly:!0})],m.OverlayRenderer.prototype,"updating",null);m.OverlayRenderer=n.__decorate([N.subclass("esri.views.3d.terrain.OverlayRenderer")],m.OverlayRenderer);let L=function(v,q){this.layerView=v;this.renderer=q};const J=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],p=new Y;p.near=1;p.far=1E4;p.relativeElevation=
null;const w=y.create(),x=y.create();m.DRAPED_Z=-2;m.overlayRenderOccludedFlag=4;Object.defineProperty(m,"__esModule",{value:!0})});