// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/mathUtils ../../../chunks/vec2f64 ../../../chunks/vec4f64 ../../../chunks/vec2 ../../../layers/support/layerUtils ../../webgl/Program ../../webgl/BufferObject ../../webgl/Texture ../../webgl/Util ../../webgl/VertexArrayObject ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/Renderbuffer ../../webgl/FramebufferObject ../../webgl/ProgramCache ../../webgl/RenderingContext ../../webgl/ShaderCompiler ../support/StreamDataLoader ../../webgl/rasterUtils ./TileTexture ./terrainUtils ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./RasterColorizerTechnique ./support/FBOPool".split(" "),
function(D,I,m,J,E,K,F,L,G,S,y,M,T,N,w,U,V,W,X,Y,O,P,u,v,Q,z,H,R){function A(q,h,a){a.layerIndex=h;const b=q.layerInfo[1][h];return b.data?(F.set(a.offset,0,0),a.tile=q,a.scale=1,a.sourceLod=q.lij,a.sourceLayerInfo=b,a):(q=b.upsampleInfo)?(h=q.tile.layerInfo[1][h],a.tile=q.tile,F.copy(a.offset,q.offset),a.scale=q.scale,a.sourceLod=q.tile.lij,a.sourceLayerInfo=h,a):null}G=function(){function q(a,b,c){this._rctx=a;this.tileSize=b;this._backgroundIsGrid=!1;this._blackTex=this._backgroundColor=this._backgroundTexture=
null;this._vectorTileHelper=new Q.VectorTileRendererHelper3D;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy);this._vaoQuad=w.createQuadVAO(this._rctx,N.Pos2Tex);a=new z.BlendLayersTechniqueConfiguration;a.mode=2;this._blendLayersTechnique=c.acquire(z.BlendLayersTechnique,a);a.mode=1;this._applyOpacityTechnique=c.acquire(z.BlendLayersTechnique,a);this._techniqueRep=c;this._blackTex=new u(w.createColorTexture(this._rctx,[0,0,0,1]));this._fboPool=
new R.FBOPool(this._rctx)}var h=q.prototype;h.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null);this._vaoQuad=m.disposeMaybe(this._vaoQuad);this._backgroundTexture=m.releaseMaybe(this._backgroundTexture);this._blackTex=m.releaseMaybe(this._blackTex);this._blendLayersTechnique=m.disposeMaybe(this._blendLayersTechnique);this._applyOpacityTechnique=m.disposeMaybe(this._applyOpacityTechnique);this._vectorTileHelper=m.disposeMaybe(this._vectorTileHelper)};h.updateTileTexture=
function(a){var b=a.layerInfo[1];for(var c of b)c.pendingUpdates&=-65;if(a.renderData){var d=a.surface,e=d.baseOpacity,g=0;c=0;for(var f=this.tileSize,n=!1,k=d.view.pixelRatio,r=b.length,l=0;l<b.length&&!n;l++){const t=d.layerViewByIndex(l,1),p=t.fullOpacity;B[l]=p;L.isBaseLayer(t.layer)&&r>=b.length&&(r=l);if(0===p)continue;++c;const x=A(a,l,C);x&&(v.isVectorTileLayerView(t)?f=Math.max(f,this.tileSize*k):1===e&&1===p&&(t.isOpaque||this._dataToTexture(x)&&m.isSome(x.sourceLayerInfo.data)&&x.sourceLayerInfo.data.descriptor.isOpaque)&&
(n=!0),++g)}this._cleanupFBOPool(k,b.length);e=f;f=J.nextHighestPowerOfTwo(e);b=f*f;d=e*e;b===d?f=e:(e=f/2,f=b-d<d-e*e?f:e);b=f/this.tileSize;--l;if(0===g){g=0;if(a.surface.view.layerViewManager.updating||0<c)g=5E3;this._backgroundTexture&&m.isNone(a.renderData.textureReference)&&(g=0);this._useBackgroundTexture(a,g)}else 1===g&&(n||this._backgroundIsGrid||m.isSome(this._backgroundColor))&&this._useLayerTexture(a,l,r,B[l])||this._composeMapLayers(a,l,r,n,B,f,b)}};h.setBackground=function(a,b){m.releaseMaybe(this._backgroundTexture);
this._backgroundIsGrid=b;a instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(a),this._backgroundColor=null):(this._backgroundTexture=new u(w.createColorTexture(this._rctx,a)),this._backgroundColor=K.fromValues(a[0]||0,a[1]||0,a[2]||0,a[3]||0))};h._buildTexture=function(a){if(m.isNone(a))return null;const b={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},c=this._rctx;let d;if("number"===typeof a)b.width=
b.height=a,d=new u(new y(c,b));else if(a instanceof O.ImageWithType)b.isOpaque=a.isOpaque,d=new u(new y(c,b,a.image)),a.release();else try{d=new u(new y(c,b,a))}catch(e){d=new u(w.createEmptyTexture(c)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}c.bindTexture(d.texture,0);d.generateMipmap();return d};h._drawQuad=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(5,0,
M.vertexCount(this._vaoQuad,"geometry"))};h._drawRasterData=function(a,b,c,d,e=1){if(!m.isNone(b)){var g=this._rctx,f=a.program;g.setPipelineState(a.pipeline);g.bindProgram(f);g.bindTexture(b,0);f.setUniform1i("tex",0);f.setUniform1f("scale",c);f.setUniform2f("offset",d[0],d[1]);f.setUniform1f("opacity",e);this._drawQuad(f)}};h._drawImageryTileData=function(a,b=1){const c=a.sourceLayerInfo.data;if(!m.isNone(c)&&c.source){a.tile.surface.layerViewByIndex(a.layerIndex,1).ensureSymbolizerParameters(c);
var d=this._getRasterColorizerTechnique(c.symbolizerParameters.type,!!c.symbolizerParameters.colormap),e=this._rctx,g=d.program;e.setPipelineState(d.pipeline);e.bindProgram(g);if(c.bind(e)){c.opacity=b;c.scale=a.scale;c.offset=a.offset;var {names:f,textures:n}=c.getTextures();P.setTextures(e,g,f,n);a=c.getUniforms();d.bindPass(e,a);this._drawQuad(g);e.bindVAO()}}};h._getRasterColorizerTechnique=function(a,b){a=["stretch","lut","hillshade"].indexOf(a);this._rasterColorizerConfig||(this._rasterColorizerConfig=
new H.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.colorizerType=a;this._rasterColorizerConfig.applyColormap=b;return this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(H.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique)};h._drawVectorData=function(a,b,c,d,e,g,f){const n=b.sourceLayerInfo.data;if(m.isNone(n))return f;
const k=this._rctx,r=b.tile.surface.layerViewByIndex(b.layerIndex,1);let l;k.setPipelineState(a.pipeline);const t=1>d;t?(l=this._fboPool.acquire(e),k.bindFramebuffer(l),k.setClearColor(1,1,1,0),k.clearSafe(16640)):f&&k.clearSafe(256);this._vectorTileHelper.render(k,b.sourceLod,n,r.painter,r.layer.styleRepository,r.schemaHelper,Math.round(1/b.scale),b.offset,this.tileSize,c);return t?(k.bindFramebuffer(g),this._drawRasterData(a,l.colorTexture,1,[0,0],d),this._fboPool.release(l),f):!0};h._useBackgroundTexture=
function(a,b){a.renderData.opacity=a.surface.baseOpacity;a.renderData.compositeBackgroundInShader=!1;a.renderData.layerOpacity=1;a.renderData.baseOpacity=1;a.renderData.setTextureReference(this._backgroundTexture,0,0,1,b)};h._useLayerTexture=function(a,b,c,d){c=b<c;a.renderData.opacity=c?1:a.surface.baseOpacity;a.renderData.compositeBackgroundInShader=!0;a.renderData.layerOpacity=d;a.renderData.baseOpacity=c?a.surface.baseOpacity:1;b=A(a,b,C);return this._dataToTexture(b)?(d=b.offset,a.renderData.setTextureReference(b.sourceLayerInfo.data,
d[0],d[1],b.scale),!0):!1};h._composeMapLayers=function(a,b,c,d,e,g,f){const n=a.renderData.ensureTexture(g,()=>this._buildTexture(g));if(!m.isNone(n)){var k=this._rctx,r=this._fboPool.acquire(g);k.bindFramebuffer(r);k.setViewport(0,0,g,g);k.setClearColor(0,0,0,0);k.setClearDepth(1);k.clearSafe(16640);var l=!1;!d&&m.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,E.ZEROS);d=a.surface.baseOpacity;for(var t=!1;0<=b;b--){const p=A(a,
b,C);p&&(b<c&&1>d&&!t&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,E.ZEROS,d),t=!0),0!==e[b]&&(v.isVectorTileRenderInfo(p)?l=this._drawVectorData(this._blendLayersTechnique,p,f,e[b],g,r,l):v.isImageryTileRenderInfo(p)?this._drawImageryTileData(p,e[b]):this._dataToTexture(p)&&m.isSome(p.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,p.sourceLayerInfo.data.texture,p.scale,p.offset,e[b])))}k.bindTexture(n.texture,0);c=n.descriptor;k.gl.copyTexImage2D(k.gl.TEXTURE_2D,
0,c.pixelFormat,0,0,c.width,c.height,0);n.generateMipmap();k.bindFramebuffer(null);this._fboPool.release(r);a.renderData.opacity=t?1:d;a.renderData.compositeBackgroundInShader=!1;a.renderData.layerOpacity=1;a.renderData.baseOpacity=1;a.renderData.setTextureReference(n,0,0,1)}};h._dataToTexture=function(a){v.isRasterTileRenderInfo(a)&&this._rasterDataToTexture(a);return v.isTextureTileRenderInfo(a)};h._rasterDataToTexture=function(a){const b=a.sourceLayerInfo;b.data=this._buildTexture(b.data);a.tile.setMemoryDirty()};
h._cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPool.clear(),this._lastPixelRatio=a,this._lastNumLayers=b};I._createClass(q,[{key:"backgroundIsGrid",get:function(){return this._backgroundIsGrid}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);return q}();const B=[],C={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};D.TileRenderer=
G;Object.defineProperty(D,"__esModule",{value:!0})});