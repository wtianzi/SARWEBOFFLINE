// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/Accessor ../../../geometry/support/spatialReferenceUtils ../../../core/Handles ../../../geometry/projection ../../../layers/support/layerUtils ./TilingScheme ./terrainUtils".split(" "),
function(q,d,b,w,x,f,y,r,z,A,B,t,m,u,n,v,h,k){b=function(p){function l(a){a=p.call(this,a)||this;a._changeHandles=new u;return a}q._inheritsLoose(l,p);var g=l.prototype;g.initialize=function(){this._changeHandles.add(this.layers.on("change",()=>this._update()));this._changeHandles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme()));this._update();this.tilingSchemeLocked||this._setAdHocTilingScheme()};g.destroy=function(){this._changeHandles.destroy();this._waitTask=this._changeHandles=
null};g._update=function(){this._waitTask=null;if(!this.tilingSchemeLocked){this._set("tilingSchemeDone",!1);var a;this.layers.some(e=>!v.isTiledLayer(e)||e.isRejected()?!1:!e.isFulfilled()||k.getTiledLayerInfo(e,this.viewSpatialReference,this.manifold).tileInfo?(a=e,"vector-tile"!==e.type&&!k.isProjectableRasterLayer(e)):!1);if(a)if(a.isResolved()){var {tileInfo:c}=k.getTiledLayerInfo(a,this.viewSpatialReference,this.manifold);c=new h(c);this._set("tilingSchemeDone",!0);this._lockTilingScheme(c)}else this._updateWhen(a);
else this._set("tilingSchemeDone",!0)}};g._updateWhen=function(a){const c=a.when().catch(e=>e).then(()=>{c!==this._waitTask||this.destroyed||this._update()});this._waitTask=c};g._lockTilingScheme=function(a){if("spherical"===this.manifold){const c=a.levels.length-1;a.spatialReference.isWebMercator?a=h.makeWebMercatorAuxiliarySphere(c):n.canProjectToWGS84ComparableLonLat(a.spatialReference)&&(a=h.makeGCSWithTileSize(a.spatialReference,a.pixelSize,c))}this.tilingSchemeLocked=!0;this.tilingScheme=a;
this.extentHelper.tilingScheme=this.tilingScheme;this._updateTiledLayerExtent();this._changeHandles.removeAll();this._changeHandles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))};g._updateTiledLayerExtent=function(){this.extent=this.extentHelper.tiledLayersExtent};g._setAdHocTilingScheme=function(){if("spherical"===this.manifold){var a=this.extentHelper.spatialReference;const c=n.canProjectToWGS84ComparableLonLat(a)||m.isMars(a)||m.isMoon(a);a.isWebMercator?
this.tilingScheme=h.WebMercatorAuxiliarySphere:c&&(this.tilingScheme=h.makeGCSWithTileSize(a,256));this.extent=this.extentHelper.layerViewsExtent}else if(a=this.extentHelper.layerViewsExtent)this.tilingScheme=h.fromExtent(a,this.extentHelper.spatialReference),this.extent=a};return l}(t);d.__decorate([f.property()],b.prototype,"tilingScheme",void 0);d.__decorate([f.property()],b.prototype,"extent",void 0);d.__decorate([f.property({value:!1})],b.prototype,"tilingSchemeLocked",void 0);d.__decorate([f.property({readOnly:!0,
value:!1})],b.prototype,"tilingSchemeDone",void 0);d.__decorate([f.property({constructOnly:!0})],b.prototype,"viewSpatialReference",void 0);d.__decorate([f.property({constructOnly:!0})],b.prototype,"layers",void 0);d.__decorate([f.property({constructOnly:!0})],b.prototype,"extentHelper",void 0);d.__decorate([f.property({constructOnly:!0})],b.prototype,"manifold",void 0);return b=d.__decorate([r.subclass("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],b)});