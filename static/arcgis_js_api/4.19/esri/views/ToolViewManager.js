// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../core/Accessor ../core/Collection ../core/Handles ../core/watchUtils ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/ToolViewManagerManipulatorState".split(" "),
function(q,k,g,f,v,C,l,D,w,E,F,G,m,p,x,y,r,z,A,h,B){const t=v.getLogger("esri.views.ToolViewManager");g=function(u){function n(a){var b=u.call(this,a)||this;b._handles=new y;b._creatingTool=null;b._manipulatorState=new B;b.tools=h.newToolCollection();b.cursor=null;b._forEachTool=d=>{if(!f.isSome(b._creatingTool)||!d(b._creatingTool))for(const c of b.tools.items)if(d(c))break};return b}q._inheritsLoose(n,u);var e=n.prototype;e.initialize=function(){this._handles.add([this.view.on(A.eventTypes,a=>{this._handleInputEvent(a)},
z.ViewEventPriorities.TOOL),this.tools.on("before-add",a=>{const b=a.item;null==b||this.tools.includes(b)?a.preventDefault():null==b.created||b.created||(t.error("tools","Tool can not be added to view before it has been created"),a.preventDefault())}),this.tools.on("before-remove",({item:a})=>{this._manipulatorState.clearPointers(a,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])};e.destroy=function(){this._forEachTool(a=>a.destroy());this._handles.destroy();this._handles=
null};e.createTool=async function(a,b,d){await this.view.whenReady();if(m.isAborted(d))throw m.createAbortError("Tool creation was interrupted by another tool being created");b=h.evaluateToolConstructorArguments(b);const c=new a({...b,view:this.view});a=m.onAbort(d,()=>this.activeTool=null);this._rejectCreatingTool("Tool creation was interrupted by another tool being created");this._creatingTool=c;c.attach();this._refreshToolWatchers();h.setActive(c,!0);await c.when();f.isSome(a)&&a.remove();this._creatingTool=
null;this.tools.add(c);c instanceof p&&null!=c.completed&&r.whenOnce(c,"completed").then(()=>{h.setActive(c,!1)});return c};e.attach=function(){this._forEachTool(a=>a.attach());"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",()=>{this.forEachManipulator(a=>{if(null!=a.onViewChange)a.onViewChange()})}),this.view.elevationProvider.on("elevation-change",a=>{this.forEachManipulator(b=>{if(null!=b.onElevationChange)b.onElevationChange(a)})})],"manipulators"):this._handles.add(this.view.watch("extent",
()=>{this.forEachManipulator(a=>{if(null!=a.onViewChange)a.onViewChange()})}))};e.detach=function(){this.activeTool=null;this._forEachTool(a=>{a.detach();a.destroy()});this.tools.removeAll();this._handles.remove("manipulators")};e.forEachManipulator=function(a){this._forEachTool(b=>{b.manipulators&&b.manipulators.forEach(({manipulator:d})=>a(d,b))})};e._handleInputEvent=function(a){let b=!1;const d={...a,stopPropagation:()=>{b=!0;a.stopPropagation()}};f.isSome(this.activeTool)?this.activeTool.handleInputEvent&&
this.activeTool.handleInputEvent(d):this._forEachTool(c=>{!b&&!1!==c.visible&&c.handleInputEvent&&c.handleInputEvent(d)});!b&&"key-down"===a.type&&"Escape"===a.key&&this.activeTool&&(a.stopPropagation(),this.activeTool=null);this._manipulatorState.handleInputEvent(d,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:c=>{this.activeTool=c},creatingTool:this._creatingTool,view:this.view});!b&&f.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(d);
this._manipulatorState.handleHoverEvent(d,this._forEachTool);this._updateCursor()};e._refreshToolWatchers=function(){this._handles.remove("tools");this._forEachTool(a=>{if(a instanceof p){const b=r.watch(a,["cursor","visible","editable"],()=>{h.areToolManipulatorsEditable(a)||this._manipulatorState.clearPointers(a,this._forEachTool);this._updateCursor()});this._handles.add(b,"tools")}a.manipulators&&this._handles.add(a.manipulators.on("change",b=>{b.removed.forEach(({id:d})=>{this._manipulatorState.clearPointers(a,
this._forEachTool,!0,d)});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()}),"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()};e._updateCursor=function(){let a=null;this._forEachTool(b=>null!=b.cursor&&!1!==b.visible?(a=b.cursor,!0):!1);a||(a=this._manipulatorState.cursor);this._get("cursor")!==a&&this._set("cursor",a)};e._rejectCreatingTool=function(a){const b=this._creatingTool;f.isNone(b)||
(this._manipulatorState.clearPointers(b,this._forEachTool),b.rejectCreation&&b.rejectCreation(m.createAbortError(a)),b.destroy(),this._creatingTool=null,this._refreshToolWatchers())};e._removeIncompleteTools=function(a){this.tools.filter(b=>(f.isNone(a)||b!==a)&&null!=b.completed&&!b.completed).forEach(b=>{this.tools.remove(b)})};q._createClass(n,[{key:"activeTool",set:function(a){f.isSome(a)&&!this.view.ready?t.error("#activeTool\x3d","cannot set active tool while view is not ready"):(h.swap(this,
a,b=>{this._set("activeTool",b);this._removeIncompleteTools(a);this._forEachTool(d=>{var c=f.isNone(this.activeTool)||d===this.activeTool;d.setEditableFlag&&d.setEditableFlag(1,c);c=h.areToolManipulatorsEditable(d);!f.isNone(this.activeTool)&&c||this._manipulatorState.clearPointers(d,this._forEachTool,!c)});this._updateCursor()}),this._creatingTool!==a&&this._rejectCreatingTool())}}]);return n}(p);k.__decorate([l.property({constructOnly:!0,nonNullable:!0})],g.prototype,"view",void 0);k.__decorate([l.property({value:null})],
g.prototype,"activeTool",null);k.__decorate([l.property({readOnly:!0,type:x})],g.prototype,"tools",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"cursor",void 0);return g=k.__decorate([w.subclass("esri.views.ToolViewManager")],g)});