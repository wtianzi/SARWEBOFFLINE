// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/arrayUtils ../core/promiseUtils".split(" "),function(n,q,r,x,h,y,z,A,B,t,C,D,E,u,v){n.PopupView=k=>{k=function(p){function l(){return p.apply(this,arguments)||this}q._inheritsLoose(l,
p);var g=l.prototype;g.fetchPopupFeatures=async function(a,b){await this.when();const {location:d,queryArea:e,layerViewsAndGraphics:c,clientOnlyGraphics:f}=await this._prepareFetchPopupFeatures(a,b);a=Promise.resolve(f);b=this._queryLayerPopupFeatures({queryArea:e,layerViewsAndGraphics:c,options:b});const m=b.map(w=>w.promise);a=v.eachAlwaysValues([a,...m]).then(u.flatten);return{location:d,clientOnlyGraphics:f,allGraphicsPromise:a,promisesPerLayerView:b}};g._queryLayerPopupFeatures=function({queryArea:a,
layerViewsAndGraphics:b,options:d}){return b.map(({layerView:e,graphics:c})=>{c={clientGraphics:c,event:h.isSome(d)?d.event:null,signal:h.isSome(d)?d.signal:null,defaultPopupTemplateEnabled:h.isSome(d)?!!d.defaultPopupTemplateEnabled:!1};c=e.fetchPopupFeatures(a,c);return{layerView:e,promise:c}})};g._isValidPopupGraphic=function(a,b){return a&&!!a.getEffectivePopupTemplate(h.isSome(b)&&b.defaultPopupTemplateEnabled)};g._prepareFetchPopupFeatures=async function(a,b){const {clientGraphics:d,queryArea:e,
location:c}=await this._popupHitTestGraphics(a,b);a=this._getFetchPopupLayerViews();const {layerViewsAndGraphics:f,clientOnlyGraphics:m}=this._graphicsPerFetchPopupLayerView(d,a);return{clientOnlyGraphics:m,layerViewsAndGraphics:f,queryArea:e,location:c}};g._popupHitTestGraphics=async function(a,b){const {results:d,mapPoint:e}=await this.popupHitTest(a);a=d.filter(f=>this._isValidPopupGraphic(f.graphic,b));const c=a.length?a[0].mapPoint:null;return{clientGraphics:a.map(f=>f.graphic),queryArea:e,location:e||
c}};g._getFetchPopupLayerViews=function(){const a=[];this.allLayerViews.forEach(b=>{this._isValidPopupLayerView(b)&&a.push(b)});h.isSome(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&a.push(this.graphicsView);return a.reverse()};g._isValidPopupLayerView=function(a){return h.isSome(a)&&(!("layer"in a)||!a.suspended)&&"fetchPopupFeatures"in a};g._graphicsPerFetchPopupLayerView=function(a,b){const d=[],e=new Map;b=b.map(c=>{const f=[];"layer"in c?e.set(c.layer,f):e.set(c.graphics,
f);return{layerView:c,graphics:f}});for(const c of a)(a=e.get(c.layer)||null)?a.push(c):d.push(c);return{layerViewsAndGraphics:b,clientOnlyGraphics:d}};return l}(k);return k=r.__decorate([t.subclass("esri.views.PopupView")],k)};Object.defineProperty(n,"__esModule",{value:!0})});