// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../support/arcadeOnDemand ../../layers/support/fieldUtils ../../core/watchUtils ../../layers/support/commonProperties ../../tasks/support/Query ./support/FeatureFilter ./support/FeatureEffect ./support/popupUtils".split(" "),
function(u,x,h,v,m,C,K,k,L,D,y,M,N,O,E,F,f,z,G,H,I,J,r){const A=C.getLogger("esri.views.layers.FeatureLayerView");v=e=>{e=function(w){function t(...a){a=w.call(this,...a)||this;a._updatingRequiredFieldsPromise=null;a.effect=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}x._inheritsLoose(t,w);var g=t.prototype;g.initialize=function(){z.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo layer.floorInfo timeExtent".split(" "),
()=>this._handleRequiredFieldsChange(),!0);z.on(this,"view.floors","change",()=>this._handleRequiredFieldsChange())};g.highlight=function(a){throw Error("missing implementation");};g.createQuery=function(){var a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=m.isSome(this.filter)?this.filter.createQuery(a):new H(a);m.isSome(this.timeExtent)&&(a.timeExtent=m.isSome(a.timeExtent)?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};g.queryFeatures=
function(a,b){throw Error("missing implementation");};g.queryObjectIds=function(a,b){throw Error("missing implementation");};g.queryFeatureCount=function(a,b){throw Error("missing implementation");};g.queryExtent=function(a,b){throw Error("missing implementation");};g._loadArcadeModules=function(a){if(a.get("expressionInfos.length"))return F.loadArcade()};g._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===
a&&this._set("_updatingRequiredFieldsPromise",null)})};g._updateRequiredFields=async function(){if(this.layer&&this.view){var a="3d"===this.view.type,{layer:b,layer:{fields:c,objectIdField:l,renderer:p,displayField:q}}=this,n=b.featureReduction,d=new Set;n=await E.eachAlways([p?p.collectRequiredFields(d,c):null,f.collectLabelingFields(d,b),a?f.collectElevationFields(d,b):null,m.isSome(this.filter)?f.collectFilterFields(d,b,this.filter):null,this.effect?f.collectFilterFields(d,b,this.effect.filter):
null,n?f.collectFeatureReductionFields(d,b,n):null]);b.timeInfo&&this.timeExtent&&f.collectFields(d,b.fields,[b.timeInfo.startField,b.timeInfo.endField]);"feature"===b.type&&b.floorInfo&&f.collectFields(d,b.fields,[b.floorInfo.floorField]);for(const B of n)B.error&&A.error(B.error);f.collectField(d,c,l);a&&q&&f.collectField(d,c,q);a=Array.from(d).sort();this._set("requiredFields",a)}};g.validateFetchPopupFeatures=function(a){const {layer:b,layer:{popupEnabled:c}}=this;if(!c)return new y("featurelayerview:fetchPopupFeatures",
"Popups are disabled",{layer:b});if(!r.getFetchPopupTemplate(this.layer,a))return new y("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:b})};g.fetchClientPopupFeatures=async function(a){const b=m.isSome(a)?a.clientGraphics:null;if(!b||0===b.length)return Promise.resolve([]);const c=[],l=[],{layer:p}=this;var q=r.getFetchPopupTemplate(p,a);if(!m.isSome(q))return Promise.resolve([]);var n=await this._loadArcadeModules(q);q=n&&n.arcadeUtils.hasGeometryOperations(q);
a=await this.createPopupQuery(a);n=f.unpackFieldNames(p.fields,a.outFields);for(const d of b)q||!f.featureHasFields(n,d)?l.push(d):c.push(d);if("stream"===p.type||0===l.length)return Promise.resolve(c);a.objectIds=l.map(d=>d.attributes[p.objectIdField]);return p.queryFeatures(a).then(d=>c.concat(d.features)).catch(()=>l)};g.createPopupQuery=async function(a){var b=this.layer;const c=b.createQuery();a=r.getFetchPopupTemplate(b,a);var l=m.isSome(a)&&await this._loadArcadeModules(a);l=m.isSome(a)&&l&&
l.arcadeUtils.hasGeometryOperations(a);b=!("point"!==b.geometryType&&!l);c.returnGeometry=b;c.returnZ=b;c.returnM=b;c.outFields=await r.getRequiredFields(this.layer,a);c.outSpatialReference=this.view.spatialReference;return c};g.canResume=function(){return!w.prototype.canResume.call(this)||m.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};x._createClass(t,[{key:"availableFields",get:function(){const {layer:a,layer:{fields:b},requiredFields:c}=this;return"outFields"in a&&a.outFields?f.fixFields(b,
[...f.unpackFieldNames(b,a.outFields),...c]):f.fixFields(b,c)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){A.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return t}(e);h.__decorate([k.property()],e.prototype,"_updatingRequiredFieldsPromise",void 0);h.__decorate([k.property({readOnly:!0})],e.prototype,"availableFields",null);h.__decorate([k.property({type:J})],
e.prototype,"effect",void 0);h.__decorate([k.property({type:I})],e.prototype,"filter",void 0);h.__decorate([k.property(G.combinedViewLayerTimeExtentProperty)],e.prototype,"timeExtent",void 0);h.__decorate([k.property()],e.prototype,"layer",void 0);h.__decorate([k.property({type:Number})],e.prototype,"maximumNumberOfFeatures",null);h.__decorate([k.property({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null);h.__decorate([k.property({readOnly:!0})],e.prototype,"requiredFields",
void 0);h.__decorate([k.property()],e.prototype,"suspended",void 0);h.__decorate([k.property()],e.prototype,"view",void 0);return e=h.__decorate([D.subclass("esri.views.layers.FeatureLayerView")],e)};u.FeatureLayerView=v;u.default=v;Object.defineProperty(u,"__esModule",{value:!0})});