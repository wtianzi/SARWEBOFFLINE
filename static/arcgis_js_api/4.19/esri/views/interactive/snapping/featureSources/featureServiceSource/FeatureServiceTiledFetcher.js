// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/handleUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/urlUtils ../../../../../core/uuid ../../../../../portal/support/resourceExtension ../../../../../core/arrayUtils ../../../../../core/promiseUtils ../../../../../geometry/Extent ../../../../../geometry/support/aaBoundingRect ../../../../../layers/graphics/featureConversionUtils ../../../../../tasks/support/Query ../../../../../rest/query/operations/pbfOptimizedFeatureSet ../../../../../rest/query/operations/query ../../../../../core/AsyncSequence ../../../../../core/HandleOwner ./PendingFeatureTile".split(" "),
function(e,x,g,M,k,A,N,B,h,O,C,P,Q,R,D,u,E,F,y,v,G,w,H,I,J){const K=A.getLogger("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher");e.FeatureServiceTiledFetcher=function(z){function t(a){a=z.call(this,a)||this;a.tilesOfInterest=[];a.availability=0;a.pendingTiles=new Map;a.pendingEdits=new H.AsyncSequence;a.pendingEditsAbortController=u.createAbortController();return a}x._inheritsLoose(t,z);var d=t.prototype;d.initialize=function(){this.initializeFetchExtent();
this.updatingHandles.add(this,"configuration",()=>this.refresh());this.updatingHandles.add(this,"tilesOfInterest",(a,b)=>{D.equals(a,b,({id:c},{id:f})=>c===f)||this.process()},1)};d.destroy=function(){this.pendingTiles.forEach(a=>this.deletePendingTile(a));this.pendingTiles.clear();this.store.destroy();this.tilesOfInterest.length=0;this.pendingEditsAbortController.abort();this.pendingEditsAbortController=null};d.refresh=function(){this.store.refresh();this.pendingTiles.forEach(a=>this.deletePendingTile(a));
this.process()};d.applyEdits=function(a){this.pendingEdits.push(a,async b=>{if(0!==b.addedFeatures.length||0!==b.updatedFeatures.length||0!==b.deletedFeatures.length){for(const [,c]of this.pendingTiles)c.reset();await this.updatingHandles.addPromise(this.store.processEdits(b,(c,f)=>this.queryFeaturesById(c,f),this.pendingEditsAbortController.signal));this.processPendingTiles()}})};d.initializeFetchExtent=function(){if(this.capabilities.query.supportsExtent){var a=u.createTask(async b=>{try{var c;
const f=await w.executeQueryForExtent(this.url,new v({where:"1\x3d1",outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint?!0:void 0}),{query:this.configuration.customParameters,signal:b});this.store.extent=E.fromJSON(null==(c=f.data)?void 0:c.extent)}catch(f){u.throwIfAbortError(f),K.error("Failed to fetch data extent",f)}});this.updatingHandles.addPromise(a.promise.then(()=>this.process()));this.handles.add(B.makeHandle(()=>a.abort()));this.fetchExtentTask=
a}};d.process=function(){k.isSome(this.fetchExtentTask)&&!this.fetchExtentTask.finished?this.setAvailability(0):(this.markTilesNotAlive(),this.createPendingTiles(),this.deletePendingTiles(),this.processPendingTiles())};d.markTilesNotAlive=function(){for(const [,a]of this.pendingTiles)a.alive=!1};d.createPendingTiles=function(){var a=this.collectMissingTilesInfo();this.setAvailability(k.isNone(a)?1:a.coveredArea/a.fullArea);if(!k.isNone(a))for(const {data:b,resolution:c}of a.missingTiles)(a=this.pendingTiles.get(b.id))?
(a.resolution=c,a.alive=!0):this.createPendingTile(b,c)};d.collectMissingTilesInfo=function(){let a=null;for(let b=this.tilesOfInterest.length-1;0<=b;b--){const c=this.store.process(this.tilesOfInterest[b],(f,l)=>this.verifyTileComplexity(f,l));k.isNone(a)?a=c:a.prepend(c)}return a};d.deletePendingTiles=function(){for(const [,a]of this.pendingTiles)a.alive||this.deletePendingTile(a)};d.processPendingTiles=function(){const a={fetchCount:(b,c)=>this.fetchCount(b,c),fetchFeatures:(b,c,f)=>this.fetchFeatures(b,
c,f),finish:(b,c)=>this.finishPendingTile(b,c),resume:()=>this.processPendingTiles()};if(this.ensureFetchAllCounts(a))for(const [,b]of this.pendingTiles)this.verifyTileComplexity(this.store.getFeatureCount(b.data),b.resolution)&&this.updatingHandles.addPromise(b.process(a))};d.verifyTileComplexity=function(a,b){return this.verifyVertexComplexity(a)&&this.verifyFeatureDensity(a,b)};d.verifyVertexComplexity=function(a){return 1E6>a*this.minimumVerticesPerFeature};d.verifyFeatureDensity=function(a,b){if(k.isNone(this.tileInfo))return!1;
b*=this.tileSize;return 1>25/(b*b)*a};d.ensureFetchAllCounts=function(a){let b=!0;for(const [,c]of this.pendingTiles)2>c.state.type&&this.updatingHandles.addPromise(c.process(a)),1>=c.state.type&&(b=!1);return b};d.finishPendingTile=function(a,b){this.store.add(a.data,b);this.deletePendingTile(a);this.updateAvailability()};d.updateAvailability=function(){const a=this.collectMissingTilesInfo();this.setAvailability(k.isNone(a)?1:a.coveredArea/a.fullArea)};d.setAvailability=function(a){this._set("availability",
a)};d.createPendingTile=function(a,b){b=new J.PendingFeatureTile(a,b);this.pendingTiles.set(a.id,b);return b};d.deletePendingTile=function(a){a.reset();this.pendingTiles.delete(a.data.id)};d.fetchCount=async function(a,b){return this.store.fetchCount(a.data,this.url,this.createCountQuery(a),{query:this.customParameters,timeout:6E5,signal:b})};d.fetchFeatures=async function(a,b,c){let f=0,l,p=0,n=b;for(;;){const q=this.createFeaturesQuery(a),r=this.setPagingParameters(q,f,n),{features:m,exceededTransferLimit:L}=
await this.queryFeatures(q,c);r&&(f+=k.unwrap(q.num));p+=m.length;l=l?l.concat(m):m;n=b-p;if(!r||!L||0>=n)return l}};d.filterProperties=function(a){return k.isNone(a)?{where:"1\x3d1",gdbVersion:void 0,timeExtent:void 0}:{where:a.where||"1\x3d1",timeExtent:a.timeExtent,gdbVersion:a.gdbVersion}};d.queryFeaturesById=function(a,b){const c=this.createFeaturesQuery(null);c.objectIds=a;return this.queryFeatures(c,b)};d.queryFeatures=function(a,b){return this.capabilities.query.supportsFormatPBF?this.queryFeaturesPBF(a,
b):this.queryFeaturesJSON(a,b)};d.queryFeaturesPBF=async function(a,b){const {sourceSpatialReference:c}=this;({data:a}=await w.executeQueryPBF(this.url,a,new G.OptimizedFeatureSetParserContext({sourceSpatialReference:c}),{query:this.configuration.customParameters,timeout:6E5,signal:b}));return y.unquantizeOptimizedFeatureSet(a)};d.queryFeaturesJSON=async function(a,b){const {sourceSpatialReference:c}=this;({data:a}=await w.executeQuery(this.url,a,c,{query:this.configuration.customParameters,timeout:6E5,
signal:b}));return y.convertFromFeatureSet(a,this.objectIdField)};d.createCountQuery=function(a){a=this.createBaseQuery(a);this.capabilities.query.supportsCacheHint&&(a.cacheHint=!0);return a};d.createFeaturesQuery=function(a){const b=this.createBaseQuery(a);b.outFields=[this.objectIdField];b.returnGeometry=!0;k.isSome(a)&&(this.capabilities.query.supportsResultType?b.resultType="tile":this.capabilities.query.supportsCacheHint&&(b.cacheHint=!0));return b};d.createBaseQuery=function(a){a=new v({returnZ:!1,
returnM:!1,geometry:k.isSome(this.tileInfo)&&k.isSome(a)?F.toExtent(a.data.extent,this.tileInfo.spatialReference):void 0});const b=this.configuration.filter;k.isSome(b)&&(a.where=b.where,a.gdbVersion=b.gdbVersion,a.timeExtent=b.timeExtent);a.outSpatialReference=this.spatialReference;return a};d.setPagingParameters=function(a,b,c){if(!this.capabilities.query.supportsPagination)return!1;const {supportsMaxRecordCountFactor:f,supportsCacheHint:l,tileMaxRecordCount:p,maxRecordCount:n,supportsResultType:q}=
this.capabilities.query,r=f?v.MAX_MAX_RECORD_COUNT_FACTOR:1,m=r*((q||l)&&p?p:n?n:2E3);a.start=b;f?(a.maxRecordCountFactor=Math.min(r,Math.ceil(c/m)),a.num=Math.min(c,a.maxRecordCountFactor*m)):a.num=Math.min(c,m);return!0};x._createClass(t,[{key:"minimumVerticesPerFeature",get:function(){var a;switch(null==(a=this.store)?void 0:a.featureStore.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":return 1;case "esriGeometryPolygon":return 4;case "esriGeometryPolyline":return 2}}},{key:"filter",
set:function(a){const b=this._get("filter");a=this.filterProperties(a);JSON.stringify(b)!==JSON.stringify(a)&&this._set("filter",a)}},{key:"customParameters",set:function(a){const b=this._get("customParameters");JSON.stringify(b)!==JSON.stringify(a)&&this._set("customParameters",a)}},{key:"configuration",get:function(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}},{key:"tileInfo",set:function(a){const b=this._get("tileInfo");b===
a||k.isSome(a)&&k.isSome(b)&&JSON.stringify(a)===JSON.stringify(b)||(this._set("tileInfo",a),this.store.tileInfo=a)}},{key:"tileSize",set:function(a){this._get("tileSize")!==a&&this._set("tileSize",a)}},{key:"updating",get:function(){return this.updatingHandles.updating||this.pendingEdits.updating}},{key:"debugInfo",get:function(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this.pendingTiles.values()).map(a=>a.debugInfo),
storedTiles:this.store.debugInfo}}}]);return t}(I.HandleOwner);g.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"url",void 0);g.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"objectIdField",void 0);g.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"capabilities",void 0);g.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"sourceSpatialReference",void 0);g.__decorate([h.property({constructOnly:!0})],
e.FeatureServiceTiledFetcher.prototype,"spatialReference",void 0);g.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"store",void 0);g.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"minimumVerticesPerFeature",null);g.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"filter",null);g.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"customParameters",null);g.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,
"configuration",null);g.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tileInfo",null);g.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tileSize",null);g.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tilesOfInterest",void 0);g.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"updating",null);g.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"availability",void 0);e.FeatureServiceTiledFetcher=
g.__decorate([C.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],e.FeatureServiceTiledFetcher);Object.defineProperty(e,"__esModule",{value:!0})});