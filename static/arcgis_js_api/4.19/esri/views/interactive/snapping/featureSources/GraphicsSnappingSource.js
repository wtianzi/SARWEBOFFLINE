// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../core/Accessor ../../../../geometry/Point ../../../../geometry/Polygon ../../../../geometry/support/typeUtils ../../../../geometry/projection ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/featureConversionUtils ../../../../core/HandleOwner ../snappingUtils ../../../../geometry/support/normalizeUtilsSync ../../../../layers/graphics/data/FeatureStore ../../../../layers/graphics/data/QueryEngine ./queryEngineUtils".split(" "),
function(g,r,l,J,f,K,L,m,M,v,N,O,P,w,t,x,y,z,A,p,B,C,D,E,F,G,H,I){g.GraphicsSnappingSource=function(u){function n(a){a=u.call(this,a)||this;a.availability=1;a.sources={multipoint:null,point:null,polygon:null,polyline:null};a.loadedWkids=new Set;a.loadedWkts=new Set;a.pendingAdds=[];return a}r._inheritsLoose(n,u);var c=n.prototype;c.destroy=function(){const a=this.pendingAdds;this.pendingAdds.length=0;for(const b of a)b.task.abort();this.mapSources(b=>this.destroySource(b))};c.initialize=function(){this.handles.add([this.layer.on("graphic-update",
a=>this.onGraphicUpdate(a)),this.updatingHandles.addOnCollectionChange(this.layer.graphics,a=>this.onGraphicsChanged(a))]);this.addMany(this.layer.graphics.toArray())};c.fetchCandidates=async function(a,b){const d=(await t.eachAlwaysValues(this.mapSources(e=>e.queryEngine.executeQueryForSnapping({point:a.coordinateHelper.toPoint(a.point,new y).toJSON(),distance:a.distance,types:a.types,query:f.isSome(a.filter)?a.filter.createQuery().toJSON():{where:"1\x3d1"}},b).then(({candidates:h})=>h)))).flat().map(e=>
I.convertSnappingCandidate(e,a.coordinateHelper));E.sortCandidatesInPlace(a.point,d);return{candidates:d}};c.refresh=function(){};c.onGraphicUpdate=function(a){switch(a.property){case "geometry":case "visible":this.remove(a.graphic),this.addMany([a.graphic])}};c.onGraphicsChanged=function(a){for(const b of a.removed)this.remove(b);this.addMany(a.added)};c.addMany=function(a){const b=[],d=new Map;for(const e of a)f.isNone(e.geometry)||(this.needsInitializeProjection(e.geometry.spatialReference)?(b.push(e.geometry.spatialReference),
d.set(e.uid,e)):this.add(e));this.createPendingAdd(b,d)};c.createPendingAdd=function(a,b){if(a.length){var d=t.createTask(async k=>{await p.initializeProjection(a.map(q=>({source:q,dest:this.spatialReference})),{signal:k});this.markLoadedSpatialReferences(a);for(const [,q]of b)this.add(q)});this.updatingHandles.addPromise(d.promise);var e={task:d,graphics:b},h=()=>w.removeUnordered(this.pendingAdds,e);d.promise.then(h,h);this.pendingAdds.push(e)}};c.markLoadedSpatialReferences=function(a){for(const b of a)null!=
b.wkid&&this.loadedWkids.add(b.wkid),null!=b.wkt&&this.loadedWkts.add(b.wkt)};c.add=function(a){if(!f.isNone(a.geometry)&&a.visible){var b=a.geometry;if("mesh"!==b.type){"extent"===b.type&&(b=z.fromExtent(b));var d=this.ensureSource(b.type);f.isNone(d)||(a=this.createOptimizedFeature(a.uid,b),f.isSome(a)&&d.featureStore.add(a))}}};c.needsInitializeProjection=function(a){return null!=a.wkid&&this.loadedWkids.has(a.wkid)||null!=a.wkt&&this.loadedWkts.has(a.wkt)?!1:!p.canProjectWithoutEngine(a,this.spatialReference)};
c.createOptimizedFeature=function(a,b){return(b=p.project(F.normalizeCentralMeridianSync(b),this.spatialReference))?new B(C.convertFromGeometry(b,!1,!1),{["OBJECTID"]:a},null,a):null};c.ensureSource=function(a){var b=this.sources[a];if(f.isSome(b))return b;b=this.createSource(a);return this.sources[a]=b};c.createSource=function(a){var b=A.featureGeometryTypeKebabDictionary.toJSON(a);const d=new G({geometryType:b,hasZ:!1,hasM:!1});b=new H["default"]({featureStore:d,fields:[{name:"OBJECTID",type:"esriFieldTypeOID",
alias:"OBJECTID"}],geometryType:b,hasM:!1,hasZ:!1,objectIdField:"OBJECTID",spatialReference:this.spatialReference,scheduler:f.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null});return{featureStore:d,queryEngine:b,type:a}};c.remove=function(a){this.mapSources(b=>this.removeFromSource(b,a));for(const b of this.pendingAdds)b.graphics.delete(a.uid),0===b.graphics.size&&b.task.abort()};c.removeFromSource=function(a,b){a.featureStore.has(b.uid)&&a.featureStore.removeById(b.uid)};
c.destroySource=function(a){a.queryEngine.destroy();this.sources[a.type]=null};c.mapSources=function(a){const {point:b,polygon:d,polyline:e,multipoint:h}=this.sources,k=[];f.isSome(b)&&k.push(a(b));f.isSome(d)&&k.push(a(d));f.isSome(e)&&k.push(a(e));f.isSome(h)&&k.push(a(h));return k};r._createClass(n,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"layer",get:function(){return this.layerSource.layer}}]);return n}(D.HandleOwnerMixin(x));l.__decorate([m.property({constructOnly:!0})],
g.GraphicsSnappingSource.prototype,"spatialReference",void 0);l.__decorate([m.property({constructOnly:!0})],g.GraphicsSnappingSource.prototype,"layerSource",void 0);l.__decorate([m.property({constructOnly:!0})],g.GraphicsSnappingSource.prototype,"view",void 0);l.__decorate([m.property({readOnly:!0})],g.GraphicsSnappingSource.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],g.GraphicsSnappingSource.prototype,"availability",void 0);g.GraphicsSnappingSource=l.__decorate([v.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],
g.GraphicsSnappingSource);Object.defineProperty(g,"__esModule",{value:!0})});