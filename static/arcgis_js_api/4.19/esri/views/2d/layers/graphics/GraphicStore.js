// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/support/contains ../../../../geometry/support/extentUtils ../../../../geometry/support/jsonUtils ../../../../core/screenUtils ../../../../core/unitUtils ../../../../geometry/support/normalizeUtilsCommon ../../../../geometry/support/normalizeUtils ../../../../geometry/support/aaBoundingRect ./graphicsUtils ../../../../chunks/rbush ./GraphicStoreItem".split(" "),function(A,B,x,C,D,E,F,G,H,q,p,I,y){function v(w,
n,a,d,c){u.minX=n;u.minY=a;u.maxX=d;u.maxY=c;return w.search(u)}const u={minX:0,minY:0,maxX:0,maxY:0},t=q.create(),z=[];return function(){function w(a,d,c,e,h,k){this._graphics=e;this._onAdd=h;this._onRemove=k;this._index=I.rbush(9,A("csp-restrictions")?b=>({minX:b.bounds[0],minY:b.bounds[1],maxX:b.bounds[2],maxY:b.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this._itemByGraphic=new Map;this._currentLevel=-Infinity;this._tileInfoView=a;this._uidFieldName=c;if(d=a.getClosestInfoForScale(d))this._currentLevel=
d.level,this._resolution=this._tileInfoView.getTileResolution(d.level);this._metersPerUnit=B.isValid(a.spatialReference)?F.getMetersPerUnit(a.spatialReference):1}var n=w.prototype;n.hitTest=function(a,d,c,e,h){a=H.normalizeMapX(a,this._tileInfoView.spatialReference);var k=.5*e*c;t[0]=a-k;t[1]=d-k;t[2]=a+k;t[3]=d+k;c=.5*e*(c+p.PIXEL_BUFFER);var b=v(this._index,a-c,d-c,a+c,d+c);if(!b||0===b.length)return[];c={x:a,y:d};k=[];for(const f of b)if(f.graphic.visible)switch(D.getJsonType(f.geometry)){case "esriGeometryPoint":{b=
f.symbol;if(!b)continue;const {x:g,y:m}=f.geometry;var l=e*this._metersPerUnit;let r;switch(b.type){case "esriTS":r=p.getTextSymbolBounds(g,m,b,f.size,e,h);break;case "expanded-cim":r=p.getCIMMarkerBounds(g,m,b,e,l,h);break;case "esriSMS":case "esriPMS":r=p.getMarkerSymbolBounds(g,m,b,e,l,h)}x.polygonContainsPoint(r,c)&&k.push(f)}break;case "esriGeometryPolyline":(b=f.symbol)&&b.layers.length&&(b=1.5*e*window.devicePixelRatio*E.pt2px(b.layers[0].width),p.isPointOnPolyline(f.geometry,a,d,b)&&k.push(f));
break;case "esriGeometryEnvelope":b=f.geometry;b=q.fromValues(b.xmin,b.ymin,b.xmax,b.ymax);q.intersects(b,t)&&k.push(f);break;case "esriGeometryPolygon":if(x.polygonContainsPoint(f.geometry,c)){k.push(f);break}b=C.getPolygonExtent(f.geometry);if(Math.abs(b.ymax-b.ymin)<5*e||Math.abs(b.xmax-b.xmin)<5*e)b=q.fromValues(b.xmin,b.ymin,b.xmax,b.ymax),q.intersects(b,t)&&k.push(f);break;case "esriGeometryMultipoint":{b=f.symbol;if(!b)continue;l=f.geometry.points;let g;for(let m=0;m<l.length;m++)if(g="esriTS"===
b.type?p.getTextSymbolBounds(l[m][0],l[m][1],b,f.size,e,h):p.getMarkerSymbolBounds(l[m][0],l[m][1],b,e,e*this._metersPerUnit,h),x.polygonContainsPoint(g,c)){k.push(f);break}}}k.sort((f,g)=>{const m=p.graphicGeometryToNumber(f.graphic),r=p.graphicGeometryToNumber(g.graphic);return m===r?g.zorder-f.zorder:m-r});return k.map(f=>f.graphic)};n.getGraphicsData=function(a,d,c){const e=this._searchForItems(d);if(0===e.length||0===c.length)return[];e.sort((f,g)=>f.zorder-g.zorder);e[0].insertAfter=-1;for(var h=
1;h<e.length;h++)e[h].insertAfter=e[h-1].graphic.uid;e.sort((f,g)=>f.graphic.uid-g.graphic.uid);c.sort((f,g)=>f.uid-g.uid);let k=h=0,b;const l=[];d={originPosition:"upperLeft",scale:[d.resolution,d.resolution],translate:[d.bounds[0],d.bounds[3]]};for(const f of c){for(k=-2;h<e.length;)if(b=e[h],h++,f.uid===b.graphic.uid){k=b.insertAfter;break}if(!b.geometry||-2===k)continue;c=b.getGeometryQuantized(d);const g={...b.graphic.attributes};g[this._uidFieldName]=f.uid;null==b.groupId&&(b.groupId=a.createTemplateGroup(b.symbol,
null));l.push({centroid:y.getCentroidQuantized(b,d),geometry:c,attributes:g,symbol:b.symbol,groupId:b.groupId,insertAfter:k,zorder:b.zorder})}l.sort((f,g)=>f.zorder-g.zorder);return l};n.queryTileData=function(a,d){const {bounds:c,resolution:e}=d;d=this._searchForItems(d);const h=[];this._createTileGraphics(h,a,d,{originPosition:"upperLeft",scale:[e,e],translate:[c[0],c[3]]});return h};n.has=function(a){return this._itemByGraphic.has(a)};n.getBounds=function(a){return this._itemByGraphic.has(a)?this._itemByGraphic.get(a).bounds:
null};n.addOrModify=function(a,d,c){if(a)return this.has(a)&&this.remove(a),this._onAdd(a),d=y.acquire(a,d,c,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),this._itemByGraphic.set(a,d),c&&this._index.insert(d),d.bounds};n.remove=function(a){if(this._itemByGraphic.has(a)){this._onRemove(a);var d=this._itemByGraphic.get(a);this._index.remove(d);this._itemByGraphic.delete(a)}};n.updateZ=function(){const a=this._graphics.items;for(let c=0;c<a.length;c++){var d=
a[c];if(d=this._itemByGraphic.get(d))d.zorder=c}};n.update=function(a,d,c){const e=this._itemByGraphic.get(a);e.groupId=null;const h=q.clone(e.bounds);e.size[0]=e.size[1]=0;this._index.remove(e);e.set(a,d,c,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);c&&this._index.insert(e);return{oldBounds:h,newBounds:e.bounds}};n.updateLevel=function(a){this._currentLevel!==a&&(this._currentLevel=a,this._resolution=this._tileInfoView.getTileResolution(a),this._index.clear(),
z.length=0,this._itemByGraphic.forEach(d=>{d.updateBounds(this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);d.geometry&&z.push(d)}),this._index.load(z))};n.clear=function(){this._itemByGraphic.clear();this._index.clear()};n._createTileGraphics=function(a,d,c,e){const h=this._uidFieldName;c.sort((g,m)=>g.zorder-m.zorder);let k,b,l,f;for(let g=0;g<c.length;g++){l=c[g];k=l.graphic;b=l.getGeometryQuantized(e);f=0===g?-1:c[g-1].graphic.uid;const m={...l.graphic.attributes};
m[h]=k.uid;null==l.groupId&&(l.groupId=d.createTemplateGroup(l.symbol,null));a.push({centroid:y.getCentroidQuantized(l,e),geometry:b,attributes:m,symbol:l.symbol,groupId:l.groupId,insertAfter:f,zorder:l.zorder})}};n._searchForItems=function(a){var d=this._tileInfoView.spatialReference,c=a.bounds;if(d.isWrappable){const [e,h]=G.getSpatialReferenceMinMaxX(d);d=1E-5>Math.abs(c[2]-h);const k=1E-5>Math.abs(c[0]-e);if(!(d&&k||!d&&!k))return a=a.resolution,a=d?q.create([e,c[1],e+a*p.PIXEL_BUFFER,c[3]]):
q.create([h-a*p.PIXEL_BUFFER,c[1],h,c[3]]),c=v(this._index,c[0],c[1],c[2],c[3]),a=v(this._index,a[0],a[1],a[2],a[3]),[...new Set([...c,...a])]}return v(this._index,c[0],c[1],c[2],c[3])};return w}()});