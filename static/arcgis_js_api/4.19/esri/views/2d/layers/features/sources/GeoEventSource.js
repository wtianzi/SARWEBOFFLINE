// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/featureConversionUtils ../support/FeatureSetReaderJSON ../../../../../chunks/rbush ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ../support/UpdateToken ./DataTileSource".split(" "),function(q,m,r,t,u,n,x,y,z,A,B,C){function D(f,
d){const c=f.weakClone(),a=n.quantizeX(d,f.geometry.coords[0]);f=n.quantizeY(d,f.geometry.coords[1]);c.geometry=new u([],[a,f]);return c}function E(f){switch(f){case "esriGeometryPoint":return D;default:return(d,c)=>{const a=d.weakClone(),b=new u;d=n.quantizeOptimizedGeometry(b,d.geometry,!1,!1,f,c,!1,!1);a.geometry=d;return a}}}function F(f){switch(f){case "esriGeometryPoint":return d=>({minX:d.geometry.coords[0],minY:d.geometry.coords[1],maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]});default:return d=>
{let c=Infinity,a=Infinity,b=-Infinity,e=-Infinity;d.geometry.forEachVertex((g,k)=>{c=Math.min(c,g);a=Math.min(a,k);b=Math.max(b,g);e=Math.max(e,k)});return{minX:c,minY:a,maxX:b,maxY:e}}}}let G=function(){function f(c,a){this.onUpdate=c;this._geometryType=a;this._objectIdToFeature=new Map}var d=f.prototype;d.add=function(c){this._objectIdToFeature.set(c.objectId,c);this._index=null};d.get=function(c){return this._objectIdToFeature.has(c)?this._objectIdToFeature.get(c):null};d.forEach=function(c){this._objectIdToFeature.forEach(c)};
d.search=function(c){if(!this._index){{var a=this._features;const b=y.rbush(9,F(this._geometryType));b.load(a);a=b}this._index=a}return this._index.search({minX:c.bounds[0],minY:c.bounds[1],maxX:c.bounds[2],maxY:c.bounds[3]})};d.removeById=function(c){const a=this._objectIdToFeature.get(c);return a?(this._objectIdToFeature.delete(c),this._index=null,a):null};d.update=function(c,a){this.onUpdate(c,a)};m._createClass(f,[{key:"_features",get:function(){const c=[];this._objectIdToFeature.forEach(a=>c.push(a));
return c}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return f}();r=function(f){function d(a){var b=f.call(this,a)||this;b.type="geoevent";b._dataReceiveEventEnabled=!1;b._level=0;b._updateInfo={websocket:0,client:0};var {outSR:e}=a;const {geometryType:g,objectIdField:k,timeInfo:p,purgeOptions:H,source:I,spatialReference:J,serviceFilter:K,maxReconnectionAttempts:L,maxReconnectionInterval:M,updateInterval:N}=a.serviceInfo,v=new G(b._onUpdate.bind(m._assertThisInitialized(b)),
g),O=new z["default"](v,k,p,H);e=A.createConnection(I,J,e,g,K,L,M);b._store=v;b._manager=O;b._connection=e;b._quantize=E(g);b._handles=[b._connection.on("feature",h=>b._onFeature(h)),b._connection.watch("connectionStatus",h=>b.events.emit("connectionStatus",h)),b._connection.watch("errorString",h=>b.events.emit("errorString",h))];let w=performance.now();b._updateIntervalId=setInterval(()=>{var h=performance.now(),l=h-w;2500<l&&(w=h,h=Math.round(b._updateInfo.client/(l/1E3)),l=Math.round(b._updateInfo.websocket/
(l/1E3)),b._updateInfo.client=0,b._updateInfo.websocket=0,b.events.emit("updateRate",{client:h,websocket:l}));a.canAcceptRequest()&&b._manager.checkForUpdates()},N);return b}m._inheritsLoose(d,f);var c=d.prototype;c.destroy=function(){f.prototype.destroy.call(this);clearInterval(this._updateIntervalId);this._handles.forEach(a=>a.remove());this._connection.destroy()};c._fetchDataTile=function(){};c.resume=function(){};c.enableEvent=function(a,b){"data-received"===a&&(this._dataReceiveEventEnabled=
b)};c.subscribe=function(a){f.prototype.subscribe.call(this,a);const b=this._subscriptions.get(a.id);this._level=a.level;const e=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:e,end:!0});b.didSend=!0};c.unsubscribe=function(a){f.prototype.unsubscribe.call(this,a)};c.forEachRequest=function(a,b){const e=this._subscriptions.get(a),{tile:g,signal:k}=e;a={type:"append",tile:g,id:a,addOrUpdate:this._getTileFeatures(g),end:!0};b(a,{signal:k});e.requests.stream.entries.forEach(p=>
{t.isSome(p)&&b(p,{signal:k})})};c.createTileQuery=function(a){throw Error("Service does not support tile  queries");};c.resend=async function(){this._subscriptions.forEach(a=>{({tile:a}=a);a={type:"append",id:a.id,addOrUpdate:this._getTileFeatures(a),end:!0};this._onMessage(a)})};c._getTileFeatures=function(a){const b=this._store.search(a).map(e=>this._quantize(e,a.transform));return x.FeatureSetReaderJSON.fromOptimizedFeatures(b,this._serviceInfo.geometryType,a.transform)};c._onFeature=function(a){this._updateInfo.websocket++;
try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const b=n.convertFromFeature(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(b)}catch(b){}};c._onUpdate=function(a,b){t.isSome(a)&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((e,g)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:g,addOrUpdate:null,clear:!0,end:!1})});this._subscriptions.forEach((e,g)=>{if(e.didSend&&e.tile.level===this._level){var k=
this._getTileFeatures(e.tile);g={type:"append",id:g,addOrUpdate:k,remove:[],end:!0,status:B.UpdateToken.empty()};e.requests.stream.enqueue(g);this._onMessage(g)}})};m._createClass(d,[{key:"updating",get:function(){return!1}}]);return d}(C.DataTileSource);q.GeoEventSource=r;Object.defineProperty(q,"__esModule",{value:!0})});