// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/property ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/urlUtils ../../../../../core/uuid ../../../../../portal/support/resourceExtension ../../../../../core/promiseUtils ../../../../../core/scheduling ../../../../../core/Accessor ../../../../../chunks/vec2 ../../../tiling/TileKey ../../../tiling/PagedTileQueue ../../../tiling/TileInfoView ../../../tiling/TileQueue ../../../tiling/TileStrategy".split(" "),
function(n,g,d,z,A,k,B,w,C,D,E,r,x,y,t,u,F,G,H,I){const q=[0,0];d=function(v){function p(a){a=v.call(this,a)||this;a._queue=new Map;a._isPaused=!1;a._scheduledNextHandle=null;a._timestamp=Date.now();a.tileInfoView=null;a._next=a._next.bind(n._assertThisInitialized(a));a._finalize=a._finalize.bind(n._assertThisInitialized(a));return a}n._inheritsLoose(p,v);var b=p.prototype;b.abort=function(a){this._onGoingTile&&this._onGoingTile.tileId===a&&(this._onGoingTile.abortController.abort(),this._onGoingTile=
null);this._queue.delete(a);this._scheduleNext();this.notifyChange("updating")};b.clear=function(){this._queue.clear();this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null);this._cancelNext();this.notifyChange("updating")};b.has=function(a){return this._queue.has(a)};b.isOngoing=function(a){return this._onGoingTile&&this._onGoingTile.tileId===a};b.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.push=function(a,h){if(!this._queue.has(a)){var e=
r.createAbortController();this._queue.set(a,{tileId:a,key:u.pool.acquire(a),timestamp:h||this._timestamp,abortController:e});this._scheduleNext();this.notifyChange("updating")}};b.refresh=function(){this._timestamp=Date.now();this.reset()};b.reset=function(){var a=this._onGoingTile;a&&({tileId:a}=a,this.push(a,this._timestamp));this.notifyChange("updating")};b.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext());this.notifyChange("updating")};b._finalize=function(){this._onGoingTile=
null;this.notifyChange("updating");this._scheduleNext()};b._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)};b._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=x.schedule(this._next))};b._next=async function(){if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)this._scheduledNextHandle=null;else{this._scheduledNextHandle=
null;var a=this._peek(),h=a.abortController.signal,{tileId:e,key:f}=a;u.pool.release(f);this._queue.delete(e);this._onGoingTile=a;a=this.process(e,this._timestamp,{signal:h});this.notifyChange("updating");if(r.isPromiseLike(a))try{await a}catch(l){}this._finalize()}};b._peek=function(){if(!this.state)throw Error("state not set");const a=this.tileInfoView,h=this.state.center;let e=Number.NEGATIVE_INFINITY,f=Number.POSITIVE_INFINITY,l=null;this._queue.forEach(m=>{a.getTileCoords(q,m.key);var c=this._timestamp-
m.timestamp;isNaN(c)?(c=t.distance(q,h),c<f&&(f=c,l=m)):c===e?(c=t.distance(q,h),c<f&&(f=c,l=m)):c>e&&(e=c,f=Number.POSITIVE_INFINITY,l=m)});return l};n._createClass(p,[{key:"length",get:function(){return this._queue.size}},{key:"updating",get:function(){return 0<this._queue.size||null!=this._onGoingTile}}]);return p}(y);g.__decorate([k.property({readOnly:!0})],d.prototype,"length",null);g.__decorate([k.property({constructOnly:!0})],d.prototype,"process",void 0);g.__decorate([k.property()],d.prototype,
"state",void 0);g.__decorate([k.property({constructOnly:!0})],d.prototype,"tileInfoView",void 0);g.__decorate([k.property({readOnly:!0})],d.prototype,"updating",null);return d=g.__decorate([w.subclass("esri.views.2d.layers.features.support.TileUpdateQueue")],d)});