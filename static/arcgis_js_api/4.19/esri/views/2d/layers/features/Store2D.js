// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/has ../../../../core/maybe ../../../../support/arcadeOnDemand ../../../../core/accessorSupport/diffUtils ../../arcade/callExpressionWithCursor".split(" "),function(m,k,n,p,q,l,r){const t=new Promise(function(g,e){m(["../../../../layers/support/labelFormatUtils"],g,e)});let u=function(){function g(b,a){this._canCacheExpressionValue=!1;this._sourceInfo=b;this._bitsets={computed:a.getBitset(a.createBitset())}}var e=g.prototype;e.invalidate=function(){this._bitsets.computed.clear()};
e.updateSchema=async function(b,a){var c=l.diff(this._schema,a);if((this._schema=a)&&!p.isNone(c)&&l.hasDiff(c,"attributes")){n("esri-2d-update-debug")&&console.debug("Applying Update - Store:",c);this._bitsets.computed.clear();b.targets[a.name]=!0;b=a.attributes;a=[];c=[];for(const f in b){const d=b[f];switch(d.type){case "expression":a.push(this._createArcadeComputedField(d));break;case "label-expression":a.push(this._createLabelArcadeComputedField(d));break;case "statistic":c.push(d)}}this._computedFields=
await Promise.all(a);this._canCacheExpressionValue=!this._computedFields.some(f=>"expression"===f.type&&f.expression.referencesScale());this._statisticFields=c}};e.setComputedAttributes=function(b,a,c,f){var d=this._bitsets.computed;if(!this._canCacheExpressionValue||!d.has(c)){d.set(c);for(const h of this._computedFields)switch(d=this._evaluateField(a,h,f),h.resultType){case "numeric":b.setComputedNumericAtIndex(c,h.fieldIndex,d);break;case "string":b.setComputedStringAtIndex(c,h.fieldIndex,d)}}};
e._createArcadeComputedField=async function(b){return{...b,expression:await q.createRendererExpression(b.valueExpression,this._sourceInfo.spatialReference,this._sourceInfo.fieldsIndex)}};e._createLabelArcadeComputedField=async function(b){var a=this._sourceInfo.spatialReference;const c=this._sourceInfo.fields,{createLabelFunction:f}=await t;a=await f(b.label,c,a);return{...b,builder:a}};e._evaluateField=function(b,a,c){switch(a.type){case "label-expression":return b=b.readArcadeFeature(),a.builder.evaluate(b)||
"";case "expression":return{expression:a}=a,r(a,b,{$view:{scale:c}})}};return g}();k.Store2D=u;Object.defineProperty(k,"__esModule",{value:!0})});