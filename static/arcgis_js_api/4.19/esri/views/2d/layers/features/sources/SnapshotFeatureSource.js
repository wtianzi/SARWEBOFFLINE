// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/promiseUtils ../support/FeatureSetReaderPBFIndirect ../support/UpdateToken ./BaseFeatureSource".split(" "),function(x,y,z,q,A,B,u,C,v,D){function E(m,k,g){var a=m.getXHydrate();m=m.getYHydrate();a=k.getColumnForX(a);a=Math.floor(k.normalizeCol(a));k=Math.floor(k.getRowForY(m));return`${g}/${k}/${a}`}function w(m,
k){if(q.isNone(m))return null;k=k.transform;const g=m.getQuantizationTransform();if(q.isNone(g)){const [h,r]=k.scale,[t,p]=k.translate;return m.transform(-t/h,p/r,1/h,1/-r)}const [a,b]=g.scale,[e,f]=g.translate,[d,c]=k.scale,[l,n]=k.translate;return m.transform((e-l)/d,(-f+n)/c,a/d,b/c)}const F=A.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");z=function(m){function k(a){var b=m.call(this,a)||this;b.mode="snapshot";b._loading=!0;b._controller=new AbortController;b._downloadPromise=
null;b._didSendEnd=!1;b._queries=[];b._invalidated=!1;b._hasAggregates=!1;b._random=new B(1E3);b._featureCount=a.featureCount;b._store=a.store;b._markedIdsBufId=b._store.storage.createBitset();return b}y._inheritsLoose(k,m);var g=k.prototype;g.destroy=function(){m.prototype.destroy.call(this);this._controller.abort()};g.update=function(a,b){m.prototype.update.call(this,a,b);this._hasAggregates=a.targets.aggregate};g.resend=async function(a=!1){await this._downloadPromise;this._invalidated||a?(this._invalidated=
!1,this._subscriptions.forEach(b=>b.clear()),this._downloadPromise=this._download(this._featureCount),await this._downloadPromise):(a=this._queries.map(({query:b,reader:e})=>this._sendPatchQuery(b,e)),await Promise.all(a),this._subscriptions.forEach(b=>{b.requests.done.forEach(e=>this._onMessage(e.message))}))};g.refresh=async function(){await this.resend(!0)};g.edit=async function(a){const b=this._signal;var e=a.addedFeatures.filter(c=>!c.error).map(c=>c.objectId),f=a.updatedFeatures.filter(c=>!c.error).map(c=>
c.objectId);a=a.deletedFeatures.filter(c=>!c.error).map(c=>c.objectId);e=[...e,...f];f=[...a,...e];for(var d of f)this._store.remove(d);d=this.createQuery();d.objectIds=e;d=await this._queue.push({query:d,depth:0,signal:b});u.throwIfAborted({signal:b});this._store.insert(d);this._send(d);this._invalidateQueries()};g._invalidateQueries=function(){this._invalidated=!0};g._sendPatchQuery=async function(a,b){const e=q.isSome(a.outFields)?a.outFields:[],f=this._queryInfo.outFields,d=f.filter(n=>-1===e.indexOf(n));
if(d.length){var c=a.clone(),l=this._signal;c.returnGeometry=!1;c.returnCentroid=!1;c.outFields=d;a.outFields=f;a=await this._queue.push({query:c,depth:0,signal:l});u.throwIfAborted({signal:l});b.joinAttributes(a)}};g._fetchDataTile=async function(a){this._downloadPromise||(this._downloadPromise=this._download(this._featureCount));var b=this._store.search(a);const e=this._subscriptions.get(a.key.id),f=b.length-1;for(let c=0;c<f;c++){var d=w(b[c],a);d={type:"append",id:a.id,addOrUpdate:d,end:!1,status:v.UpdateToken.empty()};
e.add({query:null,message:d});this._hasAggregates||await u.after(1);this._onMessage(d)}b=w(0<=f?b[f]:null,a);a={type:"append",id:a.id,addOrUpdate:b,end:this._didSendEnd,status:v.UpdateToken.empty()};e.add({query:null,message:a});this._onMessage(a)};g._download=async function(a){try{await this.whenInitialized();const b=this._store.storage.getBitset(this._markedIdsBufId),e=new Set;b.clear();const f=Array.from({length:Math.ceil(a/this.pageSize)},(d,c)=>c).sort((d,c)=>this._random.getInt()-this._random.getInt()).map(d=>
this._downloadPage(d,b,e));await Promise.all(f);this._store.sweepFeatures(b,this._store.storage);this._store.sweepFeatureSets(e)}catch(b){F.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",b)}this._sendEnd();this._loading=!1};g._downloadPage=async function(a,b,e){var f=this.pageSize;f={start:a*f,num:f,cacheHint:!0};q.isSome(this.maxRecordCountFactor)&&(f.maxRecordCountFactor=this.maxRecordCountFactor);f=this.createQuery(f);const d=this._signal;a=await this._queue.push({query:f,
depth:a,signal:d});u.throwIfAborted({signal:d});this._queries.push({query:f,reader:a});this._store.insert(a);e.add(a.instance);for(e=a.getCursor();e.next();)b.set(e.getDisplayId());this._send(a)};g._send=function(a){if(this._subscriptions.size){var b=null,e=new Map,f=new Set,d=new Map;this._subscriptions.forEach(l=>{var n,h=l.tile;e.set(h.key.id,null);b=h.tileInfoView;f.add(h.level);const {row:r,col:t}=h.key;h=`${h.level}/${r}/${t}`;const p=null!=(n=d.get(h))?n:[];p.push(l);d.set(h,p)});for(const l of f){const n=
b.getLODInfoAt(l),h=a.getCursor();for(;h.next();){var c=E(h,n,l);const r=h.getIndex();if(d.has(c))for(const t of d.get(c)){c=t.tile.id;let p=e.get(c);q.isNone(p)&&(p=[],e.set(c,p));p.push(r)}}}e.forEach((l,n)=>{if(q.isSome(l)){const h=this._subscriptions.get(n);l=w(C.FeatureSetReaderIndirect.from(a,l),h.tile);n={type:"append",id:n,addOrUpdate:l,end:!1,status:v.UpdateToken.empty()};h.add({query:null,message:n});this._onMessage(n)}})}};g._sendEnd=function(){this._subscriptions.forEach(a=>{const b={type:"append",
id:a.tile.id,addOrUpdate:null,end:!0,status:v.UpdateToken.empty()};a.add({query:null,message:b});this._onMessage(b)});this._didSendEnd=!0};y._createClass(k,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]);return k}(D.BaseFeatureSource);x.SnapshotFeatureSource=z;Object.defineProperty(x,"__esModule",{value:!0})});