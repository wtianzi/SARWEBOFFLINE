// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/Error ../../../../../core/promiseUtils ../../../../../request ../../../../../tasks/support/Query ../../../../support/QueueProcessor ../controllers/support/sourceAdapters ./DataTileSource".split(" "),function(q,r,t,g,p,v,l,w,x,u,y,z){const A=p.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");p=function(k){function m(b){var a=
k.call(this,b)||this;a.type="feature";a.mode="on-demand";a._adapter=y.createSourceAdapter(b.serviceInfo);a._queue=new u.QueueProcessor({concurrency:8,process:async c=>{l.throwIfAborted(c);if(g.isSome(c.tile)){var d=c.tile.key.id;const {tile:f,signal:h}=c;d={query:t("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0,signal:h,transform:f.transform};return a._adapter.executeQuery(c.query,d)}return a._adapter.executeQuery(c.query,c)}});a._patchQueue=new u.QueueProcessor({concurrency:8,
process:async c=>{l.throwIfAborted(c);if(g.isSome(c.tile)){var d=c.tile.key.id;const {tile:f,signal:h}=c;d={query:t("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0,signal:h,transform:f.transform};return a._adapter.executeQuery(c.query,d)}return a._adapter.executeQuery(c.query,c)}});return a}r._inheritsLoose(m,k);var e=m.prototype;e.destroy=function(){k.prototype.destroy.call(this);this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};e.enableEvent=function(b,
a){};e.subscribe=function(b){k.prototype.subscribe.call(this,b);this._fetchDataTile(b).catch(a=>{l.isAbortError(a)||A.error(new v("mapview-query-error","Encountered error when fetching tile",{tile:b,error:a}))})};e.unsubscribe=function(b){k.prototype.unsubscribe.call(this,b)};e.resume=function(){this._queue.resume()};e.forEachRequest=function(b,a){b=this._subscriptions.get(b);const {requests:c,signal:d}=b;for(const f of c.done)a(f.message,{signal:d})};e.query=async function(b,a){return this._adapter.executeQuery(b,
a)};e.queryLastEditDate=async function(){const b=this._serviceInfo.source;return(await w(b.path,{query:{...b.query,f:"json"},responseType:"json"})).data.editingInfo.lastEditDate};e.createTileQuery=function(b){const a=this.createQuery();a.quantizationParameters=b.getQuantizationParameters();a.resultType="tile";a.geometry=b.extent;"esriGeometryPolyline"===this._serviceInfo.geometryType&&(a.maxAllowableOffset=b.resolution);this._serviceInfo.capabilities.query.supportsQuantization||(a.quantizationParameters=
null,a.maxAllowableOffset=b.resolution);return a};e._createQuery=function(b,a){const c=new x({...this._queryInfo,...a});this._serviceInfo.capabilities.query.supportsQuantization||(a.quantizationParameters=null,c.maxAllowableOffset=b.resolution);a.quantizationParameters&&"esriGeometryPolyline"===this._serviceInfo.geometryType&&(c.maxAllowableOffset=b.resolution);c.resultType="tile";c.geometry=b.extent;return c};e._executePatchQuery=async function(b,a,c,d){a=a.clone();a.outFields=[this._serviceInfo.objectIdField,
...c];a.returnCentroid=!1;a.returnGeometry=!1;c=g.isSome(a.start)?a.start/8E3:0;return this._patchQueue.push({tile:b,query:a,signal:d.signal,depth:c})};e._resend=async function(b,a){const {query:c,message:d}=b,f=g.isSome(c.outFields)?c.outFields:[];b=this._queryInfo.outFields;const h=b.filter(n=>-1===f.indexOf(n));if(!g.isNone(d.addOrUpdate))if(h.length)try{const n=this._subscriptions.get(d.id).tile,B=await this._executePatchQuery(n,c,h,a);l.throwIfAborted(a);c.outFields=b;d.addOrUpdate.joinAttributes(B);
this._onMessage({...d,end:d.end,type:"append"})}catch(n){}else this._onMessage({...d,end:d.end,type:"append"})};e.resend=async function(){let b=0,a=!1;const c=[];for(this._subscriptions.forEach(d=>{d.requests.done.length||this._onMessage({id:d.tile.id,addOrUpdate:null,end:!1,type:"append"})});!a;)a=!0,this._subscriptions.forEach(({requests:d,signal:f})=>{d.done.length>b&&(a=!1,c.push(this._resend(d.done[b],{signal:f})))}),b++;await Promise.all(c)};r._createClass(m,[{key:"updating",get:function(){return!!this._queue.length}},
{key:"maxRecordCountFactor",get:function(){const {query:b}=this._serviceInfo.capabilities;return b.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var b,{query:a}=this._serviceInfo.capabilities;a=null!=(b=a.maxRecordCount)?b:8E3;b=g.unwrapOr(this.maxRecordCountFactor,1);return a*b}},{key:"pageSize",get:function(){return Math.min(8E3,this.maxPageSize)}}]);return m}(z.DataTileSource);q.BaseFeatureSource=p;Object.defineProperty(q,"__esModule",{value:!0})});