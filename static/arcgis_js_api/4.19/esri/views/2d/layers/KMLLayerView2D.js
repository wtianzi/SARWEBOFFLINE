// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/SpatialReference ../../../geometry/support/webMercatorUtils ../../../geometry/Extent ../../../core/Collection ../../../kernel ../../../request ../../../core/Handles ../../../geometry/projection ../../../rest/utils ../../../support/GraphicsCollection ../../../layers/support/kmlUtils ../../layers/LayerView ./graphics/GraphicsView2D ./graphics/GraphicContainer ../engine/Bitmap ../engine/BitmapContainer ./LayerView2D".split(" "),
function(G,l,k,p,R,S,m,T,H,r,U,V,z,A,B,I,J,K,L,t,M,u,n,N,v,w,O,P,Q){let C=function(){this.allSublayers=new Map;this.allPoints=[];this.allPolylines=[];this.allPolygons=[];this.allMapImages=[]};k=function(D){function x(){var a=D.apply(this,arguments)||this;a._handles=new L;a._bitmapIndex=new Map;a._mapImageContainer=new P.BitmapContainer;a._kmlVisualData=new C;a.allVisiblePoints=new u.GraphicsCollection;a.allVisiblePolylines=new u.GraphicsCollection;a.allVisiblePolygons=new u.GraphicsCollection;a.allVisibleMapImages=
new I;return a}G._inheritsLoose(x,D);var f=x.prototype;f.hitTest=function(a,b){if(this.suspended||!this._pointsView&&!this._polylinesView&&!this._polygonsView)return Promise.resolve(null);a=[this._pointsView.hitTest(a,b),this._polylinesView.hitTest(a,b),this._polygonsView.hitTest(a,b)];return Promise.all(a).then(e=>e.filter(c=>{c&&(c.layer=this.layer,c.sourceLayer=this.layer);return!!c})[0]||null)};f.update=function(a){this._polygonsView&&this._polygonsView.processUpdate(a);this._polylinesView&&this._polylinesView.processUpdate(a);
this._pointsView&&this._pointsView.processUpdate(a)};f.attach=function(){this._handles.add([this.allVisibleMapImages.on("change",a=>{a.added.forEach(b=>this._addMapImage(b));a.removed.forEach(b=>this._removeMapImage(b))})]);this.container.addChild(this._mapImageContainer);this._polygonsView=new v({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new w(this.view.featuresTilingScheme)});this.container.addChild(this._polygonsView.container);this._polylinesView=
new v({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new w(this.view.featuresTilingScheme)});this.container.addChild(this._polylinesView.container);this._pointsView=new v({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new w(this.view.featuresTilingScheme)});this.container.addChild(this._pointsView.container);this.watch("layer.visibleSublayers",a=>{for(const [,b]of this._kmlVisualData.allSublayers)b.visibility=
0;for(const b of a)if(a=this._kmlVisualData.allSublayers.get(b.id))a.visibility=1;this._refreshCollections()});this._fetchingPromise=this._fetchService().then(()=>{this._fetchingPromise=null;this.notifyChange("updating")})};f.detach=function(){this._handles.removeAll();this._mapImageContainer.removeAllChildren();this.container.removeAllChildren();this._bitmapIndex.clear();this._polygonsView&&(this._polygonsView.destroy(),this._polygonsView=null);this._polylinesView&&(this._polylinesView.destroy(),
this._polylinesView=null);this._pointsView&&(this._pointsView.destroy(),this._pointsView=null)};f.moveStart=function(){};f.viewChange=function(){this._polygonsView.viewChange();this._polylinesView.viewChange();this._pointsView.viewChange()};f.moveEnd=function(){};f.isUpdating=function(){return null!=this._fetchingPromise||this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating};f._addMapImage=function(a){(this.view.spatialReference.isWGS84||this.view.spatialReference.isWebMercator)&&
K(a.href,{responseType:"image"}).then(({data:b})=>{let e=B.fromJSON(a.extent);A.canProject(e,this.view.spatialReference)&&(e=A.project(e,this.view.spatialReference));const c=new O.Bitmap(b,"standard");c.x=e.xmin;c.y=e.ymax;c.resolution=e.width/b.naturalWidth;c.rotation=a.rotation;this._mapImageContainer.addChild(c);this._bitmapIndex.set(a,c)})};f._getViewDependentUrl=async function(a,b){const {viewFormat:e,viewBoundScale:c,httpQuery:q}=a;if(p.isSome(e)){if(p.isNone(b))throw Error("Loading this network link requires a view state.");
await t.load();if(p.isSome(c)&&1!==c){var d=new B(b.extent);d.expand(c)}else d=b.extent;d=t.project(d,z.WGS84);var g=t.project(d,z.WebMercator);g=Math.max(g.width,g.height);const h={"[bboxWest]":d.xmin.toString(),"[bboxEast]":d.xmax.toString(),"[bboxSouth]":d.ymin.toString(),"[bboxNorth]":d.ymax.toString(),"[lookatLon]":d.center.x.toString(),"[lookatLat]":d.center.y.toString(),"[lookatRange]":g.toString(),"[lookatTilt]":"0","[lookatHeading]":b.rotation.toString(),"[lookatTerrainLon]":d.center.x.toString(),
"[lookatTerrainLat]":d.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":d.center.x.toString(),"[cameraLat]":d.center.y.toString(),"[cameraAlt]":g.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":(b.size[0]*b.pixelRatio).toString(),"[vertPixels]":(b.size[1]*b.pixelRatio).toString(),"[terrainEnabled]":"0","[clientVersion]":J.version,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"};g=y=>{for(const E in y)for(const F in h)y[E]=y[E].replace(F,
h[F])};b=r.queryToObject(e);g(b);d={};p.isSome(q)&&(d=r.queryToObject(q),g(d));a=M.parseUrl(a.href);a.query={...a.query,...b,...d};return`${a.path}?${r.objectToQuery(b)}`}return a.href};f._fetchService=async function(){const a=new C;await this._loadVisualData(this.layer.url,a);this._kmlVisualData=a;this._refreshCollections()};f._refreshCollections=function(){this.allVisiblePoints.removeAll();this.allVisiblePolylines.removeAll();this.allVisiblePolygons.removeAll();this.allVisibleMapImages.removeAll();
this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>
a))};f._isSublayerVisible=function(a){a=this._kmlVisualData.allSublayers.get(a);return a.visibility?-1===a.parentFolderId?!0:this._isSublayerVisible(a.parentFolderId):!1};f._loadVisualData=function(a,b){return this._fetchParsedKML(a).then(async e=>{for(const c of e.sublayers){b.allSublayers.set(c.id,c);e=c.points?await n.getGraphics(c.points):[];const q=c.polylines?await n.getGraphics(c.polylines):[],d=c.polygons?await n.getGraphics(c.polygons):[],g=c.mapImages||[];b.allPoints.push(...e.map(h=>({item:h,
sublayerId:c.id})));b.allPolylines.push(...q.map(h=>({item:h,sublayerId:c.id})));b.allPolygons.push(...d.map(h=>({item:h,sublayerId:c.id})));b.allMapImages.push(...g.map(h=>({item:h,sublayerId:c.id})));c.networkLink&&(e=await this._getViewDependentUrl(c.networkLink,this.view.state),await this._loadVisualData(e,b))}})};f._fetchParsedKML=function(a){return n.fetchService(a,this.view.spatialReference,this.layer.refreshInterval).then(b=>n.parseKML(b.data))};f._removeMapImage=function(a){const b=this._bitmapIndex.get(a);
b&&(this._mapImageContainer.removeChild(b),this._bitmapIndex.delete(a))};return x}(Q.LayerView2DMixin(N));l.__decorate([m.property()],k.prototype,"_pointsView",void 0);l.__decorate([m.property()],k.prototype,"_polylinesView",void 0);l.__decorate([m.property()],k.prototype,"_polygonsView",void 0);l.__decorate([m.property()],k.prototype,"_fetchingPromise",void 0);l.__decorate([m.property()],k.prototype,"updating",void 0);return k=l.__decorate([H.subclass("esri.views.2d.layers.KMLLayerView2D")],k)});