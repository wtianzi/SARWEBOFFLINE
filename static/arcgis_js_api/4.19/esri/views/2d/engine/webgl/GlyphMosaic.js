// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define(["../../../../core/has","../../../../core/promiseUtils","../../../webgl/Texture","./Rect","./RectangleBinPack"],function(q,r,t,m,n){function u(g){const d=new Set;for(const b of g)d.add(Math.floor(b/256));return d}function v(g,d,b){g.has(d)||g.set(d,b().then(()=>{g.delete(d)}).catch(a=>{g.delete(d);r.throwIfNotAbortError(a)}));return g.get(d)}return function(){function g(b,a,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphCache={};this._textures=
[];this._rangePromises=new Map;this.width=b;this.height=a;this._glyphSource=c;this._binPack=new n(b-4,a-4);this._glyphData.push(new Uint8Array(b*a));this._dirties.push(!0);this._textures.push(null);this._initDecorationGlyph()}var d=g.prototype;d.dispose=function(){this._binPack=null;for(const b of this._textures)b&&b.dispose();this._textures.length=0;this._glyphData.length=0};d._initDecorationGlyph=function(){var b=[117,149,181,207,207,181,149,117];const a=[];for(let c=0;c<b.length;c++){const f=b[c];
for(let e=0;11>e;e++)a.push(f)}b={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(a)};this._recordGlyph(b)};d.getGlyphItems=async function(b,a,c){const f=this._getGlyphCache(b);await this._fetchRanges(b,a,c);return a.map(e=>this._getMosaicItem(f,b,e))};d.bind=function(b,a,c,f){const e=this._getTexture(b,c);e.setSamplingMode(a);this._dirties[c]&&(e.setData(this._glyphData[c]),this._dirties[c]=!1);b.bindTexture(e,f)};d._getGlyphCache=function(b){this._glyphCache[b]||(this._glyphCache[b]=
{});return this._glyphCache[b]};d._getTexture=function(b,a){this._textures[a]||(this._textures[a]=new t(b,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));return this._textures[a]};d._invalidate=function(){this._dirties[this._currentPage]=!0};d._fetchRanges=async function(b,a,c){const f=[];u(a).forEach(e=>{f.push(this._fetchRange(b,e,c))});await Promise.all(f)};d._fetchRange=async function(b,a,c){return 256<a?null:v(this._rangePromises,
b+a,()=>this._glyphSource.getRange(b,a,c))};d._getMosaicItem=function(b,a,c){if(!b[c]){a=this._glyphSource.getGlyph(a,c);if(!a||!a.metrics)return{rect:new m(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:c,sdf:!0};const f=this._recordGlyph(a);b[c]={rect:f,page:this._currentPage,metrics:a.metrics,code:c,sdf:!0};this._invalidate()}return b[c]};d._recordGlyph=function(b){var a=b.metrics;if(0===a.width)a=new m(0,0,0,0);else{const c=a.width+6,f=a.height+6;a=this._binPack.allocate(c,
f);a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new n(this.width-4,this.height-4),a=this._binPack.allocate(c,f));const e=this._glyphData[this._currentPage];b=b.bitmap;let h,p;if(b)for(let k=0;k<f;k++){h=c*k;p=this.width*(a.y+k)+a.x;for(let l=0;l<c;l++)e[p+l]=b[h+l]}q("esri-glyph-debug")&&
this._showDebugPage(e)}return a};d._showDebugPage=function(b){const a=document.createElement("canvas"),c=a.getContext("2d"),f=new ImageData(this.width,this.height),e=f.data;a.width=this.width;a.height=this.height;a.style.border="1px solid black";for(let h=0;h<b.length;++h)e[4*h]=b[h],e[4*h+1]=0,e[4*h+2]=0,e[4*h+3]=255;c.putImageData(f,0,0);document.body.appendChild(a)};return g}()});