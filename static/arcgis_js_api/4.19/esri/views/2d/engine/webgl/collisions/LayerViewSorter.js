// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Logger","../../../../../core/Error"],function(k,h,m){function l(g){return"esri.views.2d.layers.FeatureLayerView2D"===g.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===g.declaredClass}const n=h.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");h=function(){function g(a,b){this.registerLayer=a;this.unregisterLayer=b;this._layerViewState=new Map}var f=g.prototype;f.findIndex=function(a){return a.view.allLayerViews.findIndex(b=>b.uid===a.uid)};
f.update=function(a){const {added:b,removed:d}=a;for(const c of d)l(c)&&this._layerViewState.has(c)&&this._deleteState(c);for(const c of b){if(a=l(c))a:if(c.layer&&c.layer.renderer)switch(c.layer.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dictionary":case "dot-density":a=!0;break a;default:n.error(new m("mapview-labeling",`Renderer of type ${c.layer.renderer.type} does not currently support labeling`)),a=!1}else a=!1;a&&!this._layerViewState.has(c)&&this._createState(c)}this._recomputeOrder()};
f.destroy=function(){this._layerViewState.forEach(a=>a.handles.forEach(b=>b.remove()))};f._createState=function(a){const b={priority:-1,handles:null};b.handles=[a.layer.watch("visible",this._recomputeOrder.bind(this)),a.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),a.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),a.layer.watch("featureReduction",this._recomputeOrder.bind(this))];this._layerViewState.set(a,b);return b};f._deleteState=function(a){if(this._layerViewState.has(a)){var b=
this._layerViewState.get(a);b.handles.forEach(d=>d.remove());-1!==b.priority&&this.unregisterLayer(a);this._layerViewState.delete(a)}};f._recomputeOrder=function(){this._layerViewState.forEach((a,b)=>{var d=b.view.map.allLayers.findIndex(p=>p.uid===b.layer.uid);const c=b.layer;var e=c.featureReduction;e=e&&"cluster"===e.type&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length;e=c.labelsVisible&&c.labelingInfo&&c.labelingInfo.length||e;d=c.visible&&e?4294967295-d:-1;d!==a.priority&&(a.priority=
d,this.unregisterLayer(b),-1!==d&&this.registerLayer(b,d))})};return g}();k.LayerViewSorter=h;Object.defineProperty(k,"__esModule",{value:!0})});