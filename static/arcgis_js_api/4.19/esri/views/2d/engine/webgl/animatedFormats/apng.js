// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","../../../../../core/promiseUtils"],function(r,u,x){function E(a,e=0,b=a.length-e){let c=-1;for(let d=e,g=e+b;d<g;d++)c=c>>>8^y[(c^a[d])&255];return c^-1}function z(a){const e=a.constructor===Uint8Array?a:new Uint8Array(a);return w.some((b,c)=>b!==e[c])?!1:!0}function F(a,e){const b=new Uint8Array(e);if(w.some((m,l)=>m!==b[l]))return G;let c=!1;v(b,m=>!(c="acTL"===m));if(!c)return A;const d=[],g=[];let f=null,h=null,n=0;v(b,(m,l,k,t)=>{const p=new DataView(l.buffer);
switch(m){case "IHDR":f=l.subarray(k+8,k+8+t);a.width=p.getUint32(k+8);a.height=p.getUint32(k+12);break;case "acTL":a.numPlays=p.getUint32(k+8+4);break;case "fcTL":h&&(a.frames.push(h),n++);h=new H;h.width=p.getUint32(k+8+4);h.height=p.getUint32(k+8+8);h.left=p.getUint32(k+8+12);h.top=p.getUint32(k+8+16);m=p.getUint16(k+8+20);l=p.getUint16(k+8+22);0===l&&(l=100);h.delay=1E3*m/l;10>=h.delay&&(h.delay=100);a.playTime+=h.delay;h.disposeOp=p.getUint8(k+8+24);h.blendOp=p.getUint8(k+8+25);h.dataParts=[];
0===n&&2===h.disposeOp&&(h.disposeOp=1);break;case "fdAT":h&&h.dataParts.push(l.subarray(k+8+4,k+8+t));break;case "IDAT":h&&h.dataParts.push(l.subarray(k+8,k+8+t));break;case "IEND":g.push(B(l,k,12+t));break;default:d.push(B(l,k,12+t))}});if(0===a.frames.length)return A;a.frameCount=a.frames.length;const I=new Blob(d),J=new Blob(g);a.frames.forEach(m=>{let l=[];l.push(w);f.set(C(m.width),0);f.set(C(m.height),4);l.push(D("IHDR",f));l.push(I);m.dataParts.forEach(k=>l.push(D("IDAT",k)));l.push(J);m.data=
new Blob(l,{type:"image/png"});delete m.dataParts;l=null});return a}function v(a,e){const b=new DataView(a.buffer);let c=8;let d,g;do{d=b.getUint32(c);var f=c+4;f=Array.prototype.slice.call(a.subarray(f,f+4));f=String.fromCharCode.apply(String,f);g=e(f,a,c,d);c+=12+d}while(!1!==g&&"IEND"!==f&&c<a.length)}function K(a){const e=new Uint8Array(a.length);for(let b=0;b<a.length;b++)e[b]=a.charCodeAt(b);return e}function B(a,e,b){const c=new Uint8Array(b);c.set(a.subarray(e,e+b));return c}function D(a,
e){const b=a.length+e.length,c=new Uint8Array(b+8),d=new DataView(c.buffer);d.setUint32(0,e.length);c.set(K(a),4);c.set(e,8);a=E(c,4,b);d.setUint32(b+4,a);return c}function C(a){return new Uint8Array([a>>>24&255,a>>>16&255,a>>>8&255,a&255])}const y=new Uint32Array(256);for(var q=0;256>q;q++){let a=q;for(let e=0;8>e;e++)a=0!==(a&1)?3988292384^a>>>1:a>>>1;y[q]=a}const G=new u("Not a PNG"),A=new u("Not an animated PNG"),w=new Uint8Array([137,80,78,71,13,10,26,10]);q=function(){function a(){this.playTime=
this.numPlays=this.height=this.width=0;this.frames=[];this.playing=this.paused=!1;this.playSpeed=1;this.currentFrameNumber=0;this._lastUsedFrame=-1}a.create=async function(b,c){const d=new a;try{await d._load(b,c)}catch(g){if(!x.isAbortError(g))return new u("invalid-resource",`Could not load PNG: ${g.message}`)}return d};var e=a.prototype;e.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())};e.pause=function(){this.paused=!0;this.playing=!1;clearTimeout(this.timerID)};e.togglePlay=
function(){this.paused||!this.playing?this.play():this.pause()};e.bindFrame=function(b,c,d){b.bindTexture(c,d);b=this.frameChanged();if(!b)return!1;d=this.currentFrame;const g=d.frameData,f=c.descriptor;(d.left||d.top||d.width!==f.width||d.height!==f.height)&&c.setData(null);c.updateData(0,d.left,d.top,d.width,d.height,g);this.updateUsedFrame();return b};e.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber};e.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber};
e._load=async function(b,c){try{const d=F(this,b);if(d!==this)return d;this._resizeCanvas=document.createElement("canvas");this._resizeCanvas.width=this.width;this._resizeCanvas.height=this.height;await Promise.all(this.frames.map(g=>g.createImage(this._resizeCanvas)))}catch(d){if(!x.isAbortError(d))return new u("invalid-resource","Could not parse PNG")}this.play()};e._play=function(){if(0===this.playSpeed)this.pause();else{if(0>this.playSpeed){--this.currentFrameNumber;0>this.currentFrameNumber&&
(this.currentFrameNumber=this.frames.length-1);var b=this.currentFrameNumber;--b;0>b&&(b=this.frames.length-1);b=-this.frames[b].delay/this.playSpeed}else this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,b=1*this.frames[this.currentFrameNumber].delay/this.playSpeed;var c=this.frames[this.currentFrameNumber];this.currentFrame={frameData:c.imageData,top:c.top,left:c.left,width:c.width,height:c.height};this.timerID=window.setTimeout(()=>this._play(),b)}};return a}();let H=function(){function a(){this.blendOp=
this.disposeOp=this.delay=this.height=this.width=this.top=this.left=0;this.imageData=this.data=null}a.prototype.createImage=async function(e){if(null===this.imageData)return new Promise((b,c)=>{const d=URL.createObjectURL(this.data),g=document.createElement("img");g.onload=()=>{URL.revokeObjectURL(d);{e.width=g.width;e.height=g.height;var f=e.getContext("2d");f.drawImage(g,0,0,g.width,g.height);f=f.getImageData(0,0,g.width,g.height);f=new Uint8Array(f.data);let h;for(let n=0;n<f.length;n+=4)h=f[n+
3]/255,f[n]*=h,f[n+1]*=h,f[n+2]*=h;f=new ImageData(new Uint8ClampedArray(f.buffer),g.width,g.height)}this.imageData=f;b()};g.onerror=()=>{URL.revokeObjectURL(d);this.imageData=null;c(Error("Image creation error"))};g.src=d})};return a}();r.default=q;r.getPNGSize=function(a){a=new Uint8Array(a);let e,b;v(a,(c,d,g)=>{d=new DataView(d.buffer);"IHDR"===c&&(e=d.getUint32(g+8),b=d.getUint32(g+12))});return[e,b]};r.isAnimatedPNG=function(a){a=new Uint8Array(a);if(!z(a))return!1;let e=!1;v(a,b=>!(e="acTL"===
b));return e};r.isPNG=z;Object.defineProperty(r,"__esModule",{value:!0})});