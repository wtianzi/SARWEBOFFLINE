// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../core/maybe ../../../../core/Logger ../../../../core/Error ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../request ../../../../chunks/vec2 ./definitions ../../../../chunks/vec2f32 ../../../support/QueueProcessor ./util/BidiText ../../../../symbols/cim/Rasterizer ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/Result ./util/symbolUtils".split(" "),
function(E,F,G,H,l,n,u,A,B,p,I,J,K,L,q,M,N,O,P,Q,v,w,x,R){function S(g){switch(g.type){case "CIMSolidStroke":case "CIMSolidFill":return!0;case "esriSFS":return"esriSFSSolid"===g.style||"esriSFSNull"===g.style;case "esriSLS":return"esriSLSSolid"===g.style||"esriSLSNull"===g.style;default:return!1}}function r(g){switch(g.type){case "esriSMS":case "esriPMS":case "CIMPointSymbol":case "CIMVectorMarker":case "CIMPictureMarker":case "CIMCharacterMarker":return!1;default:return!0}}async function T(g,f){g=
g.imageData?`data:${g.contentType};base64,${g.imageData}`:g.url;var a;if(-1!==g.indexOf(";base64,")){f=g.indexOf(";base64,")+8;f=g.substring(f);f=atob(f);g=new Uint8Array(f.length);for(a=0;a<f.length;a++)g[a]=f.charCodeAt(a);a=g.buffer}else try{const {data:b}=await A(g,{responseType:"array-buffer",...f});a=b}catch(b){if(!n.isAbortError(b))return new l("mapview-invalid-resource",`Could not fetch requested resource at ${g}`)}return a}function C(g,f){f=Math.round(u.pt2px(f)*window.devicePixelRatio);
return Math.min(g,f*(128<=f?2:4))}const D=I.create(),t=H.getLogger("esri.views.2d.engine.webgl.TextureManager");let U=function(){function g(f,a,b){this.mosaicType=f;this.page=a;this.sdf=b}g.fromMosaic=function(f,a){return new g(f,a.page,a.sdf)};return g}();return function(){function g(a){this._invalidFontsMap=new Map;this._sdfConverter=new P(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=new L;this._ongoingRasterizations=new Map;this._imageRequestQueue=new J.QueueProcessor({concurrency:10,
process:async(b,c)=>{n.throwIfAborted(c);try{return await A(b,{responseType:"image",signal:c})}catch(d){if(!n.isAbortError(d))throw new l("mapview-invalid-resource",`Could not fetch requested resource at ${b}`,d);throw d;}}});this._spriteMosaic=new Q(a,2048,2048,500);this._glyphSource=new O(`${F.fontsUrl}/{fontstack}/{range}.pbf`);this._glyphMosaic=new N(1024,1024,this._glyphSource)}var f=g.prototype;f.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();
this._sdfConverter.dispose();this._sdfConverter=this._rasterizer=this._glyphMosaic=this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=null;this._imageRequestQueue.clear();this._imageRequestQueue=null};f.rasterizeItem=async function(a,b,c,d){if(G.isNone(a))return t.error(new l("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "CIMTextSymbol":case "esriTS":return a=
await this._rasterizeText(a,c,d),a.forEach(e=>this._setTextureBinding(q.MosaicType.GLYPH,e)),{glyphMosaicItems:a};default:if(a.type&&-1!==a.type.toLowerCase().indexOf("3d"))return t.error(new l("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,a)),null;a=await this._rasterizeSpriteSymbol(a,b,d);x.ok(a)&&a&&this._setTextureBinding(q.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}};f.bindTextures=function(a,b,c,d=!1){if(0!==c.textureBinding){var e=this._bindingInfos[c.textureBinding-
1];c=e.page;d=d?9987:9729;switch(e.mosaicType){case q.MosaicType.SPRITE:{e=this.sprites.getWidth(c);const h=this.sprites.getHeight(c);e=B.set(D,e,h);this._spriteMosaic.bind(a,d,c,p.TEXTURE_BINDING_SPRITE_ATLAS);b.setUniform1i("u_texture",p.TEXTURE_BINDING_SPRITE_ATLAS);b.setUniform2fv("u_mosaicSize",e);break}case q.MosaicType.GLYPH:e=B.set(D,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(a,d,c,p.TEXTURE_BINDING_GLYPH_ATLAS);b.setUniform1i("u_texture",p.TEXTURE_BINDING_GLYPH_ATLAS);b.setUniform2fv("u_mosaicSize",
e);break;default:t.error("mapview-texture-manager",`Cannot handle unknown type ${e.mosaicType}`)}}};f._hashMosaic=function(a,b){return 1|a<<1|(b.sdf?1:0)<<2|b.page<<3};f._setTextureBinding=function(a,b){const c=this._hashMosaic(a,b);this._hashToBindingIndex.has(c)||(a=U.fromMosaic(a,b),this._hashToBindingIndex.set(c,this._bindingInfos.length+1),this._bindingInfos.push(a));b.textureBinding=this._hashToBindingIndex.get(c)};f._rasterizeText=async function(a,b,c){const d=M.getFullyQualifiedFontName(a.font),
e=this._invalidFontsMap.has(d);if(b)a=b;else{a=K.bidiText(a.text)[0];b=[];for(let h=0;h<a.length;h++)b.push(a.charCodeAt(h));a=b}try{return await this._glyphMosaic.getGlyphItems(e?"arial-unicode-ms-regular":d,a,c)}catch(h){return t.error(new l("mapview-invalid-resource",`Couldn't find font ${d}. Falling back to Arial Unicode MS Regular`,void 0)),this._invalidFontsMap.set(d,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",a,c)}};f._rasterizeSpriteSymbol=async function(a,b,c){if(S(a))return null;
const d=R.keyFromSymbol(a);if(this._spriteMosaic.has(d))return this._spriteMosaic.getSpriteItem(d);if("esriSMS"===a.type&&a.path||a.url||a.imageData)return this._handleAsyncResource(d,a,c);if(b=this._rasterizer.rasterizeJSONResource(a,b)){const {size:e,image:h,sdf:k,simplePattern:m}=b;return this._addItemToMosaic(d,e,{type:"static",data:h},r(a),k,m)}return new l("TextureManager","unrecognized or null rasterized image")};f._handleAsyncResource=async function(a,b,c){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);
b="esriSMS"===b.type&&b.path?this._handleSVG(b,a,c):this._handleImage(b,a,c);this._ongoingRasterizations.set(a,b);try{await b,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return b};f._handleSVG=async function(a,b,c){a=await this._sdfConverter.draw(a.path,c);return this._addItemToMosaic(b,[126,126],{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)};f._handleGIFOrPNG=async function(a,b,c){var d=await T(a,c);if(x.ok(d)){var e=w.isGIF(d);const h=v.isPNG(d);
if(!e&&!h)return new l("mapview-invalid-resource","Image data is neither GIF nor PNG!");let k;try{e&&w.isAnimatedGIF(d)?k=await w["default"].create(d,c):h&&v.isAnimatedPNG(d)&&(k=await v["default"].create(d,c))}catch(m){if(!n.isAbortError(m))return new l("mapview-invalid-resource","Could not fetch requested resource!")}if(k&&x.ok(k))return this._addItemToMosaic(b,[k.width,k.height],{type:"animated",data:k},r(a),!1,!1);c=new Blob([d],{type:e?"image/gif":"image/png"});if((c=await this._imageFromBlob(c))&&
c instanceof HTMLImageElement){d=c.width;e=c.height;"esriPMS"===a.type&&(d=Math.round(C(c.width,a.width)),e=Math.round(d/c.width*c.height));const {size:m,sdf:y,image:z}=this._rasterizer.rasterizeImageResource(d,e,c,a.colorSubstitutions);return this._addItemToMosaic(b,m,{type:"static",data:z},r(a),y,!1)}}return new l("mapview-invalid-resource","Could not handle resource!")};f._handleImage=async function(a,b,c){var d;(d=a.url&&-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||
a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(d=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));if(d)return this._handleGIFOrPNG(a,b,c);d=a.imageData?`data:${a.contentType};base64,${a.imageData}`:a.url;try{const {data:e}=await this._imageRequestQueue.push(d,{...c});-1!==d.indexOf("data:image/svg+xml")&&(e.width=u.pt2px(a.width),e.height=u.pt2px(a.height));let h=e.width,k=e.height;"esriPMS"===a.type&&
(h=Math.round(C(e.width,a.width)),k=Math.round(h/e.width*e.height));const {size:m,sdf:y,image:z}=this._rasterizer.rasterizeImageResource(h,k,e,a.colorSubstitutions);return this._addItemToMosaic(b,m,{type:"static",data:z},r(a),y,!1)}catch(e){if(!n.isAbortError(e))return new l("mapview-invalid-resource",`Could not fetch requested resource at ${d}. ${e.message}`)}};f._imageFromBlob=async function(a){a=window.URL.createObjectURL(a);try{const {data:b}=await this._imageRequestQueue.push(a);window.URL.revokeObjectURL(a);
return b}catch(b){window.URL.revokeObjectURL(a);if(!n.isAbortError(b))return new l("mapview-invalid-resource",`Could not fetch requested resource at ${a}`);throw b;}};f._addItemToMosaic=function(a,b,c,d,e,h){return this._spriteMosaic.addSpriteItem(a,b,c,d,e,h)};E._createClass(g,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return g}()});