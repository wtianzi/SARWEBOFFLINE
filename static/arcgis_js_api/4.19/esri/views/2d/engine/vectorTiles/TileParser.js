// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../../core/promiseUtils ../../../../core/pbf ../webgl/TileClipper ../../tiling/enums ./Feature ./IndexMemoryBuffer ./SourceLayerData ./VertexMemoryBuffer ./buckets/CircleBucket ./buckets/FillBucket ./buckets/LineBucket ./buckets/SymbolBucket".split(" "),function(y,z,w,A,B,t,C,u,D,E,F,G){return function(){function x(a,b,c,d,f){this._pbfTiles={};this._tileClippers={};this._client=c;this._tile=b;if(f){this._styleLayerUIDs=new Set;for(const h of f)this._styleLayerUIDs.add(h)}this._styleRepository=
d;this._layers=this._styleRepository.layers;const [g,p,v]=b.tileKey.split("/").map(parseFloat);this._level=g;b=Math.max(8,Math.round(1*this._level)-8);for(const h of Object.keys(a))c=a[h],this._pbfTiles[h]=new z(new Uint8Array(c.protobuff),new DataView(c.protobuff)),c.refKey&&([c]=c.refKey.split("/").map(parseFloat),c=g-c,0<c&&(d=(1<<c)-1,this._tileClippers[h]=new w.TileClipper(c,p&d,v&d,8,b))),this._tileClippers[h]||(this._tileClippers[h]=new w.SimpleBuilder)}var l=x.prototype;l._canParseStyleLayer=
function(a){return!this._styleLayerUIDs||this._styleLayerUIDs.has(a)};l.parse=async function(a){const b=this._initialize(a),{returnedBuckets:c}=b;this._processLayers(b);this._linkReferences(b);this._filterFeatures(b);const d=new Set,f={};for(const g of c)3===g.type&&g.getResources(g.tileClipper,d,f);if(this._tile.status===A.TileStatus.INVALID)return Promise.resolve([]);a=this._fetchResources(d,f,a);return Promise.all(a).then(()=>this._processFeatures(b.returnedBuckets))};l._initialize=function(a){a=
a&&a.signal;const b=this._parseTileData(this._pbfTiles),c=this._layers,d=this._level,f=this._tileClippers,g=new Map;return{signal:a,sourceNameToTileData:b,layers:c,zoom:d,sourceNameToTileClipper:f,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:g}};l._processLayers=function(a){const {sourceNameToTileData:b,layers:c,zoom:d,sourceNameToTileClipper:f,sourceNameToUniqueSourceLayerBuckets:g,sourceNameToUniqueSourceLayers:p,
returnedBuckets:v,layerIdToBucket:h,referencerUIDToReferencedId:r}=a;for(a=c.length-1;0<=a;a--){const e=c[a];if(!this._canParseStyleLayer(e.uid)||e.minzoom&&d<Math.floor(e.minzoom)||e.maxzoom&&d>=e.maxzoom||0===e.type)continue;if(!b[e.source]||!f[e.source])continue;var m=f[e.source];const q=e.sourceLayer;var n=b[e.source][q];if(n){var k=p[e.source];k||(k=p[e.source]=new Set);k.add(e.sourceLayer);if(e.refLayerId)r.set(e.uid,e.refLayerId);else if(k=this._createBucket(e))k.layerUIDs=[e.uid],k.layerExtent=
n.extent,k.tileClipper=m,(m=g[e.source])||(m=g[e.source]={}),(n=m[q])||(n=m[q]=[]),n.push(k),v.push(k),h[e.id.toLowerCase()]=k}}};l._linkReferences=function(a){const {layerIdToBucket:b,referencerUIDToReferencedId:c}=a;c.forEach((d,f)=>{d=d.toLowerCase();b[d]&&b[d].layerUIDs.push(f)})};l._filterFeatures=function(a){const {signal:b,sourceNameToTileData:c,sourceNameToUniqueSourceLayerBuckets:d,sourceNameToUniqueSourceLayers:f}=a;a=10*this._level;const g=10*(this._level+1),p=[],v=[];for(const n of Object.keys(f))f[n].forEach(k=>
{p.push(k);v.push(n)});for(let n=0;n<p.length;n++){var h=v[n],r=p[n];if(!c[h]||!d[h])continue;const k=c[h][r];if((h=d[h][r])&&0!==h.length){if(y.isAborted(b))break;for(r=k.getData();r.nextTag(2);){var m=r.getMessage();const e=new B(m,k);m.release();if(m=e.values){const q=m._minzoom;if(q&&q>=g)continue;if((m=m._maxzoom)&&m<=a)continue}for(const q of h)q.pushFeature(e)}}}};l._fetchResources=function(a,b,c){const d=[],f=this._tile.getWorkerTileHandler();0<a.size&&(a=f.fetchSprites(a,this._client,c),
d.push(a));for(const g in b)a=b[g],0<a.size&&(a=f.fetchGlyphs(this._tile.tileKey,g,a,this._client,c),d.push(a));return d};l._processFeatures=function(a){a=a.filter(b=>b.hasFeatures()||this._canParseStyleLayer(b.layer.uid));for(const b of a)b.processFeatures(b.tileClipper);return a};l._parseTileData=function(a){const b={};for(const c of Object.keys(a)){const d=a[c],f={};for(;d.next();)switch(d.tag()){case 3:{const g=d.getMessage(),p=new C(g);g.release();f[p.name]=p;break}default:d.skip()}b[c]=f}return b};
l._createBucket=function(a){switch(a.type){case 0:return null;case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 4:return this._createCircleBucket(a);case 3:return this._createSymbolBucket(a)}};l._createFillBucket=function(a){return new E(a,this._level,new u.FillVertexBuffer(a.fillMaterial.getStride()),new t.TriangleIndexBuffer,new u.OutlineVertexBuffer(a.outlineMaterial.getStride()),new t.TriangleIndexBuffer)};l._createLineBucket=function(a){return new F(a,this._level,
new u.LineVertexBuffer(a.lineMaterial.getStride()),new t.TriangleIndexBuffer)};l._createCircleBucket=function(a){return new D(a,this._level,new u.CircleVertexBuffer(a.circleMaterial.getStride()),new t.TriangleIndexBuffer)};l._createSymbolBucket=function(a){const b=this._tile;return new G(a,this._level,new u.SymbolVertexBuffer(a.iconMaterial.getStride()),new t.TriangleIndexBuffer,new u.SymbolVertexBuffer(a.textMaterial.getStride()),new t.TriangleIndexBuffer,b.placementEngine,b.getWorkerTileHandler())};
return x}()});