// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/PerformanceSampler ../../core/PooledArray ../../core/promiseUtils ../../core/Accessor ../../core/watchUtils ../../layers/support/PromiseQueue ./debugFlags".split(" "),
function(e,r,t,P,B,K,Q,v,R,C,S,T,U,D,w,E,F,L,M,N){function x(d){return d in y?y[d]:"number"===typeof d?d:1}const O=K.getLogger("esri.views.support.Scheduler");(function(d){d.REMOTE_CLIENT="worker messages";d.SLIDE="slide";d.STAGE="stage";d.STREAM_DATA_LOADER="stream loader";d.ELEVATION_QUERY="elevation query";d.TERRAIN_SURFACE="terrain";d.SURFACE_GEOMETRY_UPDATES="surface geometry updates";d.GRAPHICS_CORE="Graphics3D";d.I3S_CONTROLLER="I3S";d.POINT_CLOUD_LAYER="point cloud";d.FEATURE_TILE_FETCHER=
"feature fetcher";d.LABELER="labeler";d.GRAPHICS_DECONFLICTOR="graphics deconflictor";d.FILTER_VISIBILITY="Graphics3D filter visibility";d.FEATURE_QUERY_ENGINE="feature query";d.SCALE_VISIBILITY="Graphics3D scale visibility";d.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";d.POINT_OF_INTEREST_FREQUENT="POI frequent";d.POINT_OF_INTEREST_INFREQUENT="POI infrequent";d.FEATURE_TILE_TREE="feature tile tree";d.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";d.ELEVATION_ALIGNMENT="elevation alignment";
d.TEXT_TEXTURE_ATLAS="text texture atlas";d.TEXTURE_UNLOAD="texture unload";d.OVERLAY_MANAGER="overlay manager";d.LINE_OF_SIGHT_TOOL="line of sight tool";d.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool";d.ELEVATION_PROFILE="elevation profile";d.SNAPPING="snapping";d[d.TEST_PRIO=1]="TEST_PRIO"})(e.Task||(e.Task={}));const y={[e.Task.REMOTE_CLIENT]:0,[e.Task.SLIDE]:0,[e.Task.STREAM_DATA_LOADER]:0,[e.Task.ELEVATION_QUERY]:0,[e.Task.STAGE]:1,[e.Task.TERRAIN_SURFACE]:1,[e.Task.SURFACE_GEOMETRY_UPDATES]:1,
[e.Task.GRAPHICS_CORE]:2,[e.Task.I3S_CONTROLLER]:2,[e.Task.POINT_CLOUD_LAYER]:2,[e.Task.FEATURE_TILE_FETCHER]:2,[e.Task.LABELER]:8,[e.Task.GRAPHICS_DECONFLICTOR]:4,[e.Task.FILTER_VISIBILITY]:4,[e.Task.FEATURE_QUERY_ENGINE]:8,[e.Task.SCALE_VISIBILITY]:4,[e.Task.FRUSTUM_VISIBILITY]:4,[e.Task.POINT_OF_INTEREST_FREQUENT]:6,[e.Task.POINT_OF_INTEREST_INFREQUENT]:30,[e.Task.FEATURE_TILE_TREE]:16,[e.Task.FEATURE_TILE_TREE_ACTIVE]:0,[e.Task.ELEVATION_ALIGNMENT]:12,[e.Task.TEXT_TEXTURE_ATLAS]:12,[e.Task.TEXTURE_UNLOAD]:12,
[e.Task.OVERLAY_MANAGER]:12,[e.Task.LINE_OF_SIGHT_TOOL]:16,[e.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE]:0,[e.Task.SNAPPING]:0},G=1E3/30;var u;(function(d){let m=function(n){function k(a){var b=n.call(this,a)||this;b.updating=!0;b.performanceInfo={total:new D("total"),tasks:[]};b._budget=null;b._state=1;b._tasks=new w;b._runQueue=new w;b._load=0;b._idleStateCallbacks=new w;b._idleUpdatesStartFired=!1;b._maxReschedule=z;b._forceTask=!1;b._debug=!1;b._debugHandle=L.init(N,"SCHEDULER_LOG_SLOW_TASKS",g=>b._debug=
g);b._budget=new H(a.nowFunc);q.length=0;for(const g in e.Task)I.set(e.Task[g],b.performanceInfo.tasks.length),b.performanceInfo.tasks.push(new D(e.Task[g])),q.push(0);let c;const h=r._assertThisInitialized(b);b._test={get state(){return B.isNone(c)?h._state:c},set state(g){c=g},FRAME_SAFETY_BUDGET:6.5,INTERACTING_BUDGET:G,IDLE_BUDGET:100,get budget(){return h._budget.budget},usedBudget:0,updateTask:g=>b._updateTask(g),getState:g=>b._getState(g),getRuntime:g=>b._getRuntime(g),resetRuntimes:()=>b._resetRuntimes(),
getRunning:()=>b._getRunning()};return b}r._inheritsLoose(k,n);var f=k.prototype;f.destroy=function(){this._debugHandle&&this._debugHandle.remove()};f.registerTask=function(a,b,c){const h=x(a);a=new p(this,a,b,c,h);this._tasks.push(a);return a};f.registerIdleStateCallbacks=function(a,b){const c={idleBegin:a,idleEnd:b};this._idleStateCallbacks.push(c);2===this.state&&this._idleUpdatesStartFired&&c.idleBegin();const h=this;return{remove:()=>this._removeIdleStateCallbacks(c),set idleBegin(g){h._idleUpdatesStartFired&&
(c.idleEnd(),2===h._state&&g());c.idleBegin=g},set idleEnd(g){c.idleEnd=g}}};f.updateBudget=function(a){this._test.usedBudget=0;let b=6.5,c=a.frameDuration,h=1;switch(this.state){case 2:b=0;c=Math.max(100,a.frameDuration);h=30;break;case 1:c=Math.max(G,a.frameDuration)}c-=a.elapsedFrameTime+b;if(2!==this.state&&1>c&&!this._forceTask)return this._forceTask=!0,!1;c=Math.max(c,h);this._budget.reset(c,this.state);this._maxReschedule=z;this._updateLoad();return this._schedule()};f.frame=function(){this._forceTask=
!1;switch(this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(a=>a.idleBegin()));this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed};f._removeIdleStateCallbacks=function(a){this._idleUpdatesStartFired&&a.idleEnd();this._idleStateCallbacks.removeUnordered(a)};f.removeTask=function(a){this._tasks.removeUnordered(a);this._runQueue.removeUnordered(a)};f._updateTask=
function(a){this._tasks.forAll(b=>{b.name===a&&b.setPriority(a)})};f._getState=function(a){if(this._runQueue.some(c=>c.name===a))return e.TaskState.SCHEDULED;let b=e.TaskState.IDLE;this._tasks.forAll(c=>{c.name===a&&c.needsUpdate&&(1>=c.schedulePriority?b=e.TaskState.READY:b!==e.TaskState.READY&&(b=e.TaskState.WAITING))});return b};f._getRuntime=function(a){let b=0;this._tasks.forAll(c=>{c.name===a&&(b+=c.runtime)});return b};f._resetRuntimes=function(){this._tasks.forAll(a=>a.runtime=0)};f._getRunning=
function(){const a=new Map;this._tasks.forAll(c=>{c.needsUpdate&&a.set(c.name,(a.get(c.name)||0)+1)});if(0===a.size)return null;let b="";a.forEach((c,h)=>{b=1<c?b+` ${c}x ${h}`:b+` ${h}`});return b};f._runIdle=function(){this._run()};f._runInteracting=function(){this._run()};f._runAnimating=function(){this._run()};f._updateLoad=function(){const a=this._tasks.reduce((b,c)=>c.needsUpdate?++b:b,0);this._load=.9*this._load+a*(1-.9)};f._schedule=function(){if(0>=this._maxReschedule)return!1;this._runQueue.filterInPlace(a=>
{if(a.needsUpdate)return!0;a.schedulePriority=a.priority;return!1});for(this._tasks.forAll(a=>{0===a.priority&&a.needsUpdate&&!this._runQueue.some(b=>b===a)&&this._runQueue.unshift(a)});0===this._runQueue.length;){let a=!1,b=0;this._tasks.forAll(c=>{if(c.needsUpdate&&0!==c.schedulePriority&&0!==c.priority)switch(a=!0,b=Math.max(b,c.priority),c.schedulePriority){case 1:c.schedulePriority=0;this._runQueue.push(c);break;default:--c.schedulePriority}});if(!a)return this.updating=!1;this._maxReschedule===
z&&(this._maxReschedule=b);--this._maxReschedule}return this.updating=!0};f._run=function(){const a=this._budget.now();for(var b=0;b<q.length;++b)q[b]=0;do for(;0<this._runQueue.length;){var c=this._budget.now();b=this._runQueue.pop();this._budget.resetProgress();try{b.update(this._budget)}catch(h){O.error(`Exception in task "${b.name}"`,h)}b.schedulePriority=b.priority;c=this._budget.now()-c;b.runtime+=c;q[I.get(b.task)]+=c;this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",
b.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms");if(0>=this._budget.remaining){this._recordFrameTaskTimes(q,this._budget.now()-a);return}}while(this._schedule());this._recordFrameTaskTimes(q,this._budget.now()-a)};f._recordFrameTaskTimes=function(a,b){for(let c=0;c<a.length;++c)this.performanceInfo.tasks[c].record(a[c]);this.performanceInfo.total.record(b)};r._createClass(k,[{key:"now",get:function(){return this.nowFunc()}},{key:"load",get:function(){return this._load}},{key:"state",
get:function(){return B.isNone(this._test.state)?this._state:this._test.state},set:function(a){this._state!==a&&(this._state=a,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(b=>b.idleEnd())))}},{key:"test",get:function(){return this._test}}]);return k}(F);t.__decorate([v.property()],m.prototype,"updating",void 0);t.__decorate([v.property()],m.prototype,"nowFunc",void 0);m=t.__decorate([C.subclass("esri.views.support.Scheduler")],m);d.Scheduler=
m;let p=function(n){function k(a,b,c,h,g){var l=n.call(this,{})||this;l._scheduler=a;l.name=b;l.update=c;l._needsUpdateCB=h;l._priority=g;l.runtime=0;l._queue=new M;l.updating=!1;l.schedulePriority=l._priority;return l}r._inheritsLoose(k,n);var f=k.prototype;f.normalizeCtorArgs=function(){return{}};f.remove=function(){this.processQueue(J);this._scheduler.removeTask(this);this.schedule=A.schedule;this.reschedule=A.reschedule};f.setPriority=function(a){this.name=a;a=x(a);if(0===this._priority||0!==
this.schedulePriority)this.schedulePriority=a;this._priority=a};f.schedule=function(a,b){this.updating=!0;return this._queue.push(a,b)};f.reschedule=function(a,b){this.updating=!0;return this._queue.unshift(a,b)};f.processQueue=function(a){for(;!a.done&&this._queue.process();)a.madeProgress();this.updating=0<this._queue.length};r._createClass(k,[{key:"priority",get:function(){return this._priority}},{key:"task",get:function(){return this.name},set:function(a){this.setPriority(a)}},{key:"needsUpdate",
get:function(){return this.updating||this._needsUpdateCB()}}]);return k}(F);t.__decorate([v.property()],p.prototype,"updating",void 0);p=t.__decorate([C.subclass("esri.views.support.SchedulerTask")],p);let H=function(){function n(f){this.now=f;this._budget=this._begin=0;this._state=2;this._didWork=!1;this._enabled=!0}var k=n.prototype;k.run=function(f){if(this.done)return!1;!0===f()&&(this._didWork=!0);return!0};k.madeProgress=function(){this._didWork=!0};k.reset=function(f,a){this._begin=this.now();
this._budget=f;this._state=a;this._didWork=!1};k.resetProgress=function(){this._didWork=!1};r._createClass(n,[{key:"done",get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}},{key:"budget",get:function(){return this._budget}},{key:"state",get:function(){return this._state}},{key:"enabled",get:function(){return this._enabled},set:function(f){this._enabled=f}},{key:"remaining",get:function(){return Math.max(this._budget-this.elapsed,0)}},{key:"elapsed",get:function(){return this.now()-
this._begin}},{key:"hasProgressed",get:function(){return this._didWork}}]);return n}();d.Budget=H})(u||(u={}));(function(d){d.SCHEDULED="s";d.READY="r";d.WAITING="w";d.IDLE="i"})(e.TaskState||(e.TaskState={}));const J=(()=>{const d=new u.Budget(()=>performance.now());d.enabled=!1;return d})(),A=new (function(){function d(){}var m=d.prototype;m.remove=function(){};m.processQueue=function(){};m.schedule=function(p){return E.when(p())};m.reschedule=function(p){return E.when(p())};return d}()),z=Number.MAX_SAFE_INTEGER,
I=new Map,q=[];e.ImmediateTask=A;e.getTaskPriority=x;e.newScheduler=function(d){return new u.Scheduler({nowFunc:d})};e.noBudget=J;e.taskPriorities=y;Object.defineProperty(e,"__esModule",{value:!0})});