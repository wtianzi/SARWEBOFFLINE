// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../request ../Portal ../../renderers/support/styleUtils ./jsonContext ../../layers/support/lazyLayerLoader".split(" "),function(m,n,t,u,v,w,k){async function x(b,g){const a=b.instance,d=a.portalItem,{url:c,title:e}=d,f=w.createForItem(d);if("group"===a.type)return a.read({title:e},f),y(a,b);c&&a.read({url:c},f);(b=await p(b,g))&&a.read(b,f);a.resourceReferences={portalItem:d,paths:f.readResourcePaths};a.read({title:e},f);return v.loadStyleRenderer(a,f)}function y(b,
g){var a=b.portalItem.type;switch(a){case "Feature Service":a=k.layerLookupMap.FeatureLayer;break;case "Stream Service":a=k.layerLookupMap.StreamLayer;break;case "Scene Service":a=k.layerLookupMap.SceneLayer;break;case "Feature Collection":a=k.layerLookupMap.FeatureLayer;break;default:throw new n("portal:unsupported-item-type-as-group",`The item type '${a}' is not supported as a 'GroupLayer'`);}let d;return a().then(c=>{d=c;return p(g)}).then(c=>0<l(c)?q(b,d,c):z(b,d))}function z(b,g){return b.portalItem.url?
t(b.portalItem.url,{responseType:"json",query:{f:"json"}}).then(a=>{function d(f){return{id:f.id,name:f.name}}var c,e;(a=a.data)&&q(b,g,{layers:null==(c=a.layers)?void 0:c.map(d),tables:null==(e=a.tables)?void 0:e.map(d)})}):Promise.resolve()}function q(b,g,a){let d=a.layers||[];const c=a.tables||[];"Feature Collection"===b.portalItem.type&&(d.forEach(e=>{var f;"Table"===(null==e?void 0:null==(f=e.layerDefinition)?void 0:f.type)&&c.push(e)}),d=d.filter(e=>{var f;return"Table"!==(null==e?void 0:null==
(f=e.layerDefinition)?void 0:f.type)}));d.reverse().forEach(e=>{e=r(b,g,a,e);b.add(e)});c.reverse().forEach(e=>{e=r(b,g,a,e);b.tables.add(e)})}function r(b,g,a,d){g=new g({portalItem:b.portalItem.clone(),layerId:d.id,sublayerTitleMode:"service-name"});"Feature Collection"===b.portalItem.type&&(b={origin:"portal-item",portal:b.portalItem.portal||u.getDefault()},g.read(d,b),a=a.showLegend,null!=a&&g.read({showLegend:a},b));return g}function p(b,g){if(!1===b.supportsData)return Promise.resolve(void 0);
const a=b.instance;return a.portalItem.fetchData("json",g).catch(()=>null).then(d=>{var c;var e="stream"===a.type?!1:"layerId"in a;if(e){e=!0;if(d&&0<l(d)){null==a.layerId&&(c=(c=d.layers)&&c.length?c[0].id:(c=d.tables)&&c.length?c[0].id:null,a.layerId=c);a:{c=a.layerId;var f=d.layers;if(f)for(var h=0;h<f.length;h++)if(f[h].id===c){c=f[h];break a}if(f=d.tables)for(h=0;h<f.length;h++)if(f[h].id===c){c=f[h];break a}c=null}c&&(1===l(d)&&(e=!1),null!=d.showLegend&&(c.showLegend=d.showLegend))}e&&"service-name"!==
a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name");return c}return d})}function l(b){var g,a,d,c;const e=null!=(g=null==b?void 0:null==(a=b.layers)?void 0:a.length)?g:0;b=null!=(d=null==b?void 0:null==(c=b.tables)?void 0:c.length)?d:0;return e+b}m.load=async function(b,g){var a=b.instance.portalItem;if(!a||!a.id)return Promise.resolve();await a.load(g);a=b.instance.portalItem;if(-1===b.supportedTypes.indexOf(a.type))throw new n("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",
{type:a.type,expectedType:b.supportedTypes.join(", ")});return x(b,g)};Object.defineProperty(m,"__esModule",{value:!0})});