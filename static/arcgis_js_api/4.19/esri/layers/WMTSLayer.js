// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/lang ../core/object ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../geometry/Extent ../core/Collection ../request ../core/Handles ./Layer ../core/MultiOriginJSONSupport ./mixins/OperationalLayer ./mixins/BlendLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/TileInfo ./support/WMTSLayerInfo ./WebTileLayer ./support/WMTSSublayer ./support/wmtsUtils".split(" "),
function(n,f,e,u,z,R,S,k,T,l,A,B,v,C,U,V,D,E,w,x,F,G,H,I,J,K,L,M,N,O,p,r){function P(t,m){return t.map(g=>{const a=new p;a.read(g,m);return a})}const y={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},Q=new Set("version service request layer style format tilematrixset tilematrix tilerow tilecol".split(" "));e=function(t){function m(...a){var b=
t.call(this,...a)||this;b._sublayersHandles=new x;b.copyright="";b.customParameters=null;b.customLayerParameters=null;b.fullExtent=null;b.operationalLayerType="WebTiledLayer";b.resourceInfo=null;b.serviceMode="RESTful";b.sublayers=null;b.type="wmts";b.version="1.0.0";b.watch("activeLayer",(d,c)=>{c&&(c.layer=null);d&&(d.layer=n._assertThisInitialized(b))},!0);b.watch("sublayers",(d,c)=>{c&&(c.forEach(h=>{h.layer=null}),b._sublayersHandles.removeAll(),b._sublayersHandles=null);d&&(d.forEach(h=>{h.layer=
n._assertThisInitialized(b)}),b._sublayersHandles||(b._sublayersHandles=new x),b._sublayersHandles.add([d.on("after-add",({item:h})=>{h.layer=n._assertThisInitialized(b)}),d.on("after-remove",({item:h})=>{h.layer=null})]))},!0);return b}n._inheritsLoose(m,t);var g=m.prototype;g.normalizeCtorArgs=function(a,b){return"string"===typeof a?{url:a,...b}:a};g.load=function(a){if("KVP"!==this.serviceMode&&"RESTful"!==this.serviceMode)console.error("WMTS mode could only be 'KVP' or 'RESTful'");else return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},
a).then(()=>this._fetchService(a)).catch(b=>{throw new v("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:b});})),Promise.resolve(this)};g.readActiveLayerFromService=function(a,b,d){let c;this.activeLayer?b.layers.some(h=>h.id===this.activeLayer.id?(c=h,!0):!1):(this.activeLayer=new p,c=b.layers[0]);this.activeLayer.read(c,d);return this.activeLayer};g.readActiveLayerFromItemOrWebDoc=function(a,b){const {templateUrl:d,wmtsInfo:c}=b;a=d?this._getLowerCasedUrlParams(d):
null;b=c&&c.layerIdentifier;let h=null;const q=c&&c.tileMatrixSet;q&&(Array.isArray(q)?q.length&&(h=q[0]):h=q);return new p({id:b,imageFormat:a&&a.format,styleId:a&&a.style,tileMatrixSetId:h})};g.writeActiveLayer=function(a,b,d,c){a=this.activeLayer;b.templateUrl=this.getUrlTemplate(a.id,a.tileMatrixSetId,a.imageFormat,a.styleId);d=z.getDeepValue("tileMatrixSet.tileInfo",a);b.tileInfo=d?d.toJSON(c):null;b.wmtsInfo={...b.wmtsInfo,layerIdentifier:a.id,tileMatrixSet:a.tileMatrixSetId}};g.readCustomParameters=
function(a,b){return(a=b.wmtsInfo)?this._mergeParams(a.customParameters,a.url):null};g.readServiceMode=function(a,b){return-1<b.templateUrl.indexOf("?")?"KVP":"RESTful"};g.readSublayersFromService=function(a,b,d){return P(b.layers,d)};g.createWebTileLayer=function(a){const b=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),d=this._getTileMatrixSetById(a.tileMatrixSetId).tileInfo,c=a.fullExtent;a=new N["default"]({layerIdentifier:a.id,
tileMatrixSet:a.tileMatrixSetId,url:this.url});this.customLayerParameters&&(a.customLayerParameters=this.customLayerParameters);this.customParameters&&(a.customParameters=this.customParameters);return new O({fullExtent:c,urlTemplate:b,tileInfo:d,wmtsInfo:a})};g.fetchTile=function(a,b,d){a=this.getTileUrl(a,b,d);return w(a,{responseType:"image"}).then(c=>c.data)};g.findSublayerById=function(a){return this.sublayers.find(b=>b.id===a)};g.getTileUrl=function(a,b,d){var c=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId).tileInfo.lods[a];
a=c?c.levelValue?c.levelValue:`${c.level}`:`${a}`;(c=this.resourceInfo?"":r.getTileUrlFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,a,b,d))||(c=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replace(/\{level\}/gi,a).replace(/\{row\}/gi,`${b}`).replace(/\{col\}/gi,`${d}`));return c=this._appendCustomLayerParameters(c)};
g.getUrlTemplate=function(a,b,d,c){if(!this.resourceInfo){var h=r.getTileUrlTemplateFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},a,b,c);if(h)return h}return"KVP"===this.serviceMode?this.url+"?SERVICE\x3dWMTS\x26VERSION\x3d"+this.version+"\x26REQUEST\x3dGetTile\x26LAYER\x3d"+a+"\x26STYLE\x3d"+c+"\x26FORMAT\x3d"+d+"\x26TILEMATRIXSET\x3d"+b+"\x26TILEMATRIX\x3d{level}\x26TILEROW\x3d{row}\x26TILECOL\x3d{col}":"RESTful"===this.serviceMode?(h="",y[d.toLowerCase()]&&(h=y[d.toLowerCase()]),
this.url+a+"/"+c+"/"+b+"/{level}/{row}/{col}"+h):""};g._fetchService=async function(a){let b;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=-1<this.url.indexOf("?")?"":"?"),b={ssl:!1,data:this.resourceInfo};else try{b=await this._getCapabilities(this.serviceMode,a)}catch{const d="KVP"===this.serviceMode?"RESTful":"KVP";try{b=await this._getCapabilities(d,a),this.serviceMode=d}catch(c){throw new v("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",
{error:c});}}b.data=this.resourceInfo?r.parseResourceInfo(b.data):r.parseCapabilities(b.data,{serviceMode:this.serviceMode,url:this.url});b.data&&this.read(b.data,{origin:"service"})};g._getCapabilities=async function(a,b){a=this._getCapabilitiesUrl(a);return await w(a,{...b,responseType:"text"})};g._getTileMatrixSetById=function(a){return this.findSublayerById(this.activeLayer.id).tileMatrixSets.find(b=>b.id===a)};g._appendCustomParameters=function(a){if(this.customParameters)for(const b in this.customParameters)a+=
(-1===a.indexOf("?")?"?":"\x26")+b+"\x3d"+encodeURIComponent(this.customParameters[b]);return a};g._appendCustomLayerParameters=function(a){if(this.customLayerParameters||this.customParameters){const b={...u.clone(this.customParameters),...this.customLayerParameters};for(const d in b)a+=(-1===a.indexOf("?")?"?":"\x26")+d+"\x3d"+encodeURIComponent(b[d])}return a};g._getCapabilitiesUrl=function(a){let b;this.url=this.url.split("?")[0];"KVP"===a?b=this.url+"?request\x3dGetCapabilities\x26service\x3dWMTS\x26version\x3d"+
this.version:"RESTful"===a&&(b=this.url+"/"+this.version+"/WMTSCapabilities.xml");return b=this._appendCustomParameters(b)};g._getLowerCasedUrlParams=function(a){if(!a)return null;const b=C.urlToObject(a).query;if(!b)return null;const d={};Object.keys(b).forEach(c=>{d[c.toLowerCase()]=b[c]});return d};g._mergeParams=function(a,b){const d=this._getLowerCasedUrlParams(b);d&&(b=Object.keys(d),b.length&&(a=a?u.clone(a):{},b.forEach(c=>{a.hasOwnProperty(c)||Q.has(c)||(a[c]=d[c])})));return a};n._createClass(m,
[{key:"activeLayer",get:function(){return this._get("activeLayer")},set:function(a){this._set("activeLayer",a)}},{key:"fullExtents",get:function(){const a=[];this.activeLayer.tileMatrixSets.forEach(b=>{b.fullExtent&&a.push(b.fullExtent)});return a}},{key:"supportedSpatialReferences",get:function(){return this.activeLayer.tileMatrixSets.map(a=>a.tileInfo.spatialReference).toArray()}},{key:"title",get:function(){var a,b;return null!=(a=null==(b=this.activeLayer)?void 0:b.title)?a:"Layer"},set:function(a){a?
this._override("title",a):this._clearOverride("title")}},{key:"url",get:function(){return this._get("url")},set:function(a){a&&"/"===a.substr(-1)?this._set("url",a.slice(0,-1)):this._set("url",a)}}]);return m}(I.BlendLayer(K.RefreshableLayer(L.ScaleRangeLayer(H.OperationalLayer(J.PortalLayer(G.MultiOriginJSONMixin(F)))))));f.__decorate([k.property()],e.prototype,"dimensionMap",void 0);f.__decorate([k.property()],e.prototype,"layerMap",void 0);f.__decorate([k.property({type:p,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],
e.prototype,"activeLayer",null);f.__decorate([l.reader("service","activeLayer",["layers"])],e.prototype,"readActiveLayerFromService",null);f.__decorate([l.reader(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],e.prototype,"readActiveLayerFromItemOrWebDoc",null);f.__decorate([B.writer(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:M},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],e.prototype,"writeActiveLayer",
null);f.__decorate([k.property({type:String,value:"",json:{write:!0}})],e.prototype,"copyright",void 0);f.__decorate([k.property({type:["show","hide"]})],e.prototype,"listMode",void 0);f.__decorate([k.property({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],e.prototype,"customParameters",void 0);
f.__decorate([l.reader("web-document","customParameters"),l.reader("portal-item","customParameters")],e.prototype,"readCustomParameters",null);f.__decorate([k.property({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],e.prototype,"customLayerParameters",void 0);f.__decorate([k.property({type:D,json:{write:{ignoreOrigin:!0},
origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],e.prototype,"fullExtent",void 0);f.__decorate([k.property({readOnly:!0})],e.prototype,"fullExtents",null);f.__decorate([k.property({type:["WebTiledLayer"]})],e.prototype,"operationalLayerType",void 0);f.__decorate([k.property()],e.prototype,"resourceInfo",void 0);f.__decorate([k.property()],e.prototype,"serviceMode",void 0);f.__decorate([l.reader(["portal-item","web-document"],"serviceMode",["templateUrl"])],
e.prototype,"readServiceMode",null);f.__decorate([k.property({type:E.ofType(p)})],e.prototype,"sublayers",void 0);f.__decorate([l.reader("service","sublayers",["layers"])],e.prototype,"readSublayersFromService",null);f.__decorate([k.property({readOnly:!0})],e.prototype,"supportedSpatialReferences",null);f.__decorate([k.property({json:{read:{source:"title"}}})],e.prototype,"title",null);f.__decorate([k.property({json:{read:!1},readOnly:!0,value:"wmts"})],e.prototype,"type",void 0);f.__decorate([k.property({json:{origins:{service:{read:{source:"tileUrl"}},
"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],e.prototype,"url",null);f.__decorate([k.property()],e.prototype,"version",void 0);return e=f.__decorate([A.subclass("esri.layers.WMTSLayer")],e)});