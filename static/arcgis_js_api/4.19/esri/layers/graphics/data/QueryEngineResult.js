// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ../../../geometry/support/quantizationUtils ./projectionSupport ./attributeSupport ./AttributesBuilder ./utils ./timeSupport".split(" "),function(R,J,F,S,N,K,T,L,C,U){function O(k){return k.substr(24,12)+k.substr(19,4)+k.substr(16,2)+k.substr(14,2)+k.substr(11,2)+k.substr(9,2)+k.substr(6,2)+k.substr(4,2)+k.substr(2,2)+k.substr(0,2)}function P(k,h,a,b){if(a&&
"esriFieldTypeDate"===a.type){const c=(new Date(k)).getTime(),d=(new Date(h)).getTime();if(!isNaN(c)&&!isNaN(d))return b?d-c:c-d}return"number"===typeof k&&"number"===typeof h?b?h-k:k-h:"string"===typeof k&&"string"===typeof h?(k=k.toUpperCase(),h=h.toUpperCase(),!a||"esriFieldTypeGUID"!==a.type&&"esriFieldTypeGlobalID"!==a.type?b=(b?k>h:k<h)?-1:(b?k<h:k>h)?1:0:(a=O(k),h=O(h),b=(b?a>h:a<h)?-1:(b?a<h:a>h)?1:0),b):b?1:-1}function V(k,h,a,b,c,d){c-=a;d-=b;k=Math.min(1,Math.max(0,((k-a)*c+(h-b)*d)/(c*
c+d*d)));return{x:a+c*k,y:b+d*k}}function W(k,h){return k?h?4:3:h?3:2}return function(){function k(a,b,c){this.items=a;this.queryGeometry=b;this.definitionExpression=c.definitionExpression;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.fieldsIndex=c.fieldsIndex;this.timeInfo=c.timeInfo;this.featureAdapter=c.featureAdapter;this.aggregateAdapter=c.aggregateAdapter}var h=k.prototype;h.createQueryResponseForCount=
function(a){const b=new L(a,this.featureAdapter,this.fieldsIndex);if(!a.outStatistics)return b.countDistinctValues(this.items);const {groupByFieldsForStatistics:c,having:d}=a;if(null==c||!c.length)return 1;const e=new Map,f=new Map,n=new Set;a=a.outStatistics;for(const g of a){({statisticType:a}=g);a="exceedslimit"!==a?g.onStatisticField:void 0;if(!f.has(a)){var l=[];for(const m of c){const p=this._getAttributeValues(b,m,e);l.push(p)}f.set(a,this._calculateUniqueValues(l))}a=f.get(a);for(const m in a){const {data:p,
items:u}=a[m];l=p.join(",");d&&!b.validateItems(u,d)||n.add(l)}}return n.size};h.createQueryResponse=function(a){let b;b=a.outStatistics?a.outStatistics.some(c=>"exceedslimit"===c.statisticType)?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(F.isValid(a.outSR)&&!F.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=C.cleanFromGeometryEngine({spatialReference:a.outSR,...K.project(this.queryGeometry,
this.queryGeometry.spatialReference,a.outSR)}):b.queryGeometry=C.cleanFromGeometryEngine({spatialReference:a.outSR,...this.queryGeometry}));return b};h.createSnappingResponse=function(a,b){const c=this.featureAdapter,d=W(this.hasZ,this.hasM),{x:e,y:f}=a.point,n="number"===typeof a.distance?a.distance:a.distance.x,l="number"===typeof a.distance?a.distance:a.distance.y,g={candidates:[]},m="esriGeometryPolygon"===this.geometryType;b=this.getPointCreator(a.point,this.spatialReference,b);for(const v of this.items){var p=
c.getGeometry(v);if(!p)continue;const {coords:q,lengths:w}=p;if(a.types&1){p=0;for(var u=0;u<w.length;u++){var x=w[u];for(var z=0;z<x;z++,p+=d){var y=q[p],t=q[p+1];if(z!==x-1){const A=q[p+d],B=q[p+d+1],{x:E,y:G}=V(e,f,y,t,A,B);var r=(e-E)/n;const D=(f-G)/l;r=r*r+D*D;1>=r&&g.candidates.push({type:"edge",objectId:c.getObjectId(v),distance:Math.sqrt(r),target:b(E,G),start:b(y,t),end:b(A,B)})}}}}if(a.types&2)for(p=m?q.length-d:q.length,u=0;u<p;u+=d)x=q[u],z=q[u+1],y=(e-x)/n,t=(f-z)/l,y=y*y+t*t,1>=y&&
g.candidates.push({type:"vertex",objectId:c.getObjectId(v),distance:Math.sqrt(y),target:b(x,z)})}g.candidates.sort((v,q)=>v.distance-q.distance);return g};h.getPointCreator=function(a,b,c){const d=J.isSome(c)&&!F.equals(b,c)?e=>K.project(e,b,c):e=>e;return null!=a.z&&null!=a.m?(e,f)=>d({x:e,y:f,z:a.z,m:a.m}):null!=a.z?(e,f)=>d({x:e,y:f,z:a.z}):null!=a.m?(e,f)=>d({x:e,y:f,m:a.m}):(e,f)=>d({x:e,y:f})};h.executeAttributesQuery=function(a){var b=T.getWhereClause(a.where,this.fieldsIndex);if(!b)return Promise.resolve(this);
if(b.isStandardized){let c=0;const d=[];for(const e of this.items)b.testFeature(e,this.featureAdapter)&&(d[c++]=e);b=new k(d,this.queryGeometry,this);b.definitionExpression=a.where;return Promise.resolve(b)}return Promise.reject(new TypeError("Where clause is not standardized"))};h.executeAggregateIdsQuery=function(a){if(!a.aggregateIds||!a.aggregateIds.length||J.isNone(this.aggregateAdapter))return Promise.resolve(this);const b=new Set;for(const d of a.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>
b.add(e));const c=this.featureAdapter.getObjectId;return Promise.resolve(new k(this.items.filter(d=>b.has(c(d))),this.queryGeometry,this))};h.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return Promise.resolve(this);const b=new Set(a.objectIds),c=this.featureAdapter.getObjectId;return Promise.resolve(new k(this.items.filter(d=>b.has(c(d))),this.queryGeometry,this))};h.executeTimeQuery=function(a){a=U.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!J.isSome(a))return Promise.resolve(this);
a=this.items.filter(a);return Promise.resolve(new k(a,this.queryGeometry,this))};h.filterLatest=function(){const {trackIdField:a,startTimeField:b,endTimeField:c}=this.timeInfo;var d=c||b;const e=new Map,f=this.featureAdapter.getAttribute;for(const n of this.items){const l=f(n,a),g=f(n,d),m=e.get(l);(!m||g>f(m,d))&&e.set(l,n)}d=Array.from(e.values());return Promise.resolve(new k(d,this.queryGeometry,this))};h.project=async function(a){if(!a||F.equals(this.spatialReference,a))return this;const b=this.featureAdapter,
c=(await K.projectMany(this.items.map(d=>C.getGeometry(this.geometryType,this.hasZ,this.hasM,b.getGeometry(d))),this.spatialReference,a)).map((d,e)=>b.cloneWithGeometry(this.items[e],S.convertFromGeometry(d,this.hasZ,this.hasM)));return new k(c,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})};
h._sortFeatures=function(a,b,c){if(1<a.length&&b&&b.length)for(const d of b.reverse()){b=d.split(" ");const e=b[0],f=this.fieldsIndex.get(e),n=b[1]&&"desc"===b[1].toLowerCase();a.sort((l,g)=>{l=c(l,e,f);g=c(g,e,f);return P(l,g,f,n)})}};h._createFeatureQueryResponse=function(a){const b=this.items,{geometryType:c,hasM:d,hasZ:e,objectIdField:f,spatialReference:n}=this,{outFields:l,outSR:g,quantizationParameters:m,resultRecordCount:p,resultOffset:u,returnZ:x,returnM:z}=a,y=null!=p?b.length>(u||0)+p:!1,
t=l&&(-1<l.indexOf("*")?[...this.fieldsIndex.fields]:l.map(r=>this.fieldsIndex.get(r)));return{exceededTransferLimit:y,features:this._createFeatures(a,b),fields:t,geometryType:c,hasM:d&&z,hasZ:e&&x,objectIdFieldName:f,spatialReference:C.cleanFromGeometryEngine(g?g:n),transform:m&&N.toQuantizationTransform(m)||null}};h._createFeatures=function(a,b){const c=new L(a,this.featureAdapter,this.fieldsIndex),{hasM:d,hasZ:e}=this,{orderByFields:f,quantizationParameters:n,returnGeometry:l,returnCentroid:g,
maxAllowableOffset:m,resultOffset:p,resultRecordCount:u,returnZ:x=!1,returnM:z=!1}=a,y=e&&x,t=d&&z;a=[];var r=0;b=[...b];this._sortFeatures(b,f,(w,A,B)=>c.getFieldValue(w,A,B));if(l||g){var v=N.toQuantizationTransform(n);if(l&&!g)for(var q of b)a[r++]={attributes:c.getAttributes(q),geometry:C.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(q),m,v,y,t)};else if(!l&&g)for(const w of b)a[r++]={attributes:c.getAttributes(w),centroid:C.transformCentroid(this,this.featureAdapter.getCentroid(w,
this),v)};else for(const w of b)a[r++]={attributes:c.getAttributes(w),centroid:C.transformCentroid(this,this.featureAdapter.getCentroid(w,this),v),geometry:C.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(w),m,v,y,t)}}else for(v of b)(q=c.getAttributes(v))&&(a[r++]={attributes:q});r=p||0;null!=u&&(a=a.slice(r,Math.min(a.length,r+u)));return a};h._createExceedsLimitQueryResponse=function(a){var b=!1;let c=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY;b=Number.POSITIVE_INFINITY;
for(const e of a.outStatistics)if("exceedslimit"===e.statisticType){c=null!=e.maxPointCount?e.maxPointCount:Number.POSITIVE_INFINITY;d=null!=e.maxRecordCount?e.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=e.maxVertexCount?e.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)b=this.items.length>c;else if(this.items.length>d)b=!0;else{a=this.hasZ?this.hasM?4:3:this.hasM?3:2;const e=this.featureAdapter;b=this.items.reduce((f,n)=>{n=e.getGeometry(n);return f+(n&&
n.coords.length||0)},0)/a>b}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};h._createStatisticsQueryResponse=function(a){var b={attributes:{}};const c=[],d=new Map,e=new Map,f=new Map,n=new Map,l=new L(a,this.featureAdapter,this.fieldsIndex);var g=a.outStatistics;const {groupByFieldsForStatistics:m,having:p,orderByFields:u}=a;a=m&&m.length;const x=!!a,z=
x&&m[0],y=x&&!this.fieldsIndex.get(z);for(const w of g){const {outStatisticFieldName:A,statisticType:B}=w;g=w;var t="exceedslimit"!==B?w.onStatisticField:void 0;const E="percentile_disc"===B||"percentile_cont"===B,G=x&&1===a&&(t===z||y)&&"count"===B;if(x){if(!f.has(t)){var r=[];for(const D of m){var v=this._getAttributeValues(l,D,d);r.push(v)}f.set(t,this._calculateUniqueValues(r,l.returnDistinctValues))}r=f.get(t);for(const D in r){const {count:X,data:Q,items:Y,itemPositions:Z}=r[D];v=Q.join(",");
if(!p||l.validateItems(Y,p)){const M=n.get(v)||{attributes:{}};var q=null;if(G)q=X;else{const H=this._getAttributeValues(l,t,d);q=Z.map(I=>H[I]);q=E&&"statisticParameters"in g?this._getPercentileValue(g,q):this._getStatisticValue(g,q)}M.attributes[A]=q;m.forEach((H,I)=>M.attributes[this.fieldsIndex.get(H)?H:`EXPR_${I+1}`]=Q[I]);n.set(v,M)}}}else t=this._getAttributeValues(l,t,d),b.attributes[A]=E&&"statisticParameters"in g?this._getPercentileValue(g,t):this._getStatisticValue(g,t,e);c.push({name:A,
alias:A,type:"esriFieldTypeDouble"})}b=x?Array.from(n.values()):[b];this._sortFeatures(b,u,(w,A)=>w.attributes[A]);return{fields:c,features:b}};h._getStatisticValue=function(a,b,c){const {onStatisticField:d,statisticType:e}=a;a=c&&c.has(d)?c.get(d):this._calculateStatistics(b);c&&c.set(d,a);return a["var"===e?"variance":e]};h._getPercentileValue=function(a,b){const {onStatisticField:c,statisticParameters:d,statisticType:e}=a,{value:f,orderBy:n}=d,l="desc"===n,g=this.fieldsIndex.get(c);a=[...b].filter(m=>
null!=m).sort((m,p)=>P(m,p,g,l));return this._calculatePercentile(a,f,"percentile_disc"===e)};h._getAttributeValues=function(a,b,c){if(c.has(b))return c.get(b);const d=this.fieldsIndex.get(b),e=this.items.map(f=>a.getFieldValue(f,b,d));c.set(b,e);return e};h._calculateStatistics=function(a){let b=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,d=null,e=null,f=null,n=null;const l=[];let g=0;for(const m of a)"string"===typeof m?g++:null==m||isNaN(m)||(d+=m,b=Math.min(b,m),c=Math.max(c,m),l.push(m),
g++);if(g){e=d/g;a=0;for(const m of l)a+=(m-e)**2;n=1<g?a/(g-1):0;f=Math.sqrt(n)}else c=b=null;return{avg:e,count:g,max:c,min:b,stddev:f,sum:d,variance:n}};h._calculateUniqueValues=function(a,b){const c={},d=this.items,e=d.length;for(let f=0;f<e;f++){const n=d[f],l=[];for(const m of a)l.push(m[f]);const g=l.join(",");b?null==c[g]&&(c[g]={count:1,data:l,items:[n],itemPositions:[f]}):null==c[g]?c[g]={count:1,data:l,items:[n],itemPositions:[f]}:(c[g].count++,c[g].items.push(n),c[g].itemPositions.push(f))}return c};
h._calculatePercentile=function(a,b,c){if(0===a.length)return null;if(0>=b)return a[0];if(1<=b)return a[a.length-1];var d=(a.length-1)*b,e=Math.floor(d);b=e+1;d%=1;e=a[e];const f=a[b];return b>=a.length||c||"string"===typeof e||"string"===typeof f?e:e*(1-d)+f*d};R._createClass(k,[{key:"size",get:function(){return this.items.length}}]);return k}()});