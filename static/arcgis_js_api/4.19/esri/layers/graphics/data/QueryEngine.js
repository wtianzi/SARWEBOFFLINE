// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/lang ../../../core/maybe ../../../core/Error ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../core/unitUtils ../../../geometry/support/normalizeUtils ../../../core/MemCache ../../../geometry/support/aaBoundingRect ../../support/PromiseQueue ../../support/FieldsIndex ./QueryEngineCapabilities ../../../geometry/support/aaBoundingBox ./projectionSupport ./attributeSupport ./utils ./spatialQuerySupport ./timeSupport ./QueryEngineResult".split(" "),
function(G,Q,x,H,w,I,R,C,J,N,O,K,S,T,U,y,z,u,p,A,V,t){function W(v){return v.every(h=>"exceedslimit"!==h.statisticType)}const D=new Set,X=new O.MemCacheStorage(2E6);let Y=0,ba=function(){function v(b){this.capabilities={query:U.queryCapabilities};this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.definitionExpression=b.definitionExpression;this.featureStore=b.featureStore;this.aggregateAdapter=b.aggregateAdapter;
this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=b.timeInfo;b.cacheSpatialQueries&&(this._geometryQueryCache=new O.MemCache(Y++ +"$$",X));this.fieldsIndex=new T(b.fields);b.scheduler&&b.task&&(this._frameQueue=new S,this._frameTask=b.scheduler.registerTask(b.task,a=>this._update(a),()=>0<this._frameQueue.length))}var h=v.prototype;h.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=
null);this.clearCache();this._geometryQueryCache&&this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};h.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};h.executeQuery=async function(b={},a){let c=x.clone(b),d;try{c=await this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),a),c=await this._reschedule(()=>this._checkQuerySupport(c),
a),d=await this._reschedule(()=>this._executeGeometryQuery(c,a),a),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),a),d=await this._reschedule(()=>d.executeObjectIdsQuery(c),a),d=await this._reschedule(()=>d.executeTimeQuery(c),a),d=await this._reschedule(()=>d.executeAttributesQuery(c),a)}catch(f){if(f!==p.QUERY_ENGINE_EMPTY_RESULT)throw f;d=new t([],null,this)}return d.createQueryResponse(c)};h.executeQueryForCount=async function(b={},a){let c=x.clone(b),d;c.returnGeometry=!1;c.returnCentroid=
!1;c.outSR=null;try{c=await this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),a),c=await this._reschedule(()=>this._checkQuerySupport(c),a),d=await this._reschedule(()=>this._executeGeometryQuery(c,a),a),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),a),d=await this._reschedule(()=>d.executeObjectIdsQuery(c),a),d=await this._reschedule(()=>d.executeTimeQuery(c),a),d=await this._reschedule(()=>d.executeAttributesQuery(c),a)}catch(f){if(f!==p.QUERY_ENGINE_EMPTY_RESULT)throw f;
return 0}return d.createQueryResponseForCount(c)};h.executeQueryForExtent=async function(b={},a){let c=x.clone(b),d;b=c.outSR;try{c=await this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),a);c=await this._reschedule(()=>this._checkQuerySupport(c),a);c.returnGeometry=!0;c.returnCentroid=!1;c.outSR=null;d=await this._reschedule(()=>this._executeGeometryQuery(c,a),a);d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),a);d=await this._reschedule(()=>d.executeObjectIdsQuery(c),
a);d=await this._reschedule(()=>d.executeTimeQuery(c),a);d=await this._reschedule(()=>d.executeAttributesQuery(c),a);const f=d.size;if(!f)return{count:f,extent:null};y.set(r,y.NEGATIVE_INFINITY);this.featureStore.forEachBounds(d.items,g=>y.expandWithAABB(r,g),Z);const k={xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(r[2])&&isFinite(r[5])&&(k.zmin=r[2],k.zmax=r[5]);const e=z.project(k,d.spatialReference,b);e.spatialReference=
p.cleanFromGeometryEngine(b||this.spatialReference);if(0===e.xmax-e.xmin){const g=J.getMetersPerUnitForSR(e.spatialReference);e.xmin-=g;e.xmax+=g}if(0===e.ymax-e.ymin){const g=J.getMetersPerUnitForSR(e.spatialReference);e.ymin-=g;e.ymax+=g}if(this.hasZ&&null!=e.zmin&&null!=e.zmax&&0===e.zmax-e.zmin){const g=J.getMetersPerUnitForSR(e.spatialReference);e.zmin-=g;e.zmax+=g}return{count:f,extent:e}}catch(f){if(f===p.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw f;}};h.executeQueryForIds=
async function(b={},a){return this.executeQueryForIdSet(b,a).then(c=>Array.from(c))};h.executeQueryForIdSet=async function(b={},a){let c=x.clone(b),d;c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;try{c=await this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),a);c=await this._reschedule(()=>this._checkQuerySupport(c),a);d=await this._reschedule(()=>this._executeGeometryQuery(c,a),a);d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),a);d=await this._reschedule(()=>
d.executeObjectIdsQuery(c),a);d=await this._reschedule(()=>d.executeTimeQuery(c),a);d=await this._reschedule(()=>d.executeAttributesQuery(c),a);const f=d.items,k=new Set;await this._reschedule(()=>{for(const e of f)k.add(d.featureAdapter.getObjectId(e))},a);return k}catch(f){if(f===p.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw f;}};h.executeQueryForSnapping=async function(b,a){const {point:c,distance:d,types:f}=b;if(0===f)return{candidates:[]};const k=await this._reschedule(()=>this._checkQuerySupport(b.query),
a),e=!I.equals(c.spatialReference,this.spatialReference);e&&await z.checkProjectionSupport(c.spatialReference,this.spatialReference);var g="number"===typeof d?d:d.x,m="number"===typeof d?d:d.y;g={xmin:c.x-g,xmax:c.x+g,ymin:c.y-m,ymax:c.y+m,spatialReference:c.spatialReference};g=e?z.project(g,this.spatialReference):g;if(!g)return{candidates:[]};m=(await N.normalizeCentralMeridian(C.fromJSON(c),null,{signal:a}))[0];const q=(await N.normalizeCentralMeridian(C.fromJSON(g),null,{signal:a}))[0];if(H.isNone(m)||
H.isNone(q))return{candidates:[]};let l=new t(this._searchFeatures(this._getQueryBBoxes(q.toJSON())),null,this);l=await this._reschedule(()=>l.executeObjectIdsQuery(k),a);l=await this._reschedule(()=>l.executeTimeQuery(k),a);l=await this._reschedule(()=>l.executeAttributesQuery(k),a);a=m.toJSON();a=e?z.project(a,this.spatialReference):a;return l.createSnappingResponse({...b,point:a,distance:e?Math.max(g.xmax-g.xmin,g.ymax-g.ymin)/2:d},c.spatialReference)};h.executeQueryForLatestObservations=async function(b=
{},a){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new w("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:b,timeInfo:this.timeInfo});let c=x.clone(b),d;try{c=await this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),a),c=await this._reschedule(()=>this._checkQuerySupport(c),a),d=await this._reschedule(()=>this._executeGeometryQuery(c,a),a),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),a),d=await this._reschedule(()=>
d.executeObjectIdsQuery(c),a),d=await this._reschedule(()=>d.executeTimeQuery(c),a),d=await this._reschedule(()=>d.executeAttributesQuery(c),a),d=await this._reschedule(()=>d.filterLatest(),a)}catch(f){if(f!==p.QUERY_ENGINE_EMPTY_RESULT)throw f;d=new t([],null,this)}return d.createQueryResponse(c)};h._schedule=async function(b,a){return this._frameQueue?this._frameQueue.push(b,a):b()};h._reschedule=async function(b,a){return this._frameQueue?this._frameQueue.unshift(b,a):b()};h._update=function(b){for(this._budget=
b;!b.done&&this._frameQueue&&this._frameQueue.process();)b.madeProgress();this._budget=null};h._getAll=function(){if(!this._allItems){const b=[];this.featureStore.forEach(a=>b.push(a));this._allItems=new t(b,null,this)}return this._allItems};h._executeGeometryQuery=async function(b,a){const {geometry:c,outSR:d,spatialRel:f,returnGeometry:k,returnCentroid:e}=b,g=k||e,m=I.isValid(d)&&!I.equals(this.spatialReference,d),q=this._geometryQueryCache?m&&g?JSON.stringify({geometry:c,spatialRelationship:f,
outSpatialReference:d}):JSON.stringify({geometry:c,spatialRelationship:f}):null;if(q){var l=this._geometryQueryCache.get(q);if(!H.isUndefined(l))return l}l=async n=>{if(m&&g)return n=await n.project(d),q&&this._geometryQueryCache.put(q,n,n.size||1),n;q&&this._geometryQueryCache.put(q,n,n.size||1);return n};if(!c)return l(this._getAll());const E=this.featureAdapter;if("esriSpatialRelDisjoint"===f){b=this._searchFeatures(this._getQueryBBoxes(c));if(!b.length)return l(this._getAll());let n,P;const L=
new Set;for(var B of b)L.add(E.getObjectId(B));await this._reschedule(()=>{let M=0;n=Array(L.size);this.featureStore.forEach(F=>n[M++]=F);P=L},a);b=await this._reschedule(async()=>{const M=await A.getSpatialQueryOperator(f,c,this.geometryType,this.hasZ,this.hasM);return new t(await this._runSpatialFilter(n,F=>!P.has(E.getObjectId(F))||M(E.getGeometry(F)),a),c,this)},a);return l(b)}B=this._searchFeatures(this._getQueryBBoxes(c));if(!B.length)return l=new t([],c,this),q&&this._geometryQueryCache.put(q,
l,l.size||1),l;if(this._canExecuteSoloPass(c,b))return l(new t(B,c,this));const aa=await A.getSpatialQueryOperator(f,c,this.geometryType,this.hasZ,this.hasM);b=await this._runSpatialFilter(B,n=>aa(E.getGeometry(n)),a);return l(new t(b,c,this))};h._runSpatialFilter=async function(b,a,c){if(!a)return b;if(!this._budget)return b.filter(e=>a(e));let d=0;const f=[],k=async()=>{for(;d<b.length;){const e=b[d];a(e)&&f.push(e);this._budget.done&&await this._reschedule(()=>k(),c);++d}};return this._reschedule(()=>
k(),c).then(()=>f)};h._canExecuteSoloPass=function(b,a){const {geometryType:c}=this;({spatialRel:a}=a);return A.canQueryWithRBush(b)&&("esriSpatialRelEnvelopeIntersects"===a||"esriGeometryPoint"===c&&("esriSpatialRelIntersects"===a||"esriSpatialRelContains"===a||"esriSpatialRelWithin"===a))};h._getQueryBBoxes=function(b){if(A.canQueryWithRBush(b)){if(C.isExtent(b))return[K.fromValues(b.xmin,b.ymin,b.xmax,b.ymax)];if(C.isPolygon(b))return b.rings.map(a=>K.fromValues(Math.min(a[0][0],a[2][0]),Math.min(a[0][1],
a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1])))}return[R.getBoundsXY(K.create(),b)]};h._searchFeatures=function(b){for(const d of b)this.featureStore.forEachInBounds(d,f=>{D.add(f)});const a=Array(D.size);let c=0;D.forEach(d=>a[c++]=d);D.clear();return a};h._checkQuerySupport=async function(b){if(0>b.distance||null!=b.geometryPrecision||b.multipatchOption||b.pixelSize||b.relationParam||b.text)throw new w("feature-store:unsupported-query","Unsupported query options",{query:b});return Promise.all([this._checkAttributesQuerySupport(b),
this._checkStatisticsQuerySupport(b),A.checkSpatialQuerySupport(b,this.geometryType,this.spatialReference),z.checkProjectionSupport(this.spatialReference,b.outSR)]).then(()=>b)};h._checkAttributesQuerySupport=function(b){const {outFields:a,orderByFields:c,returnDistinctValues:d,outStatistics:f}=b,k=f?f.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()):[];if(c&&0<c.length){const e=c.map(g=>{const m=g.toLowerCase();return-1<m.indexOf(" asc")?m.split(" asc")[0]:-1<m.indexOf(" desc")?
m.split(" desc")[0]:g}).filter(g=>-1===k.indexOf(g));u.validateFields(this.fieldsIndex,e,"orderByFields contains missing fields")}if(a&&0<a.length)u.validateFields(this.fieldsIndex,a,"outFields contains missing fields");else if(d)throw new w("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:b});u.validateWhere(this.fieldsIndex,b.where)};h._checkStatisticsQuerySupport=async function(b){const {outStatistics:a,groupByFieldsForStatistics:c,having:d}=b;var f=
c&&c.length,k=a&&a.length;if(d){if(!f||!k)throw new w("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:b});u.validateHaving(this.fieldsIndex,d,a)}if(k&&W(a)){k=a.map(e=>e.onStatisticField);u.validateFields(this.fieldsIndex,k,"onStatisticFields contains missing fields");f&&u.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");for(const e of a){const {onStatisticField:g,statisticType:m}=e;if(("percentile_disc"===
m||"percentile_cont"===m)&&"statisticParameters"in e){if({statisticParameters:f}=e,!f)throw new w("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:e,query:b});}else if("count"!==m&&g&&u.hasInvalidFieldType(g,this.fieldsIndex))throw new w("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:e,query:b});}}};Q._createClass(v,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",
get:function(){const b=this.featureStore.fullBounds;return b?{xmin:b[0],ymin:b[1],xmax:b[2],ymax:b[3],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=V.getTimeExtent(this.timeInfo,this.featureStore):null}}]);return v}();const Z=y.create(),r=y.create();G.Feature=function(v,h=null,b,a,c){this.attributes=v;this.geometry=b;this.centroid=a;this.filterFlags=c;this.groupId=-1;
this.displayId=h};G.default=ba;Object.defineProperty(G,"__esModule",{value:!0})});