// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/lang ../../../core/object ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/Extent ../../../request ../../../core/Loadable ../../../TimeExtent ../../../rest/query/operations/zscale ../../../rest/query/operations/queryAttachments ../../../tasks/QueryTask ./support/clientSideDefaults".split(" "),
function(v,r,w,z,A,x,p,L,t,M,B,u,y,N,O,C,m,D,E,F,G,H,I){async function J(n){if("string"===typeof n){const l=y.dataComponents(n);return l?l:{data:n}}return new Promise((l,d)=>{const a=new FileReader;a.readAsDataURL(n);a.onload=()=>l(y.dataComponents(a.result));a.onerror=b=>d(b)})}const K=new Set(["Feature Layer","Table"]);p=function(n){function l(){var a=n.apply(this,arguments)||this;a.type="feature-layer";return a}v._inheritsLoose(l,n);var d=l.prototype;d.load=function(a){a=x.isSome(a)?a.signal:null;
this.addResolvingPromise(this._fetchService(a));return Promise.resolve(this)};d.addAttachment=async function(a,b){await this.load();a=a.attributes[this.layer.objectIdField];const c=this.layer.parsedUrl.path+"/"+a+"/addAttachment",e=this._getLayerRequestOptions();b=this._getFormDataForAttachment(b,e.query);try{const f=await m(c,{body:b});return this._createFeatureEditResult(f.data.addAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}};d.updateAttachment=async function(a,b,c){await this.load();
a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/updateAttachment";b=this._getLayerRequestOptions({query:{attachmentId:b}});c=this._getFormDataForAttachment(c,b.query);try{const f=await m(e,{body:c});return this._createFeatureEditResult(f.data.updateAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}};d.applyEdits=async function(a,b){await this.load();const c=a.addFeatures.map(this._serializeFeature,this),e=a.updateFeatures.map(this._serializeFeature,
this),f=this._getFeatureIds(a.deleteFeatures,null==b?void 0:b.globalIdUsed);F.unapplyEditsZUnitScaling(c,e,this.layer.spatialReference);const g=[],h=[],k=[...a.deleteAttachments];for(const q of a.addAttachments)g.push(await this._serializeAttachment(q));for(const q of a.updateAttachments)h.push(await this._serializeAttachment(q));a=g.length||h.length||k.length?{adds:g,updates:h,deletes:k}:null;b=this._getLayerRequestOptions({method:"post",query:{adds:c.length?JSON.stringify(c):null,updates:e.length?
JSON.stringify(e):null,deletes:f.length?null!=b&&b.globalIdUsed?JSON.stringify(f):f.join(","):null,gdbVersion:(null==b?void 0:b.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:null==b?void 0:b.rollbackOnFailureEnabled,useGlobalIds:null==b?void 0:b.globalIdUsed,attachments:a&&JSON.stringify(a)}});b=await m(this.layer.parsedUrl.path+"/applyEdits",b);return this._createEditsResult(b)};d.deleteAttachments=async function(a,b){await this.load();a=a.attributes[this.layer.objectIdField];const c=this.layer.parsedUrl.path+
"/"+a+"/deleteAttachments";try{return(await m(c,this._getLayerRequestOptions({query:{attachmentIds:b.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(e){throw this._createAttachmentErrorResult(a,e);}};d.fetchRecomputedExtents=function(a={}){return this.load({signal:a.signal}).then(async()=>{var b=this._getLayerRequestOptions({...a,query:{returnUpdates:!0}});const {layerId:c,url:e}=this.layer;({data:b}=await m(`${e}/${c}`,b));const {id:f,extent:g,fullExtent:h,
timeExtent:k}=b;b=g||h;return{id:f,fullExtent:b&&C.fromJSON(b),timeExtent:k&&E.fromJSON({start:k[0],end:k[1]})}})};d.queryAttachments=async function(a,b={}){const {parsedUrl:c}=this.layer,e=c.path;await this.load();b=this._getLayerRequestOptions(b);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const {objectIds:f}=a;a=[];for(const g of f)a.push(m(e+"/"+g+"/attachments",b));return Promise.all(a).then(g=>f.map((h,k)=>({parentObjectId:h,attachmentInfos:g[k].data.attachmentInfos}))).then(g=>
G.processAttachmentQueryResult(g,e))}return this.queryTask.executeAttachmentQuery(a,b)};d.queryFeatures=async function(a,b){await this.load();return this.queryTask.execute(a,{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryFeaturesJSON=async function(a,b){await this.load();return this.queryTask.executeJSON(a,{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryObjectIds=async function(a,b){await this.load();return this.queryTask.executeForIds(a,
{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryFeatureCount=async function(a,b){await this.load();return this.queryTask.executeForCount(a,{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryExtent=async function(a,b){await this.load();return this.queryTask.executeForExtent(a,{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryRelatedFeatures=async function(a,b){await this.load();return this.queryTask.executeRelationshipQuery(a,
{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d.queryRelatedFeaturesCount=async function(a,b){await this.load();return this.queryTask.executeRelationshipQueryForCount(a,{...b,query:{...this.layer.customParameters,...null==b?void 0:b.query}})};d._fetchService=async function(a){let b=this.layer.sourceJSON;b||({data:a}=await m(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:w("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:a})),b=a);this.sourceJSON=
this._patchServiceJSON(b);a=b.type;if(!K.has(a))throw new u("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`);};d._patchServiceJSON=function(a){var b;"Table"===a.type||!a.geometryType||null!=a&&null!=(b=a.drawingInfo)&&b.renderer||a.defaultSymbol||(b=I.createDrawingInfo(a.geometryType).renderer,A.setDeepValue("drawingInfo.renderer",b,a));return a};d._serializeFeature=function(a){const {geometry:b,attributes:c}=a;return x.isNone(b)?{attributes:c}:"mesh"===b.type||"extent"===
b.type?null:{geometry:b.toJSON(),attributes:c}};d._serializeAttachment=async function(a){const {feature:b,attachment:c}=a,{globalId:e,name:f,contentType:g,data:h,uploadId:k}=c;a={globalId:e,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};b&&(a.parentGlobalId="attributes"in b?b.attributes&&b.attributes[this.layer.globalIdField]:b.globalId);if(k)a.uploadId=k;else if(h){const q=await J(h);a.contentType=q.mediaType;a.data=q.data;h instanceof File&&(a.name=h.name)}f&&(a.name=f);
g&&(a.contentType=g);return a};d._getFeatureIds=function(a,b){const c=a[0];return c?this._canUseGlobalIds(b,a)?this._getGlobalIdsFromFeatureIdentifier(a):"objectId"in c?this._getObjectIdsFromFeatureIdentifier(a):this._getIdsFromFeatures(a):[]};d._getIdsFromFeatures=function(a){const b=this.layer.objectIdField;return a.map(c=>c.attributes&&c.attributes[b])};d._canUseGlobalIds=function(a,b){return a&&"globalId"in b[0]};d._getObjectIdsFromFeatureIdentifier=function(a){return a.map(b=>b.objectId)};d._getGlobalIdsFromFeatureIdentifier=
function(a){return a.map(b=>b.globalId)};d._createEditsResult=function(a){const b=a.data;a=a.data&&a.data.attachments;return{addFeatureResults:b.addResults?b.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:b.updateResults?b.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:b.deleteResults?b.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:a&&a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:a&&
a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:a&&a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};d._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new u("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};d._createAttachmentErrorResult=function(a,b){return{objectId:a,globalId:null,error:new u("feature-layer-source:attachment-failure",
b.details.messages&&b.details.messages[0]||b.message,{code:b.details.httpStatus||b.details.messageCode})}};d._getFormDataForAttachment=function(a,b){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(const c in b){const e=b[c];null!=e&&(a.set?a.set(c,e):a.append(c,e))}return a};d._getLayerRequestOptions=function(a={}){const {parsedUrl:b,gdbVersion:c,dynamicDataSource:e}=this.layer;return{...a,query:z.fixJson({gdbVersion:c,layer:e?JSON.stringify({source:e}):void 0,...b.query,f:"json",
...this.layer.customParameters,...null==a?void 0:a.query}),responseType:"json"}};v._createClass(l,[{key:"queryTask",get:function(){const {capabilities:{query:{supportsFormatPBF:a}},parsedUrl:b,dynamicDataSource:c,gdbVersion:e,spatialReference:f,fieldsIndex:g}=this.layer,h=w("featurelayer-pbf")&&a?"pbf":"json";return new H({url:b.path,format:h,fieldsIndex:g,dynamicDataSource:c,gdbVersion:e,sourceSpatialReference:f})}}]);return l}(D);r.__decorate([t.property()],p.prototype,"type",void 0);r.__decorate([t.property({constructOnly:!0})],
p.prototype,"layer",void 0);r.__decorate([t.property({readOnly:!0})],p.prototype,"queryTask",null);return p=r.__decorate([B.subclass("esri.layers.graphics.sources.FeatureLayerSource")],p)});