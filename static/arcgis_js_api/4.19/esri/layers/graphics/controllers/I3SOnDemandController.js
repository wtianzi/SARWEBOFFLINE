// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/PooledArray ../../../core/promiseUtils ../../../core/Accessor ../../../core/Promise ../../../core/Handles ../../../core/watchUtils ../../../geometry/support/aaBoundingRect ../../../geometry/projection ../../support/PromiseQueue ../../../views/support/Scheduler ../../../geometry/support/aaBoundingBox ../../../views/support/layerViewUtils ../dehydratedFeatures ../../../views/3d/support/extentUtils ../../../views/3d/support/index ../../../views/3d/layers/i3s/I3SFrameTask ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SStreamDataController ../../../views/3d/layers/i3s/I3SViewportQueries".split(" "),
function(A,l,H,e,h,Y,m,Z,I,aa,ba,ca,u,r,J,K,L,B,C,M,N,O,P,v,Q,R,S,T,w,U,V,W,D,X){function x(q,n){return e.isSome(q)&&q.length===n.length&&q.every(d=>0<=y(n,d.name))}function y(q,n){n=n.toLowerCase();for(let d=0;d<q.length;d++)if(q[d].name.toLowerCase()===n)return d;return-1}const t=h.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");h=function(q){function n(a){a=q.call(this,a)||this;a.screenSizeFactor=0;a.featureTarget=5E4;a.fixedFeatureTarget=!1;a.updating=!0;a.updatingProgress=
1;a.leavesReached=!1;a.scaleVisibilityEnabled=!0;a._featureLOD=1;a._stableFeatureLOD=!1;a._isIdle=!1;a._cameraDirty=!0;a._invisibleDirty=!1;a._newLoadingNodes=new u({deallocator:null});a._loadedNodeScales=new Map;a._modificationsNodeFilteringArray=new u;a._downloadingCount=0;a._loadingNodes=new Map;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._requiredAttributes=[];a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableIDBCache=!1;a._disableMemCache=!1;a._restartNodeLoading=!1;a._fields=
null;a._attributeStorageInfo=null;a._handles=new L;a._idleQueue=new N;a._elevationUpdateNodes=new u({deallocator:null});a._errorCount=0;return a}A._inheritsLoose(n,q);var d=n.prototype;d.initialize=function(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData;this._lodHandling=new V(this.layerView);const a=this.layerView.i3slayer;this.layer=a;this._defaultGeometrySchema=a.store.defaultGeometrySchema;this.disableIDBCache=H("disable-feature:idb-cache");"fields"in
a&&(this._fields=a.fields,this._attributeStorageInfo=a.attributeStorageInfo);this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then(([b])=>{if(!this.destroyed&&this.layerView&&!this.layerView.destroyed){var c=this.layerView.view;this._setClippingArea(c.clippingArea);var g=this.layerView.view.resourceController;this._handles.add([B.init(c,"pointsOfInterest.focus.renderLocation",f=>this._pointOfInterestChanged(f)),g.memoryController.events.on("quality-changed",
()=>this._setCameraDirty()),B.init(this.layerView,"suspended",f=>{const k=f?()=>this._updateViewData():()=>this._updateIdleState(!0),E=f?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(f&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=k,this._idleStateCallbacks.idleEnd=E):this._idleStateCallbacks=g.scheduler.registerIdleStateCallbacks(k,E)}),T.addTask(this.layerView.view.resourceController.scheduler,{update:(f,k)=>this._frame(f,k),needsUpdate:()=>
this.updating}),this.watch("uncompressedTextureDownsamplingEnabled",()=>this.restartNodeLoading()),this.watch(["featureTarget","fixedFeatureTarget"],()=>{this._setCameraDirty();this._stableFeatureLOD=!1}),c.state.watch("camera",()=>this._setCameraDirty()),c.state.watch("contentCamera",()=>this._setCameraDirty()),this.layer.watch("elevationInfo",()=>this._elevationInfoChanged()),this.layer.watch(["minScale","maxScale"],()=>this._scaleBoundsChanged()),this.layerView.watch("lodFactor",()=>this._setCameraDirty()),
this.layerView.watch("availableFields?",()=>this._requiredFieldsChange()),this.layerView.watch("holeFilling",f=>e.isSome(this._index)&&(this._index.holeFilling=f))]);this._updateScaleHandles();this._viewportQueries=new X(this.crsIndex,c.renderCoordsHelper,c.state.camera,c.state.contentCamera,c.state.fixedContentCamera,this._clippingArea,c.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:.5>this.lod});
this._index=new U.I3SIndex(a,b,this.indexStreamController,this._viewportQueries,t,this.layerView.holeFilling,f=>this.layerView.isNodeLoaded(f),f=>this.layerView.isNodeReloading(f),f=>this._shouldLoadNode(f),f=>this._enableFromGPUCache(f,1),f=>this._needsUpdate(f),()=>!this.indexStreamController.busy,f=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(f):null,f=>this.layerView.computeNodeFiltering(f));b=e.isSome(this.layer.modifications)&&this.layer.modifications&&0<this.layer.modifications.length;
this._index.imModificationsChanged(b);this._startNodeLoading()}}));this._tmpPoint=Q.makeDehydratedPoint(0,0,0,this.crsIndex)};d.updateNodeModificationStatus=function(a){const b=this._index,c=this.layerView;e.isSome(b)&&c&&c.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),a.forAll(g=>{g=b.getNode(g);e.isSome(g)&&this._modificationsNodeFilteringArray.push(g)}),c.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)};d.destroy=function(){this.cancelNodeLoading();
this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null);this._handles.destroy();this._nodeLoader=null;p.prune();e.isSome(z)&&(z.remove(),z=null)};d._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const a=this._attributeStorageInfo,b=this._fields,c=this.layer.objectIdField;return this.layerView.availableFields.map(g=>{const f=y(a,g);g=y(b,g);return 0<=f&&0<=g?{index:f,
name:b[g].name,field:b[g],attributeStorageInfo:a[f]}:null}).filter(g=>null!=g&&g.name!==c)};d._requiredFieldsChange=function(){const a=this._getRequiredAttributes();x(this._requiredAttributes,a)||(this._requiredAttributes=a,this._requiredAttributesDirty=!1,this.restartNodeLoading())};d.requestUpdate=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};d._setClippingArea=function(a){const b=P.create();R.projectToBoundingBox(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=
b:this._clippingArea=null};d._pointOfInterestChanged=function(a){e.isSome(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(a),e.isSome(this._index)&&(this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))};d.updateClippingArea=function(a){this._setClippingArea(a);e.isSome(this._viewportQueries)&&e.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache());
this._setCameraDirty()};d._setCameraDirty=function(){this._cameraDirty=!0;this.notifyChange("rootNodeVisible");this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};d.updateElevationChanged=function(a,b){const c=this._index;if(!e.isNone(c)){var g=c.rootNode;if(!e.isNone(g)){var f=this._elevationUpdateNodes;f.clear();w.findIntersectingNodes(a,b,g,this.crsIndex,c,k=>f.push(k.index));f.forAll(k=>{c.invalidateBoundingVolumeCache(k);k===g.index&&this.notifyChange("rootNodeVisible")});f.length&&
this.restartNodeLoading()}}};d.getParentIndex=function(a){return e.isSome(this._index)&&this._index.getParentIndex(a)};d._elevationInfoChanged=function(){e.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo);this._setCameraDirty()};d._updateScaleHandles=function(){this._handles.remove("scale-bounds");this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",a=>this._scaleUpdateHandler(a)),"scale-bounds")};d._scaleBoundsChanged=function(){this.areScaleBoundsActive||
this._loadedNodeScales.clear();this._updateScaleHandles();this._setCameraDirty()};d._scaleUpdateHandler=function(a){this._updateScaleInBoundingRect(a.scale,a.extent,a.spatialReference);this._setCameraDirty()};d._updateScaleInBoundingRect=function(a,b,c){const g=this._index;e.isNone(g)||!e.isNone(g.rootNode)&&M.projectBoundingRect(b,c,G,this.crsIndex)&&this._loadedNodeScales.forEach((f,k)=>{f=g.getNode(k);e.isSome(f)&&C.containsPoint(G,f.mbs)&&this._loadedNodeScales.set(k,a)})};d.restartNodeLoading=
function(){this._restartNodeLoading=!0;this.cancelNodeLoading();this._evaluateUpdating()};d.schedule=function(a,b){return this._idleQueue.push(a,b)};d.reschedule=function(a,b){return this._idleQueue.unshift(a,b)};d._frame=function(a,b){if(this.layerView.suspended)return this._updateViewData(),this._evaluateUpdating(),-Infinity;if(!this.layerView.visible||e.isNone(this._index))return-Infinity;this._processLogError(a,b);return this._index.getPriority()};d._processLogError=function(a,b){try{this._process(a,
b)}catch(c){50>this._errorCount?t.error("Error during processing: "+c):50===this._errorCount&&t.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};d._process=function(a,b){this._restartNodeLoading&&this._startNodeLoading();if(null!=this._nodeLoader&&!e.isNone(this._index)){this._updateViewData();this._invisibleDirty&&this._removeInvisibleNodes(a)&&(this._invisibleDirty=!1);this.isIntegratedMesh&&(a.enabled=!1);a.run(()=>this._processIndex(a));this._updateFeatureLOD();
a.run(()=>this._processCache(a));this.isIntegratedMesh&&(a.enabled=!0);for(a.run(()=>this._processNodes(a,b));!a.done&&this._idleQueue.process();)a.madeProgress();a.run(()=>this._prefetchIndex());b.numIndexLoading+=this._index.getIndexLoading();b.numNodesLoading+=this._downloadingCount;a.run(()=>this._lodHandling.lodGlobalHandling(a));this._evaluateUpdating()}};d._processIndex=function(a){if(e.isNone(this._index))return!1;this._index.dirty&&(this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],
a,b=>this.updateNodeModificationStatus(b)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length)),a=this._index.featureEstimate.leavesReached,this._index.isLoading()||a===this._get("leavesReached")||this._set("leavesReached",a));return this._index.load()};d._prefetchIndex=function(){return e.isNone(this._index)||0<this._loadingNodes.size||
0<this._index.updates.add.length?!1:this._index.prefetch()};d._updateFeatureLOD=function(){if(this.isGraphics3D&&!e.isNone(this._index)&&!e.isNone(this._viewportQueries)){var a=!this._index.isLoading(),b=this.featureTarget*this.baseLOD,c=this._index.featureEstimate;c.estimate=c.estimate||b/2;if(500<this._index.getIndexMissing()){if(1E-4>=this._featureLOD)return;this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(a&&c.estimate<b){if(c.leavesReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;
this._featureLOD*=Math.min(10,Math.max(b/c.estimate,1.001));a=this.lod;b=this._index.checkFeatureTarget(b,a);b!==a&&(this._featureLOD=b/this.baseLOD,this._stableFeatureLOD=!0)}else if(c.estimate>1.2*b||a&&c.estimate>b){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(c.estimate/b-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,Math.max(1E-4,this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.requestUpdate()}};d._processCache=function(a){const b=
this._index;if(e.isNone(b))return!1;for(;0<this._newLoadingNodes.length&&!a.done;){var c=this._newLoadingNodes.pop();for(c=b.getParent(c);e.isSome(c)&&!this.layerView.isNodeLoaded(c.index)&&this._isNodeInScaleBounds(c);c=b.getParent(c.index))if(this._enableFromGPUCache(c,0)){a.madeProgress();break}}return a.hasProgressed};d._processNodes=function(a,b){if(e.isNone(this._index))return!1;let c=(this._isIdle?100:2)-this._loadingNodes.size;const g=this._index.updates;g.cancel.forEach(this._cancelNode,
this);for(g.cancel=[];0<g.remove.length&&!a.done;)this.layerView.removeNode(g.remove.pop()),a.madeProgress();for(;0<g.update.length&&!a.done;){var f=this._index.getNode(g.update.pop());e.isSome(f)&&(this._updateLoadedNode(f),a.madeProgress())}for(;0<g.add.length&&!a.done&&0<c;){--c;f=this._index.getNode(g.add.back());if(e.isNone(f)||2!==f.cacheState&&!this._hasNodeLoadToken(b))break;g.add.pop();this._loadNode(f);a.madeProgress()}return a.hasProgressed};d._cancelAllNodes=function(){this._loadingNodes.forEach(a=>
a.abort());this._loadingNodes.clear();this._updatingNodes.forEach(a=>a.abort());this._updatingNodes.clear()};d._cancelNode=function(a){const b=this._loadingNodes.get(a);b&&(b.abort(),this._loadingNodes.delete(a))};d._hasNodeLoadToken=function(a){return!this._isIdle&&2<=a.numNodesLoading+this._loadingNodes.size?!1:this._downloadingCount<S.maxDownloadSlots&&!this.dataStreamController.busy};d._evaluateUpdating=function(){var a=!1,b=0;this.layerView.suspended?b=(a=this._cameraDirty)?.5:1:(a=e.isSome(this._index)?
this._index.getIndexMissing():0,b=e.isSome(this._index)?this._index.updates.add.length:0,b=a+3*b+2*this._loadingNodes.size,a=!!(0<b||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||0<this._idleQueue.length||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===b&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(b,this._progressMaxNumNodes),b=1-b/this._progressMaxNumNodes);a!==this.updating&&this._set("updating",a);b!==this.updatingProgress&&this._set("updatingProgress",
b)};d._updateViewData=function(){if(this._cameraDirty&&!e.isNone(this._index)&&!e.isNone(this._viewportQueries)){var a=this.layerView.view,{camera:b,contentCamera:c,fixedContentCamera:g}=a.state;this.screenSizeFactor=1/(b.perScreenPixelRatio/2);this._viewportQueries.updateCamera(b,c,g);this._viewportQueries.setPointOfInterest(a.pointsOfInterest.focus.renderLocation);this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.invalidateVisibilityCache();this._index.progressiveLoadPenalty=
F.distancePenalty*this._viewportQueries.distCameraToPOI();this._index.requestUpdate();this._stableFeatureLOD=!1;this._invisibleDirty=!0;this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};d._getProgressiveLoadFactor=function(){return 1>this.layerView.view.resourceController.memoryController.memoryFactor?1:this.layerView.progressiveLoadFactor};d.isGeometryVisible=function(a){return e.isSome(this._index)&&this._index.isGeometryVisible(a.index)};d.updateVisibility=function(a){e.isSome(this._index)&&
this._index.invalidateNodeVisibilityCache(a)};d.updateBoundingVolume=function(a){e.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(a)};d.invalidateGeometryVisibility=function(a){e.isSome(this._index)&&this._index.invalidateGeometryVisibility(a)};d.invalidateVisibilityObbs=function(){e.isSome(this._index)&&this._index.invalidateVisibilityObbs()};d.modificationsChanged=function(){if(e.isSome(this._index)){const a=e.isSome(this.layer.modifications)&&this.layer.modifications&&0<this.layer.modifications.length;
this._index.imModificationsChanged(a)}this._invisibleDirty=!0};d._shouldLoadNode=function(a){return this._lodHandling.shouldLoadNode(a)&&!this._shouldDropNode(a)&&this._isNodeInScaleBounds(a)?e.isSome(this._index)?this._index.isGeometryVisible(a.index):!1:!1};d._shouldDropNode=function(a){if(e.isNone(this._viewportQueries))return!1;const b=this.lodDropFactor;return 1<=b||!this._lodHandling.hasNoVisibleChildren(a)?!1:Math.abs(this._viewportQueries.calcCameraDistanceToCenter(a))-this._viewportQueries.minDistance>
(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*b};d._startNodeLoading=function(){this._restartNodeLoading=!1;const a=this._index;this._updatesDisabled||e.isNone(a)||e.isNone(this._viewportQueries)||(this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1),this._nodeLoader=new W(this.layer,this.dataStreamController,t,this._defaultGeometrySchema,this._requiredAttributes,{textureEncodings:this.layerView.supportedTextureEncodings,
uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid}),a.requestUpdate(),this._lodHandling.startNodeLoading(b=>this._isNodeInScaleBounds(b),(b,c)=>this._removeNodes(b,c,1),a,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating())};d.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index};d.cancelNodeLoading=function(){this.isNodeLoading()&&
(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())};d._removeInvisibleNodes=function(a){const b=this._index;if(e.isNone(b)||e.isNone(this._viewportQueries))return!1;p.clear();this.layerView.getLoadedNodeIndices(p);const c=0===this._viewportQueries.maxDistance,g=c?()=>!1:f=>this._shouldDropNode(f);p.filterInPlace(f=>{const k=b.getNode(f);return e.isNone(k)||!b.isGeometryVisible(f)||
g(k)||!this._isNodeInScaleBounds(k)});0<p.length&&this._lodHandling.setLodGlobalDirty();this._removeNodes(p,a,0);if(c&&1>this.lodDropFactor)return!1;if(0===p.length)return!0;p.clear();return!1};d.markNodeToRemove=function(a){p.push(a)};d.removeMarkedNodes=function(){this._removeNodes(p,O.noBudget,0)};d._removeNodes=function(a,b,c){const g=a.length;if(0!==g&&!b.done){for(e.isSome(this._index)&&this._index.requestUpdate();0<a.length&&!b.done;){const f=a.pop(),k=this._index;1===c&&this.layerView.nodeFadeoutEnabled&&
e.isSome(k)&&k.isGeometryVisible(f)?this.layerView.fadeNode(f,1,!0):this.layerView.removeNode(f);b.madeProgress()}if(0<this._loadedNodeScales.size)for(b=a.length;b<g;b++)this._loadedNodeScales.delete(a.data[b])}};d._needsUpdate=function(a){if(!a.resources.hasFeatureData||this._updatingNodes.has(a.index))return!1;a=this.layerView.getLoadedAttributes(a.index);return null!=a&&a!==this._requiredAttributes};d._updateLoadedNode=function(a){const b=r.createAbortController();this._updatingNodes.set(a.index,
b);const c=this.layerView.getLoadedAttributes(a.index);(x(c,this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(a.index)):this._nodeLoader.loadAttributes(a,this._requiredAttributes,b.signal)).then(g=>this.schedule(()=>this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:g},b.signal),b.signal)).catch(g=>{if(!r.isAbortError(g))return this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},
b.signal)}).catch(()=>{}).then(()=>{this._updatingNodes.delete(a.index);this._evaluateUpdating()});this._evaluateUpdating()};d._loadNode=function(a){if(this._loadingNodes.has(a.index))t.error("already loading node "+a.index);else{var b=r.createAbortController();this._loadingNodes.set(a.index,b);var c=()=>{this._loadingNodes.get(a.index)===b&&this._loadingNodes.delete(a.index);this._evaluateUpdating()};this._evaluateUpdating();this._loadAndAddNode(a,b.signal).then(c).catch(g=>{c();if(!r.isAbortError(g))throw g;
})}};d._loadAndAddNode=function(a,b){return 1===a.cacheState?this._loadUncached(a,b):this._loadCached(a,b).then(c=>{c||(a.cacheState=1,e.isSome(this._index)&&this._index.updates.add.push(a.index))}).catch(c=>{if(!r.isAbortError(c))throw a.cacheState=1,c;})};d._enableFromGPUCache=function(a,b){if(this._disableMemCache||e.isNone(this._index))return!1;if(0===b&&!this._index.useNodeAsHole(a.index))return!0;const c=this._loadCachedGPUData(a);if(!c)return!1;this.layerView.addCachedGPUData(a,c,b);this._nodeAdded();
return!0};d._loadCachedGPUData=function(a){a=this.layerView.loadCachedGPUData(a);if(e.isSome(a)&&e.isSome(a.attributeInfo)&&x(a.attributeInfo.loadedAttributes,this._requiredAttributes))return a;this.layerView.deleteCachedGPUData(a);return null};d._nodeAdded=function(){e.isSome(this._index)&&this._index.requestUpdate();this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};d._loadCached=function(a,b){if(this._enableFromGPUCache(a,1))return Promise.resolve(!0);const c=this.layerView;return!this.disableIDBCache&&
c.loadCachedNodeData&&c.addCachedNodeData?this.schedule(()=>c.loadCachedNodeData(a,b,(g,f)=>this._nodeLoader.loadTextures(a,g,f)),b).then(g=>{if(e.isNone(g))return!1;const f=this._requiredAttributes;return this.reschedule(()=>this._nodeLoader.loadAttributes(a,f,b),b).then(k=>this.reschedule(()=>c.addCachedNodeData(a,g,{loadedAttributes:f,attributeData:k},b),b)).then(()=>{this._nodeAdded();return!0})}):Promise.resolve(!1)};d._loadUncached=function(a,b){this._downloadingCount++;return this._nodeLoader.loadNodeData(a,
b).catch(c=>{this._downloadingCount--;throw c;}).then(c=>{this._downloadingCount--;return this.schedule(()=>this.layerView.addNode(a,c,b),b)}).then(()=>{this._nodeAdded();a.cacheState=2}).catch(c=>{if(!r.isAbortError(c))throw t.error("#loadNodeData()",this.layer,`Failed to load node '${a.id}'`,c),a.failed=!0,e.isSome(this._index)&&this._index.requestUpdate(),c;})};d._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=a,this._evaluateUpdating(),a&&this._index&&e.isSome(this._index)&&this._index.resetFailedNodes())};
d._getScale=function(a){if(this._loadedNodeScales.has(a.index))return this._loadedNodeScales.get(a.index);this._tmpPoint.x=a.mbs[0];this._tmpPoint.y=a.mbs[1];this._tmpPoint.z=a.mbs[2];const b=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);this.layerView.isNodeLoaded(a.index)&&this._loadedNodeScales.set(a.index,b);return b};d._isNodeInScaleBounds=function(a){if(!this.areScaleBoundsActive)return!0;a=this._getScale(a);const {minScale:b,maxScale:c}=v.extractSafeScaleBounds(this.layer);return v.scaleBoundsPredicate(a,
b,c)};d.updateStats=function(a){a.index=e.isSome(this._index)?this._index.size:0;this.isGraphics3D&&(a.detail=this._featureLOD,a.target=this.featureTarget*this.baseLOD);e.isSome(this._index)&&this._index.updateStats(a)};d.notifyLODUpdate=function(){this._lodHandling.setLodGlobalDirty();this._evaluateUpdating();e.isSome(this._index)&&this._index.requestUpdate()};d.geometryFilterChanged=function(a){const b=this._index;e.isSome(b)&&b.layerFilterChanged(a);this.requestUpdate()};A._createClass(n,[{key:"isMeshPyramid",
get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(2);return new D.I3SStreamDataController(a)}},{key:"dataStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(3);return new D.I3SStreamDataController(a)}},{key:"crsVertex",
get:function(){return w.getVertexCrs(this.layer)}},{key:"crsIndex",get:function(){return w.getIndexCrs(this.layer)}},{key:"rootNodeVisible",get:function(){if(e.isSome(this._index)){const a=this._index.rootNode;if(e.isSome(a))return this._updateViewData(),this._index.isNodeVisible(a.index)}return!0}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){const {minScale:a,maxScale:b}=v.extractSafeScaleBounds(this.layer);return this.scaleVisibilityEnabled&&
(0<a||0<b)}},{key:"unloadedMemoryEstimate",get:function(){return e.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return e.isSome(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(a){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0);this._disableMemCache=a}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",
get:function(){const a=this.layerView.lodFactor,b=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(0<a?a:1)*b}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;const a=this.layerView.view.resourceController.memoryController;return(Math.min(a.memoryFactor,.5)-a.minQuality)/(.5-a.minQuality)}},{key:"test",get:function(){const a=this;return{index:this._index,set disableUpdates(b){(a._updatesDisabled=b)?a.cancelNodeLoading():
a.requestUpdate()},set disableIDBCache(b){a.disableIDBCache=b},set ignoreServiceObb(b){e.isSome(a._index)&&(a._index.ignoreServiceObb=b)},shouldLoadNode:b=>a._shouldLoadNode(b)}}}]);return n}(K.EsriPromiseMixin(J));l.__decorate([m.property({readOnly:!0})],h.prototype,"isMeshPyramid",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"isGraphics3D",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"indexStreamController",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"dataStreamController",
null);l.__decorate([m.property({readOnly:!0})],h.prototype,"crsVertex",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"crsIndex",null);l.__decorate([m.property()],h.prototype,"screenSizeFactor",void 0);l.__decorate([m.property()],h.prototype,"featureTarget",void 0);l.__decorate([m.property()],h.prototype,"fixedFeatureTarget",void 0);l.__decorate([m.property()],h.prototype,"layerView",void 0);l.__decorate([m.property()],h.prototype,"layer",void 0);l.__decorate([m.property({readOnly:!0})],
h.prototype,"updating",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"updatingProgress",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"leavesReached",void 0);l.__decorate([m.property({constructOnly:!0})],h.prototype,"scaleVisibilityEnabled",void 0);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],h.prototype,"rootNodeVisible",null);h=l.__decorate([I.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],h);const p=new u({deallocator:null});let z;const F=
{factorIM:.2,factor3dObject:.05,distancePenalty:10},G=C.create();return h});