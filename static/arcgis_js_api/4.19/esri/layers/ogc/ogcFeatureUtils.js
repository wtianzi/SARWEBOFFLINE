// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../core/maybe ../../core/Logger ../../core/Error ../../geometry/support/spatialReferenceUtils ../../geometry/SpatialReference ../../geometry/support/webMercatorUtils ../../geometry ../../request ../support/fieldType ../graphics/OptimizedFeatureSet ../graphics/featureConversionUtils ../support/FieldsIndex ../../tasks/support/FeatureSet ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults".split(" "),function(k,v,L,q,E,m,F,ca,p,M,N,x,O,P,y,Q){function G(a){a=
/^http:\/\/www\.opengis\.net\/def\/crs\/(.+)\/(.+)\/(.+)$/i.exec(a);if(!a)return null;const [,c,,b]=a;switch(c.toLowerCase()){case "ogc":switch(b.toLowerCase()){case "crs27":return m.GCS_NAD_1927;case "crs83":return new m({wkid:4269});case "crs84":case "crs84h":return m.WGS84;default:return null}case "esri":case "epsg":return a=Number.parseInt(b,10),Number.isNaN(a)?null:900913===a?m.WebMercator:new m({wkid:a});default:return null}}async function H(a,c,b){a=await I(a,c,b);return x.convertToFeatureSet(a)}
async function I(a,c,b){const {capabilities:{query:{maxRecordCount:l}},collectionId:e,layerDefinition:f,spatialReference:n,supportedCrs:d,url:r}=a;var t=`${r}/collections/${e}/items`;const {geometry:R,num:J,start:z,timeExtent:S,where:T}=c;if(c.objectIds)throw new q("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");a=m.fromJSON(n);c=v.unwrapOr(c.outSpatialReference,a);a=c.isWGS84?null:K(c,d);var g=U(R,d),w=V(S);const X=W(T);({data:g}=await p(t,{...b,query:{...g,
crs:a,datetime:w,query:X,limit:null!=J?J:null!=z&&void 0!==z?10:l,startindex:z,f:"json"}}));b=!1;g.links&&(b=!!g.links.find(Y=>"next"===Y.rel));!b&&Number.isInteger(g.numberMatched)&&Number.isInteger(g.numberReturned)&&(b=g.numberReturned<g.numberMatched);const {fields:Z,globalIdField:aa,hasM:ba,hasZ:A,objectIdField:B}=f;t=f.geometryType;g=y.createOptimizedFeatures(g,{geometryType:t,hasZ:A,objectIdFieldName:B});if(!a&&c.isWebMercator)for(var u of g)u.geometry&&(w=x.convertToGeometry(u.geometry,t,
A,!1),w.spatialReference=m.WGS84,u.geometry=x.convertFromGeometry(F.project(w,c)));for(var h of g)h.objectId=h.attributes[B];u=a||!a&&c.isWebMercator?c.toJSON():E.WGS84;h=new N;h.exceededTransferLimit=b;h.features=g;h.fields=Z;h.geometryType=t;h.globalIdFieldName=aa;h.hasM=ba;h.hasZ=A;h.objectIdFieldName=B;h.spatialReference=u;return h}function K(a,c){return c.find(b=>{b=G(b);return E.equals(b,a)})}function C(a){const {xmin:c,ymin:b,xmax:l,ymax:e}=a;return`${c},${b},${l},${e}`}function V(a){if(v.isNone(a))return null;
const {start:c,end:b}=a;return`${c?c.toISOString():".."}/${b?b.toISOString():".."}`}function W(a){return v.isNone(a)||!a||"1\x3d1"===a?null:a}function U(a,c){if(!v.isSome(a)||"extent"!==a.type)return null;const {spatialReference:b}=a;return!b||b.isWGS84?{bbox:C(a)}:(c=K(b,c))?{bbox:C(a),"bbox-crs":c}:b.isWebMercator?{bbox:C(F.project(a,m.WGS84))}:null}const D=L.getLogger("esri.layers.graphics.sources.ogcfeature");k.getCollectionDefinition=async function(a,c,b,l,e=5){({data:a}=await p(`${a}/collections/${c}/items`,
{signal:l,query:{limit:e,f:"json"}}));await y.validateGeoJSON(a);const f=y.inferLayerProperties(a,{geometryType:b.geometryType});a=b.fields||f.fields||[];c=null!=b.hasZ?b.hasZ:f.hasZ;l=f.geometryType;const n=b.objectIdField||f.objectIdFieldName||"OBJECTID";b=b.timeInfo;if(e=a.find(r=>r.name===n))e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1;else{if(!f.objectIdFieldType)throw new q("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");a.unshift({name:n,
alias:n,type:"esriFieldTypeOID",editable:!1,nullable:!1})}n!==f.objectIdFieldName&&(e=a.find(r=>r.name===f.objectIdFieldName))&&(e.type="esriFieldTypeInteger");if(!l)throw new q("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");a===f.fields&&0<f.unknownFields.length&&D.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}});
for(var d of a){null==d.name&&(d.name=d.alias);null==d.alias&&(d.alias=d.name);"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&(d.editable=null==d.editable?!0:!!d.editable,d.nullable=null==d.nullable?!0:!!d.nullable);if(!d.name)throw new q("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(-1===M.kebabDict.jsonValues.indexOf(d.type))throw new q("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,{field:d});}b&&(d=new O(a),b.startTimeField&&
((e=d.get(b.startTimeField))?(b.startTimeField=e.name,e.type="esriFieldTypeDate"):b.startTimeField=null),b.endTimeField&&((e=d.get(b.endTimeField))?(b.endTimeField=e.name,e.type="esriFieldTypeDate"):b.endTimeField=null),b.trackIdField&&((d=d.get(b.trackIdField))?b.trackIdField=d.name:(b.trackIdField=null,D.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:b}}))),b.startTimeField||b.endTimeField||(D.warn({name:"ogc-feature-layer:invalid-timeInfo",
message:"startTimeField and endTimeField are missing",details:{timeInfo:b}}),b=null));return{drawingInfo:Q.createDrawingInfo(l),geometryType:l,fields:a,hasZ:!!c,objectIdField:n,timeInfo:b}};k.getServerCollection=async function(a,c,b){({data:a}=await p(`${a}/collections/${c}`,{signal:b,query:{f:"json"}}));return a};k.getServerCollections=async function(a,c){({data:a}=await p(`${a}/collections`,{signal:c,query:{f:"json"}}));return a};k.getServerConformance=async function(a,c){({data:a}=await p(`${a}/conformance`,
{signal:c,query:{f:"json"}}));return a};k.getServerLandingPage=async function(a,c){({data:a}=await p(a,{signal:c,query:{f:"json"}}));return a};k.getSpatialReference=G;k.queryFeatureSet=async function(a,c,b){a=await H(a,c,b);return P.fromJSON(a)};k.queryFeatureSetJSON=H;k.queryOptimizedFeatureSet=I;Object.defineProperty(k,"__esModule",{value:!0})});