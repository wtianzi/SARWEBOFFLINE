// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/lang ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/utils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/cast ../../core/jsonMap ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../core/Error ../../core/urlUtils ../../core/uuid ../../core/accessorSupport/PropertyOrigin ../../portal/support/resourceExtension ../../geometry/Extent ../../geometry ../../core/Collection ./fieldUtils ../../core/Identifiable ../../PopupTemplate ../../request ../../core/Loadable ../../symbols ../../renderers/Renderer ../../renderers/ClassBreaksRenderer ../../renderers/UniqueValueRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/SimpleRenderer ../../renderers/support/types ../../renderers/support/jsonUtils ../../core/MultiOriginJSONSupport ./Field ./FieldsIndex ./LabelClass ./FeatureType ./source/MapLayerSource ./source/DataLayerSource ../../support/popupUtils ../../tasks/support/Query ../../core/HandleOwner".split(" "),
function(z,F,f,d,A,M,q,B,h,N,ha,r,O,u,w,P,ia,G,ja,Q,ka,R,S,T,U,V,W,X,la,ma,na,oa,pa,qa,ra,H,sa,Y,Z,aa,ba,ca,C,I,da,J,ea){function D(k){return k&&"esriSMS"===k.type}function K(k,m,e){var a;return{ignoreOrigin:!0,enabled:e?"map-image"===(null==(a=e.layer)?void 0:a.type)&&(e.writeSublayerStructure||this.originIdOf(m)>=G.nameToId(e.origin)):!1}}function L(k,m,e){var a;return{enabled:e?"tile"===(null==(a=e.layer)?void 0:a.type)&&this._isOverridden(m):!1}}function n(k,m,e){return{ignoreOrigin:!0,enabled:e&&
e.writeSublayerStructure||!1}}function x(k,m,e){return{ignoreOrigin:!0,enabled:e?e.writeSublayerStructure||this.originIdOf(m)>=G.nameToId(e.origin):!1}}var y;const E=M.getLogger("esri.layers.support.Sublayer");let fa=0;const t=new Set;t.add("layer");t.add("parent");t.add("loaded");t.add("loadStatus");t.add("loadError");t.add("loadWarnings");d=y=function(k){function m(a){a=k.call(this,a)||this;a.capabilities=void 0;a.fields=null;a.fullExtent=null;a.globalIdField=null;a.legendEnabled=!0;a.objectIdField=
null;a.popupEnabled=!0;a.popupTemplate=null;a.sourceJSON=null;a.title=null;a.typeIdField=null;a.types=null;return a}F._inheritsLoose(m,k);var e=m.prototype;e.load=async function(a){this.addResolvingPromise((async()=>{var b;if(!this.layer&&!this.url)throw new w("sublayer:missing-layer","Sublayer can't be loaded without being part of a layer",{sublayer:this});let c=null;if(!this.layer||2<this.originIdOf("url")||"data-layer"===(null==(b=this.source)?void 0:b.type))c=(await V(this.url,{responseType:"json",
query:{f:"json"},...a})).data;else{var g;b=this.id;"map-layer"===(null==(g=this.source)?void 0:g.type)&&(b=this.source.mapLayerId);c=await this.layer.fetchSublayerInfo(b,a)}c&&(this.sourceJSON=c,this.read({layerDefinition:c},{origin:"service"}))})());return this};e.readCapabilities=function(a,b){b=b.layerDefinition||b;a=(a=b.capabilities||a)?a.toLowerCase().split(",").map(c=>c.trim()):[];return{exportMap:{supportsModification:!!b.canModifyLayer},operations:{supportsQuery:-1!==a.indexOf("query")}}};
e.readGlobalIdFieldFromService=function(a,b){b=b.layerDefinition||b;if(b.globalIdField)return b.globalIdField;if(b.fields)for(const c of b.fields)if("esriFieldTypeGlobalID"===c.type)return c.name};e.writeLabelingInfo=function(a,b,c,g){a&&a.length&&(b.layerDefinition={drawingInfo:{labelingInfo:a.map(l=>l.write({},g))}})};e.readMinScale=function(a,b){return b.minScale||b.layerDefinition&&b.layerDefinition.minScale||0};e.readMaxScale=function(a,b){return b.maxScale||b.layerDefinition&&b.layerDefinition.maxScale||
0};e.readObjectIdFieldFromService=function(a,b){b=b.layerDefinition||b;if(b.objectIdField)return b.objectIdField;if(b.fields)for(const c of b.fields)if("esriFieldTypeOID"===c.type)return c.name};e.readOpacity=function(a,b){a=b.layerDefinition;return 1-.01*(null!=a.transparency?a.transparency:a.drawingInfo.transparency)};e.writeOpacity=function(a,b,c,g){b.layerDefinition={drawingInfo:{transparency:100-100*a}}};e.writeParent=function(a,b){b.parentLayerId=this.parent&&this.parent!==this.layer?q.ensureInteger(this.parent.id):
-1};e.castSublayers=function(a){return q.ensureType(R.ofType(y),a)};e.writeSublayers=function(a,b,c){this.get("sublayers.length")&&(b[c]=this.sublayers.map(g=>g.id).toArray().reverse())};e.readTypeIdField=function(a,b){b=b.layerDefinition||b;if(a=b.typeIdField)if(b=S.getField(b.fields,a))return b.name;return null};e.writeVisible=function(a,b,c,g){b[c]=this.getAtOrigin("defaultVisibility","service")||a};e.clone=function(){const {store:a}=B.getProperties(this),b=new y;B.getProperties(b).store=a.clone(t);
this.commitProperty("url");b._lastParsedUrl=this._lastParsedUrl;return b};e.createPopupTemplate=function(a){return da.createPopupTemplate(this,a)};e.createQuery=function(){return new J({returnGeometry:!0,where:this.definitionExpression||"1\x3d1"})};e.createFeatureLayer=async function(){var a,b;if(this.hasOwnProperty("sublayers"))return null;const c=null==(a=this.layer)?void 0:a.parsedUrl;a=new (await new Promise(function(g,l){z(["../FeatureLayer"],function(p){g(Object.freeze({__proto__:null,"default":p}))},
l)})).default({url:c.path});c&&this.source&&("map-layer"===this.source.type?a.layerId=this.source.mapLayerId:a.dynamicDataSource=this.source);null!=this.layer.refreshInterval&&(a.refreshInterval=this.layer.refreshInterval);this.definitionExpression&&(a.definitionExpression=this.definitionExpression);2<this.originIdOf("labelingInfo")&&(a.labelingInfo=A.clone(this.labelingInfo));0<this.originIdOf("labelsVisible")&&(a.labelsVisible=this.labelsVisible);0<this.originIdOf("legendEnabled")&&(a.legendEnabled=
this.legendEnabled);0<this.originIdOf("visible")&&(a.visible=this.visible);0<this.originIdOf("minScale")&&(a.minScale=this.minScale);0<this.originIdOf("maxScale")&&(a.maxScale=this.maxScale);0<this.originIdOf("opacity")&&(a.opacity=this.opacity);0<this.originIdOf("popupTemplate")&&(a.popupTemplate=A.clone(this.popupTemplate));2<this.originIdOf("renderer")&&(a.renderer=A.clone(this.renderer));"data-layer"===(null==(b=this.source)?void 0:b.type)&&(a.dynamicDataSource=this.source.clone());0<this.originIdOf("title")&&
(a.title=this.title);"map-image"===this.layer.type&&0<this.layer.originIdOf("customParameters")&&(a.customParameters=this.layer.customParameters);"tile"===this.layer.type&&0<this.layer.originIdOf("customParameters")&&(a.customParameters=this.layer.customParameters);return a};e.getFeatureType=function(a){const {typeIdField:b,types:c}=this;if(!b||!a)return null;const g=a.attributes?a.attributes[b]:void 0;if(null==g)return null;let l=null;c.some(p=>{const {id:v}=p;if(null==v)return!1;v.toString()===
g.toString()&&(l=p);return!!l});return l};e.getFieldDomain=function(a,b){return(b=this.getFeatureType(b&&b.feature))&&(b=b.domains&&b.domains[a])&&"inherited"!==b.type?b:this._getLayerDomain(a)};e.queryFeatures=function(a=this.createQuery(),b){return this.load().then(()=>{if(!this.get("capabilities.operations.supportsQuery"))throw new w("Sublayer.queryFeatures","this layer doesn't support queries.");return Promise.all([new Promise(function(c,g){z(["../../rest/query/operations/query"],c,g)}),new Promise(function(c,
g){z(["../../tasks/support/FeatureSet"],function(l){c(Object.freeze({__proto__:null,"default":l}))},g)})])}).then(([{executeQuery:c},{default:g}])=>c(this.url,J.from(a),this.layer?this.layer.spatialReference:null,{...b,query:{...this.layer.customParameters}}).then(l=>g.fromJSON(l.data))).then(c=>{c&&c.features&&c.features.forEach(g=>{g.sourceLayer=this});return c})};e.toExportImageJSON=function(){var a;const b={id:this.id,source:(null==(a=this.source)?void 0:a.toJSON())||{mapLayerId:this.id,type:"mapLayer"}};
this.definitionExpression&&(b.definitionExpression=this.definitionExpression);const c=["renderer","labelingInfo","opacity","labelsVisible"].reduce((g,l)=>{g[l]=this.originIdOf(l);return g},{});Object.keys(c).some(g=>2<c[g])&&(a=b.drawingInfo={},2<c.renderer&&(a.renderer=this.renderer?this.renderer.toJSON():null),2<c.labelsVisible&&(a.showLabels=this.labelsVisible),this.labelsVisible&&2<c.labelingInfo&&(a.labelingInfo=this.labelingInfo?this.labelingInfo.map(g=>g.write({},{origin:"service",layer:this.layer})):
null,a.showLabels=!0),2<c.opacity&&(a.transparency=100-100*this.opacity),this._assignDefaultSymbolColors(a.renderer));return b};e._assignDefaultSymbolColors=function(a){this._forEachSimpleMarkerSymbols(a,b=>{b.color||"esriSMSX"!==b.style&&"esriSMSCross"!==b.style||(b.color=b.outline&&b.outline.color?b.outline.color:[0,0,0,0])})};e._forEachSimpleMarkerSymbols=function(a,b){if(a){const c="uniqueValueInfos"in a?a.uniqueValueInfos:"classBreakInfos"in a?a.classBreakInfos:[];for(const g of c)D(g.symbol)&&
b(g.symbol);"symbol"in a&&D(a.symbol)&&b(a.symbol);"defaultSymbol"in a&&D(a.defaultSymbol)&&b(a.defaultSymbol)}};e._setAndNotifyLayer=function(a,b){const c=this.layer,g=this._get(a);let l,p;switch(a){case "definitionExpression":l="supportsSublayerDefinitionExpression";case "minScale":case "maxScale":case "visible":l="supportsSublayerVisibility";break;case "labelingInfo":case "labelsVisible":case "opacity":case "renderer":case "source":l="supportsDynamicLayers",p="supportsModification"}const v=B.getProperties(this).getDefaultOrigin();
if("service"!==v){if(l&&!1===this.get(`layer.capabilities.exportMap.${l}`)){this._logLockedError(a,`capability not available 'layer.capabilities.exportMap.${l}'`);return}if(p&&!1===this.get(`capabilities.exportMap.${p}`)){this._logLockedError(a,`capability not available 'capabilities.exportMap.${p}'`);return}}"source"===a&&"not-loaded"!==this.loadStatus?this._logLockedError(a,"'source' can't be changed after calling sublayer.load()"):(this._set(a,b),"service"!==v&&g!==b&&c&&c.emit&&c.emit("sublayer-update",
{propertyName:a,target:this}))};e._handleSublayersChange=function(a,b){b&&(b.forEach(c=>{c.parent=null;c.layer=null}),this.handles.removeAll());a&&(a.forEach(c=>{c.parent=this;c.layer=this.layer}),this.handles.add([a.on("after-add",({item:c})=>{c.parent=this;c.layer=this.layer}),a.on("after-remove",({item:c})=>{c.parent=null;c.layer=null}),a.on("before-changes",c=>{const g=this.get("layer.capabilities.exportMap.supportsSublayersChanges");null==g||g||(E.error(new w("sublayer:sublayers-non-modifiable",
"Sublayer can't be added, moved, or removed from the layer's sublayers",{sublayer:this,layer:this.layer})),c.preventDefault())})]))};e._logLockedError=function(a,b){E.error(new w("sublayer:locked",`Property '${a}' can't be changed on Sublayer from the layer '${this.layer.id}'`,{reason:b,sublayer:this,layer:this.layer}))};e._getLayerDomain=function(a){return(a=this.fieldsIndex.get(a))?a.domain:null};F._createClass(m,[{key:"definitionExpression",set:function(a){this._setAndNotifyLayer("definitionExpression",
a)}},{key:"fieldsIndex",get:function(){return new aa(this.fields||[])}},{key:"id",get:function(){const a=this._get("id");return null==a?fa++:a},set:function(a){this._get("id")!==a&&(!1===this.get("layer.capabilities.exportMap.supportsDynamicLayers")?this._logLockedError("id","capability not available 'layer.capabilities.exportMap.supportsDynamicLayers'"):this._set("id",a))}},{key:"labelingInfo",set:function(a){this._setAndNotifyLayer("labelingInfo",a)}},{key:"labelsVisible",set:function(a){this._setAndNotifyLayer("labelsVisible",
a)}},{key:"layer",set:function(a){this._set("layer",a);this.sublayers&&this.sublayers.forEach(b=>b.layer=a)}},{key:"listMode",set:function(a){this._set("listMode",a)}},{key:"minScale",set:function(a){this._setAndNotifyLayer("minScale",a)}},{key:"maxScale",set:function(a){this._setAndNotifyLayer("maxScale",a)}},{key:"opacity",set:function(a){this._setAndNotifyLayer("opacity",a)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"renderer",set:function(a){if(a)for(const b of a.getSymbols())if(X.isSymbol3D(b)){E.warn("Sublayer renderer should use 2D symbols");
break}this._setAndNotifyLayer("renderer",a)}},{key:"source",get:function(){return this._get("source")||new C.MapLayerSource({mapLayerId:this.id})},set:function(a){this._setAndNotifyLayer("source",a)}},{key:"sublayers",set:function(a){this._handleSublayersChange(a,this._get("sublayers"));this._set("sublayers",a)}},{key:"url",get:function(){var a,b;const c=null!=(a=null==(b=this.layer)?void 0:b.parsedUrl)?a:this._lastParsedUrl;a=this.source;if(!c)return null;this._lastParsedUrl=c;if("map-layer"===(null==
a?void 0:a.type))return`${c.path}/${a.mapLayerId}`;a={layer:JSON.stringify({source:this.source})};return`${c.path}/dynamicLayer?${P.objectToQuery(a)}`},set:function(a){a?this._override("url",a):this._clearOverride("url")}},{key:"visible",set:function(a){this._setAndNotifyLayer("visible",a)}}]);return m}(ea.HandleOwnerMixin(Y.MultiOriginJSONMixin(T.IdentifiableMixin(W))));d.test={isMapImageLayerOverridePolicy:k=>k===n||k===K,isTileImageLayerOverridePolicy:k=>k===L};f.__decorate([h.property({readOnly:!0})],
d.prototype,"capabilities",void 0);f.__decorate([r.reader("service","capabilities",["layerDefinition.canModifyLayer","layerDefinition.capabilities"])],d.prototype,"readCapabilities",null);f.__decorate([h.property({type:String,value:null,json:{read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression",overridePolicy:K}}})],d.prototype,"definitionExpression",null);f.__decorate([h.property({type:[Z],json:{origins:{service:{read:{source:"layerDefinition.fields"}}}}})],
d.prototype,"fields",void 0);f.__decorate([h.property({readOnly:!0})],d.prototype,"fieldsIndex",null);f.__decorate([h.property({type:Q,json:{read:{source:"layerDefinition.extent"}}})],d.prototype,"fullExtent",void 0);f.__decorate([h.property({type:String})],d.prototype,"globalIdField",void 0);f.__decorate([r.reader("service","globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],d.prototype,"readGlobalIdFieldFromService",null);f.__decorate([h.property({type:q.Integer,json:{write:{ignoreOrigin:!0}}})],
d.prototype,"id",null);f.__decorate([h.property({value:null,type:[ba],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo"},write:{target:"layerDefinition.drawingInfo.labelingInfo",overridePolicy:n}}})],d.prototype,"labelingInfo",null);f.__decorate([u.writer("labelingInfo")],d.prototype,"writeLabelingInfo",null);f.__decorate([h.property({type:Boolean,value:!0,json:{read:{source:"layerDefinition.drawingInfo.showLabels"},write:{target:"layerDefinition.drawingInfo.showLabels",overridePolicy:n}}})],
d.prototype,"labelsVisible",null);f.__decorate([h.property({value:null})],d.prototype,"layer",null);f.__decorate([h.property({type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend",overridePolicy:x}}})],d.prototype,"legendEnabled",void 0);f.__decorate([h.property({type:["show","hide","hide-children"],value:"show",json:{read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],d.prototype,"listMode",null);f.__decorate([h.property({type:Number,
value:0,json:{write:{overridePolicy:n}}})],d.prototype,"minScale",null);f.__decorate([r.reader("minScale",["minScale","layerDefinition.minScale"])],d.prototype,"readMinScale",null);f.__decorate([h.property({type:Number,value:0,json:{write:{overridePolicy:n}}})],d.prototype,"maxScale",null);f.__decorate([r.reader("maxScale",["maxScale","layerDefinition.maxScale"])],d.prototype,"readMaxScale",null);f.__decorate([h.property({type:String})],d.prototype,"objectIdField",void 0);f.__decorate([r.reader("service",
"objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],d.prototype,"readObjectIdFieldFromService",null);f.__decorate([h.property({type:Number,value:1,json:{write:{target:"layerDefinition.drawingInfo.transparency",overridePolicy:n}}})],d.prototype,"opacity",null);f.__decorate([r.reader("opacity",["layerDefinition.drawingInfo.transparency","layerDefinition.transparency"])],d.prototype,"readOpacity",null);f.__decorate([u.writer("opacity")],d.prototype,"writeOpacity",null);f.__decorate([h.property({json:{type:q.Integer,
write:{target:"parentLayerId",allowNull:!0,overridePolicy:n}}})],d.prototype,"parent",void 0);f.__decorate([u.writer("parent")],d.prototype,"writeParent",null);f.__decorate([h.property({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader(k,m){return!m.disablePopup}},write:{target:"disablePopup",overridePolicy:x,writer(k,m,e){m[e]=!k}}}})],d.prototype,"popupEnabled",void 0);f.__decorate([h.property({type:U,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:x}}})],d.prototype,
"popupTemplate",void 0);f.__decorate([h.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);f.__decorate([h.property({types:H.rendererTypes,value:null,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:n},origins:{"web-scene":{types:H.webSceneRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:n}}}}})],d.prototype,"renderer",null);f.__decorate([h.property({types:{key:"type",base:null,typeMap:{"data-layer":I.DataLayerSource,"map-layer":C.MapLayerSource}},
cast(k){if(k){if("mapLayerId"in k)return q.ensureClass(C.MapLayerSource,k);if("dataSource"in k)return q.ensureClass(I.DataLayerSource,k)}return k},json:{name:"layerDefinition.source",write:{overridePolicy:n}}})],d.prototype,"source",null);f.__decorate([h.property()],d.prototype,"sourceJSON",void 0);f.__decorate([h.property({value:null,json:{type:[q.Integer],write:{target:"subLayerIds",allowNull:!0,overridePolicy:n}}})],d.prototype,"sublayers",null);f.__decorate([N.cast("sublayers")],d.prototype,"castSublayers",
null);f.__decorate([u.writer("sublayers")],d.prototype,"writeSublayers",null);f.__decorate([h.property({type:String,json:{read:{source:"name"},write:{target:"name",allowNull:!0,overridePolicy:x}}})],d.prototype,"title",void 0);f.__decorate([h.property({type:String})],d.prototype,"typeIdField",void 0);f.__decorate([r.reader("typeIdField",["layerDefinition.typeIdField"])],d.prototype,"readTypeIdField",null);f.__decorate([h.property({type:[ca],json:{origins:{service:{read:{source:"layerDefinition.types"}}}}})],
d.prototype,"types",void 0);f.__decorate([h.property({type:String,json:{read:{source:"layerUrl"},write:{target:"layerUrl",overridePolicy:L}}})],d.prototype,"url",null);f.__decorate([h.property({type:Boolean,value:!0,json:{read:{source:"defaultVisibility"},write:{target:"defaultVisibility",overridePolicy:n}}})],d.prototype,"visible",null);f.__decorate([u.writer("visible")],d.prototype,"writeVisible",null);return d=y=f.__decorate([O.subclass("esri.layers.support.Sublayer")],d)});