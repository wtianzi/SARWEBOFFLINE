// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("require exports ../../core/maybe ../../core/Error ../../core/urlUtils ../../request ./arcgisLayerUrl ./lazyLayerLoader".split(" "),function(w,n,l,x,p,y,q,z){function r(a,b){return a?a.find(c=>c.id===b):null}function A(a,b,c){function e(d,g){d={...c,layerId:d,sublayerTitleMode:"service-name"};l.isSome(g)&&(d.sourceJSON=g);return new b.Constructor(d)}b.sublayerIds.forEach(d=>{d=e(d,r(b.sublayerInfos,d));a.add(d)});b.tableIds.forEach(d=>{d=e(d,r(b.tableInfos,d));a.tables.add(d)})}async function B(a,
b){var c=q.parse(a);l.isNone(c)&&(c=await C(a,b));if(l.isNone(c))throw new x("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:a});const {serverType:e,sublayer:d}=c;var g={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(e){case "MapServer":var h=null!=d?"FeatureLayer":D(a,b).then(f=>f?"TileLayer":"MapImageLayer");break;case "ImageServer":h=k(a,b).then(f=>{const m=f.tileInfo&&f.tileInfo.format;return f.tileInfo?!m||
"LERC"!==m.toUpperCase()||f.cacheType&&"elevation"!==f.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"});break;case "SceneServer":h=k(c.url.path,b).then(f=>{const m={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};return f&&Array.isArray(f.layers)&&0<f.layers.length&&(f=f.layers[0].layerType,null!=m[f])?m[f]:"SceneLayer"});break;default:h=g[e]}g="FeatureServer"===e;c={parsedUrl:c,
Constructor:null,layerOrTableId:g?d:null,sublayerIds:null,tableIds:null};h=await h;if({FeatureLayer:!0,SceneLayer:!0}[h]&&null==d)if(a=await E(a,e,b),g&&(c.sublayerInfos=a.layerInfos,c.tableInfos=a.tableInfos),1!==a.layerIds.length+a.tableIds.length)c.sublayerIds=a.layerIds,c.tableIds=a.tableIds;else if(g){var t,u;c.layerOrTableId=null!=(t=a.layerIds[0])?t:a.tableIds[0];c.sourceJSON=null!=(u=a.layerInfos[0])?u:a.tableInfos[0]}c.Constructor=await F(h);return c}async function C(a,b){b=await k(a,b);
let c=null,e=null;var d=b.type;"Feature Layer"===d||"Table"===d?(c="FeatureServer",e=b.id):"indexedVector"===d?c="VectorTileServer":b.hasOwnProperty("mapName")?c="MapServer":b.hasOwnProperty("bandCount")&&b.hasOwnProperty("pixelSizeX")?c="ImageServer":b.hasOwnProperty("maxRecordCount")&&b.hasOwnProperty("allowGeometryUpdates")?c="FeatureServer":b.hasOwnProperty("streamUrls")&&(c="StreamServer");if(!c)return null;d=null!=e?q.parseNonStandardSublayerUrl(a):null;return{title:l.isSome(d)&&b.name||p.getFilename(a),
serverType:c,sublayer:e,url:{path:l.isSome(d)?d.serviceUrl:p.urlToObject(a).path}}}async function E(a,b,c){var e,d;let g=!1;"FeatureServer"===b?(a=await G(a,c),g=!!a.layersJSON,b=a.layersJSON||a.serviceJSON):b=await k(a,c);a=null==(e=b)?void 0:e.layers;e=null==(d=b)?void 0:d.tables;return{layerIds:(null==a?void 0:a.map(h=>h.id).reverse())||[],tableIds:(null==e?void 0:e.map(h=>h.id).reverse())||[],layerInfos:g?a:[],tableInfos:g?e:[]}}function v(a){return!a.type||"Feature Layer"===a.type}async function G(a,
b){var c,e;let d=await k(a,b);d=d||{};d.layers=(null==(c=d.layers)?void 0:c.filter(v))||[];c={serviceJSON:d};if(10.5>d.currentVersion)return c;a=await k(a+"/layers",b);c.layersJSON={layers:(null==a?void 0:null==(e=a.layers)?void 0:e.filter(v))||[],tables:(null==a?void 0:a.tables)||[]};return c}async function F(a){return(0,z.layerLookupMap[a])()}async function D(a,b){return(await k(a,b)).tileInfo}async function k(a,b){return(await y(a,{responseType:"json",query:{f:"json",...b}})).data}n.fromUrl=async function(a){var b,
c=null==(b=a.properties)?void 0:b.customParameters;b=await B(a.url,c);a={...a.properties,url:a.url};if(!b.sublayerIds)return null!=b.layerOrTableId&&(a.layerId=b.layerOrTableId,a.sourceJSON=b.sourceJSON),new b.Constructor(a);c=new (await new Promise(function(e,d){w(["../GroupLayer"],function(g){e(Object.freeze({__proto__:null,"default":g}))},d)})).default({title:b.parsedUrl.title});A(c,b,a);return c};Object.defineProperty(n,"__esModule",{value:!0})});