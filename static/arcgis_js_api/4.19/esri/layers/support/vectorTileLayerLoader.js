// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("exports ../../config ../../core/urlUtils ../../core/promiseUtils ../../request ../../views/2d/engine/vectorTiles/style/VectorTileSource".split(" "),function(t,u,g,y,z,A){function m(a){a&&(a=g.getOrigin(a),r&&-1===r.indexOf(a)&&r.push(a))}function n(...a){let c=void 0;for(let b=0;b<a.length;++b)g.isProtocolRelative(a[b])?c&&(c=c.split("://")[0]+":"+a[b].trim()):c=g.isAbsolute(a[b])?a[b]:g.join(c,a[b]);return g.removeTrailingSlash(c)}async function p(a,c,b,e,f){y.throwIfAborted(f);if("string"===
typeof b){e=g.normalize(b);m(e);var d=g.urlToObject(e);d=await z(d.path,{query:{f:"json"},responseType:"json",...f});b=e}else d={data:b},b=b.jsonUrl||null;const h=d.data;d.ssl&&(b&&(b=b.replace(/^http:/i,"https:")),e&&(e=e.replace(/^http:/i,"https:")));return h.sources?(a.styleUrl=b||null,B(a,h,e,f)):h.sources?Promise.reject("You must specify the URL or the JSON for a service or for a style."):a.sourceUrl?v(a,h,e,!1,c,f):(a.sourceUrl=b||null,v(a,h,e,!0,c,f))}async function B(a,c,b,e){b=b?g.removeFile(b):
g.appBaseUrl;a.styleBase=b;a.style=c;a.styleUrl&&m(a.styleUrl);c["sprite-format"]&&"webp"===c["sprite-format"].toLowerCase()&&(a.spriteFormat="webp");const f=[];if(c.sources&&c.sources.esri){const d=c.sources.esri;d.url?await p(a,"esri",n(b,d.url),void 0,e):f.push(p(a,"esri",d,b,e))}for(const d of Object.keys(c.sources))"esri"!==d&&"vector"===c.sources[d].type&&(c.sources[d].url?f.push(p(a,d,n(b,c.sources[d].url),void 0,e)):c.sources[d].tiles&&f.push(p(a,d,c.sources[d],b,e)));await Promise.all(f)}
async function v(a,c,b,e,f,d){b=b?g.removeTrailingSlash(b)+"/":g.appBaseUrl;if(c.hasOwnProperty("tileInfo"))var h=c;else{var k={xmin:-2.0037507067161843E7,ymin:-2.0037507067161843E7,xmax:2.0037507067161843E7,ymax:2.0037507067161843E7,spatialReference:{wkid:102100}},l=78271.51696400007,w=2.958287637957775E8,x=[],C=c.hasOwnProperty("minzoom")?parseFloat(c.minzoom):0,D=c.hasOwnProperty("maxzoom")?parseFloat(c.maxzoom):22;for(let q=0;q<=D;q++)q>=C&&x.push({level:q,scale:w,resolution:l}),l/=2,w/=2;for(h of c.tiles)m(n(b,
h));h={capabilities:"TilesOnly",initialExtent:k,fullExtent:k,minScale:0,maxScale:0,tiles:c.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},lods:x,spatialReference:{wkid:102100}}}}k=new A(f,b,h);if(!e&&a.primarySourceName in a.sourceNameToSource){l=a.sourceNameToSource[a.primarySourceName];if(!l.isCompatibleWith(k))return Promise.resolve();null!=k.fullExtent&&(null!=l.fullExtent?l.fullExtent.union(k.fullExtent):l.fullExtent=k.fullExtent.clone());
l.tileInfo.lods.length<k.tileInfo.lods.length&&(l.tileInfo=k.tileInfo)}e?(a.sourceBase=b,a.source=c,a.validatedSource=h,a.primarySourceName=f,a.sourceUrl&&m(a.sourceUrl)):m(b);a.sourceNameToSource[f]=k;if(!a.style)return null==c.defaultStyles?Promise.reject():"string"===typeof c.defaultStyles?p(a,"",n(b,c.defaultStyles,"root.json"),void 0,d):p(a,"",c.defaultStyles,n(b,"root.json"),d)}const r=u.defaults&&u.defaults.io.corsEnabledServers;t.loadMetadata=async function(a,c){const b={source:null,sourceBase:null,
sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[e,f]="string"===typeof a?[a,null]:[null,a.jsonUrl],d=e?g.urlToObject(e):null;await p(b,"esri",a,f,c);a={layerDefinition:b.validatedSource,url:e,parsedUrl:d,serviceUrl:b.sourceUrl,style:b.style,styleUrl:b.styleUrl,spriteUrl:b.style.sprite&&n(b.styleBase,b.style.sprite),spriteFormat:b.spriteFormat,glyphsUrl:b.style.glyphs&&n(b.styleBase,b.style.glyphs),sourceNameToSource:b.sourceNameToSource,
primarySourceName:b.primarySourceName};m(a.spriteUrl);m(a.glyphsUrl);return a};Object.defineProperty(t,"__esModule",{value:!0})});