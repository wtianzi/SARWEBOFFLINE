// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/SpatialReference ../../../geometry/Point ../../../geometry/Extent ../../../geometry ../PixelBlock ../RasterInfo ../rasterFormats/utils ../rasterFunctions/pixelUtils ../RasterStorageInfo ./BaseRaster ./xmlUtilities ./pamParser".split(" "),
function(J,C,y,F,T,U,D,V,K,A,W,X,Y,L,G,M,Z,N,O,P,Q,R,S,r,H){const u=new Map;u.set("Int8","s8");u.set("UInt8","u8");u.set("Int16","s16");u.set("UInt16","u16");u.set("Int32","s32");u.set("UInt32","u32");u.set("Float32","f32");u.set("Float64","f32");u.set("Double64","f32");const B=new Map;B.set("lerc",".lrc");B.set("none",".til");B.set("deflate",".pzp");B.set("jpeg",".jzp");y=function(I){function E(){var a=I.apply(this,arguments)||this;a._files=null;a._storageIndex=null;a.datasetFormat="MRF";return a}
J._inheritsLoose(E,I);var z=E.prototype;z.open=async function(a){var b;await this.init();this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);var c=a?F.unwrap(a.signal):null,e=await this.request(this.url,{responseType:"xml",signal:c});const {rasterInfo:d,files:k}=this._parseHeader(e.data);if(-1===(null==(b=this.ioConfig.skipExtensions)?void 0:b.indexOf("aux.xml"))&&(a=await this._fetchAuxiliaryData(a),null!=a)){var m;d.statistics=null!=(m=a.statistics)?m:d.statistics;(d.histograms=a.histograms)&&
!F.isSome(d.statistics)&&(d.statistics=Q.estimateStatisticsFromHistograms(a.histograms))}this._set("rasterInfo",d);this._files=k;c=await this.request(k.index,{responseType:"array-buffer",signal:c});this._storageIndex=this._parseIndex(c.data);c=0;m=-1;const {blockWidth:p,blockHeight:f,compression:w}=this.rasterInfo.storageInfo;e=this.rasterInfo.storageInfo.pyramidScalingFactor;const {width:t,height:h,bandCount:q}=this.rasterInfo,l=[],n="none"===w?1:q;for(;c<this._storageIndex.length;)m++,a=Math.ceil(t/
p/e**m),b=Math.ceil(h/f/e**m),c+=a*b*n*4,l.push({maxRow:b,maxCol:a,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=l;0<m&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=m);this.updateTileInfo()};z.fetchRawTile=async function(a,b,c,e={}){const {blockWidth:d,blockHeight:k,blockBoundary:m,compression:p}=this.rasterInfo.storageInfo;var f=m[a];if(!f||f.maxRow<b||f.maxCol<c||f.minRow>b||f.minCol>c)return null;const {bandCount:w,pixelType:t}=
this.rasterInfo,{ranges:h,actualTileWidth:q,actualTileHeight:l}=this._getTileLocation(a,b,c);if(!h||0===h.length)return null;if(0===h[0].from&&0===h[0].to)return a=new Uint8Array(d*k),new N({width:d,height:k,pixels:null,mask:a,validPixelCount:0});({bandIds:c}=this.ioConfig);b="none"===p?1:w;f=[];for(a=a=0;a<b;a++)(!c||-1<c.indexOf[a])&&f.push(this.request(this._files.data,{range:{from:h[a].from,to:h[a].to},responseType:"array-buffer",signal:e.signal}));e=await Promise.all(f);a=e.map(n=>n.data.byteLength).reduce((n,
g)=>n+g);c=new Uint8Array(a);for(a=f=0;a<b;a++)c.set(new Uint8Array(e[a].data),f),f+=e[a].data.byteLength;e=await this.decodePixelBlock(c.buffer,{width:d,height:k,format:"lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip",pixelType:t});c=b=0;if(q!==d||l!==k)if(f=e.mask)for(a=0;a<k;a++)for(c=a*d,b=a<l?q:0;b<d;b++)f[c+b]=0;else for(f=new Uint8Array(d*k),e.mask=f,a=0;a<l;a++)for(c=a*d,b=0;b<q;b++)f[c+b]=1;return e};z._parseIndex=function(a){if(0<a.byteLength%16)throw"invalid array buffer must be multiples of 16";
let b,c,e,d,k;if(P.isPlatformLittleEndian){b=new Uint8Array(a);e=new ArrayBuffer(a.byteLength);c=new Uint8Array(e);for(d=0;d<a.byteLength/4;d++)for(k=0;4>k;k++)c[4*d+k]=b[4*d+3-k];a=new Uint32Array(e)}else a=new Uint32Array(a);return a};z._getTileLocation=function(a,b,c){const {blockWidth:e,blockHeight:d,pyramidScalingFactor:k,compression:m}=this.rasterInfo.storageInfo,{width:p,height:f,bandCount:w}=this.rasterInfo,t="none"===m?1:w;let h,q;var l,n=0;let g=0;for(l=0;l<a;l++)g=k**l,h=Math.ceil(p/e/
g),q=Math.ceil(f/d/g),n+=h*q;g=k**a;h=Math.ceil(p/e/g);q=Math.ceil(f/d/g);n=4*(n+(b*h+c))*t;a=this._storageIndex.subarray(n,n+4*t);n=l=0;const v=[];for(let x=0;x<t;x++)l=a[4*x]*2**32+a[4*x+1],n=l+a[4*x+2]*2**32+a[4*x+3],v.push({from:l,to:n});return{ranges:v,actualTileWidth:c<h-1?e:Math.ceil(p/g)-e*(h-1),actualTileHeight:b<q-1?d:Math.ceil(f/g)-d*(q-1)}};z._parseHeader=function(a){var b=r.getElement(a,"MRF_META/Raster");if(!b)throw new A("mrf:open","not a valid MRF format");var c=r.getElement(b,"Size"),
e=parseInt(c.getAttribute("x"),10),d=parseInt(c.getAttribute("y"),10);const k=parseInt(c.getAttribute("c"),10);c=(r.getElementValue(b,"Compression")||"none").toLowerCase();var m=["none","lerc"];if(!c||-1===m.indexOf(c))throw new A("mrf:open","currently does not support compression "+c);var p=r.getElementValue(b,"DataType")||"UInt8";m=u.get(p);if(null==m)throw new A("mrf:open","currently does not support pixel type "+p);var f=r.getElement(b,"PageSize");p=parseInt(f.getAttribute("x"),10);f=parseInt(f.getAttribute("y"),
10);b=r.getElement(b,"DataValues");let w;b&&(b=b.getAttribute("NoData"),null!=b&&(w=b.trim().split(" ").map(x=>parseFloat(x))));if(r.getElement(a,"MRF_META/CachedSource"))throw new A("mrf:open","currently does not support MRF referencing other data files");var t=r.getElement(a,"MRF_META/GeoTags"),h=r.getElement(t,"BoundingBox");if(null==h)throw new A("mrf:open","missing node MRF_META/GeoTags/BoundingBox");b=parseFloat(h.getAttribute("minx"));const q=parseFloat(h.getAttribute("miny")),l=parseFloat(h.getAttribute("maxx")),
n=parseFloat(h.getAttribute("maxy"));var g=r.getElementValue(t,"Projection")||"";t=r.getElementValue(a,"datafile");h=r.getElementValue(a,"IndexFile");let v;"LOCAL_CS[]"!==g&&(g.toLowerCase().startsWith("epsg:")?(g=Number(g.slice(5)),isNaN(g)||0===g||(v=new L({wkid:g}))):v=H.parseSpatialReference(g));g=new M(b,q,l,n);g.spatialReference=v;a=r.getElement(a,"MRF_META/Rsets");a=parseInt(a&&a.getAttribute("scale")||"2",10);a=new R({origin:new G({x:g.xmin,y:g.ymax,spatialReference:v}),blockWidth:p,blockHeight:f,
pyramidBlockWidth:p,pyramidBlockHeight:f,compression:c,pyramidScalingFactor:a});p=new G({x:(l-b)/e,y:(n-q)/d,spatialReference:v});e=new O({width:e,height:d,extent:g,spatialReference:v,bandCount:k,pixelType:m,pixelSize:p,noDataValue:w,storageInfo:a});d={mrf:this.url,index:h||this.url.replace(".mrf",".idx"),data:t||this.url.replace(".mrf",B.get(c))};return{rasterInfo:e,files:d}};z._fetchAuxiliaryData=async function(a){try{const {data:b}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:null==
a?void 0:a.signal});return H.parsePAMInfo(b)}catch{return null}};return E}(S);C.__decorate([D.property()],y.prototype,"_files",void 0);C.__decorate([D.property()],y.prototype,"_storageIndex",void 0);C.__decorate([D.property({type:String,json:{write:!0}})],y.prototype,"datasetFormat",void 0);return y=C.__decorate([K.subclass("esri.layers.support.rasterIO.MRFRaster")],y)});