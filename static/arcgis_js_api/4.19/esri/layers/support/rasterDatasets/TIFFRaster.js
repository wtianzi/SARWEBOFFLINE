// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/Point ../../../geometry/Extent ../../../geometry ../RasterInfo ../rasterFormats/TiffTags ../rasterFormats/TiffDecoder ../rasterFunctions/pixelUtils ../RasterStorageInfo ./BaseRaster ../rasterTransforms/PolynomialTransform ./pamParser".split(" "),
function(O,x,u,K,aa,ba,C,ca,P,L,da,ea,fa,y,M,ha,Q,D,E,R,S,T,U,V){const N=function(q,v){return(q=q.get(v))&&q.values},F=function(q,v){return(q=q.get(v))&&q.values[0]};u=function(q){function v(){var a=q.apply(this,arguments)||this;a._files=null;a._headerInfo=null;a._bufferSize=1048576;a.datasetFormat="TIFF";return a}O._inheritsLoose(v,q);var w=v.prototype;w.open=async function(a){var c;await this.init();var d=a?K.unwrap(a.signal):null,{data:b}=await this.request(this.url,{range:{from:0,to:this._bufferSize},
responseType:"array-buffer",signal:d});if(!b)throw new L("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {littleEndian:e,firstIFD:f,isBigTiff:h}=E.parseSignature(b),l=[];await this.readIFDs(l,b,e,f,0,h?8:4,d);d=E.getImageInfo(l);const {width:k,height:m,tileWidth:r,tileHeight:z,planes:I,pixelType:G,compression:A,firstPyramidLevel:H,maximumPyramidLevel:W,pyramidBlockWidth:X,pyramidBlockHeight:Y,tileBoundary:Z,affine:p,metadata:B}=
d,n=M.fromJSON(d.extent);b=n.spatialReference;var g=n?new y({x:n.xmin,y:n.ymax,spatialReference:b}):new y({x:0,y:0});const J=new S({blockWidth:r,blockHeight:z,pyramidBlockWidth:X,pyramidBlockHeight:Y,compression:A,origin:g,firstPyramidLevel:H,maximumPyramidLevel:W,blockBoundary:Z});g=new y({x:(n.xmax-n.xmin)/k,y:(n.ymax-n.ymin)/m,spatialReference:b});g=new Q({width:k,height:m,bandCount:I,pixelType:G,compression:A,pixelSize:g,storageInfo:J,spatialReference:b,keyProperties:B?{BandProperties:B.bandProperties,
DataType:B.dataType}:{},extent:n,statistics:B?B.statistics:null});null!=p&&p.length&&(g.nativeExtent=new M({xmin:-.5,ymin:.5-m,xmax:k-.5,ymax:.5,spatialReference:b}),g.transform=new U({polynomialOrder:1,forwardCoefficients:[p[2]+p[0]/2,p[5]-p[3]/2,p[0],p[3],-p[1],-p[4]]}),g.extent=g.transform.forwardTransform(g.nativeExtent),g.pixelSize=new y({x:(n.xmax-n.xmin)/k,y:(n.ymax-n.ymin)/m,spatialReference:b}),J.origin.x=-.5,J.origin.y=.5);if(null==(c=this.ioConfig.skipExtensions)||!c.includes("aux.xml"))if(a=
await this._fetchAuxiliaryData(a),null!=a){var t;g.statistics=null!=(t=a.statistics)?t:g.statistics;(g.histograms=a.histograms)&&!K.isSome(g.statistics)&&(g.statistics=R.estimateStatisticsFromHistograms(a.histograms));a.transform&&!p&&(g.transform=a.transform,g.nativeExtent=g.extent,t=g.transform.forwardTransform(g.nativeExtent),g.pixelSize=new y({x:(t.xmax-t.xmin)/k,y:(t.ymax-t.ymin)/m,spatialReference:b}),g.extent=t);g.spatialReference||(g.spatialReference=a.spatialReference)}this._set("rasterInfo",
g);this._headerInfo={littleEndian:e,isBigTiff:h,ifds:l,...d};if(!this._headerInfo.isSupported)throw new L("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);this.updateTileInfo()};w.fetchRawTile=async function(a,c,d,b={}){var e;if(null==(e=this._headerInfo)||!e.isSupported||this.isBlockOutside(a,c,d))return null;c=this.getTileLocation(a,c,d);if(!c)return null;const {range:f,actualTileWidth:h,actualTileHeight:l,ifd:k}=c;({data:b}=await this.request(this.url,{range:f,responseType:"array-buffer",
signal:b.signal}));const {blockWidth:m,blockHeight:r}=this.getBlockWidthHeight(a);a=await this.decodePixelBlock(b,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:k,offset:0,size:0},width:m,height:r,planes:null,pixelType:null});if(h!==m||l!==r)if(e=a.mask)for(b=0;b<r;b++)for(d=b*m,c=b<l?h:0;c<m;c++)e[d+c]=0;else for(e=new Uint8Array(m*r),a.mask=e,b=0;b<l;b++)for(d=b*m,c=0;c<h;c++)e[d+c]=1;return a};w.readIFDs=async function(a,c,d,b,e,f=4,h){if(!b)return null;if(b>=c.byteLength||0>b)c=
(await this.request(this.url,{range:{from:b+e,to:b+e+this._bufferSize},responseType:"array-buffer",signal:h})).data,e=b+e,b=0;b=await this.readIFD(c,d,b,e,D.TIFF_TAGS,f,h);a.push(b.ifd);if(!b.nextIFD)return null;await this.readIFDs(a,c,d,b.nextIFD-e,e,f,h)};w.readIFD=async function(a,c,d,b,e=D.TIFF_TAGS,f=4,h){if(!a)return null;d=E.parseIFD(a,c,d,b,e,f);if(d.success){const l=[];d.ifd.forEach(k=>{k.values||l.push(k)});0<l.length&&(f=l.map(k=>k.offlineOffsetSize),e=Math.min.apply(null,f.map(k=>k[0])),
Math.min.apply(null,f.map(k=>k[0]+k[1]))-e<=this._bufferSize&&({data:f}=await this.request(this.url,{range:{from:e,to:e+this._bufferSize},responseType:"array-buffer",signal:h}),a=f,b=e,l.forEach(k=>E.parseFieldValues(a,c,k,b))));d.ifd.has("GEOKEYDIRECTORY")&&(e=d.ifd.get("GEOKEYDIRECTORY"),(f=e.values)&&4<f.length&&(f=f[0]+"."+f[1]+"."+f[2],h=await this.readIFD(a,c,e.valueOffset+6-b,b,D.GEO_KEYS,2,h),e.data=h.ifd,e.data&&e.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[f]})));
return d}if(d.requiredBufferSize&&d.requiredBufferSize!==a.byteLength)return a=(await this.request(this.url,{range:{from:b,to:b+d.requiredBufferSize+4},responseType:"array-buffer",signal:h})).data,a.byteLength<d.requiredBufferSize?null:this.readIFD(a,c,0,b,D.TIFF_TAGS,4,h)};w.getTileLocation=function(a,c,d){const {firstPyramidLevel:b,blockBoundary:e}=this.rasterInfo.storageInfo;var f=0===a?0:a-(b-1);a=this._headerInfo.ifds[f];if(!a)return null;var h=N(a,"TILEOFFSETS");if(void 0===h)return null;var l=
N(a,"TILEBYTECOUNTS");const {minRow:k,minCol:m,maxRow:r,maxCol:z}=e[f];if(c>r||d>z||c<k||d<m)return null;f=F(a,"IMAGEWIDTH");const I=F(a,"IMAGELENGTH"),G=F(a,"TILEWIDTH"),A=F(a,"TILELENGTH"),H=c*(z+1)+d;h=h[H];l=l[H];return null==h||null==l?null:{range:{from:h,to:h+l-1},ifd:a,actualTileWidth:d===z?f%G:G,actualTileHeight:c===r?I%A:A}};w._fetchAuxiliaryData=async function(a){try{const {data:c}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:null==a?void 0:a.signal});return V.parsePAMInfo(c)}catch{return null}};
return v}(T);x.__decorate([C.property()],u.prototype,"_files",void 0);x.__decorate([C.property()],u.prototype,"_headerInfo",void 0);x.__decorate([C.property()],u.prototype,"_bufferSize",void 0);x.__decorate([C.property({type:String,json:{write:!0}})],u.prototype,"datasetFormat",void 0);return u=x.__decorate([P.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],u)});