// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/SpatialReference ../../../geometry/Point ../../../geometry/Extent ../../../geometry ../../../tasks/support/FeatureSet ../TileInfo ../serviceTileInfoProperty ../TilemapCache ../RasterInfo ../rasterFunctions/pixelUtils ../RasterStorageInfo ./BaseRaster".split(" "),
function(E,v,u,w,Q,R,z,S,F,x,G,T,U,H,A,B,V,I,J,K,L,C,M,N,O){u=function(D){function y(){var b=D.apply(this,arguments)||this;b._levelOffset=0;b._slices=null;b._tilemapCache=null;b.datasetFormat="RasterTileServer";return b}E._inheritsLoose(y,D);var r=y.prototype;r.open=async function(b){await this.init();b=b&&b.signal;var a=this.sourceJSON?{data:this.sourceJSON}:await this.request(this.url,{query:{f:"json"},signal:b});a.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));const d=a.data;this.sourceJSON=
d;if(!d)throw new x("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!d.tileInfo)throw new x("imageserverraster:open","use ImageryLayer to open non-tiled image services");this._fixScaleInServiceInfo();a="jpg jpeg png png8 png24 png32 mixed".split(" ");this.tileType=d.cacheType;null==this.tileType&&(-1<a.indexOf(d.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===d.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster");this.datasetName=
d.name.slice(d.name.indexOf("/")+1);b=await this._fetchRasterInfo({signal:b});if(w.isSome(b)){a="Map"===this.tileType?K.readServiceTileInfo(d.tileInfo,d):J.fromJSON(d.tileInfo);const {extent:g,pixelSize:h}=b,p=.5/b.width*h.x;var c,e=a.lodAt(Math.max.apply(null,a.lods.map(k=>k.level)));"Map"!==this.tileType&&0!==d.maxScale&&("Raster"===this.tileType?(c=a.lods.filter(k=>k.resolution===h.x)[0])||(c=a.lods[a.lods.length-1]):(c=a.lods.filter(k=>Math.abs(k.scale-d.maxScale)<p)[0])||(c=a.lods.filter(k=>
k.scale>d.maxScale).sort((k,P)=>k.scale>P.scale?1:-1)[0]),h.x=h.y=c.resolution,b.width=Math.ceil((g.xmax-g.xmin)/h.x-.1),b.height=Math.ceil((g.ymax-g.ymin)/h.y-.1));c||(c=e);e=a.lodAt(Math.min.apply(null,a.lods.map(k=>k.level)));if("Map"===this.tileType)this._levelOffset=a.lods[0].level;else if(0!==d.minScale&&"Elevation"===this.tileType){var l=a.lods.filter(k=>Math.abs(k.scale-d.minScale)<p)[0];this._levelOffset=l.level-e.level}l||(l=e);const t=Math.max(h.x,h.y);if(Math.abs(h.x-h.y)>p||!a.lods.some(k=>
Math.abs(k.resolution-t)<p))h.x=h.y=c.resolution,b.width=Math.ceil((g.xmax-g.xmin)/h.x-.1),b.height=Math.ceil((g.ymax-g.ymin)/h.y-.1);c=c.level-l.level;const [q,n]=a.size;l=a.origin;let {x:f,y:m}=h;e=[{minCol:Math.floor((g.xmin-l.x+.1*f)/q/f),maxCol:Math.floor((g.xmax-l.x-.1*f)/q/f),minRow:Math.floor((l.y-g.ymax+.1*m)/n/m),maxRow:Math.floor((l.y-g.ymin-.1*m)/n/m)}];if(0<c)for(let k=0;k<c;k++)f*=2,m*=2,e.push({minCol:Math.floor((g.xmin-l.x+.1*f)/q/f),maxCol:Math.floor((g.xmax-l.x-.1*f)/q/f),minRow:Math.floor((l.y-
g.ymax+.1*m)/n/f),maxRow:Math.floor((l.y-g.ymin-.1*m)/n/f)});b.storageInfo=new N({blockWidth:a.size[0],blockHeight:a.size[1],pyramidBlockWidth:a.size[0],pyramidBlockHeight:a.size[1],compression:a.format,origin:a.origin,firstPyramidLevel:1,maximumPyramidLevel:c,tileInfo:a,blockBoundary:e});this._set("rasterInfo",b)}else throw new x("image-server-raster:open","cannot initialize image service");-1<d.capabilities.toLowerCase().indexOf("tilemap")&&(b={tileInfo:b.storageInfo.tileInfo,parsedUrl:G.urlToObject(this.url),
url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new L.TilemapCache({layer:b}))};r.fetchRawTile=async function(b,a,d,c={}){const {storageInfo:e,extent:l,pixelSize:g}=this.rasterInfo;({data:c}=await this.request(`${this.url}/tile/${e.maximumPyramidLevel-b+this._levelOffset}/${a}/${d}`,{query:this._slices?{sliceId:c.sliceId||0}:null,responseType:"array-buffer",signal:c.signal}));if(!c)return null;c=await this.decodePixelBlock(c,{width:e.tileInfo.size[0],height:e.tileInfo.size[1],planes:null,
pixelType:null,isPoint:"Elevation"===this.tileType});const h=e.blockBoundary[b];if("jpg"!==e.compression||d>h.minCol&&d<h.maxCol&&a>h.minRow&&a<h.maxRow)return c;const {origin:p,blockWidth:t,blockHeight:q}=e;var n=2**b,f=Math.round((l.xmin-p.x)/(g.x*n))%t;b=Math.round((l.xmax-p.x)/(g.x*n))%t;var m=Math.round((p.y-l.ymax)/(g.x*n))%q;n=Math.round((p.y-l.ymin)/(g.x*n))%q;f=d===h.minCol?f:0;m=a===h.minRow?m:0;M.setValidBoundary(c,{x:f,y:m},{width:(d===h.maxCol?b:t)-f,height:(a===h.maxRow?n:q)-m});return c};
r.getSliceIndex=function(b){if(null==b||!b.length||!this._slices)return null;for(let a=0;a<this._slices.length;a++){const d=this._slices[a].multidimensionalDefinition;if(d.length===b.length&&!d.some(c=>{var e=b.filter(g=>c.variableName===g.variableName&&g.dimensionName===c.dimensionName)[0];if(!e)return!0;const l=Array.isArray(c.values[0])?c.values[0][0]:c.values[0];e=Array.isArray(e.values[0])?e.values[0][0]:e.values[0];return l!==e}))return a}return null};r.fetchVariableStatisticsHistograms=async function(b,
a){var d=this.request(this.url+"/statistics",{query:{variable:b,f:"json"},signal:a}).then(c=>{var e;return null==(e=c.data)?void 0:e.statistics});b=this.request(this.url+"/histograms",{query:{variable:b,f:"json"},signal:a}).then(c=>{var e;return null==(e=c.data)?void 0:e.histograms});d=await Promise.all([d,b]);d[0]&&d[0].forEach(c=>{c.avg=c.mean;c.stddev=c.standardDeviation});return{statistics:d[0]||null,histograms:d[1]||null}};r.computeBestPyramidLevelForLocation=async function(b,a={}){if(!this._tilemapCache)return 0;
b=this.identifyPixelLocation(b,0,w.unwrap(a.datumTransformation));if(null===b)return null;let d=0;var {maximumPyramidLevel:c}=this.rasterInfo.storageInfo;c=c-d+this._levelOffset;const e=b.srcLocation;for(;0<=c;){try{if("available"===await this._tilemapCache.fetchAvailability(c,b.row,b.col,a))break}catch{}c--;d++;b=this.identifyPixelLocation(e,d,w.unwrap(a.datumTransformation));if(null===b)return null}return-1===c||null==b?null:d};r._fetchRasterInfo=async function(b){const a=this.sourceJSON,d=Math.ceil((a.extent.xmax-
a.extent.xmin)/a.pixelSizeX-.1),c=Math.ceil((a.extent.ymax-a.extent.ymin)/a.pixelSizeY-.1),e=H.fromJSON(a.spatialReference||a.extent.spatialReference);if("Map"===this.tileType)return new C({width:d,height:c,bandCount:3,extent:B.fromJSON(a.extent),spatialReference:e,pixelSize:new A({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:e}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}});const {slice:l,signal:g}=b;b=a.hasRasterAttributeTable?this.request(this.url+"/rasterAttributeTable",
{query:{slice:l,f:"json"},signal:g}).then(f=>I.fromJSON(f.data)).catch(()=>null):!1;const h=a.hasColormap?this.request(this.url+"/colormap",{query:{slice:l,f:"json"},signal:g}).then(f=>{var m;return null==(m=f.data)?void 0:m.colormap}):!1,p=a.hasHistograms?this.request(this.url+"/histograms",{query:{slice:l,f:"json"},signal:g}).then(f=>{var m;return null==(m=f.data)?void 0:m.histograms}):!1,t=this.request(this.url+"/keyProperties",{query:{f:"json"},signal:g}).then(f=>f.data).catch(()=>{}),q=a.hasMultidimensions?
this._fetchMultidimensionalInfo():!1,n=a.hasMultidimensions?this.request(this.url+"/slices",{query:{f:"json"},signal:g}).then(f=>f.data&&f.data.slices).catch(()=>{}):!1;return Promise.all([b,h,p,t,q,n]).then(f=>{let m=null;if(a.minValues&&a.minValues.length===a.bandCount){m=[];for(let k=0;k<a.minValues.length;k++)m.push({min:a.minValues[k],max:a.maxValues[k],avg:a.meanValues[k],stddev:a.stdvValues[k]})}this._slices=f[5]||null;return new C({width:d,height:c,bandCount:a.bandCount,extent:B.fromJSON(a.extent),
spatialReference:e,pixelSize:new A({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:e}),pixelType:a.pixelType.toLowerCase(),statistics:m,attributeTable:f[0]||null,colormap:f[1]||null,histograms:f[2]||null,keyProperties:f[3]||{},multidimensionalInfo:f[4]||null})})};r._fetchMultidimensionalInfo=async function(b){var a;b=await this.request(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:b}).then(d=>{var c;return null==(c=d.data)?void 0:c.multidimensionalInfo});null!=(a=b.variables)&&a.length&&
b.variables.forEach(d=>{var c;null!=(c=d.statistics)&&c.length&&d.statistics.forEach(e=>{e.avg=e.mean;e.stddev=e.standardDeviation})});return b};r._fixScaleInServiceInfo=function(){const {sourceJSON:b}=this;b.minScale&&0>b.minScale&&(b.minScale=0);b.maxScale&&0>b.maxScale&&(b.maxScale=0)};return y}(O);v.__decorate([z.property({type:String,json:{write:!0}})],u.prototype,"datasetFormat",void 0);v.__decorate([z.property()],u.prototype,"tileType",void 0);return u=v.__decorate([F.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],
u)});