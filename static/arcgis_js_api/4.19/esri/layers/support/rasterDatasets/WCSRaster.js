// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.19/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../geometry/Extent ../../../geometry ../DimensionalDefinition ../rasterFunctions/pixelUtils ./BaseRaster ../wmsUtils ./multipartParser ./wcsCapabilitiesParser ./wcsCoverageParser".split(" "),
function(N,F,A,J,Y,Z,H,aa,O,B,ba,ca,da,K,P,ea,Q,R,S,T,U,V,L){const W=["nearest neighbor","bilinear","bicubic"],X=["nearest","linear","cubic"];A=function(M){function I(){var a=M.apply(this,arguments)||this;a.datasetFormat="WCSServer";return a}N._inheritsLoose(I,M);var y=I.prototype;y.open=async function(a){await this.init();a=null==a?void 0:a.signal;var b=await this._getCapabilities(a);this.capabilities=b;if(!this.version){var d;let c=null==(d=b.capabilitiesVersion)?void 0:d.slice(0,3);this.version=
"2.0"===c||"1.1"===c||"1.0"===c?b.capabilitiesVersion:c=b.supportedVersions.find(e=>"2.0.1"===e)||b.supportedVersions.find(e=>"2.0"===e.slice(0,3))||b.supportedVersions.find(e=>"1.1"===e.slice(0,3))||b.supportedVersions.find(e=>"1.0"===e.slice(0,3))||"1.0.0"}null==this.coverageId&&(this.coverageId=b.coverages[0].id);d=b.coverages.filter(c=>c.id===this.coverageId)[0];if(null==d)throw new B("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);this.coverageInfo=(await this._describeCoverage(a))[0];
"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=d.lonLatEnvelope,this.coverageInfo.supportedInterpolations=L.standardizeInterpolations(b.supportedInterpolations));this.datasetName=this.coverageInfo.title;({rasterInfo:b}=this.coverageInfo);this.createRemoteDatasetStorageInfo(b,512,512);this._set("rasterInfo",b);if(null==b.spatialReference)throw new B("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const {pixelType:g,bandCount:f}=await this._getPixelTypeAndBandCount(a);
b.pixelType=g;1===b.bandCount&&1<f&&(b.bandCount=f);this.updateTileInfo()};y.fetchRawTile=async function(a,b,d,g={}){if(this.isBlockOutside(a,b,d))return null;const {nativePixelSize:f,spatialReference:c}=this.rasterInfo,e=2**a,m=f.x*e,p=f.y*e,{blockWidth:v,blockHeight:w}=this.getBlockWidthHeight(a);({origin:a}=this.rasterInfo.storageInfo.tileInfo);const x=this.getTileExtent({x:m,y:p},b,d,a,c,[v,w]),z=this.rasterInfo.extent;b=x.xmax>z.xmax||x.ymin<z.ymin;let h=x;d=v;a=w;b&&(h=x.clone().intersection(z),
d=Math.floor((h.xmax-h.xmin)/m),a=Math.floor((h.ymax-h.ymin)/p),h.xmax=h.xmin+m*d,h.ymin=h.ymax-p*a);if(1>=d||1>=a)return null;g=await this._getCoverage(h,d,a,e,g);if(!g)return null;if((g=await this.decodePixelBlock(g,{width:d,height:a,planes:null,pixelType:null}))&&(g.width!==d||g.height!==a))throw new B("wcsraster-fetch",`the reponse has unexpected dimension width: ${g.width}, height: {pixelBlock.height}`);b&&(g=R.clip(g,{x:0,y:0},{width:w,height:w}));return g};y._getCapabilities=async function(a){const b=
{service:"WCS",request:"GetCapabilities"};this.version&&(b.version=this.version,b.acceptVersions=this.version);try{const {data:d}=await this.request(this.url,{query:b,responseType:"xml",signal:a});return V.parseCapabilities(d)}catch(d){if(!K.isAbortError(d))throw new B("wcslayer:open","wcs capabilities is not valid or supported");throw d;}};y._describeCoverage=async function(a){const b={service:"WCS",request:"DescribeCoverage",version:this.version},d=this.version.slice(0,3);"1.0"===d?b.coverage=this.coverageId:
"1.1"===d?b.identifiers=this.coverageId:"2.0"===d&&(b.coverageId=this.coverageId);try{const {data:g}=await this.request(this.url,{query:b,responseType:"xml",signal:a});return L.parseCoverages(g,this.version)}catch(g){if(!K.isAbortError(g))throw new B("wcslayer:open","wcs coverage description is not valid or supported");throw g;}};y._getPixelTypeAndBandCount=async function(a){const {pixelSize:b,extent:d,multidimensionalInfo:g}=this.rasterInfo;var f=d.center;f=new P({xmin:f.x-b.x,xmax:f.x+b.x,ymin:f.y-
b.y,ymax:f.y+b.y,spatialReference:d.spatialReference});let c;if(J.isSome(g)){const e=g.variables[0];c=[];e.dimensions.forEach(m=>{c.push(new Q({variableName:e.name,dimensionName:m.name,values:m.hasRegularIntervals?m.extent[0]:m.values[0],isSlice:!0}))})}a=await this._getCoverage(f,2,2,1,{multidimensionalDefinition:c,signal:J.unwrap(a)});if(!a)throw new B("wcsraster-open","unable to determine pixel type");a=await this.decodePixelBlock(a,{width:2,height:2,planes:null,pixelType:null});return{pixelType:a.pixelType,
bandCount:a.getPlaneCount()}};y._getCoverage=async function(a,b,d,g,f){const {coverageDescription:c}=this.coverageInfo;var {version:e}=c;a="2.0"===c.version?this._getCoverage201Parameters(a,b,d,g,f,c):"1.1"===c.version?this._getCoverage110Parameters(a,b,d,f,c):this._getCoverage100Parameters(a,b,d,f);f="2.0"===c.version?await this.request(this._constructWCS201Url(a),{signal:f.signal,responseType:"array-buffer"}):await this.request(this.url,{query:a,signal:f.signal,responseType:"array-buffer"});if("1.0"===
e)return f.data;e=U.parse(f);if(e.isMultipart&&e.data)return e=e.data.filter(m=>{var p;return(null==(p=m.contentType)?void 0:p.toLowerCase().includes("image"))&&null!=m.contentData})[0],null==e?void 0:e.contentData;if(this.ioConfig.allowAnyMediaType)return f.data;throw new B("wcsraster:getcoverage","response is not a valid coverage, multipart response is expected");};y._getInterpolationIndex=function(a){return-1===this.coverageInfo.supportedInterpolations.indexOf(a)?0:"nearest"===a?0:"bilinear"===
a?1:"cubic"===a?2:0};y._getCoverage100Parameters=function(a,b,d,g){const f=`${a.xmin},${a.ymin},${a.xmax},${a.ymax}`;a=a.spatialReference.wkid;const c=(this.coverageInfo.supportedFormats||[]).find(v=>-1<v.toLowerCase().indexOf("tiff"))||"GEOTIFF",{bandIds:e,interpolation:m}=g;g=this._getInterpolationIndex(m);const p=e?e.map(v=>this.coverageInfo.bandNames[v]):null;return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:c,crs:`EPSG:${a}`,bbox:f,width:b,height:d,
interpolation:W[g],band:null==p?void 0:p.join(",")}};y._getCoverage110Parameters=function(a,b,d,g,f){var c;const {multidimensionalDefinition:e,bandIds:m,interpolation:p}=g;g=a.spatialReference.wkid;const v=`urn:ogc:def:crs:EPSG::${g}`,w=(this.coverageInfo.supportedFormats||[]).find(r=>-1<r.toLowerCase().indexOf("tiff"))||"image/tiff";var x=this._getInterpolationIndex(p);x=X[x];const z=null==p||0===(null==(c=this.coverageInfo.supportedInterpolations)?void 0:c.indexOf(p));c=f.domain.spatialDomain;var h=
c.origin.x<=c.envelope.xmin&&c.origin.y<=c.envelope.ymin,t=a.width/b,n=a.height/d*(h?1:-1);d=h?[a.xmin,a.ymin]:[a.xmin,a.ymax];d=(c=c.useEPSGAxis&&T.coordsReversedForWKID(g))?`${d[1]},${d[0]}`:`${d[0]},${d[1]}`;b=c?`${n},0,0,${t}`:`${t},0,0,${n}`;h=t/2;t=a.xmin+h;h=a.xmax-h;var q=Math.abs(n)/2;n=a.ymin+q;a=a.ymax-q;a=c?`${n},${t},${a},${h},${v}`:`${t},${n},${h},${a},${v}`;c=(c=f.range.filter(r=>r.axis.some(l=>-1<l.identifier.toLowerCase().indexOf("band")))[0])&&x&&m?z?`${c.identifier}[${c.axis[0].identifier}[${m.join(",")}]]`:
`${c.identifier}:${x}[${c.axis[0].identifier}[${m.join(",")}]]`:null;let G;if(null!=e&&e.length)for(n=0;n<e.length;n++){t=e[n].values;const r=e[n].dimensionName.toLowerCase(),l=e[n].variableName.toLowerCase();0<t.length&&(t[0]instanceof Array&&(t=t[0]),"stdtime"===r?G=t.map(k=>this._convertToISOTime(k)).join(","):(h=f.range.filter(k=>k.identifier.toLowerCase()===l)[0])&&(q=h.axis.filter(k=>k.identifier.toLowerCase()===r)[0])&&(c=z?h.identifier+"["+q.identifier+"["+t.join(",")+"]]":h.identifier+":"+
x+"["+q.identifier+"["+t.join(",")+"]]"))}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:w,crs:`EPSG:${g}`,boundingbox:a,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:d,gridOffsets:b,gridBaseCRS:v,timeSequence:G,rangeSubset:c}};y._convertToISOTime=function(a,b=!1){return(b?new Date(864E5*(a-25569)):new Date(a)).toISOString()};y._getCoverage201Parameters=function(a,b,d,g,f,c){const {multidimensionalDefinition:e,
interpolation:m}=f;var p=this._getInterpolationIndex(m);let v=null;var {supportedInterpolations:w}=this.capabilities;if(null!=w&&w.length)switch(p){case 0:v=w.find(u=>u.includes("nearest"));break;case 1:v=w.find(u=>u.includes("linear"));break;case 2:v=w.find(u=>u.includes("cubic")||u.includes("quadratic"))}p=(this.coverageInfo.supportedFormats||[]).find(u=>-1<u.toLowerCase().indexOf("tiff"))||"image/tiff";const {bandNames:x}=this.coverageInfo,{boundedBy:z,domainSet:h,rangeType:t}=c;var n=z.isEastFirst?
0:1,{axisLabels:q}=z;w=q[n];n=q[1-n];const G=`http://www.opengis.net/def/crs/EPSG/0/${a.spatialReference.wkid}`,r=[];r.push(`${w}(${a.xmin},${a.xmax})`);r.push(`${n}(${a.ymin},${a.ymax})`);a=[];if(2<q.length)for(var l=2;l<q.length;l++){var k=h.origin[l];if(-1<q[l].toLowerCase().indexOf("time")){let u=k.toString();-1<z.uomLabels[l].toLowerCase().indexOf("ole")&&(a.push(q[l]),u=this._convertToISOTime(k,!0));r.push(q[l]+",http://www.opengis.net("+u+")")}else r.push(q[l]+",http://www.opengis.net("+k+
")")}a=null;if(null!=e&&e.length){const u=[];t.forEach(C=>C.forEach(D=>u.push(D.name)));f=[];for(let C=0;C<e.length;C++){const D=q.find(E=>E===e[C].dimensionName);l=u.find(E=>E===e[C].variableName);-1===f.indexOf(l)&&f.push(l);D&&(k=e[C].values,0<k.length&&(Array.isArray(k[0])&&(k=k[0]),l="",l=-1<D.toLowerCase().indexOf("time")?k.map(E=>this._convertToISOTime(E)).join(","):k.join(","),k=r.findIndex(E=>0===E.indexOf(D+",http://www.opengis.net")),-1===k&&r.push(D+",http://www.opengis.net("+l+")"),-1!==
k&&-1===r[k].indexOf("("+l+")")&&r.splice(k,1,D+",http://www.opengis.net("+l+")")))}f.length&&(a=f.join(","))}else null!=x&&x.length&&(a=(f.bandIds?f.bandIds.map(u=>x[u]):x).join(","));q=r.join("\x26subset\x3d");c=c.domainSet.axisLabels.join("")!==c.boundedBy.axisLabels.join("")&&!1!==this.ioConfig.allowScaleFactor;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:a,interpolation:v,scaleSize:c?null:`${w}(${b}),${n}(${d})`,scaleFactor:c?1/g:null,
subset:q,format:p,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:G,subsettingcrs:G}};y._constructWCS201Url=function(a){const b={...this.ioConfig.customFetchParameters,...a},d=[];Object.keys(b).forEach(f=>{const c=b[f];null!=c&&("subset"!==f?d.push(`${f}=${encodeURIComponent(c)}`):c.split("\x26subset\x3d").forEach(e=>{e&&d.push(`subset=${encodeURIComponent(e)}`)}))});a=encodeURI(this.url);const g=d.join("\x26");return`${a}?${g}`};return I}(S);F.__decorate([H.property({type:String,
json:{write:!0}})],A.prototype,"datasetFormat",void 0);F.__decorate([H.property()],A.prototype,"tileType",void 0);F.__decorate([H.property({type:String,json:{write:!0}})],A.prototype,"version",void 0);F.__decorate([H.property({type:String,json:{write:!0}})],A.prototype,"coverageId",void 0);return A=F.__decorate([O.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],A)});